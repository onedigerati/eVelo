<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Portfolio Strategy Simulator</title>

    <!-- ZenDeep Finance Design System v2.0 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@300;400;600&family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- OPrime Utility Classes (Phase 2: Inline Style Elimination) -->
    <style>
/* ========================================
   OPrime Design System - Utility Classes
   Phase 2: Inline Style Elimination
   ======================================== */

/* ---- Display Utilities ---- */
.hidden {
    display: none;
}

.visible {
    display: block;
}

.inline {
    display: inline;
}

.inline-block {
    display: inline-block;
}

.flex {
    display: flex;
}

.flex-row {
    display: flex;
    flex-direction: row;
}

.flex-col {
    display: flex;
    flex-direction: column;
}

.flex-wrap {
    display: flex;
    flex-wrap: wrap;
}

.flex-center {
    display: flex;
    align-items: center;
    justify-content: center;
}

.flex-between {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.flex-start {
    display: flex;
    align-items: flex-start;
}

.flex-end {
    display: flex;
    align-items: flex-end;
}

.grid {
    display: grid;
}

/* ---- Flex Gap Utilities ---- */
.gap-0 {
    gap: 0;
}

.gap-4 {
    gap: 4px;
}

.gap-8 {
    gap: 8px;
}

.gap-12 {
    gap: 12px;
}

.gap-16 {
    gap: 16px;
}

.gap-24 {
    gap: 24px;
}

/* ---- Margin Utilities ---- */
.m-0 {
    margin: 0;
}

.m-8 {
    margin: 8px;
}

.m-12 {
    margin: 12px;
}

.m-16 {
    margin: 16px;
}

.mx-auto {
    margin-left: auto;
    margin-right: auto;
}

.mx-0 {
    margin-left: 0;
    margin-right: 0;
}

.my-0 {
    margin-top: 0;
    margin-bottom: 0;
}

/* ---- Margin Top ---- */
.mt-0 {
    margin-top: 0;
}

.mt-4 {
    margin-top: 4px;
}

.mt-8 {
    margin-top: 8px;
}

.mt-12 {
    margin-top: 12px;
}

.mt-16 {
    margin-top: 16px;
}

.mt-24 {
    margin-top: 24px;
}

.mt-32 {
    margin-top: 32px;
}

/* ---- Margin Bottom ---- */
.mb-0 {
    margin-bottom: 0;
}

.mb-4 {
    margin-bottom: 4px;
}

.mb-8 {
    margin-bottom: 8px;
}

.mb-10 {
    margin-bottom: 10px;
}

.mb-12 {
    margin-bottom: 12px;
}

.mb-16 {
    margin-bottom: 16px;
}

.mb-24 {
    margin-bottom: 24px;
}

.mb-32 {
    margin-bottom: 32px;
}

/* ---- Margin Left ---- */
.ml-0 {
    margin-left: 0;
}

.ml-4 {
    margin-left: 4px;
}

.ml-8 {
    margin-left: 8px;
}

.ml-12 {
    margin-left: 12px;
}

.ml-16 {
    margin-left: 16px;
}

.ml-20 {
    margin-left: 20px;
}

.ml-24 {
    margin-left: 24px;
}

/* ---- Margin Right ---- */
.mr-0 {
    margin-right: 0;
}

.mr-4 {
    margin-right: 4px;
}

.mr-8 {
    margin-right: 8px;
}

.mr-12 {
    margin-right: 12px;
}

.mr-16 {
    margin-right: 16px;
}

.mr-24 {
    margin-right: 24px;
}

/* ---- Padding Utilities ---- */
.p-0 {
    padding: 0;
}

.p-4 {
    padding: 4px;
}

.p-8 {
    padding: 8px;
}

.p-12 {
    padding: 12px;
}

.p-16 {
    padding: 16px;
}

.p-24 {
    padding: 24px;
}

.px-0 {
    padding-left: 0;
    padding-right: 0;
}

.px-8 {
    padding-left: 8px;
    padding-right: 8px;
}

.px-12 {
    padding-left: 12px;
    padding-right: 12px;
}

.px-16 {
    padding-left: 16px;
    padding-right: 16px;
}

.px-24 {
    padding-left: 24px;
    padding-right: 24px;
}

.py-0 {
    padding-top: 0;
    padding-bottom: 0;
}

.py-8 {
    padding-top: 8px;
    padding-bottom: 8px;
}

.py-12 {
    padding-top: 12px;
    padding-bottom: 12px;
}

.py-16 {
    padding-top: 16px;
    padding-bottom: 16px;
}

.py-24 {
    padding-top: 24px;
    padding-bottom: 24px;
}

/* ---- Padding Top ---- */
.pt-0 {
    padding-top: 0;
}

.pt-8 {
    padding-top: 8px;
}

.pt-12 {
    padding-top: 12px;
}

.pt-16 {
    padding-top: 16px;
}

.pt-24 {
    padding-top: 24px;
}

/* ---- Padding Bottom ---- */
.pb-0 {
    padding-bottom: 0;
}

.pb-8 {
    padding-bottom: 8px;
}

.pb-12 {
    padding-bottom: 12px;
}

.pb-16 {
    padding-bottom: 16px;
}

.pb-24 {
    padding-bottom: 24px;
}

/* ---- Padding Left ---- */
.pl-0 {
    padding-left: 0;
}

.pl-8 {
    padding-left: 8px;
}

.pl-12 {
    padding-left: 12px;
}

.pl-16 {
    padding-left: 16px;
}

.pl-24 {
    padding-left: 24px;
}

/* ---- Padding Right ---- */
.pr-0 {
    padding-right: 0;
}

.pr-8 {
    padding-right: 8px;
}

.pr-12 {
    padding-right: 12px;
}

.pr-16 {
    padding-right: 16px;
}

.pr-24 {
    padding-right: 24px;
}

/* ---- Width Utilities ---- */
.w-full {
    width: 100%;
}

.w-auto {
    width: auto;
}

.w-fit {
    width: fit-content;
}

.w-80 {
    width: 80px;
}

.w-100 {
    width: 100px;
}

.w-120 {
    width: 120px;
}

.w-200 {
    width: 200px;
}

.w-300 {
    width: 300px;
}

.max-w-full {
    max-width: 100%;
}

.max-w-800 {
    max-width: 800px;
}

.min-w-100 {
    min-width: 100px;
}

.min-w-200 {
    min-width: 200px;
}

/* ---- Height Utilities ---- */
.h-auto {
    height: auto;
}

.h-full {
    height: 100%;
}

.h-20 {
    height: 20px;
}

.h-24 {
    height: 24px;
}

.h-32 {
    height: 32px;
}

.h-36 {
    height: 36px;
}

.h-40 {
    height: 40px;
}

.h-48 {
    height: 48px;
}

.h-275 {
    height: 275px;
}

.max-h-50vh {
    max-height: 50vh;
}

.max-h-55vh {
    max-height: 55vh;
}

.min-h-20 {
    min-height: 20px;
}

/* ---- Overflow Utilities ---- */
.overflow-hidden {
    overflow: hidden;
}

.overflow-auto {
    overflow: auto;
}

.overflow-x-auto {
    overflow-x: auto;
}

.overflow-y-auto {
    overflow-y: auto;
}

.overflow-x-hidden {
    overflow-x: hidden;
}

.overflow-y-hidden {
    overflow-y: hidden;
}

/* ---- Text Alignment Utilities ---- */
.text-left {
    text-align: left;
}

.text-center {
    text-align: center;
}

.text-right {
    text-align: right;
}

.text-justify {
    text-align: justify;
}

/* ---- Vertical Alignment ---- */
.align-top {
    vertical-align: top;
}

.align-middle {
    vertical-align: middle;
}

.align-bottom {
    vertical-align: bottom;
}

/* ---- Font Size Utilities ---- */
.text-xs {
    font-size: 12px;
}

.text-sm {
    font-size: 13px;
}

.text-base {
    font-size: 14px;
}

.text-md {
    font-size: 15px;
}

.text-lg {
    font-size: 16px;
}

.text-xl {
    font-size: 18px;
}

.text-2xl {
    font-size: 24px;
}

.text-3xl {
    font-size: 32px;
}

/* ---- Font Weight Utilities ---- */
.font-normal {
    font-weight: 400;
}

.font-medium {
    font-weight: 500;
}

.font-semibold {
    font-weight: 600;
}

.font-bold {
    font-weight: 700;
}

/* ---- Line Height Utilities ---- */
.leading-tight {
    line-height: 1.2;
}

.leading-normal {
    line-height: 1.5;
}

.leading-relaxed {
    line-height: 1.8;
}

.leading-loose {
    line-height: 2;
}

/* ---- Border Utilities ---- */
.border {
    border: 1px solid var(--md-sys-color-outline);
}

.border-t {
    border-top: 1px solid var(--md-sys-color-outline);
}

.border-b {
    border-bottom: 1px solid var(--md-sys-color-outline);
}

.border-l {
    border-left: 1px solid var(--md-sys-color-outline);
}

.border-r {
    border-right: 1px solid var(--md-sys-color-outline);
}

.border-none {
    border: none;
}

/* ---- Border Radius Utilities ---- */
.rounded-none {
    border-radius: 0;
}

.rounded-sm {
    border-radius: 4px;
}

.rounded {
    border-radius: 4px;
}

.rounded-md {
    border-radius: 6px;
}

.rounded-lg {
    border-radius: 4px;
}

.rounded-xl {
    border-radius: 5px;
}

.rounded-full {
    border-radius: 9999px;
}

/* ---- Box Shadow Utilities ---- */
.shadow-none {
    box-shadow: none;
}

.shadow-xs {
    box-shadow: var(--shadow-xs);
}

.shadow-sm {
    box-shadow: var(--shadow-sm);
}

.shadow-md {
    box-shadow: var(--shadow-md);
}

.shadow-lg {
    box-shadow: var(--shadow-lg);
}

.shadow-xl {
    box-shadow: var(--shadow-xl);
}

.shadow-inner {
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* ---- Opacity Utilities ---- */
.opacity-0 {
    opacity: 0;
}

.opacity-25 {
    opacity: 0.25;
}

.opacity-50 {
    opacity: 0.5;
}

.opacity-75 {
    opacity: 0.75;
}

.opacity-100 {
    opacity: 1;
}

/* ---- Background Color Utilities ---- */
.bg-transparent {
    background-color: transparent;
}

.bg-white {
    background-color: var(--color-neutral-white);
}

.bg-primary {
    background-color: var(--color-brand-primary);
}

.bg-primary-soft {
    background-color: var(--color-brand-primary-soft);
}

.bg-primary-light {
    background-color: var(--color-brand-primary-soft-alt);
}

.bg-success {
    background-color: var(--color-semantic-success);
}

.bg-success-light {
    background-color: var(--color-semantic-success-soft);
}

.bg-warning {
    background-color: var(--color-semantic-warning);
}

.bg-warning-light {
    background-color: var(--color-semantic-warning-soft);
}

.bg-danger {
    background-color: var(--color-semantic-danger);
}

.bg-danger-light {
    background-color: var(--color-semantic-danger-light);
}

/* ---- Text Color Utilities ---- */
.text-white {
    color: white;
}

.text-primary {
    color: var(--color-brand-primary);
}

.text-secondary {
    color: var(--color-neutral-text-secondary);
}

.text-muted {
    color: var(--color-neutral-text-muted);
}

.text-success {
    color: var(--color-semantic-success);
}

.text-warning {
    color: var(--color-semantic-warning);
}

.text-danger {
    color: var(--color-semantic-danger);
}

.text-on-surface {
    color: var(--md-sys-color-on-surface);
}

/* ---- Cursor Utilities ---- */
.cursor-auto {
    cursor: auto;
}

.cursor-default {
    cursor: default;
}

.cursor-pointer {
    cursor: pointer;
}

.cursor-not-allowed {
    cursor: not-allowed;
}

.cursor-move {
    cursor: move;
}

.cursor-text {
    cursor: text;
}

/* ---- Pointer Events Utilities ---- */
.pointer-events-none {
    pointer-events: none;
}

.pointer-events-auto {
    pointer-events: auto;
}

/* ---- Position Utilities ---- */
.relative {
    position: relative;
}

.absolute {
    position: absolute;
}

.fixed {
    position: fixed;
}

.sticky {
    position: sticky;
}

/* ---- Z-Index Utilities ---- */
.z-0 {
    z-index: 0;
}

.z-10 {
    z-index: 10;
}

.z-50 {
    z-index: 50;
}

.z-100 {
    z-index: 100;
}

.z-auto {
    z-index: auto;
}

/* ---- Transform Utilities ---- */
.scale-100 {
    transform: scale(1);
}

.scale-110 {
    transform: scale(1.1);
}

.scale-120 {
    transform: scale(1.2);
}

.scale-95 {
    transform: scale(0.95);
}

.translate-x-4 {
    transform: translateX(4px);
}

.translate-y-n2 {
    transform: translateY(-2px);
}

.translate-y-0 {
    transform: translateY(0);
}

.rotate-90 {
    transform: rotate(90deg);
}

.rotate-180 {
    transform: rotate(180deg);
}

/* ---- Transition & Animation Utilities ---- */
.transition-all {
    transition: all 0.2s ease;
}

.transition-colors {
    transition: color 0.2s, background-color 0.2s;
}

.transition-fast {
    transition: all 0.15s ease;
}

.transition-normal {
    transition: all 0.3s ease;
}

.transition-slow {
    transition: all 0.5s ease;
}

/* ---- User Select Utilities ---- */
.select-none {
    user-select: none;
}

.select-text {
    user-select: text;
}

.select-all {
    user-select: all;
}

/* ---- Whitespace Utilities ---- */
.whitespace-nowrap {
    white-space: nowrap;
}

.whitespace-normal {
    white-space: normal;
}

.whitespace-pre {
    white-space: pre;
}

.whitespace-pre-wrap {
    white-space: pre-wrap;
}

/* ---- Text Overflow Utilities ---- */
.truncate {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.line-clamp-1 {
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
}

.line-clamp-2 {
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

/* ---- Flex Grow/Shrink Utilities ---- */
.flex-1 {
    flex: 1;
}

.flex-auto {
    flex: auto;
}

.flex-grow {
    flex-grow: 1;
}

.flex-shrink {
    flex-shrink: 1;
}

.flex-grow-0 {
    flex-grow: 0;
}

.flex-shrink-0 {
    flex-shrink: 0;
}

/* ---- Appearance Utilities ---- */
.appearance-none {
    appearance: none;
}

/* ---- List Style Utilities ---- */
.list-none {
    list-style: none;
}

.list-disc {
    list-style: disc;
}

/* ---- Component-Specific Utility Combinations ---- */

/* List Item Indented */
.list-indented {
    margin-left: 20px;
    line-height: 1.8;
}

/* List Item Standard */
.list-item-standard {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
}

/* Centered Container */
.container-centered {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

/* Card Container */
.card-container {
    background-color: var(--md-sys-color-surface);
    border-radius: 4px;
    padding: 16px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--md-sys-color-outline);
}

/* Input/Form Container */
.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 16px;
}

.form-row {
    display: flex;
    gap: 12px;
    align-items: flex-start;
}

/* Button Group */
.button-group {
    display: flex;
    gap: 8px;
    align-items: center;
}

/* Icon Container */
.icon-container {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
}

.icon-sm {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 16px;
    height: 16px;
}

.icon-md {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
}

.icon-lg {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
}

/* Badge/Chip */
.badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    white-space: nowrap;
}

.badge-primary {
    background-color: var(--color-brand-primary-soft);
    color: var(--color-brand-primary);
}

.badge-success {
    background-color: var(--color-semantic-success-soft);
    color: var(--color-semantic-success);
}

.badge-warning {
    background-color: var(--color-semantic-warning-soft);
    color: var(--color-semantic-warning);
}

.badge-danger {
    background-color: var(--color-semantic-danger-light);
    color: var(--color-semantic-danger);
}

/* Spacer */
.spacer {
    flex: 1;
}

.spacer-horizontal {
    width: 100%;
}

.spacer-vertical {
    height: 100%;
}

/* Responsive Utilities */
@media (max-width: 768px) {
    .hidden-mobile {
        display: none !important;
    }

    .flex-mobile-col {
        flex-direction: column;
    }

    .w-full-mobile {
        width: 100% !important;
    }

    .text-center-mobile {
        text-align: center;
    }

    /* Hide Settings button on mobile to optimize vertical space */
    #settingsButton {
        display: none !important;
    }
}

@media (min-width: 769px) {
    .hidden-desktop {
        display: none !important;
    }
}
    </style>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        :root {
            /* ========================================
               ZenDeep Finance Design System v2.0 - Light Mode
               Grounded, sophisticated palette with deep forest green
               Source: design-finance-zendeep-finance-2.json
               ======================================== */

            /* ---- Brand Colors (Primary) ---- */
            --color-brand-primary: #1B4B4B;
            --color-brand-primary-soft: #E8F0EF;
            --color-brand-primary-soft-alt: #F0F5F4;
            --color-brand-primary-strong: #0F3333;
            --color-brand-primary-muted: #3D6B6B;
            --color-brand-secondary-gold: #D4A84A;
            --color-brand-secondary-gold-soft: #F9F3E6;
            --color-brand-secondary-gold-muted: #B8934A;
            --color-brand-secondary-purple: #6C63FF;
            --color-brand-secondary-cyan: #00BFA5;

            /* ---- Neutral Colors ---- */
            --color-neutral-white: #FFFFFF;
            --color-neutral-bg-shell: #3A4F4F;
            --color-neutral-bg-shell-light: #4A5F5F;
            --color-neutral-bg-app: #F5F7F6;
            --color-neutral-bg-sidebar: #FFFFFF;
            --color-neutral-bg-card: #FFFFFF;
            --color-neutral-bg-card-soft: #FAFBFB;
            --color-neutral-bg-card-warm: #FFFDF9;
            --color-neutral-border-subtle: #E5E8E7;
            --color-neutral-border-strong: #C8CFCD;
            --color-neutral-text-primary: #1A2424;
            --color-neutral-text-secondary: #5A6B6B;
            --color-neutral-text-muted: #8A9A9A;
            --color-neutral-icon-muted: #8A9A9A;

            /* ---- Semantic Status Colors ---- */
            --color-semantic-success: #2DB89B;
            --color-semantic-success-soft: #E8F7F4;
            --color-semantic-warning: #E57373;
            --color-semantic-warning-soft: #FDF2F2;
            --color-semantic-info: #1B4B4B;
            --color-semantic-info-soft: #E8F0EF;
            --color-semantic-positive: #26D07C;
            --color-semantic-positive-soft: #ECFDF5;

            /* ---- Shorthand Aliases for Common Use ---- */
            --success: #16A34A;
            --warning: #F59E0B;
            --error: #EF4444;
            --primary: #00796B;
            --text-primary: #1A2424;
            --text-secondary: #5A6B6B;
            --border-color: #E5E8E7;
            --surface-0: #FFFFFF;
            --surface-1: #FAFBFB;
            --surface-2: #F5F7F6;

            /* ---- Status Chips ---- */
            --color-chip-paid-bg: #E8F7F4;
            --color-chip-paid-border: #A7E8D8;
            --color-chip-paid-text: #1A8F73;
            --color-chip-pending-bg: #FDF2F2;
            --color-chip-pending-border: #F5B0B0;
            --color-chip-pending-text: #C55050;
            --color-chip-progress-bg: #F9F3E6;
            --color-chip-progress-border: #E8D4A0;
            --color-chip-progress-text: #9A7A30;

            /* ---- KPI Panel Colors ---- */
            --color-kpi-income-bg: #FFFFFF;
            --color-kpi-expenses-bg: #FFFFFF;
            --color-kpi-savings-bg: #FFFFFF;
            --color-kpi-border: #E5E8E7;
            --color-kpi-percent-positive: #2DB89B;
            --color-kpi-percent-positive-bg: #E8F7F4;
            --color-kpi-percent-negative: #E57373;
            --color-kpi-percent-negative-bg: #FDF2F2;

            /* ---- Chart Colors ---- */
            --color-chart-bar-primary: #1B4B4B;
            --color-chart-bar-secondary: #C8D4D4;
            --color-chart-bar-highlight: #0F3333;
            --color-chart-donut-teal: #2DB89B;
            --color-chart-donut-gold: #D4A84A;
            --color-chart-donut-dark: #1B4B4B;
            --color-chart-axis: #8A9A9A;
            --color-chart-grid: #E5E8E7;
            --color-chart-tooltip-bg: #1B4B4B;
            --color-chart-tooltip-text: #FFFFFF;

            /* ---- Control Colors ---- */
            --color-control-nav-active-bg: #1B4B4B;
            --color-control-nav-active-text: #FFFFFF;
            --color-control-nav-inactive-text: #1B4B4B;
            --color-control-nav-hover-bg: #E8F0EF;
            --color-control-search-bg: #FFFFFF;
            --color-control-search-border: #E5E8E7;
            --color-control-search-icon: #8A9A9A;
            --color-control-button-primary-bg: #1B4B4B;
            --color-control-button-primary-hover-bg: #0F3333;
            --color-control-button-primary-text: #FFFFFF;
            --color-control-button-secondary-bg: #FFFFFF;
            --color-control-button-secondary-border: #E5E8E7;
            --color-control-button-secondary-text: #1A2424;
            --color-control-button-ghost-text: #1B4B4B;
            --color-control-toggle-bg: #FFFFFF;
            --color-control-toggle-border: #E5E8E7;
            --color-control-toggle-knob: #1B4B4B;

            /* ---- Correlation Matrix Text Colors ---- */
            --correlation-high-text: #FFFFFF;  /* White text for dark green backgrounds (corr >= 0.4) */
            --correlation-low-text: #000000;   /* Black text for light gray backgrounds (corr < 0.4) */

            /* ---- Material Design System (Compatibility) ---- */
            --md-sys-color-primary: var(--color-brand-primary);
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: var(--color-brand-primary-soft);
            --md-sys-color-on-primary-container: #001150;
            --md-sys-color-secondary: var(--color-brand-secondary-purple);
            --md-sys-color-on-secondary: #FFFFFF;
            --md-sys-color-secondary-container: #F3E9FF;
            --md-sys-color-on-secondary-container: #31004A;
            --md-sys-color-tertiary: var(--color-brand-secondary-cyan);
            --md-sys-color-on-tertiary: #FFFFFF;
            --md-sys-color-surface: var(--color-neutral-white);
            --md-sys-color-on-surface: var(--color-neutral-text-primary);
            --md-sys-color-surface-variant: var(--color-neutral-border-subtle);
            --md-sys-color-on-surface-variant: var(--color-neutral-text-secondary);
            --md-sys-color-outline: var(--color-neutral-border-strong);
            --md-sys-color-background: var(--color-neutral-bg-app);
            --md-sys-color-error: var(--color-semantic-danger);
            --md-sys-color-on-error: #FFFFFF;
            --md-sys-color-surface-container: var(--color-neutral-bg-card-soft);
            --md-sys-color-surface-container-high: var(--color-brand-primary-soft-alt);
            --md-sys-color-surface-container-highest: var(--color-brand-primary-soft);

            /* ---- Design System Variables ---- */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 16px;
            --spacing-xl: 24px;
            --spacing-2xl: 32px;
            --spacing-3xl: 48px;

            /* ---- Typography Scale ---- */
            --text-display-lg: 3rem;
            --text-display-md: 2.25rem;
            --text-headline-lg: 1.5rem;
            --text-headline-md: 1.375rem;
            --text-headline-sm: 1.125rem;
            --text-body-lg: 1rem;
            --text-body-md: 0.875rem;
            --text-body-sm: 0.8125rem;

            /* ---- Shadow System ---- */
            /* ZenDeep Finance Shadows - Light Mode */
            --shadow-xs: 0 1px 2px rgba(26, 36, 36, 0.04);
            --shadow-sm: 0 2px 8px rgba(26, 36, 36, 0.06);
            --shadow-md: 0 4px 16px rgba(26, 36, 36, 0.08);
            --shadow-lg: 0 8px 32px rgba(26, 36, 36, 0.12);
            --shadow-xl: 0 12px 48px rgba(26, 36, 36, 0.16);
            --shadow-card: 0 2px 12px rgba(26, 36, 36, 0.06);
            --shadow-tooltip: 0 4px 16px rgba(26, 36, 36, 0.16);
            --shadow-inner: inset 0 2px 4px rgba(0, 0, 0, 0.06);

            /* ---- Border Radius System ---- */
            --radius-none: 0;
            --radius-sm: 4px;
            --radius-base: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --radius-2xl: 24px;
            --radius-full: 9999px;

            /* ---- Transitions ---- */
            --transition-fast: 150ms ease-out;
            --transition-base: 200ms ease-out;
            --transition-slow: 300ms ease-out;

            /* ---- Gradients ---- */
            --gradient-primary: linear-gradient(135deg, #1B4B4B 0%, #3D6B6B 100%);
            --gradient-secondary: linear-gradient(135deg, #2C5F5D 0%, #3D7371 100%);
            --gradient-gold: linear-gradient(135deg, #E8D9B0 0%, #D4C490 50%, #C4B480 100%);
            --gradient-teal: linear-gradient(135deg, #3D6B6B 0%, #1B4B4B 100%);
            --gradient-success: linear-gradient(135deg, #2DB89B 0%, #26D07C 100%);
            --gradient-premium: linear-gradient(135deg, var(--color-brand-primary) 0%, var(--color-brand-secondary-gold) 100%);
            --gradient-glass: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);

            /* ---- Legacy Aliases (for backward compatibility) ---- */
            --color-success: var(--color-semantic-success);
            --color-success-light: var(--color-semantic-success-soft);
            --color-warning: var(--color-semantic-warning);
            --color-warning-light: var(--color-semantic-warning-soft);
            --color-danger: var(--color-semantic-danger);
            --color-danger-light: var(--color-semantic-danger-light);
            --color-info: var(--color-semantic-info);
            --color-info-light: var(--color-semantic-info-soft);
            --kpi-blue-bg: var(--color-kpi-employees-bg);
            --kpi-cyan-bg: var(--color-kpi-applicants-bg);
            --kpi-purple-bg: var(--color-kpi-attendance-bg);
            --kpi-green-bg: var(--color-kpi-new-employees-bg);

            /* ---- Interaction States (Focus & Hover) ---- */
            --color-focus-outline: #00BFA5;
            --color-focus-outline-style: 2px solid;

            /* ---- Additional Status Colors ---- */
            --color-semantic-danger-dark: #DC2626;
            --color-semantic-danger-darker: #B71C1C;
            --color-semantic-success-dark: #047857;
            --color-semantic-warning-dark: #92400E;
            --color-semantic-warning-amber: #F59E0B;

            /* ---- Special Purpose Colors ---- */
            --color-progress-teal: #00796B;
            --color-progress-teal-light: #00BFA5;
            --color-progress-teal-medium: #004D40;

            /* ---- Accent Colors ---- */
            --color-accent-coral: #FF6B6B;
            --color-accent-coral-light: #FFE5E5;
            --color-accent-orange: #FF8A65;
            --color-accent-purple: #9F90FF;
            --color-accent-teal: #00BFA5;

            /* ---- Percentile Distribution Colors (Light Mode) ---- */
            --color-percentile-worst-bg: #FEE2E2;
            --color-percentile-worst-text: #DC2626;
            --color-percentile-median-bg: #DBEAFE;
            --color-percentile-median-text: #1D4ED8;
            --color-percentile-best-bg: #DBEAFE;
            --color-percentile-best-text: #16A34A;
            --color-percentile-container-bg: #FFFFFF;
        }

        [data-theme="dark"] {
            /* ========================================
               ZenDeep Finance Design System v2.0 - Dark Mode
               Deep charcoal-teal with forest green cards and vibrant accents
               Source: design-finance-zendeep-finance-2.json
               ======================================== */

            /* ---- Brand Colors (Primary) ---- */
            --color-brand-primary: #4DB8A0;
            --color-brand-primary-soft: #1A2F2B;
            --color-brand-primary-soft-alt: #0D1A17;
            --color-brand-primary-strong: #6DCFB8;
            --color-brand-primary-muted: #3D8F7F;
            --color-brand-secondary-gold: #E5B94E;
            --color-brand-secondary-gold-soft: #2A2518;
            --color-brand-secondary-gold-muted: #C4A040;
            --color-brand-secondary-purple: #9F90FF;
            --color-brand-secondary-cyan: #00E5CC;

            /* ---- Neutral Colors ---- */
            --color-neutral-white: #0F1A17;
            --color-neutral-bg-shell: #080E0C;
            --color-neutral-bg-shell-light: #0F1A17;
            --color-neutral-bg-app: #0F1A17;
            --color-neutral-bg-sidebar: #0F1A17;
            --color-neutral-bg-card: #1A2926;
            --color-neutral-bg-card-soft: #243533;
            --color-neutral-bg-card-warm: #1F2820;
            --color-neutral-border-subtle: #2F3F3C;
            --color-neutral-border-strong: #3F4F4C;
            --color-neutral-text-primary: #E8F0EE;
            --color-neutral-text-secondary: #A8B8B4;
            --color-neutral-text-muted: #6A7A76;
            --color-neutral-icon-muted: #6A7A76;

            /* ---- Semantic Status Colors ---- */
            --color-semantic-success: #4DCFB0;
            --color-semantic-success-soft: #0F2620;
            --color-semantic-warning: #F08080;
            --color-semantic-warning-soft: #2A1818;
            --color-semantic-info: #4DB8A0;
            --color-semantic-info-soft: #1A2F2B;
            --color-semantic-positive: #5EE7A0;
            --color-semantic-positive-soft: #0F2818;

            /* ---- Shorthand Aliases for Common Use ---- */
            --success: #10B981;
            --warning: #FBBF24;
            --error: #F87171;
            --primary: #00BFA5;
            --text-primary: #E8F0EE;
            --text-secondary: #A8B8B4;
            --border-color: #2F3F3C;
            --surface-0: #1A2926;
            --surface-1: #243533;
            --surface-2: #2F3F3C;

            /* ---- Status Chips ---- */
            --color-chip-paid-bg: #0F2620;
            --color-chip-paid-border: #4DCFB0;
            --color-chip-paid-text: #6EDFC0;
            --color-chip-pending-bg: #2A1818;
            --color-chip-pending-border: #F08080;
            --color-chip-pending-text: #FFA0A0;
            --color-chip-progress-bg: #2A2518;
            --color-chip-progress-border: #E5B94E;
            --color-chip-progress-text: #FFD070;

            /* ---- KPI Panel Colors ---- */
            --color-kpi-income-bg: #1A2926;
            --color-kpi-expenses-bg: #1A2926;
            --color-kpi-savings-bg: #1A2926;
            --color-kpi-border: #2F3F3C;
            --color-kpi-percent-positive: #4DCFB0;
            --color-kpi-percent-positive-bg: #0F2620;
            --color-kpi-percent-negative: #F08080;
            --color-kpi-percent-negative-bg: #2A1818;

            /* ---- Chart Colors ---- */
            --color-chart-bar-primary: #4DB8A0;
            --color-chart-bar-secondary: #2F4540;
            --color-chart-bar-highlight: #6DCFB8;
            --color-chart-donut-teal: #4DCFB0;
            --color-chart-donut-gold: #E5B94E;
            --color-chart-donut-dark: #1A2926;
            --color-chart-axis: #6A7A76;
            --color-chart-grid: #2F3F3C;
            --color-chart-tooltip-bg: #243533;
            --color-chart-tooltip-text: #E8F0EE;

            /* ---- Control Colors ---- */
            --color-control-nav-active-bg: #4DB8A0;
            --color-control-nav-active-text: #0F1A17;
            --color-control-nav-inactive-text: #A8B8B4;
            --color-control-nav-hover-bg: #1A2F2B;
            --color-control-search-bg: #1A2926;
            --color-control-search-border: #2F3F3C;
            --color-control-search-icon: #6A7A76;
            --color-control-button-primary-bg: #4DB8A0;
            --color-control-button-primary-hover-bg: #6DCFB8;
            --color-control-button-primary-text: #0F1A17;
            --color-control-button-secondary-bg: #1A2926;
            --color-control-button-secondary-border: #2F3F3C;
            --color-control-button-secondary-text: #E8F0EE;
            --color-control-button-ghost-text: #4DB8A0;
            --color-control-toggle-bg: #1A2926;
            --color-control-toggle-border: #2F3F3C;
            --color-control-toggle-knob: #4DB8A0;

            /* ---- Correlation Matrix Text Colors ---- */
            --correlation-high-text: #FFFFFF;  /* White text for all cells in dark mode */
            --correlation-low-text: #FFFFFF;   /* White text for all cells in dark mode */

            /* ---- Material Design System (Compatibility) ---- */
            --md-sys-color-primary: var(--color-brand-primary);
            --md-sys-color-on-primary: #0A0E1A;
            --md-sys-color-primary-container: var(--color-brand-primary-strong);
            --md-sys-color-on-primary-container: var(--color-brand-primary-soft);
            --md-sys-color-secondary: #9F90FF;
            --md-sys-color-on-secondary: #0A0E1A;
            --md-sys-color-secondary-container: #1A1730;
            --md-sys-color-on-secondary-container: #EDE9FF;
            --md-sys-color-tertiary: var(--color-brand-secondary-cyan);
            --md-sys-color-on-tertiary: #0A0E1A;

            /* Dark surfaces with midnight luxe tones */
            --md-sys-color-surface: var(--color-neutral-bg-card);
            --md-sys-color-on-surface: var(--color-neutral-text-primary);
            --md-sys-color-surface-variant: var(--color-neutral-border-strong);
            --md-sys-color-on-surface-variant: var(--color-neutral-text-secondary);
            --md-sys-color-outline: #2D3748;
            --md-sys-color-background: var(--color-neutral-bg-app);
            --md-sys-color-error: var(--color-semantic-danger);
            --md-sys-color-on-error: #FFFFFF;

            /* Dark surface hierarchy - Midnight gradient */
            --md-sys-color-surface-container: #141823;
            --md-sys-color-surface-container-high: #1E2432;
            --md-sys-color-surface-container-highest: #252B3B;

            /* Zendeep Dark mode accent variables */
            --md-warm-accent: var(--color-semantic-success);
            --md-warm-accent-light: #6EE7B7;
            --md-success-dark: var(--color-semantic-success);
            --md-warning-dark: var(--color-semantic-warning);
            --md-danger-dark: var(--color-semantic-danger);

            /* ---- Legacy Aliases (for backward compatibility) ---- */
            --color-success: var(--color-semantic-success);
            --color-success-light: var(--color-semantic-success-soft);
            --color-warning: var(--color-semantic-warning);
            --color-warning-light: var(--color-semantic-warning-soft);
            --color-danger: var(--color-semantic-danger);
            --color-danger-light: var(--color-semantic-danger-light);
            --color-info: var(--color-semantic-info);
            --color-info-light: var(--color-semantic-info-soft);
            --kpi-blue-bg: var(--color-kpi-employees-bg);
            --kpi-cyan-bg: var(--color-kpi-applicants-bg);
            --kpi-purple-bg: var(--color-kpi-attendance-bg);
            --kpi-green-bg: var(--color-kpi-new-employees-bg);

            /* ---- Interaction States (Focus & Hover) ---- */
            --color-focus-outline: #00E5CC;
            --color-focus-outline-style: 2px solid;

            /* ---- Shadow System (Dark Mode) ---- */
            /* ZenDeep Finance Shadows - Dark Mode */
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.2);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 12px 48px rgba(0, 0, 0, 0.6);
            --shadow-card: 0 0 0 1px rgba(255, 255, 255, 0.05);
            --shadow-tooltip: 0 4px 16px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 16px rgba(77, 184, 160, 0.15);
            --shadow-inner: inset 0 2px 4px rgba(0, 0, 0, 0.3);

            /* Border Radius and Transitions inherit from light mode */

            /* ---- Gradients (Dark Mode) ---- */
            --gradient-primary: linear-gradient(135deg, #4DB8A0 0%, #6DCFB8 100%);
            --gradient-secondary: linear-gradient(135deg, #3D7371 0%, #4DB8A0 100%);
            --gradient-gold: linear-gradient(135deg, #3A3020 0%, #4A4030 50%, #3A3020 100%);
            --gradient-teal: linear-gradient(135deg, #2F4540 0%, #1A2926 100%);
            --gradient-success: linear-gradient(135deg, #4DCFB0 0%, #5EE7A0 100%);
            --gradient-premium: linear-gradient(135deg, var(--color-brand-primary) 0%, var(--color-brand-secondary-gold) 100%);
            --gradient-glass: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);

            /* ---- Accent Colors (Dark Mode) ---- */
            --color-accent-coral: #FF8A65;
            --color-accent-coral-light: #2A1A14;
            --color-accent-orange: #FCA5A5;
            --color-accent-purple: #B794F4;
            --color-accent-teal: #00E5CC;

            /* ---- Percentile Distribution Colors (Dark Mode) ---- */
            --color-percentile-worst-bg: #450A0A;
            --color-percentile-worst-text: #FCA5A5;
            --color-percentile-median-bg: #0C4A6E;
            --color-percentile-median-text: #7DD3FC;
            --color-percentile-best-bg: #064E3B;
            --color-percentile-best-text: #6EE7B7;
            --color-percentile-container-bg: #141823;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        /* Allow normal scrolling on mobile where layout is stacked */
        @media (max-width: 768px) {
            html, body {
                height: auto;
                overflow: auto;
            }
        }

        body {
            font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-surface);
            transition: background-color 0.3s, color 0.3s;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            line-height: 1.6;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        .top-header {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            padding: 8px var(--spacing-3xl);
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            border-bottom: none;
            position: relative;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        .top-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.2) 50%, transparent 100%);
        }

        .top-header h1 {
            color: white;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            letter-spacing: -0.5px;
            font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .top-header .subtitle {
            font-size: 13px;
            opacity: 0.92;
            font-weight: 400;
            max-width: 800px;
            margin: 0 auto;
        }

        .app-body {
            display: flex;
            height: calc(100vh - 75px);
        }

        .left-panel {
            width: 390px;
            background: linear-gradient(180deg, rgba(255,255,255,0.95) 0%, rgba(247,249,251,0.9) 100%);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            display: flex;
            flex-direction: column;
            padding: 0;
            border-right: 1px solid rgba(255,255,255,0.5);
            box-shadow: inset -1px 0 0 rgba(255,255,255,0.2), var(--shadow-sm);
            transition: width 0.3s cubic-bezier(0.23, 1, 0.320, 1), max-height 0.3s cubic-bezier(0.23, 1, 0.320, 1);
            position: relative;
        }

        [data-theme="dark"] .left-panel {
            background: linear-gradient(180deg, rgba(20,24,35,0.95) 0%, rgba(30,36,50,0.9) 100%);
            border-right: 1px solid rgba(255,255,255,0.1);
            box-shadow: inset -1px 0 0 rgba(255,255,255,0.05), var(--shadow-md);
        }

        /* Mobile Collapse Toggle Button - Hidden by default (desktop) */
        .mobile-collapse-toggle {
            display: none;
        }

        /* Desktop Collapse Toggle Button - Hidden by default (mobile) */
        .desktop-collapse-toggle {
            display: none;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            color: var(--md-sys-color-primary);
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            transition: background-color 0.2s ease;
            margin-left: auto;
        }

        .desktop-collapse-toggle:hover {
            background-color: rgba(0, 76, 69, 0.1);
        }

        .desktop-collapse-toggle .material-icons {
            font-size: 24px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] .desktop-collapse-toggle:hover {
            background-color: rgba(77, 184, 160, 0.15);
        }

        @media (max-width: 1024px) {
            .left-panel {
                width: 320px;
            }
        }

        @media (max-width: 768px) {
            .left-panel {
                width: 100%;
                max-height: 50vh;
                border-right: none;
                border-bottom: 3px solid var(--md-sys-color-primary);
                box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.08);
            }

            .app-body {
                flex-direction: column;
            }

            .main-content {
                width: 100%;
                max-height: 50vh;
                overflow-y: auto;
            }

            /* Show toggle button only on mobile */
            .mobile-collapse-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
                background: transparent;
                border: none;
                color: var(--md-sys-color-primary);
                cursor: pointer;
                padding: 4px;
                margin-left: auto;
                border-radius: 50%;
                width: 36px;
                height: 36px;
                transition: background-color 0.2s ease, transform 0.3s ease;
            }

            .mobile-collapse-toggle:hover {
                background-color: rgba(0, 76, 69, 0.1);
            }

            .mobile-collapse-toggle .material-icons {
                font-size: 24px;
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            /* Rotate icon when collapsed */
            .left-panel.mobile-collapsed .mobile-collapse-toggle .material-icons {
                transform: rotate(180deg);
            }

            /* Panel header clickable area on mobile */
            .panel-header {
                cursor: pointer;
                flex-wrap: nowrap;
                padding: 16px 20px;
            }

            .panel-header h2 {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                font-size: 1.1rem;
                flex: 1;
                min-width: 0;
            }

            .panel-header > span.material-icons {
                flex-shrink: 0;
            }

            /* Collapsed state for left panel */
            .left-panel {
                transition: max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1);
                overflow: hidden;
            }

            .left-panel.mobile-collapsed {
                max-height: 60px; /* Height of panel-header only (adjusted for mobile padding) */
            }

            .left-panel.mobile-collapsed .panel-content {
                opacity: 0;
                visibility: hidden;
                pointer-events: none;
            }

            .left-panel.mobile-collapsed .sticky-button-wrapper {
                opacity: 0;
                visibility: hidden;
                pointer-events: none;
                position: absolute;
            }

            /* Expanded state - allow main content to use remaining space */
            .left-panel:not(.mobile-collapsed) ~ .main-content {
                max-height: 50vh;
            }

            /* When collapsed, main content gets more space */
            .left-panel.mobile-collapsed ~ .main-content {
                max-height: calc(100vh - 75px - 72px); /* viewport - header - collapsed panel */
                flex: 1;
            }

            /* Smooth transitions for content visibility */
            .panel-content,
            .sticky-button-wrapper {
                transition: opacity 0.2s ease, visibility 0.2s ease;
            }
        }

        @media (max-width: 480px) {
            .left-panel {
                max-height: 45vh;
            }

            .main-content {
                max-height: 55vh;
            }
        }

        /* ========================================
           Desktop Panel Collapse (>768px)
           Horizontal collapse to 48px with rotated header
           ======================================== */
        @media (min-width: 769px) {
            /* Show desktop toggle button */
            .desktop-collapse-toggle {
                display: flex;
            }

            /* Allow rotated text to show outside panel */
            .left-panel {
                overflow: visible;
            }

            /* Collapsed state: narrow panel with rotated header */
            .left-panel.desktop-collapsed {
                width: 48px;
            }

            /* Rotate header text vertically */
            .left-panel.desktop-collapsed .panel-header {
                padding: 24px 8px;
                justify-content: center;
            }

            .left-panel.desktop-collapsed .panel-header h2 {
                writing-mode: vertical-lr;
                transform: rotate(180deg);
                white-space: nowrap;
                margin: 0;
                font-size: 14px;
            }

            /* Hide emoji icon when collapsed */
            .left-panel.desktop-collapsed .panel-header > span.material-icons:first-child {
                display: none;
            }

            /* Hide panel content completely on desktop when collapsed */
            .left-panel.desktop-collapsed .panel-content {
                opacity: 0;
                visibility: hidden;
                pointer-events: none;
                position: absolute;
            }

            .left-panel.desktop-collapsed .sticky-button-wrapper {
                opacity: 0;
                visibility: hidden;
                pointer-events: none;
                position: absolute;
            }

            /* Smooth content transitions */
            .panel-content,
            .sticky-button-wrapper {
                transition: opacity 0.25s ease, visibility 0.25s ease;
            }
        }

        /* Left panel scrollbar styling - subtle dark theme */
        .left-panel::-webkit-scrollbar {
            width: 8px;
        }

        .left-panel::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 0;
        }

        .left-panel::-webkit-scrollbar-thumb {
            background: rgba(0, 121, 107, 0.3);
            border-radius: 4px;
            border: none;
        }

        .left-panel::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 121, 107, 0.5);
        }

        [data-theme="dark"] .left-panel::-webkit-scrollbar-thumb {
            background: rgba(74, 85, 104, 0.5);
            box-shadow: none;
        }

        [data-theme="dark"] .left-panel::-webkit-scrollbar-thumb:hover {
            background: rgba(74, 85, 104, 0.7);
        }

        [data-theme="dark"] .top-header {
            background: linear-gradient(90deg, var(--color-neutral-bg-shell) 0%, var(--color-neutral-bg-shell-light) 100%);
            box-shadow: var(--shadow-sm);
        }

        [data-theme="dark"] .top-header h1 {
            color: #FFFFFF;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] .top-header .subtitle {
            color: #E8F0EE;
            text-shadow: 0 1px 4px rgba(0, 0, 0, 0.25);
        }

        [data-theme="dark"] .left-panel {
            background: linear-gradient(180deg, var(--md-sys-color-surface) 0%, var(--md-sys-color-surface-container) 100%);
            border-right-color: var(--md-sys-color-surface-variant);
            box-shadow: inset -1px 0 0 rgba(255,255,255,0.05), 2px 0 8px rgba(0,0,0,0.2);
        }

        [data-theme="dark"] .panel-header {
            background: var(--md-sys-color-surface-container);
            border-bottom-color: var(--md-sys-color-surface-variant);
        }

        [data-theme="dark"] .panel-header h2 {
            color: var(--md-sys-color-primary);
        }

        .panel-header {
            background: var(--color-brand-primary-soft-alt);
            padding: 24px 28px;
            border-bottom: 1px solid var(--md-sys-color-outline);
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
        }

        .panel-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, rgba(76, 111, 255, 0.15) 50%, transparent 100%);
        }

        .panel-header h2 {
            font-size: var(--text-headline-md);
            font-weight: 700;
            margin: 0;
            color: var(--color-brand-primary);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        .panel-content {
            padding: 16px 24px;
            overflow-y: auto;
            flex: 1;
        }

        /* Panel content scrollbar styling - matches main content */
        .panel-content::-webkit-scrollbar {
            width: 8px;
        }

        .panel-content::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 0;
        }

        .panel-content::-webkit-scrollbar-thumb {
            background: rgba(0, 121, 107, 0.3);
            border-radius: 4px;
            border: none;
        }

        .panel-content::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 121, 107, 0.5);
        }

        [data-theme="dark"] .panel-content::-webkit-scrollbar-thumb {
            background: rgba(74, 85, 104, 0.5);
            box-shadow: none;
        }

        [data-theme="dark"] .panel-content::-webkit-scrollbar-thumb:hover {
            background: rgba(74, 85, 104, 0.7);
        }

        /* Simulation Mode Toggle */
        .simulation-mode-toggle {
            display: flex;
            background-color: var(--md-sys-color-surface-container);
            border-radius: 6px;
            padding: 4px;
            margin-bottom: 24px;
            gap: 4px;
        }

        .mode-button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: var(--md-sys-color-on-surface-variant);
            font-size: 14px;
            font-weight: 500;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.23, 1, 0.320, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .mode-button:hover {
            background: linear-gradient(135deg, var(--color-brand-primary-soft) 0%, transparent 100%);
            transform: translateY(-1px);
        }

        .mode-button.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .mode-button.active::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 5px;
            background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, transparent 100%);
        }

        [data-theme="dark"] .mode-button.active {
            background: var(--gradient-primary);
            color: var(--color-neutral-bg-app);
            box-shadow: var(--shadow-md);
        }

        .mode-button .material-icons {
            font-size: 18px;
        }

        /* Monte Carlo Specific Styles */
        .monte-carlo-content {
            display: none;
        }

        .monte-carlo-content.active {
            display: block;
        }

        .single-asset-content.hidden {
            display: none;
        }

        .asset-selector-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .asset-weight-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background-color: var(--md-sys-color-surface-container);
            border-radius: 4px;
            border: 1px solid var(--md-sys-color-outline);
        }

        .asset-color-indicator {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            flex-shrink: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            transition: transform 0.2s ease;
            align-self: flex-start;
            margin-top: 4px;
        }

        .asset-weight-item:hover .asset-color-indicator {
            transform: scale(1.15);
        }

        .asset-info-section {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .asset-info-header {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .asset-weight-item .asset-name {
            font-weight: 500;
            font-size: 13px;
            color: var(--md-sys-color-on-surface);
            line-height: 1.3;
        }

        .asset-info-badge {
            display: inline-flex;
            align-items: center;
            padding: 1px 6px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            background-color: rgba(0, 121, 107, 0.15);
            color: var(--md-sys-color-primary);
            flex-shrink: 0;
        }

        .asset-info-badge.bond {
            background-color: rgba(33, 150, 243, 0.15);
            color: #1565c0;
        }

        .asset-info-badge.commodity {
            background-color: rgba(255, 152, 0, 0.15);
            color: #e65100;
        }

        .asset-info-badge.index {
            background-color: rgba(156, 39, 176, 0.15);
            color: #7b1fa2;
        }

        .asset-info-stats {
            font-size: 11px;
            font-weight: 400;
            color: var(--md-sys-color-on-surface-variant);
            line-height: 1.3;
        }

        .asset-weight-item input[type="number"] {
            width: 70px;
            padding: 6px 8px;
            border-radius: 6px;
            font-size: 13px;
            flex-shrink: 0;
        }

        .asset-weight-item .percent-label {
            font-size: 12px;
            color: var(--md-sys-color-on-surface-variant);
            flex-shrink: 0;
        }

        .asset-weight-item .remove-asset-btn {
            background: transparent;
            border: none;
            color: var(--md-sys-color-error);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .asset-weight-item .remove-asset-btn:hover {
            background-color: rgba(179, 38, 30, 0.1);
        }

        .weight-distribution-bar {
            height: 32px;
            display: flex;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
            border: 1px solid var(--md-sys-color-outline);
        }

        .weight-segment {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        /* Portfolio weight distribution bar (in results panel) */
        .portfolio-weight-bar {
            height: 48px;
            display: flex;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 12px;
            border: 1px solid var(--md-sys-color-outline);
        }

        .portfolio-weight-bar .weight-segment {
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .add-asset-section {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .add-asset-section select {
            flex: 1;
        }

        /* Asset Listbox Styling */
        .asset-listbox-section {
            margin-bottom: 16px;
        }

        .asset-listbox {
            border: 2px solid var(--md-sys-color-outline);
            border-radius: 4px;
            background-color: var(--md-sys-color-surface);
            height: 275px;
            overflow-y: auto;
            padding: 4px;
            resize: vertical;
        }

        .asset-listbox-item {
            padding: 14px 16px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
            transition: background-color 0.2s;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant, rgba(0, 0, 0, 0.08));
        }

        .asset-listbox-item:last-child {
            border-bottom: none;
        }

        .asset-listbox-item:hover {
            background-color: rgba(0, 76, 69, 0.06);
        }

        .asset-listbox-item:active {
            background-color: rgba(0, 76, 69, 0.12);
        }

        .asset-listbox-item-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
            min-width: 0;
        }

        .asset-listbox-item-header {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .asset-listbox-item-name {
            font-weight: 500;
            font-size: 14px;
            color: var(--md-sys-color-on-surface);
        }

        .asset-listbox-item-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background-color: rgba(0, 121, 107, 0.15);
            color: var(--md-sys-color-primary);
        }

        .asset-listbox-item-badge.bond {
            background-color: rgba(33, 150, 243, 0.15);
            color: #1565c0;
        }

        .asset-listbox-item-badge.commodity {
            background-color: rgba(255, 152, 0, 0.15);
            color: #e65100;
        }

        .asset-listbox-item-badge.index {
            background-color: rgba(156, 39, 176, 0.15);
            color: #7b1fa2;
        }

        .asset-listbox-item-stats {
            font-size: 12px;
            font-weight: 400;
            color: var(--md-sys-color-on-surface-variant);
        }

        .asset-listbox-item-add-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background-color: var(--md-sys-color-surface-variant, rgba(0, 0, 0, 0.04));
            color: var(--md-sys-color-on-surface-variant);
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
            border: none;
            font-size: 18px;
        }

        .asset-listbox-item-add-btn:hover {
            background-color: rgba(0, 121, 107, 0.15);
            color: var(--md-sys-color-primary);
            transform: scale(1.05);
        }

        .asset-listbox-item-add-btn:active {
            transform: scale(0.95);
        }

        .asset-listbox-empty {
            padding: 24px;
            text-align: center;
            color: var(--md-sys-color-on-surface-variant);
            font-size: 13px;
            font-style: italic;
        }

        /* Scrollbar styling for listbox */
        .asset-listbox::-webkit-scrollbar {
            width: 8px;
        }

        .asset-listbox::-webkit-scrollbar-track {
            background: var(--md-sys-color-surface-variant);
            border-radius: 4px;
        }

        .asset-listbox::-webkit-scrollbar-thumb {
            background: var(--md-sys-color-outline);
            border-radius: 4px;
        }

        .asset-listbox::-webkit-scrollbar-thumb:hover {
            background: var(--md-sys-color-primary);
        }

        /* Portfolio Presets Styling */
        .preset-selector {
            font-size: 14px;
            padding: 10px 12px;
            border: 2px solid var(--md-sys-color-outline);
            border-radius: 4px;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
        }

        .preset-action-btn {
            background-color: rgba(0, 76, 69, 0.1);
            color: var(--color-brand-primary);
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            width: 40px;
            height: 40px;
        }

        .preset-action-btn:hover {
            background-color: var(--color-brand-primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 76, 69, 0.3);
        }

        .preset-action-btn.delete-btn {
            background-color: var(--color-semantic-danger-light);
            color: var(--color-semantic-danger);
        }

        .preset-action-btn.delete-btn:hover {
            background-color: #ffcdd2;
            color: #b71c1c;
        }

        [data-theme="dark"] .preset-action-btn.delete-btn {
            background-color: var(--color-semantic-danger-light);
            color: #ef5350;
        }

        [data-theme="dark"] .preset-action-btn.delete-btn:hover {
            background-color: #7c2828;
            color: #ff5252;
        }

        [data-theme="dark"] .preset-action-btn {
            background-color: rgba(77, 184, 160, 0.15);
            color: var(--color-brand-primary);
        }

        [data-theme="dark"] .preset-action-btn:hover {
            background-color: var(--color-brand-primary);
            color: var(--color-neutral-bg-app);
            box-shadow: 0 4px 8px rgba(77, 184, 160, 0.3);
        }

        /* Custom Modal Dialog Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 200ms ease-out;
        }

        [data-theme="dark"] .modal-overlay {
            background-color: rgba(0, 0, 0, 0.7);
        }

        .modal-card {
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            border-radius: 5px;
            padding: var(--spacing-2xl);
            min-width: 320px;
            max-width: 480px;
            box-shadow: var(--shadow-xl);
            animation: scaleIn 250ms cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 1px solid var(--md-sys-color-outline);
        }

        [data-theme="dark"] .modal-card {
            box-shadow: 0 20px 25px rgba(0, 0, 0, 0.3), 0 10px 10px rgba(0, 0, 0, 0.2);
        }

        @media (max-width: 480px) {
            .modal-card {
                min-width: 90vw;
                max-width: 90vw;
                margin: var(--spacing-lg);
            }
        }

        /* Import Summary Modal Dark Theme Adjustments */
        [data-theme="dark"] #importSummaryModal table {
            color: var(--md-sys-color-on-surface);
        }

        [data-theme="dark"] #importSummaryModal .unmatched-section {
            background-color: rgba(211, 47, 47, 0.15) !important;
            border-left-color: #ff6b6b !important;
        }

        [data-theme="dark"] #importSummaryModal .unmatched-table-container {
            background-color: rgba(0, 0, 0, 0.3) !important;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-title {
            font-size: var(--text-headline-md);
            font-weight: 700;
            margin: 0 0 var(--spacing-lg) 0;
            color: var(--md-sys-color-on-surface);
            letter-spacing: -0.01em;
        }

        .modal-message {
            font-size: 14px;
            line-height: 1.6;
            margin: 0 0 20px 0;
            color: var(--md-sys-color-on-surface-variant);
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            font-size: 14px;
            border: 2px solid var(--md-sys-color-outline);
            border-radius: 4px;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            margin-bottom: 20px;
            box-sizing: border-box;
            transition: border-color 0.2s ease;
        }

        .modal-input:focus {
            outline: none;
            border-color: var(--md-sys-color-primary);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: var(--spacing-sm) var(--spacing-lg);
            font-size: var(--text-body-sm);
            font-weight: 700;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 80px;
            letter-spacing: 0.5px;
        }

        .modal-btn-cancel {
            background-color: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface-variant);
            border: 1px solid var(--md-sys-color-outline);
        }

        .modal-btn-cancel:hover {
            background-color: var(--md-sys-color-outline);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .modal-btn-confirm {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .modal-btn-confirm:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .modal-btn-confirm.delete-action {
            background-color: var(--color-semantic-danger);
            color: white;
        }

        .modal-btn-confirm.delete-action:hover {
            background-color: #c62828;
        }

        [data-theme="dark"] .modal-btn-confirm.delete-action:hover {
            background-color: #b71c1c;
        }

        .modal-btn:active {
            transform: translateY(0);
        }

        /* Warning Banner Styles */
        .warning-banner {
            padding: 16px;
            margin: 16px 0;
            border-radius: 6px;
            border-left: 4px solid;
            display: flex;
            gap: 12px;
            align-items: flex-start;
            animation: slideIn 0.3s ease-out;
        }

        .warning-banner.critical {
            background-color: rgba(239, 68, 68, 0.1);
            border-color: var(--color-semantic-danger);
        }

        .warning-banner.warning {
            background-color: rgba(234, 179, 8, 0.1);
            border-color: var(--color-semantic-warning);
        }

        .warning-banner.info {
            background-color: rgba(66, 153, 225, 0.1);
            border-color: var(--color-semantic-info);
        }

        [data-theme="dark"] .warning-banner.critical {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.2) 0%, rgba(255, 107, 107, 0.05) 100%);
            border-color: var(--color-semantic-danger);
            box-shadow: inset 0 0 12px rgba(255, 107, 107, 0.1);
        }

        [data-theme="dark"] .warning-banner.warning {
            background: linear-gradient(135deg, rgba(255, 184, 86, 0.2) 0%, rgba(255, 184, 86, 0.05) 100%);
            border-color: var(--color-semantic-warning);
            box-shadow: inset 0 0 12px rgba(255, 184, 86, 0.1);
        }

        [data-theme="dark"] .warning-banner.info {
            background: linear-gradient(135deg, rgba(153, 204, 255, 0.2) 0%, rgba(153, 204, 255, 0.05) 100%);
            border-color: #99CCFF;
            box-shadow: inset 0 0 12px rgba(153, 204, 255, 0.1);
        }

        .warning-banner-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .warning-banner.critical .warning-banner-icon {
            color: var(--color-semantic-danger);
        }

        .warning-banner.warning .warning-banner-icon {
            color: var(--color-semantic-warning);
        }

        .warning-banner.info .warning-banner-icon {
            color: var(--color-semantic-info);
        }

        .warning-banner-content h4 {
            margin: 0 0 8px 0;
            font-size: 16px;
            font-weight: 600;
        }

        .warning-banner-content p {
            margin: 0;
            line-height: 1.6;
        }

        /* 
           GUARDRAILS DESIGN SYSTEM - Monte Carlo Results Redesign
           Inspired by ZenDeep Finance Design System
            */

        /* Status Banner - Hero Component */
        .guardrails-status-banner {
            position: relative;
            display: flex;
            align-items: center;
            gap: 1.25rem;
            padding: 1.25rem 1.75rem;
            background: var(--md-sys-color-surface);
            border-radius: 1rem;
            margin-bottom: 3px;
            box-shadow: 0 10px 20px rgba(0, 121, 107, 0.1);
            overflow: hidden;
            animation: bannerSlideIn 0.6s cubic-bezier(0.23, 1, 0.32, 1);
        }

        [data-theme="dark"] .guardrails-status-banner {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        @keyframes bannerSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .guardrails-status-banner::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
        }

        .guardrails-status-banner.status-green::before {
            background: linear-gradient(135deg, #10B981 0%, #6BCB77 100%);
        }

        .guardrails-status-banner.status-yellow::before {
            background: linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%);
        }

        .guardrails-status-banner.status-red::before {
            background: linear-gradient(135deg, #EF4444 0%, #F87171 100%);
        }

        /* Status Banner Card Wrapper */
        .status-banner-card {
            margin-bottom: 1rem;
        }

        .status-icon-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .status-green .status-icon-container {
            background: rgba(16, 185, 129, 0.15);
        }

        .status-yellow .status-icon-container {
            background: rgba(245, 158, 11, 0.15);
        }

        .status-red .status-icon-container {
            background: rgba(239, 68, 68, 0.15);
        }

        .status-icon-container .material-icons {
            font-size: 28px;
        }

        .status-green .status-icon-container .material-icons {
            color: #10B981;
        }

        .status-yellow .status-icon-container .material-icons {
            color: #F59E0B;
        }

        .status-red .status-icon-container .material-icons {
            color: #EF4444;
        }

        /* Pulsing animation for warning/danger states */
        .status-yellow .status-icon-container::after,
        .status-red .status-icon-container::after {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            animation: statusPulse 2s ease-in-out infinite;
        }

        .status-yellow .status-icon-container::after {
            border: 2px solid #F59E0B;
        }

        .status-red .status-icon-container::after {
            border: 2px solid #EF4444;
        }

        @keyframes statusPulse {
            0%, 100% { opacity: 0; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(1.1); }
        }

        .status-content {
            flex: 1;
        }

        .status-title {
            font-family: 'Plus Jakarta Sans', 'Inter', system-ui, sans-serif;
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            letter-spacing: -0.01em;
        }

        .status-green .status-title { color: #10B981; }
        .status-yellow .status-title { color: #F59E0B; }
        .status-red .status-title { color: #EF4444; }

        .status-message {
            font-size: 0.95rem;
            color: var(--md-sys-color-on-surface-variant);
            line-height: 1.5;
        }

        .status-action-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            background: var(--md-sys-color-surface-container-high);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: 50px;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--md-sys-color-on-surface-variant);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
            flex-shrink: 0;
        }

        .status-action-btn:hover {
            background: rgba(0, 121, 107, 0.1);
            border-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-primary);
        }

        .status-action-btn .material-icons {
            font-size: 1.125rem;
        }

        /* Guardrail Metric Cards Grid */
        .guardrails-cards-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        @media (max-width: 968px) {
            .guardrails-cards-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .guardrails-cards-grid {
                grid-template-columns: 1fr;
            }

            .guardrails-status-banner {
                flex-direction: column;
                text-align: center;
                padding: 1.5rem 1rem;
            }

            .status-action-btn {
                width: 100%;
                justify-content: center;
            }
        }

        .guardrail-metric-card {
            position: relative;
            background: var(--md-sys-color-surface);
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid var(--md-sys-color-outline-variant);
            box-shadow: 0 4px 6px rgba(0, 121, 107, 0.07);
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            cursor: default;
            overflow: hidden;
            animation: cardFadeIn 0.6s cubic-bezier(0.23, 1, 0.32, 1) backwards;
        }

        .guardrail-metric-card:nth-child(1) { animation-delay: 0.1s; }
        .guardrail-metric-card:nth-child(2) { animation-delay: 0.2s; }
        .guardrail-metric-card:nth-child(3) { animation-delay: 0.3s; }

        @keyframes cardFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .guardrail-metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 121, 107, 0.15);
            border-color: var(--md-sys-color-primary);
        }

        [data-theme="dark"] .guardrail-metric-card:hover {
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        .guardrail-metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .guardrail-metric-card.card-green::before { background: linear-gradient(135deg, #10B981 0%, #6BCB77 100%); }
        .guardrail-metric-card.card-yellow::before { background: linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%); }
        .guardrail-metric-card.card-red::before { background: linear-gradient(135deg, #EF4444 0%, #F87171 100%); }

        .card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 1.25rem;
        }

        .card-title-group {
            flex: 1;
        }

        .card-title {
            font-family: 'Plus Jakarta Sans', 'Inter', system-ui, sans-serif;
            font-size: 1rem;
            font-weight: 700;
            color: var(--md-sys-color-on-surface);
            margin-bottom: 0.125rem;
        }

        .card-subtitle {
            font-size: 0.8rem;
            color: var(--md-sys-color-on-surface-variant);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .card-status-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
        }

        .card-green .card-status-badge {
            background: rgba(16, 185, 129, 0.15);
            color: #10B981;
        }

        .card-yellow .card-status-badge {
            background: rgba(245, 158, 11, 0.15);
            color: #F59E0B;
        }

        .card-red .card-status-badge {
            background: rgba(239, 68, 68, 0.15);
            color: #EF4444;
        }

        .card-status-badge .material-icons {
            font-size: 1.25rem;
        }

        .card-metrics {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .metric-primary {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
        }

        .metric-value {
            font-family: 'Plus Jakarta Sans', 'Inter', system-ui, sans-serif;
            font-size: 2.25rem;
            font-weight: 800;
            letter-spacing: -0.02em;
            line-height: 1;
        }

        .card-green .metric-value { color: #10B981; }
        .card-yellow .metric-value { color: #F59E0B; }
        .card-red .metric-value { color: #EF4444; }

        .metric-suffix {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--md-sys-color-on-surface-variant);
        }

        .metric-label {
            font-size: 0.8rem;
            color: var(--md-sys-color-on-surface-variant);
            margin-top: 0.25rem;
        }

        .metric-secondary {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: 1rem;
            border-top: 1px solid var(--md-sys-color-outline-variant);
        }

        .secondary-item {
            display: flex;
            flex-direction: column;
        }

        .secondary-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
        }

        .secondary-value.positive {
            color: #10B981;
        }

        .secondary-value.positive::before {
            content: '+';
        }

        .secondary-value.negative {
            color: #EF4444;
        }

        .secondary-label {
            font-size: 0.75rem;
            color: var(--md-sys-color-on-surface-variant);
        }

        .worst-case {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--md-sys-color-surface-container-low);
            border-radius: 0.5rem;
            margin-top: 1rem;
        }

        .worst-case-icon {
            font-size: 1rem;
            color: var(--md-sys-color-on-surface-variant);
        }

        .worst-case-text {
            font-size: 0.8rem;
            color: var(--md-sys-color-on-surface-variant);
        }

        .worst-case-value {
            font-weight: 600;
            color: #FF6B6B;
        }

        /* Recommendations Section */
        .guardrails-recommendations {
            margin-bottom: 1.5rem;
            animation: fadeInUp 0.6s cubic-bezier(0.23, 1, 0.32, 1) 0.4s backwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .recommendations-container {
            background: var(--md-sys-color-surface);
            border-radius: 1rem;
            border: 1px solid var(--md-sys-color-outline-variant);
            box-shadow: 0 4px 6px rgba(0, 121, 107, 0.07);
            overflow: hidden;
        }

        [data-theme="dark"] .recommendations-container {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .recommendations-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            background: var(--md-sys-color-surface-container-low);
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .recommendations-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-family: 'Plus Jakarta Sans', 'Inter', system-ui, sans-serif;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
        }

        .recommendations-title .material-icons {
            color: var(--md-sys-color-primary);
        }

        .recommendations-count {
            padding: 0.25rem 0.625rem;
            background: var(--md-sys-color-primary);
            color: white;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .recommendations-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .recommendation-item {
            display: flex;
            gap: 1rem;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
            transition: background 0.2s ease;
        }

        .recommendation-item:last-child {
            border-bottom: none;
        }

        .recommendation-item:hover {
            background: var(--md-sys-color-surface-container-low);
        }

        .recommendation-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 0.625rem;
            flex-shrink: 0;
        }

        .recommendation-item.critical .recommendation-icon {
            background: rgba(239, 68, 68, 0.15);
            color: #EF4444;
        }

        .recommendation-item.warning .recommendation-icon {
            background: rgba(245, 158, 11, 0.15);
            color: #F59E0B;
        }

        .recommendation-item.opportunity .recommendation-icon {
            background: rgba(16, 185, 129, 0.15);
            color: #10B981;
        }

        .recommendation-item.info .recommendation-icon {
            background: rgba(14, 165, 233, 0.15);
            color: #0EA5E9;
        }

        .recommendation-content {
            flex: 1;
        }

        .recommendation-message {
            font-size: 0.95rem;
            color: var(--md-sys-color-on-surface);
            margin-bottom: 0.375rem;
            line-height: 1.5;
        }

        .recommendation-action {
            font-size: 0.85rem;
            color: var(--md-sys-color-on-surface-variant);
        }

        .recommendation-action strong {
            color: var(--md-sys-color-primary);
            font-weight: 600;
        }

        /* Collapsible Simulation Details */
        .simulation-details-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 1rem 1.5rem;
            background: var(--md-sys-color-surface);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .simulation-details-toggle:hover {
            background: var(--md-sys-color-surface-container-low);
            border-color: var(--md-sys-color-primary);
        }

        .simulation-details-toggle .toggle-label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
        }

        .simulation-details-toggle .toggle-label .material-icons {
            color: var(--md-sys-color-primary);
        }

        .simulation-details-toggle .toggle-icon {
            transition: transform 0.3s ease;
        }

        .simulation-details-toggle.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        .simulation-details-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }

        .simulation-details-content.expanded {
            max-height: 2000px;
        }

        /* Section Header with Badge */
        .guardrails-section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }

        .guardrails-section-title {
            font-family: 'Plus Jakarta Sans', 'Inter', system-ui, sans-serif;
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
        }

        .guardrails-section-badge {
            padding: 0.25rem 0.75rem;
            background: rgba(0, 121, 107, 0.1);
            color: var(--md-sys-color-primary);
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Mobile responsive adjustments for recommendations */
        @media (max-width: 768px) {
            .recommendations-header {
                padding: 1rem;
            }

            .recommendation-item {
                padding: 1rem;
            }
        }

        .correlation-matrix {
            width: 100%;
            font-size: 12px;
            margin-top: 12px;
        }

        .correlation-matrix td, .correlation-matrix th {
            text-align: center;
            padding: 8px 4px;
        }

        .correlation-cell {
            border-radius: 0;
            font-weight: 600;
        }

        .correlation-positive {
            background-color: rgba(76, 175, 80, 0.3);
            color: var(--color-semantic-success);
        }

        .correlation-negative {
            background-color: rgba(244, 67, 54, 0.3);
            color: var(--color-semantic-danger);
        }

        [data-theme="dark"] .correlation-positive {
            background: linear-gradient(135deg, rgba(155, 217, 153, 0.3) 0%, rgba(129, 199, 132, 0.15) 100%);
            color: #A8EFA8;
            border: 1px solid #9BD999;
            border-radius: 4px;
            box-shadow: 0 0 8px rgba(155, 217, 153, 0.1);
        }

        [data-theme="dark"] .correlation-negative {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.3) 0%, rgba(239, 83, 80, 0.15) 100%);
            color: #FF8989;
            border: 1px solid #FF6B6B;
            border-radius: 4px;
            box-shadow: 0 0 8px rgba(255, 107, 107, 0.1);
        }

        /* Monte Carlo Progress Overlay */
        .monte-carlo-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.80);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .progress-card {
            background: var(--md-sys-color-surface);
            border-radius: 5px;
            padding: 56px 48px;
            min-width: 550px;
            max-width: 90vw;
            box-shadow: 0 12px 48px rgba(0,0,0,0.4);
            border: 3px solid transparent;
            background-clip: padding-box;
            position: relative;
            animation: scaleIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .progress-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 5px;
            padding: 3px;
            background: linear-gradient(135deg, #0F766E, #80CCC0, #047857, #80CCC0, #0F766E);
            background-size: 300% 300%;
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            animation: gradientShift 3s ease infinite;
            z-index: -1;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .progress-icon {
            font-size: 80px;
            color: var(--md-sys-color-primary);
            animation: pulse 2s ease-in-out infinite, spin 4s linear infinite;
            display: inline-block;
            text-shadow: 0 4px 12px rgba(0, 76, 69, 0.3);
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.7;
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .progress-title {
            font-size: var(--text-headline-lg);
            font-weight: 700;
            margin: var(--spacing-lg) 0 var(--spacing-md);
            color: var(--md-sys-color-on-surface);
            letter-spacing: -0.01em;
        }

        .progress-subtitle {
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: var(--spacing-2xl);
            font-size: var(--text-body-md);
            line-height: 1.6;
        }

        .progress-bar-container {
            height: 36px;
            background: var(--md-sys-color-surface-container);
            border-radius: 9px;
            overflow: hidden;
            margin: var(--spacing-2xl) 0 var(--spacing-lg);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid var(--md-sys-color-outline);
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--gradient-primary);
            background-size: 200% 200%;
            transition: width 0.5s cubic-bezier(0.4, 0.0, 0.2, 1);
            border-radius: 9px;
            position: relative;
            box-shadow: 0 0 24px rgba(0, 76, 69, 0.4);
        }

        .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 1.5s infinite;
        }

        @keyframes gradientFlow {
            0% { background-position: 0% 50%; }
            100% { background-position: 300% 50%; }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(200%); }
        }

        .progress-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
        }

        .progress-percentage {
            font-size: 32px;
            font-weight: 700;
            color: var(--color-brand-primary);
            letter-spacing: -1px;
        }

        .progress-counter {
            font-size: 16px;
            color: var(--md-sys-color-on-surface-variant);
            font-weight: 500;
        }

        .progress-status-message {
            text-align: center;
            margin-top: 24px;
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
            font-style: italic;
            min-height: 20px;
            animation: fadeInOut 2s ease-in-out infinite;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        [data-theme="dark"] .progress-card {
            box-shadow: 0 12px 48px rgba(0,0,0,0.8);
        }

        [data-theme="dark"] .progress-icon {
            color: var(--md-sys-color-primary);
        }

        [data-theme="dark"] .progress-percentage {
            color: var(--md-sys-color-primary);
        }

        [data-theme="dark"] .progress-bar-fill {
            box-shadow: 0 0 20px rgba(74, 125, 200, 0.6);
        }

        /* Mobile responsive styles for progress card */
        @media (max-width: 768px) {
            .progress-card {
                min-width: unset;
                width: calc(100vw - 32px);
                max-width: calc(100vw - 32px);
                padding: 32px 24px;
                margin: 0 16px;
            }

            .progress-icon {
                font-size: 60px;
            }

            .progress-title {
                font-size: 20px;
            }

            .progress-subtitle {
                font-size: 14px;
            }

            .progress-percentage {
                font-size: 24px;
            }

            .progress-counter {
                font-size: 14px;
            }

            .progress-bar-container {
                height: 28px;
                border-radius: 7px;
            }

            .progress-bar-fill {
                border-radius: 7px;
            }
        }

        @media (max-width: 480px) {
            .progress-card {
                padding: 24px 16px;
                width: calc(100vw - 24px);
                max-width: calc(100vw - 24px);
                margin: 0 12px;
            }

            .progress-icon {
                font-size: 48px;
            }

            .progress-title {
                font-size: 18px;
            }

            .progress-subtitle {
                font-size: 13px;
            }

            .progress-percentage {
                font-size: 20px;
            }

            .progress-stats {
                flex-direction: column;
                gap: 8px;
                align-items: center;
            }
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background-color: var(--md-sys-color-background);
        }

        /* Main content scrollbar styling - subtle dark theme */
        .main-content::-webkit-scrollbar {
            width: 8px;
        }

        .main-content::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 0;
        }

        .main-content::-webkit-scrollbar-thumb {
            background: rgba(0, 121, 107, 0.3);
            border-radius: 4px;
            border: none;
        }

        .main-content::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 121, 107, 0.5);
        }

        [data-theme="dark"] .main-content::-webkit-scrollbar-thumb {
            background: rgba(74, 85, 104, 0.5);
            box-shadow: none;
        }

        [data-theme="dark"] .main-content::-webkit-scrollbar-thumb:hover {
            background: rgba(74, 85, 104, 0.7);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--md-sys-color-outline);
        }

        h1 {
            font-size: var(--text-display-md);
            font-weight: 700;
            margin-bottom: var(--spacing-lg);
            color: var(--md-sys-color-on-surface);
            letter-spacing: -0.02em;
        }

        h2 {
            font-size: var(--text-headline-lg);
            font-weight: 700;
            margin-bottom: var(--spacing-lg);
            color: var(--md-sys-color-on-surface);
            letter-spacing: -0.01em;
        }

        h3 {
            font-size: var(--text-headline-md);
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            color: var(--md-sys-color-on-surface);
        }

        h4 {
            font-size: var(--text-headline-sm);
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            color: var(--md-sys-color-on-surface);
        }

        p {
            font-size: var(--text-body-md);
            line-height: 1.6;
            color: var(--md-sys-color-on-surface);
        }

        label {
            font-size: var(--text-body-sm);
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
            display: block;
            margin-bottom: var(--spacing-sm);
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.35);
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: all 0.2s ease;
            width: 40px;
            height: 40px;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.15);
        }

        .theme-toggle .material-icons {
            font-size: 20px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .material-icons {
            font-size: 24px;
        }

        .input-group {
            margin-bottom: var(--spacing-xl);
            display: flex;
            flex-direction: column;
        }

        label {
            display: block;
            margin-bottom: var(--spacing-sm);
            font-size: var(--text-body-sm);
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
            transition: color 0.2s ease;
            white-space: nowrap;
        }

        .input-group:focus-within label {
            color: var(--md-sys-color-primary);
        }

        .helper-text {
            font-size: 12px;
            color: var(--md-sys-color-on-surface-variant);
            margin-top: var(--spacing-xs);
            font-style: italic;
            line-height: 1.4;
        }

        /* ========================================
           Regime Mode Toggle - Segmented Control
           ======================================== */

        .regime-mode-toggle {
            margin-top: 16px;
            padding: 16px;
            background: linear-gradient(135deg, rgba(0, 76, 69, 0.04) 0%, rgba(0, 76, 69, 0.02) 100%);
            border: 1px solid rgba(0, 76, 69, 0.12);
            border-radius: 8px;
        }

        .regime-mode-toggle.hidden {
            display: none;
        }

        .regime-mode-toggle .input-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-weight: 500;
            font-size: 14px;
            color: var(--md-sys-color-on-surface);
        }

        .regime-mode-toggle .info-tooltip-container {
            position: static;
        }

        .regime-mode-toggle .info-tooltip {
            position: fixed;
            bottom: auto;
            left: auto;
            right: auto;
            transform: none;
            z-index: 10000;
        }

        .regime-mode-toggle .info-tooltip::before {
            display: none;
        }

        .regime-mode-toggle .info-icon:hover + .info-tooltip,
        .regime-mode-toggle .info-icon:focus + .info-tooltip {
            opacity: 1;
            visibility: visible;
            transform: none;
            pointer-events: auto;
        }

        .segmented-control {
            display: flex;
            position: relative;
            background: rgba(0, 0, 0, 0.06);
            border-radius: 8px;
            padding: 4px;
            gap: 4px;
        }

        .segmented-control input[type="radio"] {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        .segment-label {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.2s ease;
            z-index: 1;
            user-select: none;
        }

        .segment-label:hover {
            color: #333;
        }

        .segment-icon {
            font-size: 16px;
        }

        .segmented-control input[type="radio"]:checked + .segment-label {
            color: #004C45;
            font-weight: 600;
        }

        .segment-slider {
            position: absolute;
            top: 4px;
            left: 4px;
            width: calc(50% - 6px);
            height: calc(100% - 8px);
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 0;
        }

        .segmented-control input[type="radio"]#regimeModeConservative:checked ~ .segment-slider {
            transform: translateX(calc(100% + 4px));
        }

        .regime-mode-description {
            margin-top: 12px;
            font-size: 13px;
            color: #666;
            line-height: 1.5;
            min-height: 40px;
            transition: opacity 0.2s ease;
        }

        /* Dark mode support for regime toggle */
        [data-theme="dark"] .regime-mode-toggle {
            background: linear-gradient(135deg, rgba(0, 200, 180, 0.08) 0%, rgba(0, 200, 180, 0.04) 100%);
            border-color: rgba(0, 200, 180, 0.2);
        }

        [data-theme="dark"] .segmented-control {
            background: rgba(255, 255, 255, 0.08);
        }

        [data-theme="dark"] .segment-label {
            color: #aaa;
        }

        [data-theme="dark"] .segment-label:hover {
            color: #ddd;
        }

        [data-theme="dark"] .segmented-control input[type="radio"]:checked + .segment-label {
            color: #00C8B4;
        }

        [data-theme="dark"] .segment-slider {
            background: rgba(0, 200, 180, 0.15);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] .regime-mode-description {
            color: #999;
        }

        /* Mobile responsive for regime toggle */
        @media (max-width: 480px) {
            .segment-label {
                padding: 8px 12px;
                font-size: 13px;
            }

            .segment-icon {
                font-size: 14px;
            }

            .segment-text {
                display: inline;
            }
        }

        /* Refined Info Tooltip System */
        .info-tooltip-container {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--md-sys-color-primary) 0%, var(--md-sys-color-tertiary) 100%);
            color: white;
            font-size: 11px;
            font-weight: 700;
            font-family: 'Segoe UI', system-ui, sans-serif;
            cursor: help;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .info-icon:hover {
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(0, 131, 110, 0.3);
        }

        .info-icon:focus {
            outline: 2px solid var(--md-sys-color-primary);
            outline-offset: 2px;
        }

        .info-tooltip {
            position: absolute;
            bottom: calc(100% + 12px);
            left: 50%;
            transform: translateX(-50%) translateY(4px);
            min-width: 340px;
            max-width: 420px;
            padding: 16px 18px;
            background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFB 100%);
            border: 1px solid rgba(0, 131, 110, 0.15);
            border-radius: 6px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.08);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            pointer-events: none;
        }

        .info-tooltip::before {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: #FFFFFF;
            filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.05));
        }

        .info-icon:hover + .info-tooltip,
        .info-icon:focus + .info-tooltip,
        .info-tooltip:hover {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
            pointer-events: auto;
        }

        .info-tooltip-title {
            font-size: 13px;
            font-weight: 700;
            color: var(--md-sys-color-primary);
            margin-bottom: 8px;
            letter-spacing: 0.3px;
            font-family: 'Segoe UI Semibold', 'Segoe UI', system-ui, sans-serif;
        }

        .info-tooltip-content {
            font-size: 12px;
            line-height: 1.6;
            color: var(--md-sys-color-on-surface);
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        .info-tooltip-content strong {
            color: var(--md-sys-color-primary);
            font-weight: 600;
        }

        .info-tooltip-list {
            margin: 8px 0 0 0;
            padding-left: 18px;
            font-size: 11.5px;
            line-height: 1.7;
            color: var(--md-sys-color-on-surface-variant);
        }

        .info-tooltip-list li {
            margin-bottom: 4px;
        }

        .info-tooltip-list li:last-child {
            margin-bottom: 0;
        }

        /* Dark theme support */
        [data-theme="dark"] .info-tooltip {
            background: linear-gradient(135deg, #1a1f2e 0%, #242938 100%);
            border-color: rgba(0, 131, 110, 0.25);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] .info-tooltip::before {
            border-top-color: #1a1f2e;
        }

        [data-theme="dark"] .info-icon {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] .info-icon:hover {
            box-shadow: 0 4px 12px rgba(0, 131, 110, 0.5);
        }

        .error-text {
            font-size: 12px;
            color: var(--md-sys-color-error);
            margin-top: var(--spacing-xs);
            font-weight: 500;
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #E5E7EB;
            border-radius: 4px;
            font-size: 14px;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: #FFFFFF;
            color: var(--md-sys-color-on-surface);
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(76, 111, 255, 0.04);
        }

        input[type="text"]:hover,
        input[type="number"]:hover,
        textarea:hover,
        select:hover {
            border-color: #CBD5F5;
            background-color: #FFFFFF;
        }

        input[type="text"]:focus-visible,
        input[type="number"]:focus-visible,
        textarea:focus-visible,
        select:focus-visible {
            outline: none;
            border-color: var(--color-brand-primary);
            box-shadow: 0 0 0 3px var(--color-brand-primary-soft);
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--color-brand-primary);
            box-shadow: 0 0 0 3px var(--color-brand-primary-soft);
        }

        /* Input validation states */
        input[type="text"].error,
        input[type="number"].error,
        textarea.error,
        select.error {
            border-color: var(--md-sys-color-error);
        }

        input[type="text"].error:focus,
        input[type="number"].error:focus,
        textarea.error:focus,
        select.error:focus {
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }

        input[type="text"].success,
        input[type="number"].success {
            border-color: #22C55E;
        }

        input[type="text"].success:focus,
        input[type="number"].success:focus {
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
        }

        [data-theme="dark"] input[type="text"],
        [data-theme="dark"] input[type="number"],
        [data-theme="dark"] textarea,
        [data-theme="dark"] select {
            background-color: #232F45;
            color: #E3E8E7;
            border-color: #2D3F5C;
        }

        [data-theme="dark"] input[type="text"]:hover,
        [data-theme="dark"] input[type="number"]:hover,
        [data-theme="dark"] textarea:hover,
        [data-theme="dark"] select:hover {
            border-color: #3D5174;
            background-color: #2A3850;
        }

        [data-theme="dark"] input[type="text"]:focus-visible,
        [data-theme="dark"] input[type="number"]:focus-visible,
        [data-theme="dark"] textarea:focus-visible,
        [data-theme="dark"] select:focus-visible,
        [data-theme="dark"] input[type="text"]:focus,
        [data-theme="dark"] input[type="number"]:focus,
        [data-theme="dark"] textarea:focus,
        [data-theme="dark"] select:focus {
            border-color: var(--color-brand-primary);
            box-shadow: 0 0 0 3px var(--color-brand-primary-soft);
        }

        [data-theme="dark"] input[type="text"].error,
        [data-theme="dark"] input[type="number"].error,
        [data-theme="dark"] textarea.error,
        [data-theme="dark"] select.error {
            border-color: #FF6B6B;
        }

        [data-theme="dark"] input[type="text"].success,
        [data-theme="dark"] input[type="number"].success {
            border-color: #4ADE80;
        }

        textarea {
            resize: vertical;
            min-height: 120px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            border-radius: 8px !important;
        }

        /* Scrollbar styling for select and textarea to match left panel */
        select::-webkit-scrollbar,
        textarea::-webkit-scrollbar {
            width: 10px;
        }

        select::-webkit-scrollbar-track,
        textarea::-webkit-scrollbar-track {
            background: var(--md-sys-color-surface-container);
            border-radius: 0;
        }

        select::-webkit-scrollbar-thumb,
        textarea::-webkit-scrollbar-thumb {
            background: var(--color-brand-primary);
            border-radius: 5px;
            border: 2px solid var(--color-neutral-bg-card-soft);
        }

        select::-webkit-scrollbar-thumb:hover,
        textarea::-webkit-scrollbar-thumb:hover {
            background: var(--color-brand-primary-strong);
        }

        [data-theme="dark"] select::-webkit-scrollbar-thumb,
        [data-theme="dark"] textarea::-webkit-scrollbar-thumb {
            background: var(--color-brand-primary);
        }

        [data-theme="dark"] select::-webkit-scrollbar-thumb:hover,
        [data-theme="dark"] textarea::-webkit-scrollbar-thumb:hover {
            background: var(--color-brand-primary-strong);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            cursor: pointer;
            accent-color: var(--md-sys-color-primary);
        }

        .checkbox-group label {
            margin-bottom: 0;
            cursor: pointer;
        }

        /* ========================================
           Parameter Group Sections
           Logical grouping for form parameters
           ======================================== */

        .param-group {
            background: linear-gradient(135deg, rgba(27, 75, 75, 0.03) 0%, rgba(27, 75, 75, 0.01) 100%);
            border: 1px solid rgba(27, 75, 75, 0.08);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 20px;
            position: relative;
        }

        .param-group::before {
            content: '';
            position: absolute;
            left: 0;
            top: 12px;
            bottom: 12px;
            width: 3px;
            background: var(--color-brand-primary);
            border-radius: 0 2px 2px 0;
            opacity: 0.4;
        }

        .param-group-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 14px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(27, 75, 75, 0.08);
        }

        .param-group-icon {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(27, 75, 75, 0.08);
            border-radius: var(--radius-sm);
            color: var(--color-brand-primary);
            font-size: 16px;
        }

        .param-group-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--color-brand-primary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin: 0;
        }

        .param-group .input-group:last-child,
        .param-group .checkbox-group:last-child,
        .param-group .grid-3-col:last-child {
            margin-bottom: 0;
        }

        .param-group .input-group {
            margin-bottom: 16px;
        }

        /* Dark mode adjustments for param groups */
        [data-theme="dark"] .param-group {
            background: linear-gradient(135deg, rgba(77, 184, 160, 0.06) 0%, rgba(77, 184, 160, 0.02) 100%);
            border-color: rgba(77, 184, 160, 0.15);
        }

        [data-theme="dark"] .param-group::before {
            background: var(--color-brand-primary);
            opacity: 0.6;
        }

        [data-theme="dark"] .param-group-header {
            border-bottom-color: rgba(77, 184, 160, 0.12);
        }

        [data-theme="dark"] .param-group-icon {
            background: rgba(77, 184, 160, 0.15);
            color: var(--color-brand-primary);
        }

        [data-theme="dark"] .param-group-title {
            color: var(--color-brand-primary);
        }

        /* Optional/Advanced indicator */
        .param-group-optional {
            font-size: 11px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
            background: rgba(0, 0, 0, 0.04);
            padding: 2px 8px;
            border-radius: var(--radius-full);
            margin-left: auto;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        [data-theme="dark"] .param-group-optional {
            background: rgba(255, 255, 255, 0.08);
        }

        .button {
            padding: 12px 28px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.23, 1, 0.320, 1);
            text-transform: uppercase;
            letter-spacing: 0.02em;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .button::before {
            content: '';
            position: absolute;
            inset: 0;
            background: var(--gradient-glass);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .button:hover::before {
            opacity: 1;
        }

        .button-primary {
            background: var(--gradient-primary);
            color: white;
            width: 100%;
            padding: 16px var(--spacing-xl);
            font-size: var(--text-body-lg);
            margin-top: 0px;
            box-shadow: var(--shadow-md);
            border-radius: 5px;
            font-weight: 600;
            font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            letter-spacing: 0.02em;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .button-primary::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, transparent 50%, rgba(0,0,0,0.1) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .button-primary:hover {
            box-shadow: var(--shadow-lg), var(--shadow-glow);
            transform: translateY(-2px) scale(1.02);
        }

        .button-primary:hover::after {
            opacity: 1;
        }

        .button-primary:active {
            transform: translateY(0px) scale(0.98);
            box-shadow: var(--shadow-inner);
        }

        .sticky-button-wrapper {
            flex-shrink: 0;
            background-color: var(--md-sys-color-surface);
            padding: 15px 20px;
            margin: 0;
            border-top: 1px solid var(--md-sys-color-outline);
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
        }

        .button-secondary {
            background: var(--gradient-secondary);
            color: white;
            margin-top: var(--spacing-sm);
            width: 100%;
            font-weight: 600;
            box-shadow: var(--shadow-sm);
            border-radius: 8px;
            padding: 14px 24px;
            border: 1.5px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .button-secondary::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, transparent 50%, rgba(0,0,0,0.05) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .button-secondary:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px) scale(1.02);
        }

        .button-secondary:hover::after {
            opacity: 1;
        }

        .button-secondary:active {
            transform: translateY(0) scale(0.98);
            box-shadow: var(--shadow-inner);
        }

        [data-theme="dark"] .button-primary {
            background: var(--gradient-primary);
            color: var(--color-neutral-bg-app);
            box-shadow: var(--shadow-md);
        }

        [data-theme="dark"] .button-primary:hover {
            box-shadow: var(--shadow-lg), var(--shadow-glow);
        }

        [data-theme="dark"] .button-secondary {
            background: var(--gradient-secondary);
            box-shadow: var(--shadow-sm);
            color: var(--color-neutral-bg-app);
        }

        [data-theme="dark"] .button-secondary:hover {
            background: linear-gradient(135deg, #4DB8A0 0%, #6DCFB8 100%);
            box-shadow: 0 4px 14px rgba(77, 184, 160, 0.4);
            color: var(--color-neutral-bg-app);
        }

        /* Clear All Assets Button */
        .button-clear-all {
            background: transparent;
            color: #D97706;
            border: 1.5px solid #F59E0B;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .button-clear-all::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(245, 158, 11, 0.15) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .button-clear-all:hover {
            background: rgba(251, 191, 36, 0.1);
            border-color: #FBBF24;
            color: #F59E0B;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
        }

        .button-clear-all:hover::before {
            opacity: 1;
        }

        .button-clear-all:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.15);
        }

        [data-theme="dark"] .button-clear-all {
            color: #FCD34D;
            border-color: #FBBF24;
        }

        [data-theme="dark"] .button-clear-all::before {
            background: linear-gradient(135deg, rgba(252, 211, 77, 0.08) 0%, rgba(251, 191, 36, 0.12) 100%);
        }

        [data-theme="dark"] .button-clear-all:hover {
            background: rgba(252, 211, 77, 0.12);
            border-color: #FDE68A;
            color: #FDE68A;
            box-shadow: 0 4px 14px rgba(251, 191, 36, 0.25);
        }

        /* Portfolio Control Buttons (Balance Weights, Clear All) */
        .button-portfolio-control {
            font-size: 12px;
            padding: 8.5px 14px;
            flex: 1;
            white-space: nowrap;
            height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            margin-top: 0;
        }

        .button-force-refresh {
            background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
            color: white;
            font-weight: 500;
            flex: 0 0 auto;
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(74, 85, 104, 0.25);
        }

        .button-force-refresh:hover {
            background: linear-gradient(135deg, #818ea4 0%, #5a6678 100%);
            box-shadow: 0 4px 10px rgba(74, 85, 104, 0.35);
            transform: translateY(-1px);
        }

        .button-force-refresh:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(74, 85, 104, 0.3);
        }

        [data-theme="dark"] .button-force-refresh {
            background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
            box-shadow: 0 2px 6px rgba(148, 163, 184, 0.3);
        }

        [data-theme="dark"] .button-force-refresh:hover {
            background: linear-gradient(135deg, #a8b8cf 0%, #748599 100%);
            box-shadow: 0 4px 10px rgba(148, 163, 184, 0.4);
        }

        /* Fetch Historical Data Button */
        .button-fetch {
            background: linear-gradient(135deg, var(--color-brand-primary) 0%, var(--color-brand-primary-strong) 100%);
            color: black;
            font-style: var(--color-neutral-text-primary);
            font-weight: 600;
            border-radius: 4px;
            padding: 12px 24px;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0, 76, 69, 0.2);
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .button-fetch:hover {
            background: linear-gradient(135deg, var(--color-brand-primary-strong) 0%, var(--color-brand-primary) 100%);
            box-shadow: 0 4px 12px rgba(0, 76, 69, 0.3);
            transform: translateY(-2px);
        }

        .button-fetch:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 76, 69, 0.2);
        }

        [data-theme="dark"] .button-fetch {
            background: linear-gradient(135deg, var(--color-brand-primary) 0%, var(--color-brand-primary-strong) 100%);
            box-shadow: 0 2px 8px rgba(77, 184, 160, 0.25);
        }

        [data-theme="dark"] .button-fetch:hover {
            background: linear-gradient(135deg, #5cc9af 0%, var(--color-brand-primary) 100%);
            box-shadow: 0 4px 12px rgba(77, 184, 160, 0.35);
        }

        .card {
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.9) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 5px;
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255,255,255,0.3);
            transition: all 0.3s cubic-bezier(0.23, 1, 0.320, 1);
            min-width: 0;
            position: relative;
            overflow: hidden;
            scroll-margin-top: 24px;
        }

        .card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: var(--gradient-glass);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-4px);
            border-color: var(--color-brand-primary);
        }

        .card:hover::before {
            opacity: 1;
        }

        [data-theme="dark"] .card {
            background: linear-gradient(135deg, rgba(20,24,35,0.95) 0%, rgba(20,24,35,0.85) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: var(--shadow-md);
        }

        [data-theme="dark"] .card:hover {
            box-shadow: var(--shadow-lg), var(--shadow-glow);
            background: linear-gradient(135deg, rgba(30,36,50,0.98) 0%, rgba(30,36,50,0.9) 100%);
            border-color: var(--color-brand-primary);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            font-size: var(--text-headline-md);
            font-weight: 700;
            margin-bottom: var(--spacing-lg);
            color: var(--md-sys-color-primary);
            padding-bottom: var(--spacing-md);
            border-bottom: 3px solid var(--md-sys-color-primary);
        }

        [data-theme="dark"] .section-header {
            color: var(--color-brand-primary);
            border-bottom-color: var(--color-brand-primary);
        }

        /* Key Metrics Card - matches Monte Carlo card styling */
        .key-metrics-card {
            /* Inherits background, border, box-shadow, border-radius from .card */
            padding: 10px;
        }

        .key-metrics-card .section-header {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 32px;
            padding-bottom: 16px;
        }

        /* Disable background change on hover for Key Metrics card */
        .key-metrics-card:hover {
            background: inherit;
        }

        [data-theme="dark"] .key-metrics-card:hover {
            background: linear-gradient(135deg, rgba(20,24,35,0.95) 0%, rgba(20,24,35,0.85) 100%);
        }
        
        
        @media (min-width: 1200px) {
            .key-metrics-card {
                padding: 15px 15px;
            }
        }

        @media (min-width: 1600px) {
            .key-metrics-card {
                padding: 15px 15px;
            }
        }

        .salary-equivalent {
            background: var(--color-brand-primary);
            color: white;
            padding: 24px 20px;
            border-radius: 4px;
            margin-bottom: 24px;
            text-align: center;
            box-shadow: var(--shadow-md);
        }

        .salary-equivalent h3 {
            font-size: 18px;
            font-weight: 400;
            margin-bottom: 12px;
            color: white;
            opacity: 0.95;
        }

        .salary-equivalent .amount {
            font-size: 36px;
            font-weight: 600;
            margin: 12px 0;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);            
        }

        .salary-equivalent .equivalent-text {
            font-size: 14px;
            margin: 16px 0 10px 0;
            opacity: 0.95;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);            
        }

        .salary-equivalent .taxable-amount {
            font-size: 32px;
            font-weight: 600;
            margin: 10px 0 16px 0;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);            
        }

        .salary-equivalent .savings-text {
            font-size: 13px;
            opacity: 0.85;
            line-height: 1.5;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);            
        }

        [data-theme="dark"] .salary-equivalent {
            background: var(--color-brand-primary);
            box-shadow: var(--shadow-md);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);            
        }

        .summary-grid {
            display: flex;
            flex-direction: column;
            gap: 24px;
            margin-bottom: 24px;
        }

        /* Base summary card styles */
        .summary-card {
            background-color: var(--md-sys-color-surface-container-high);
            border-radius: 6px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            transition: all 0.2s ease;
        }

        .summary-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }

        [data-theme="dark"] .summary-card {
            background-color: #1A2A4A;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
        }

        [data-theme="dark"] .summary-card:hover {
            box-shadow: 0 6px 16px rgba(0,0,0,0.5);
            background-color: #1F3A5A;
        }

        .metric-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: 28px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
            line-height: 1.2;
        }

        /* Hero metrics section (Tier 1) */
        .hero-metrics-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        /* 
           GUARDRAIL-STYLE HERO METRIC CARDS
            */
        .hero-metric-card {
            position: relative;
            background: var(--neutral-surface, #FFFFFF);
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid var(--border-default, #E2E8F0);
            box-shadow: 0 4px 6px rgba(0, 121, 107, 0.07);
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            cursor: default;
            overflow: hidden;
        }

        .hero-metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 121, 107, 0.15);
            border-color: var(--md-sys-color-primary, #00796B);
        }

        /* Top color stripe */
        .hero-metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--card-gradient, linear-gradient(135deg, #10B981 0%, #6BCB77 100%));
        }

        /* Card Header with title and status badge */
        .hero-metric-card .card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 1.25rem;
        }

        .hero-metric-card .card-title-group {
            flex: 1;
        }

        .hero-metric-card .card-title {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary, #1A1F36);
            margin-bottom: 0.125rem;
            letter-spacing: -0.01em;
        }

        .hero-metric-card .card-subtitle {
            font-size: 0.7rem;
            color: var(--text-disabled, #94A3B8);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        .hero-metric-card .card-status-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .hero-metric-card .card-status-badge .material-icons {
            font-size: 1.25rem;
        }

        /* Card Metrics Section */
        .hero-metric-card .card-metrics {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .hero-metric-card .metric-primary {
            display: flex;
            align-items: baseline;
            gap: 0.25rem;
        }

        .hero-metric-card .metric-value {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            font-size: 2.25rem;
            font-weight: 800;
            letter-spacing: -0.02em;
            line-height: 1;
            color: var(--metric-color, #10B981);
        }

        .hero-metric-card .metric-suffix {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-secondary, #4E5D78);
        }

        .hero-metric-card .metric-label {
            font-size: 0.8rem;
            color: var(--text-secondary, #4E5D78);
            margin-top: 0.25rem;
        }

        /* Secondary metrics row */
        .hero-metric-card .metric-secondary {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: 1rem;
            border-top: 1px solid var(--border-light, #F1F5F9);
        }

        .hero-metric-card .secondary-item {
            display: flex;
            flex-direction: column;
        }

        .hero-metric-card .secondary-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary, #1A1F36);
        }

        .hero-metric-card .secondary-value.positive {
            color: #10B981;
        }

        .hero-metric-card .secondary-value.positive::before {
            content: '+';
        }

        .hero-metric-card .secondary-value.negative {
            color: #EF4444;
        }

        .hero-metric-card .secondary-label {
            font-size: 0.75rem;
            color: var(--text-disabled, #94A3B8);
        }

        /* Worst case footer */
        .hero-metric-card .worst-case {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--neutral-surface-variant, #F7F9FB);
            border-radius: 0.5rem;
            margin-top: 1rem;
        }

        .hero-metric-card .worst-case-icon {
            font-size: 1rem;
            color: var(--text-disabled, #94A3B8);
        }

        .hero-metric-card .worst-case-text {
            font-size: 0.8rem;
            color: var(--text-secondary, #4E5D78);
        }

        .hero-metric-card .worst-case-value {
            font-weight: 600;
            color: #FF6B6B;
        }

        /* Status-based styling - Success/Green */
        .hero-metric-card.success-excellent {
            --card-gradient: linear-gradient(135deg, #10B981 0%, #6BCB77 100%);
            --metric-color: #10B981;
        }

        .hero-metric-card.success-excellent .card-status-badge {
            background: #D1FAE5;
            color: #10B981;
        }

        /* Status-based styling - Warning/Yellow */
        .hero-metric-card.success-moderate {
            --card-gradient: linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%);
            --metric-color: #F59E0B;
        }

        .hero-metric-card.success-moderate .card-status-badge {
            background: #FEF3C7;
            color: #F59E0B;
        }

        /* Status-based styling - Danger/Red */
        .hero-metric-card.success-poor {
            --card-gradient: linear-gradient(135deg, #EF4444 0%, #F87171 100%);
            --metric-color: #EF4444;
        }

        .hero-metric-card.success-poor .card-status-badge {
            background: #FEE2E2;
            color: #EF4444;
        }

        /* CAGR card styling */
        .hero-metric-card.cagr-excellent {
            --card-gradient: linear-gradient(135deg, #10B981 0%, #6BCB77 100%);
            --metric-color: #10B981;
        }

        .hero-metric-card.cagr-excellent .card-status-badge {
            background: #D1FAE5;
            color: #10B981;
        }

        .hero-metric-card.cagr-good {
            --card-gradient: linear-gradient(135deg, #0EA5E9 0%, #38BDF8 100%);
            --metric-color: #0EA5E9;
        }

        .hero-metric-card.cagr-good .card-status-badge {
            background: #E0F2FE;
            color: #0EA5E9;
        }

        .hero-metric-card.cagr-high {
            --card-gradient: linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%);
            --metric-color: #D97706;
        }

        .hero-metric-card.cagr-high .card-status-badge {
            background: #FEF3C7;
            color: #D97706;
        }

        .high-growth-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: #FEF3C7;
            color: #D97706;
            margin-left: 6px;
            vertical-align: middle;
        }

        .cagr-info-icon {
            font-size: 14px !important;
            color: var(--md-sys-color-on-surface-variant);
            vertical-align: middle;
            margin-left: 4px;
            cursor: help;
            opacity: 0.7;
        }

        .cagr-info-icon:hover {
            opacity: 1;
            color: #D97706;
        }

        .hero-metric-card.cagr-undefined {
            --card-gradient: linear-gradient(135deg, #9CA3AF 0%, #D1D5DB 100%);
            --metric-color: #9CA3AF;
        }

        .hero-metric-card.cagr-undefined .card-status-badge {
            background: #F3F4F6;
            color: #9CA3AF;
        }

        /* Margin call card styling */
        .hero-metric-card.margin-low {
            --card-gradient: linear-gradient(135deg, #10B981 0%, #6BCB77 100%);
            --metric-color: #10B981;
        }

        .hero-metric-card.margin-low .card-status-badge {
            background: #D1FAE5;
            color: #10B981;
        }

        .hero-metric-card.margin-moderate {
            --card-gradient: linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%);
            --metric-color: #F59E0B;
        }

        .hero-metric-card.margin-moderate .card-status-badge {
            background: #FEF3C7;
            color: #F59E0B;
        }

        .hero-metric-card.margin-high {
            --card-gradient: linear-gradient(135deg, #EF4444 0%, #F87171 100%);
            --metric-color: #EF4444;
        }

        .hero-metric-card.margin-high .card-status-badge {
            background: #FEE2E2;
            color: #EF4444;
        }

        /* Dark theme */
        [data-theme="dark"] .hero-metric-card {
            background: #141823;
            border-color: #2D3748;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
        }

        [data-theme="dark"] .hero-metric-card:hover {
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
            background: #1E2432;
        }

        [data-theme="dark"] .hero-metric-card .card-title {
            color: #F0F4F8;
        }

        [data-theme="dark"] .hero-metric-card .card-subtitle {
            color: #4A5568;
        }

        [data-theme="dark"] .hero-metric-card .metric-label {
            color: #A0AEC0;
        }

        [data-theme="dark"] .hero-metric-card .secondary-value {
            color: #F0F4F8;
        }

        [data-theme="dark"] .hero-metric-card .secondary-label {
            color: #4A5568;
        }

        [data-theme="dark"] .hero-metric-card .metric-secondary {
            border-top-color: #2D3748;
        }

        [data-theme="dark"] .hero-metric-card .worst-case {
            background: #1E2432;
        }

        [data-theme="dark"] .hero-metric-card .worst-case-text {
            color: #A0AEC0;
        }

        [data-theme="dark"] .high-growth-badge {
            background: rgba(251, 191, 36, 0.2);
            color: #FBBF24;
        }

        [data-theme="dark"] .cagr-info-icon {
            color: #A0AEC0;
        }

        [data-theme="dark"] .cagr-info-icon:hover {
            color: #FBBF24;
        }

        /* Outcome spectrum section (Tier 2) */
        .outcome-spectrum {
            background: linear-gradient(135deg, #F8FAFC 0%, var(--color-percentile-container-bg) 100%);
            border-radius: 4px;
            padding: 32px 28px;
            box-shadow: 0 4px 12px rgba(76, 111, 255, 0.08);
            border: 1px solid rgba(76, 111, 255, 0.08);
        }

        [data-theme="dark"] .outcome-spectrum {
            background: linear-gradient(135deg, #1F2837 0%, var(--color-percentile-container-bg) 100%);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(76, 111, 255, 0.1);
        }

        .spectrum-header {
            font-size: 14px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface-variant);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 20px;
            text-align: center;
        }

        .spectrum-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 28px;
            position: relative;
            padding: 8px 0;
        }

        .spectrum-container::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg,
                var(--color-percentile-worst-text) 0%,
                var(--color-percentile-median-text) 50%,
                var(--color-percentile-best-text) 100%);
            transform: translateY(-50%);
            border-radius: 2px;
            opacity: 0.2;
            z-index: 0;
        }

        .percentile-marker {
            position: relative;
            z-index: 1;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .percentile-marker.worst {
            z-index: 1;
        }

        .percentile-marker.median {
            transform: scale(1.12);
            z-index: 3;
        }

        .percentile-marker.best {
            z-index: 2;
        }

        .percentile-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface-variant);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .percentile-marker.median .percentile-label {
            font-size: 12px;
            color: var(--color-percentile-median-text);
            font-weight: 700;
        }

        .percentile-value {
            font-size: 20px;
            font-weight: 700;
            padding: 14px 18px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        .percentile-marker.worst .percentile-value {
            color: var(--color-percentile-worst-text);
            background: var(--color-percentile-worst-bg);
        }

        .percentile-marker.median .percentile-value {
            font-size: 24px;
            color: var(--color-percentile-median-text);
            background: var(--color-percentile-median-bg);
            box-shadow: 0 4px 16px rgba(76, 111, 255, 0.2);
            border: 2px solid var(--color-percentile-median-text);
            padding: 14px 20px;
        }

        .percentile-marker.best .percentile-value {
            color: var(--color-percentile-best-text);
            background: var(--color-percentile-best-bg);
        }

        /* Metadata section (Tier 3) */
        .metadata-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .metadata-card {
            background: var(--md-sys-color-surface-container-high);
            border-radius: 6px;
            padding: 16px 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            display: flex;
            align-items: center;
            gap: 12px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .metadata-card:hover {
            box-shadow: 0 4px 12px rgba(0, 76, 69, 0.15);
            transform: translateY(-2px);
            border-color: var(--color-brand-primary);
        }

        .metadata-icon {
            font-size: 24px;
            opacity: 0.7;
            color: var(--md-sys-color-primary);
        }

        .metadata-content {
            flex: 1;
        }

        .metadata-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface-variant);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .metadata-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
        }

        /* Planned Debt Card Styles */
        .planned-debt-card {
            background: var(--md-sys-color-secondary-container);
            box-shadow: 0 2px 8px rgba(159, 144, 255, 0.08);
        }

        .planned-debt-value {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(159, 144, 255, 0.2);
        }

        [data-theme="dark"] .planned-debt-card {
            background: linear-gradient(135deg, rgba(159, 144, 255, 0.06) 0%, rgba(183, 148, 244, 0.03) 100%);
            box-shadow: 0 4px 12px rgba(159, 144, 255, 0.08);
        }

        [data-theme="dark"] .planned-debt-value {
            background: rgba(37, 43, 59, 0.6);
            border: 1px solid rgba(159, 144, 255, 0.15);
            backdrop-filter: blur(10px);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2), 0 0 20px rgba(159, 144, 255, 0.1);
        }

        [data-theme="dark"] .planned-debt-value > div {
            text-shadow: 0 0 30px rgba(183, 148, 244, 0.3);
        }

        /* Tier 2: Secondary metrics row (for Single Asset mode) */
        .secondary-metrics-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-top: 20px;
        }

        .secondary-metric-card {
            background: var(--md-sys-color-surface-container);
            border-radius: 6px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .secondary-metric-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }

        .metric-icon-secondary {
            font-size: 28px;
            color: var(--md-sys-color-primary);
            opacity: 0.8;
        }

        .metric-content {
            flex: 1;
        }

        .metric-label-secondary {
            font-size: 13px;
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 6px;
            font-weight: 500;
        }

        .metric-value-secondary {
            font-size: 22px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
        }

        /* Color coding for margin call cards in Single Asset mode */
        .hero-metric-card.margin-call-safe {
            --accent-color: #16A34A;
            --accent-color-light: #68d391;
        }

        .hero-metric-card.margin-call-safe .metric-value {
            color: #16A34A;
        }

        .hero-metric-card.margin-call-warning {
            --accent-color: #EF4444;
            --accent-color-light: #fc8181;
        }

        .hero-metric-card.margin-call-warning .metric-value {
            color: #EF4444;
        }

        /* Positive/negative value colors for metric values */
        .metric-value.positive {
            color: #16A34A;
        }

        .metric-value.negative {
            color: #EF4444;
        }

        .metric-value-secondary.positive {
            color: #16A34A;
        }

        .metric-value-secondary.negative {
            color: #EF4444;
        }

        /* Portfolio assets with collapse */
        .portfolio-assets-card {
            grid-column: 1 / -1;
            align-items: flex-start;
        }

        .portfolio-assets-card .metadata-content {
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .assets-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .asset-chip {
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .assets-more-btn {
            background: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }

        .assets-more-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Liquidity Stress Testing Dashboard Styles */
        .liquidity-dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            border-radius: 6px;
            padding: 20px 20px;
            margin-bottom: 20px;
        }

        .stress-test-card {
            background: var(--md-sys-color-surface-container);
            border-radius: 6px;
            padding: 16px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .stress-test-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
        }

        .stress-test-card.safe {
            border-color: #16A34A;
            background: linear-gradient(135deg, var(--md-sys-color-surface-container) 0%, rgba(102, 187, 106, 0.1) 100%);
        }

        .stress-test-card.warning {
            border-color: #FFA726;
            background: linear-gradient(135deg, var(--md-sys-color-surface-container) 0%, rgba(255, 167, 38, 0.1) 100%);
        }

        .stress-test-card.danger {
            border-color: #DC2626;
            background: linear-gradient(135deg, var(--md-sys-color-surface-container) 0%, rgba(239, 83, 80, 0.1) 100%);
        }

        /* Dark mode enhancements for status cards */
        [data-theme="dark"] .stress-test-card.safe {
            border-color: var(--md-success-dark);
            background: linear-gradient(135deg, var(--md-sys-color-surface-container) 0%, rgba(127, 204, 127, 0.2) 100%);
            box-shadow: 0 2px 6px rgba(0,0,0,0.08), inset 0 0 20px rgba(127, 204, 127, 0.08);
        }

        [data-theme="dark"] .stress-test-card.warning {
            border-color: var(--md-warning-dark);
            background: linear-gradient(135deg, var(--md-sys-color-surface-container) 0%, rgba(255, 184, 86, 0.2) 100%);
            box-shadow: 0 2px 6px rgba(0,0,0,0.08), inset 0 0 20px rgba(255, 184, 86, 0.08);
        }

        [data-theme="dark"] .stress-test-card.danger {
            border-color: var(--md-danger-dark);
            background: linear-gradient(135deg, var(--md-sys-color-surface-container) 0%, rgba(255, 107, 107, 0.2) 100%);
            box-shadow: 0 2px 6px rgba(0,0,0,0.08), inset 0 0 20px rgba(255, 107, 107, 0.08);
        }

        .stress-test-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--md-sys-color-outline);
        }

        .stress-test-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
        }

        .stress-test-badge {
            font-size: 11px;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stress-test-badge.safe {
            background: #E8F5E9;
            color: #2E7D32;
        }

        .stress-test-badge.warning {
            background: #FFF3E0;
            color: #E65100;
        }

        .stress-test-badge.danger {
            background: #FFEBEE;
            color: #DC2626;
        }

        [data-theme="dark"] .stress-test-badge.safe {
            background: rgba(127, 204, 127, 0.25);
            color: #A8EFA8;
            border: 1px solid var(--md-success-dark);
        }

        [data-theme="dark"] .stress-test-badge.warning {
            background: rgba(255, 184, 86, 0.25);
            color: #FFD699;
            border: 1px solid var(--md-warning-dark);
        }

        [data-theme="dark"] .stress-test-badge.danger {
            background: rgba(255, 107, 107, 0.25);
            color: #FF8989;
            border: 1px solid var(--md-danger-dark);
        }

        .stress-test-body {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .stress-test-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .stress-test-metric-label {
            color: var(--md-sys-color-on-surface-variant);
            font-weight: 500;
        }

        .stress-test-metric-value {
            color: var(--md-sys-color-on-surface);
            font-weight: 600;
        }

        .liquidity-status-banner {
            background: var(--md-sys-color-primary-container);
            border-radius: 6px;
            padding: 20px 24px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .liquidity-status-icon {
            font-size: 48px;
        }

        .liquidity-status-content {
            flex: 1;
        }

        .liquidity-status-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--md-sys-color-on-primary-container);
            margin-bottom: 6px;
        }

        .liquidity-status-description {
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
            line-height: 1.4;
        }

        .summary-item {
            background-color: var(--md-sys-color-surface-container-high);
            padding: 16px;
            border-radius: 4px;
        }

        .summary-item.margin-call-warning {
            background-color: #FFEBEE;
            border: 2px solid #DC2626;
        }

        [data-theme="dark"] .summary-item.margin-call-warning {
            background-color: #4A1515;
            border: 2px solid #DC2626;
        }

        .summary-item.margin-call-safe {
            background-color: #E8F5E9;
            border: 2px solid #2E7D32;
        }

        [data-theme="dark"] .summary-item.margin-call-safe {
            background-color: #1B4332;
            border: 2px solid #16A34A;
        }

        .summary-item .label {
            font-size: 12px;
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 4px;
        }

        .summary-item .value {
            font-size: 24px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
        }

        .card .section {
            margin-bottom: 28px;
        }

        .card .section:last-child {
            margin-bottom: 0;
        }

        .card .section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--md-sys-color-on-surface);
        }

        .card .overview-text {
            margin-bottom: 12px;
            line-height: 1.6;
        }

        .card .outcome-box {
            background-color: #D4EDDA;
            border: 2px solid #52B788;
            border-radius: 4px;
            padding: 16px;
            margin-top: 12px;
        }

        [data-theme="dark"] .card .outcome-box {
            background-color: #1B4332;
            border-color: #2D6A4F;
        }

        .card .outcome-box .check {
            color: #52B788;
            font-weight: 700;
            margin-right: 4px;
        }

        .card ul {
            list-style: none;
            padding-left: 0;
        }

        .card li {
            margin-bottom: 12px;
            line-height: 1.6;
            position: relative;
            padding-left: 0;
        }

        .card li strong {
            color: var(--md-sys-color-on-surface);
        }

        .table-container {
            overflow-x: auto;
            margin-bottom: 24px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--md-sys-color-surface);
            border-radius: 6px;
            overflow: hidden;
            box-shadow: var(--shadow-xs);
        }

        thead {
            background-color: var(--md-sys-color-surface-container-highest);
            border-bottom: 3px solid var(--md-sys-color-primary);
        }

        th {
            padding: var(--spacing-lg);
            text-align: left;
            font-weight: 700;
            color: var(--md-sys-color-on-surface);
            font-size: var(--text-body-sm);
            border-bottom: none;
            letter-spacing: 0.5px;
        }

        td {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--md-sys-color-surface-variant);
            font-size: var(--text-body-md);
        }

        tr:hover {
            background-color: var(--md-sys-color-surface-variant);
        }

        .chart-container {
            background: #FFFFFF;
            padding: var(--spacing-xl);
            border-radius: 4px;
            margin-bottom: var(--spacing-xl);
            height: 350px;
            width: 100%;
            border: none;
            box-shadow: 0 6px 16px rgba(15, 23, 42, 0.06);
            transition: all 0.3s cubic-bezier(0.22, 0.61, 0.36, 1);
            position: relative;
            overflow: hidden;
            min-width: 0;
        }

        .chart-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--color-brand-primary);
        }

        .chart-container:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        [data-theme="dark"] .chart-container {
            background: var(--color-neutral-bg-card);
            box-shadow: var(--shadow-md);
        }

        [data-theme="dark"] .chart-container::before {
            background: var(--color-brand-primary);
        }

        [data-theme="dark"] .chart-container:hover {
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.5);
        }

        @media (max-width: 768px) {
            .chart-container {
                height: 250px;
                padding: var(--spacing-lg);
            }
        }

        @media (max-width: 480px) {
            .chart-container {
                height: 200px;
            }
        }

        .error-message {
            background-color: var(--md-sys-color-error);
            color: var(--md-sys-color-on-error);
            padding: 16px;
            border-radius: 4px;
            margin-bottom: 24px;
        }

        .warning-message {
            background-color: #FFF4E5;
            color: #663C00;
            padding: 16px;
            border-radius: 4px;
            margin-bottom: 24px;
        }

        [data-theme="dark"] .warning-message {
            background-color: #4A3800;
            color: #FFDEA8;
        }

        .api-section {
            background-color: var(--md-sys-color-surface-container-highest);
            padding: 16px;
            border-radius: 4px;
            margin-bottom: 24px;
            border: 1px solid var(--md-sys-color-outline);
        }

        .api-section h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .api-section small {
            display: block;
            margin-top: 8px;
            color: var(--md-sys-color-on-surface-variant);
            font-size: 11px;
        }

        .api-section small a {
            color: #3B5998;
            text-decoration: none;
        }

        .api-section small a:hover {
            text-decoration: underline;
        }

        #results {
            display: none;
        }

        /* Prevent margin collapse on last card creating extra scroll space */
        #results > *:last-child {
            margin-bottom: 0;
        }

        .empty-state {
            padding: 40px;
            color: var(--md-sys-color-on-surface);
        }

        .empty-state .icon {
            font-size: 72px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 24px;
            font-weight: 400;
            margin-bottom: 12px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .empty-state p {
            font-size: 16px;
            max-width: 500px;
            margin: 0 auto;
        }

        .welcome-guide {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
        }

        @media (min-width: 1400px) {
            .welcome-guide {
                max-width: 1400px;
                padding: 0 40px;
            }
        }

        @media (min-width: 1800px) {
            .welcome-guide {
                max-width: 1600px;
                padding: 0 60px;
            }
        }

        .guide-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .guide-icon {
            font-size: 64px;
            display: block;
            margin-bottom: 16px;
        }

        .guide-header h2 {
            font-size: 32px;
            font-weight: 500;
            color: var(--md-sys-color-primary);
            margin: 0;
        }

        [data-theme="dark"] .guide-header h2 {
            color: var(--md-sys-color-primary);
        }

        .guide-intro {
            background-color: var(--color-brand-primary-soft);
            border-left: 4px solid var(--md-sys-color-primary);
            padding: 24px 32px;
            border-radius: 4px;
            margin-bottom: 40px;
            font-size: 16px;
            line-height: 1.6;
        }

        @media (min-width: 1200px) {
            .guide-intro {
                padding: 28px 40px;
                margin-bottom: 48px;
            }
        }

        [data-theme="dark"] .guide-intro {
            background: linear-gradient(135deg, #233354 0%, #1E2A3F 100%);
            border-left-color: var(--md-sys-color-primary);
        }

        /* ---- Buy Borrow Die Strategy Section ---- */
        .bbd-strategy-section {
            background: linear-gradient(135deg, #FFFFFF 0%, #F5F9F8 40%, #E8F0EF 100%);
            border-radius: 4px;
            padding: 40px 48px;
            margin-bottom: 40px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(27, 75, 75, 0.12);
            box-shadow: 0 4px 24px rgba(27, 75, 75, 0.08), 0 0 1px rgba(27, 75, 75, 0.1);
            animation: fadeInUp 0.8s ease-out;
        }

        @media (min-width: 1200px) {
            .bbd-strategy-section {
                padding: 48px 56px;
            }
        }

        @media (min-width: 1400px) {
            .bbd-strategy-section {
                padding: 56px 72px;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .bbd-strategy-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 6px;
            height: 100%;
            background: linear-gradient(180deg, var(--color-brand-primary) 0%, var(--color-brand-secondary-gold) 100%);
        }

        [data-theme="dark"] .bbd-strategy-section {
            background: linear-gradient(135deg, rgba(20, 24, 35, 0.95) 0%, rgba(30, 36, 50, 0.9) 50%, rgba(26, 35, 48, 0.92) 100%);
            border: 1px solid rgba(0, 191, 165, 0.15);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.4), 0 0 40px rgba(0, 191, 165, 0.08), inset 0 1px 0 rgba(0, 191, 165, 0.1);
            position: relative;
        }

        [data-theme="dark"] .bbd-strategy-section::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 4px;
            padding: 1px;
            background: linear-gradient(135deg, rgba(0, 191, 165, 0.2) 0%, rgba(159, 144, 255, 0.1) 100%);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            pointer-events: none;
            opacity: 0.6;
        }

        .bbd-header {
            margin-bottom: 24px;
            padding-left: 16px;
        }

        .bbd-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 42px;
            font-weight: 700;
            color: var(--color-brand-primary);
            margin: 0 0 8px 0;
            line-height: 1.2;
            letter-spacing: -0.5px;
        }

        [data-theme="dark"] .bbd-title {
            color: var(--color-brand-secondary-gold);
        }

        .bbd-subtitle {
            font-size: 16px;
            color: var(--color-neutral-text-secondary);
            margin: 0;
            font-weight: 500;
        }

        [data-theme="dark"] .bbd-subtitle {
            color: var(--color-neutral-text-muted);
        }

        .bbd-content {
            padding-left: 16px;
            display: grid;
            gap: 36px;
        }

        @media (min-width: 1200px) {
            .bbd-content {
                gap: 40px;
            }
        }

        .bbd-description {
            font-size: 17px;
            line-height: 1.7;
            color: var(--color-neutral-text-primary);
            max-width: 100%;
        }

        [data-theme="dark"] .bbd-description {
            color: var(--color-neutral-text-secondary);
        }

        .bbd-pillars {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
            margin: 8px 0;
        }

        @media (min-width: 1200px) {
            .bbd-pillars {
                gap: 32px;
            }
        }

        .bbd-pillar {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 6px;
            padding: 24px 20px;
            text-align: center;
            border: 1px solid rgba(27, 75, 75, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .bbd-pillar:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(27, 75, 75, 0.12);
            border-color: var(--color-brand-primary);
        }

        [data-theme="dark"] .bbd-pillar {
            background: rgba(26, 36, 36, 0.6);
            border-color: rgba(212, 168, 74, 0.2);
        }

        [data-theme="dark"] .bbd-pillar:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            border-color: var(--color-brand-secondary-gold);
        }

        .bbd-pillar-icon {
            font-size: 48px;
            margin-bottom: 12px;
            display: block;
            filter: drop-shadow(0 2px 8px rgba(27, 75, 75, 0.15));
        }

        .bbd-pillar-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 24px;
            font-weight: 700;
            color: var(--color-brand-primary);
            margin: 0 0 8px 0;
        }

        [data-theme="dark"] .bbd-pillar-title {
            color: var(--color-brand-secondary-gold);
        }

        .bbd-pillar-text {
            font-size: 14px;
            color: var(--color-neutral-text-secondary);
            margin: 0;
            line-height: 1.5;
        }

        [data-theme="dark"] .bbd-pillar-text {
            color: var(--color-neutral-text-muted);
        }

        .bbd-arrow {
            display: none;
        }

        @media (min-width: 900px) {
            .bbd-pillars {
                grid-template-columns: 1fr auto 1fr auto 1fr;
                align-items: center;
            }

            .bbd-arrow {
                display: block;
                font-size: 32px;
                color: var(--color-brand-secondary-gold);
                opacity: 0.6;
            }
        }

        .bbd-videos {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .bbd-video-link {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 14px 24px;
            background: var(--color-brand-primary);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 12px rgba(27, 75, 75, 0.2);
            position: relative;
            overflow: hidden;
        }

        .bbd-video-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, transparent 0%, rgba(255, 255, 255, 0.1) 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .bbd-video-link:hover::before {
            opacity: 1;
        }

        .bbd-video-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(27, 75, 75, 0.3);
            background: var(--color-brand-primary-strong);
        }

        .bbd-video-link:active {
            transform: translateY(0);
        }

        [data-theme="dark"] .bbd-video-link {
            background: var(--color-brand-secondary-gold);
            color: #0F1A1A;
            box-shadow: 0 2px 12px rgba(212, 168, 74, 0.3);
        }

        [data-theme="dark"] .bbd-video-link:hover {
            background: var(--color-brand-secondary-gold-muted);
            box-shadow: 0 6px 20px rgba(212, 168, 74, 0.4);
        }

        .bbd-video-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .bbd-learn-more {
            margin-top: 16px;
            padding-top: 24px;
            border-top: 1px solid var(--color-neutral-border-subtle);
        }

        [data-theme="dark"] .bbd-learn-more {
            border-top-color: rgba(212, 168, 74, 0.2);
        }

        .bbd-learn-more-title {
            font-weight: 600;
            color: var(--color-brand-primary);
            margin: 0 0 12px 0;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        [data-theme="dark"] .bbd-learn-more-title {
            color: var(--color-brand-secondary-gold);
        }

        .bbd-simulator-helps {
            margin-top: 28px;
            padding-top: 28px;
            border-top: 1px solid var(--color-neutral-border-subtle);
        }

        [data-theme="dark"] .bbd-simulator-helps {
            border-top-color: rgba(212, 168, 74, 0.2);
        }

        .bbd-simulator-title {
            font-weight: 600;
            color: var(--color-brand-primary);
            margin: 0 0 20px 0;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        [data-theme="dark"] .bbd-simulator-title {
            color: var(--color-brand-secondary-gold);
        }

        .bbd-features-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 18px;
        }

        @media (min-width: 1200px) {
            .bbd-features-grid {
                gap: 24px;
            }
        }

        .bbd-feature-card {
            background: rgba(255, 255, 255, 0.4);
            border: 1.5px solid var(--color-neutral-border-subtle);
            border-radius: 5px;
            padding: 18px 16px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .bbd-feature-card:hover {
            transform: translateY(-2px);
            border-color: var(--color-brand-secondary-gold);
            box-shadow: 0 4px 16px rgba(212, 168, 74, 0.15);
            background: rgba(255, 255, 255, 0.7);
        }

        [data-theme="dark"] .bbd-feature-card {
            background: rgba(26, 36, 36, 0.4);
            border-color: rgba(212, 168, 74, 0.25);
        }

        [data-theme="dark"] .bbd-feature-card:hover {
            border-color: var(--color-brand-secondary-gold);
            box-shadow: 0 4px 16px rgba(212, 168, 74, 0.25);
            background: rgba(26, 36, 36, 0.6);
        }

        .bbd-feature-icon {
            font-size: 28px;
            flex-shrink: 0;
            filter: drop-shadow(0 2px 4px rgba(212, 168, 74, 0.3));
        }

        .bbd-feature-content {
            flex: 1;
        }

        .bbd-feature-heading {
            font-weight: 600;
            font-size: 15px;
            color: var(--color-brand-primary);
            margin: 0 0 6px 0;
            line-height: 1.3;
        }

        [data-theme="dark"] .bbd-feature-heading {
            color: var(--color-brand-secondary-gold);
        }

        .bbd-feature-text {
            font-size: 13px;
            color: var(--color-neutral-text-secondary);
            margin: 0;
            line-height: 1.5;
        }

        [data-theme="dark"] .bbd-feature-text {
            color: var(--color-neutral-text-muted);
        }

        @media (max-width: 768px) {
            .bbd-strategy-section {
                padding: 28px 24px;
            }

            .bbd-title {
                font-size: 32px;
            }

            .bbd-pillars {
                grid-template-columns: 1fr;
            }

            .bbd-video-link {
                width: 100%;
                justify-content: center;
            }

            .bbd-features-grid {
                grid-template-columns: 1fr;
            }
        }

        .guide-steps {
            display: flex;
            flex-direction: column;
            gap: 28px;
            margin-bottom: 32px;
            padding: 1px;
            border-radius: 5px;
        }

        @media (min-width: 1200px) {
            .guide-steps {
                gap: 36px;
                padding: 10px;
            }
        }

        @media (min-width: 1600px) {
            .guide-steps {
                gap: 40px;
                padding: 10px;
            }
        }

        .step-card {
            background-color: var(--md-sys-color-surface-container);
            border-radius: 4px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            opacity: 0;
            animation: fadeInUp 0.6s ease-out forwards;
        }

        @media (min-width: 768px) {
            .step-card {
                padding: 32px;
                flex-direction: row;
                gap: 24px;
            }
        }

        .step-card:nth-child(1) {
            animation-delay: 0.1s;
        }

        .step-card:nth-child(2) {
            animation-delay: 0.2s;
        }

        .step-card:nth-child(3) {
            animation-delay: 0.3s;
        }

        .step-card:nth-child(4) {
            animation-delay: 0.4s;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (min-width: 1200px) {
            .step-card {
                padding: 40px 48px;
                border-radius: 5px;
                padding-left: 120px;
            }
        }

        @media (min-width: 1600px) {
            .step-card {
                padding: 48px 64px;
                padding-left: 140px;
            }
        }

        .step-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

        .step-card:hover .step-number {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(27, 75, 75, 0.3);
        }

        @media (min-width: 1200px) {
            .step-card:hover .step-number {
                transform: scale(1.08);
            }
        }

        .step-number {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 56px;
            width: 56px;
            height: 56px;
            border-radius: 6px;
            background: var(--gradient-primary);
            color: #FFFFFF;
            font-size: 24px;
            font-weight: 700;
            flex-shrink: 0;
            box-shadow: var(--shadow-md);
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @media (min-width: 1200px) {
            .step-number {
                position: absolute;
                left: 40px;
                top: 40px;
                width: 64px;
                height: 64px;
                border-radius: 4px;
                font-size: 28px;
            }
        }

        @media (min-width: 1600px) {
            .step-number {
                left: 48px;
                top: 48px;
                width: 72px;
                height: 72px;
                font-size: 32px;
            }
        }

        [data-theme="dark"] .step-number {
            background: var(--gradient-primary);
            box-shadow: var(--shadow-md);
            color: #FFFFFF;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        .step-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .step-content h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 14px;
            color: var(--md-sys-color-on-surface);
            letter-spacing: -0.01em;
        }

        @media (min-width: 1200px) {
            .step-content h3 {
                font-size: 22px;
                margin-bottom: 16px;
            }
        }

        @media (min-width: 1600px) {
            .step-content h3 {
                font-size: 24px;
                margin-bottom: 18px;
            }
        }

        .step-content p {
            font-size: 16px;
            line-height: 1.7;
            margin: 0;
            color: var(--md-sys-color-on-surface-variant);
            max-width: 900px;
        }

        @media (min-width: 1200px) {
            .step-content p {
                font-size: 16.5px;
                line-height: 1.75;
                max-width: 1000px;
            }
        }

        @media (min-width: 1600px) {
            .step-content p {
                font-size: 17px;
                line-height: 1.8;
            }
        }

        /* Asset list multi-column layout */
        #availableAssets {
            display: block;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--md-sys-color-outline-variant);
            font-size: 14.5px;
            line-height: 1.8;
            color: var(--md-sys-color-on-surface-variant);
        }

        @media (min-width: 900px) {
            #availableAssets {
                column-count: 2;
                column-gap: 32px;
                font-size: 15px;
                margin-top: 20px;
                padding-top: 20px;
            }
        }

        @media (min-width: 1200px) {
            #availableAssets {
                column-count: 3;
                column-gap: 40px;
            }
        }

        @media (min-width: 1600px) {
            #availableAssets {
                column-count: 3;
                column-gap: 48px;
                font-size: 15.5px;
            }
        }

        .guide-tips {
            background-color: var(--color-brand-primary-soft);
            border: 2px solid var(--color-neutral-border-subtle);
            border-radius: 6px;
            padding: 24px;
            margin-bottom: 32px;
        }

        [data-theme="dark"] .guide-tips {
            background-color: var(--color-brand-primary-soft);
            border-color: var(--color-neutral-border-subtle);
        }

        .tip-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--md-sys-color-on-surface);
        }

        .guide-tips ul {
            list-style: none;
            padding-left: 0;
            margin: 0;
        }

        .guide-tips li {
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 12px;
            padding-left: 24px;
            position: relative;
        }

        .guide-tips li:before {
            content: "";
            position: absolute;
            left: 0;
            color: #22C55E;
            font-weight: bold;
        }

        .guide-tips li:last-child {
            margin-bottom: 0;
        }

        .guide-cta {
            text-align: center;
            padding: 40px 32px;
            background: var(--gradient-primary);
            border-radius: 6px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        [data-theme="dark"] .guide-cta {
            background: var(--gradient-primary);
        }

        [data-theme="dark"] .guide-cta p {
            color: #FFFFFF;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
        }

        .cta-arrow {
            font-size: 48px;
            flex-shrink: 0;
            animation: bounceLeft 2s infinite;
        }

        @keyframes bounceLeft {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(-10px); }
        }

        .guide-cta p {
            font-size: 18px;
            font-weight: 500;
            margin: 0;
            color: #FFFFFF;
            line-height: 1.5;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
        }

        /* Field Instructions Section */
        .field-instructions-toggle-group {
            margin-top: 32px;
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .toggle-instructions-btn {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
            border: none;
            padding: 16px 24px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 1;
            min-width: 280px;
            max-width: 400px;
            justify-content: center;
        }

        .toggle-instructions-btn.single-asset-guide {
            background: var(--gradient-teal);
            color: white;
        }

        .toggle-instructions-btn.single-asset-guide:hover {
            background: var(--gradient-primary);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .toggle-instructions-btn.monte-carlo-guide {
            background: var(--gradient-primary);
            color: white;
        }

        .toggle-instructions-btn.monte-carlo-guide:hover {
            background: linear-gradient(135deg, var(--color-brand-primary-strong) 0%, var(--color-brand-primary-muted) 100%);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        /* Dark Mode Overrides for Field Guide Buttons */
        [data-theme="dark"] .toggle-instructions-btn.single-asset-guide {
            background: var(--gradient-teal);
            color: white;
            border: 2px solid var(--color-brand-primary);
        }

        [data-theme="dark"] .toggle-instructions-btn.single-asset-guide:hover {
            background: var(--gradient-primary);
            color: white;
            border-color: var(--color-brand-primary-strong);
            box-shadow: var(--shadow-glow);
        }

        [data-theme="dark"] .toggle-instructions-btn.monte-carlo-guide {
            background: var(--gradient-teal);
            color: white;
            border: 2px solid var(--color-brand-primary);
        }

        [data-theme="dark"] .toggle-instructions-btn.monte-carlo-guide:hover {
            background: linear-gradient(135deg, var(--color-brand-primary-strong) 0%, var(--color-brand-primary-muted) 100%);
            color: white;
            border-color: var(--color-brand-primary-strong);
            box-shadow: var(--shadow-glow);
        }

        .toggle-instructions-btn .toggle-icon {
            transition: transform 0.3s;
        }

        .toggle-instructions-btn.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        /* Responsive: Stack vertically on mobile */
        @media (max-width: 768px) {
            .field-instructions-toggle-group {
                flex-direction: column;
                align-items: stretch;
            }

            .toggle-instructions-btn {
                max-width: none;
                min-width: auto;
            }
        }

        .field-instructions {
            margin-top: 24px;
            background-color: var(--md-sys-color-surface-container);
            border-radius: 6px;
            padding: 32px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .instructions-header {
            text-align: center;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 2px solid var(--md-sys-color-outline);
        }

        .instructions-header h3 {
            font-size: 28px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
            margin-bottom: 12px;
        }

        .instructions-header p {
            font-size: 16px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .instruction-item {
            background-color: var(--md-sys-color-surface);
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 16px;
            border-left: 4px solid var(--md-sys-color-primary);
        }

        /* Monte Carlo specific instruction styling */
        #fieldInstructionsMonteCarlo .instruction-item {
            border-left-color: var(--color-brand-primary);
        }

        [data-theme="dark"] .instruction-item {
            border-left-color: var(--color-brand-primary);
        }

        [data-theme="dark"] #fieldInstructionsMonteCarlo .instruction-item {
            border-left-color: var(--color-brand-primary);
        }

        .instruction-item h4 {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-brand-primary);
            margin-bottom: 12px;
        }

        #fieldInstructionsMonteCarlo .instruction-item h4 {
            color: var(--color-brand-primary);
        }

        [data-theme="dark"] .instruction-item h4 {
            color: var(--color-brand-primary);
        }

        [data-theme="dark"] #fieldInstructionsMonteCarlo .instruction-item h4 {
            color: var(--color-brand-primary);
        }

        .instruction-item p {
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 10px;
            color: var(--md-sys-color-on-surface);
        }

        .instruction-item p:last-child {
            margin-bottom: 0;
        }

        .instruction-item ul {
            margin: 12px 0;
            padding-left: 24px;
        }

        .instruction-item li {
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 8px;
            color: var(--md-sys-color-on-surface);
        }

        .instruction-item code {
            background-color: var(--md-sys-color-surface-variant);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .instruction-item a {
            color: var(--md-sys-color-primary);
            text-decoration: none;
            font-weight: 500;
        }

        .instruction-item a:hover {
            text-decoration: underline;
        }

        [data-theme="dark"] .instruction-item a {
            color: #A8E8DF;
        }

        .instructions-footer {
            margin-top: 32px;
            text-align: center;
            padding-top: 24px;
            border-top: 2px solid var(--md-sys-color-outline);
        }

        .instructions-footer .button-primary {
            margin-top: 0;
        }

        .positive {
            color: #2E7D32;
        }

        .negative {
            color: #DC2626;
        }

        /* Regime Parameters Table - Responsive Display */
        .regime-params-table-desktop {
            display: table;
        }
        .regime-params-cards-mobile {
            display: none;
        }

        @media (max-width: 768px) {
            .regime-params-table-desktop {
                display: none;
            }
            .regime-params-cards-mobile {
                display: block;
                margin-top: 8px;
            }
            .regime-mode-comparison-grid {
                grid-template-columns: 1fr !important;
            }
        }

        [data-theme="dark"] .positive {
            color: #16A34A;
        }

        [data-theme="dark"] .negative {
            color: #DC2626;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .spinner {
            border: 3px solid var(--md-sys-color-surface-variant);
            border-top: 3px solid var(--md-sys-color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        @media (min-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr 1fr;
            }

            .chart-card {
                margin-bottom: 0;
            }
        }

        [data-theme="dark"] .top-header {
            background: var(--md-sys-color-primary);
        }

        [data-theme="dark"] .panel-header h2 {
            color: var(--md-sys-color-primary);
        }

        [data-theme="dark"] .left-panel {
            border-right-color: #4A68A7;
        }

        .theme-toggle-wrapper {
            position: absolute;
            top: 24px;
            right: 48px;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        /* Settings Modal Styles */
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-panel {
            background-color: var(--md-sys-color-surface);
            border-radius: 4px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 32px;
            border-bottom: 2px solid var(--md-sys-color-outline);
            position: sticky;
            top: 0;
            background-color: var(--md-sys-color-surface);
            z-index: 1;
        }

        .settings-header h2 {
            margin: 0;
            font-size: 28px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
        }

        .settings-close-btn {
            background-color: var(--md-sys-color-primary);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .settings-close-btn:hover {
            background-color: var(--md-sys-color-primary-dark);
        }

        .settings-content {
            padding: 24px 32px 32px;
        }

        .settings-section {
            margin-bottom: 32px;
        }

        .settings-section h3 {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 16px;
            color: var(--md-sys-color-on-surface);
        }

        .data-source-option {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 12px;
            border-radius: 4px;
            background-color: var(--md-sys-color-surface-container);
            transition: background-color 0.2s;
        }

        .data-source-option:hover {
            background-color: var(--md-sys-color-surface-container-high);
        }

        .data-source-option input[type="radio"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            cursor: pointer;
        }

        .data-source-option label {
            flex: 1;
            cursor: pointer;
            font-size: 15px;
            color: var(--md-sys-color-on-surface);
        }

        .api-config-section {
            margin-top: 24px;
            padding: 20px;
            border-radius: 4px;
            background-color: var(--md-sys-color-surface-container-low);
            border-left: 4px solid var(--md-sys-color-primary);
        }

        .api-config-section h3 {
            font-size: 18px;
            margin-bottom: 16px;
            color: var(--md-sys-color-on-surface);
        }

        .api-key-input {
            width: 100%;
            padding: 12px 16px;
            font-size: 15px;
            border: 2px solid var(--md-sys-color-outline);
            border-radius: 4px;
            margin-bottom: 12px;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            font-family: 'Courier New', monospace;
        }

        .api-key-input:focus {
            outline: none;
            border-color: var(--md-sys-color-primary);
        }

        .test-connection-btn {
            background-color: var(--md-sys-color-secondary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-bottom: 12px;
        }

        .test-connection-btn:hover {
            background-color: var(--md-sys-color-secondary-dark);
        }

        .proxy-preset-btn:hover {
            background-color: #2d3748 !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .proxy-preset-btn:active {
            transform: translateY(0);
        }

        /* Toast Notifications */
        .toast {
            background: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            padding: var(--spacing-lg) var(--spacing-xl);
            border-radius: 6px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-md);
            min-width: 300px;
            max-width: 420px;
            animation: slideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-left: 5px solid var(--md-sys-color-primary);
            font-size: var(--text-body-sm);
            line-height: 1.5;
            backdrop-filter: blur(8px);
            border: 1px solid var(--md-sys-color-outline);
        }

        .toast.success {
            border-left-color: #22C55E;
        }

        .toast.error {
            border-left-color: #EF4444;
        }

        .toast.warning {
            border-left-color: #F97316;
        }

        .toast.info {
            border-left-color: var(--md-sys-color-primary);
        }

        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
            line-height: 1;
            margin-top: 2px;
        }

        .toast.success .toast-icon {
            color: #22C55E;
        }

        .toast.error .toast-icon {
            color: #EF4444;
        }

        .toast.warning .toast-icon {
            color: #F97316;
        }

        .toast.info .toast-icon {
            color: var(--md-sys-color-primary);
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 700;
            margin-bottom: var(--spacing-xs);
            font-size: var(--text-body-md);
        }

        .toast-message {
            color: var(--md-sys-color-on-surface-variant);
            white-space: pre-line;
            font-size: var(--text-body-sm);
        }

        .toast-close {
            cursor: pointer;
            color: #999;
            font-size: 20px;
            line-height: 1;
            padding: 0;
            background: none;
            border: none;
            margin-left: 8px;
            flex-shrink: 0;
        }

        .toast-close:hover {
            color: #333;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .toast.removing {
            animation: slideOut 0.3s ease-out forwards;
        }

        [data-theme="dark"] .toast {
            background: linear-gradient(135deg, #2A241F 0%, #211E1B 100%);
            color: #E8E8E8;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        [data-theme="dark"] .toast.success {
            border-left-color: #7FCC7F;
        }

        [data-theme="dark"] .toast.error {
            border-left-color: #FF6B6B;
        }

        [data-theme="dark"] .toast.warning {
            border-left-color: #FFB856;
        }

        [data-theme="dark"] .toast.info {
            border-left-color: #86D5C9;
        }

        [data-theme="dark"] .toast-message {
            color: #BFBFBF;
        }

        [data-theme="dark"] .toast-close {
            color: #8A8080;
            transition: color 0.2s ease;
        }

        [data-theme="dark"] .toast-close:hover {
            color: #E8E8E8;
        }

        .connection-status {
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 12px;
            display: none;
        }

        .connection-status.success {
            background-color: #E8F5E9;
            color: #2E7D32;
            border: 1px solid #4CAF50;
            display: block;
        }

        .connection-status.error {
            background-color: #FFEBEE;
            color: #DC2626;
            border: 1px solid #DC2626;
            display: block;
        }

        .connection-status.testing {
            background-color: #FFF3E0;
            color: #E65100;
            border: 1px solid #FF9800;
            display: block;
        }

        [data-theme="dark"] .connection-status.success {
            background-color: #1B5E20;
            color: #A5D6A7;
            border-color: #16A34A;
        }

        [data-theme="dark"] .connection-status.error {
            background-color: #B71C1C;
            color: #EF9A9A;
            border-color: #E57373;
        }

        [data-theme="dark"] .connection-status.testing {
            background-color: #E65100;
            color: #FFCC80;
            border-color: #FFB74D;
        }

        .api-help-text {
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
            line-height: 1.5;
            margin: 0;
        }

        .api-help-text a {
            color: var(--md-sys-color-primary);
            text-decoration: none;
        }

        .api-help-text a:hover {
            text-decoration: underline;
        }

        /* Tablet Optimizations */
        @media (max-width: 1024px) and (min-width: 769px) {
            .hero-metrics-row {
                grid-template-columns: repeat(2, 1fr);
                gap: 18px;
            }

            .hero-metric-card .metric-value {
                font-size: 1.875rem;
            }

            .hero-metric-card .card-title {
                font-size: 0.9rem;
            }

            .hero-metric-card .metric-secondary {
                flex-wrap: wrap;
                gap: 0.75rem;
            }

            .hero-metric-card .secondary-item {
                min-width: 45%;
            }

            .spectrum-container {
                gap: 20px;
            }

            .percentile-value {
                font-size: 19px;
            }

            .percentile-marker.median .percentile-value {
                font-size: 23px;
            }
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            /* Key Metrics Responsive */
            .hero-metrics-row {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .hero-metric-card {
                padding: 1.25rem;
            }

            .hero-metric-card .card-header {
                margin-bottom: 1rem;
            }

            .hero-metric-card .metric-value {
                font-size: 2rem;
            }

            .hero-metric-card .metric-suffix {
                font-size: 1rem;
            }

            .hero-metric-card .metric-secondary {
                flex-direction: row;
                gap: 1rem;
            }

            .hero-metric-card .secondary-value {
                font-size: 0.9rem;
            }

            .hero-metric-card .secondary-label {
                font-size: 0.7rem;
            }

            .hero-metric-card .worst-case {
                padding: 0.4rem 0.6rem;
            }

            .hero-metric-card .worst-case-text {
                font-size: 0.75rem;
            }

            .secondary-metrics-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            /* Strategy comparison columns - stack vertically on mobile */
            .comparison-metrics-grid {
                grid-template-columns: 1fr !important;
                gap: 16px !important;
            }

            .spectrum-container {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .spectrum-container::before {
                display: none;
            }

            .percentile-marker.median {
                transform: scale(1);
                order: -1;
            }

            .percentile-value {
                font-size: 18px;
            }

            .percentile-marker.median .percentile-value {
                font-size: 22px;
            }

            .metadata-row {
                grid-template-columns: 1fr;
            }

            /* Portfolio & Params responsive */
            .portfolio-integrated-section {
                padding: 1.25rem;
            }

            .portfolio-integrated-header {
                gap: 0.75rem;
                margin-bottom: 1.25rem;
            }

            .portfolio-integrated-icon {
                width: 40px;
                height: 40px;
            }

            .portfolio-integrated-icon .material-icons {
                font-size: 22px;
            }

            .portfolio-integrated-title-group h3 {
                font-size: 1.125rem;
            }

            /* Donut chart mobile adjustments */
            .portfolio-donut-container {
                flex-direction: column;
                gap: 1.25rem;
            }

            .portfolio-donut {
                width: 130px;
                height: 130px;
            }

            .portfolio-donut-center {
                width: 82px;
                height: 82px;
            }

            .portfolio-donut-center-value {
                font-size: 1rem;
            }

            .portfolio-donut-center-label {
                font-size: 0.625rem;
            }

            .portfolio-legend {
                width: 100%;
            }

            .portfolio-legend-item {
                padding: 0.375rem 0.625rem;
            }

            .portfolio-legend-name {
                font-size: 0.8125rem;
            }

            .portfolio-legend-percent {
                font-size: 0.875rem;
            }

            .params-grid {
                grid-template-columns: 1fr !important;
                gap: 1.5rem !important;
                padding: 1.25rem !important;
            }

            .params-grid .param-item {
                display: flex !important;
                flex-direction: column !important;
                align-items: flex-start !important;
                justify-content: flex-start !important;
                gap: 0.375rem !important;
            }

            .params-grid .param-label {
                font-size: 0.6875rem;
                margin-bottom: 0;
            }

            .params-grid .param-value {
                font-size: 1.5rem !important;
                text-align: left !important;
            }

            .app-body {
                flex-direction: column;
                height: auto;
            }

            .left-panel {
                width: 100%;
                border-right: none;
                border-bottom: 4px solid var(--md-sys-color-primary);
                max-height: none;
            }

            .main-content {
                padding: 16px;
            }

            .top-header {
                padding: 20px 16px 24px 16px;
                overflow: visible;
            }

            .top-header h1 {
                font-size: 24px;
                flex-direction: column;
                gap: 8px;
            }

            .top-header .subtitle {
                font-size: 14px;
            }

            .theme-toggle-wrapper {
                top: 12px;
                right: 12px;
                gap: 8px;
                z-index: 10;
                flex-direction: column;
                align-items: flex-end;
            }

            .theme-toggle {
                padding: 8px;
                width: 40px;
                height: 40px;
            }

            .theme-toggle .material-icons {
                font-size: 20px;
            }

            /* Ensure header content doesn't overlap with icons */
            .top-header h1 {
                padding-right: 60px; /* Space for vertically stacked icons */
            }

            .top-header .subtitle {
                padding-right: 60px;
            }

            /* Make inputs and buttons more touch-friendly */
            input[type="text"],
            input[type="number"],
            textarea,
            select {
                padding: 14px 16px;
                font-size: 16px; /* Prevents zoom on iOS */
            }

            .button-primary {
                padding: 18px;
                font-size: 16px;
            }

            /* Adjust cards for mobile */
            .summary-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .card {
                padding: 16px;
                margin-bottom: 16px;
            }

            /* Chart containers */
            .charts-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .chart-container {
                height: 300px;
                padding: 12px;
                margin-bottom: 16px;
            }

            /* Make charts more responsive on mobile */
            canvas {
                max-width: 100%;
                height: auto !important;
            }

            /* Tables */
            table {
                font-size: 13px;
            }

            th, td {
                padding: 10px 8px;
            }

            /* Welcome guide mobile adjustments */
            .welcome-guide {
                padding: 0;
            }

            .guide-header h2 {
                font-size: 24px;
            }

            .guide-icon {
                font-size: 48px;
            }

            .step-card {
                flex-direction: column;
                padding: 16px;
            }

            .step-number {
                font-size: 32px;
            }

            .guide-cta {
                flex-direction: column;
                padding: 24px 16px;
                gap: 16px;
            }

            .cta-arrow {
                animation: bounceDown 2s infinite;
            }

            @keyframes bounceDown {
                0%, 100% { transform: translateY(0); }
                50% { transform: translateY(10px); }
            }

            /* Salary equivalent */
            .salary-equivalent {
                padding: 20px 16px;
            }

            .salary-equivalent .amount {
                font-size: 30px;
            }

            .salary-equivalent .taxable-amount {
                font-size: 26px;
            }

            .section-header {
                font-size: 18px;
            }

            /* Input groups side by side */
            .input-group label {
                font-size: 14px;
            }

            /* Make 3-column reduction grid stack on mobile */
            div[style*="grid-template-columns: 1fr 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }

            /* Empty state */
            .empty-state {
                padding: 40px 20px;
            }

            .empty-state h3 {
                font-size: 20px;
            }

            .empty-state .icon {
                font-size: 56px;
            }

            /* Field instructions mobile */
            .field-instructions {
                padding: 20px 16px;
            }

            .instructions-header h3 {
                font-size: 22px;
            }

            .instructions-header p {
                font-size: 14px;
            }

            .instruction-item {
                padding: 16px;
            }

            .instruction-item h4 {
                font-size: 16px;
            }

            .instruction-item p,
            .instruction-item li {
                font-size: 14px;
            }

            .toggle-instructions-btn {
                padding: 14px 20px;
                font-size: 15px;
            }
        }

        /* Small mobile devices */
        @media (max-width: 480px) {
            .top-header h1 {
                font-size: 20px;
                padding-right: 130px; /* Adjusted for smaller icons */
            }

            .top-header {
                padding: 16px 12px;
            }

            .theme-toggle-wrapper {
                top: 10px;
                right: 8px;
                gap: 8px;
                flex-direction: column;
                align-items: flex-end;
            }

            .theme-toggle {
                padding: 7px;
                width: 38px;
                height: 38px;
            }

            .theme-toggle .material-icons {
                font-size: 18px;
            }

            .main-content {
                padding: 12px;
            }

            .panel-content {
                padding: 16px;
            }

            .card {
                padding: 12px;
            }

            .salary-equivalent .amount {
                font-size: 24px;
            }

            .salary-equivalent .taxable-amount {
                font-size: 22px;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px 6px;
            }

            .guide-header h2 {
                font-size: 20px;
            }

            .step-content h3 {
                font-size: 16px;
            }

            .step-content p {
                font-size: 14px;
            }
        }

        /* Improve touch targets */
        @media (hover: none) and (pointer: coarse) {
            .theme-toggle,
            .button,
            .checkbox-group input[type="checkbox"] {
                min-height: 44px;
                min-width: 44px;
            }

            select option {
                padding: 12px;
            }
        }

        /* Escape Velocity Unlocked Banner */
        .escape-velocity-banner {
            background: linear-gradient(135deg, #2A9D8F 0%, #3db3a3 50%, #1d6b63 100%);
            border: 2px solid #4dbdae;
            border-radius: 6px;
            padding: 28px;
            margin-bottom: 3px;
            box-shadow: 0 8px 24px rgba(42, 157, 143, 0.3);
            animation: slideInDown 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }

        .escape-velocity-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmerGlow 2s infinite;
        }

        .escape-velocity-content {
            position: relative;
            z-index: 1;
            text-align: center;
        }

        .escape-velocity-text {
            font-size: 32px;
            font-weight: 700;
            color: white;
            margin: 0;
            text-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .escape-velocity-emoji {
            font-size: 48px;
            display: inline-block;
            margin-right: 12px;
            animation: rocketBounce 1.5s ease-in-out infinite;
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes rocketBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        @keyframes shimmerGlow {
            0% { transform: translateX(-100%); }
            50% { transform: translateX(0); }
            100% { transform: translateX(100%); }
        }

        [data-theme="dark"] .escape-velocity-banner {
            background: linear-gradient(135deg, #1d6b63 0%, #164d47 50%, #0d302c 100%);
            border-color: #2A9D8F;
            box-shadow: 0 8px 24px rgba(42, 157, 143, 0.15);
        }

        /* Encouragement Banner - Work in Progress */
        .encouragement-banner {
            background: linear-gradient(135deg, #EAB308 0%, #F59E0B 50%, #D97706 100%);
            border: 2px solid #FCD34D;
            border-radius: 6px;
            padding: 28px;
            margin-bottom: 3px;
            box-shadow: 0 8px 24px rgba(234, 179, 8, 0.25);
            animation: slideInDown 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }

        .encouragement-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.12), transparent);
            animation: shimmerGlow 2s infinite;
        }

        .encouragement-content {
            position: relative;
            z-index: 1;
            text-align: center;
        }

        .encouragement-text {
            font-size: 32px;
            font-weight: 700;
            color: white;
            margin: 0;
            text-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .encouragement-emoji {
            font-size: 48px;
            display: inline-block;
            margin-right: 12px;
            animation: flexBounce 1.5s ease-in-out infinite;
        }

        @keyframes flexBounce {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.15) rotate(-5deg); }
        }

        [data-theme="dark"] .encouragement-banner {
            background: linear-gradient(135deg, #B45309 0%, #92400E 50%, #6B2E0A 100%);
            border-color: #FCD34D;
            box-shadow: 0 8px 24px rgba(234, 179, 8, 0.15);
        }

        /* Parameter Summary Section */
        .params-summary-container {
            background: linear-gradient(135deg, rgba(255,255,255,0.6) 0%, rgba(250,250,252,0.8) 100%);
            border: 1px solid rgba(42, 157, 143, 0.15);
            border-radius: 4px;
            padding: 24px 32px;
            margin-bottom: 28px;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            animation: fadeInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .params-summary-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #2A9D8F 0%, #16A34A 100%);
        }

        .params-summary-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 22px;
            font-weight: 600;
            color: #1a1a1a;
            margin: 0 0 18px 0;
            letter-spacing: -0.3px;
            padding-left: 8px;
        }

        .params-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px 24px;
            padding-left: 8px;
        }

        .param-item {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            padding: 8px 0;
            border-bottom: 1px dashed rgba(42, 157, 143, 0.12);
            transition: all 0.2s ease;
        }

        .param-item:hover {
            padding-left: 6px;
            border-bottom-color: rgba(42, 157, 143, 0.3);
        }

        .param-label {
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 500;
            color: #555;
            letter-spacing: 0.2px;
            text-transform: uppercase;
            margin-right: 12px;
        }

        .param-value {
            font-family: 'Cormorant Garamond', serif;
            font-size: 18px;
            font-weight: 600;
            color: #2A9D8F;
            white-space: nowrap;
        }

        .param-value-highlight {
            color: #16A34A;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        [data-theme="dark"] .params-summary-container {
            background: linear-gradient(135deg, rgba(26, 26, 26, 0.7) 0%, rgba(30, 30, 35, 0.85) 100%);
            border-color: rgba(42, 157, 143, 0.25);
        }

        [data-theme="dark"] .params-summary-container::before {
            background: linear-gradient(180deg, #4dbdae 0%, #16A34A 100%);
        }

        [data-theme="dark"] .params-summary-title {
            color: #e8e8e8;
        }

        [data-theme="dark"] .param-item {
            border-bottom-color: rgba(77, 189, 174, 0.15);
        }

        [data-theme="dark"] .param-item:hover {
            border-bottom-color: rgba(77, 189, 174, 0.35);
        }

        [data-theme="dark"] .param-label {
            color: #a8a8a8;
        }

        [data-theme="dark"] .param-value {
            color: #4dbdae;
        }

        [data-theme="dark"] .param-value-highlight {
            color: #5cd18c;
        }

        /* 
           GUARDRAILS-STYLE PORTFOLIO & PARAMETERS DESIGN
            */

        /* Unified container for portfolio + parameters */
        .params-summary-container {
            background: var(--neutral-surface, #FFFFFF);
            border-radius: 1rem;
            border: 1px solid var(--border-default, #E2E8F0);
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 121, 107, 0.07);
            animation: fadeInUp 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            margin-bottom: 2rem;
            padding: 0;
        }

        /* Portfolio section - guardrails style */
        .portfolio-integrated-section {
            padding: 1.5rem;
            background: #E0F2F1;
            position: relative;
            overflow: hidden;
        }

        .portfolio-integrated-section::before {
            display: none;
        }

        .portfolio-integrated-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            animation: fadeIn 0.8s cubic-bezier(0.23, 1, 0.32, 1) 0.2s backwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .portfolio-integrated-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: #00796B;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 121, 107, 0.25);
        }

        .portfolio-integrated-icon .material-icons {
            font-size: 26px;
            color: white;
        }

        .portfolio-integrated-title-group h3 {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            font-size: 1.25rem;
            font-weight: 700;
            color: #1A1F36;
            letter-spacing: -0.01em;
            margin: 0;
        }

        .portfolio-integrated-count {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            font-size: 0.875rem;
            color: #4E5D78;
            font-weight: 500;
            margin-top: 0.125rem;
        }

        /* Portfolio Donut Chart + Legend Layout */
        .portfolio-donut-container {
            display: flex;
            align-items: flex-start;
            gap: 2rem;
            animation: fadeIn 0.8s cubic-bezier(0.23, 1, 0.32, 1) 0.3s backwards;
        }

        /* Donut Chart */
        .portfolio-donut-wrapper {
            position: relative;
            flex-shrink: 0;
        }

        .portfolio-donut {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            position: relative;
            animation: donutSpin 1s cubic-bezier(0.23, 1, 0.32, 1) 0.4s backwards;
        }

        @keyframes donutSpin {
            from {
                opacity: 0;
                transform: rotate(-90deg) scale(0.8);
            }
            to {
                opacity: 1;
                transform: rotate(0deg) scale(1);
            }
        }

        .portfolio-donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            background: #E0F2F1;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .portfolio-donut-center-value {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            font-size: 1.125rem;
            font-weight: 700;
            color: #00796B;
            line-height: 1.2;
        }

        .portfolio-donut-center-label {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            font-size: 0.6875rem;
            color: #4E5D78;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
        }

        /* Legend Table */
        .portfolio-legend {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.625rem;
            min-width: 0;
        }

        .portfolio-legend-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0.75rem;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 8px;
            transition: all 0.2s ease;
            animation: slideInRight 0.5s cubic-bezier(0.23, 1, 0.32, 1) backwards;
            position: relative;
            overflow: hidden;
        }

        .portfolio-legend-bar {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            opacity: 0.18;
            border-radius: 8px;
            transition: width 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            z-index: 0;
        }

        .portfolio-legend-color,
        .portfolio-legend-name,
        .portfolio-legend-percent {
            position: relative;
            z-index: 1;
        }

        .portfolio-legend-item:nth-child(1) { animation-delay: 0.5s; }
        .portfolio-legend-item:nth-child(2) { animation-delay: 0.55s; }
        .portfolio-legend-item:nth-child(3) { animation-delay: 0.6s; }
        .portfolio-legend-item:nth-child(4) { animation-delay: 0.65s; }
        .portfolio-legend-item:nth-child(5) { animation-delay: 0.7s; }
        .portfolio-legend-item:nth-child(6) { animation-delay: 0.75s; }
        .portfolio-legend-item:nth-child(7) { animation-delay: 0.8s; }
        .portfolio-legend-item:nth-child(8) { animation-delay: 0.85s; }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .portfolio-legend-item:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateX(4px);
        }

        .portfolio-legend-color {
            width: 14px;
            height: 14px;
            border-radius: 4px;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .portfolio-legend-name {
            flex: 1;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            font-size: 0.875rem;
            font-weight: 500;
            color: #1A1F36;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 0;
        }

        .portfolio-legend-percent {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            font-size: 0.9375rem;
            font-weight: 700;
            color: #00796B;
            flex-shrink: 0;
            min-width: 50px;
            text-align: right;
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            .portfolio-donut-container {
                flex-direction: column;
                gap: 1.5rem;
            }

            .portfolio-donut {
                width: 140px;
                height: 140px;
            }

            .portfolio-donut-center {
                width: 88px;
                height: 88px;
            }

            .portfolio-donut-center-value {
                font-size: 1rem;
            }

            .portfolio-legend {
                width: 100%;
            }
        }

        /* Section divider - hidden, using border instead */
        .section-divider-integrated {
            display: none;
        }

        /* Parameters grid - guardrails style */
        .params-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem 3rem;
            padding: 1.5rem;
            background: #FFFFFF;
            position: relative;
        }

        /* Left and bottom border gradient accent */
        .params-grid::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #00796B 0%, #10B981 100%);
            border-radius: 0 2px 2px 0;
        }

        .param-item {
            display: flex;
            flex-direction: row;
            align-items: baseline;
            justify-content: space-between;
            animation: fadeInUp 0.6s cubic-bezier(0.23, 1, 0.32, 1) backwards;
            border-bottom: none;
            padding: 0.5rem 0;
        }

        .param-item:nth-child(1) { animation-delay: 0.7s; }
        .param-item:nth-child(2) { animation-delay: 0.75s; }
        .param-item:nth-child(3) { animation-delay: 0.8s; }
        .param-item:nth-child(4) { animation-delay: 0.85s; }
        .param-item:nth-child(5) { animation-delay: 0.9s; }
        .param-item:nth-child(6) { animation-delay: 0.95s; }
        .param-item:nth-child(7) { animation-delay: 1s; }
        .param-item:nth-child(8) { animation-delay: 1.05s; }

        .param-label {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #78716C;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0;
            flex-shrink: 0;
        }

        .param-label::before {
            content: '';
            width: 3px;
            height: 14px;
            background: #00796B;
            border-radius: 2px;
        }

        .param-value {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            font-size: 1.5rem;
            font-weight: 600;
            color: #00796B;
            letter-spacing: -0.02em;
            transition: color 0.3s;
            text-align: right;
        }

        .param-item:hover .param-value {
            color: #00695C;
        }

        .param-value-highlight {
            color: #00796B;
            font-weight: 700;
        }

        /* Dark theme overrides for integrated design - guardrails style */
        [data-theme="dark"] .params-summary-container {
            background: #141823;
            border-color: #2D3748;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
        }

        [data-theme="dark"] .portfolio-integrated-section {
            background: #001F1A;
        }

        [data-theme="dark"] .portfolio-integrated-section::before {
            display: none;
        }

        [data-theme="dark"] .portfolio-integrated-icon {
            background: #00BFA5;
            box-shadow: 0 4px 12px rgba(0, 191, 165, 0.3);
        }

        [data-theme="dark"] .portfolio-integrated-title-group h3 {
            color: #F0F4F8;
        }

        [data-theme="dark"] .portfolio-integrated-count {
            color: #A0AEC0;
        }

        /* Dark mode for donut chart */
        [data-theme="dark"] .portfolio-donut-center {
            background: #001F1A;
        }

        [data-theme="dark"] .portfolio-donut-center-value {
            color: #00BFA5;
        }

        [data-theme="dark"] .portfolio-donut-center-label {
            color: #A0AEC0;
        }

        [data-theme="dark"] .portfolio-legend-item {
            background: rgba(30, 36, 50, 0.6);
        }

        [data-theme="dark"] .portfolio-legend-item:hover {
            background: rgba(30, 36, 50, 0.9);
        }

        [data-theme="dark"] .portfolio-legend-bar {
            opacity: 0.25;
        }

        [data-theme="dark"] .portfolio-legend-name {
            color: #F0F4F8;
        }

        [data-theme="dark"] .portfolio-legend-percent {
            color: #00BFA5;
        }

        [data-theme="dark"] .section-divider-integrated {
            display: none;
        }

        [data-theme="dark"] .params-grid {
            background: #141823;
        }

        [data-theme="dark"] .params-grid::before {
            background: linear-gradient(180deg, #00BFA5 0%, #10B981 100%);
        }

        [data-theme="dark"] .param-label {
            color: #A0AEC0;
        }

        [data-theme="dark"] .param-label::before {
            background: #00BFA5;
        }

        [data-theme="dark"] .param-value {
            color: #00BFA5;
        }

        [data-theme="dark"] .param-item:hover .param-value {
            color: #00E5CC;
        }

        [data-theme="dark"] .param-value-highlight {
            color: #00BFA5;
        }

        /* ========================================
           Phase 3a: Critical Dark Mode Overrides
           ======================================== */

        /* 1. Metadata Card System */
        [data-theme="dark"] .metadata-card {
            background-color: var(--md-sys-color-surface);
            border-color: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface);
        }

        [data-theme="dark"] .metadata-card:hover {
            box-shadow: 0 4px 12px rgba(77, 184, 160, 0.2);
            border-color: var(--color-brand-primary);
            background-color: var(--md-sys-color-surface-container-high);
        }

        [data-theme="dark"] .metadata-icon {
            color: var(--md-sys-color-primary);
        }

        [data-theme="dark"] .metadata-label {
            color: var(--md-sys-color-on-surface-variant);
        }

        [data-theme="dark"] .metadata-value {
            color: var(--md-sys-color-on-surface);
        }

        [data-theme="dark"] .metadata-row {
            border-color: var(--md-sys-color-surface-variant);
        }

        /* 2. Asset Listbox & Selection */
        [data-theme="dark"] .asset-listbox {
            background-color: var(--md-sys-color-surface);
            border-color: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface);
        }

        [data-theme="dark"] .asset-listbox-item {
            color: var(--md-sys-color-on-surface);
            background-color: transparent;
            border-bottom-color: rgba(255, 255, 255, 0.08);
        }

        [data-theme="dark"] .asset-listbox-item:hover {
            background-color: rgba(77, 184, 160, 0.15);
        }

        [data-theme="dark"] .asset-listbox-item:active {
            background-color: rgba(77, 184, 160, 0.25);
        }

        [data-theme="dark"] .asset-listbox-item-name {
            color: var(--md-sys-color-on-surface);
        }

        [data-theme="dark"] .asset-listbox-item-stats {
            color: var(--md-sys-color-on-surface-variant);
        }

        [data-theme="dark"] .asset-listbox-item-badge {
            background-color: rgba(77, 184, 160, 0.2);
            color: #4db8a0;
        }

        [data-theme="dark"] .asset-listbox-item-badge.bond {
            background-color: rgba(33, 150, 243, 0.2);
            color: #64b5f6;
        }

        [data-theme="dark"] .asset-listbox-item-badge.commodity {
            background-color: rgba(255, 152, 0, 0.2);
            color: #ffb74d;
        }

        [data-theme="dark"] .asset-listbox-item-badge.index {
            background-color: rgba(156, 39, 176, 0.2);
            color: #ba68c8;
        }

        [data-theme="dark"] .asset-listbox-item-add-btn {
            background-color: rgba(255, 255, 255, 0.08);
            color: var(--md-sys-color-on-surface-variant);
        }

        [data-theme="dark"] .asset-listbox-item-add-btn:hover {
            background-color: rgba(77, 184, 160, 0.25);
            color: #4db8a0;
        }

        [data-theme="dark"] .asset-weight-item {
            background-color: var(--md-sys-color-surface-container);
            border-color: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface);
        }

        [data-theme="dark"] .asset-weight-item .asset-name {
            color: var(--md-sys-color-on-surface);
        }

        [data-theme="dark"] .asset-info-stats {
            color: var(--md-sys-color-on-surface-variant);
        }

        [data-theme="dark"] .asset-info-badge {
            background-color: rgba(77, 184, 160, 0.2);
            color: #4db8a0;
        }

        [data-theme="dark"] .asset-info-badge.bond {
            background-color: rgba(33, 150, 243, 0.2);
            color: #64b5f6;
        }

        [data-theme="dark"] .asset-info-badge.commodity {
            background-color: rgba(255, 152, 0, 0.2);
            color: #ffb74d;
        }

        [data-theme="dark"] .asset-info-badge.index {
            background-color: rgba(156, 39, 176, 0.2);
            color: #ba68c8;
        }

        [data-theme="dark"] .asset-selector-grid {
            color: var(--md-sys-color-on-surface);
        }

        [data-theme="dark"] .asset-chip {
            background-color: var(--md-sys-color-surface-container);
            color: var(--md-sys-color-on-surface);
            border-color: var(--md-sys-color-surface-variant);
        }

        /* 3. Liquidity Dashboard */
        [data-theme="dark"] .liquidity-dashboard-grid {
            background-color: var(--md-sys-color-on-primary-container);
        }

        [data-theme="dark"] .liquidity-status-banner {
            background-color: var(--md-sys-color-surface-container);
            border-color: var(--md-sys-color-surface-variant);
        }

        [data-theme="dark"] .liquidity-status-icon {
            color: var(--md-sys-color-primary);
        }

        [data-theme="dark"] .liquidity-status-title {
            color: var(--md-sys-color-on-surface);
        }

        [data-theme="dark"] .liquidity-status-description {
            color: var(--md-sys-color-on-surface-variant);
        }

        /* 4. Settings Panel */
        [data-theme="dark"] .settings-panel {
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
        }

        [data-theme="dark"] .settings-section {
            border-color: var(--md-sys-color-surface-variant);
            background-color: var(--md-sys-color-surface-container);
        }

        [data-theme="dark"] .settings-header {
            color: var(--md-sys-color-on-surface);
            border-color: var(--md-sys-color-surface-variant);
        }

        [data-theme="dark"] .settings-option {
            color: var(--md-sys-color-on-surface);
        }

        /* 5. Secondary Metrics */
        [data-theme="dark"] .secondary-metric-card {
            background-color: var(--md-sys-color-surface-container);
            border-color: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface);
        }

        [data-theme="dark"] .metric-icon-secondary {
            color: var(--md-sys-color-primary);
        }

        [data-theme="dark"] .metric-label-secondary {
            color: var(--md-sys-color-on-surface-variant);
        }

        [data-theme="dark"] .metric-value-secondary {
            color: var(--md-sys-color-on-surface);
        }

        /* 6. API Configuration Section */
        [data-theme="dark"] .api-section {
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
        }

        [data-theme="dark"] .api-config-section {
            border-color: var(--md-sys-color-surface-variant);
            background-color: var(--md-sys-color-surface-container);
        }

        [data-theme="dark"] .api-key-input {
            background-color: var(--md-sys-color-surface-container);
            color: var(--md-sys-color-on-surface);
            border-color: var(--md-sys-color-surface-variant);
        }

        [data-theme="dark"] .api-key-input:focus {
            border-color: var(--md-sys-color-primary);
        }

        [data-theme="dark"] .data-source-option {
            color: var(--md-sys-color-on-surface);
            background-color: var(--md-sys-color-surface-container);
            border-color: var(--md-sys-color-surface-variant);
        }

        [data-theme="dark"] .test-connection-btn {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
        }

        /* ========================================
           Phase 3b: Medium-Priority Dark Mode Rules
           ======================================== */

        /* 1. Tables & Data Display */
        [data-theme="dark"] .table-container {
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
        }

        [data-theme="dark"] .correlation-matrix {
            background-color: var(--md-sys-color-surface);
            border-color: var(--md-sys-color-surface-variant);
        }

        [data-theme="dark"] .correlation-matrix thead {
            background-color: var(--md-sys-color-surface-container);
        }

        [data-theme="dark"] .correlation-matrix th {
            color: var(--md-sys-color-on-surface);
            border-color: var(--md-sys-color-surface-variant);
        }

        [data-theme="dark"] .correlation-matrix td {
            border-color: var(--md-sys-color-surface-variant);
        }

        /* 2. Portfolio Management UI */
        [data-theme="dark"] .portfolio-assets-card {
            background-color: var(--md-sys-color-surface-container);
            border-color: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface);
        }

        [data-theme="dark"] .portfolio-weight-bar {
            background-color: var(--md-sys-color-surface-variant);
        }

        [data-theme="dark"] .weight-segment {
            opacity: 0.9;
        }

        [data-theme="dark"] .asset-chip {
            background-color: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface);
        }

        [data-theme="dark"] .assets-preview {
            background-color: var(--md-sys-color-surface-container);
            border-color: var(--md-sys-color-surface-variant);
        }

        /* 3. User Guidance & Onboarding */
        [data-theme="dark"] .step-card {
            background-color: var(--md-sys-color-surface-container);
            border-color: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface);
        }

        [data-theme="dark"] .guide-steps {
            background-color: var(--md-sys-color-surface);
        }

        [data-theme="dark"] .field-instructions {
            background-color: var(--md-sys-color-surface-container);
            border-color: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface);
        }

        [data-theme="dark"] .instruction-item {
            color: var(--md-sys-color-on-surface);
            border-color: var(--md-sys-color-surface-variant);
        }


        /* 4. Asset Management Details */
        [data-theme="dark"] .asset-selector-grid {
            background-color: var(--md-sys-color-surface);
        }

        [data-theme="dark"] .add-asset-section {
            background-color: var(--md-sys-color-surface-container);
            border-color: var(--md-sys-color-surface-variant);
        }

        [data-theme="dark"] .empty-state {
            color: var(--md-sys-color-on-surface-variant);
        }

        [data-theme="dark"] .preset-selector {
            background-color: var(--md-sys-color-surface-container);
            color: var(--md-sys-color-on-surface);
            border-color: var(--md-sys-color-surface-variant);
        }

        /* 5. Chart & Spectrum Visualization */
        [data-theme="dark"] .charts-grid {
            background-color: var(--md-sys-color-background);
        }

        [data-theme="dark"] .chart-container {
            background-color: var(--md-sys-color-surface);
            border-color: var(--md-sys-color-surface-variant);
        }

        [data-theme="dark"] .outcome-spectrum {
            background-color: var(--md-sys-color-surface-container);
        }

        [data-theme="dark"] .spectrum-container {
            background-color: var(--md-sys-color-surface);
        }

        [data-theme="dark"] .percentile-marker {
            color: var(--md-sys-color-on-surface);
        }

        [data-theme="dark"] .percentile-marker.worst .percentile-value {
            color: var(--color-percentile-worst-text);
            background: var(--color-percentile-worst-bg);
        }

        [data-theme="dark"] .percentile-marker.median .percentile-value {
            color: var(--color-percentile-median-text);
            background: var(--color-percentile-median-bg);
            border-color: var(--color-percentile-median-text);
            box-shadow: 0 4px 16px rgba(76, 111, 255, 0.3);
        }

        [data-theme="dark"] .percentile-marker.best .percentile-value {
            color: var(--color-percentile-best-text);
            background: var(--color-percentile-best-bg);
        }

        [data-theme="dark"] .percentile-marker.median .percentile-label {
            color: var(--color-percentile-median-text);
        }

        /* ========================================
           Phase 3c: Polish & Refinement
           ======================================== */

        /* Text Refinements */
        [data-theme="dark"] .error-text {
            color: #FF6B6B;
        }

        [data-theme="dark"] .helper-text {
            color: var(--md-sys-color-on-surface-variant);
        }

        [data-theme="dark"] .instructions-header {
            color: var(--md-sys-color-on-surface);
        }

        /* Icon Adjustments */
        [data-theme="dark"] .material-icons {
            color: inherit;
        }

        [data-theme="dark"] [class*="icon"] {
            color: inherit;
        }

        /* Modal Refinements */
        [data-theme="dark"] .modal-input {
            background-color: var(--md-sys-color-surface-container);
            color: var(--md-sys-color-on-surface);
            border-color: var(--md-sys-color-surface-variant);
        }

        [data-theme="dark"] .modal-input:focus {
            border-color: var(--md-sys-color-primary);
            outline: none;
        }

        [data-theme="dark"] .modal-input::placeholder {
            color: var(--md-sys-color-on-surface-variant);
            opacity: 0.7;
        }

        /* Button Refinements */
        [data-theme="dark"] button {
            color: var(--md-sys-color-on-surface);
        }

        [data-theme="dark"] .btn-primary {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
        }

        [data-theme="dark"] .btn-secondary {
            background-color: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface);
        }

        /* Badge Styling */
        [data-theme="dark"] .badge {
            background-color: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface);
        }

        /* Border Consistency */
        [data-theme="dark"] input,
        [data-theme="dark"] select,
        [data-theme="dark"] textarea {
            border-color: var(--md-sys-color-surface-variant);
            background-color: var(--md-sys-color-surface-container);
            color: var(--md-sys-color-on-surface);
        }

        [data-theme="dark"] input:focus,
        [data-theme="dark"] select:focus,
        [data-theme="dark"] textarea:focus {
            border-color: var(--md-sys-color-primary);
            outline: none;
        }

        /* ========================================
           Phase 2: Utility Classes for Inline Styles
           ======================================== */

        /* Visibility utilities */
        .hidden {
            display: none;
        }

        .visible {
            display: block;
        }

        /* Margin utilities */
        .mb-0 {
            margin-bottom: 0;
        }

        .mb-8 {
            margin-bottom: 8px;
        }

        .mb-10 {
            margin-bottom: 10px;
        }

        .mb-12 {
            margin-bottom: 12px;
        }

        .mb-16 {
            margin-bottom: 16px;
        }

        .ml-0 {
            margin-left: 0;
        }

        /* List styles */
        .list-indented {
            margin-left: 20px;
        }

        .list-indented-spaced {
            margin-left: 20px;
            line-height: 1.8;
        }

        .list-indented-deep {
            margin-left: 40px;
        }

        .list-indented-deep-spaced {
            margin-left: 40px;
            margin-bottom: 16px;
            line-height: 2;
            list-style-type: disc;
        }

        .list-indented-deep-compact {
            margin-left: 40px;
            margin-top: 8px;
            margin-bottom: 8px;
            line-height: 1.8;
        }

        /* Grid layouts */
        .grid-2-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .grid-3-col {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        /* Flexbox utilities */
        .flex-center {
            display: flex;
            align-items: center;
        }

        .flex-center-gap-8 {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .flex-center-gap-10 {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .flex-center-gap-12 {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .flex-center-justify {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ========================================
           Phase 2b: Typography Utilities
           ======================================== */

        /* Font Size Utilities */
        .text-xs { font-size: 11px; }
        .text-sm { font-size: 12px; }
        .text-base { font-size: 13px; }
        .text-md { font-size: 14px; }
        .text-lg { font-size: 16px; }
        .text-xl { font-size: 20px; }
        .text-2xl { font-size: 24px; }
        .text-3xl { font-size: 32px; }
        .text-4xl { font-size: 40px; }

        /* Font Weight Utilities */
        .font-normal { font-weight: 400; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: bold; }

        /* Line Height Utilities */
        .leading-tight { line-height: 1.2; }
        .leading-normal { line-height: 1.5; }
        .leading-relaxed { line-height: 1.6; }
        .leading-spaced { line-height: 1.8; }
        .leading-double { line-height: 2; }

        /* Letter Spacing */
        .tracking-tight { letter-spacing: -0.5px; }
        .tracking-normal { letter-spacing: 0; }
        .tracking-wide { letter-spacing: 0.5px; }
        .tracking-wider { letter-spacing: 1px; }

        /* ========================================
           Phase 2b: Spacing Utilities (Extended)
           ======================================== */

        /* Margin Top */
        .mt-0 { margin-top: 0; }
        .mt-4 { margin-top: 4px; }
        .mt-8 { margin-top: 8px; }
        .mt-12 { margin-top: 12px; }
        .mt-16 { margin-top: 16px; }
        .mt-20 { margin-top: 20px; }
        .mt-24 { margin-top: 24px; }
        .mt-30 { margin-top: 30px; }

        /* Margin Bottom (Extended) */
        .mb-4 { margin-bottom: 4px; }
        .mb-15 { margin-bottom: 15px; }
        .mb-20 { margin-bottom: 20px; }
        .mb-24 { margin-bottom: 24px; }

        /* Margin Left */
        .ml-5 { margin-left: 5px; }
        .ml-20 { margin-left: 20px; }
        .ml-30 { margin-left: 30px; }

        /* Margin Right */
        .mr-5 { margin-right: 5px; }
        .mr-8 { margin-right: 8px; }

        /* Margin Shorthand */
        .m-0 { margin: 0; }
        .m-4 { margin: 4px; }
        .m-8 { margin: 8px; }
        .m-16 { margin: 16px; }

        /* Padding Utilities */
        .p-0 { padding: 0; }
        .p-4 { padding: 4px; }
        .p-5 { padding: 5px; }
        .p-8 { padding: 8px; }
        .p-10 { padding: 10px; }
        .p-12 { padding: 12px; }
        .p-14 { padding: 14px; }
        .p-16 { padding: 16px; }
        .p-20 { padding: 20px; }
        .p-24 { padding: 24px; }

        /* Padding X (left-right) */
        .px-8 { padding: 0 8px; }
        .px-10 { padding: 0 10px; }
        .px-12 { padding: 0 12px; }
        .px-16 { padding: 0 16px; }
        .px-20 { padding: 0 20px; }

        /* Padding Y (top-bottom) */
        .py-4 { padding: 4px 0; }
        .py-8 { padding: 8px 0; }
        .py-10 { padding: 10px 0; }
        .py-12 { padding: 12px 0; }
        .py-16 { padding: 16px 0; }

        /* Padding Left */
        .pl-20 { padding-left: 20px; }

        /* ========================================
           Phase 2b: Border Utilities
           ======================================== */

        /* Border Radius */
        .rounded-none { border-radius: 0; }
        .rounded-sm { border-radius: 4px; }
        .rounded-md { border-radius: 6px; }
        .rounded-lg { border-radius: 4px; }
        .rounded-xl { border-radius: 5px; }
        .rounded-2xl { border-radius: 6px; }
        .rounded-full { border-radius: 9999px; }

        /* Borders */
        .border-none { border: none; }
        .border-1 { border: 1px solid var(--md-sys-color-outline); }
        .border-2 { border: 2px solid var(--md-sys-color-outline); }

        /* Border Top */
        .border-t-1 { border-top: 1px solid var(--md-sys-color-outline); }

        /* Border Bottom */
        .border-b-1 { border-bottom: 1px solid var(--md-sys-color-outline); }

        /* Border Left */
        .border-l-2 { border-left: 2px solid var(--md-sys-color-outline); }
        .border-l-4 { border-left: 4px solid var(--md-sys-color-outline); }

        /* ========================================
           Phase 2b: Text & Display Utilities
           ======================================== */

        /* Text Alignment */
        .text-left { text-align: left; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }

        /* Display Utilities (Extended) */
        .inline { display: inline; }
        .inline-block { display: inline-block; }
        .block { display: block; }
        .flex { display: flex; }
        .grid { display: grid; }

        /* Flex Direction & Wrap */
        .flex-row { flex-direction: row; }
        .flex-col { flex-direction: column; }
        .flex-wrap { flex-wrap: wrap; }
        .flex-nowrap { flex-wrap: nowrap; }

        /* Flex Alignment */
        .items-start { align-items: flex-start; }
        .items-center { align-items: center; }
        .items-end { align-items: flex-end; }
        .items-stretch { align-items: stretch; }

        /* Justify Content */
        .justify-start { justify-content: flex-start; }
        .justify-end { justify-content: flex-end; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .justify-around { justify-content: space-around; }

        /* Gap Utilities */
        .gap-4 { gap: 4px; }
        .gap-8 { gap: 8px; }
        .gap-10 { gap: 10px; }
        .gap-12 { gap: 12px; }
        .gap-16 { gap: 16px; }
        .gap-20 { gap: 20px; }
        .gap-24 { gap: 24px; }

        /* Flex Sizing */
        .flex-1 { flex: 1; }
        .flex-auto { flex: auto; }
        .flex-shrink-0 { flex-shrink: 0; }

        /* ========================================
           Phase 2b: Color Utilities
           ======================================== */

        /* Text Colors */
        .text-primary { color: var(--md-sys-color-primary); }
        .text-error { color: #FF6B6B; }
        .text-surface-variant { color: var(--md-sys-color-on-surface-variant); }
        .text-success { color: #28a745; }
        .text-danger { color: #dc3545; }
        .text-warning { color: #ff9800; }
        .text-info { color: #4C6FFF; }

        /* Background Colors */
        .bg-primary { background-color: var(--md-sys-color-primary); }
        .bg-surface { background-color: var(--md-sys-color-surface); }
        .bg-error { background-color: #FF6B6B; }
        .bg-success { background-color: #28a745; }
        .bg-danger { background-color: #dc3545; }
        .bg-warning { background-color: #ff9800; }
        .bg-info { background-color: #4C6FFF; }
        .bg-light-error { background-color: #ffebee; }
        .bg-light-success { background-color: #e8f5e9; }
        .bg-light-warning { background-color: #fff3e0; }

        /* ========================================
           Phase 2b: Interactive Utilities
           ======================================== */

        /* Cursor */
        .cursor-pointer { cursor: pointer; }
        .cursor-default { cursor: default; }
        .cursor-text { cursor: text; }

        /* White Space */
        .whitespace-normal { white-space: normal; }
        .whitespace-nowrap { white-space: nowrap; }
        .whitespace-pre { white-space: pre; }

        /* Overflow */
        .overflow-auto { overflow: auto; }
        .overflow-hidden { overflow: hidden; }
        .overflow-scroll { overflow: scroll; }
        .overflow-x-auto { overflow-x: auto; }
        .overflow-y-auto { overflow-y: auto; }

        /* Sizing */
        .w-full { width: 100%; }
        .w-auto { width: auto; }
        .min-w-0 { min-width: 0; }
        .max-h-96 { max-height: 600px; }

        /* Transitions */
        .transition-all { transition: all 0.3s ease; }
        .transition-colors { transition: background-color 0.3s ease, color 0.3s ease; }

        /* ========================================
           Phase 2b: Compound Utilities (Common Patterns)
           ======================================== */

        /* Padding + Border Bottom */
        .py-8-border-b { padding: 8px 0; border-bottom: 1px solid var(--md-sys-color-outline); }

        /* Padding + Text Align */
        .p-5-text-center { padding: 5px; text-align: center; }
        .p-5-text-left { padding: 5px; text-align: left; }

        /* Margin Left + Border Bottom */
        .ml-20-mb-16 { margin-left: 20px; margin-bottom: 16px; }

        /* Margin combinations */
        .ml-30-mt-8 { margin-left: 30px; margin-top: 8px; }
        .ml-20-lh-2 { margin-left: 20px; line-height: 2; }
        .my-24 { margin: 24px 0; }
        .m-0 { margin: 0; }

        /* Border combinations */
        .border-none-t-1-my-24 { border: none; border-top: 1px solid var(--md-sys-color-outline); margin: 24px 0; }

        /* Typography compounds */
        .text-sm-on-surface-variant { font-size: 12px; color: var(--md-sys-color-on-surface-variant); }
        .text-sm-on-surface-variant-mb-4 { font-size: 12px; color: var(--md-sys-color-on-surface-variant); margin-bottom: 4px; }
        .text-base-lh-relaxed-on-surface-variant { font-size: 13px; line-height: 1.5; color: var(--md-sys-color-on-surface-variant); }
        .text-sm-lh-relaxed-on-surface-variant { font-size: 13px; line-height: 1.6; color: var(--md-sys-color-on-surface-variant); }
        .text-sm-mt-2-on-surface-variant { font-size: 12px; color: var(--md-sys-color-on-surface-variant); margin-top: 2px; }

        /* Layout compounds */
        .grid-auto-fit-500 { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 24px; }
        .grid-full-mt-24 { grid-template-columns: 1fr; margin-top: 24px; }

        /* Vertical align + margin */
        .align-middle-mr-8 { vertical-align: middle; margin-right: 8px; }

        /* Table styling */
        .table-collapse-text-sm { width: 100%; border-collapse: collapse; font-size: 13px; }
        .table-header-p-10 { padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid var(--md-sys-color-outline); }

        /* Color utilities (additional) */
        .text-warning-orange { color: #F57C00; }

        /* Width compounds */
        .w-full-text-sm-on-surface-variant { width: 100%; color: var(--md-sys-color-on-surface-variant); font-size: 12px; }

        /* Typography primary compounds */
        .text-lg-my-16-text-primary { font-size: 16px; margin: 16px 0; color: var(--md-sys-color-primary); }
        .text-base-my-12-text-primary-semibold { font-size: 13px; margin: 0 0 12px 0; color: var(--md-sys-color-on-surface); font-weight: 600; }

        /* ========================================
           TOC Navigation - Collapsible FAB Menu
           Floating table of contents with scroll spy
           ======================================== */

        /* Toggle Button - Hidden by default, shown after simulation */
        .toc-toggle {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: var(--color-brand-primary);
            color: white;
            border: none;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            z-index: 901;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.23, 1, 0.320, 1);
        }

        /* Show TOC when activated after simulation */
        .toc-toggle.toc-active {
            display: flex;
        }

        .toc-toggle:hover {
            transform: scale(1.08);
            box-shadow: var(--shadow-xl);
        }

        .toc-toggle:active {
            transform: scale(0.95);
        }

        [data-theme="dark"] .toc-toggle {
            background: var(--md-sys-color-primary);
        }

        .toc-toggle svg {
            width: 24px;
            height: 24px;
            transition: transform 0.3s ease;
        }

        .toc-toggle.toc-open svg {
            transform: rotate(45deg);
        }

        /* TOC scroll targets - ensure section headers are visible when navigating via TOC */
        #monteCarloChartsSection,
        #section-charts,
        #section-salary-equivalent,
        #section-executive-summary {
            scroll-margin-top: 24px;
        }

        /* TOC Panel - Hidden by default */
        .toc-nav {
            position: fixed;
            bottom: 88px;
            right: 24px;
            width: 220px;
            max-height: calc(100vh - 140px);
            overflow-y: auto;
            background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(255,255,255,0.95) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 12px;
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255,255,255,0.3);
            z-index: 900;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px) scale(0.95);
            transform-origin: bottom right;
            transition: all 0.25s cubic-bezier(0.23, 1, 0.320, 1);
        }

        .toc-nav.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }

        [data-theme="dark"] .toc-nav {
            background: linear-gradient(135deg, rgba(20,24,35,0.98) 0%, rgba(20,24,35,0.95) 100%);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .toc-header {
            font-size: var(--text-body-sm);
            font-weight: 700;
            color: var(--color-brand-primary);
            margin-bottom: var(--spacing-md);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--color-brand-primary);
        }

        [data-theme="dark"] .toc-header {
            color: var(--md-sys-color-primary);
            border-bottom-color: var(--md-sys-color-primary);
        }

        .toc-nav-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .toc-nav-list li {
            margin-bottom: 2px;
        }

        .toc-nav-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            font-size: var(--text-body-sm);
            color: var(--color-neutral-text-secondary);
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.2s ease;
            border-left: 2px solid transparent;
            cursor: pointer;
        }

        .toc-nav-item:hover {
            background: var(--color-brand-primary-soft);
            color: var(--color-brand-primary);
            transform: translateX(2px);
        }

        .toc-nav-item.active {
            background: var(--color-brand-primary-soft);
            color: var(--color-brand-primary);
            font-weight: 600;
            border-left-color: var(--color-brand-primary);
        }

        [data-theme="dark"] .toc-nav-item {
            color: var(--md-sys-color-on-surface-variant);
        }

        [data-theme="dark"] .toc-nav-item:hover {
            background: rgba(255,255,255,0.08);
            color: var(--md-sys-color-primary);
        }

        [data-theme="dark"] .toc-nav-item.active {
            background: rgba(77, 184, 160, 0.15);
            color: var(--md-sys-color-primary);
            border-left-color: var(--md-sys-color-primary);
        }

        .toc-nav-icon {
            font-size: 14px;
            flex-shrink: 0;
        }

        .toc-nav-label {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Hide TOC items for hidden sections */
        .toc-nav-item.toc-hidden {
            display: none;
        }

        /* Mobile adjustments */
        @media (max-width: 480px) {
            .toc-nav {
                right: 16px;
                bottom: 80px;
                width: calc(100vw - 32px);
                max-width: 280px;
            }

            .toc-toggle {
                right: 16px;
                bottom: 16px;
            }
        }

        /* Custom scrollbar for TOC */
        .toc-nav::-webkit-scrollbar {
            width: 4px;
        }

        .toc-nav::-webkit-scrollbar-track {
            background: transparent;
        }

        .toc-nav::-webkit-scrollbar-thumb {
            background: var(--color-neutral-border-strong);
            border-radius: 4px;
        }

        .toc-nav::-webkit-scrollbar-thumb:hover {
            background: var(--color-brand-primary);
        }

        [data-theme="dark"] .toc-nav::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
        }

        [data-theme="dark"] .toc-nav::-webkit-scrollbar-thumb:hover {
            background: var(--md-sys-color-primary);
        }

        /* ========================================
           Print Report Button Styles - Icon Only
           ======================================== */
        .print-report-container {
            position: fixed;
            bottom: 24px;
            right: 88px; /* Positioned to the left of TOC toggle (24px + 52px + 12px gap) */
            z-index: 900;
            margin: 0;
            padding: 0;
        }

        .print-report-btn {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 52px;
            height: 52px;
            background: var(--color-brand-primary);
            color: #FFFFFF;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s cubic-bezier(0.23, 1, 0.320, 1);
        }

        .print-report-btn .material-icons {
            font-size: 24px;
        }

        .print-report-btn:hover {
            transform: scale(1.08);
            box-shadow: var(--shadow-xl);
        }

        .print-report-btn:active {
            transform: scale(0.95);
        }

        /* Tooltip - appears above button on hover */
        .print-report-btn::after {
            content: 'Print Report';
            position: absolute;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%) translateY(5px);
            padding: 8px 14px;
            background: rgba(15, 26, 23, 0.95);
            color: #fff;
            font-size: 13px;
            font-weight: 500;
            border-radius: 8px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .print-report-btn:hover::after {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Dark theme */
        [data-theme="dark"] .print-report-btn {
            background: var(--md-sys-color-primary);
        }

        [data-theme="dark"] .print-report-btn::after {
            background: rgba(77, 184, 160, 0.95);
            color: #0F1A17;
        }

        /* Hide print button on mobile devices */
        @media (max-width: 768px) {
            .print-report-container {
                display: none !important;
            }
        }

        /* Adjust position for smaller screens to match TOC toggle */
        @media (min-width: 769px) and (max-width: 1200px) {
            .print-report-container {
                bottom: 16px;
                right: 80px;
            }
        }

        /* ========================================
           Back to Results Button Styles
           ======================================== */
        .back-to-results-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 900;
            margin: 0;
            padding: 0;
        }

        .back-to-results-btn {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            height: 52px;
            padding: 0 16px 0 12px; /* More padding on right for text */
            background: var(--color-brand-primary);
            color: #FFFFFF;
            border: none;
            border-radius: 26px; /* Pill shape for desktop with text */
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s cubic-bezier(0.23, 1, 0.320, 1);
            white-space: nowrap;
        }

        .back-to-results-btn .material-icons {
            font-size: 24px;
        }

        .back-to-results-label {
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .back-to-results-btn:hover {
            transform: scale(1.08);
            box-shadow: var(--shadow-xl);
        }

        .back-to-results-btn:active {
            transform: scale(0.95);
        }

        /* Dark theme */
        [data-theme="dark"] .back-to-results-btn {
            background: var(--md-sys-color-primary);
        }

        /* Mobile: Icon only, circular button */
        @media (max-width: 768px) {
            .back-to-results-container {
                right: 16px;
                bottom: 88px; /* Position above TOC button (16px + 52px + 20px gap) */
            }

            .back-to-results-btn {
                width: 52px;
                height: 52px;
                padding: 0;
                border-radius: 50%;
                justify-content: center;
            }

            .back-to-results-label {
                display: none;
            }

            /* Tooltip for mobile - appears on hover/touch */
            .back-to-results-btn::after {
                content: 'Back to Results';
                position: absolute;
                bottom: calc(100% + 10px);
                left: 50%;
                transform: translateX(-50%) translateY(5px);
                padding: 8px 14px;
                background: rgba(15, 26, 23, 0.95);
                color: #fff;
                font-size: 13px;
                font-weight: 500;
                border-radius: 8px;
                white-space: nowrap;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.2s ease, transform 0.2s ease;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            }

            .back-to-results-btn:hover::after {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }

            [data-theme="dark"] .back-to-results-btn::after {
                background: rgba(77, 184, 160, 0.95);
                color: #0F1A17;
            }
        }

        /* Adjust position for smaller screens */
        @media (min-width: 769px) and (max-width: 1200px) {
            .back-to-results-container {
                bottom: 16px;
                right: 24px;
            }
        }

        /* ================================================
           STRATEGY ANALYSIS - CONSOLIDATED SECTION
           Inspired by guardrails-prototype.html design
           ================================================ */

        .strategy-analysis-section {
            background: var(--surface-0);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.04);
            overflow: hidden;
            margin-bottom: 24px;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
        }

        .strategy-analysis-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0, 121, 107, 0.12);
            border-color: var(--md-sys-color-primary);
        }

        [data-theme="dark"] .strategy-analysis-section {
            background: linear-gradient(135deg, rgba(20,24,35,0.95) 0%, rgba(20,24,35,0.85) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: var(--shadow-md);
        }

        [data-theme="dark"] .strategy-analysis-section:hover {
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.4);
        }

        /* Header */
        .sa-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
            padding: 24px 28px;
            background: var(--surface-1);
            border-bottom: 1px solid var(--border-color);
        }

        [data-theme="dark"] .sa-header {
            background: var(--surface-2);
        }

        .sa-header-content {
            flex: 1;
        }

        .sa-title-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 4px;
        }

        .sa-title-icon {
            font-size: 28px;
            color: var(--primary);
        }

        .sa-title {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            letter-spacing: -0.02em;
        }

        .sa-subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin: 0;
        }

        .sa-disclaimer-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(255, 107, 107, 0.08);
            border: 1px solid rgba(255, 107, 107, 0.2);
            border-radius: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            max-width: 400px;
        }

        .sa-disclaimer-badge .material-icons {
            font-size: 18px;
            color: #FF6B6B;
            flex-shrink: 0;
        }

        /* Verdict Banner */
        .sa-verdict-banner {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 24px 28px;
            background: linear-gradient(135deg, rgba(22, 163, 74, 0.08) 0%, rgba(22, 163, 74, 0.02) 100%);
            border-bottom: 1px solid rgba(22, 163, 74, 0.15);
            position: relative;
        }

        .sa-verdict-banner::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
            background: linear-gradient(180deg, var(--success) 0%, #6BCB77 100%);
        }

        .sa-verdict-banner.favorable::before {
            background: linear-gradient(180deg, var(--success) 0%, #6BCB77 100%);
        }

        .sa-verdict-banner.moderate {
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.08) 0%, rgba(234, 179, 8, 0.02) 100%);
            border-bottom-color: rgba(234, 179, 8, 0.15);
        }

        .sa-verdict-banner.moderate::before {
            background: linear-gradient(180deg, var(--warning) 0%, #FBBF24 100%);
        }

        .sa-verdict-banner.consider-both {
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.08) 0%, rgba(234, 179, 8, 0.02) 100%);
            border-bottom-color: rgba(234, 179, 8, 0.15);
        }

        .sa-verdict-banner.consider-both::before {
            background: linear-gradient(180deg, #F59E0B 0%, #FBBF24 100%);
        }

        .sa-verdict-banner.unfavorable {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(59, 130, 246, 0.02) 100%);
            border-bottom-color: rgba(59, 130, 246, 0.15);
        }

        .sa-verdict-banner.unfavorable::before {
            background: linear-gradient(180deg, #3B82F6 0%, #60A5FA 100%);
        }

        .sa-verdict-icon-container {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            background: var(--success);
            color: white;
            box-shadow: 0 4px 12px rgba(22, 163, 74, 0.25);
        }

        .sa-verdict-icon-container .material-icons {
            font-size: 32px;
            font-weight: 700;
        }

        .sa-verdict-banner.moderate .sa-verdict-icon-container,
        .sa-verdict-banner.consider-both .sa-verdict-icon-container {
            background: var(--warning);
            box-shadow: 0 4px 12px rgba(234, 179, 8, 0.25);
        }

        .sa-verdict-banner.unfavorable .sa-verdict-icon-container {
            background: #3B82F6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
        }

        .sa-verdict-content {
            flex: 1;
        }

        .sa-verdict-headline {
            font-family: var(--font-display);
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 4px 0;
        }

        .sa-verdict-rationale {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin: 0;
            line-height: 1.5;
        }

        /* Success Dial */
        .sa-success-dial {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .sa-dial-ring {
            position: relative;
            width: 64px;
            height: 64px;
        }

        .sa-dial-ring svg {
            transform: rotate(-90deg);
        }

        .sa-dial-bg {
            stroke: rgba(0, 0, 0, 0.08);
        }

        [data-theme="dark"] .sa-dial-bg {
            stroke: rgba(255, 255, 255, 0.1);
        }

        .sa-dial-progress {
            stroke: var(--success);
            stroke-linecap: round;
            transition: stroke-dashoffset 1s ease-out, stroke 0.3s ease;
        }

        .sa-verdict-banner.favorable .sa-dial-progress {
            stroke: var(--success);
        }

        .sa-verdict-banner.moderate .sa-dial-progress,
        .sa-verdict-banner.consider-both .sa-dial-progress {
            stroke: var(--warning);
        }

        .sa-verdict-banner.unfavorable .sa-dial-progress {
            stroke: #3B82F6;
        }

        .sa-dial-value {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .sa-dial-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Side-by-Side Comparison Grid */
        .sa-comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 24px 28px;
        }

        @media (max-width: 768px) {
            .sa-comparison-grid {
                grid-template-columns: 1fr;
            }
        }

        .sa-strategy-card {
            background: var(--surface-0);
            border-radius: 12px;
            border: 2px solid var(--border-color);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        [data-theme="dark"] .sa-strategy-card {
            background: var(--surface-2);
        }

        .sa-strategy-card:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        }

        .sa-strategy-card.sa-bbd {
            border-color: var(--success);
        }

        .sa-strategy-card.sa-sell {
            border-color: var(--primary);
        }

        .sa-strategy-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 16px 20px;
            font-weight: 600;
            font-size: 1rem;
        }

        .sa-bbd .sa-strategy-header {
            background: rgba(22, 163, 74, 0.08);
            color: var(--success);
        }

        .sa-sell .sa-strategy-header {
            background: rgba(0, 121, 107, 0.08);
            color: var(--primary);
        }

        .sa-strategy-header .material-icons {
            font-size: 22px;
        }

        .sa-strategy-metrics {
            padding: 16px 20px;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .sa-metric {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .sa-metric-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .sa-metric-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
        }

        .sa-metric-value.sa-cost {
            color: var(--warning);
        }

        .sa-metric-value.sa-risk {
            color: var(--error);
        }

        .sa-metric-value.sa-success {
            color: var(--success);
        }

        .sa-metric-subtext {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Wealth Differential */
        .sa-differential {
            padding: 0 28px 24px;
        }

        .sa-section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin: 0 0 16px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .sa-section-title .material-icons {
            font-size: 20px;
            color: var(--primary);
        }

        .sa-differential-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        @media (max-width: 600px) {
            .sa-differential-grid {
                grid-template-columns: 1fr;
            }
        }

        .sa-diff-card {
            background: var(--surface-1);
            border-radius: 10px;
            padding: 16px 20px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        [data-theme="dark"] .sa-diff-card {
            background: var(--surface-2);
        }

        .sa-diff-label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .sa-diff-value {
            display: block;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--success);
            font-variant-numeric: tabular-nums;
        }

        /* Explanation Section */
        .sa-explanation {
            padding: 0 28px 24px;
        }

        .sa-insight-quote {
            font-size: 1.1rem;
            font-style: italic;
            color: var(--text-primary);
            line-height: 1.6;
            padding: 16px 20px;
            background: linear-gradient(135deg, rgba(0, 121, 107, 0.06) 0%, rgba(0, 121, 107, 0.02) 100%);
            border-left: 4px solid var(--primary);
            border-radius: 0 10px 10px 0;
            margin-bottom: 16px;
        }

        .sa-insight-text {
            font-size: 0.95rem;
            color: var(--text-secondary);
            line-height: 1.7;
            margin-bottom: 20px;
        }

        .sa-benefits-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        @media (max-width: 700px) {
            .sa-benefits-grid {
                grid-template-columns: 1fr;
            }
        }

        .sa-benefit-card {
            display: flex;
            gap: 16px;
            background: var(--surface-0);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s ease;
        }

        [data-theme="dark"] .sa-benefit-card {
            background: var(--surface-2);
        }

        .sa-benefit-card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        }

        .sa-benefit-icon {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .sa-benefit-icon.teal {
            background: rgba(0, 121, 107, 0.12);
            color: var(--primary);
        }

        .sa-benefit-icon.purple {
            background: rgba(108, 99, 255, 0.12);
            color: #6C63FF;
        }

        .sa-benefit-icon .material-icons {
            font-size: 24px;
        }

        .sa-benefit-content {
            flex: 1;
        }

        .sa-benefit-title {
            display: block;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .sa-benefit-value {
            display: block;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
            font-variant-numeric: tabular-nums;
        }

        .sa-benefit-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.6;
            margin: 0;
        }

        /* Charts Section */
        .sa-charts-section {
            padding: 0 28px 24px;
        }

        .sa-charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }

        @media (max-width: 900px) {
            .sa-charts-grid {
                grid-template-columns: 1fr;
            }
        }

        .sa-chart-card {
            background: var(--surface-0);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            box-shadow: 0 1px 3px rgba(0, 121, 107, 0.05);
        }

        .sa-chart-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 121, 107, 0.15);
            border-color: var(--primary, #00796B);
        }

        [data-theme="dark"] .sa-chart-card {
            background: var(--surface-2);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] .sa-chart-card:hover {
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            border-color: var(--primary, #00BFA5);
        }

        .sa-chart-card.sa-chart-full {
            margin-bottom: 0;
        }

        .sa-chart-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 16px 0;
        }

        .sa-chart-container {
            height: 320px;
            position: relative;
        }

        .sa-chart-full .sa-chart-container {
            height: 280px;
        }

        /* Considerations Section */
        .sa-considerations {
            padding: 0 28px 24px;
        }

        .sa-considerations-container {
            background: var(--surface-0);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        [data-theme="dark"] .sa-considerations-container {
            background: var(--surface-2);
        }

        .sa-considerations-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 20px;
            background: var(--surface-1);
            border-bottom: 1px solid var(--border-color);
        }

        [data-theme="dark"] .sa-considerations-header {
            background: var(--surface-3);
        }

        .sa-considerations-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .sa-considerations-title .material-icons {
            color: var(--primary);
            font-size: 20px;
        }

        .sa-considerations-count {
            background: var(--primary);
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 50px;
        }

        .sa-considerations-list {
            display: flex;
            flex-direction: column;
        }

        .sa-consideration-item {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s ease;
        }

        .sa-consideration-item:last-child {
            border-bottom: none;
        }

        .sa-consideration-item:hover {
            background: var(--surface-1);
        }

        .sa-consideration-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .sa-consideration-icon.warning {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        .sa-consideration-icon.caution {
            background: rgba(234, 179, 8, 0.1);
            color: var(--warning);
        }

        .sa-consideration-icon.info {
            background: rgba(14, 165, 233, 0.1);
            color: #0EA5E9;
        }

        .sa-consideration-icon.action {
            background: rgba(22, 163, 74, 0.1);
            color: var(--success);
        }

        .sa-consideration-icon .material-icons {
            font-size: 22px;
        }

        .sa-consideration-content {
            flex: 1;
        }

        .sa-consideration-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .sa-consideration-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .sa-consideration-label {
            font-weight: 600;
            margin-right: 4px;
        }

        .sa-consideration-label.warning {
            color: var(--error);
        }

        .sa-consideration-label.note {
            color: #0EA5E9;
        }

        .sa-consideration-label.action {
            color: var(--success);
        }

        /* Alternative Approaches */
        .sa-alternatives {
            padding: 0 28px 24px;
        }

        .sa-alternatives-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        @media (max-width: 800px) {
            .sa-alternatives-grid {
                grid-template-columns: 1fr;
            }
        }

        .sa-alternative-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 24px 20px;
            background: var(--surface-0);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        [data-theme="dark"] .sa-alternative-card {
            background: var(--surface-2);
        }

        .sa-alternative-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        }

        .sa-alternative-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .sa-alternative-title {
            display: block;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .sa-alternative-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Next Steps */
        .sa-next-steps {
            padding: 0 28px 28px;
        }

        .sa-next-steps-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        @media (max-width: 900px) {
            .sa-next-steps-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 500px) {
            .sa-next-steps-grid {
                grid-template-columns: 1fr;
            }
        }

        .sa-next-step-card {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 24px 20px;
            background: var(--surface-0);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0, 121, 107, 0.07);
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            cursor: pointer;
            overflow: hidden;
        }

        /* Gradient top bar - default (success/low-risk) */
        .sa-next-step-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #10B981 0%, #6BCB77 100%);
        }

        [data-theme="dark"] .sa-next-step-card {
            background: var(--surface-2);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
        }

        .sa-next-step-card:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 121, 107, 0.15);
        }

        [data-theme="dark"] .sa-next-step-card:hover {
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
        }

        /* Warning state - moderate risk (amber/orange) */
        .sa-next-step-card.warning::before {
            background: linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%);
        }

        .sa-next-step-card.warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.04) 0%, rgba(245, 158, 11, 0.02) 100%);
        }

        [data-theme="dark"] .sa-next-step-card.warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.08) 0%, rgba(245, 158, 11, 0.04) 100%);
        }

        /* Critical state - high risk (red) */
        .sa-next-step-card.critical::before {
            background: linear-gradient(135deg, #EF4444 0%, #F87171 100%);
        }

        .sa-next-step-card.critical {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.04) 0%, rgba(239, 68, 68, 0.02) 100%);
        }

        [data-theme="dark"] .sa-next-step-card.critical {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.08) 0%, rgba(239, 68, 68, 0.04) 100%);
        }

        .sa-next-step-icon {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
        }

        /* Material Icons styling */
        .sa-next-step-icon .material-icons {
            font-size: 28px;
        }

        /* Icon backgrounds - default (success/low-risk) */
        .sa-next-step-card .sa-next-step-icon {
            background: rgba(16, 185, 129, 0.15);
            color: #10B981;
        }

        /* Icon backgrounds for warning states */
        .sa-next-step-card.warning .sa-next-step-icon {
            background: rgba(245, 158, 11, 0.15);
            color: #F59E0B;
        }

        .sa-next-step-card.critical .sa-next-step-icon {
            background: rgba(239, 68, 68, 0.15);
            color: #EF4444;
        }

        [data-theme="dark"] .sa-next-step-card .sa-next-step-icon {
            background: rgba(16, 185, 129, 0.2);
            color: #6BCB77;
        }

        [data-theme="dark"] .sa-next-step-card.warning .sa-next-step-icon {
            background: rgba(245, 158, 11, 0.2);
            color: #FBBF24;
        }

        [data-theme="dark"] .sa-next-step-card.critical .sa-next-step-icon {
            background: rgba(239, 68, 68, 0.2);
            color: #F87171;
        }

        .sa-next-step-title {
            display: block;
            font-family: 'Plus Jakarta Sans', 'Inter', system-ui, sans-serif;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 1rem;
            letter-spacing: -0.01em;
        }

        .sa-next-step-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Mobile Responsive Adjustments */
        @media (max-width: 768px) {
            .sa-header {
                flex-direction: column;
                padding: 20px;
            }

            .sa-disclaimer-badge {
                max-width: 100%;
            }

            .sa-verdict-banner {
                flex-direction: column;
                text-align: center;
                padding: 20px;
            }

            .sa-verdict-banner::before {
                width: 100%;
                height: 4px;
                top: 0;
                left: 0;
                right: 0;
                bottom: auto;
            }

            .sa-comparison-grid,
            .sa-differential,
            .sa-explanation,
            .sa-charts-section,
            .sa-considerations,
            .sa-alternatives,
            .sa-next-steps {
                padding-left: 20px;
                padding-right: 20px;
            }
        }

        /* ================================================
           STRATEGIC RECOMMENDATION - ENHANCED DESIGN
           ================================================ */

        .strategic-recommendation {
            background: var(--surface-2);
            border-radius: 12px;
            padding: 0;
            border: none;
            overflow: hidden;
        }

        /* Status Banner - Hero Section */
        .sr-status-banner {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 24px 28px;
            background: linear-gradient(135deg, rgba(0, 121, 107, 0.08) 0%, rgba(0, 121, 107, 0.02) 100%);
            border-bottom: 1px solid rgba(0, 121, 107, 0.15);
        }

        .sr-status-banner.favorable {
            background: linear-gradient(135deg, rgba(22, 163, 74, 0.08) 0%, rgba(22, 163, 74, 0.02) 100%);
            border-bottom-color: rgba(22, 163, 74, 0.15);
        }

        .sr-status-banner.moderate {
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.08) 0%, rgba(234, 179, 8, 0.02) 100%);
            border-bottom-color: rgba(234, 179, 8, 0.15);
        }

        .sr-status-banner.unfavorable {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.08) 0%, rgba(239, 68, 68, 0.02) 100%);
            border-bottom-color: rgba(239, 68, 68, 0.15);
        }

        .sr-status-icon {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            flex-shrink: 0;
            background: var(--success);
            color: white;
            box-shadow: 0 4px 12px rgba(22, 163, 74, 0.25);
        }

        .sr-status-icon.moderate {
            background: var(--warning);
            box-shadow: 0 4px 12px rgba(234, 179, 8, 0.25);
        }

        .sr-status-icon.unfavorable {
            background: var(--error);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.25);
        }

        .sr-status-content {
            flex: 1;
        }

        .sr-status-headline {
            font-size: 1.25em;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 4px 0;
        }

        .sr-status-subtext {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin: 0;
        }

        .sr-success-dial {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .sr-dial-ring {
            position: relative;
            width: 64px;
            height: 64px;
        }

        .sr-dial-ring svg {
            transform: rotate(-90deg);
        }

        .sr-dial-ring .bg-ring {
            stroke: rgba(0, 0, 0, 0.08);
        }

        .sr-dial-ring .progress-ring {
            stroke: var(--success);
            stroke-linecap: round;
            transition: stroke-dashoffset 1s ease-out;
        }

        .sr-dial-value {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .sr-dial-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Disclaimer Treatment */
        .sr-disclaimer {
            display: flex;
            gap: 12px;
            padding: 14px 20px;
            background: #FFFBF5;
            border-left: 4px solid #FF6B6B;
            margin: 20px 28px;
            border-radius: 0 8px 8px 0;
        }

        [data-theme="dark"] .sr-disclaimer {
            background: rgba(255, 107, 107, 0.08);
        }

        .sr-disclaimer-icon {
            flex-shrink: 0;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #FF6B6B;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
        }

        .sr-disclaimer-text {
            font-size: 0.85em;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .sr-disclaimer-tag {
            display: inline-block;
            padding: 2px 8px;
            background: rgba(255, 107, 107, 0.15);
            color: #D4574E;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-right: 6px;
        }

        /* Content Container */
        .sr-content {
            padding: 0 28px 28px;
        }

        /* Hero Metrics Grid */
        .sr-metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 28px;
        }

        @media (max-width: 900px) {
            .sr-metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 500px) {
            .sr-metrics-grid {
                grid-template-columns: 1fr;
            }
        }

        .sr-metric-card {
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.06);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        [data-theme="dark"] .sr-metric-card {
            background: var(--surface-1);
            border-color: rgba(255, 255, 255, 0.08);
        }

        .sr-metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            border-color: var(--primary);
        }

        .sr-metric-card.highlight {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(0, 121, 107, 0.03) 0%, white 100%);
        }

        [data-theme="dark"] .sr-metric-card.highlight {
            background: linear-gradient(135deg, rgba(0, 121, 107, 0.1) 0%, var(--surface-1) 100%);
        }

        .sr-metric-icon {
            font-size: 28px;
            margin-bottom: 8px;
            display: block;
        }

        .sr-metric-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .sr-metric-value {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
            line-height: 1.2;
        }

        .sr-metric-value.positive {
            color: var(--success);
        }

        .sr-metric-value.negative {
            color: var(--error);
        }

        .sr-metric-delta {
            font-size: 12px;
            color: var(--success);
            margin-top: 4px;
        }

        .sr-metric-delta.negative {
            color: var(--error);
        }

        /* Section Headers */
        .sr-section-header {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 32px 0 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid rgba(0, 0, 0, 0.06);
        }

        [data-theme="dark"] .sr-section-header {
            border-bottom-color: rgba(255, 255, 255, 0.08);
        }

        /* Insight Card */
        .sr-insight-card {
            background: linear-gradient(135deg, rgba(0, 121, 107, 0.06) 0%, rgba(0, 121, 107, 0.02) 100%);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid rgba(0, 121, 107, 0.12);
        }

        [data-theme="dark"] .sr-insight-card {
            background: linear-gradient(135deg, rgba(0, 121, 107, 0.12) 0%, rgba(0, 121, 107, 0.04) 100%);
        }

        .sr-insight-quote {
            font-size: 1.1em;
            font-style: italic;
            color: var(--text-primary);
            line-height: 1.6;
            padding-left: 20px;
            border-left: 4px solid var(--primary);
            margin-bottom: 16px;
        }

        .sr-insight-text {
            font-size: 0.95em;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        /* Benefit Cards - Side by Side */
        .sr-benefits-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        @media (max-width: 700px) {
            .sr-benefits-grid {
                grid-template-columns: 1fr;
            }
        }

        .sr-benefit-card {
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.06);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s ease;
        }

        [data-theme="dark"] .sr-benefit-card {
            background: var(--surface-1);
            border-color: rgba(255, 255, 255, 0.08);
        }

        .sr-benefit-card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        }

        .sr-benefit-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .sr-benefit-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .sr-benefit-icon.teal {
            background: rgba(0, 121, 107, 0.12);
        }

        .sr-benefit-icon.purple {
            background: rgba(108, 99, 255, 0.12);
        }

        .sr-benefit-title {
            font-size: 1em;
            font-weight: 600;
            color: var(--text-primary);
        }

        .sr-benefit-value {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
            font-variant-numeric: tabular-nums;
        }

        .sr-benefit-text {
            font-size: 0.9em;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .sr-benefit-note {
            font-size: 0.85em;
            color: var(--text-secondary);
            font-style: italic;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(0, 0, 0, 0.06);
            line-height: 1.6;
        }

        [data-theme="dark"] .sr-benefit-note {
            border-top-color: rgba(255, 255, 255, 0.08);
        }

        /* Actionable Insights Container (Recommendations-style) */
        .sr-insights-container {
            background: var(--surface-0);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.04);
            overflow: hidden;
            margin-bottom: 24px;
        }

        [data-theme="dark"] .sr-insights-container {
            background: var(--surface-1);
            border-color: rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .sr-insights-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: var(--surface-1);
            border-bottom: 1px solid var(--border-color);
        }

        [data-theme="dark"] .sr-insights-header {
            background: var(--surface-2);
            border-bottom-color: rgba(255, 255, 255, 0.08);
        }

        .sr-insights-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: var(--font-display);
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-primary);
        }

        .sr-insights-title .material-icons {
            color: var(--primary);
            font-size: 20px;
        }

        .sr-insights-count {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            height: 24px;
            padding: 0 8px;
            background: var(--primary);
            color: white;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        /* Risk Factor Cards - Recommendation Style */
        .sr-risks-list {
            display: flex;
            flex-direction: column;
        }

        .sr-risk-card {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 18px 20px;
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s ease;
        }

        .sr-risk-card:last-child {
            border-bottom: none;
        }

        [data-theme="dark"] .sr-risk-card {
            border-bottom-color: rgba(255, 255, 255, 0.06);
        }

        .sr-risk-card:hover {
            background: var(--surface-1);
        }

        [data-theme="dark"] .sr-risk-card:hover {
            background: var(--surface-2);
        }

        /* Remove old border-left styling */
        .sr-risk-card.high,
        .sr-risk-card.medium,
        .sr-risk-card.low {
            border-left: none;
        }

        /* Icon Squares (replacing dots) */
        .sr-risk-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            flex-shrink: 0;
        }

        .sr-risk-icon .material-icons {
            font-size: 20px;
        }

        .sr-risk-icon.high {
            background: rgba(239, 68, 68, 0.12);
            color: #EF4444;
        }

        .sr-risk-icon.medium {
            background: rgba(234, 179, 8, 0.12);
            color: #D97706;
        }

        .sr-risk-icon.low {
            background: rgba(14, 165, 233, 0.12);
            color: #0EA5E9;
        }

        .sr-risk-icon.success {
            background: rgba(16, 185, 129, 0.12);
            color: #10B981;
        }

        [data-theme="dark"] .sr-risk-icon.high {
            background: rgba(239, 68, 68, 0.2);
        }

        [data-theme="dark"] .sr-risk-icon.medium {
            background: rgba(234, 179, 8, 0.2);
        }

        [data-theme="dark"] .sr-risk-icon.low {
            background: rgba(14, 165, 233, 0.2);
        }

        [data-theme="dark"] .sr-risk-icon.success {
            background: rgba(16, 185, 129, 0.2);
        }

        /* Hide old severity dots */
        .sr-risk-severity {
            display: none;
        }

        .sr-risk-content {
            flex: 1;
        }

        .sr-risk-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            line-height: 1.4;
        }

        .sr-risk-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Colored label prefixes */
        .sr-risk-label {
            font-weight: 600;
        }

        .sr-risk-label.warning {
            color: #D97706;
        }

        .sr-risk-label.note {
            color: #0EA5E9;
        }

        .sr-risk-label.action {
            color: var(--primary);
        }

        .sr-risk-label.insight {
            color: #10B981;
        }

        /* Alternative Approaches Cards */
        .sr-alternatives-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        @media (max-width: 800px) {
            .sr-alternatives-grid {
                grid-template-columns: 1fr;
            }
        }

        .sr-alternative-card {
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.06);
            border-radius: 10px;
            padding: 16px;
            text-align: center;
            transition: all 0.2s ease;
            cursor: default;
        }

        [data-theme="dark"] .sr-alternative-card {
            background: var(--surface-1);
            border-color: rgba(255, 255, 255, 0.08);
        }

        .sr-alternative-card:hover {
            border-color: #6C63FF;
            box-shadow: 0 4px 12px rgba(108, 99, 255, 0.1);
        }

        .sr-alternative-icon {
            font-size: 24px;
            margin-bottom: 8px;
            display: block;
        }

        .sr-alternative-title {
            font-size: 0.9em;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .sr-alternative-text {
            font-size: 0.8em;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* ================================================
           EXECUTIVE SUMMARY - ENHANCED DESIGN
           ================================================ */

        .executive-summary-enhanced {
            background: var(--surface-2);
            border-radius: 12px;
            padding: 0;
            border: none;
            overflow: hidden;
        }

        /* Portfolio Chips */
        .es-portfolio-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .es-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        [data-theme="dark"] .es-chip {
            background: var(--surface-1);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .es-chip:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(0, 121, 107, 0.15);
        }

        .es-chip-icon {
            font-size: 14px;
        }

        /* Strategy Overview Card */
        .es-overview-card {
            background: linear-gradient(135deg, rgba(0, 121, 107, 0.04) 0%, rgba(0, 121, 107, 0.01) 100%);
            border: 1px solid rgba(0, 121, 107, 0.1);
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 24px;
        }

        [data-theme="dark"] .es-overview-card {
            background: linear-gradient(135deg, rgba(0, 121, 107, 0.1) 0%, rgba(0, 121, 107, 0.03) 100%);
        }

        .es-overview-text {
            font-size: 0.95em;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        .es-overview-text strong {
            color: var(--text-primary);
        }

        /* Consideration Cards - Two Column Layout */
        .es-considerations-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        @media (max-width: 700px) {
            .es-considerations-grid {
                grid-template-columns: 1fr;
            }
        }

        .es-consideration-card {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 14px 16px;
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.06);
            border-radius: 10px;
            transition: all 0.2s ease;
        }

        [data-theme="dark"] .es-consideration-card {
            background: var(--surface-1);
            border-color: rgba(255, 255, 255, 0.08);
        }

        .es-consideration-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .es-consideration-card.benefit {
            border-left: 3px solid var(--success);
        }

        .es-consideration-card.risk {
            border-left: 3px solid var(--warning);
        }

        .es-consideration-card.neutral {
            border-left: 3px solid #9CA3AF;
        }

        .es-consideration-icon {
            flex-shrink: 0;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .es-consideration-icon.benefit {
            background: rgba(22, 163, 74, 0.1);
        }

        .es-consideration-icon.risk {
            background: rgba(234, 179, 8, 0.1);
        }

        .es-consideration-icon.neutral {
            background: rgba(156, 163, 175, 0.1);
        }

        .es-consideration-content {
            flex: 1;
            min-width: 0;
        }

        .es-consideration-title {
            font-size: 0.9em;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .es-consideration-text {
            font-size: 0.8em;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Next Steps - Action Cards */
        .es-next-steps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .es-next-step-card {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 20px 16px;
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.06);
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0, 121, 107, 0.07);
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            cursor: pointer;
            overflow: hidden;
        }

        /* Gradient top bar - default (success/low-risk) */
        .es-next-step-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #10B981 0%, #6BCB77 100%);
        }

        [data-theme="dark"] .es-next-step-card {
            background: var(--surface-1);
            border-color: rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
        }

        .es-next-step-card:hover {
            border-color: var(--primary);
            box-shadow: 0 20px 40px rgba(0, 121, 107, 0.15);
            transform: translateY(-4px);
        }

        [data-theme="dark"] .es-next-step-card:hover {
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
        }

        /* Warning state - moderate risk (amber/orange) */
        .es-next-step-card.warning::before {
            background: linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%);
        }

        .es-next-step-card.warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.04) 0%, rgba(245, 158, 11, 0.02) 100%);
        }

        [data-theme="dark"] .es-next-step-card.warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.08) 0%, rgba(245, 158, 11, 0.04) 100%);
        }

        /* Critical state - high risk (red) */
        .es-next-step-card.critical::before {
            background: linear-gradient(135deg, #EF4444 0%, #F87171 100%);
        }

        .es-next-step-card.critical {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.04) 0%, rgba(239, 68, 68, 0.02) 100%);
        }

        [data-theme="dark"] .es-next-step-card.critical {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.08) 0%, rgba(239, 68, 68, 0.04) 100%);
        }

        .es-next-step-icon {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
        }

        /* Material Icons styling */
        .es-next-step-icon .material-icons {
            font-size: 28px;
        }

        /* Icon backgrounds - default (success/low-risk) */
        .es-next-step-card .es-next-step-icon {
            background: rgba(16, 185, 129, 0.15);
            color: #10B981;
        }

        /* Icon backgrounds for warning states */
        .es-next-step-card.warning .es-next-step-icon {
            background: rgba(245, 158, 11, 0.15);
            color: #F59E0B;
        }

        .es-next-step-card.critical .es-next-step-icon {
            background: rgba(239, 68, 68, 0.15);
            color: #EF4444;
        }

        [data-theme="dark"] .es-next-step-card .es-next-step-icon {
            background: rgba(16, 185, 129, 0.2);
            color: #6BCB77;
        }

        [data-theme="dark"] .es-next-step-card.warning .es-next-step-icon {
            background: rgba(245, 158, 11, 0.2);
            color: #FBBF24;
        }

        [data-theme="dark"] .es-next-step-card.critical .es-next-step-icon {
            background: rgba(239, 68, 68, 0.2);
            color: #F87171;
        }

        .es-next-step-title {
            font-family: 'Plus Jakarta Sans', 'Inter', system-ui, sans-serif;
            font-size: 0.9em;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 6px;
            letter-spacing: -0.01em;
        }

        .es-next-step-text {
            font-size: 0.75em;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Simulation Stats Bar */
        .es-sim-stats {
            display: flex;
            justify-content: center;
            gap: 24px;
            padding: 12px 20px;
            background: rgba(0, 0, 0, 0.02);
            border-radius: 8px;
            margin-bottom: 20px;
        }

        [data-theme="dark"] .es-sim-stats {
            background: rgba(255, 255, 255, 0.03);
        }

        .es-sim-stat {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .es-sim-stat-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Hero Summary Banner - Consolidated */
        .es-hero-summary {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            padding: 24px 28px;
            margin-bottom: 24px;
            background: linear-gradient(135deg, rgba(0, 121, 107, 0.08) 0%, rgba(0, 121, 107, 0.02) 100%);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .es-hero-summary.moderate {
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.08) 0%, rgba(234, 179, 8, 0.02) 100%);
            border-bottom-color: rgba(234, 179, 8, 0.15);
        }

        .es-hero-summary.unfavorable {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.08) 0%, rgba(239, 68, 68, 0.02) 100%);
            border-bottom-color: rgba(239, 68, 68, 0.15);
        }

        .es-hero-checkmark {
            flex-shrink: 0;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #00796B;
            border: none;
        }

        .es-hero-checkmark svg {
            width: 24px;
            height: 24px;
            stroke: white;
            stroke-width: 3;
            fill: none;
        }

        .es-hero-checkmark.moderate {
            background: #B45309;
        }

        .es-hero-checkmark.unfavorable {
            background: #DC2626;
        }

        .es-hero-content {
            flex: 1;
            min-width: 0;
        }

        .es-hero-badge {
            display: inline-block;
            padding: 0;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            background: none;
            color: #000;
        }

        .es-hero-badge.moderate {
            color: #000;
        }

        .es-hero-badge.unfavorable {
            color: #000;
        }

        .es-hero-text {
            font-size: 1.05em;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .es-hero-text strong {
            color: var(--primary);
            font-weight: 700;
        }

        .es-hero-summary.moderate .es-hero-text strong {
            color: #B45309;
        }

        .es-hero-summary.unfavorable .es-hero-text strong {
            color: var(--error);
        }

        .es-hero-subtext {
            margin-top: 8px;
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .es-hero-dial {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        @media (max-width: 600px) {
            .es-hero-summary {
                flex-wrap: wrap;
            }
            .es-hero-dial {
                width: 100%;
                margin-top: 12px;
                flex-direction: row;
                justify-content: center;
                gap: 12px;
            }
        }

    </style>
</head>
<body>
    <!-- Top Header -->
    <div class="top-header">
        <h1>
            <span class="material-icons" class="text-4xl"></span>
        Portfolio Strategy Simulator
        </h1>
        <div class="subtitle">Tax-Efficient Retirement Planning with BBD Strategy & Monte Carlo Analysis</div>
        <div class="theme-toggle-wrapper">
            <button class="theme-toggle" id="settingsButton" onclick="showSettings()" title="Data Source Settings">
                <span class="material-icons">settings</span>
            </button>
            <button class="theme-toggle" onclick="showWelcomeGuide()" title="Show help guide">
                <span class="material-icons">help_outline</span>
            </button>
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
                <span class="material-icons" id="theme-icon">light_mode</span>
            </button>
        </div>
    </div>

    <div class="app-body">
        <!-- Left Panel -->
        <div class="left-panel">
            <div class="panel-header">
                <span class="material-icons"></span>
                <h2>Strategy Parameters</h2>
                <button class="mobile-collapse-toggle" id="mobileCollapseToggle" onclick="toggleMobilePanel()" aria-label="Toggle parameters panel" aria-expanded="true">
                    <span class="material-icons">expand_less</span>
                </button>
                <button class="desktop-collapse-toggle" id="desktopCollapseToggle" onclick="toggleDesktopPanel()" aria-label="Toggle parameters panel" aria-expanded="true">
                    <span class="material-icons">chevron_left</span>
                </button>
            </div>

            <div class="panel-content">
                <!-- Simulation Mode Toggle -->
                <div class="simulation-mode-toggle">
                    <button type="button" class="mode-button active" id="monteCarloModeBtn" onclick="switchSimulationMode('montecarlo')">
                        <span class="material-icons">scatter_plot</span>
                        <span>Monte Carlo</span>
                    </button>
                    <button type="button" class="mode-button" id="singleAssetModeBtn" onclick="switchSimulationMode('single')">
                        <span class="material-icons">trending_up</span>
                        <span>Single Asset</span>
                    </button>
                </div>

                <form id="simulatorForm">
                <!-- Monte Carlo Mode Content -->
                <div id="monteCarloContent" class="monte-carlo-content active">

                    <!-- Simulation Parameters -->
                    <div class="input-group">
                        <label for="numSimulations">Number of Simulations:</label>
                        <select id="numSimulations">
                            <option value="1000">1,000 (Fast)</option>
                            <option value="5000">5,000 (Recommended)</option>
                            <option value="10000" selected>10,000 (Precise)</option>
                            <option value="50000">50,000 (Precise+)</option>
                            <option value="100000">100,000 (Precise++)</option>
                        </select>
                        <div class="helper-text">More simulations = more accurate probability estimates</div>
                    </div>

                    <!-- Inflation Parameter -->
                    <div class="input-group">
                        <label for="inflationRate">Expected Annual Inflation (%):</label>
                        <input type="number" id="inflationRate" step="0.1" min="0" max="20" value="2.5">
                        <div class="helper-text">Used to calculate real (inflation-adjusted) returns and portfolio values</div>
                    </div>

                    <div class="input-group">
                        <label>Portfolio Composition:</label>
                        <div class="helper-text">Build a custom portfolio or load a preset configuration.</div>

                        <!-- Available Assets Listbox -->
                        <div class="asset-listbox-section">
                            <label style="font-size: 14px; font-weight: 500; margin-bottom: 4px; display: block;">
                                Available Assets:
                            </label>
                            <div class="helper-text" style="margin-bottom: 8px; margin-top: 0;">
                                Click the + icon or double-click an asset to add it to your portfolio
                            </div>
                            <div id="monteCarloAssetListbox" class="asset-listbox">
                                <!-- Assets populated dynamically -->
                            </div>
                        </div>
                    <!-- Portfolio Presets Section -->
                    <div class="input-group" id="portfolioPresetsSection" class="hidden">
                        <label>
                            Select a Portfolio Preset:
                        </label>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <select id="portfolioPresetSelector" class="preset-selector" style="flex: 1;">
                                <option value="">-- Presets --</option>
                            </select>
                            <button type="button" class="preset-action-btn" onclick="saveCurrentPortfolio()" title="Save current portfolio">
                                <span class="material-icons">save</span>
                            </button>
                            <button type="button" class="preset-action-btn" onclick="loadSelectedPortfolio()" title="Load selected portfolio">
                                <span class="material-icons">folder_open</span>
                            </button>
                            <button type="button" class="preset-action-btn" onclick="document.getElementById('tickerFileInput').click()" title="Import portfolio from ticker file">
                                <span class="material-icons">upload_file</span>
                            </button>
                            <button type="button" class="preset-action-btn delete-btn" onclick="deleteSelectedPortfolio()" title="Delete selected portfolio">
                                <span class="material-icons">delete</span>
                            </button>
                        </div>
                        <input type="file" id="tickerFileInput" accept=".txt" class="hidden" onchange="loadTickerFile(event)">
                        <div class="helper-text" class="text-sm mt-4">
                            <span class="material-icons" style="font-size: 14px; vertical-align: middle; color: var(--md-sys-color-primary);">save</span> Save,
                            <span class="material-icons" style="font-size: 14px; vertical-align: middle; color: var(--md-sys-color-primary);">folder_open</span> Load,
                            <span class="material-icons" style="font-size: 14px; vertical-align: middle; color: var(--md-sys-color-primary);">upload_file</span> Import from file, or
                            <span class="material-icons" style="font-size: 14px; vertical-align: middle; color: var(--md-sys-color-error);">delete</span> Delete portfolio configurations
                        </div>
                    </div>

                        <!-- Selected Assets List -->
                        <div id="selectedAssetsList" class="asset-selector-grid">
                            <!-- Assets will be added here dynamically -->
                        </div>

                        <!-- Weight Distribution Visualization -->
                        <div id="weightDistribution" class="mt-16">
                            <label style="margin-bottom: 4px;">Weight Distribution:</label>
                            <div class="weight-distribution-bar" id="weightDistributionBar">
                                <div class="flex-center-justify" class="w-full-text-sm-on-surface-variant">
                                    No assets selected
                                </div>
                            </div>
                            <div style="margin-top: 8px;">
                                <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 6px;">
                                    <button type="button" class="button button-secondary button-portfolio-control" onclick="balanceWeights()">
                                        Balance Weights
                                    </button>
                                    <button type="button" id="clearAllAssetsBtn" class="button button-clear-all button-portfolio-control" onclick="clearAllAssets()" style="display: none;">
                                        <span class="material-icons" style="font-size: 16px; margin-right: 4px;">delete_sweep</span>
                                        Clear All
                                    </button>
                                </div>
                                <div style="text-align: right;">
                                    <span id="totalWeightLabel" style="font-size: 14px; font-weight: 600; color: var(--md-sys-color-on-surface-variant);">
                                        Total: 0%
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Modal Dialogs -->
                    <!-- Confirm Modal -->
                    <div id="customConfirmModal" class="modal-overlay hidden">
                        <div class="modal-card">
                            <h3 class="modal-title" id="confirmModalTitle">Confirm</h3>
                            <p class="modal-message" id="confirmModalMessage"></p>
                            <div class="modal-actions">
                                <button type="button" class="modal-btn modal-btn-cancel" id="confirmModalCancel">Cancel</button>
                                <button type="button" class="modal-btn modal-btn-confirm" id="confirmModalOK">OK</button>
                            </div>
                        </div>
                    </div>

                    <!-- Prompt Modal -->
                    <div id="customPromptModal" class="modal-overlay hidden">
                        <div class="modal-card">
                            <h3 class="modal-title" id="promptModalTitle">Input Required</h3>
                            <p class="modal-message" id="promptModalMessage"></p>
                            <input type="text" class="modal-input" id="promptModalInput" />
                            <div class="modal-actions">
                                <button type="button" class="modal-btn modal-btn-cancel" id="promptModalCancel">Cancel</button>
                                <button type="button" class="modal-btn modal-btn-confirm" id="promptModalOK">OK</button>
                            </div>
                        </div>
                    </div>

                    <!-- Import Summary Modal -->
                    <div id="importSummaryModal" class="modal-overlay hidden">
                        <div class="modal-card" style="max-width: 700px; max-height: 80vh; display: flex; flex-direction: column;">
                            <h3 class="modal-title" id="importSummaryTitle">Portfolio Import Summary</h3>
                            <div id="importSummaryContent" style="flex: 1; overflow-y: auto; margin: 16px 0;">
                                <!-- Content will be dynamically populated -->
                            </div>
                            <div class="modal-actions">
                                <button type="button" class="modal-btn modal-btn-confirm" id="importSummaryClose">Close</button>
                            </div>
                        </div>
                    </div>

                    <!-- Correlation Matrix -->
                    <div class="input-group" id="correlationMatrixSection" class="hidden">
                        <label>Asset Correlation Matrix:</label>
                        <div class="helper-text">Shows how assets move together (green=correlated, red=inverse)</div>
                        <div style="overflow-x: auto;">
                            <table id="correlationMatrix" class="correlation-matrix"></table>
                        </div>
                    </div>

                    <!-- Advanced Return Modeling -->
                    <div class="input-group">
                        <label for="returnModel">Return Distribution Model:</label>
                        <select id="returnModel">
                            <option value="bootstrap" selected>Historical Bootstrap</option>
                            <option value="regime">Regime-Switching (Bull/Bear)</option>
                            <option value="fat-tail">Fat-Tailed Distribution</option>
                        </select>
                        <div class="helper-text">
                            <span class="info-tooltip-container">
                                How to model market returns and volatility
                                <span class="info-icon" tabindex="0" role="button" aria-label="Information about Regime-Switching model">i</span>
                                <div class="info-tooltip" role="tooltip">
                                    <div class="info-tooltip-title">Asset-Class-Aware Regime Modeling</div>
                                    <div class="info-tooltip-content">
                                        The <strong>Regime-Switching</strong> model now applies different parameters based on asset class during market regimes:
                                        <ul class="info-tooltip-list">
                                            <li><strong>Commodities (Gold, Silver):</strong> Positive bias (+5%) in bear markets (flight-to-safety)</li>
                                            <li><strong>Bonds:</strong> Positive bias (+3%) in bear markets (rate cuts, safe haven)</li>
                                            <li><strong>Equity Indices:</strong> Standard bear parameters (-15%)</li>
                                            <li><strong>Individual Stocks:</strong> Enhanced bear penalty (-18%, higher beta)</li>
                                        </ul>
                                        This preserves the <strong>diversification benefit</strong> of hedge assets during equity downturns.
                                    </div>
                                </div>
                            </span>
                        </div>
                    </div>

                    <!-- Regime Mode Toggle - Only visible when regime model selected -->
                    <div id="regimeModeToggle" class="regime-mode-toggle hidden">
                        <label class="input-label">
                            Regime Calibration
                            <span class="info-tooltip-container">
                                <span class="info-icon" tabindex="0" role="button" aria-label="Information about regime calibration modes">i</span>
                                <div class="info-tooltip" role="tooltip">
                                    <div class="info-tooltip-title">Regime Calibration Modes</div>
                                    <div class="info-tooltip-content">
                                        <ul class="info-tooltip-list">
                                        <li><strong>Historical Mode</strong> calibrates parameters to match S&P 500 performance (1950-2024), producing realistic baseline projections suitable for retirement planning.</li>
                                        <li><strong>Conservative Mode</strong> uses stress-testing parameters with extended crash durations, ideal for evaluating strategy resilience under adverse conditions.</li>
                                        </ul>
                                    </div>
                                </div>
                            </span>
                        </label>
                        <div class="segmented-control">
                            <input type="radio" id="regimeModeHistorical" name="regimeMode" value="historical" checked>
                            <label for="regimeModeHistorical" class="segment-label">
                                <span class="segment-icon"></span>
                                <span class="segment-text">Historical</span>
                            </label>
                            <input type="radio" id="regimeModeConservative" name="regimeMode" value="conservative">
                            <label for="regimeModeConservative" class="segment-label">
                                <span class="segment-icon"></span>
                                <span class="segment-text">Conservative</span>
                            </label>
                            <div class="segment-slider"></div>
                        </div>
                        <p id="regimeModeDescription" class="regime-mode-description">
                            Stress-testing parameters with extended crash durations. Recommended for evaluating worst-case scenarios.
                        </p>
                    </div>

                    <hr class="border-none-t-1-my-24">
                </div>

                <!-- Single Asset Mode Content -->
                <div id="singleAssetContent" class="single-asset-content hidden">
                <!-- Data Fetch Section -->
                <div class="api-section">
                    <h3>Fetch Historical Data (Optional):</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button type="button" class="button-fetch" onclick="fetchHistoricalData(false)">
                            Fetch Historical Data
                        </button>
                        <button type="button" class="button button-force-refresh" onclick="fetchHistoricalData(true)"
                                title="Force re-fetch from API, bypassing cache">
                             Force Refresh
                        </button>
                    </div>
                    <small style="display: block; margin-top: 8px;">Configure data source in <a href="javascript:showSettings()" style="color: var(--md-sys-color-primary); text-decoration: underline;">Settings</a></small>
                </div>

                <!-- Historical Data Asset Selector -->
                <div class="input-group">
                    <label for="historicalDataAsset">Historical Data (Asset):</label>
                    <select id="historicalDataAsset" onchange="loadHistoricalAssetData()">
                        <option value="">None</option>
                    </select>
                    <div class="helper-text">Select a predefined asset to auto-fill historical data</div>
                </div>

                <!-- Historical Data Input -->
                <div class="input-group">
                    <label for="historicalData">Historical Returns Data</label>
                    <textarea id="historicalData" onblur="updateStartYearsFromHistoricalData(this.value)" placeholder="Format:
1995: 24.32%
1996: 65.80%
1997: 38.12%">2025: 43.56%
2026: 88.32%
2027: 56.43%
2028: 114.60%
2029: 68.36%
2030: -62.85%
2031: 52.74%
2032: -21.96%
2033: 5.88%
2034: -2.37%
2035: -2.13%
2036: 14.19%
2037: 19.22%
2038: -45.39%
2039: 56.79%
2040: -8.43%
2041: -6.99%
2042: 2.89%
2043: 40.06%
2044: 24.16%
2045: 19.44%
2046: 12.00%
2047: 37.66%
2048: 18.74%
2049: 55.26%
2050: 41.04%
2051: 51.21%
2052: -28.69%
2053: 56.80%
2054: 12.09%</textarea>
                </div>

                <div class="input-group">
                    <label for="assetName">Asset to Invest In:</label>
                    <input type="text" id="assetName" value="MSFT" placeholder="e.g., MSFT, AAPL, GOOGL">
                    <div class="helper-text">Use stock ticker symbols (MSFT, AAPL, GOOGL, etc.)</div>
                </div>
                </div>
                <!-- End Single Asset Content -->

                <!-- Shared BBD Strategy Parameters -->
                <h3 style="font-size: 16px; margin-bottom: 16px; margin-top: 24px;">BBD Strategy Parameters:</h3>

                <!-- A. Starting Position -->
                <div class="param-group">
                    <div class="param-group-header">
                        <div class="param-group-icon">
                            <span class="material-icons">account_balance</span>
                        </div>
                        <h4 class="param-group-title">Starting Position</h4>
                    </div>
                    <div class="input-group">
                        <label for="startValue">Asset Start Value ($):</label>
                        <input type="number" id="startValue" value="3000000" min="0" step="1000">
                    </div>
                    <div class="input-group">
                        <label for="locBalance">LOC Balance ($):</label>
                        <input type="number" id="locBalance" value="0" min="0" step="1000">
                        <div class="helper-text">Starting line of credit balance (set to 0 if starting fresh)</div>
                    </div>
                </div>

                <!-- B. Timeline -->
                <div class="param-group">
                    <div class="param-group-header">
                        <div class="param-group-icon">
                            <span class="material-icons">schedule</span>
                        </div>
                        <h4 class="param-group-title">Timeline</h4>
                    </div>
                    <div class="input-group">
                        <label for="startYear">Buy Borrow Die Start Year:</label>
                        <input type="number" id="startYear" value="" min="1900" max="2100">
                    </div>
                    <div class="input-group">
                        <label for="withdrawalStartYear">Year to Start Withdrawal:</label>
                        <input type="number" id="withdrawalStartYear" value="" min="1900" max="2100">
                    </div>
                    <div class="input-group">
                        <label for="period">Period (Years):</label>
                        <input type="number" id="period" value="16" min="1" max="100">
                    </div>
                </div>

                <!-- C. Withdrawal Strategy -->
                <div class="param-group">
                    <div class="param-group-header">
                        <div class="param-group-icon">
                            <span class="material-icons">payments</span>
                        </div>
                        <h4 class="param-group-title">Withdrawal Strategy</h4>
                    </div>
                    <div class="input-group">
                        <label for="annualWithdrawal">Total Annual Withdrawal ($):</label>
                        <input type="number" id="annualWithdrawal" value="150000" min="0" step="1000">
                    </div>
                    <div class="input-group">
                        <label for="annualRaise">Annual Percentage Raise (%):</label>
                        <input type="number" id="annualRaise" value="3" min="0" max="100" step="0.1">
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="monthlyWithdrawal" checked>
                        <label for="monthlyWithdrawal">Withdraw Monthly (Equal Amounts)</label>
                    </div>
                </div>

                <!-- D. SBLOC Risk Parameters -->
                <div class="param-group">
                    <div class="param-group-header">
                        <div class="param-group-icon">
                            <span class="material-icons">shield</span>
                        </div>
                        <h4 class="param-group-title">SBLOC Risk Parameters</h4>
                    </div>
                    <div class="input-group">
                        <label for="sblocRate">SBLOC Interest Rate (%):</label>
                        <input type="number" id="sblocRate" value="7.4" min="0" max="100" step="0.01">
                    </div>
                    <div class="input-group">
                        <label for="maxBorrowing">SBLOC Max Borrowing % (Hard Margin Call):</label>
                        <input type="number" id="maxBorrowing" value="65" min="0" max="100" step="1">
                        <div class="helper-text">Portfolio liquidated if LTV exceeds this threshold</div>
                    </div>
                    <div class="input-group">
                        <label for="maintenanceMargin">Maintenance Margin % (Warning Zone):</label>
                        <input type="number" id="maintenanceMargin" value="50" min="0" max="100" step="1">
                        <div class="helper-text">Warning zone - between this and max borrowing</div>
                    </div>
                    <div class="input-group">
                        <label for="liquidationHaircut">Forced Liquidation Haircut %:</label>
                        <input type="number" id="liquidationHaircut" value="5" min="0" max="20" step="0.5">
                        <div class="helper-text">Market impact + transaction costs on forced sale</div>
                    </div>
                </div>

                <hr class="border-none-t-1-my-24">

                <!-- Withdrawal Chapters Section -->
                <h3 class="text-lg-my-16-text-primary">Withdrawal Chapters (Optional)</h3>

                <div class="checkbox-group">
                    <input type="checkbox" id="enableChapters" onchange="toggleChaptersInputs()">
                    <label for="enableChapters">Enable Multi-Phase Withdrawal Strategy</label>
                </div>

                <div id="chaptersSection" class="hidden">
                    <div class="helper-text mb-16">
                        Define up to 2 additional withdrawal phases. Chapter 1 uses the settings above.
                    </div>

                    <!-- Chapter 2 -->
                    <div style="background: rgba(66, 153, 225, 0.05); padding: 12px; border-radius: 4px; margin-bottom: 12px; border-left: 4px solid rgba(66, 153, 225, 0.3);">
                        <h4 class="text-base-my-12-text-primary-semibold">
                            Chapter 2
                        </h4>
                        <div class="grid-2-col">
                            <div class="input-group mb-0">
                                <label for="chapter2YearsAfter">Years After Chapter 1:</label>
                                <input type="number" id="chapter2YearsAfter" value="10" min="1" max="100">
                            </div>
                            <div class="input-group mb-0">
                                <label for="chapter2ReductionPct">Reduction (%):</label>
                                <input type="number" id="chapter2ReductionPct" value="20" min="-100" max="100" step="1">
                                <div class="helper-text">Negative = increase</div>
                            </div>
                        </div>
                    </div>

                    <!-- Chapter 3 -->
                    <div style="background: rgba(66, 153, 225, 0.05); padding: 12px; border-radius: 4px; border-left: 4px solid rgba(66, 153, 225, 0.3);">
                        <h4 class="text-base-my-12-text-primary-semibold">
                            Chapter 3
                        </h4>
                        <div class="grid-2-col">
                            <div class="input-group mb-0">
                                <label for="chapter3YearsAfter">Years After Chapter 2:</label>
                                <input type="number" id="chapter3YearsAfter" value="10" min="1" max="100">
                            </div>
                            <div class="input-group mb-0">
                                <label for="chapter3ReductionPct">Reduction (%):</label>
                                <input type="number" id="chapter3ReductionPct" value="30" min="-100" max="100" step="1">
                                <div class="helper-text">Negative = increase</div>
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="border-none-t-1-my-24">

                <!-- Tax Modeling Section -->
                <h3 class="text-lg-my-16-text-primary">Tax Modeling (Optional)</h3>

                <div class="checkbox-group">
                    <input type="checkbox" id="enableTaxModeling" onchange="toggleTaxInputs()" checked>
                    <label for="enableTaxModeling">Enable Dividend Tax & Capital Gains Tax Modeling</label>
                </div>

                <div id="taxInputsSection" class="hidden">
                    <div class="input-group">
                        <label for="dividendYield">Average Dividend Yield (%):</label>
                        <input type="number" id="dividendYield" value="2.0" min="0" max="10" step="0.1">
                        <div class="helper-text">Approximate dividend yield of portfolio</div>
                    </div>

                    <div class="input-group">
                        <label for="ordinaryTaxRate">Ordinary Income Tax Rate (%):</label>
                        <input type="number" id="ordinaryTaxRate" value="37" min="0" max="100" step="1">
                        <div class="helper-text">Top federal + state tax rate on dividends</div>
                    </div>

                    <div class="input-group">
                        <label for="ltcgTaxRate">Long-Term Capital Gains Tax Rate (%):</label>
                        <input type="number" id="ltcgTaxRate" value="23.8" min="0" max="100" step="0.1">
                        <div class="helper-text">Federal LTCG (20%) + NIIT (3.8%)</div>
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="taxAdvantaged">
                        <label for="taxAdvantaged">Portfolio in Tax-Advantaged Account (No Taxes)</label>
                    </div>
                </div>

                </form>
            </div>

            <div class="sticky-button-wrapper">
                <button type="submit" form="simulatorForm" class="button button-primary">
                    <span class="material-icons" class="align-middle-mr-8">play_arrow</span>
                    Run Simulation
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div id="emptyState" class="empty-state">
                <div class="welcome-guide">
                    <div class="guide-header">
                        <span class="guide-icon"></span>
                        <h2>Welcome to the Portfolio Strategy Simulator</h2>
                    </div>

                    <div class="guide-intro">
                        <p>Model tax-efficient retirement strategies using historical asset data. Choose between <strong>Monte Carlo</strong> simulation (probabilistic with multiple assets) or <strong>Single Asset</strong> analysis (deterministic) to understand portfolio behavior and risk.</p>
                    </div>

                    <!-- Buy Borrow Die Strategy Section -->
                    <div class="bbd-strategy-section">
                        <div class="bbd-header">
                            <h2 class="bbd-title">Buy, Borrow, Die</h2>
                            <p class="bbd-subtitle">The Wealth Preservation Strategy</p>
                        </div>

                        <div class="bbd-content">
                            <div class="bbd-description">
                                <p><strong>Buy, Borrow, Die</strong> is a sophisticated tax optimization strategy used to preserve and transfer wealth across generations. Instead of selling appreciated assets and triggering capital gains taxes - effectively dismantling a portion of your compounding engine - this approach allows investors to access liquidity while holding their fully invested positions. By keeping the entire principal at work, the investor benefits from uninterrupted compounding. Upon the owner's death, the Step-up in Basis (IRC 1014) resets the tax cost to current market value, allowing heirs to inherit the full momentum of the built wealth entirely tax-free.</p>
                            </div>

                            <div class="bbd-pillars">
                                <div class="bbd-pillar">
                                    <span class="bbd-pillar-icon"></span>
                                    <h3 class="bbd-pillar-title">Buy</h3>
                                    <p class="bbd-pillar-text">Invest in appreciating assets like stocks, real estate, or businesses that grow in value over time.</p>
                                </div>

                                <span class="bbd-arrow"></span>

                                <div class="bbd-pillar">
                                    <span class="bbd-pillar-icon"></span>
                                    <h3 class="bbd-pillar-title">Borrow</h3>
                                    <p class="bbd-pillar-text">Use appreciated assets as collateral to secure low-interest loans for living expenses, avoiding taxable sales.</p>
                                </div>

                                <span class="bbd-arrow"></span>

                                <div class="bbd-pillar">
                                    <span class="bbd-pillar-icon"></span>
                                    <h3 class="bbd-pillar-title">Die</h3>
                                    <p class="bbd-pillar-text">Transfer assets to heirs with a stepped-up cost basis, eliminating capital gains tax on appreciation.</p>
                                </div>
                            </div>

                            <!-- How This Simulator Helps Section -->
                            <div class="bbd-simulator-helps">
                                <h4 class="bbd-simulator-title">
                                    <span class="material-icons" style="font-size: 20px;">insights</span>
                                    How This Simulator Helps You Model BBD Strategy
                                </h4>

                                <div class="bbd-features-grid">
                                    <div class="bbd-feature-card">
                                        <span class="bbd-feature-icon"></span>
                                        <div class="bbd-feature-content">
                                            <h5 class="bbd-feature-heading">Model Tax-Free Withdrawals</h5>
                                            <p class="bbd-feature-text">Configure SBLOC borrowing amounts and track loan-to-value ratios across different market scenarios.</p>
                                        </div>
                                    </div>

                                    <div class="bbd-feature-card">
                                        <span class="bbd-feature-icon"></span>
                                        <div class="bbd-feature-content">
                                            <h5 class="bbd-feature-heading">Stress Test Margin Calls</h5>
                                            <p class="bbd-feature-text">Run Monte Carlo simulations to identify vulnerable years and understand portfolio resilience during downturns.</p>
                                        </div>
                                    </div>

                                    <div class="bbd-feature-card">
                                        <span class="bbd-feature-icon"></span>
                                        <div class="bbd-feature-content">
                                            <h5 class="bbd-feature-heading">Calculate Tax Savings</h5>
                                            <p class="bbd-feature-text">Compare tax-free SBLOC borrowing versus taxable salary to quantify your annual tax optimization benefit.</p>
                                        </div>
                                    </div>

                                    <div class="bbd-feature-card">
                                        <span class="bbd-feature-icon"></span>
                                        <div class="bbd-feature-content">
                                            <h5 class="bbd-feature-heading">Plan Multi-Phase Strategy</h5>
                                            <p class="bbd-feature-text">Model different withdrawal phases across your lifetime to optimize long-term wealth preservation and transfer.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="bbd-learn-more">
                                <h4 class="bbd-learn-more-title">
                                    <span class="material-icons" style="font-size: 20px;">play_circle</span>
                                    Learn More About This Strategy
                                </h4>
                                <div class="bbd-videos">
                                    <a href="https://youtu.be/KHCwDcbUmgg?si=Pq2Owco0bedE6jHa" target="_blank" rel="noopener noreferrer" class="bbd-video-link">
                                        <svg class="bbd-video-icon" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                                        </svg>
                                        Buy Borrow Die Explained
                                    </a>
                                    <a href="https://youtu.be/-hqEIseS_e0?si=RPBLEN3HPNvt10SJ" target="_blank" rel="noopener noreferrer" class="bbd-video-link">
                                        <svg class="bbd-video-icon" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                                        </svg>
                                        Advanced Tax Strategy
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="guide-steps">
                        <div class="step-card">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <h3>Choose Your Simulation Mode</h3>
                                <p><strong>Monte Carlo:</strong> Build a portfolio from multiple assets and run thousands of probabilistic simulations to understand risk (recommended).<br>
                                <strong>Single Asset:</strong> Analyze one asset with its exact historical returns (deterministic).</p>
                            </div>
                        </div>

                        <div class="step-card">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <h3>Monte Carlo: Build Portfolio</h3>
                                <p>Select 2-5 assets from the dropdown, set portfolio weights (must total 100%), and choose number of simulations. Review correlation matrix to understand asset relationships.</p>
                            </div>
                        </div>

                        <div class="step-card">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <h3>Single Asset: Quick Start</h3>
                                <p>Switch to <strong>Single Asset mode</strong>, then select from <strong>Historical Data (Asset)</strong> dropdown to auto-populate returns. <span id="availableAssets">Loading assets...</span> Or enter your own ticker and fetch data via Settings ().</p>
                            </div>
                        </div>

                        <div class="step-card">
                            <div class="step-number">4</div>
                            <div class="step-content">
                                <h3>Configure BBD Strategy</h3>
                                <p>Set annual withdrawal amount, SBLOC interest rate, margin limits, and time horizon. Parameters apply to both Single Asset and Monte Carlo modes.</p>
                            </div>
                        </div>

                        <div class="step-card">
                            <div class="step-number">5</div>
                            <div class="step-content">
                                <h3>Analyze Results</h3>
                                <p><strong>Monte Carlo:</strong> See probability cones, success rates, percentile outcomes, liquidity stress testing, and terminal value distributions.<br>
                                <strong>Single Asset:</strong> View exact projections with charts and year-by-year details.</p>
                            </div>
                        </div>
                    </div>

                    <div class="guide-tips">
                        <div class="tip-header"> Pro Tips</div>
                        <ul>
                            <li><strong>Compare Modes:</strong> Run Monte Carlo first to understand probability ranges, then Single Asset for exact projections if needed.</li>
                            <li><strong>Portfolio Diversification:</strong> Mix volatile assets (tech stocks) with stable ones (indexes) to reduce risk.</li>
                            <li><strong>Correlation Matters:</strong> Assets with low/negative correlation provide better diversification.</li>
                            <li><strong>Run More Simulations:</strong> 10,000 simulations give more accurate probabilities (but take longer).</li>
                            <li><strong>Success Rate:</strong> Aim for 80%+ success rate for a robust strategy.</li>
                            <li><strong>Dark Mode:</strong> Toggle theme in top-right corner for comfortable viewing.</li>
                        </ul>
                    </div>

                    <div class="guide-cta">
                        <div class="cta-arrow"></div>
                        <p>Ready to start? Select a preset asset or configure your parameters on the left!</p>
                    </div>

                    <!-- Field Instructions Toggle -->
                    <div class="field-instructions-toggle-group">
                        <button class="toggle-instructions-btn monte-carlo-guide" onclick="toggleFieldInstructions('montecarlo')">
                            <span class="material-icons">scatter_plot</span>
                            <span>Monte Carlo Field Guide</span>
                            <span class="material-icons toggle-icon">expand_more</span>
                        </button>
                        <button class="toggle-instructions-btn single-asset-guide" onclick="toggleFieldInstructions('single')">
                            <span class="material-icons">trending_up</span>
                            <span>Single Asset Field Guide</span>
                            <span class="material-icons toggle-icon">expand_more</span>
                        </button>
                    </div>

                    <!-- Single Asset Field Instructions (Hidden by default) -->
                    <div id="fieldInstructionsSingle" class="field-instructions hidden">
                        <div class="instructions-header">
                            <h3> Single Asset Parameter Guide</h3>
                            <p>Detailed explanations for each input field to help you configure your single asset simulation.</p>
                        </div>

                        <div class="instruction-item">
                            <h4> Settings Modal & Data Configuration</h4>
                            <p><strong>Purpose:</strong> Configure API data sources, manage cached data, and adjust advanced technical settings. Access by clicking the <strong>Settings</strong> button () in the top right corner.</p>

                            <p class="mt-16"><strong> Data Source Configuration (6 API Providers):</strong></p>

                            <div class="ml-20-mb-16">
                                <p class="mb-8"><strong>1. FMP (Financial Modeling Prep)</strong></p>
                                <ul class="list-indented-compact">
                                    <li><strong>Free Tier:</strong> 250 requests/day</li>
                                    <li><strong>Paid Tier:</strong> $19/month for unlimited requests</li>
                                    <li><strong>Data Quality:</strong> Excellent, reliable, fast</li>
                                    <li><strong>How to get API key:</strong> Sign up at financialmodelingprep.com  Dashboard  API Keys</li>
                                    <li><strong>Best for:</strong> High-volume users who need reliable daily data fetching</li>
                                </ul>
                            </div>

                            <div class="ml-20-mb-16">
                                <p class="mb-8"><strong>2. EODHD (End of Day Historical Data)</strong></p>
                                <ul class="list-indented-compact">
                                    <li><strong>Free Tier:</strong> 20 requests/day (limited but sufficient for occasional use)</li>
                                    <li><strong>Paid Tier:</strong> 19.99/month (~$21/mo)</li>
                                    <li><strong>Data Quality:</strong> Excellent, comprehensive coverage</li>
                                    <li><strong>How to get API key:</strong> Register at eodhistoricaldata.com  Account  API Settings</li>
                                    <li><strong>Best for:</strong> Users who fetch data occasionally and want high-quality free access</li>
                                </ul>
                            </div>

                            <div class="ml-20-mb-16">
                                <p class="mb-8"><strong>3. Alpha Vantage</strong></p>
                                <ul class="list-indented-compact">
                                    <li><strong>Free Tier:</strong> 25 requests/day, 5 requests/minute rate limit</li>
                                    <li><strong>Paid Tier:</strong> $49.99/month</li>
                                    <li><strong>Data Quality:</strong> Good, but rate limits can be restrictive</li>
                                    <li><strong>How to get API key:</strong> Visit alphavantage.co  Get Free API Key  Fill form</li>
                                    <li><strong>Best for:</strong> Casual users with low data needs; free tier has stricter limits</li>
                                </ul>
                            </div>

                            <div class="ml-20-mb-16">
                                <p class="mb-8"><strong>4. Yahoo Finance (Unofficial)</strong></p>
                                <ul class="list-indented-compact">
                                    <li><strong>Cost:</strong> Completely free, no API key required</li>
                                    <li><strong>Data Quality:</strong> Good, but unofficial API (may break unexpectedly)</li>
                                    <li><strong>Reliability:</strong> Works most of the time, but Yahoo can block or change endpoints</li>
                                    <li><strong>Best for:</strong> Testing or when you don't want to manage API keys</li>
                                    <li><strong> Warning:</strong> No official support; may require CORS proxy</li>
                                </ul>
                            </div>

                            <div class="ml-20-mb-16">
                                <p class="mb-8"><strong>5. Tiingo</strong></p>
                                <ul class="list-indented-compact">
                                    <li><strong>Free Tier:</strong> 50 symbols/hour, 30+ years of historical data</li>
                                    <li><strong>Paid Tier:</strong> Flat-rate pricing for higher limits</li>
                                    <li><strong>Data Quality:</strong> Excellent, data back to 1962</li>
                                    <li><strong>How to get API key:</strong> Sign up at tiingo.com  My Account  API</li>
                                    <li><strong>Best for:</strong> On-demand fetching of new assets to add to your library</li>
                                    <li><strong>Special Feature:</strong> "Fetch & Add to Library" button adds assets directly to Available Assets list</li>
                                    <li><strong> Note:</strong> May require CORS proxy for browser access</li>
                                </ul>
                            </div>

                            <div class="ml-20-mb-16">
                                <p class="mb-8"><strong>6. Manual Entry (Default)</strong></p>
                                <ul class="list-indented-compact">
                                    <li><strong>How it works:</strong> Manually paste historical returns into the text area</li>
                                    <li><strong>Best for:</strong> Testing hypothetical scenarios or when APIs are unavailable</li>
                                    <li><strong>Format:</strong> One line per year in format: <code>YYYY: XX.XX%</code></li>
                                    <li><strong>Advantage:</strong> No API dependencies, complete control over data</li>
                                </ul>
                            </div>

                            <p class="mt-16"><strong> How to Configure API Sources:</strong></p>
                            <ol class="ml-20-lh-2">
                                <li>Click <strong>Settings</strong> button () in top right</li>
                                <li>Select your preferred data source (radio button)</li>
                                <li>Enter your API key in the text field that appears</li>
                                <li>Click <strong>Test Connection</strong> to verify it works</li>
                                <li>If successful, click <strong>Save Settings</strong></li>
                                <li>Your API key is stored securely in browser localStorage (never sent to servers)</li>
                            </ol>

                            <p class="mt-16"><strong> Cache Management:</strong></p>
                            <ul class="list-indented-spaced">
                                <li><strong>Automatic Caching:</strong> Fetched data is permanently cached in your browser to avoid repeated API calls</li>
                                <li><strong>Cache Benefits:</strong> Instant load times, saves API quota, works offline</li>
                                <li><strong>View Cache:</strong> Click "Cache Details" in Settings to see what's stored (displays asset names, date ranges, data size)</li>
                                <li><strong>Clear Cache:</strong> Click "Clear All Cached Data" button to remove all stored historical data (useful if data is outdated or corrupted)</li>
                                <li><strong>Cache Statistics:</strong> Shows total entries cached and storage used</li>
                            </ul>

                            <p class="mt-16"><strong> Force Refresh Feature:</strong></p>
                            <ul class="list-indented-spaced">
                                <li><strong>Purpose:</strong> Fetch the latest data from API, bypassing cache (useful when new year's data is available)</li>
                                <li><strong>How to use:</strong> Click the <strong>"Force Refresh"</strong> button next to "Fetch Historical Data" to ignore cached data and pull fresh data</li>
                                <li><strong>When to use:</strong> Beginning of a new year to get updated returns; after market close to include latest trading day; if you suspect cached data is stale</li>
                                <li><strong>API Impact:</strong> Uses one API request per force refresh</li>
                            </ul>

                            <p class="mt-16"><strong> CORS Proxy Configuration:</strong></p>
                            <ul class="list-indented-spaced">
                                <li><strong>What is CORS?</strong> Browser security that blocks some API requests. A CORS proxy bypasses this restriction.</li>
                                <li><strong>When needed:</strong> If API connections fail with CORS errors</li>
                                <li><strong>Preset Options:</strong> Two preset proxy buttons (CORSProxy.io, AllOrigins) for quick setup</li>
                                <li><strong>Custom Proxy:</strong> Enter your own proxy URL if you prefer (format: https://proxy.example.com/)</li>
                                <li><strong>Direct Connection:</strong> Leave blank to connect directly (works for most paid API tiers)</li>
                            </ul>

                            <p class="mt-16"><strong> Advanced Technical Settings:</strong></p>
                            <ul class="list-indented-spaced">
                                <li><strong>Require True Crossover Above 20:</strong> (Checkbox) Only consider data "valid" if it has a proper start/end alignment</li>
                                <li><strong>Minimum History Bars:</strong> (Default: 120) Minimum number of data points required for simulation. Prevents running simulations with insufficient data.</li>
                            </ul>

                            <p class="mt-16"><strong> Recommended Setup:</strong></p>
                            <ul class="list-indented">
                                <li><strong>For frequent users:</strong> FMP paid ($19/mo) with direct connection (no proxy)</li>
                                <li><strong>For occasional users:</strong> EODHD free (20/day) or Alpha Vantage free (25/day)</li>
                                <li><strong>For testing:</strong> Yahoo Finance (free, no key) or Manual Entry</li>
                            </ul>
                        </div>

                        <div class="instruction-item">
                            <h4> Complete Preset Asset List (19 Assets)</h4>
                            <p><strong>Purpose:</strong> Quick-select assets with pre-loaded historical return data. These assets have been carefully curated with extensive historical data for realistic simulations.</p>

                            <p class="mt-12"><strong>Available Preset Assets:</strong></p>

                            <div class="ml-20">
                                <p class="mb-8"><strong>Broad Market Indexes (3):</strong></p>
                                <ul class="list-indented-compact">
                                    <li><strong>S&P500</strong> - S&P 500 Index (broad US market, most diversified)</li>
                                    <li><strong>QQQ</strong> - Nasdaq-100 ETF (tech-heavy index)</li>
                                    <li><strong>Vanguard Total Stock Market Index</strong> - VTI (entire US stock market)</li>
                                </ul>

                                <p class="mb-8 mt-16"><strong>Large Cap Technology (6):</strong></p>
                                <ul class="list-indented-compact">
                                    <li><strong>Microsoft</strong> - MSFT (software, cloud, AI)</li>
                                    <li><strong>Nvidia</strong> - NVDA (GPUs, AI chips, data centers)</li>
                                    <li><strong>Apple</strong> - AAPL (consumer electronics, services)</li>
                                    <li><strong>Google</strong> - GOOGL (search, advertising, cloud)</li>
                                    <li><strong>Amazon</strong> - AMZN (e-commerce, AWS cloud)</li>
                                    <li><strong>AMD</strong> - Advanced Micro Devices (CPUs, GPUs)</li>
                                </ul>

                                <p class="mb-8 mt-16"><strong>Traditional Technology (1):</strong></p>
                                <ul class="list-indented-compact">
                                    <li><strong>IBM</strong> - International Business Machines (enterprise IT, consulting)</li>
                                    <li><strong>Intel</strong> - INTC (semiconductors, CPUs)</li>
                                </ul>

                                <p class="mb-8 mt-16"><strong>Consumer/Retail (3):</strong></p>
                                <ul class="list-indented-compact">
                                    <li><strong>McDonald's</strong> - MCD (fast food, dividends)</li>
                                    <li><strong>Coca Cola</strong> - KO (beverages, dividend aristocrat)</li>
                                    <li><strong>Walmart</strong> - WMT (retail, stable earnings)</li>
                                </ul>

                                <p class="mb-8 mt-16"><strong>Automotive (2):</strong></p>
                                <ul class="list-indented-compact">
                                    <li><strong>Ford</strong> - F (traditional auto manufacturer)</li>
                                    <li><strong>Rivian</strong> - RIVN (electric vehicles, growth stock)</li>
                                </ul>

                                <p class="mb-8 mt-16"><strong>Energy (2):</strong></p>
                                <ul class="list-indented-compact">
                                    <li><strong>ConocoPhillips</strong> - COP (oil & gas exploration)</li>
                                    <li><strong>Exxon</strong> - XOM (integrated energy giant)</li>
                                </ul>

                                <p class="mb-8 mt-16"><strong>Commodities (1):</strong></p>
                                <ul class="list-indented-compact">
                                    <li><strong>Gold (GLD)</strong> - SPDR Gold Shares ETF (precious metal, inflation hedge)</li>
                                </ul>
                            </div>

                            <p class="mt-16"><strong>How to use preset assets:</strong></p>
                            <ol class="ml-20-lh-2">
                                <li><strong>Single Asset Mode:</strong> Select from "Historical Data" dropdown  historical returns auto-populate</li>
                                <li><strong>Monte Carlo Mode:</strong> Click dropdown to add assets to portfolio  configure weights  run simulation</li>
                            </ol>

                            <p class="mt-12"><strong> Custom Assets:</strong> Edit <code>HistoricalData.txt</code> file to add your own assets with historical returns. Follow the format:<br>
                            <code>TICKER: YYYY: XX.XX%, YYYY: XX.XX%, ...</code></p>

                            <p class="mt-12"><strong>Diversification Tips:</strong></p>
                            <ul class="list-indented">
                                <li><strong>Low correlation:</strong> Combine assets from different sectors (e.g., Tech + Energy + Consumer)</li>
                                <li><strong>Mix growth and stability:</strong> Nvidia (high growth) + S&P500 (stable) + Coca Cola (dividends)</li>
                                <li><strong>Avoid overconcentration:</strong> Don't select 5 tech stocks (they're highly correlated)</li>
                            </ul>
                        </div>

                        <div class="instruction-item">
                            <h4>Historical Data (Asset)</h4>
                            <p><strong>Purpose:</strong> Quick-select preset assets with pre-loaded historical return data.</p>
                            <p><strong>How to use:</strong> Select an asset to automatically populate historical returns and run the simulation instantly.</p>
                            <p><strong>See above</strong> for the complete list of 19 available preset assets organized by category.</p>
                        </div>

                        <div class="instruction-item">
                            <h4>Historical Returns Data</h4>
                            <p><strong>Purpose:</strong> The year-by-year return percentages for your chosen asset.</p>
                            <p><strong>Format:</strong> One line per year in format: <code>YYYY: XX.XX%</code></p>
                            <p><strong>Example:</strong> <code>2025: 34.11%</code> or <code>2030: -10.14%</code></p>
                            <p><strong>Note:</strong> Use <code>N/A</code> for years with no data. The simulation uses these historical returns to model realistic market volatility.</p>
                        </div>

                        <div class="instruction-item">
                            <h4>Asset to Invest In</h4>
                            <p><strong>Purpose:</strong> The stock ticker symbol or asset name for your investment.</p>
                            <p><strong>Examples:</strong> MSFT, AAPL, GOOGL, TSLA, SPY</p>
                            <p><strong>Note:</strong> This is for display/reference only and auto-fills when selecting a preset asset.</p>
                        </div>

                        <!-- 
                             STARTING POSITION - What you have now
                              -->
                        <div class="instruction-item" style="background: linear-gradient(135deg, rgba(27, 75, 75, 0.06) 0%, rgba(27, 75, 75, 0.02) 100%); border-left: 3px solid rgba(27, 75, 75, 0.4);">
                            <h4 style="color: var(--color-brand-primary); margin-bottom: 8px;">Starting Position</h4>
                            <p style="margin: 0; font-size: 13px; color: var(--md-sys-color-on-surface-variant);">What you have now  your initial portfolio and any existing debt</p>
                        </div>

                        <div class="instruction-item">
                            <h4>Asset Start Value ($)</h4>
                            <p><strong>Purpose:</strong> Your initial portfolio value at the beginning of the simulation.</p>
                            <p><strong>Example:</strong> $3,000,000</p>
                            <p><strong>Tip:</strong> This is the total market value of your investment portfolio when the strategy begins.</p>
                        </div>

                        <div class="instruction-item">
                            <h4>LOC Balance ($)</h4>
                            <p><strong>Purpose:</strong> Your existing Securities-Backed Line of Credit balance (if any).</p>
                            <p><strong>Default:</strong> $0 (starting fresh)</p>
                            <p><strong>When to use:</strong> Set this if you already have an existing SBLOC balance when starting the simulation.</p>
                        </div>

                        <!-- 
                             TIMELINE - When things happen
                              -->
                        <div class="instruction-item" style="background: linear-gradient(135deg, rgba(27, 75, 75, 0.06) 0%, rgba(27, 75, 75, 0.02) 100%); border-left: 3px solid rgba(27, 75, 75, 0.4);">
                            <h4 style="color: var(--color-brand-primary); margin-bottom: 8px;">Timeline</h4>
                            <p style="margin: 0; font-size: 13px; color: var(--md-sys-color-on-surface-variant);">When things happen  simulation start, withdrawal start, and duration</p>
                        </div>

                        <div class="instruction-item">
                            <h4>Buy Borrow Die Start Year</h4>
                            <p><strong>Purpose:</strong> The year your simulation begins.</p>
                            <p><strong>Default:</strong> Current year</p>
                            <p><strong>Note:</strong> Should align with the first year in your historical data. Auto-set when selecting preset assets.</p>
                        </div>

                        <div class="instruction-item">
                            <h4>Year to Start Withdrawal</h4>
                            <p><strong>Purpose:</strong> The year you begin taking withdrawals from the portfolio via SBLOC borrowing.</p>
                            <p><strong>Default:</strong> Same as start year (immediate withdrawals)</p>
                            <p><strong>Strategy:</strong> Setting this to a later year allows the portfolio to grow tax-free before you start borrowing.</p>
                        </div>

                        <div class="instruction-item">
                            <h4>Period (Years)</h4>
                            <p><strong>Purpose:</strong> Total duration of the simulation in years.</p>
                            <p><strong>Default:</strong> 30 years</p>
                            <p><strong>Typical range:</strong> 20-40 years for retirement planning</p>
                            <p><strong>Note:</strong> Must have enough historical data to cover this period.</p>
                        </div>

                        <!-- 
                             WITHDRAWAL STRATEGY - What you take out
                              -->
                        <div class="instruction-item" style="background: linear-gradient(135deg, rgba(27, 75, 75, 0.06) 0%, rgba(27, 75, 75, 0.02) 100%); border-left: 3px solid rgba(27, 75, 75, 0.4);">
                            <h4 style="color: var(--color-brand-primary); margin-bottom: 8px;">Withdrawal Strategy</h4>
                            <p style="margin: 0; font-size: 13px; color: var(--md-sys-color-on-surface-variant);">What you take out  annual amounts, raises, and optional reductions</p>
                        </div>

                        <div class="instruction-item">
                            <h4>Total Annual Withdrawal ($)</h4>
                            <p><strong>Purpose:</strong> How much money you want to withdraw each year for living expenses.</p>
                            <p><strong>Default:</strong> $150,000</p>
                            <p><strong>Note:</strong> This is borrowed from your SBLOC tax-free. The simulator shows the equivalent taxable salary.</p>
                            <p><strong>Strategy:</strong> Typically 3-5% of your starting portfolio value for sustainability.</p>
                        </div>

                        <div class="instruction-item">
                            <h4>Annual Percentage Raise (%)</h4>
                            <p><strong>Purpose:</strong> How much to increase your withdrawal amount each year to keep up with inflation.</p>
                            <p><strong>Default:</strong> 3%</p>
                            <p><strong>Common range:</strong> 2-4% (matches typical inflation)</p>
                            <p><strong>Example:</strong> With 3% raise, a $150,000 withdrawal becomes $154,500 next year.</p>
                        </div>

                        <div class="instruction-item">
                            <h4>Withdraw Monthly (Equal Amounts)</h4>
                            <p><strong>Purpose:</strong> Whether to withdraw money monthly or annually.</p>
                            <p><strong>Checked (default):</strong> Withdrawals divided into 12 equal monthly amounts with monthly compounding.</p>
                            <p><strong>Unchecked:</strong> One lump sum withdrawal per year with annual compounding.</p>
                            <p><strong>Recommendation:</strong> Keep checked for more realistic modeling of regular income needs.</p>
                        </div>


                        <!-- 
                             SBLOC RISK PARAMETERS - Loan mechanics
                              -->
                        <div class="instruction-item" style="background: linear-gradient(135deg, rgba(27, 75, 75, 0.06) 0%, rgba(27, 75, 75, 0.02) 100%); border-left: 3px solid rgba(27, 75, 75, 0.4);">
                            <h4 style="color: var(--color-brand-primary); margin-bottom: 8px;">SBLOC Risk Parameters</h4>
                            <p style="margin: 0; font-size: 13px; color: var(--md-sys-color-on-surface-variant);">Loan mechanics  interest rates, margin thresholds, and liquidation costs</p>
                        </div>

                        <div class="instruction-item">
                            <h4>SBLOC Interest Rate (%)</h4>
                            <p><strong>Purpose:</strong> Annual interest rate charged on your line of credit borrowing.</p>
                            <p><strong>Default:</strong> 7.4%</p>
                            <p><strong>Typical range:</strong> 5-9% (varies by lender and market conditions)</p>
                            <p><strong>Impact:</strong> Lower rates are better - your portfolio needs to outperform this rate for the strategy to work long-term.</p>
                        </div>

                        <div class="instruction-item">
                            <h4>SBLOC Max Borrowing % (Margin Call Trigger)</h4>
                            <p><strong>Purpose:</strong> Maximum percentage of portfolio value you can borrow before triggering a margin call.</p>
                            <p><strong>Default:</strong> 65%</p>
                            <p><strong>Typical range:</strong> 50-70% (conservative = lower, aggressive = higher)</p>
                            <p><strong> Warning:</strong> If your LOC balance exceeds this percentage of your portfolio value, you'll receive a margin call requiring immediate action.</p>
                        </div>

                        <div class="instruction-item">
                            <h4>Maintenance Margin % (Warning Zone)</h4>
                            <p><strong>Purpose:</strong> The threshold at which you enter a "warning zone" - your LOC usage is getting dangerously high but hasn't yet triggered a margin call.</p>
                            <p><strong>Default:</strong> 50%</p>
                            <p><strong>Typical range:</strong> 40-55% (should be lower than Max Borrowing %)</p>
                            <p><strong>How it works:</strong> When your LOC balance reaches this percentage of portfolio value, you're in the warning zone. If it continues rising to the Max Borrowing %, a forced liquidation will occur.</p>
                            <p><strong> Important:</strong> Must be lower than "SBLOC Max Borrowing %" for the warning system to work properly.</p>
                        </div>

                        <div class="instruction-item">
                            <h4>Forced Liquidation Haircut %</h4>
                            <p><strong>Purpose:</strong> The percentage of asset value lost during a forced liquidation event due to market impact and transaction costs.</p>
                            <p><strong>Default:</strong> 5%</p>
                            <p><strong>Typical range:</strong> 3-10% (higher for illiquid assets, lower for highly liquid ones)</p>
                            <p><strong>How it works:</strong> When a margin call is triggered (LOC balance exceeds Max Borrowing %), assets are sold to pay down the LOC. However, you only receive (100% - haircut%) of the asset value due to:</p>
                            <ul class="list-indented-deep-compact">
                                <li><strong>Market impact:</strong> Large sales can move prices against you</li>
                                <li><strong>Bid-ask spread:</strong> Difference between buy and sell prices</li>
                                <li><strong>Transaction costs:</strong> Brokerage fees and commissions</li>
                                <li><strong>Urgency discount:</strong> Forced sales often receive worse prices</li>
                            </ul>
                            <p><strong>Example:</strong> With a 5% haircut, selling $100,000 of assets only generates $95,000 to pay down your LOC.</p>
                            <p><strong> Impact:</strong> Higher haircuts make margin calls more damaging to your portfolio and can lead to portfolio failure even after liquidation.</p>
                        </div>

                        <!-- 
                             OPTIONAL FEATURES
                              -->
                        <div class="instruction-item">
                            <h4>Withdrawal Chapters (Optional) & Tax Modeling (Optional)</h4>
                            <p><strong>Note:</strong> Both optional features are available and work the same way in Single Asset mode:</p>
                            <ul class="list-indented-spaced">
                                <li><strong>Withdrawal Chapters:</strong> Define a multi-phase withdrawal strategy with different amounts at different life stages</li>
                                <li><strong>Tax Modeling:</strong> Account for dividend and capital gains taxes in your results</li>
                            </ul>
                            <p><strong>Configuration:</strong></p>
                            <ul class="list-indented-spaced">
                                <li><strong>Withdrawal Chapters:</strong> Set years and percentage adjustments for up to 3 withdrawal phases</li>
                                <li><strong>Tax Modeling:</strong> Enter dividend yield, tax rates, and select whether your account is tax-advantaged</li>
                            </ul>
                            <p><strong>See Monte Carlo Field Guide</strong> (other toggle button above) for comprehensive explanations, configuration details, and practical examples of how to use these features effectively.</p>
                        </div>

                        <div class="instruction-item">
                            <h4> Margin Call Process: What Happens Step-by-Step</h4>
                            <p><strong>Purpose:</strong> Understand exactly what happens when your LOC utilization exceeds the Max Borrowing % threshold.</p>

                            <p class="mt-12"><strong> Margin Call Triggers When:</strong></p>
                            <ul class="list-indented">
                                <li>LOC Balance  Portfolio Value > Max Borrowing %</li>
                                <li><strong>Example:</strong> LOC Balance = $2.1M, Portfolio = $3M  70% utilization. If Max Borrowing = 65%, margin call triggered.</li>
                            </ul>

                            <p class="mt-16"><strong> The Forced Liquidation Process (6 Steps):</strong></p>

                            <div class="ml-20">
                                <p class="mb-8"><strong>Step 1: Calculate Required Paydown</strong></p>
                                <ul class="list-indented-compact">
                                    <li>Determine how much LOC balance must be reduced to get back under Max Borrowing %</li>
                                    <li>Target: Bring LOC utilization down to Max Borrowing % exactly</li>
                                    <li><strong>Example:</strong> If utilization is 70% and max is 65%, need to reduce LOC enough to reach 65%</li>
                                </ul>

                                <p class="mb-8 mt-16"><strong>Step 2: Apply Liquidation Haircut</strong></p>
                                <ul class="list-indented-compact">
                                    <li>Assets are sold at a discount due to forced sale conditions</li>
                                    <li>Only receive (100% - Haircut%) of asset value</li>
                                    <li><strong>Example:</strong> Need to pay down $200k LOC with 5% haircut  Must sell $210,526 of assets to net $200k</li>
                                    <li><strong>Why haircuts occur:</strong> Market impact (large sales move prices), bid-ask spreads, transaction costs, urgency discount</li>
                                </ul>

                                <p class="mb-8 mt-16"><strong>Step 3: Calculate Capital Gains</strong></p>
                                <ul class="list-indented-compact">
                                    <li>Determine cost basis for sold assets</li>
                                    <li>Calculate realized gains = Sale Price - Cost Basis</li>
                                    <li><strong>Example:</strong> Sell $210k of assets with $150k cost basis  $60k capital gain</li>
                                    <li><strong>Cost basis tracking:</strong> Simulator maintains running cost basis as assets grow</li>
                                </ul>

                                <p class="mb-8 mt-16"><strong>Step 4: Apply Capital Gains Tax</strong></p>
                                <ul class="list-indented-compact">
                                    <li>If Tax Modeling enabled, calculate LTCG tax on realized gains</li>
                                    <li>Tax is borrowed via SBLOC (added to LOC balance)</li>
                                    <li><strong>Example:</strong> $60k gain  23.8% LTCG rate = $14,280 tax  added to LOC</li>
                                    <li><strong>Double impact:</strong> You lose asset value AND increase LOC balance with tax</li>
                                </ul>

                                <p class="mb-8 mt-16"><strong>Step 5: Update Portfolio State</strong></p>
                                <ul class="list-indented-compact">
                                    <li>Portfolio Value: Reduced by liquidated amount</li>
                                    <li>LOC Balance: Reduced by sale proceeds, increased by taxes owed</li>
                                    <li>Cost Basis: Updated to reflect sold assets</li>
                                    <li><strong>Example:</strong> $3M portfolio  $2.79M; $2.1M LOC  $1.91M (after $200k paydown + $14k tax)</li>
                                </ul>

                                <p class="mb-8 mt-16"><strong>Step 6: Check if Still Over Limit</strong></p>
                                <ul class="list-indented-compact">
                                    <li>Recalculate LOC utilization after liquidation</li>
                                    <li>If still over Max Borrowing %, <strong>simulation fails</strong> (portfolio liquidated entirely)</li>
                                    <li>If back under limit, continue simulation but with reduced portfolio</li>
                                    <li><strong>Success check:</strong> $1.91M LOC  $2.79M portfolio = 68.5% (still over 65%  FAIL)</li>
                                </ul>
                            </div>

                            <p class="mt-16"><strong> Why Margin Calls Are Devastating:</strong></p>
                            <ul class="list-indented-spaced">
                                <li><strong>Haircut losses:</strong> 5% haircut on $200k liquidation = $10k immediate loss</li>
                                <li><strong>Tax consequences:</strong> Forced to realize capital gains and pay taxes now (vs never with BBD)</li>
                                <li><strong>Reduced portfolio:</strong> Smaller portfolio = less growth capacity, harder to recover</li>
                                <li><strong>Vicious cycle risk:</strong> If market continues down, you may trigger another margin call with less capital</li>
                                <li><strong>Permanent wealth destruction:</strong> Unlike market losses (which can recover), haircut losses are permanent</li>
                            </ul>

                            <p class="mt-16"><strong> How to Avoid Margin Calls:</strong></p>
                            <ul class="list-indented">
                                <li><strong>Conservative Max Borrowing:</strong> Use 50-55% instead of 65-70%</li>
                                <li><strong>Larger starting capital:</strong> More cushion relative to withdrawals</li>
                                <li><strong>Lower withdrawal rate:</strong> 3-4% of portfolio value instead of 5-6%</li>
                                <li><strong>Watch Maintenance Margin:</strong> When you hit this threshold, consider reducing withdrawals voluntarily</li>
                                <li><strong>Use Liquidity Stress Testing:</strong> Monte Carlo mode shows "distance to margin call" - aim for 20%+ buffer</li>
                            </ul>

                            <p class="mt-16"><strong> Margin Call in Monte Carlo Results:</strong></p>
                            <ul class="list-indented">
                                <li><strong>Margin Call Rate:</strong> % of simulations that experienced at least one margin call</li>
                                <li><strong>Margin Call Risk by Year:</strong> Chart showing which years are most dangerous</li>
                                <li><strong>Success Rate:</strong> Only counts scenarios with NO margin calls and positive final net worth</li>
                            </ul>
                        </div>

                        <div class="instruction-item">
                            <h4> Glossary: Key Financial Terms</h4>

                            <div class="ml-20">
                                <p class="mb-8"><strong>SBLOC (Securities-Backed Line of Credit)</strong></p>
                                <p class="ml-20 mb-12" style="font-size: 0.95em;">A revolving credit line secured by your investment portfolio. You can borrow up to a certain percentage of your portfolio value (typically 50-70%) at interest rates usually 2-4% above prime rate. Used in BBD strategy to fund withdrawals without selling assets.</p>

                                <p class="mb-8"><strong>Buy Borrow Die Strategy</strong></p>
                                <p class="ml-20 mb-12" style="font-size: 0.95em;"><strong>Buy:</strong> Accumulate appreciating assets. <strong>Borrow:</strong> Use SBLOC to fund living expenses without selling. <strong>Die:</strong> Heirs receive step-up basis, eliminating capital gains tax on inherited assets. Strategy maximizes wealth transfer by never realizing gains during lifetime.</p>

                                <p class="mb-8"><strong>Step-Up Basis</strong></p>
                                <p class="ml-20 mb-12" style="font-size: 0.95em;">Tax provision where inherited assets have their cost basis reset to fair market value at death. Eliminates all unrealized capital gains. <strong>Example:</strong> You buy stock at $100k, it grows to $5M. You borrow against it. You die. Heirs inherit at $5M basis, paying zero capital gains tax on the $4.9M gain.</p>

                                <p class="mb-8"><strong>Margin Call</strong></p>
                                <p class="ml-20 mb-12" style="font-size: 0.95em;">Demand from lender to reduce loan balance when it exceeds maximum allowed percentage of portfolio value. Triggers forced liquidation of assets to pay down debt. Most damaging event in BBD strategy.</p>

                                <p class="mb-8"><strong>Maintenance Margin</strong></p>
                                <p class="ml-20 mb-12" style="font-size: 0.95em;">Warning threshold before margin call. When LOC utilization reaches this level, you're in danger zone but not yet forced to liquidate. Smart strategy: voluntarily reduce withdrawals when hitting maintenance margin.</p>

                                <p class="mb-8"><strong>Liquidation Haircut</strong></p>
                                <p class="ml-20 mb-12" style="font-size: 0.95em;">Percentage of value lost during forced asset sales due to market impact, bid-ask spreads, transaction costs, and urgency discounts. Typical range: 3-10%. Represents permanent wealth destruction.</p>

                                <p class="mb-8"><strong>LTCG (Long-Term Capital Gains)</strong></p>
                                <p class="ml-20 mb-12" style="font-size: 0.95em;">Tax on profits from selling assets held >1 year. Federal rates: 0%, 15%, or 20% based on income. Plus 3.8% NIIT (Net Investment Income Tax) for high earners. State taxes additional. BBD strategy defers this tax until death (step-up basis).</p>

                                <p class="mb-8"><strong>CAGR (Compound Annual Growth Rate)</strong></p>
                                <p class="ml-20 mb-12" style="font-size: 0.95em;">Geometric average return per year over multiple years. <strong>Formula:</strong> ((Ending Value / Beginning Value)^(1/Years)) - 1. More accurate than arithmetic average for investment returns. <strong>Example:</strong> $1M  $2.59M in 10 years = 10% CAGR.</p>

                                <p class="mb-8"><strong>Monte Carlo Simulation</strong></p>
                                <p class="ml-20 mb-12" style="font-size: 0.95em;">Statistical method that runs thousands of scenarios with randomized returns based on historical data. Produces probability distributions showing range of possible outcomes. Shows success rate, percentile paths (10th/50th/90th), and margin call risk.</p>

                                <p class="mb-8"><strong>Percentile (Path-Coherent)</strong></p>
                                <p class="ml-20 mb-12" style="font-size: 0.95em;">Industry-standard method for displaying Monte Carlo results. Each percentile line represents ONE complete simulation path ranked by terminal net worth. <strong>50th percentile:</strong> median outcome (half ended better, half worse). Not an average - it's a real scenario.</p>

                                <p class="mb-8"><strong>Bootstrap Sampling</strong></p>
                                <p class="ml-20 mb-12" style="font-size: 0.95em;">Statistical technique for Monte Carlo that randomly samples historical returns with replacement. Simple approach: each simulation year picks a random year from history. Assumes future resembles past.</p>

                                <p class="mb-8"><strong>Survivorship Bias</strong></p>
                                <p class="ml-20 mb-12" style="font-size: 0.95em;">Statistical distortion where successful assets are overrepresented because failed assets disappear from datasets. <strong>Example:</strong> S&P500 excludes bankrupt companies, inflating historical returns. Fat-Tailed model corrects with -3% mean adjustment.</p>

                                <p class="mb-8"><strong>Correlation</strong></p>
                                <p class="ml-20 mb-12" style="font-size: 0.95em;">Statistical measure (-1 to +1) of how two assets move together. <strong>+1:</strong> Perfect positive (move in lockstep). <strong>0:</strong> Uncorrelated. <strong>-1:</strong> Perfect negative (move opposite). Lower correlation = better diversification.</p>

                                <p class="mb-8"><strong>Fat-Tailed Distribution</strong></p>
                                <p class="ml-20 mb-12" style="font-size: 0.95em;">Statistical distribution (Student's t-distribution) that generates extreme events (crashes, booms) more frequently than normal distribution. Used in Monte Carlo to model realistic tail risk. Includes survivorship bias correction and negative skew (crashes worse than equivalent rallies).</p>
                            </div>
                        </div>

                        <div class="instruction-item">
                            <h4> Common Scenarios & Recommended Settings</h4>

                            <p class="mb-16"><strong>Use these as starting points, then adjust based on your results and risk tolerance:</strong></p>

                            <div class="ml-20">
                                <p class="mb-8"><strong>Scenario 1: Conservative Retirement (Target: 85%+ Success Rate)</strong></p>
                                <ul class="list-indented-compact">
                                    <li><strong>Starting Portfolio:</strong> $3,000,000+</li>
                                    <li><strong>Annual Withdrawal:</strong> $120,000 (4% of portfolio)</li>
                                    <li><strong>SBLOC Max Borrowing:</strong> 50% (conservative)</li>
                                    <li><strong>Maintenance Margin:</strong> 40%</li>
                                    <li><strong>Portfolio:</strong> 70% S&P500, 20% Microsoft, 10% Coca Cola (stable, diversified)</li>
                                    <li><strong>Return Model:</strong> Fat-Tailed Distribution (most conservative)</li>
                                    <li><strong>Rationale:</strong> Low withdrawal rate + conservative leverage + diversification = high success rate</li>
                                </ul>

                                <p class="mb-8 mt-16"><strong>Scenario 2: Aggressive Growth (Higher Risk, Higher Reward)</strong></p>
                                <ul class="list-indented-compact">
                                    <li><strong>Starting Portfolio:</strong> $5,000,000+</li>
                                    <li><strong>Annual Withdrawal:</strong> $300,000 (6% of portfolio)</li>
                                    <li><strong>SBLOC Max Borrowing:</strong> 65% (aggressive)</li>
                                    <li><strong>Maintenance Margin:</strong> 55%</li>
                                    <li><strong>Portfolio:</strong> 50% Nvidia, 30% Microsoft, 20% QQQ (tech-heavy)</li>
                                    <li><strong>Return Model:</strong> Regime-Switching (models boom/bust cycles)</li>
                                    <li><strong>Expected Outcome:</strong> 60-75% success rate, but much higher terminal wealth in successful scenarios</li>
                                    <li><strong>Rationale:</strong> Larger capital buffer allows higher withdrawals and leverage</li>
                                </ul>

                                <p class="mb-8 mt-16"><strong>Scenario 3: Tax-Advantaged Account (Roth IRA / 401k)</strong></p>
                                <ul class="list-indented-compact">
                                    <li><strong>Starting Portfolio:</strong> $2,500,000</li>
                                    <li><strong>Annual Withdrawal:</strong> $100,000</li>
                                    <li><strong>SBLOC Max Borrowing:</strong> 60%</li>
                                    <li><strong>Tax Modeling:</strong> Enabled, Tax-Advantaged Account checked</li>
                                    <li><strong>Portfolio:</strong> 40% S&P500, 30% Apple, 30% Amazon</li>
                                    <li><strong>Benefit:</strong> No dividend taxes  10-15% higher success rate vs taxable account</li>
                                    <li><strong>Note:</strong> Compare results with/without tax-advantaged checkbox to see impact</li>
                                </ul>

                                <p class="mb-8 mt-16"><strong>Scenario 4: Declining Withdrawal (Retirement Phases)</strong></p>
                                <ul class="list-indented-compact">
                                    <li><strong>Starting Portfolio:</strong> $4,000,000</li>
                                    <li><strong>Chapter 1 (Years 1-15):</strong> $200,000/year (active retirement - travel, activities)</li>
                                    <li><strong>Chapter 2 (Years 16-25):</strong> 30% reduction  $140,000/year (less active)</li>
                                    <li><strong>Chapter 3 (Years 26+):</strong> 40% reduction  $84,000/year (final years)</li>
                                    <li><strong>Enable Withdrawal Chapters:</strong> Yes</li>
                                    <li><strong>Rationale:</strong> Spending typically declines with age; models realistic retirement trajectory</li>
                                </ul>

                                <p class="mb-8 mt-16"><strong>Scenario 5: Portfolio Comparison Test</strong></p>
                                <ul class="list-indented-compact">
                                    <li><strong>Purpose:</strong> Compare concentrated vs diversified portfolios</li>
                                    <li><strong>Test A:</strong> 100% Nvidia (single asset mode)</li>
                                    <li><strong>Test B:</strong> 100% S&P500 (single asset mode)</li>
                                    <li><strong>Test C:</strong> 33% Nvidia, 33% S&P500, 34% Microsoft (Monte Carlo mode)</li>
                                    <li><strong>Same settings:</strong> $3M start, $150k withdrawal, 65% max borrowing</li>
                                    <li><strong>Compare:</strong> Success rate, margin call risk, terminal net worth</li>
                                    <li><strong>Expected Finding:</strong> Diversified portfolio (C) has highest success rate but may have lower best-case outcome</li>
                                </ul>
                            </div>
                        </div>

                        <div class="instruction-item">
                            <h4> Troubleshooting & FAQ</h4>

                            <p class="mb-16"><strong>Common Issues and Solutions:</strong></p>

                            <div class="ml-20">
                                <p class="mb-8"><strong> "Portfolio weights must total exactly 100%"</strong></p>
                                <p class="ml-20 mb-12" style="font-size: 0.95em;"><strong>Problem:</strong> Monte Carlo requires precise weight allocation.<br>
                                <strong>Solution:</strong> Click "Balance Weights" button to auto-distribute equally, or manually adjust until total shows 100.0% in green.</p>

                                <p class="mb-8"><strong> "API connection failed" or "CORS error"</strong></p>
                                <p class="ml-20 mb-12" style="font-size: 0.95em;"><strong>Problem:</strong> Browser blocking API request or invalid API key.<br>
                                <strong>Solution 1:</strong> Check API key is correct (test connection in Settings).<br>
                                <strong>Solution 2:</strong> Configure CORS proxy (Settings  CORS Proxy  use preset button).<br>
                                <strong>Solution 3:</strong> Switch to different data source or use Manual Entry.</p>

                                <p class="mb-8"><strong> "Not enough historical data for simulation period"</strong></p>
                                <p class="ml-20 mb-12" style="font-size: 0.95em;"><strong>Problem:</strong> Period (years) exceeds available historical data.<br>
                                <strong>Solution:</strong> Reduce "Period (Years)" setting, or use asset with longer history (S&P500 has most data).</p>

                                <p class="mb-8"><strong> "Success rate is 0% - all simulations failed"</strong></p>
                                <p class="ml-20 mb-12" style="font-size: 0.95em;"><strong>Problem:</strong> Withdrawal rate too high or leverage too aggressive.<br>
                                <strong>Solution 1:</strong> Reduce annual withdrawal by 20-30%.<br>
                                <strong>Solution 2:</strong> Reduce Max Borrowing % from 65% to 50%.<br>
                                <strong>Solution 3:</strong> Increase starting portfolio value.<br>
                                <strong>Solution 4:</strong> Switch to more conservative return model (Fat-Tailed).</p>

                                <p class="mb-8"><strong> "Simulation running very slowly"</strong></p>
                                <p class="ml-20 mb-12" style="font-size: 0.95em;"><strong>Problem:</strong> Too many simulations or long period.<br>
                                <strong>Solution:</strong> Reduce from 10,000 to 5,000 simulations (still accurate), or use shorter period for initial testing.</p>

                                <p class="mb-8"><strong> "Implied CAGR shows >20% - is this realistic?"</strong></p>
                                <p class="ml-20 mb-12" style="font-size: 0.95em;"><strong>Problem:</strong> Very high success rate may indicate survivorship bias in concentrated portfolios.<br>
                                <strong>Solution:</strong> Use Fat-Tailed Distribution model (includes -3% survivorship bias correction) or diversify portfolio.</p>

                                <p class="mb-8 mt-16"><strong> Frequently Asked Questions:</strong></p>

                                <p class="mb-6 mt-12"><strong>Q: Should I use Monte Carlo or Single Asset mode?</strong></p>
                                <p class="ml-20 mb-12" style="font-size: 0.95em;"><strong>A:</strong> Use Monte Carlo for realistic planning (shows probability distributions and risk). Use Single Asset for exploring specific historical scenarios or understanding one particular path.</p>

                                <p class="mb-6"><strong>Q: What's a good success rate target?</strong></p>
                                <p class="ml-20 mb-12" style="font-size: 0.95em;"><strong>A:</strong> Aim for 80%+ for confidence. 70-80% is acceptable with lower risk tolerance. Below 70% is too risky for retirement planning.</p>

                                <p class="mb-6"><strong>Q: Why is my Sell Assets terminal value lower than BBD?</strong></p>
                                <p class="ml-20 mb-12" style="font-size: 0.95em;"><strong>A:</strong> BBD keeps portfolio fully invested (only borrows). Sell Assets reduces portfolio size each year (sells assets). Plus BBD avoids annual capital gains taxes.</p>

                                <p class="mb-6"><strong>Q: Should I use monthly or annual withdrawals?</strong></p>
                                <p class="ml-20 mb-12" style="font-size: 0.95em;"><strong>A:</strong> Monthly is more realistic (matches actual spending) and slightly more conservative (interest/growth compounds monthly). Use annual only for simplified modeling.</p>

                                <p class="mb-6"><strong>Q: How do I compare different portfolios?</strong></p>
                                <p class="ml-20 mb-12" style="font-size: 0.95em;"><strong>A:</strong> Use Portfolio Presets to save configurations. Run simulation for Portfolio A, note success rate. Load Portfolio B preset, run simulation, compare results. Keep all other settings identical.</p>

                                <p class="mb-6"><strong>Q: What SBLOC interest rate should I use?</strong></p>
                                <p class="ml-20 mb-12" style="font-size: 0.95em;"><strong>A:</strong> Check with lenders (typically 6-9% in 2024-2025). Use higher rates for conservative planning. Remember: portfolio must outperform this rate for BBD strategy to work.</p>
                            </div>
                        </div>

                        <div class="instructions-footer">
                            <button class="button button-primary" onclick="toggleFieldInstructions('single')">
                                Close Instructions
                            </button>
                        </div>
                    </div>

                    <!-- Monte Carlo Field Instructions (Hidden by default) -->
                    <div id="fieldInstructionsMonteCarlo" class="field-instructions hidden">
                        <div class="instructions-header">
                            <h3> Monte Carlo Parameter Guide</h3>
                            <p>Understanding probabilistic simulation settings and portfolio configuration for Monte Carlo analysis.</p>
                        </div>

                        <div class="instruction-item">
                            <h4>What is Monte Carlo Simulation?</h4>
                            <p><strong>Purpose:</strong> Monte Carlo simulation runs thousands of different scenarios using random sampling from historical data to understand the range of possible outcomes.</p>
                            <p><strong>Why use it:</strong> Instead of showing one deterministic path (Single Asset mode), Monte Carlo shows you probability distributions, success rates, and worst/best case scenarios.</p>
                            <p><strong>Key insight:</strong> You'll see percentile outcomes (10th, 50th, 90th) showing what happens in pessimistic, median, and optimistic scenarios.</p>
                        </div>

                        <div class="instruction-item">
                            <h4>Number of Simulations</h4>
                            <p><strong>Purpose:</strong> How many probabilistic scenarios to run.</p>
                            <p><strong>Options:</strong></p>
                            <ul class="list-indented">
                                <li><strong>1,000 (Fast):</strong> Quick results, less precise (~2-3 seconds)</li>
                                <li><strong>5,000 (Recommended):</strong> Good balance of speed and accuracy (~5-6 seconds)</li>
                                <li><strong>10,000 (Precise):</strong> Most accurate probability estimates (~10-12 seconds)</li>
                            </ul>
                            <p><strong>Recommendation:</strong> Use 5,000 for most analyses. Use 10,000 for final decision-making when high precision matters.</p>
                            <p><strong>What happens:</strong> Each simulation randomly samples from historical returns for each asset and runs the entire BBD strategy simulation, giving you thousands of different outcome paths.</p>
                        </div>

                        <div class="instruction-item">
                            <h4> Expected Annual Inflation (%)</h4>
                            <p><strong>Purpose:</strong> Adjust all dollar values in the results to account for the decreasing purchasing power of money over time (inflation).</p>

                            <p><strong>Default:</strong> 2.5% (typical long-term US inflation rate)</p>

                            <p><strong>How it works:</strong> When inflation is enabled, all displayed values (portfolio value, withdrawals, net worth) can be viewed in "real" (inflation-adjusted) terms rather than "nominal" (face value) terms. For example, $1,000,000 in 20 years has less purchasing power than $1,000,000 today.</p>

                            <p><strong>Examples:</strong></p>
                            <ul class="list-indented">
                                <li><strong>2.5% inflation (typical):</strong> $1M today  $610k purchasing power in 20 years</li>
                                <li><strong>3.5% inflation (elevated):</strong> $1M today  $500k purchasing power in 20 years</li>
                                <li><strong>1.5% inflation (low):</strong> $1M today  $740k purchasing power in 20 years</li>
                            </ul>

                            <p><strong>When to adjust:</strong> Use 3-4% if you expect higher inflation (recent environment), or 1.5-2% if you expect lower inflation (historical pre-2020 average).</p>

                            <p><strong> Important:</strong> Even if your portfolio grows at 10% annually, your "real" growth rate after 2.5% inflation is only ~7.5%. This parameter helps you understand whether your strategy maintains purchasing power over time.</p>
                        </div>

                        <div class="instruction-item">
                            <h4>Portfolio Composition</h4>
                            <p><strong>Purpose:</strong> Select multiple assets to create a diversified portfolio rather than investing in a single asset.</p>
                            <p><strong>How to use:</strong></p>
                            <ol class="ml-20-lh-2">
                                <li>Click the dropdown to see available assets (same preset assets from Single Asset mode)</li>
                                <li>Select an asset and click the <strong>+</strong> button to add it</li>
                                <li>Repeat to add 2-5 assets (diversification works best with 3-5)</li>
                                <li>Remove assets by clicking the <strong></strong> button next to each asset</li>
                            </ol>
                            <p><strong>Tip:</strong> Mix asset types for better diversification (e.g., tech stocks + indexes + consumer stocks).</p>
                        </div>

                        <div class="instruction-item">
                            <h4>Portfolio Presets (Save & Load)</h4>
                            <p><strong>Purpose:</strong> Save your portfolio compositions to quickly reload them later without manually re-selecting assets and weights.</p>
                            <p><strong>How to use:</strong></p>
                            <ol class="ml-20-lh-2">
                                <li>Configure your portfolio with assets and weights totaling 100%</li>
                                <li>Click the <strong> Save</strong> button and enter a name for your preset</li>
                                <li>Your portfolio is saved to browser storage and appears in the dropdown</li>
                                <li>Later, select a preset from the dropdown and click <strong> Load</strong> to restore it</li>
                                <li>Click <strong> Delete</strong> to remove unwanted presets</li>
                            </ol>
                            <p><strong>Examples of useful presets:</strong></p>
                            <ul class="list-indented">
                                <li><strong>Tech Heavy:</strong> 60% Microsoft, 20% Apple, 20% Nvidia</li>
                                <li><strong>Balanced 4-Stock:</strong> 25% each of McDonald's, Microsoft, Qualcomm, Walmart</li>
                                <li><strong>Conservative:</strong> 70% S&P500, 15% Apple, 15% Microsoft</li>
                            </ul>
                            <p><strong>Auto-save feature:</strong> The app automatically saves your last portfolio configuration. When you switch back to Monte Carlo mode, it will be restored if your portfolio is empty.</p>
                            <p><strong>Storage:</strong> Presets are stored in your browser's localStorage and persist across sessions. They're only available on this device/browser.</p>
                            <p><strong>Tip:</strong> Name your presets descriptively (e.g., "Aggressive Tech 2025" or "Retirement Conservative") to easily identify them later.</p>
                        </div>

                        <div class="instruction-item">
                            <h4>Portfolio Weights</h4>
                            <p><strong>Purpose:</strong> Define what percentage of your portfolio is allocated to each asset.</p>
                            <p><strong>Requirement:</strong> Weights MUST total exactly 100%</p>
                            <p><strong>How to set:</strong> Enter percentage values (0-100) in the weight field next to each asset.</p>
                            <p><strong>Examples:</strong></p>
                            <ul class="list-indented">
                                <li><strong>Equal weight:</strong> 3 assets  33.33% each = 100%</li>
                                <li><strong>Tilted:</strong> Microsoft 50%, Apple 30%, S&P500 20%</li>
                                <li><strong>Conservative:</strong> 70% S&P500, 15% Microsoft, 15% Apple</li>
                            </ul>
                            <p><strong>Visual feedback:</strong> The weight distribution bar shows color-coded segments for each asset. The total label turns green when exactly 100%, orange otherwise.</p>
                        </div>

                        <div class="instruction-item">
                            <h4>Balance Weights Button</h4>
                            <p><strong>Purpose:</strong> Quickly distribute weights equally across all selected assets.</p>
                            <p><strong>How it works:</strong> Divides 100% evenly among your assets.</p>
                            <p><strong>Example:</strong></p>
                            <ul class="list-indented">
                                <li>3 assets  Each gets 33.33%</li>
                                <li>4 assets  Each gets 25%</li>
                                <li>5 assets  Each gets 20%</li>
                            </ul>
                            <p><strong>Tip:</strong> Use this as a starting point, then manually adjust for your preferences.</p>
                        </div>

                        <div class="instruction-item">
                            <h4>Asset Correlation Matrix</h4>
                            <p><strong>Purpose:</strong> Shows how your selected assets move together historically (correlation coefficient from -1 to +1).</p>
                            <p><strong>When it appears:</strong> Automatically shown when you have 2 or more assets selected.</p>
                            <p><strong>How to read:</strong></p>
                            <ul class="list-indented">
                                <li><strong>1.00 (Dark Green):</strong> Perfect correlation - assets move together</li>
                                <li><strong>0.50-0.99 (Light Green):</strong> Moderate-high positive correlation</li>
                                <li><strong>0.00-0.49 (Yellow/White):</strong> Low correlation - some diversification benefit</li>
                                <li><strong>-0.01 to -0.99 (Red):</strong> Negative correlation - assets move opposite (rare, excellent for diversification)</li>
                            </ul>
                            <p><strong>Diversification tip:</strong> Lower correlations provide better diversification. Avoid portfolios where all assets have 0.90+ correlation (too similar).</p>
                            <p><strong>Example:</strong> If Microsoft and Apple have 0.85 correlation, they tend to move together (both tech stocks), so they don't diversify each other much.</p>
                        </div>

                        <div class="instruction-item">
                            <h4>Return Distribution Model</h4>
                            <p><strong>Purpose:</strong> Controls how asset returns are generated across thousands of simulations to model different types of market behavior.</p>
                            <p><strong>Options:</strong></p>

                            <div class="ml-20-mb-16">
                                <p class="mb-8"><strong>1. Historical Bootstrap (Default)</strong></p>
                                <ul class="list-indented-spaced">
                                    <li><strong>How it works:</strong> Randomly samples actual historical returns with replacement</li>
                                    <li><strong>Pros:</strong> Simple, uses real observed returns</li>
                                    <li><strong>Cons:</strong> Assumes future will resemble past exactly; may miss extreme events not in data; vulnerable to survivorship bias</li>
                                    <li><strong>Best for:</strong> Stable assets with long historical data (e.g., S&P500)</li>
                                </ul>
                            </div>

                            <div class="ml-20-mb-16">
                                <p class="mb-8"><strong>2. Regime-Switching (Bull/Bear/Crash/Recovery)  Recommended for Long-Term Planning</strong></p>

                                <div style="background: linear-gradient(135deg, rgba(0, 76, 69, 0.08) 0%, rgba(0, 76, 69, 0.04) 100%); border-left: 3px solid #004C45; padding: 16px 20px; border-radius: 6px; margin-bottom: 20px;">
                                    <p style="margin: 0; font-weight: 500; color: #1a1a1a;"><strong>Overview:</strong> Models four distinct market regimes using a Markov chain. Two calibration modes are available: <strong>Historical Mode</strong> (calibrated to S&P 500 1950-2024 data, recommended for baseline planning) and <strong>Conservative Mode</strong> (stress-testing parameters with extended crash durations).</p>
                                </div>

                                <!-- Mode Comparison Callout -->
                                <div class="regime-mode-comparison-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                                    <div style="background: rgba(59, 130, 246, 0.08); padding: 16px; border-radius: 8px; border-left: 4px solid #3B82F6;">
                                        <p style="margin: 0 0 8px 0; font-weight: 700; color: #1e40af;"> Historical Mode</p>
                                        <ul style="margin: 0; padding-left: 18px; font-size: 13px; line-height: 1.6;">
                                            <li>Median 30yr CAGR: ~7-8%</li>
                                            <li>P(Loss over 30yr): ~15-18%</li>
                                            <li>Crash duration: ~1 year</li>
                                            <li><em>Best for:</em> Baseline retirement planning</li>
                                        </ul>
                                    </div>
                                    <div style="background: rgba(234, 179, 8, 0.08); padding: 16px; border-radius: 8px; border-left: 4px solid #EAB308;">
                                        <p style="margin: 0 0 8px 0; font-weight: 700; color: #854d0e;"> Conservative Mode</p>
                                        <ul style="margin: 0; padding-left: 18px; font-size: 13px; line-height: 1.6;">
                                            <li>Median 30yr CAGR: ~3%</li>
                                            <li>P(Loss over 30yr): ~36%</li>
                                            <li>Crash duration: ~1.5 years</li>
                                            <li><em>Best for:</em> Stress-testing, worst-case analysis</li>
                                        </ul>
                                    </div>
                                </div>

                                <ul class="list-indented-spaced">
                                    <li><strong>The Four Market Regimes:</strong>
                                        <ul class="ml-30-mt-8" style="line-height: 1.8;">
                                            <li><strong> Bull Market (89% persistence, ~9 year duration):</strong> Normal growth periods. Uses full historical mean returns with 25% lower volatility (0.75x). Represents expansion cycles like 2009-2020 or 2003-2007. Low correlation between assets.</li>

                                            <li><strong> Bear Market (45% persistence, ~1.8 year duration):</strong> Moderate sustained decline like 2000-2002 or 2022. Retains 25% of historical mean (quality stocks still have edge) with -12% absolute penalty. Elevated volatility (1.8x) and rising correlations (0.40) as markets become more synchronized.</li>

                                            <li><strong> Crash State (variable persistence):</strong> Acute market dislocations like 2008 GFC or March 2020. Historical mean becomes irrelevant (0% multiplier), replaced by severe drawdown. Extreme volatility and near-perfect correlation as "all correlations go to 1" during panic. <em>Historical Mode:</em> ~1 year duration (10% persistence). <em>Conservative Mode:</em> ~1.5 year duration (35% persistence).</li>

                                            <li><strong> Recovery Phase (45% persistence, ~1.8 year duration):</strong> Post-crisis rebuilding with uncertainty. Returns recovering toward normal (70% of historical mean) with +8% bounce-back bias. Still-elevated volatility (1.4x) as markets stabilize. Correlations normalizing (0.25).</li>
                                        </ul>
                                    </li>

                                    <li style="margin-top: 20px;"><strong>Regime Transition Probabilities (Annual):</strong>

                                        <div class="regime-mode-comparison-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 12px;">
                                            <!-- Historical Mode Transitions -->
                                            <div>
                                                <p style="font-weight: 600; color: #1e40af; margin-bottom: 8px;"> Historical Mode</p>
                                                <div style="font-family: 'SF Mono', 'Monaco', 'Consolas', monospace; font-size: 12px; line-height: 1.8; background: rgba(59, 130, 246, 0.06); padding: 12px 14px; border-radius: 6px; border: 1px solid rgba(59, 130, 246, 0.15);">
                                                    <div><strong>Bull     </strong> Bull 89% | Bear 6%  | Crash 2%  | Recov 3%</div>
                                                    <div><strong>Bear     </strong> Bull 5%  | Bear 45% | Crash 20% | Recov 30%</div>
                                                    <div><strong>Crash    </strong> Bull 0%  | Bear 20% | Crash 10% | Recov 70%</div>
                                                    <div><strong>Recovery </strong> Bull 50% | Bear 5%  | Crash 2%  | Recov 43%</div>
                                                </div>
                                            </div>
                                            <!-- Conservative Mode Transitions -->
                                            <div>
                                                <p style="font-weight: 600; color: #854d0e; margin-bottom: 8px;"> Conservative Mode</p>
                                                <div style="font-family: 'SF Mono', 'Monaco', 'Consolas', monospace; font-size: 12px; line-height: 1.8; background: rgba(234, 179, 8, 0.06); padding: 12px 14px; border-radius: 6px; border: 1px solid rgba(234, 179, 8, 0.15);">
                                                    <div><strong>Bull     </strong> Bull 89% | Bear 6%  | Crash 2%  | Recov 3%</div>
                                                    <div><strong>Bear     </strong> Bull 5%  | Bear 45% | Crash 20% | Recov 30%</div>
                                                    <div><strong>Crash    </strong> Bull 0%  | Bear 15% | Crash 35% | Recov 50%</div>
                                                    <div><strong>Recovery </strong> Bull 45% | Bear 8%  | Crash 2%  | Recov 45%</div>
                                                </div>
                                            </div>
                                        </div>

                                        <p class="mt-12" style="font-size: 13px; color: #666; font-style: italic;">Key difference: Historical Mode features faster crash exits (10% persistence vs 35%), producing more realistic recovery timelines.</p>
                                    </li>

                                    <li style="margin-top: 20px;"><strong>Base Regime Parameters (Conservative Mode):</strong>
                                        <div class="ml-30-mt-8">
                                            <!-- Desktop Table View -->
                                            <table class="regime-params-table-desktop" style="width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 8px; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.08); border-radius: 6px; overflow: hidden;">
                                                <thead>
                                                    <tr style="background: linear-gradient(135deg, #004C45 0%, #006b5f 100%); color: white; font-weight: 600;">
                                                        <th style="padding: 12px 14px; text-align: left; border-right: 1px solid rgba(255,255,255,0.15); color: white;">Regime</th>
                                                        <th style="padding: 12px 14px; text-align: center; border-right: 1px solid rgba(255,255,255,0.15); color: white;">Mean Multiplier</th>
                                                        <th style="padding: 12px 14px; text-align: center; border-right: 1px solid rgba(255,255,255,0.15); color: white;">Mean Adjustment</th>
                                                        <th style="padding: 12px 14px; text-align: center; border-right: 1px solid rgba(255,255,255,0.15); color: white;">Vol Multiplier</th>
                                                        <th style="padding: 12px 14px; text-align: center; color: white;">Correlation Spike</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr style="border-bottom: 1px solid #eee;">
                                                        <td style="padding: 10px 14px; font-weight: 600; color: #2d5016;"> Bull</td>
                                                        <td style="padding: 10px 14px; text-align: center;">1.00</td>
                                                        <td style="padding: 10px 14px; text-align: center;">0%</td>
                                                        <td style="padding: 10px 14px; text-align: center;">0.75x</td>
                                                        <td style="padding: 10px 14px; text-align: center;">0.00</td>
                                                    </tr>
                                                    <tr style="border-bottom: 1px solid #eee; background: rgba(234, 179, 8, 0.05);">
                                                        <td style="padding: 10px 14px; font-weight: 600; color: #a16207;"> Bear</td>
                                                        <td style="padding: 10px 14px; text-align: center;">0.25</td>
                                                        <td style="padding: 10px 14px; text-align: center; color: #c53030;">-12%</td>
                                                        <td style="padding: 10px 14px; text-align: center;">1.8x</td>
                                                        <td style="padding: 10px 14px; text-align: center;">+0.40</td>
                                                    </tr>
                                                    <tr style="border-bottom: 1px solid #eee; background: rgba(239, 68, 68, 0.08);">
                                                        <td style="padding: 10px 14px; font-weight: 600; color: #991b1b;"> Crash</td>
                                                        <td style="padding: 10px 14px; text-align: center;">0.00</td>
                                                        <td style="padding: 10px 14px; text-align: center; color: #991b1b; font-weight: 700;">-35%</td>
                                                        <td style="padding: 10px 14px; text-align: center; font-weight: 600;">3.0x</td>
                                                        <td style="padding: 10px 14px; text-align: center; font-weight: 600;">+0.70</td>
                                                    </tr>
                                                    <tr style="background: rgba(59, 130, 246, 0.05);">
                                                        <td style="padding: 10px 14px; font-weight: 600; color: #1e40af;"> Recovery</td>
                                                        <td style="padding: 10px 14px; text-align: center;">0.70</td>
                                                        <td style="padding: 10px 14px; text-align: center; color: #16a34a;">+8%</td>
                                                        <td style="padding: 10px 14px; text-align: center;">1.4x</td>
                                                        <td style="padding: 10px 14px; text-align: center;">+0.25</td>
                                                    </tr>
                                                </tbody>
                                            </table>

                                            <!-- Mobile Card View -->
                                            <div class="regime-params-cards-mobile">
                                                <!-- Bull Card -->
                                                <div class="regime-card" style="background: white; border-radius: 8px; padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); border-left: 4px solid #2d5016;">
                                                    <div style="font-weight: 700; font-size: 15px; color: #2d5016; margin-bottom: 12px;"> Bull Market</div>
                                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px;">
                                                        <div><span style="color: #666;">Mean Mult:</span> <strong>1.00</strong></div>
                                                        <div><span style="color: #666;">Mean Adj:</span> <strong>0%</strong></div>
                                                        <div><span style="color: #666;">Vol Mult:</span> <strong>0.75x</strong></div>
                                                        <div><span style="color: #666;">Corr Spike:</span> <strong>0.00</strong></div>
                                                    </div>
                                                </div>

                                                <!-- Bear Card -->
                                                <div class="regime-card" style="background: rgba(234, 179, 8, 0.05); border-radius: 8px; padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); border-left: 4px solid #a16207;">
                                                    <div style="font-weight: 700; font-size: 15px; color: #a16207; margin-bottom: 12px;"> Bear Market</div>
                                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px;">
                                                        <div><span style="color: #666;">Mean Mult:</span> <strong>0.25</strong></div>
                                                        <div><span style="color: #666;">Mean Adj:</span> <strong style="color: #c53030;">-12%</strong></div>
                                                        <div><span style="color: #666;">Vol Mult:</span> <strong>1.8x</strong></div>
                                                        <div><span style="color: #666;">Corr Spike:</span> <strong>+0.40</strong></div>
                                                    </div>
                                                </div>

                                                <!-- Crash Card -->
                                                <div class="regime-card" style="background: rgba(239, 68, 68, 0.08); border-radius: 8px; padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); border-left: 4px solid #991b1b;">
                                                    <div style="font-weight: 700; font-size: 15px; color: #991b1b; margin-bottom: 12px;"> Crash State</div>
                                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px;">
                                                        <div><span style="color: #666;">Mean Mult:</span> <strong>0.00</strong></div>
                                                        <div><span style="color: #666;">Mean Adj:</span> <strong style="color: #991b1b;">-35%</strong></div>
                                                        <div><span style="color: #666;">Vol Mult:</span> <strong>3.0x</strong></div>
                                                        <div><span style="color: #666;">Corr Spike:</span> <strong>+0.70</strong></div>
                                                    </div>
                                                </div>

                                                <!-- Recovery Card -->
                                                <div class="regime-card" style="background: rgba(59, 130, 246, 0.05); border-radius: 8px; padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); border-left: 4px solid #1e40af;">
                                                    <div style="font-weight: 700; font-size: 15px; color: #1e40af; margin-bottom: 12px;"> Recovery Phase</div>
                                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px;">
                                                        <div><span style="color: #666;">Mean Mult:</span> <strong>0.70</strong></div>
                                                        <div><span style="color: #666;">Mean Adj:</span> <strong style="color: #16a34a;">+8%</strong></div>
                                                        <div><span style="color: #666;">Vol Mult:</span> <strong>1.4x</strong></div>
                                                        <div><span style="color: #666;">Corr Spike:</span> <strong>+0.25</strong></div>
                                                    </div>
                                                </div>
                                            </div>

                                            <p class="mt-12" style="font-size: 13px; color: #666; line-height: 1.6;"><em>Mean Multiplier:</em> Fraction of historical mean to retain. <em>Mean Adjustment:</em> Absolute % added/subtracted. <em>Vol Multiplier:</em> Factor applied to historical volatility. <em>Correlation Spike:</em> Added to base correlation during regime.</p>
                                        </div>
                                    </li>

                                    <li style="margin-top: 20px;"><strong>Asset Class-Specific Overrides (Flight-to-Safety Dynamics):</strong>
                                        <p class="ml-30-mt-8" style="margin-bottom: 12px;">Different asset classes behave distinctly during Bear and Crash regimes, modeling real-world flight-to-safety patterns:</p>

                                        <div class="ml-30" style="background: rgba(234, 179, 8, 0.06); padding: 14px 18px; border-radius: 6px; margin-bottom: 12px; border-left: 3px solid #eab308;">
                                            <p style="margin: 0 0 10px 0; font-weight: 600; color: #854d0e;"> Bear Market Overrides (Moderate Decline):</p>
                                            <ul style="margin: 0; padding-left: 20px; line-height: 1.7; font-size: 13px;">
                                                <li><strong>Individual Stocks:</strong> 0.20 mean mult., -14% adjustment, 2.0x vol, +0.50 correlation (loses more alpha)</li>
                                                <li><strong>Market Indices:</strong> 0.25 mean mult., -12% adjustment, 1.8x vol, +0.40 correlation (base equity behavior)</li>
                                                <li><strong>Bonds:</strong> 1.0 mean mult., +4% adjustment, 1.3x vol, -0.15 correlation (rally in risk-off)</li>
                                                <li><strong>Commodities (Gold):</strong> 0.85 mean mult., +3% adjustment, 1.4x vol, +0.10 correlation (mild safe-haven)</li>
                                            </ul>
                                        </div>

                                        <div class="ml-30" style="background: rgba(239, 68, 68, 0.08); padding: 14px 18px; border-radius: 6px; border-left: 3px solid #ef4444;">
                                            <p style="margin: 0 0 10px 0; font-weight: 600; color: #991b1b;"> Crash Market Overrides (Acute Panic):</p>
                                            <ul style="margin: 0; padding-left: 20px; line-height: 1.7; font-size: 13px;">
                                                <li><strong>Individual Stocks:</strong> 0.0 mean mult., <strong style="color: #991b1b;">-42% adjustment</strong>, 3.5x vol, +0.80 correlation (worst hit)</li>
                                                <li><strong>Market Indices:</strong> 0.0 mean mult., -35% adjustment, 3.0x vol, +0.70 correlation (severe across board)</li>
                                                <li><strong>Bonds:</strong> 1.0 mean mult., <strong style="color: #16a34a;">+8% adjustment</strong>, 1.8x vol, -0.30 correlation (treasuries surge)</li>
                                                <li><strong>Commodities (Gold):</strong> 0.70 mean mult., <strong style="color: #16a34a;">+10% adjustment</strong>, 2.0x vol, +0.05 correlation (strong flight-to-safety)</li>
                                            </ul>
                                        </div>
                                    </li>

                                    <li style="margin-top: 20px;"><strong>Return Bounds:</strong> Returns clamped between -99% (portfolio retains 1% value, can recover) and +500% (generous ceiling for recovery rallies). Crash regime with 3.5x volatility on high-growth stocks can produce extreme draws; clamping ensures simulation stability.</li>

                                    <li style="margin-top: 16px;"><strong>Pros:</strong> Most realistic for long-term planning; captures distinct crash vs. bear dynamics; models flight-to-safety and correlation spikes; quality stocks retain partial edge in bears; bonds/gold behave appropriately; transition probabilities calibrated to historical data (1950-2024).</li>

                                    <li><strong>Cons:</strong> Still uses normal distribution (though bounded and regime-adjusted); requires understanding of regime parameters to interpret results; more complex than bootstrap.</li>

                                    <li><strong>Best for:</strong> Long-term planning (20-40 years) where experiencing multiple market cycles is likely; portfolios with mixed asset classes (stocks + bonds/gold); stress-testing against both prolonged downturns (bears) and acute crises (crashes); understanding how safe-haven assets provide downside protection.</li>
                                </ul>
                            </div>

                            <div class="ml-20-mb-16">
                                <p class="mb-8"><strong>3. Fat-Tailed Distribution (Most Conservative)  Recommended</strong></p>
                                <ul class="list-indented-spaced">
                                    <li><strong>How it works:</strong> Uses Student's t-distribution with <strong>asset class-specific</strong> enhancements for extreme risk modeling:
                                        <ul class="ml-30-mt-8">
                                            <li><strong>Survivorship bias correction:</strong> Reduces historical mean based on asset class (individual stocks: -4.5%, indices: -2.5%, commodities: -1.0%) to account for the fact that successful assets have inflated historical returns. Individual stocks penalized most heavily since many fail completely.</li>
                                            <li><strong>Tail risk amplification:</strong> Increases volatility by asset class (individual stocks: 25%, indices: 15%, commodities: 10%) to capture unobserved extreme events. Individual stocks get highest amplification due to idiosyncratic risk.</li>
                                            <li><strong>Negative skew:</strong> Makes market crashes (left tail) more severe than equivalent rallies (right tail), modeling asymmetric downside risk. Severity varies by asset class (stocks: 10-15% heavier left tail, commodities: 5%).</li>
                                            <li><strong>Heavy tails:</strong> Generates extreme events more frequently than normal distribution using asset class-specific degrees of freedom (individual stocks: df=4 fattest tails, indices: df=5, commodities: df=6 lighter tails).</li>
                                        </ul>
                                    </li>
                                    <li><strong>Pros:</strong> Most realistic for stress testing; accounts for survivorship bias by asset class; captures tail dependence; models asymmetric crash risk; heavily penalizes concentrated individual stock portfolios</li>
                                    <li><strong>Cons:</strong> Lower expected returns than other models; may seem "pessimistic" but this is intentional conservatism; individual stocks get especially harsh treatment</li>
                                    <li><strong>Best for:</strong> High-stakes planning (retirement SBLOC strategies); concentrated portfolios with growth stocks; when you want conservative estimates that account for "unknown unknowns"</li>
                                    <li><strong> Important:</strong> If you're using individual growth stocks (Nvidia, Tesla) and still see 20%+ CAGR even with Fat-Tailed model applying -4.5% survivorship penalty, this indicates genuine exceptional performance or remaining survivorship bias. Consider diversifying or using more conservative weights.</li>
                                </ul>
                            </div>

                            <div class="ml-20-mb-16" style="border-left: 3px solid #004C45; padding-left: 16px; margin-top: 24px;">
                                <p class="mb-8"><strong> How Asset Classes Affect Simulations</strong></p>

                                <p><strong>Available Asset Classes:</strong></p>
                                <ul class="list-indented-spaced">
                                    <li><strong>Individual Stocks (equity_stock):</strong> Single companies like Nvidia, Microsoft, AMD. Highest volatility and survivorship bias.</li>
                                    <li><strong>Market Indices (equity_index):</strong> QQQ, S&P 500. Lower risk than individual stocks due to diversification and automatic rebalancing.</li>
                                    <li><strong>Commodities (commodity):</strong> Gold (GLD). Often moves differently than stocks, providing diversification benefit.</li>
                                </ul>

                                <p class="mt-16"><strong>How Each Model Handles Asset Classes:</strong></p>

                                <p class="mb-8 mt-12"><em>1. Historical Bootstrap:</em></p>
                                <ul class="list-indented-spaced">
                                    <li><strong>Correlation Preservation:</strong> When you build a multi-asset portfolio (e.g., 80% Nvidia + 20% Gold), Bootstrap uses a <strong>shared year index</strong> to sample returns. This means if it picks 2008 data for Nvidia, it also uses 2008 data for Gold, preserving the historical correlation between assets.</li>
                                    <li><strong>Asset Class Treatment:</strong> Each asset samples from its own historical data. No special adjustments based on asset class.</li>
                                    <li><strong>Example:</strong> If stocks crashed in 2008 (-40%) and gold rallied (+5%), Bootstrap can reproduce this relationship by sampling the same historical year for both assets.</li>
                                </ul>

                                <p class="mb-8 mt-12"><em>2. Regime-Switching (Bull/Bear/Crash/Recovery):</em></p>
                                <ul class="list-indented-spaced">
                                    <li><strong>Asset Class Matters During Bear & Crash Regimes:</strong> Different asset classes behave distinctly during market stress, with crash regimes significantly more severe than bear markets:

                                        <div class="ml-30-mt-12" style="background: rgba(234, 179, 8, 0.06); padding: 12px 16px; border-radius: 6px; margin-bottom: 12px; border-left: 3px solid #eab308;">
                                            <p style="margin: 0 0 8px 0; font-weight: 600; color: #854d0e;"> Bear Markets (Moderate Sustained Decline):</p>
                                            <ul style="margin: 0; padding-left: 20px; line-height: 1.6; font-size: 13px;">
                                                <li><strong>Individual Stocks:</strong> 0.20 historical mean, -14% adjustment, 2.0 volatility, +0.50 correlation (lose more alpha)</li>
                                                <li><strong>Market Indices:</strong> 0.25 historical mean, -12% adjustment, 1.8 volatility, +0.40 correlation</li>
                                                <li><strong>Bonds:</strong> 1.0 historical mean, +4% adjustment, 1.3 volatility, -0.15 correlation (rally in risk-off)</li>
                                                <li><strong>Commodities (Gold):</strong> 0.85 historical mean, +3% adjustment, 1.4 volatility, +0.10 correlation</li>
                                            </ul>
                                        </div>

                                        <div class="ml-30" style="background: rgba(239, 68, 68, 0.08); padding: 12px 16px; border-radius: 6px; border-left: 3px solid #ef4444;">
                                            <p style="margin: 0 0 8px 0; font-weight: 600; color: #991b1b;"> Crash Regimes (Acute Panic):</p>
                                            <ul style="margin: 0; padding-left: 20px; line-height: 1.6; font-size: 13px;">
                                                <li><strong>Individual Stocks:</strong> 0.0 historical mean, <strong style="color: #991b1b;">-42% adjustment</strong>, 3.5 volatility, +0.80 correlation (worst hit)</li>
                                                <li><strong>Market Indices:</strong> 0.0 historical mean, -35% adjustment, 3.0 volatility, +0.70 correlation (severe)</li>
                                                <li><strong>Bonds:</strong> 1.0 historical mean, <strong style="color: #16a34a;">+8% adjustment</strong>, 1.8 volatility, -0.30 correlation (treasuries surge)</li>
                                                <li><strong>Commodities (Gold):</strong> 0.70 historical mean, <strong style="color: #16a34a;">+10% adjustment</strong>, 2.0 volatility, +0.05 correlation (strong safe-haven)</li>
                                            </ul>
                                        </div>
                                    </li>

                                    <li style="margin-top: 12px;"><strong>Bull & Recovery Markets:</strong> All equity assets use base regime parameters (no asset class overrides). Bonds and commodities still behave according to their asset class characteristics but without special flight-to-safety adjustments.</li>

                                    <li><strong>Example 1 - Bear Market:</strong> Your 80% Nvidia / 20% Gold portfolio during a bear year might see Nvidia drop ~-16% (0.215% - 14%) while Gold gains ~+3%, giving portfolio return = (0.8  -16%) + (0.2  +3%) = -12.2%.</li>

                                    <li><strong>Example 2 - Crash Regime:</strong> Same portfolio during a crash might see Nvidia plummet ~-42% while Gold surges ~+10%, giving portfolio return = (0.8  -42%) + (0.2  +10%) = -31.6%. The 20% gold allocation cushions the blow from -42% to -31.6%.</li>

                                    <li><strong>Key Insight:</strong> The 4-state model separates moderate bears (stocks retain some mean, gold mildly helps) from acute crashes (stocks collapse completely, safe-havens rally strongly). This more accurately models real crisis dynamics like 2008 and March 2020.</li>
                                </ul>

                                <p class="mb-8 mt-12"><em>3. Fat-Tailed Distribution (Most Conservative):</em></p>
                                <ul class="list-indented-spaced">
                                    <li><strong>Asset Class-Specific Risk Adjustments:</strong> Each asset class gets different conservative parameters reflecting its inherent risk characteristics:
                                        <ul class="ml-30-mt-8">
                                            <li><strong>Individual Stocks:</strong> -4.5% survivorship bias (many stocks fail; survivors are exceptional), 1.25x volatility, df=4 (fattest tails), 1.15x crash severity</li>
                                            <li><strong>Market Indices:</strong> -2.5% survivorship bias (auto-rebalanced, lower bias), 1.15x volatility, df=5 (standard fat tails), 1.10x crash severity</li>
                                            <li><strong>Commodities:</strong> -1.0% survivorship bias (gold always existed), 1.10x volatility, df=6 (lighter tails), 1.05x crash severity</li>
                                        </ul>
                                    </li>
                                    <li><strong>Why This Matters:</strong> A portfolio of 100% individual growth stocks gets hit with -4.5% mean reduction + 25% extra volatility + fatter crash tails. A portfolio of 50% stocks + 50% QQQ gets blended adjustments, making it more conservative.</li>
                                    <li><strong>Example:</strong> If Nvidia historically averaged 30% annually, Fat-Tailed adjusts it to ~25.5% (30% - 4.5%) with amplified volatility and more frequent extreme crashes. If QQQ averaged 12%, it adjusts to ~9.5% (12% - 2.5%) with less volatility amplification.</li>
                                    <li><strong> Survivorship Bias:</strong> Individual stocks like Nvidia, Tesla, Apple are in your dataset <em>because they succeeded</em>. Hundreds of other companies went bankrupt (Enron, Lehman, Pets.com). Fat-Tailed heavily penalizes individual stocks to account for this selection bias.</li>
                                </ul>

                                <p class="mt-16"><strong>Portfolio-Level Returns (All Models):</strong></p>
                                <ul class="list-indented-spaced">
                                    <li>Your portfolio return each simulated year is the <strong>weighted average</strong> of all your asset returns.</li>
                                    <li><strong>Formula:</strong> Portfolio Return = (Asset1 Weight  Asset1 Return) + (Asset2 Weight  Asset2 Return) + ...</li>
                                    <li><strong>Example:</strong> Portfolio = 70% Nvidia, 20% QQQ, 10% Gold
                                        <ul class="ml-30-mt-8">
                                            <li>Year 1 returns: Nvidia +45%, QQQ +18%, Gold -3%</li>
                                            <li>Portfolio return = (0.70  45%) + (0.20  18%) + (0.10  -3%) = 31.5% + 3.6% - 0.3% = <strong>34.8%</strong></li>
                                        </ul>
                                    </li>
                                </ul>

                                <p class="mt-16"><strong>Practical Guidance:</strong></p>
                                <ul class="list-indented-spaced">
                                    <li><strong>Diversify Asset Classes:</strong> Mixing stocks with commodities (gold) can reduce portfolio volatility during bear markets (especially with Regime-Switching model).</li>
                                    <li><strong>Individual Stocks Are Risky:</strong> Fat-Tailed model heavily penalizes portfolios concentrated in individual stocks due to survivorship bias. If you're 100% Nvidia and still see 20%+ CAGR with Fat-Tailed, consider diversifying.</li>
                                    <li><strong>Indices Are More Stable:</strong> QQQ, S&P 500 get lighter penalties in Fat-Tailed and suffer less in bear markets with Regime-Switching. Good for conservative strategies.</li>
                                    <li><strong>Test Your Mix:</strong> Run simulations with different asset class mixes (e.g., 100% stocks vs. 80% stocks + 20% gold) to see how diversification affects your success rate and margin call risk.</li>
                                </ul>
                            </div>

                            <p><strong>Which should you use?</strong></p>
                            <ul class="list-indented-spaced">
                                <li><strong>For initial exploration:</strong> Bootstrap (fastest, shows best-case scenario)</li>
                                <li><strong>For realistic planning:</strong> Regime-Switching (models market cycles)</li>
                                <li><strong>For conservative/final decisions:</strong> Fat-Tailed Distribution (most realistic risk modeling)</li>
                            </ul>
                            <p><strong>Tip:</strong> Run simulations with all three models to understand the range of outcomes. If your strategy only works with Bootstrap but fails with Fat-Tailed, it's too risky.</p>
                        </div>

                        <div class="instruction-item">
                            <h4>BBD Strategy Parameters (Shared)</h4>
                            <p><strong>Note:</strong> All BBD strategy parameters work the same way in Monte Carlo mode. Parameters are organized into four logical groups:</p>

                            <p style="margin-top: 12px; margin-bottom: 4px;"><strong>Starting Position</strong>  What you have now</p>
                            <ul class="list-indented">
                                <li>Asset Start Value ($)</li>
                                <li>LOC Balance ($)</li>
                            </ul>

                            <p style="margin-top: 12px; margin-bottom: 4px;"><strong>Timeline</strong>  When things happen</p>
                            <ul class="list-indented">
                                <li>Buy Borrow Die Start Year</li>
                                <li>Year to Start Withdrawal</li>
                                <li>Period (Years)</li>
                            </ul>

                            <p style="margin-top: 12px; margin-bottom: 4px;"><strong>Withdrawal Strategy</strong>  What you take out</p>
                            <ul class="list-indented">
                                <li>Total Annual Withdrawal ($)</li>
                                <li>Annual Percentage Raise (%)</li>
                                <li>Withdraw Monthly (checkbox)</li>
                                <li>Reduce Draw settings (optional)</li>
                            </ul>

                            <p style="margin-top: 12px; margin-bottom: 4px;"><strong>SBLOC Risk Parameters</strong>  Loan mechanics</p>
                            <ul class="list-indented">
                                <li>SBLOC Interest Rate (%)</li>
                                <li>SBLOC Max Borrowing % (Hard Margin Call)</li>
                                <li>Maintenance Margin % (Warning Zone)</li>
                                <li>Forced Liquidation Haircut %</li>
                            </ul>

                            <p><strong>Difference:</strong> In Monte Carlo mode, these parameters are applied across all simulations, but the portfolio returns vary randomly based on historical data.</p>
                            <p><strong>See Single Asset Field Guide</strong> (other toggle button above) for detailed explanations of each parameter.</p>
                        </div>

                        <div class="instruction-item">
                            <h4>Withdrawal Chapters (Optional)</h4>
                            <p><strong>Purpose:</strong> Define a multi-phase withdrawal strategy with different withdrawal amounts at different life stages.</p>
                            <p><strong>When to use:</strong> Model retirement scenarios where you withdraw more early (active years) and less later, or vice versa. Useful for part-time work phases or health-related changes.</p>
                            <p><strong>How it works:</strong></p>
                            <ul class="list-indented-spaced">
                                <li><strong>Chapter 1:</strong> Your initial withdrawal strategy (uses settings above)</li>
                                <li><strong>Chapter 2:</strong> Starts N years after Chapter 1, with a percentage reduction (or increase if negative)</li>
                                <li><strong>Chapter 3:</strong> Starts N years after Chapter 2, with another percentage adjustment</li>
                            </ul>
                            <p><strong>Configuration:</strong></p>
                            <ul class="list-indented-spaced">
                                <li><strong>Years After Chapter X:</strong> How many years until the next withdrawal phase begins</li>
                                <li><strong>Reduction (%):</strong> Percentage change to apply to withdrawal amount (negative values increase withdrawals)</li>
                            </ul>
                            <p><strong>Examples:</strong></p>
                            <ul class="list-indented-spaced">
                                <li><strong>Declining withdrawals:</strong> Chapter 1: $150k, Chapter 2 at year 15 (-30%): $105k, Chapter 3 at year 30 (-50% of Ch2): $52.5k. Models living expenses decrease with age.</li>
                                <li><strong>Increasing withdrawals:</strong> Use negative percentages to increase. Chapter 2 (-20%) increases $150k to $180k.</li>
                                <li><strong>Travel years:</strong> Chapter 1: $150k (retirement), Chapter 2: +50% for 5 years ($225k for travel), Chapter 3: back to $150k</li>
                            </ul>
                            <p><strong> Important:</strong> Each chapter's reduction is applied to the previous chapter's final amount, not the original. Enable the checkbox to use this feature.</p>
                            <p><strong>Monte Carlo advantage:</strong> See how different market cycles affect each withdrawal phase across thousands of scenarios. Identify vulnerable periods where your withdrawal chapter transitions coincide with market downturns.</p>
                        </div>

                        <div class="instruction-item">
                            <h4>Tax Modeling (Optional)</h4>
                            <p><strong>Purpose:</strong> Account for taxes on dividends and capital gains, showing the after-tax impact of your SBLOC strategy.</p>
                            <p><strong>When to use:</strong> Get realistic net-of-tax outcomes. Important for taxable accounts where dividend and capital gains taxes reduce your purchasing power.</p>
                            <p><strong>How it works:</strong> The simulator calculates annual dividend taxes on your portfolio and borrows via SBLOC to pay them (keeping portfolio fully invested). Capital gains taxes apply only when forced liquidations occur during margin calls.</p>
                            <p><strong>Configuration:</strong></p>
                            <ul class="list-indented-spaced">
                                <li><strong>Average Dividend Yield (%):</strong> Annual dividend income as % of portfolio value (typically 1-3% for growth stocks, 2-4% for dividend stocks)</li>
                                <li><strong>Ordinary Income Tax Rate (%):</strong> Your marginal tax rate on dividends (federal + state combined). Typical: 24-37% for high earners.</li>
                                <li><strong>Long-Term Capital Gains Tax Rate (%):</strong> Combined federal LTCG (0%, 15%, or 20%) + NIIT (3.8% if applicable). Common: 15-23.8%</li>
                                <li><strong>Tax-Advantaged Account:</strong> Check this if your portfolio is in a 401k, IRA, or other tax-sheltered account (dividends and gains not taxed)</li>
                            </ul>
                            <p><strong>Tax Impact Scenarios:</strong></p>
                            <ul class="list-indented-spaced">
                                <li><strong>Dividend cost:</strong> With 2% yield and 37% tax rate, you'll borrow ~0.74% of portfolio value annually to pay dividend taxes (added to SBLOC balance)</li>
                                <li><strong>Liquidation taxes:</strong> If a margin call forces you to sell at a $100k gain, you'll owe ~$15-23k in capital gains taxes, further straining liquidity</li>
                                <li><strong>Tax-advantaged benefit:</strong> Same portfolio in a Roth IRA avoids all these taxes, significantly improving success rate</li>
                            </ul>
                            <p><strong>Key Insight:</strong> In a true Buy Borrow Die strategy, you borrow to pay both living expenses AND dividend taxes, keeping your portfolio fully invested. This maximizes the step-up basis benefit at death but increases your SBLOC balance faster.</p>
                            <p><strong>Monte Carlo & Tax Efficiency:</strong> Run simulations comparing taxable vs. tax-advantaged accounts to quantify the impact. Across thousands of scenarios, you'll see the success rate difference between tax-efficient and tax-inefficient withdrawal strategies. This is particularly important for concentrated positions (high capital gains) or high-yield portfolios.</p>
                            <p><strong> Tip:</strong> Compare results with and without taxes enabled to understand the tax efficiency of your strategy. In tax-advantaged accounts, the strategy typically works better because you keep all gains.</p>
                        </div>

                        <div class="instruction-item">
                            <h4>Understanding Monte Carlo Results</h4>
                            <p><strong>Success Rate:</strong> Percentage of simulations that ended with positive net worth and no margin calls.</p>
                            <ul class="list-indented">
                                <li><strong>80%+ :</strong>  Excellent - Strategy is highly robust</li>
                                <li><strong>50-80%:</strong>  Moderate - Consider adjusting parameters</li>
                                <li><strong>&lt;50%:</strong>  High Risk - Reduce withdrawals or increase initial capital</li>
                            </ul>

                            <p class="mt-16"><strong>Percentile Outcomes (Path-Coherent):</strong></p>
                            <ul class="list-indented">
                                <li><strong>10th Percentile (Worst Case):</strong> One specific simulation path where only 10% of outcomes ended worse - shows the entire journey from start to finish</li>
                                <li><strong>50th Percentile (Median):</strong> One specific simulation path representing the middle outcome - this is a real path an investor could experience</li>
                                <li><strong>90th Percentile (Best Case):</strong> One specific simulation path where only 10% of outcomes ended better - shows the complete trajectory</li>
                            </ul>
                            <p style="margin-top: 12px; margin-left: 20px; font-size: 13px; color: var(--md-sys-color-on-surface-variant);">
                                <strong>Important:</strong> Each percentile line represents ONE complete simulation from start to finish, ranked by terminal (final) net worth. This matches industry standards used by Vanguard, MoneyGuidePro, and financial advisors. The median line, for example, is not an average - it's one actual path that could happen.</p>

                            <p class="mt-16"><strong>Charts Explained:</strong></p>
                            <ul class="list-indented">
                                <li><strong>Net Worth Percentiles (Probability Cone):</strong> Shows how net worth evolves over time for different percentiles (cone of uncertainty)</li>
                                <li><strong>SBLOC Utilization Percentiles:</strong> Shows SBLOC borrowing % over time with max borrowing limit line</li>
                                <li><strong>Net Worth Across Simulations:</strong> Probability cone chart showing the full range of net worth outcomes (10th-90th percentiles) with filled bands for easy visualization</li>
                                <li><strong>Margin Call Risk by Year:</strong> Bar chart showing % of simulations experiencing margin calls each year (color-coded by risk level)</li>
                                <li><strong>Liquidity Safety Buffer:</strong> Shows "distance to margin call" over time - higher values indicate greater safety margin</li>
                                <li><strong>Terminal Distribution:</strong> Histogram of final net worth outcomes showing the distribution</li>
                            </ul>

                            <p class="mt-16"><strong>Percentile Table:</strong> Year-by-year breakdown of portfolio value, LOC balance, utilization %, and net worth for all percentiles.</p>
                        </div>

                        <div class="instruction-item">
                            <h4> Liquidity Stress Testing Dashboard (NEW!)</h4>
                            <p><strong>Purpose:</strong> Understand how resilient your portfolio is to sudden market drops and how close you come to triggering a margin call.</p>

                            <p><strong>What is "Distance to Margin Call"?</strong><br>
                            This measures how many percentage points of buffer you have before hitting the max borrowing limit. For example, if your LOC utilization is at 75% and your max is 100%, your distance to margin call is 25% points.</p>

                            <p class="mt-12"><strong>Risk Zones:</strong></p>
                            <ul class="list-indented">
                                <li><strong> Safe Zone (>25% pts):</strong> Healthy buffer - portfolio can withstand significant volatility</li>
                                <li><strong> Warning Zone (10-25% pts):</strong> Moderate risk - consider increasing safety margin</li>
                                <li><strong> Danger Zone (<10% pts):</strong> Critical risk - portfolio is close to margin call; immediate action needed</li>
                            </ul>

                            <p class="mt-12"><strong>Stress Test Scenarios:</strong><br>
                            The dashboard shows 4 "what-if" scenarios testing what happens if your portfolio suddenly drops by 10%, 20%, 30%, or 40%. Each card displays:</p>
                            <ul class="list-indented">
                                <li><strong>New Portfolio Value:</strong> Portfolio value after the hypothetical drop</li>
                                <li><strong>LOC Utilization:</strong> Percentage of max credit used after the drop</li>
                                <li><strong>Distance to Margin Call:</strong> Remaining safety buffer in percentage points</li>
                                <li><strong>Status Badge:</strong> SAFE (no margin call), HIGH RISK (>75% utilization), or MARGIN CALL (triggered)</li>
                            </ul>

                            <p class="mt-12"><strong>Key Liquidity Metrics:</strong></p>
                            <ul class="list-indented">
                                <li><strong>10th Percentile Safety Buffer:</strong> In the worst 10% of scenarios, you have at least this percentage point buffer before hitting a margin call. More representative than absolute minimum, which shows extreme tail risk.</li>
                                <li><strong>Most Dangerous Year:</strong> The year when you're closest to a margin call across all scenarios</li>
                                <li><strong>90th Percentile LOC Utilization:</strong> In 90% of simulations, your borrowing never exceeds this percentage. Shows realistic worst-case utilization rather than statistical outliers.</li>
                            </ul>

                            <p class="mt-12"><strong> How to Use This Information:</strong></p>
                            <ul class="list-indented">
                                <li>If stress tests show margin calls at 20-30% drops, consider reducing withdrawal amounts or increasing starting capital</li>
                                <li>Watch the "Most Dangerous Year" - this is when you should be most cautious about portfolio rebalancing</li>
                                <li>Aim for stress tests showing at least 15%+ distance to margin call even after a 30% portfolio drop</li>
                                <li>The Liquidity Safety Buffer chart shows how your safety margin evolves - look for periods where all percentiles dip close to the danger zone</li>
                            </ul>
                        </div>

                        <div class="instruction-item">
                            <h4> Strategy Comparison: Buy Borrow Die vs. Sell Assets</h4>
                            <p><strong>Purpose:</strong> Directly compare the Buy Borrow Die (BBD) leverage strategy against a traditional sell-assets approach using the same market returns to understand which strategy produces better outcomes.</p>

                            <p><strong>How it works:</strong> After running a Monte Carlo simulation, the simulator automatically runs a parallel "Sell Assets" strategy using the identical market returns. This apples-to-apples comparison isolates the impact of the BBD strategy itself.</p>

                            <p class="mt-12"><strong>Two Strategies Compared:</strong></p>
                            <ul class="list-indented-spaced">
                                <li><strong>Buy Borrow Die (BBD):</strong> Borrow against your portfolio via SBLOC for annual withdrawals. Pay interest on borrowed funds and dividend taxes. No capital gains taxes during your lifetime. Portfolio remains fully invested. Beneficiaries receive step-up basis at death (zero capital gains tax on inherited assets).</li>
                                <li><strong>Sell Assets:</strong> Sell a portion of your portfolio each year to fund withdrawals. Pay capital gains taxes on realized gains annually. No borrowing, no interest costs, no margin call risk. Portfolio size shrinks over time as you sell assets.</li>
                            </ul>

                            <p class="mt-12"><strong>Key Metrics Compared:</strong></p>
                            <ul class="list-indented">
                                <li><strong>Terminal Net Worth:</strong> Final portfolio value after the simulation period (median scenario)</li>
                                <li><strong>Success Rate:</strong> BBD shows success rate based on margin calls; Sell Assets shows success rate based on portfolio depletion risk</li>
                                <li><strong>Tax Savings:</strong> Total capital gains taxes avoided by BBD strategy (paid at death with step-up basis)</li>
                                <li><strong>Cumulative Interest:</strong> Total interest paid on SBLOC borrowing (BBD only)</li>
                                <li><strong>Terminal Value Difference:</strong> How much more (or less) wealth BBD produces vs selling</li>
                                <li><strong>Estate Value with Step-Up:</strong> Final estate value for heirs after applying step-up basis benefit</li>
                            </ul>

                            <p class="mt-12"><strong>Comparison Charts (3 Total):</strong></p>
                            <ul class="list-indented">
                                <li><strong>Net Worth Over Time:</strong> Line chart showing median net worth evolution for both strategies. Shows when BBD pulls ahead or falls behind.</li>
                                <li><strong>Cumulative Costs (Taxes vs Interest):</strong> Area chart comparing cumulative capital gains taxes (Sell Assets) vs cumulative interest paid (BBD). Visualizes the trade-off.</li>
                                <li><strong>Terminal Distribution (All Percentiles):</strong> Bar chart comparing final outcomes across 10th, 25th, 50th, 75th, and 90th percentiles for both strategies.</li>
                            </ul>

                            <p class="mt-12"><strong> Interpreting the Comparison:</strong></p>
                            <ul class="list-indented-spaced">
                                <li><strong>When BBD wins:</strong> If terminal net worth is higher and interest costs are less than tax savings, BBD is superior. Look for positive "Terminal Value Difference."</li>
                                <li><strong>When Sell Assets wins:</strong> If BBD success rate is low (&lt;50%) or interest costs exceed tax savings significantly, selling may be safer despite lower terminal value.</li>
                                <li><strong>Risk vs Reward:</strong> BBD typically produces higher terminal wealth but with margin call risk. Sell Assets avoids leverage risk but may face portfolio depletion with aggressive withdrawals.</li>
                                <li><strong>Time horizon matters:</strong> Longer periods favor BBD (more time for compounding and step-up basis benefit). Shorter periods favor selling (less interest accumulation).</li>
                            </ul>

                            <p class="mt-12"><strong>Strategic Recommendation:</strong> The comparison section provides an automated recommendation based on your results, considering success rate, tax efficiency, and risk tolerance. Use this to inform your decision, but remember:</p>
                            <ul class="list-indented">
                                <li>High BBD success rate (80%+) with positive tax savings  BBD is compelling</li>
                                <li>Moderate success rate (50-80%)  Consider hybrid approach or reduce withdrawals</li>
                                <li>Low success rate (&lt;50%)  Selling is likely safer for your parameters</li>
                            </ul>

                            <p class="mt-12"><strong>Example Scenario:</strong><br>
                            If BBD shows $4.2M terminal net worth (median) with 85% success rate and $420k cumulative interest, while Sell Assets shows $3.1M terminal net worth with $680k cumulative taxes paid, the BBD strategy is superior: $1.1M more wealth despite $420k interest, because you avoided $680k in taxes and kept your portfolio fully invested.</p>
                        </div>

                        <div class="instruction-item">
                            <h4> Equivalent Taxable Salary (Results Display)</h4>
                            <p><strong>Purpose:</strong> Shows the pre-tax salary you would need to earn to match your tax-free BBD withdrawal amount.</p>

                            <p><strong>How it's calculated:</strong> Assumes a 25% effective tax rate on salary income (federal + state combined). The formula is:<br>
                            <em>Equivalent Salary = Annual Withdrawal  (1 - 0.25)</em></p>

                            <p><strong>Examples:</strong></p>
                            <ul class="list-indented">
                                <li><strong>$150,000 tax-free withdrawal</strong> = $200,000 taxable salary equivalent</li>
                                <li><strong>$100,000 tax-free withdrawal</strong> = $133,333 taxable salary equivalent</li>
                                <li><strong>$250,000 tax-free withdrawal</strong> = $333,333 taxable salary equivalent</li>
                            </ul>

                            <p><strong>Why this matters:</strong> The Buy Borrow Die strategy allows you to "withdraw" money by borrowing against your portfolio without triggering income taxes. This display helps you visualize the tax benefit compared to earning traditional income.</p>

                            <p><strong>Annual tax savings:</strong> Using the example above, a $150k withdrawal saves you approximately $50,000/year in income taxes compared to earning a $200k salary. Over 20 years, that's $1,000,000 in cumulative tax savings (not counting investment growth on those savings).</p>

                            <p><strong> Important caveat:</strong> You're not truly "avoiding" taxes forever - you're borrowing and paying interest. The real benefit comes from the step-up basis at death, which eliminates capital gains taxes on inherited assets. Compare the cumulative interest costs vs cumulative tax savings in the Strategy Comparison section.</p>

                            <p><strong> Tip:</strong> This calculation assumes 25% effective rate, which is conservative. High earners with 35-45% marginal rates (federal + state + NIIT + FICA) would see even greater tax savings from the BBD strategy.</p>
                        </div>

                        <div class="instructions-footer">
                            <button class="button button-primary" onclick="toggleFieldInstructions('montecarlo')">
                                Close Instructions
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="results">
                <!-- Print Report Button - Floating Icon -->
                <div class="print-report-container" id="printReportContainer" style="display: none;">
                    <button class="print-report-btn" id="printReportBtn" onclick="openPrintWindow()" title="Print Report">
                        <span class="material-icons">print</span>
                    </button>
                </div>

                <!-- Key Metrics -->
                <div class="card key-metrics-card" id="section-key-metrics">
                    <!--div class="section-header"> Key Metrics</div-->
                    <div class="summary-grid" id="keyMetrics"></div>
                </div>

                <!-- Charts -->
                <div class="charts-grid" id="section-charts" class="grid-auto-fit-500">
                    <div class="card chart-card">
                        <div class="section-header"> Net Worth Over Time</div>
                        <div class="chart-container">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>

                    <div class="card chart-card">
                        <div class="section-header"> SBLOC Balance to SBLOC% Used</div>
                        <div class="chart-container">
                            <canvas id="debtChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Monte Carlo Specific Charts -->
                <div id="monteCarloChartsSection" class="hidden">
                    <!-- Row 1: SBLOC Utilization & Net Worth Across Simulations -->
                    <div class="charts-grid">
                        <!-- Chart 1: SBLOC Utilization Percentiles -->
                        <div class="card chart-card">
                            <div class="section-header"> SBLOC Usage % Over Time (Percentiles)</div>
                            <div class="chart-container">
                                <canvas id="sblocUtilizationChart"></canvas>
                            </div>
                        </div>

                        <!-- Chart 2: Net Worth Across Simulations (NEW) -->
                        <div class="card chart-card">
                            <div class="section-header"> Net Worth Across Simulations (Percentiles)</div>
                            <div class="chart-container">
                                <canvas id="netWorthPercentilesChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Row 2: Margin Call Risk & Terminal Distribution -->
                    <div class="charts-grid" style="margin-top: 24px;">
                        <!-- Chart 3: Margin Call Risk by Year -->
                        <div class="card chart-card">
                            <div class="section-header"> Margin Call Risk by Year</div>
                            <div class="chart-container">
                                <canvas id="marginCallRiskChart"></canvas>
                            </div>
                        </div>

                        <!-- Chart 4: Terminal Distribution -->
                        <div class="card chart-card">
                            <div class="section-header"> Terminal Net Worth Distribution</div>
                            <div class="chart-container">
                                <canvas id="terminalDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Row 3: Stress Testing Dashboard (Full-width) -->
                    <div class="charts-grid" style="grid-template-columns: 1fr; gap: 24px; margin-top: 24px; display: none;">
                        <!-- Liquidity Stress Testing Dashboard -->
                        <div class="card" id="section-stress-testing">
                            <div class="section-header flex-center-gap-8">
                                <span class="material-icons" class="text-error">emergency</span>
                                <span>Liquidity Stress Testing Dashboard</span>
                            </div>
                            <div id="liquidityStressDashboard" class="p-16">
                                <!-- Dashboard content will be dynamically inserted here -->
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Salary Equivalent -->
                <div class="salary-equivalent" id="section-salary-equivalent">
                    <h3>Your Annual Withdrawal Tax-Free</h3>
                    <div class="amount" id="salaryEquivalent">$0</div>
                    <div class="equivalent-text">Is equivalent to earning a taxable salary of:</div>
                    <div class="taxable-amount" id="taxableEquivalent">$0</div>
                    <div class="savings-text" id="taxSavingsText">You save approximately $0 in annual taxes by using the Buy Borrow Die strategy (based on 2024 federal tax rates for single filer)</div>
                </div>

                <!-- Strategy Summary and Executive Summary have been consolidated into Strategy Analysis below -->

                <!-- Strategy Analysis Section (Consolidated) -->
                <div class="strategy-analysis-section" id="strategyAnalysisSection" style="display: none;">
                    <!-- Header with Methodology Note -->
                    <div class="sa-header">
                        <div class="sa-header-content">
                            <div class="sa-title-row">
                                <span class="material-icons sa-title-icon">balance</span>
                                <h2 class="sa-title">Strategy Analysis</h2>
                            </div>
                            <p class="sa-subtitle" id="saSubtitle">Based on 10,000 Monte Carlo simulations over 15 years</p>
                        </div>
                        <div class="sa-disclaimer-badge">
                            <span class="material-icons">info</span>
                            <span>Results based on historical return patterns. Your actual results will differ.</span>
                        </div>
                    </div>

                    <!-- Verdict Banner -->
                    <div class="sa-verdict-banner" id="saVerdictBanner">
                        <div class="sa-verdict-icon-container" id="saVerdictIconContainer">
                            <span class="material-icons" id="saVerdictIcon">check</span>
                        </div>
                        <div class="sa-verdict-content">
                            <h3 class="sa-verdict-headline" id="saVerdictHeadline">BBD Recommended</h3>
                            <p class="sa-verdict-rationale" id="saVerdictRationale">BBD strategy shows strong advantage for your scenario</p>
                        </div>
                        <div class="sa-success-dial">
                            <div class="sa-dial-ring">
                                <svg width="64" height="64" viewBox="0 0 64 64">
                                    <circle class="sa-dial-bg" cx="32" cy="32" r="25" fill="none" stroke-width="6"/>
                                    <circle class="sa-dial-progress" id="saDialProgress" cx="32" cy="32" r="25" fill="none" stroke-width="6"
                                        stroke-dasharray="157" stroke-dashoffset="31"/>
                                </svg>
                                <div class="sa-dial-value" id="saDialValue">80%</div>
                            </div>
                            <span class="sa-dial-label">Success</span>
                        </div>
                    </div>

                    <!-- Side-by-Side Comparison -->
                    <div class="sa-comparison-grid">
                        <!-- BBD Column -->
                        <div class="sa-strategy-card sa-bbd">
                            <div class="sa-strategy-header">
                                <span class="material-icons">trending_up</span>
                                <span>Buy Borrow Die</span>
                            </div>
                            <div class="sa-strategy-metrics">
                                <div class="sa-metric">
                                    <span class="sa-metric-label">Terminal Net Worth</span>
                                    <span class="sa-metric-value" id="bbdTerminalMedian">$0</span>
                                </div>
                                <div class="sa-metric">
                                    <span class="sa-metric-label">Success Rate</span>
                                    <span class="sa-metric-value" id="bbdSuccessRate">0%</span>
                                </div>
                                <div class="sa-metric">
                                    <span class="sa-metric-label">Lifetime Cost</span>
                                    <span class="sa-metric-value sa-cost" id="bbdCumulativeInterest">$0</span>
                                    <span class="sa-metric-subtext">interest paid</span>
                                </div>
                                <div class="sa-metric">
                                    <span class="sa-metric-label">Dividend Taxes</span>
                                    <span class="sa-metric-value sa-cost" id="bbdDividendTaxes">$0</span>
                                </div>
                                <div class="sa-metric">
                                    <span class="sa-metric-label">Primary Risk</span>
                                    <span class="sa-metric-value sa-risk" id="bbdRiskFactor">0% margin call</span>
                                </div>
                            </div>
                        </div>

                        <!-- Sell Assets Column -->
                        <div class="sa-strategy-card sa-sell">
                            <div class="sa-strategy-header">
                                <span class="material-icons">account_balance</span>
                                <span>Sell Assets</span>
                            </div>
                            <div class="sa-strategy-metrics">
                                <div class="sa-metric">
                                    <span class="sa-metric-label">Terminal Net Worth</span>
                                    <span class="sa-metric-value" id="sellTerminalMedian">$0</span>
                                </div>
                                <div class="sa-metric">
                                    <span class="sa-metric-label">Success Rate</span>
                                    <span class="sa-metric-value" id="sellSuccessRate">0%</span>
                                    <span class="sa-metric-subtext" id="sellSuccessRateSubtext">No portfolio depletion</span>
                                </div>
                                <div class="sa-metric">
                                    <span class="sa-metric-label">Lifetime Cost</span>
                                    <span class="sa-metric-value sa-cost" id="sellTaxesPaid">$0</span>
                                    <span class="sa-metric-subtext">taxes paid</span>
                                </div>
                                <div class="sa-metric">
                                    <span class="sa-metric-label">Primary Risk</span>
                                    <span class="sa-metric-value sa-success" id="sellRiskFactor">Low</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Wealth Differential -->
                    <div class="sa-differential">
                        <h4 class="sa-section-title">
                            <span class="material-icons">monetization_on</span>
                            Wealth Differential
                        </h4>
                        <div class="sa-differential-grid">
                            <div class="sa-diff-card">
                                <span class="sa-diff-label">BBD vs Sell</span>
                                <span class="sa-diff-value" id="terminalDifference">+$0</span>
                            </div>
                            <div class="sa-diff-card">
                                <span class="sa-diff-label">Tax Savings</span>
                                <span class="sa-diff-value" id="taxSavingsAmount">$0</span>
                            </div>
                            <div class="sa-diff-card">
                                <span class="sa-diff-label">Estate Value (BBD)</span>
                                <span class="sa-diff-value" id="estateValueDiff">$0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Why Strategy Performs Well -->
                    <div class="sa-explanation" id="saExplanation">
                        <h4 class="sa-section-title">
                            <span class="material-icons">lightbulb</span>
                            <span id="saExplanationTitle">Why BBD Performs Well in Your Scenario</span>
                        </h4>
                        <div class="sa-insight-quote" id="saInsightQuote">
                            "82.4% of scenarios avoid margin calls while achieving 34.3% higher median wealth versus selling assets."
                        </div>
                        <p class="sa-insight-text" id="saInsightText">
                            Your withdrawal rate creates favorable borrowing conditions with sufficient headroom above maintenance margins.
                        </p>
                        <div class="sa-benefits-grid">
                            <div class="sa-benefit-card">
                                <div class="sa-benefit-icon teal">
                                    <span class="material-icons">shield</span>
                                </div>
                                <div class="sa-benefit-content">
                                    <span class="sa-benefit-title">Tax Deferral Benefit</span>
                                    <span class="sa-benefit-value" id="saTaxDeferralValue">$0</span>
                                    <p class="sa-benefit-text" id="saTaxDeferralText">By borrowing instead of selling, your entire portfolio remains invested.</p>
                                </div>
                            </div>
                            <div class="sa-benefit-card">
                                <div class="sa-benefit-icon purple">
                                    <span class="material-icons">trending_up</span>
                                </div>
                                <div class="sa-benefit-content">
                                    <span class="sa-benefit-title">Compounding Advantage</span>
                                    <span class="sa-benefit-value" id="saCompoundingValue">$0</span>
                                    <p class="sa-benefit-text" id="saCompoundingText">Tax drag on sold assets compounds into the observed difference in median outcomes.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Visual Comparison Charts -->
                    <div class="sa-charts-section">
                        <h4 class="sa-section-title">
                            <span class="material-icons">bar_chart</span>
                            Visual Comparison
                        </h4>
                        <div class="sa-charts-grid">
                            <div class="sa-chart-card">
                                <h5 class="sa-chart-title">Net Worth Over Time (Median)</h5>
                                <div class="sa-chart-container">
                                    <canvas id="comparisonNetWorthChart"></canvas>
                                </div>
                            </div>
                            <div class="sa-chart-card">
                                <h5 class="sa-chart-title">Cumulative Costs: Taxes vs Interest</h5>
                                <div class="sa-chart-container">
                                    <canvas id="comparisonTaxChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="sa-chart-card sa-chart-full">
                            <h5 class="sa-chart-title">Terminal Value Distribution (All Percentiles)</h5>
                            <div class="sa-chart-container">
                                <canvas id="comparisonDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Important Considerations -->
                    <div class="sa-considerations">
                        <h4 class="sa-section-title">
                            <span class="material-icons">warning</span>
                            Important Considerations
                        </h4>
                        <div class="sa-considerations-container">
                            <div class="sa-considerations-header">
                                <div class="sa-considerations-title">
                                    <span class="material-icons">lightbulb</span>
                                    Actionable Insights
                                </div>
                                <span class="sa-considerations-count">6</span>
                            </div>
                            <div class="sa-considerations-list" id="saConsiderationsList">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!--
                    ========================================
                    COMMENTED OUT: Recommended Next Steps & Alternative Approaches
                    To restore: Uncomment this entire block
                    ========================================

                    <div class="sa-next-steps">
                        <h4 class="sa-section-title">
                            <span class="material-icons">arrow_forward</span>
                            Recommended Next Steps
                        </h4>
                        <div class="sa-next-steps-grid" id="saNextStepsGrid">
                            [Dynamically populated by JavaScript]
                        </div>
                    </div>

                    <div class="sa-alternatives">
                        <h4 class="sa-section-title">
                            <span class="material-icons">swap_horiz</span>
                            Alternative Approaches
                        </h4>
                        <div class="sa-alternatives-grid">
                            <div class="sa-alternative-card">
                                <span class="sa-alternative-icon"></span>
                                <span class="sa-alternative-title">Hybrid Strategy</span>
                                <span class="sa-alternative-text">Use BBD for 60-70% of withdrawals and sell assets for the remainder</span>
                            </div>
                            <div class="sa-alternative-card">
                                <span class="sa-alternative-icon"></span>
                                <span class="sa-alternative-title">Dynamic Approach</span>
                                <span class="sa-alternative-text">Switch to selling if SBLOC rates spike or portfolio drops significantly</span>
                            </div>
                            <div class="sa-alternative-card">
                                <span class="sa-alternative-icon"></span>
                                <span class="sa-alternative-title">Tax-Optimized Selling</span>
                                <span class="sa-alternative-text">Use tax-loss harvesting, qualified dividends, and Roth conversions</span>
                            </div>
                        </div>
                    </div>

                    ======================================== END COMMENTED SECTION
                    -->

                </div>

                <!-- Year by Year Table -->
                <div class="card" id="section-year-by-year">
                    <div class="section-header"> Year-by-Year Details</div>
                    <div class="table-container">
                        <table id="yearTable">
                            <thead>
                                <tr>
                                    <th>Year</th>
                                    <th>Return (%)</th>
                                    <th>Portfolio Value</th>
                                    <th>Withdrawal</th>
                                    <th>LOC Balance</th>
                                    <th>% of LOC Used</th>
                                    <th>Net Portfolio</th>
                                </tr>
                            </thead>
                            <tbody id="yearTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="settings-overlay hidden">
        <div class="settings-panel">
            <div class="settings-header">
                <h2>Settings</h2>
                <button class="settings-close-btn" onclick="closeSettings()">Close</button>
            </div>

            <div class="settings-content">
                <div class="settings-section">
                    <h3>Data Source</h3>

                    <div class="data-source-option">
                        <input type="radio" id="source-fmp" name="dataSource" value="fmp" onchange="selectDataSource('fmp')">
                        <label for="source-fmp">
                            <strong>FMP - Financial Modeling Prep</strong> (Free: 250/day | Paid: $19/mo)
                        </label>
                    </div>

                    <div class="data-source-option">
                        <input type="radio" id="source-eodhd" name="dataSource" value="eodhd" onchange="selectDataSource('eodhd')">
                        <label for="source-eodhd">
                            <strong>EODHD - End of Day Historical</strong> (Free: 20/day | Paid: 19.99/mo)
                        </label>
                    </div>

                    <div class="data-source-option">
                        <input type="radio" id="source-alphavantage" name="dataSource" value="alphavantage" onchange="selectDataSource('alphavantage')">
                        <label for="source-alphavantage">
                            <strong>Alpha Vantage</strong> (Free: 25/day | Paid: $49.99/mo)
                        </label>
                    </div>

                    <div class="data-source-option">
                        <input type="radio" id="source-yahoo" name="dataSource" value="yahoo" onchange="selectDataSource('yahoo')">
                        <label for="source-yahoo">
                            <strong>Yahoo Finance</strong> (Free, Unofficial - May Break)
                        </label>
                    </div>

                    <div class="data-source-option">
                        <input type="radio" id="source-tiingo" name="dataSource" value="tiingo" onchange="selectDataSource('tiingo')">
                        <label for="source-tiingo">
                            <strong>Tiingo</strong> (Free: 50 symbols/hr, 30+ years data)
                        </label>
                    </div>

                    <div class="data-source-option">
                        <input type="radio" id="source-manual" name="dataSource" value="manual" onchange="selectDataSource('manual')" checked>
                        <label for="source-manual">
                            <strong>Manual Entry</strong> (No API required)
                        </label>
                    </div>
                </div>

                <!-- FMP API Key Section -->
                <div id="fmp-config" class="api-config-section hidden">
                    <h3>Financial Modeling Prep API Key</h3>
                    <input type="text" id="fmp-api-key" class="api-key-input" placeholder="Enter your FMP API key" oninput="onApiKeyChange('fmp')">
                    <button type="button" class="test-connection-btn" onclick="testConnection('fmp')">Test Connection</button>
                    <div id="fmp-status" class="connection-status"></div>
                    <p class="api-help-text">
                        Get a free key at <a href="https://financialmodelingprep.com/developer/docs/" target="_blank">financialmodelingprep.com</a> (Free: 250 req/day, enough for S&P 500 with caching)
                    </p>
                </div>

                <!-- EODHD API Key Section -->
                <div id="eodhd-config" class="api-config-section hidden">
                    <h3>End of Day Historical API Key</h3>
                    <input type="text" id="eodhd-api-key" class="api-key-input" placeholder="Enter your EODHD API key" oninput="onApiKeyChange('eodhd')">
                    <button type="button" class="test-connection-btn" onclick="testConnection('eodhd')">Test Connection</button>
                    <div id="eodhd-status" class="connection-status"></div>
                    <p class="api-help-text">
                        Get a free key at <a href="https://eodhistoricaldata.com/" target="_blank">eodhistoricaldata.com</a> (Free: 20 req/day)
                    </p>
                </div>

                <!-- Alpha Vantage API Key Section -->
                <div id="alphavantage-config" class="api-config-section hidden">
                    <h3>Alpha Vantage API Key</h3>
                    <input type="text" id="alphavantage-api-key" class="api-key-input" placeholder="Enter your Alpha Vantage API key" oninput="onApiKeyChange('alphavantage')">
                    <button type="button" class="test-connection-btn" onclick="testConnection('alphavantage')">Test Connection</button>
                    <div id="alphavantage-status" class="connection-status"></div>
                    <p class="api-help-text">
                        Get a free key at <a href="https://www.alphavantage.co/support/#api-key" target="_blank">alphavantage.co</a> (Free: 25 req/day | Paid: $49.99/mo)
                    </p>
                </div>

                <!-- Yahoo Finance Info -->
                <div id="yahoo-config" class="api-config-section hidden">
                    <h3>Yahoo Finance (No API Key Required)</h3>
                    <p class="api-help-text">
                        Yahoo Finance is free and doesn't require an API key. However, it's unofficial and may break at any time. Use with caution.
                    </p>
                    <div id="yahoo-status" class="connection-status"></div>
                </div>

                <!-- Tiingo API Key Section -->
                <div id="tiingo-config" class="api-config-section hidden">
                    <h3>Tiingo API Key</h3>
                    <input type="text" id="tiingo-api-key" class="api-key-input" placeholder="Enter your Tiingo API key" oninput="onApiKeyChange('tiingo')">
                    <button type="button" class="test-connection-btn" onclick="testConnection('tiingo')">Test Connection</button>
                    <div id="tiingo-status" class="connection-status"></div>
                    <p class="api-help-text">
                        Get a free key at <a href="https://www.tiingo.com/" target="_blank">tiingo.com</a> (Free: 50 symbols/hr, 30+ years of historical data back to 1962)<br>
                        <strong>Note:</strong> Tiingo may require a CORS proxy for browser access. Configure one in Advanced settings below if you get CORS errors.
                    </p>
                    <div style="margin-top: 15px; padding: 12px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);">
                        <h4 style="margin: 0 0 10px 0; font-size: 14px;">Fetch Asset Data</h4>
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <input type="text" id="tiingo-fetch-symbol" class="api-key-input" placeholder="Enter ticker symbol (e.g., AAPL)" style="flex: 1; min-width: 150px;">
                            <button type="button" class="test-connection-btn" onclick="fetchTiingoAsset()" style="background: var(--accent-color);">
                                Fetch & Add to Library
                            </button>
                        </div>
                        <p class="api-help-text" style="margin-top: 8px; font-size: 12px;">
                            Fetches historical data and adds the asset to your Available Assets list for portfolio composition.
                        </p>
                    </div>
                </div>

                <!-- Manual Entry Info -->
                <div id="manual-config" class="api-config-section" class="block">
                    <h3>Manual Entry (Default)</h3>
                    <p class="api-help-text">
                        Enter historical returns data manually or select from preset assets. No API key required.
                    </p>
                </div>

                <!-- Advanced Settings Section -->
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                    <h2 class="mb-15">Advanced</h2>

                    <h3 class="mb-10">CORS Proxy URL</h3>
                    <input type="text" id="cors-proxy-url" class="api-key-input"
                           placeholder="Leave blank to try direct connection first"
                           class="mb-10">

                    <div class="mb-15">
                        <button type="button" class="proxy-preset-btn" onclick="setCorsProxy('')"
                                style="margin-right: 5px; padding: 8px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                             No Proxy (Direct)
                        </button>
                        <button type="button" class="proxy-preset-btn" onclick="setCorsProxy('https://corsproxy.io/?')"
                                style="margin-right: 5px; padding: 8px 12px; background: #4a5568; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                            CORSProxy.io
                        </button>
                        <button type="button" class="proxy-preset-btn" onclick="setCorsProxy('https://api.allorigins.win/raw?url=')"
                                style="padding: 8px 12px; background: #4a5568; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                            AllOrigins
                        </button>
                    </div>

                    <p class="api-help-text" class="mb-15">
                        <strong>Leave blank to try direct connection first.</strong> Only use a proxy if you get CORS errors.<br>
                        Most modern browsers allow direct API calls to FMP, EODHD, and Alpha Vantage.
                    </p>

                    <label style="display: flex; align-items: center; margin-bottom: 15px; cursor: pointer;">
                        <input type="checkbox" id="require-true-crossover" class="mr-8">
                        <span>Require true crossover above 20</span>
                    </label>
                    <p class="api-help-text" class="mb-15">
                        More strict: requires %K to cross from below 20 to above 20.
                    </p>

                    <h3 class="mb-10">Minimum History (bars)</h3>
                    <input type="number" id="minimum-history" class="api-key-input"
                           placeholder="120" value="120" min="1" max="1000"
                           class="mb-10">

                    <button type="button" onclick="saveAdvancedSettings()"
                            style="width: 100%; padding: 12px; background: #4C6FFF; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500; margin-top: 10px; transition: background 0.3s ease; box-shadow: 0 2px 8px rgba(76, 111, 255, 0.25);">
                        Save Settings
                    </button>

                    <!-- Historical Data Cache Section -->
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                        <h3 class="mb-10">Historical Data Cache</h3>
                        <p class="api-help-text" id="cache-stats-summary" class="mb-10">Loading cache info...</p>
                        <div id="cache-details" style="max-height: 200px; overflow-y: auto; margin: 10px 0; font-size: 12px; border: 1px solid var(--border-color); border-radius: 4px; padding: 8px;"></div>
                        <button type="button" onclick="clearHistoricalCache()"
                                style="width: 100%; padding: 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500;">
                            Clear All Cached Data
                        </button>
                        <p class="api-help-text" style="margin-top: 10px; font-size: 12px;">
                            Historical data is cached permanently. Use "Force Refresh" button if you need to update a symbol with the latest year's data.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container" style="position: fixed; top: 20px; left: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; max-width: 400px;"></div>

    <script>
        let trendChart = null;
        let debtChart = null;
        let historicalDataLibrary = {};
        let assetClassLibrary = {};  // Asset class lookup - populated during historical data parsing
        let currentResults = null;
        let currentParams = null;

        // Monte Carlo results storage for theme updates
        let currentMonteCarloPercentilesData = null;
        let currentMonteCarloResults = null;
        let currentMonteCarloParams = null;

        // Data Provider Configuration
        const dataProviders = {
            fmp: {
                name: 'Financial Modeling Prep',
                requiresApiKey: true,
                endpoint: (symbol, apiKey) => `https://financialmodelingprep.com/stable/historical-price-eod/full?symbol=${symbol}&apikey=${apiKey}`,
                testEndpoint: (apiKey) => `https://financialmodelingprep.com/stable/historical-price-eod/light?symbol=AAPL&apikey=${apiKey}`,
                parseResponse: (data, startYear, period) => {
                    // New API may return data directly as array or wrapped in an object
                    const historicalData = Array.isArray(data) ? data : (data.historical || data.data || data);
                    if (!historicalData || !Array.isArray(historicalData)) return null;
                    const returns = calculateAnnualReturnsFromDaily(historicalData, startYear, period);
                    return returns;
                }
            },
            eodhd: {
                name: 'End of Day Historical Data',
                requiresApiKey: true,
                endpoint: (symbol, apiKey) => `https://eodhistoricaldata.com/api/eod/${symbol}.US?api_token=${apiKey}&fmt=json`,
                testEndpoint: (apiKey) => `https://eodhistoricaldata.com/api/eod/AAPL.US?api_token=${apiKey}&fmt=json&limit=1`,
                parseResponse: (data, startYear, period) => {
                    if (!Array.isArray(data)) return null;
                    const returns = calculateAnnualReturnsFromDaily(data, startYear, period);
                    return returns;
                }
            },
            alphavantage: {
                name: 'Alpha Vantage',
                requiresApiKey: true,
                endpoint: (symbol, apiKey) => `https://www.alphavantage.co/query?function=TIME_SERIES_MONTHLY_ADJUSTED&symbol=${symbol}&apikey=${apiKey}`,
                testEndpoint: (apiKey) => `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=AAPL&apikey=${apiKey}`,
                parseResponse: (data, startYear, period) => {
                    if (data['Error Message']) return null;
                    if (data['Note']) return null;
                    const timeSeries = data['Monthly Adjusted Time Series'];
                    if (!timeSeries) return null;
                    return calculateAnnualReturns(timeSeries, startYear, period);
                }
            },
            yahoo: {
                name: 'Yahoo Finance',
                requiresApiKey: false,
                endpoint: (symbol) => `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1mo&range=max`,
                testEndpoint: () => `https://query1.finance.yahoo.com/v8/finance/chart/AAPL?interval=1d&range=5d`,
                parseResponse: (data, startYear, period) => {
                    if (!data.chart || !data.chart.result || !data.chart.result[0]) return null;
                    const result = data.chart.result[0];
                    const timestamps = result.timestamp;
                    const prices = result.indicators.adjclose[0].adjclose;
                    return calculateAnnualReturnsFromTimestamps(timestamps, prices, startYear, period);
                }
            },
            tiingo: {
                name: 'Tiingo',
                requiresApiKey: true,
                endpoint: (symbol, apiKey) => `https://api.tiingo.com/tiingo/daily/${symbol}/prices?startDate=1962-01-01&token=${apiKey}`,
                testEndpoint: (apiKey) => `https://api.tiingo.com/tiingo/daily/AAPL/prices?startDate=2024-01-01&endDate=2024-01-05&token=${apiKey}`,
                parseResponse: (data, startYear, period) => {
                    if (!Array.isArray(data) || data.length === 0) return null;
                    // Tiingo returns: { date, open, high, low, close, volume, adjOpen, adjHigh, adjLow, adjClose, adjVolume, divCash, splitFactor }
                    const returns = calculateAnnualReturnsFromDaily(data, startYear, period);
                    return returns;
                }
            },
            manual: {
                name: 'Manual Entry',
                requiresApiKey: false
            }
        };

        // Settings State
        let settingsState = {
            selectedSource: 'manual',
            apiKeys: {},
            corsProxyUrl: '',
            requireTrueCrossover: false,
            minimumHistory: 120,
            regimeMode: 'conservative'  // Default regime calibration mode
        };

        // Load settings from localStorage on page load
        function loadSettings() {
            const saved = localStorage.getItem('bbd_settings');
            if (saved) {
                try {
                    settingsState = JSON.parse(saved);
                } catch (e) {
                    console.error('Failed to load settings:', e);
                }
            }

            // Update UI to reflect loaded settings
            const sourceRadio = document.getElementById(`source-${settingsState.selectedSource}`);
            if (sourceRadio) {
                sourceRadio.checked = true;
                selectDataSource(settingsState.selectedSource, false);
            }

            // Populate API key inputs
            Object.keys(settingsState.apiKeys).forEach(provider => {
                const input = document.getElementById(`${provider}-api-key`);
                if (input) {
                    input.value = settingsState.apiKeys[provider] || '';
                }
            });

            // Populate advanced settings
            const corsProxyInput = document.getElementById('cors-proxy-url');
            if (corsProxyInput) {
                corsProxyInput.value = settingsState.corsProxyUrl || '';
            }

            const trueCrossoverCheckbox = document.getElementById('require-true-crossover');
            if (trueCrossoverCheckbox) {
                trueCrossoverCheckbox.checked = settingsState.requireTrueCrossover || false;
            }

            const minimumHistoryInput = document.getElementById('minimum-history');
            if (minimumHistoryInput) {
                minimumHistoryInput.value = settingsState.minimumHistory || 120;
            }

            // Restore regime mode selection
            if (settingsState.regimeMode) {
                const regimeModeRadio = document.getElementById(
                    settingsState.regimeMode === 'historical'
                        ? 'regimeModeHistorical'
                        : 'regimeModeConservative'
                );
                if (regimeModeRadio) {
                    regimeModeRadio.checked = true;
                    // Update description text to match
                    if (typeof updateRegimeModeDescription === 'function') {
                        updateRegimeModeDescription();
                    }
                }
            }
        }

        // Save settings to localStorage
        function saveSettings() {
            localStorage.setItem('bbd_settings', JSON.stringify(settingsState));
        }

        // Show Settings Modal
        function showSettings() {
            document.getElementById('settingsModal').style.display = 'flex';
            updateCacheStats();  // Refresh cache stats when opening settings
        }

        // Close Settings Modal
        function closeSettings() {
            // Save all API keys before closing
            saveApiKeys();
            document.getElementById('settingsModal').style.display = 'none';
            saveSettings();
        }

        // Save API keys from input fields to settingsState
        function saveApiKeys() {
            const apiKeyInputs = document.querySelectorAll('.api-key-input');
            apiKeyInputs.forEach(input => {
                const provider = input.id.replace('-api-key', '');
                const value = input.value.trim();
                if (value) {
                    settingsState.apiKeys[provider] = value;
                } else {
                    // Remove the key if the input is empty
                    delete settingsState.apiKeys[provider];
                }
            });
        }

        // Auto-save API key when input changes
        function onApiKeyChange(provider) {
            const input = document.getElementById(`${provider}-api-key`);
            if (input) {
                const value = input.value.trim();
                if (value) {
                    settingsState.apiKeys[provider] = value;
                } else {
                    delete settingsState.apiKeys[provider];
                }
                saveSettings();
            }
        }

        // Set CORS Proxy URL
        function setCorsProxy(url) {
            const input = document.getElementById('cors-proxy-url');
            if (input) {
                input.value = url;
                settingsState.corsProxyUrl = url;
                saveSettings();

                if (url === '') {
                    showToast('CORS proxy disabled\nAPI calls will go directly to the source.', 'success', 3000);
                } else {
                    showToast(`CORS proxy configured\nAPI calls will be routed through:\n${url}`, 'success', 4000);
                }
            }
        }

        // Save Advanced Settings
        function saveAdvancedSettings() {
            const corsProxyInput = document.getElementById('cors-proxy-url');
            const trueCrossoverCheckbox = document.getElementById('require-true-crossover');
            const minimumHistoryInput = document.getElementById('minimum-history');

            if (corsProxyInput) {
                settingsState.corsProxyUrl = corsProxyInput.value.trim();
            }

            if (trueCrossoverCheckbox) {
                settingsState.requireTrueCrossover = trueCrossoverCheckbox.checked;
            }

            if (minimumHistoryInput) {
                settingsState.minimumHistory = parseInt(minimumHistoryInput.value) || 120;
            }

            saveSettings();
            showToast('Advanced settings saved successfully!', 'success', 2000);
        }

        // ========== Toast Notification System ==========

        function showToast(message, type = 'info', duration = 5000) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            // Parse message to extract title if present
            let title = '';
            let content = message;

            // Check if message contains newlines - first line becomes title
            if (message.includes('\n')) {
                const lines = message.split('\n');
                title = lines[0];
                content = lines.slice(1).join('\n').trim();
            }

            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            // Icon based on type
            const icons = {
                success: '',
                error: '',
                warning: '',
                info: ''
            };

            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.info}</div>
                <div class="toast-content">
                    ${title ? `<div class="toast-title">${title}</div>` : ''}
                    <div class="toast-message">${content || title}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()"></button>
            `;

            container.appendChild(toast);

            // Auto-remove after duration
            setTimeout(() => {
                toast.classList.add('removing');
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.remove();
                    }
                }, 300); // Match animation duration
            }, duration);
        }

        // ========== Cache Management Functions ==========

        // Get cached data for a symbol+provider
        function getCachedHistoricalData(symbol, provider) {
            const cache = JSON.parse(localStorage.getItem('bbd_historical_cache') || '{}');
            const key = `${symbol.toUpperCase()}_${provider}`;
            return cache[key] || null;
        }

        // Store data in cache (permanent - no expiration)
        function setCachedHistoricalData(symbol, provider, returnsArray) {
            const cache = JSON.parse(localStorage.getItem('bbd_historical_cache') || '{}');
            const key = `${symbol.toUpperCase()}_${provider}`;
            const lastYear = returnsArray.length > 0 ? Math.max(...returnsArray.map(r => r.year)) : 0;

            cache[key] = {
                symbol: symbol.toUpperCase(),
                provider: provider,
                fetchedAt: Date.now(),
                lastYear: lastYear,
                data: returnsArray
            };
            localStorage.setItem('bbd_historical_cache', JSON.stringify(cache));
        }

        // Clear entire cache
        async function clearHistoricalCache() {
            const confirmed = await showConfirm(
                'This will clear all cached historical data. Are you sure?',
                'Clear Cache'
            );
            if (confirmed) {
                localStorage.removeItem('bbd_historical_cache');
                showToast('Historical data cache cleared!', 'success', 2000);
                updateCacheStats();
            }
        }

        // Remove specific symbol from cache
        function removeCachedSymbol(symbol, provider) {
            const cache = JSON.parse(localStorage.getItem('bbd_historical_cache') || '{}');
            const key = `${symbol.toUpperCase()}_${provider}`;
            delete cache[key];
            localStorage.setItem('bbd_historical_cache', JSON.stringify(cache));
            updateCacheStats();
        }

        // Get cache statistics
        function getCacheStats() {
            const cache = JSON.parse(localStorage.getItem('bbd_historical_cache') || '{}');
            const symbols = Object.keys(cache);
            const sizeBytes = new Blob([JSON.stringify(cache)]).size;
            const sizeMB = (sizeBytes / (1024 * 1024)).toFixed(2);

            // Get details per symbol
            const details = symbols.map(key => {
                const entry = cache[key];
                const date = new Date(entry.fetchedAt).toLocaleDateString();
                return {
                    symbol: entry.symbol,
                    provider: entry.provider,
                    lastYear: entry.lastYear,
                    fetchedDate: date,
                    dataPoints: entry.data.length
                };
            });

            return { count: symbols.length, sizeMB: sizeMB, details: details };
        }

        // Update cache stats display
        function updateCacheStats() {
            const stats = getCacheStats();
            const summaryDiv = document.getElementById('cache-stats-summary');
            const detailsDiv = document.getElementById('cache-details');

            if (summaryDiv) {
                summaryDiv.innerHTML = `Cache contains <strong>${stats.count}</strong> symbol(s) using <strong>${stats.sizeMB} MB</strong>. No expiration - data stored permanently.`;
            }

            if (detailsDiv && stats.details.length > 0) {
                let html = '<table style="width: 100%; border-collapse: collapse; font-size: 12px;">';
                html += '<tr class="border-b-1"><th class="p-5-text-left">Symbol</th><th class="p-5-text-left">Provider</th><th class="p-5-text-center">Last Year</th><th class="p-5-text-center">Years</th><th class="p-5-text-left">Fetched</th></tr>';
                stats.details.forEach(detail => {
                    html += `<tr class="border-b-1">
                        <td class="p-5">${detail.symbol}</td>
                        <td class="p-5">${detail.provider}</td>
                        <td class="p-5-text-center">${detail.lastYear}</td>
                        <td class="p-5-text-center">${detail.dataPoints}</td>
                        <td class="p-5">${detail.fetchedDate}</td>
                    </tr>`;
                });
                html += '</table>';
                detailsDiv.innerHTML = html;
            } else if (detailsDiv) {
                detailsDiv.innerHTML = '<p style="color: #999; font-style: italic;">No cached data yet.</p>';
            }
        }

        // Select Data Source
        function selectDataSource(source, shouldSave = true) {
            settingsState.selectedSource = source;

            // Hide all config sections
            document.querySelectorAll('.api-config-section').forEach(section => {
                section.style.display = 'none';
            });

            // Show selected config section
            const configSection = document.getElementById(`${source}-config`);
            if (configSection) {
                configSection.style.display = 'block';
            }

            if (shouldSave) {
                saveSettings();
            }
        }

        // Test Connection
        async function testConnection(provider) {
            const statusDiv = document.getElementById(`${provider}-status`);
            const apiKeyInput = document.getElementById(`${provider}-api-key`);
            const apiKey = apiKeyInput ? apiKeyInput.value.trim() : '';

            if (!statusDiv) return;

            // Clear previous status
            statusDiv.className = 'connection-status testing';
            statusDiv.textContent = 'Testing connection...';

            const providerConfig = dataProviders[provider];
            if (!providerConfig) {
                statusDiv.className = 'connection-status error';
                statusDiv.textContent = 'Invalid provider';
                return;
            }

            if (providerConfig.requiresApiKey && !apiKey) {
                statusDiv.className = 'connection-status error';
                statusDiv.textContent = 'Please enter an API key';
                return;
            }

            try {
                let testUrl = providerConfig.requiresApiKey
                    ? providerConfig.testEndpoint(apiKey)
                    : providerConfig.testEndpoint();

                // Apply CORS proxy if configured
                if (settingsState.corsProxyUrl) {
                    testUrl = settingsState.corsProxyUrl + encodeURIComponent(testUrl);
                }

                const response = await fetch(testUrl);
                const data = await response.json();

                // Check for HTTP 429 (Rate Limit)
                if (response.status === 429) {
                    statusDiv.className = 'connection-status error';
                    statusDiv.textContent = ' Rate limit exceeded. Please wait and try again later.';
                    return;
                }

                // Check for provider-specific error indicators
                if (provider === 'alphavantage' && (data['Error Message'] || data['Note'])) {
                    statusDiv.className = 'connection-status error';
                    statusDiv.textContent = data['Error Message'] || data['Note'] || 'Connection failed';
                } else if (provider === 'fmp' && data.Error) {
                    statusDiv.className = 'connection-status error';
                    statusDiv.textContent = data.Error || 'Invalid API key';
                } else if (provider === 'eodhd' && data.error) {
                    statusDiv.className = 'connection-status error';
                    statusDiv.textContent = data.error || 'Invalid API key';
                } else if (provider === 'tiingo' && data.detail) {
                    statusDiv.className = 'connection-status error';
                    statusDiv.textContent = data.detail || 'Invalid API key';
                } else if (response.ok) {
                    statusDiv.className = 'connection-status success';
                    statusDiv.textContent = ' Connection successful! API key is valid.';

                    // Save API key
                    if (providerConfig.requiresApiKey) {
                        settingsState.apiKeys[provider] = apiKey;
                        saveSettings();
                    }
                } else {
                    statusDiv.className = 'connection-status error';
                    statusDiv.textContent = `Connection failed (HTTP ${response.status})`;
                }
            } catch (error) {
                statusDiv.className = 'connection-status error';
                statusDiv.textContent = `Connection error: ${error.message}`;
            }
        }

        // Convert returns array format to HistoricalData.txt string format
        // Input: [{ year: 2020, return: 12.5 }, { year: 2021, return: -3.2 }, ...]
        // Output: "2020: 12.50%\n2021: -3.20%\n..."
        function convertReturnsArrayToString(returnsArray) {
            if (!Array.isArray(returnsArray) || returnsArray.length === 0) {
                return '';
            }

            // Sort by year ascending
            const sorted = [...returnsArray].sort((a, b) => a.year - b.year);

            // Convert to string format matching HistoricalData.txt
            return sorted.map(item => `${item.year}: ${item.return.toFixed(2)}%`).join('\n');
        }

        // Fetch asset data from Tiingo and add to historicalDataLibrary
        async function fetchTiingoAsset() {
            const symbolInput = document.getElementById('tiingo-fetch-symbol');
            const statusDiv = document.getElementById('tiingo-status');
            const apiKey = settingsState.apiKeys.tiingo;

            if (!apiKey) {
                statusDiv.className = 'connection-status error';
                statusDiv.textContent = 'Please enter and save your Tiingo API key first';
                return;
            }

            const symbol = symbolInput.value.trim().toUpperCase();
            if (!symbol) {
                statusDiv.className = 'connection-status error';
                statusDiv.textContent = 'Please enter a ticker symbol';
                return;
            }

            statusDiv.className = 'connection-status';
            statusDiv.textContent = `Fetching ${symbol} data from Tiingo...`;

            try {
                const provider = dataProviders.tiingo;
                let fetchUrl = provider.endpoint(symbol, apiKey);

                // Apply CORS proxy if configured
                if (settingsState.corsProxyUrl) {
                    fetchUrl = settingsState.corsProxyUrl + encodeURIComponent(fetchUrl);
                }

                const response = await fetch(fetchUrl);

                // Check for HTTP errors
                if (response.status === 404) {
                    statusDiv.className = 'connection-status error';
                    statusDiv.textContent = `Symbol "${symbol}" not found on Tiingo`;
                    return;
                }

                if (response.status === 429) {
                    statusDiv.className = 'connection-status error';
                    statusDiv.textContent = 'Rate limit exceeded. Please wait and try again later.';
                    return;
                }

                if (!response.ok) {
                    statusDiv.className = 'connection-status error';
                    statusDiv.textContent = `Fetch failed (HTTP ${response.status})`;
                    return;
                }

                const data = await response.json();

                // Check for Tiingo-specific errors
                if (data.detail) {
                    statusDiv.className = 'connection-status error';
                    statusDiv.textContent = data.detail;
                    return;
                }

                // Parse the response to get annual returns
                const returnsArray = provider.parseResponse(data, 1962, 100);

                if (!returnsArray || returnsArray.length === 0) {
                    statusDiv.className = 'connection-status error';
                    statusDiv.textContent = `No historical data found for ${symbol}`;
                    return;
                }

                // Convert to string format for historicalDataLibrary
                const returnsString = convertReturnsArrayToString(returnsArray);

                // Add to historicalDataLibrary with asset class
                const assetName = symbol;
                const assetClass = 'equity_stock'; // Default for stocks from Tiingo

                historicalDataLibrary[assetName] = returnsString;
                assetClassLibrary[assetName] = assetClass;

                // Also cache in browser storage
                setCachedHistoricalData(symbol, 'tiingo', returnsArray);

                // Refresh the Available Assets listbox
                populateMonteCarloListbox();

                // Update the single-asset dropdown too
                const dropdown = document.getElementById('historicalDataAsset');
                if (dropdown && !dropdown.querySelector(`option[value="${assetName}"]`)) {
                    const option = document.createElement('option');
                    option.value = assetName;
                    option.textContent = assetName;
                    dropdown.appendChild(option);

                    // Sort options alphabetically
                    const options = Array.from(dropdown.options).slice(1); // Skip first "None" option
                    options.sort((a, b) => a.textContent.localeCompare(b.textContent));
                    options.forEach(opt => dropdown.appendChild(opt));
                }

                // Success message
                const firstYear = returnsArray[0].year;
                const lastYear = returnsArray[returnsArray.length - 1].year;
                statusDiv.className = 'connection-status success';
                statusDiv.textContent = ` ${symbol} added! ${returnsArray.length} years of data (${firstYear}-${lastYear})`;

                // Clear input
                symbolInput.value = '';

                // Show toast notification
                showToast(`${symbol} added to Available Assets\n${returnsArray.length} years (${firstYear}-${lastYear})`, 'success', 4000);

            } catch (error) {
                statusDiv.className = 'connection-status error';
                statusDiv.textContent = `Fetch error: ${error.message}`;
            }
        }

        // Helper function to calculate annual returns from daily data (FMP, EODHD format)
        function calculateAnnualReturnsFromDaily(dailyData, startYear, period) {
            const yearlyPrices = {};

            // Group by year and get December closing price - collect ALL years
            dailyData.forEach(item => {
                const date = item.date;
                if (!date) return;

                const year = parseInt(date.substring(0, 4));
                const month = parseInt(date.substring(5, 7));

                // Remove year filtering - collect all available data
                if (month === 12) {
                    yearlyPrices[year] = parseFloat(item.adjClose || item.adjusted_close || item.close);
                }
            });

            // Calculate returns for all consecutive years
            const returns = [];
            const years = Object.keys(yearlyPrices).map(Number).sort();

            for (let i = 1; i < years.length; i++) {
                const prevYear = years[i - 1];
                const currentYear = years[i];
                const returnPct = ((yearlyPrices[currentYear] - yearlyPrices[prevYear]) / yearlyPrices[prevYear]) * 100;
                returns.push({ year: currentYear, return: returnPct });
            }

            return returns;
        }

        // Helper function to calculate annual returns from timestamps (Yahoo Finance format)
        function calculateAnnualReturnsFromTimestamps(timestamps, prices, startYear, period) {
            const yearlyPrices = {};

            // Group by year and get December closing price - collect ALL years
            timestamps.forEach((timestamp, index) => {
                const date = new Date(timestamp * 1000);
                const year = date.getFullYear();
                const month = date.getMonth() + 1; // 0-indexed

                // Remove year filtering - collect all available data
                if (prices[index] !== null && month === 12) {
                    yearlyPrices[year] = prices[index];
                }
            });

            // Calculate returns for all consecutive years
            const returns = [];
            const years = Object.keys(yearlyPrices).map(Number).sort();

            for (let i = 1; i < years.length; i++) {
                const prevYear = years[i - 1];
                const currentYear = years[i];
                const returnPct = ((yearlyPrices[currentYear] - yearlyPrices[prevYear]) / yearlyPrices[prevYear]) * 100;
                returns.push({ year: currentYear, return: returnPct });
            }

            return returns;
        }

        // Theme Toggle
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);

            const icon = document.getElementById('theme-icon');
            icon.textContent = newTheme === 'dark' ? 'dark_mode' : 'light_mode';

            localStorage.setItem('theme', newTheme);

            // Update charts if they exist
            updateChartTheme();
        }

        // Show Welcome Guide
        function showWelcomeGuide() {
            // Save current scroll position before navigating away
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                sessionStorage.setItem('resultsScrollPosition', mainContent.scrollTop.toString());
            }

            document.getElementById('results').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';

            // Hide TOC button when navigating away from results
            hideTOCButton();

            // Hide print button
            hidePrintButton();

            // Show back to results button if results exist
            showBackToResultsButton();

            // Collapse System Parameters section in mobile view
            collapseMobilePanel();

            // Scroll to top
            document.querySelector('.main-content').scrollTop = 0;

            // Reset dropdown to "None"
            document.getElementById('historicalDataAsset').value = '';
        }

        // Toggle Field Instructions
        function toggleFieldInstructions(mode) {
            // Determine which instructions section to toggle
            const instructionsDiv = mode === 'montecarlo'
                ? document.getElementById('fieldInstructionsMonteCarlo')
                : document.getElementById('fieldInstructionsSingle');

            const toggleBtn = mode === 'montecarlo'
                ? document.querySelector('.monte-carlo-guide')
                : document.querySelector('.single-asset-guide');

            const toggleIcon = toggleBtn.querySelector('.toggle-icon');
            const buttonText = toggleBtn.querySelector('span:nth-child(2)');

            // Get the other mode's elements (to potentially close them)
            const otherMode = mode === 'montecarlo' ? 'single' : 'montecarlo';
            const otherInstructionsDiv = otherMode === 'montecarlo'
                ? document.getElementById('fieldInstructionsMonteCarlo')
                : document.getElementById('fieldInstructionsSingle');
            const otherToggleBtn = otherMode === 'montecarlo'
                ? document.querySelector('.monte-carlo-guide')
                : document.querySelector('.single-asset-guide');

            const isCurrentlyHidden = window.getComputedStyle(instructionsDiv).display === 'none';
            if (isCurrentlyHidden) {
                // Open this section
                instructionsDiv.style.display = 'block';
                toggleBtn.classList.add('expanded');

                // Update button text
                const guideName = mode === 'montecarlo' ? 'Monte Carlo Field Guide' : 'Single Asset Field Guide';
                buttonText.textContent = guideName;
                toggleIcon.textContent = 'expand_less';

                // Close the other section if open
                if (otherInstructionsDiv && otherInstructionsDiv.style.display === 'block') {
                    otherInstructionsDiv.style.display = 'none';
                    if (otherToggleBtn) {
                        otherToggleBtn.classList.remove('expanded');
                        const otherIcon = otherToggleBtn.querySelector('.toggle-icon');
                        if (otherIcon) otherIcon.textContent = 'expand_more';
                    }
                }

                // Smooth scroll to instructions
                setTimeout(() => {
                    instructionsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
            } else {
                // Close this section
                instructionsDiv.style.display = 'none';
                toggleBtn.classList.remove('expanded');

                // Reset button text
                const guideName = mode === 'montecarlo' ? 'Monte Carlo Field Guide' : 'Single Asset Field Guide';
                buttonText.textContent = guideName;
                toggleIcon.textContent = 'expand_more';

                // Scroll back to toggle button
                setTimeout(() => {
                    toggleBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            }
        }

        /**
         * Mobile Panel Collapse/Expand Functionality
         * Only active on viewports 768px
         */

        // Check if we're in mobile view
        function isMobileView() {
            return window.innerWidth <= 768;
        }

        // Toggle the mobile panel collapsed state
        function toggleMobilePanel() {
            if (!isMobileView()) return;

            const leftPanel = document.querySelector('.left-panel');
            const toggleBtn = document.getElementById('mobileCollapseToggle');

            if (!leftPanel) return;

            const isCollapsed = leftPanel.classList.toggle('mobile-collapsed');

            // Update ARIA attribute for accessibility
            if (toggleBtn) {
                toggleBtn.setAttribute('aria-expanded', !isCollapsed);
            }

            // Store preference in sessionStorage (resets on page reload)
            sessionStorage.setItem('mobilePanelCollapsed', isCollapsed);
        }

        // Expand the mobile panel (used before user needs to interact with form)
        function expandMobilePanel() {
            if (!isMobileView()) return;

            const leftPanel = document.querySelector('.left-panel');
            const toggleBtn = document.getElementById('mobileCollapseToggle');

            if (!leftPanel) return;

            leftPanel.classList.remove('mobile-collapsed');

            if (toggleBtn) {
                toggleBtn.setAttribute('aria-expanded', 'true');
            }

            sessionStorage.setItem('mobilePanelCollapsed', 'false');
        }

        // Collapse the mobile panel (used after successful simulation)
        function collapseMobilePanel() {
            if (!isMobileView()) return;

            const leftPanel = document.querySelector('.left-panel');
            const toggleBtn = document.getElementById('mobileCollapseToggle');

            if (!leftPanel) return;

            leftPanel.classList.add('mobile-collapsed');

            if (toggleBtn) {
                toggleBtn.setAttribute('aria-expanded', 'false');
            }

            sessionStorage.setItem('mobilePanelCollapsed', 'true');
        }

        /**
         * Desktop Panel Collapse/Expand Functionality
         * Only active on viewports >768px
         */

        // Check if we're in desktop view
        function isDesktopView() {
            return window.innerWidth > 768;
        }

        // Toggle the desktop panel collapsed state
        function toggleDesktopPanel() {
            if (!isDesktopView()) return;

            const leftPanel = document.querySelector('.left-panel');
            const toggleBtn = document.getElementById('desktopCollapseToggle');
            const icon = toggleBtn?.querySelector('.material-icons');

            if (!leftPanel) return;

            const isCollapsed = leftPanel.classList.toggle('desktop-collapsed');

            // Update icon direction
            if (icon) {
                icon.textContent = isCollapsed ? 'chevron_right' : 'chevron_left';
            }

            // Update ARIA attribute
            if (toggleBtn) {
                toggleBtn.setAttribute('aria-expanded', !isCollapsed);
            }

            // Store preference in sessionStorage
            sessionStorage.setItem('desktopPanelCollapsed', isCollapsed);
        }

        // Collapse desktop panel programmatically
        function collapseDesktopPanel() {
            if (!isDesktopView()) return;

            const leftPanel = document.querySelector('.left-panel');
            const toggleBtn = document.getElementById('desktopCollapseToggle');
            const icon = toggleBtn?.querySelector('.material-icons');

            if (!leftPanel) return;

            leftPanel.classList.add('desktop-collapsed');

            if (icon) {
                icon.textContent = 'chevron_right';
            }

            if (toggleBtn) {
                toggleBtn.setAttribute('aria-expanded', 'false');
            }

            sessionStorage.setItem('desktopPanelCollapsed', 'true');
        }

        // Expand desktop panel programmatically
        function expandDesktopPanel() {
            if (!isDesktopView()) return;

            const leftPanel = document.querySelector('.left-panel');
            const toggleBtn = document.getElementById('desktopCollapseToggle');
            const icon = toggleBtn?.querySelector('.material-icons');

            if (!leftPanel) return;

            leftPanel.classList.remove('desktop-collapsed');

            if (icon) {
                icon.textContent = 'chevron_left';
            }

            if (toggleBtn) {
                toggleBtn.setAttribute('aria-expanded', 'true');
            }

            sessionStorage.setItem('desktopPanelCollapsed', 'false');
        }

        // Allow clicking entire panel header to toggle (mobile only)
        document.addEventListener('DOMContentLoaded', function() {
            const panelHeader = document.querySelector('.panel-header');

            if (panelHeader) {
                panelHeader.addEventListener('click', function(e) {
                    // Only toggle if clicking on header itself, not any toggle button
                    // (toggle buttons have their own onclick handlers)
                    if (!e.target.closest('.mobile-collapse-toggle') &&
                        !e.target.closest('.desktop-collapse-toggle')) {
                        toggleMobilePanel();
                    }
                });
            }

            // Restore desktop panel state from sessionStorage
            if (isDesktopView()) {
                const desktopPanelCollapsed = sessionStorage.getItem('desktopPanelCollapsed') === 'true';
                if (desktopPanelCollapsed) {
                    const leftPanel = document.querySelector('.left-panel');
                    const toggleBtn = document.getElementById('desktopCollapseToggle');
                    const icon = toggleBtn?.querySelector('.material-icons');

                    if (leftPanel) {
                        leftPanel.classList.add('desktop-collapsed');
                    }

                    if (icon) {
                        icon.textContent = 'chevron_right';
                    }

                    if (toggleBtn) {
                        toggleBtn.setAttribute('aria-expanded', 'false');
                    }
                }
            }

            // Position regime calibration tooltip dynamically (escapes overflow:hidden)
            const regimeInfoIcon = document.querySelector('.regime-mode-toggle .info-icon');
            const regimeTooltip = document.querySelector('.regime-mode-toggle .info-tooltip');

            if (regimeInfoIcon && regimeTooltip) {
                function positionRegimeTooltip() {
                    const iconRect = regimeInfoIcon.getBoundingClientRect();
                    const tooltipWidth = regimeTooltip.offsetWidth || 340;

                    // Position below the icon
                    let top = iconRect.bottom + 8;
                    let left = iconRect.left + (iconRect.width / 2) - (tooltipWidth / 2);

                    // Keep within viewport
                    const viewportWidth = window.innerWidth;
                    const viewportHeight = window.innerHeight;

                    if (left < 10) left = 10;
                    if (left + tooltipWidth > viewportWidth - 10) {
                        left = viewportWidth - tooltipWidth - 10;
                    }

                    // If tooltip would go below viewport, position above icon
                    if (top + regimeTooltip.offsetHeight > viewportHeight - 10) {
                        top = iconRect.top - regimeTooltip.offsetHeight - 8;
                    }

                    regimeTooltip.style.top = top + 'px';
                    regimeTooltip.style.left = left + 'px';
                }

                regimeInfoIcon.addEventListener('mouseenter', positionRegimeTooltip);
                regimeInfoIcon.addEventListener('focus', positionRegimeTooltip);
            }
        });

        // Load saved theme and set current year defaults
        window.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            const icon = document.getElementById('theme-icon');
            icon.textContent = savedTheme === 'dark' ? 'dark_mode' : 'light_mode';

            // Set default years to current year
            const currentYear = new Date().getFullYear();
            document.getElementById('startYear').value = currentYear;
            document.getElementById('withdrawalStartYear').value = currentYear;

            // NOTE: Historical data loading moved to second DOMContentLoaded listener (line 8888)
            // This ensures proper async/await sequencing before Monte Carlo mode initialization
        });

        /**
         * Determine asset class for an asset
         * Looks up from assetClassLibrary (populated during data parsing)
         * Falls back to pattern matching if not found
         * @param {string} assetName - Name of the asset
         * @returns {string} - Asset class: 'equity_stock', 'equity_index', 'commodity', or 'bond'
         */
        function getAssetClass(assetName) {
            // Primary: lookup from parsed data
            if (assetClassLibrary[assetName]) {
                return assetClassLibrary[assetName];
            }

            // Fallback: pattern matching for assets not in library
            const nameLower = assetName.toLowerCase();
            if (nameLower.includes('gold') || nameLower.includes('silver') || nameLower.includes('commodity') || nameLower.includes('gld')) {
                return 'commodity';
            }
            if (nameLower.includes('bond') || nameLower.includes('treasury') || nameLower.includes('fixed income') || nameLower.includes('bnd') || nameLower.includes('agg') || nameLower.includes('tlt')) {
                return 'bond';
            }
            if (nameLower.includes('index') || nameLower.includes('idx') || nameLower.includes('s&p') ||
                nameLower.includes('qqq') || nameLower.includes('spy') || nameLower.includes('vti') || nameLower.includes('vanguard')) {
                return 'equity_index';
            }

            // Default
            return 'equity_stock';
        }

        // Embedded fallback historical data (used when file:/// protocol blocks fetch)
        const FALLBACK_HISTORICAL_DATA = `**AIR PRODUCTS & CHEMICALS INC [equity_stock]
2025: 14.88%
2026: 15.93%
2027: 17.61%
2028: -17.06%
2029: -16.20%
2030: 24.58%
2031: 7.07%
2032: 3.32%
2033: 31.40%
2034: 6.94%
2035: 4.88%
2036: 31.02%
2037: 38.63%
2038: -42.84%
2039: 55.43%
2040: 12.38%
2041: -6.44%
2042: 0.85%
2043: 34.69%
2044: 3.82%
2045: -8.66%
2046: 12.35%
2047: 16.29%
2048: -1.72%
2049: 47.90%
2050: 17.65%
2051: 13.06%
2052: 2.14%
2053: -10.97%
2054: 1.30%
2055: -2.40%

**AMD [equity_stock]
2025: 58.75%
2026: 28.35%
2027: -22.91%
2028: 51.58%
2029: 98.76%
2030: -38.45%
2031: -3.88%
2032: -69.19%
2033: 84.15%
2034: 48.45%
2035: 41.59%
2036: -12.92%
2037: -18.78%
2038: -72.64%
2039: 351.91%
2040: -14.61%
2041: -37.28%
2042: -59.57%
2043: 60.17%
2044: -31.32%
2045: 7.21%
2046: 295.12%
2047: -9.35%
2048: 79.57%
2049: 148.43%
2050: 99.98%
2051: 56.91%
2052: -54.99%
2053: 127.59%
2054: 16.80%
2055: -4.50%

**Amazon-m2054 [equity_stock]
2025: 156.38%
2026: 966.39%
2027: 42.18%
2028: -79.56%
2029: -30.47%
2030: 74.58%
2031: 178.56%
2032: -15.83%
2033: 6.46%
2034: -16.31%
2035: 134.77%
2036: -44.65%
2037: 162.32%
2038: 33.81%
2039: -3.83%
2040: 44.93%
2041: 58.96%
2042: -22.18%
2043: 117.78%
2044: 10.95%
2045: 55.96%
2046: 28.43%
2047: 23.03%
2048: 76.26%
2049: 2.38%
2050: -49.62%
2051: 80.88%
2052: 44.39%
2053: 5.21%
2054: 25.02%
2055: 17.88%

**Apple [equity_stock]
2025: -18.27%
2026: -34.51%
2027: -37.13%
2028: 211.90%
2029: 151.15%
2030: -71.06%
2031: 47.23%
2032: -34.57%
2033: 49.13%
2034: 201.36%
2035: 123.26%
2036: 18.01%
2037: 133.47%
2038: -56.91%
2039: 146.90%
2040: 53.07%
2041: 25.56%
2042: 31.40%
2043: 5.42%
2044: 37.72%
2045: -4.64%
2046: 10.03%
2047: 46.11%
2048: -6.79%
2049: 86.16%
2050: 80.75%
2051: 33.82%
2052: -26.83%
2053: 48.18%
2054: 30.07%
2055: 8.56%

**AUTOMATIC DATA PROCESSING INC [equity_stock]
2025: 23.72%
2026: 21.36%
2027: 35.88%
2028: 15.68%
2029: 0.11%
2030: 25.10%
2031: 8.35%
2032: -18.79%
2033: 3.65%
2034: -3.61%
2035: 5.67%
2036: 18.26%
2037: 4.86%
2038: -15.22%
2039: 5.48%
2040: 10.96%
2041: 17.55%
2042: 6.94%
2043: 31.86%
2044: 25.75%
2045: 3.03%
2046: 22.51%
2047: 16.03%
2048: -11.08%
2049: 31.78%
2050: 3.73%
2051: 42.66%
2052: -2.33%
2053: -2.39%
2054: 29.50%
2055: 14.20%

**BROADCOM INC-2042 [equity_stock]
2025: 13.04%
2026: 55.33%
2027: 1.58%
2028: 9.67%
2029: 67.08%
2030: 90.22%
2031: 44.30%
2032: 21.78%
2033: 45.33%
2034: -1.02%
2035: 24.28%
2036: 38.55%
2037: 51.97%
2038: -15.97%
2039: 99.64%
2040: 107.70%
2041: 42.29%
2042: 16.00%
2043: 32.39%
2044: 13.69%
2045: 1.38%
2046: 11.96%
2047: 21.83%
2048: -4.38%
2049: 31.49%
2050: 18.40%
2051: 28.71%
2052: -18.11%
2053: 26.29%
2054: 25.02%
2055: 16.63%

**CHEVRON CORP [equity_stock]
2025: 30.65%
2026: 30.50%
2027: 24.26%
2028: 0.18%
2029: 20.93%
2030: 9.94%
2031: -3.39%
2032: -12.98%
2033: 6.90%
2034: 31.70%
2035: 14.16%
2036: 21.90%
2037: 25.21%
2038: -9.84%
2039: -3.81%
2040: 21.93%
2041: 22.18%
2042: -0.66%
2043: 16.52%
2044: -3.93%
2045: -18.99%
2046: 36.65%
2047: 6.36%
2048: -13.24%
2049: 7.77%
2050: -29.98%
2051: 46.28%
2052: 58.46%
2053: -13.92%
2054: 13.20%
2055: 8.50%

**CISCO SYSTEMS INC [equity_stock]
2025: 88.01%
2026: 66.82%
2027: 38.16%
2028: 151.78%
2029: 130.34%
2030: -28.58%
2031: -52.88%
2032: -27.42%
2033: 88.13%
2034: 2.12%
2035: -14.93%
2036: 61.21%
2037: 3.19%
2038: -25.25%
2039: 47.78%
2040: -15.42%
2041: -2.31%
2042: 15.86%
2043: 18.89%
2044: 28.02%
2045: 0.90%
2046: 15.01%
2047: 28.32%
2048: 16.71%
2049: 14.39%
2050: -3.88%
2051: 45.83%
2052: -22.39%
2053: 10.15%
2054: 21.40%
2055: 6.20%

**CME GROUP INC CL A-2049 [equity_stock]
2025: 14.00%
2026: 78.65%
2027: 125.75%
2028: 52.87%
2029: 53.68%
2030: 51.57%
2031: -32.55%
2032: 37.37%
2033: 0.69%
2034: -16.96%
2035: 8.93%
2036: 45.54%
2037: 10.97%
2038: 4.88%
2039: 29.35%
2040: 25.86%
2041: 31.84%
2042: 24.33%
2043: -3.45%
2044: 25.86%
2045: -18.02%
2046: 15.54%
2047: 2.45%
2048: 20.30%
2049: 31.49%
2050: 18.40%
2051: 28.71%
2052: -18.11%
2053: 26.29%
2054: 25.02%
2055: 16.63%

**CocaCola [equity_stock]
2025: 46.10%
2026: 43.20%
2027: 37.60%
2028: 1.30%
2029: -15.80%
2030: 9.30%
2031: -8.00%
2032: -2.80%
2033: 19.30%
2034: -17.70%
2035: -0.30%
2036: 19.80%
2037: 29.80%
2038: -24.10%
2039: 30.10%
2040: 18.50%
2041: 9.50%
2042: 5.30%
2043: 17.20%
2044: 5.30%
2045: 5.00%
2046: -0.30%
2047: 10.70%
2048: 3.20%
2049: 20.80%
2050: 11.20%
2051: 11.40%
2052: 10.60%
2053: -4.30%
2054: 15.60%
2055: 8.90%

**ConocoPhillips-2049 [equity_stock]
2025: -5.70%
2026: 7.70%
2027: 26.60%
2028: 27.20%
2029: 30.10%
2030: 38.60%
2031: -33.60%
2032: 3.50%
2033: 38.50%
2034: 20.30%
2035: 8.60%
2036: 19.40%
2037: -8.30%
2038: -18.30%
2039: 13.90%
2040: 9.00%
2041: 3.10%
2042: 11.20%
2043: -34.80%
2044: 88.50%
2045: 71.00%
2046: -5.80%
2047: 11.30%
2048: -12.40%
2049: 31.49%
2050: 18.40%
2051: 28.71%
2052: -18.11%
2053: 26.29%
2054: 25.02%
2055: 16.63%

**CORNING INC [equity_stock]
2025: 11.95%
2026: 39.88%
2027: 15.35%
2028: 59.45%
2029: 233.15%
2030: -56.33%
2031: -83.18%
2032: -62.30%
2033: 298.53%
2034: 4.87%
2035: 64.91%
2036: -3.81%
2037: 29.54%
2038: -45.72%
2039: 53.62%
2040: -0.46%
2041: -31.79%
2042: 1.40%
2043: 42.66%
2044: 31.81%
2045: -19.67%
2046: 35.85%
2047: 32.74%
2048: -6.44%
2049: -0.38%
2050: 22.82%
2051: 4.29%
2052: -11.97%
2053: -4.31%
2054: 76.80%
2055: 22.50%

**DELL TECHNOLOGIES INC CL C-2035 [equity_stock]
2025: 27.84%
2026: 47.86%
2027: 8.59%
2028: 5.16%
2029: 42.62%
2030: 51.21%
2031: -28.40%
2032: 90.20%
2033: 50.64%
2034: 12.79%
2035: 4.91%
2036: 15.79%
2037: 5.49%
2038: -37.00%
2039: 26.46%
2040: 15.06%
2041: 2.11%
2042: 16.00%
2043: 32.39%
2044: 13.69%
2045: 1.38%
2046: 11.96%
2047: 21.83%
2048: -4.38%
2049: 31.49%
2050: 18.40%
2051: 28.71%
2052: -18.11%
2053: 26.29%
2054: 25.02%
2055: 16.63%

**EATON CORP PLC [equity_stock]
2025: 16.35%
2026: 28.98%
2027: 15.54%
2028: 0.17%
2029: 7.15%
2030: 0.10%
2031: 7.42%
2032: -6.91%
2033: 40.06%
2034: 22.51%
2035: 4.05%
2036: 17.06%
2037: 26.69%
2038: -38.64%
2039: 22.79%
2040: 52.88%
2041: -6.78%
2042: 14.36%
2043: 46.77%
2044: -9.83%
2045: -18.57%
2046: 31.06%
2047: 18.39%
2048: -11.98%
2049: 38.64%
2050: 27.67%
2051: 46.33%
2052: 0.81%
2053: 54.38%
2054: 45.10%
2055: 18.40%

**EXXON MOBIL CORP [equity_stock]
2025: 43.14%
2026: 23.32%
2027: 24.58%
2028: 18.49%
2029: 21.80%
2030: 8.66%
2031: -5.70%
2032: -11.23%
2033: 20.31%
2034: 28.30%
2035: 11.75%
2036: 23.00%
2037: 24.28%
2038: -13.04%
2039: -12.87%
2040: 11.25%
2041: 18.47%
2042: 2.89%
2043: 16.60%
2044: -2.85%
2045: -12.92%
2046: 19.98%
2047: -7.02%
2048: -15.11%
2049: 10.45%
2050: -36.31%
2051: 57.65%
2052: 87.26%
2053: -6.11%
2054: 21.50%
2055: 11.40%

**FASTENAL CO [equity_stock]
2025: 45.42%
2026: 41.67%
2027: 12.18%
2028: 32.86%
2029: 30.63%
2030: -9.62%
2031: 29.89%
2032: 23.36%
2033: 31.90%
2034: 29.50%
2035: 35.59%
2036: 6.00%
2037: 21.13%
2038: -10.97%
2039: 13.06%
2040: 42.14%
2041: 8.87%
2042: 12.33%
2043: 4.89%
2044: 2.21%
2045: -13.43%
2046: 15.65%
2047: 17.58%
2048: -3.83%
2049: 46.12%
2050: 34.02%
2051: 30.56%
2052: -21.46%
2053: 41.33%
2054: 20.20%
2055: 15.60%

**Ford [equity_stock]
2025: 10.90%
2026: 25.10%
2027: 53.60%
2028: 89.20%
2029: 8.40%
2030: -24.30%
2031: 14.50%
2032: -35.20%
2033: 84.70%
2034: 0.10%
2035: -10.60%
2036: -3.00%
2037: -0.40%
2038: -54.70%
2039: 336.70%
2040: 67.80%
2041: -34.60%
2042: 23.20%
2043: 20.30%
2044: 2.70%
2045: -5.30%
2046: -2.30%
2047: 4.70%
2048: -35.60%
2049: 26.60%
2050: 4.60%
2051: 167.30%
2052: -42.10%
2053: 9.30%
2054: -4.30%
2055: -2.80%

**GENERAL DYNAMICS CORP [equity_stock]
2025: 15.15%
2026: 18.23%
2027: 19.34%
2028: 12.78%
2029: 25.30%
2030: 49.34%
2031: 0.65%
2032: -4.95%
2033: 20.24%
2034: 25.46%
2035: 9.87%
2036: 18.27%
2037: 23.95%
2038: -30.08%
2039: 21.05%
2040: 6.94%
2041: -2.62%
2042: 7.74%
2043: 39.88%
2044: 49.60%
2045: 0.98%
2046: 28.53%
2047: 19.46%
2048: -22.31%
2049: 16.15%
2050: -14.39%
2051: 42.44%
2052: 18.45%
2053: 5.86%
2054: 16.50%
2055: 9.20%

**Gold (GLD)-2047 [commodity]
2025: 5.40%
2026: 17.50%
2027: 23.50%
2028: 31.00%
2029: 5.60%
2030: 24.60%
2031: 29.60%
2032: 10.10%
2033: 7.10%
2034: -28.00%
2035: -1.80%
2036: -10.40%
2037: 8.40%
2038: 13.20%
2039: -1.60%
2040: 18.30%
2041: 25.10%
2042: -3.60%
2043: -0.40%
2044: 13.20%
2045: 27.20%
2046: 27.00%
2047: 21.83%
2048: -4.38%
2049: 31.49%
2050: 18.40%
2051: 28.71%
2052: -18.11%
2053: 26.29%
2054: 25.02%
2055: 64.61%

**Google-m2047 [equity_stock]
2025: 92.14%
2026: 115.19%
2027: 11.00%
2028: 50.17%
2029: -55.51%
2030: 101.52%
2031: -4.20%
2032: 8.74%
2033: 9.52%
2034: 58.43%
2035: -5.39%
2036: 46.61%
2037: 1.86%
2038: 32.93%
2039: -0.80%
2040: 28.18%
2041: 30.85%
2042: 65.30%
2043: -39.09%
2044: 58.32%
2045: 35.51%
2046: 65.35%
2047: 21.83%
2048: -4.38%
2049: 31.49%
2050: 18.40%
2051: 28.71%
2052: -18.11%
2053: 26.29%
2054: 25.02%
2055: 17.88%

**HOME DEPOT INC [equity_stock]
2025: 1.90%
2026: 10.90%
2027: 74.00%
2028: 99.40%
2029: 67.90%
2030: -9.90%
2031: 0.10%
2032: -25.20%
2033: 40.00%
2034: 16.90%
2035: -2.30%
2036: -3.80%
2037: -12.10%
2038: -10.30%
2039: 25.70%
2040: 21.20%
2041: 24.30%
2042: 43.10%
2043: 27.20%
2044: 28.00%
2045: 23.30%
2046: 1.90%
2047: 41.20%
2048: -9.50%
2049: 28.30%
2050: 23.60%
2051: 56.20%
2052: -21.90%
2053: 12.00%
2054: 20.30%
2055: 10.50%

**HP INC [equity_stock]
2025: 41.76%
2026: 22.38%
2027: 32.19%
2028: 62.47%
2029: 65.23%
2030: -40.67%
2031: -37.03%
2032: -35.26%
2033: 31.02%
2034: 6.94%
2035: 2.12%
2036: 22.34%
2037: 15.65%
2038: -46.73%
2039: 44.59%
2040: -1.78%
2041: -19.49%
2042: -31.76%
2043: 96.65%
2044: 27.53%
2045: -13.06%
2046: 28.35%
2047: 43.70%
2048: -2.01%
2049: 0.50%
2050: -1.63%
2051: 56.12%
2052: -27.42%
2053: 13.68%
2054: 23.20%
2055: 8.50%

**IBM [equity_stock]
2025: 31.84%
2026: 67.56%
2027: 39.29%
2028: 77.29%
2029: -20.52%
2030: -20.84%
2031: 42.66%
2032: -35.53%
2033: 20.51%
2034: 7.15%
2035: -15.80%
2036: 19.78%
2037: 12.91%
2038: -20.76%
2039: 58.60%
2040: 14.22%
2041: 7.49%
2042: 1.55%
2043: 0.22%
2044: -12.39%
2045: -11.93%
2046: 20.61%
2047: -7.57%
2048: -22.58%
2049: 21.90%
2050: -3.85%
2051: 9.35%
2052: 8.87%
2053: 19.33%
2054: 51.50%
2055: 18.20%

**Intel [equity_stock]
2025: 57.06%
2026: 104.97%
2027: 14.61%
2028: 51.53%
2029: 39.81%
2030: 4.83%
2031: -43.68%
2032: -51.35%
2033: 98.74%
2034: -16.03%
2035: 15.53%
2036: 5.75%
2037: 11.21%
2038: -42.27%
2039: 47.98%
2040: 3.48%
2041: 17.15%
2042: -15.11%
2043: 27.24%
2044: 42.47%
2045: -3.89%
2046: 6.95%
2047: 27.13%
2048: 1.68%
2049: 30.15%
2050: -14.63%
2051: 6.01%
2052: -46.54%
2053: 95.03%
2054: -20.50%
2055: -15.00%

**MCDONALDS CORP [equity_stock]
2025: 55.08%
2026: 0.05%
2027: 5.64%
2028: 62.00%
2029: 13.56%
2030: -9.38%
2031: -2.31%
2032: -35.26%
2033: 25.54%
2034: 31.42%
2035: 5.78%
2036: 31.79%
2037: 35.84%
2038: 8.46%
2039: 3.12%
2040: 24.18%
2041: 34.73%
2042: -9.84%
2043: 13.90%
2044: -0.01%
2045: 29.83%
2046: 15.01%
2047: 44.59%
2048: -4.56%
2049: 13.56%
2050: 10.96%
2051: 27.64%
2052: -0.34%
2053: 14.80%
2054: 2.10%
2055: 6.50%

**Meta-m2039 [equity_stock]
2025: -30.37%
2026: 105.30%
2027: 42.76%
2028: 34.15%
2029: 9.93%
2030: 53.38%
2031: -25.71%
2032: 56.57%
2033: 33.09%
2034: 23.13%
2035: -64.22%
2036: 194.13%
2037: 65.42%
2038: 12.74%
2039: 26.46%
2040: 15.06%
2041: 2.11%
2042: 16.00%
2043: 32.39%
2044: 13.69%
2045: 1.38%
2046: 11.96%
2047: 21.83%
2048: -4.38%
2049: 31.49%
2050: 18.40%
2051: 28.71%
2052: -18.11%
2053: 26.29%
2054: 25.02%
2055: 17.88%

**Microsoft [equity_stock]
2025: 43.56%
2026: 88.32%
2027: 56.43%
2028: 114.60%
2029: 68.36%
2030: -62.85%
2031: 52.74%
2032: -21.96%
2033: 5.88%
2034: -2.37%
2035: -2.13%
2036: 14.19%
2037: 19.22%
2038: -45.39%
2039: 56.79%
2040: -8.43%
2041: -6.99%
2042: 2.89%
2043: 40.06%
2044: 24.16%
2045: 19.44%
2046: 12.00%
2047: 37.66%
2048: 18.74%
2049: 55.26%
2050: 41.04%
2051: 51.21%
2052: -28.69%
2053: 56.80%
2054: 12.09%
2055: 14.74%

**Nvidia-m2052 [equity_stock]
2025: 138.41%
2026: 39.61%
2027: 308.36%
2028: -82.80%
2029: 101.56%
2030: 1.55%
2031: 55.18%
2032: 102.46%
2033: 37.88%
2034: -76.28%
2035: 131.47%
2036: -17.56%
2037: -10.00%
2038: -11.54%
2039: 30.67%
2040: 25.16%
2041: 64.39%
2042: 223.85%
2043: 81.28%
2044: -31.01%
2045: 76.25%
2046: 121.93%
2047: 125.29%
2048: -50.31%
2049: 238.87%
2050: 171.17%
2051: 38.88%
2052: -18.11%
2053: 26.29%
2054: 25.02%
2055: 17.88%

**Oracle [equity_stock]
2025: 39.50%
2026: 52.88%
2027: -22.25%
2028: 88.06%
2029: 189.65%
2030: -57.25%
2031: -45.91%
2032: -31.78%
2033: 22.61%
2034: 5.67%
2035: -24.49%
2036: 39.43%
2037: 29.43%
2038: -15.40%
2039: 39.61%
2040: 31.97%
2041: -12.42%
2042: 30.82%
2043: 15.63%
2044: 18.06%
2045: -18.06%
2046: 6.94%
2047: 25.26%
2048: -4.31%
2049: 19.46%
2050: 22.95%
2051: 36.65%
2052: -5.92%
2053: 29.35%
2054: 23.40%
2055: 14.72%

**PepsiCola [equity_stock]
2025: 53.60%
2026: 11.20%
2027: 35.50%
2028: 12.30%
2029: -16.40%
2030: 30.20%
2031: 4.60%
2032: -3.80%
2033: 16.00%
2034: 5.30%
2035: 0.10%
2036: 7.70%
2037: 21.00%
2038: -22.30%
2039: 14.10%
2040: 9.30%
2041: 5.20%
2042: -1.70%
2043: 23.20%
2044: 17.60%
2045: 8.50%
2046: 6.70%
2047: 17.60%
2048: -5.10%
2049: 25.10%
2050: 9.20%
2051: 20.30%
2052: 6.70%
2053: -6.00%
2054: 2.10%
2055: 4.80%

**QQQ-2052 [equity_index]
2025: 61.43%
2026: -36.95%
2027: -32.74%
2028: -37.58%
2029: 49.65%
2030: 10.42%
2031: 1.55%
2032: 7.10%
2033: 19.14%
2034: -41.73%
2035: 54.68%
2036: 20.06%
2037: 3.42%
2038: 18.11%
2039: 36.63%
2040: 19.18%
2041: 9.45%
2042: 7.07%
2043: 32.66%
2044: -0.14%
2045: 38.96%
2046: 48.60%
2047: 27.24%
2048: -32.58%
2049: 54.85%
2050: 24.50%
2051: 24.70%
2052: -18.11%
2053: 26.29%
2054: 25.02%
2055: 19.60%

**Qualcomm [equity_stock]
2025: 13.93%
2026: 25.68%
2027: 22.31%
2028: 142.14%
2029: 379.86%
2030: -38.64%
2031: -37.33%
2032: 32.88%
2033: 53.62%
2034: -4.38%
2035: 5.51%
2036: -11.08%
2037: 7.42%
2038: -6.74%
2039: 30.69%
2040: 8.79%
2041: 13.72%
2042: 12.87%
2043: 19.18%
2044: 0.16%
2045: -32.74%
2046: 34.02%
2047: -2.00%
2048: -11.19%
2049: 57.06%
2050: 74.90%
2051: 22.15%
2052: -38.74%
2053: 33.19%
2054: 20.20%
2055: 13.19%

**Rivian-2030 [equity_stock]
2025: 29.14%
2026: -82.20%
2027: 27.00%
2028: -53.00%
2029: -45.00%
2030: -9.10%
2031: -11.89%
2032: 19.56%
2033: 28.68%
2034: 10.88%
2035: 4.91%
2036: 15.79%
2037: 5.49%
2038: -37.00%
2039: 26.46%
2040: 15.06%
2041: 2.11%
2042: 16.00%
2043: 32.39%
2044: 13.69%
2045: 1.38%
2046: 11.96%
2047: 21.83%
2048: -4.38%
2049: 31.49%
2050: 18.40%
2051: 28.71%
2052: -18.11%
2053: 26.29%
2054: 25.02%
2055: 16.63%

**RTX CORP [equity_stock]
2025: 47.96%
2026: 34.42%
2027: 12.87%
2028: 15.71%
2029: 23.36%
2030: 21.00%
2031: -28.98%
2032: -4.32%
2033: 54.34%
2034: 9.38%
2035: -0.66%
2036: 13.43%
2037: 17.06%
2038: -32.55%
2039: 8.51%
2040: 14.89%
2041: -6.44%
2042: 15.01%
2043: 40.58%
2044: 2.94%
2045: -13.25%
2046: 16.85%
2047: 26.54%
2048: -15.93%
2049: 42.66%
2050: -19.95%
2051: 22.56%
2052: 18.48%
2053: -0.62%
2054: 46.50%
2055: 14.50%

**S&P500 [equity_index]
2025: 37.58%
2026: 22.96%
2027: 33.36%
2028: 28.58%
2029: 21.04%
2030: -9.10%
2031: -11.89%
2032: -22.10%
2033: 28.68%
2034: 10.88%
2035: 4.91%
2036: 15.79%
2037: 5.49%
2038: -37.00%
2039: 26.46%
2040: 15.06%
2041: 2.11%
2042: 16.00%
2043: 32.39%
2044: 13.69%
2045: 1.38%
2046: 11.96%
2047: 21.83%
2048: -4.38%
2049: 31.49%
2050: 18.40%
2051: 28.71%
2052: -18.11%
2053: 26.29%
2054: 25.02%
2055: 16.44%

**STARBUCKS CORP [equity_stock]
2025: 47.96%
2026: 42.66%
2027: 19.46%
2028: 51.58%
2029: 29.50%
2030: -14.63%
2031: 30.15%
2032: -0.98%
2033: 47.34%
2034: 67.89%
2035: -3.49%
2036: 22.18%
2037: -17.58%
2038: -48.77%
2039: 148.43%
2040: 38.64%
2041: 44.59%
2042: 15.65%
2043: 48.60%
2044: 5.67%
2045: 48.45%
2046: -7.57%
2047: 3.48%
2048: 15.01%
2049: 36.65%
2050: 24.18%
2051: 9.94%
2052: -14.39%
2053: -2.31%
2054: 12.50%
2055: 6.50%

**Tesla-m2041 [equity_stock]
2025: 11.47%
2026: 7.25%
2027: 18.59%
2028: 344.14%
2029: 47.85%
2030: 7.91%
2031: -10.97%
2032: 45.70%
2033: 6.89%
2034: 25.70%
2035: 743.44%
2036: 49.76%
2037: -65.03%
2038: 101.72%
2039: 62.52%
2040: 11.36%
2041: 2.11%
2042: 16.00%
2043: 32.39%
2044: 13.69%
2045: 1.38%
2046: 11.96%
2047: 21.83%
2048: -4.38%
2049: 31.49%
2050: 18.40%
2051: 28.71%
2052: -18.11%
2053: 26.29%
2054: 25.02%
2055: 17.88%

**UNITED PARCEL SERVICE INC CL B-2052 [equity_stock]
2025: 58.60%
2026: -7.63%
2027: 33.72%
2028: -0.76%
2029: 36.65%
2030: 24.33%
2031: 0.10%
2032: 3.82%
2033: -19.49%
2034: -26.98%
2035: 6.90%
2036: 14.39%
2037: 2.12%
2038: 0.98%
2039: 51.57%
2040: 9.35%
2041: 5.75%
2042: 0.85%
2043: 29.83%
2044: -4.56%
2045: -0.98%
2046: 27.67%
2047: 19.18%
2048: 27.24%
2049: 4.88%
2050: -9.83%
2051: -2.31%
2052: -18.11%
2053: 26.29%
2054: 25.02%
2055: 16.63%

**US BANCORP DE NEW [equity_stock]
2025: 63.57%
2026: 54.41%
2027: 87.35%
2028: 62.09%
2029: -31.85%
2030: 10.06%
2031: -9.98%
2032: 1.39%
2033: 40.34%
2034: 5.17%
2035: -4.57%
2036: 21.08%
2037: -12.30%
2038: -21.20%
2039: -10.00%
2040: 19.81%
2041: 0.30%
2042: 18.08%
2043: 26.49%
2044: 11.26%
2045: -5.07%
2046: 20.39%
2047: 4.30%
2048: -14.71%
2049: 29.74%
2050: -21.42%
2051: 20.56%
2052: -22.36%
2053: -0.76%
2054: 10.51%
2055: 7.17%

**Vanguard Tot Stk Mkt IDX-2050 [equity_index]
2025: -10.57%
2026: -20.96%
2027: 31.35%
2028: 12.36%
2029: 6.08%
2030: 15.51%
2031: 5.49%
2032: -36.98%
2033: 28.60%
2034: 17.20%
2035: 0.96%
2036: 16.25%
2037: 33.35%
2038: 12.43%
2039: 0.29%
2040: 12.53%
2041: 21.16%
2042: -5.17%
2043: 30.80%
2044: 20.95%
2045: 25.72%
2046: -19.53%
2047: 26.06%
2048: 23.28%
2049: 16.44%
2050: 18.40%
2051: 28.71%
2052: -18.11%
2053: 26.29%
2054: 25.02%
2055: 16.63%

**Walmart [equity_stock]
2025: 23.33%
2026: 19.68%
2027: 37.00%
2028: 72.33%
2029: 71.93%
2030: -29.28%
2031: 8.79%
2032: -11.66%
2033: -1.02%
2034: 3.19%
2035: 0.22%
2036: -1.55%
2037: 6.95%
2038: 19.46%
2039: 2.12%
2040: 3.48%
2041: 12.78%
2042: 16.85%
2043: 18.48%
2044: 9.38%
2045: -26.98%
2046: 15.65%
2047: 46.28%
2048: -2.31%
2049: 30.15%
2050: 23.63%
2051: 1.94%
2052: 1.30%
2053: 12.50%
2054: 23.20%
2055: 25.96%

**WEC ENERGY GROUP INC [equity_stock]
2025: 35.84%
2026: 3.12%
2027: 12.78%
2028: 16.03%
2029: -14.39%
2030: 24.33%
2031: 7.74%
2032: 3.82%
2033: 18.11%
2034: 20.93%
2035: 9.35%
2036: 19.78%
2037: 15.54%
2038: -13.24%
2039: 15.93%
2040: 20.30%
2041: 23.63%
2042: 1.55%
2043: 8.46%
2044: 28.53%
2045: -4.31%
2046: 22.18%
2047: 19.34%
2048: 3.19%
2049: 27.24%
2050: 11.21%
2051: 7.07%
2052: -2.50%
2053: -4.10%
2054: 24.20%
2055: 14.50%

**WILLIAMS COS INC DEL [equity_stock]
2025: 58.60%
2026: 27.67%
2027: 4.88%
2028: -19.49%
2029: 31.97%
2030: 104.97%
2031: -37.03%
2032: -35.26%
2033: 38.64%
2034: 24.50%
2035: 39.43%
2036: 32.66%
2037: 29.43%
2038: -35.53%
2039: 42.14%
2040: 25.30%
2041: 14.22%
2042: -6.78%
2043: 25.10%
2044: 17.58%
2045: -32.55%
2046: 38.96%
2047: 7.42%
2048: -6.44%
2049: 22.51%
2050: -19.67%
2051: 34.02%
2052: 30.65%
2053: 11.20%
2054: 28.10%
2055: 22.50%`;

        // Parse and load historical data from external file (with fallback to embedded data)
        async function loadHistoricalDataLibrary() {
            let historicalDataText = null;
            let usingFallback = false;

            try {
                // Try to fetch from external file first
                const response = await fetch('HistoricalData.txt');
                if (response.ok) {
                    historicalDataText = await response.text();
                    console.log(' Loaded historical data from HistoricalData.txt');
                } else {
                    throw new Error('Failed to fetch HistoricalData.txt');
                }
            } catch (error) {
                // Fall back to embedded data (works with file:// protocol)
                console.warn(' Could not load HistoricalData.txt from file system (CORS restriction)');
                console.info(' Using embedded fallback data. To update assets dynamically, run a local web server:');
                console.info('  python -m http.server');
                console.info('  Then open: http://localhost:8000/PortfolioStrategySimulator.html');
                historicalDataText = FALLBACK_HISTORICAL_DATA;
                usingFallback = true;
            }

            // Parse the data (same for both external and fallback)
            historicalDataLibrary = {};
            assetClassLibrary = {};  // Clear asset class lookup on reload

            const lines = historicalDataText.split('\n');
            let currentAsset = null;
            let currentData = [];

            lines.forEach(line => {
                if (line.startsWith('**')) {
                    // Save previous asset if exists
                    if (currentAsset) {
                        historicalDataLibrary[currentAsset] = currentData.join('\n');
                    }

                    // Parse new asset header
                    let rawHeader = line.substring(2).trim();
                    let assetClass = 'equity_stock'; // Default

                    // Extract asset class from bracket notation: **AssetName [asset_class]
                    const classMatch = rawHeader.match(/\s*\[(\w+)\]\s*$/);
                    if (classMatch) {
                        assetClass = classMatch[1];
                        rawHeader = rawHeader.replace(/\s*\[\w+\]\s*$/, '').trim();
                    }

                    // Use cleaned name (without [class] tag) as the asset key
                    currentAsset = rawHeader;
                    currentData = [];

                    // Store asset class in parallel lookup
                    assetClassLibrary[currentAsset] = assetClass;

                } else if (line.trim() && currentAsset) {
                    currentData.push(line.trim());
                }
            });

            // Save last asset
            if (currentAsset) {
                historicalDataLibrary[currentAsset] = currentData.join('\n');
                // assetClassLibrary already populated in the loop
            }

            // Populate dropdown
            const dropdown = document.getElementById('historicalDataAsset');
            const assetNames = Object.keys(historicalDataLibrary).sort();

            assetNames.forEach(assetName => {
                const option = document.createElement('option');
                option.value = assetName;
                option.textContent = assetName;
                dropdown.appendChild(option);
            });

            // Populate Monte Carlo asset listbox
            populateMonteCarloListbox();

            // Update available assets list in welcome guide
            const availableAssetsSpan = document.getElementById('availableAssets');
            if (availableAssetsSpan && assetNames.length > 0) {
                // Format as a clean list for multi-column display
                const assetListHTML = assetNames.map(name => `<span style="display: block; margin-bottom: 4px;"> ${name}</span>`).join('');
                availableAssetsSpan.innerHTML = `<strong style="display: block; margin-bottom: 8px;">Available assets:</strong>${assetListHTML}`;
            }
        }

        // Load selected asset's historical data
        function loadHistoricalAssetData() {
            const selectedAsset = document.getElementById('historicalDataAsset').value;
            const historicalDataTextarea = document.getElementById('historicalData');

            if (selectedAsset && historicalDataLibrary[selectedAsset]) {
                const rawData = historicalDataLibrary[selectedAsset];

                // Analyze the historical data
                const stats = getHistoricalDataStats(rawData);

                if (stats.hasData) {
                    // Get current year
                    const currentYear = new Date().getFullYear();

                    // Remap data to start from current year
                    const remappedData = remapHistoricalDataToCurrentYear(rawData, currentYear);

                    // Update textarea with remapped data
                    historicalDataTextarea.value = remappedData;

                    // Update asset name
                    document.getElementById('assetName').value = selectedAsset;

                    // Set start year to current year
                    document.getElementById('startYear').value = currentYear;
                    document.getElementById('withdrawalStartYear').value = currentYear;

                    // Auto-adjust period to match available data
                    document.getElementById('period').value = stats.totalYears;

                    // Show informative toast
                    const endYear = currentYear + stats.totalYears - 1;
                    showToast(
                        `${selectedAsset} data loaded and remapped\n` +
                        `${stats.totalYears} years (${stats.firstYear}-${stats.lastYear})  ${currentYear}-${endYear}`,
                        'success',
                        5000
                    );

                    // Store scroll position and run simulation
                    const mainContent = document.querySelector('.main-content');
                    const currentScrollPosition = mainContent.scrollTop;

                    runSimulation();

                    setTimeout(() => {
                        mainContent.scrollTop = currentScrollPosition;
                    }, 0);
                } else {
                    // No valid data found
                    historicalDataTextarea.value = rawData;
                    document.getElementById('assetName').value = selectedAsset;
                    showToast(`${selectedAsset} loaded but contains no valid data`, 'warning', 3000);
                }
            } else if (!selectedAsset) {
                // Reset to default state if "None" is selected
                historicalDataTextarea.value = '';

                // Hide results and show empty state
                document.getElementById('results').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';

                // Hide TOC button when navigating away from results
                hideTOCButton();

                // Reset stored results
                currentResults = null;
                currentParams = null;
            }
        }

        // Analyze historical data and return metadata
        function getHistoricalDataStats(dataText) {
            const lines = dataText.trim().split('\n');
            let firstValidYear = null;
            let lastValidYear = null;
            let validYearCount = 0;

            lines.forEach(line => {
                const match = line.match(/(\d{4})[:\s]+(.+)/);
                if (match) {
                    const year = parseInt(match[1]);
                    const value = match[2].trim();

                    // Count non-N/A values
                    if (value !== 'N/A' && !value.toLowerCase().includes('n/a')) {
                        if (firstValidYear === null) firstValidYear = year;
                        lastValidYear = year;
                        validYearCount++;
                    }
                }
            });

            return {
                firstYear: firstValidYear,
                lastYear: lastValidYear,
                totalYears: validYearCount,
                hasData: validYearCount > 0
            };
        }

        // Remap historical data to start from a target year (e.g., current year)
        function remapHistoricalDataToCurrentYear(dataText, targetStartYear) {
            const lines = dataText.trim().split('\n');
            const stats = getHistoricalDataStats(dataText);

            if (!stats.hasData) return dataText;

            const yearOffset = targetStartYear - stats.firstYear;
            let remappedLines = [];

            lines.forEach(line => {
                const match = line.match(/(\d{4})[:\s]+(.+)/);
                if (match) {
                    const originalYear = parseInt(match[1]);
                    const value = match[2];
                    const newYear = originalYear + yearOffset;
                    remappedLines.push(`${newYear}: ${value}`);
                }
            });

            return remappedLines.join('\n');
        }

        // Global state for simulation mode
        // Default to Monte Carlo (primary mode) - provides probabilistic risk assessment
        let currentSimulationMode = 'montecarlo'; // 'montecarlo' or 'single'
        let selectedPortfolioAssets = {}; // {assetName: weight}

        // OPrime Color palette for portfolio assets (used in asset list and weight distribution bar)
        // Soft blue to purple gradient with semantic colors
        const ASSET_COLORS = [
            '#4C6FFF', '#A855F7', '#38BDF8', '#22C55E', '#F97316',
            '#6B8CFF', '#C196FF', '#5DDBF1', '#4ADE80', '#FBBF24'
        ];

        // Switch between simulation modes
        // Toggle tax modeling inputs
        function toggleTaxInputs() {
            const enabled = document.getElementById('enableTaxModeling').checked;
            document.getElementById('taxInputsSection').style.display = enabled ? 'block' : 'none';
        }

        function toggleChaptersInputs() {
            const enabled = document.getElementById('enableChapters').checked;
            document.getElementById('chaptersSection').style.display = enabled ? 'block' : 'none';
        }

        function switchSimulationMode(mode) {
            currentSimulationMode = mode;

            // Update button states
            document.getElementById('singleAssetModeBtn').classList.toggle('active', mode === 'single');
            document.getElementById('monteCarloModeBtn').classList.toggle('active', mode === 'montecarlo');

            // Toggle content visibility
            document.getElementById('singleAssetContent').classList.toggle('hidden', mode === 'montecarlo');
            document.getElementById('monteCarloContent').classList.toggle('active', mode === 'montecarlo');

            // Show/hide portfolio presets section
            const presetsSection = document.getElementById('portfolioPresetsSection');
            if (presetsSection) {
                presetsSection.style.display = mode === 'montecarlo' ? 'block' : 'none';
                if (mode === 'montecarlo') {
                    populatePresetSelector();
                    loadLastPortfolioIfExists(); // Auto-restore last portfolio
                }
            }

            // Update button text
            const runButton = document.querySelector('.sticky-button-wrapper .button-primary');
            if (mode === 'montecarlo') {
                runButton.innerHTML = '<span class="material-icons" class="align-middle-mr-8">scatter_plot</span>Run Monte Carlo Simulation';
            } else {
                runButton.innerHTML = '<span class="material-icons" class="align-middle-mr-8">play_arrow</span>Run Simulation';
            }

            // Destroy all existing Chart.js instances to prevent "Canvas already in use" errors
            if (trendChart) {
                trendChart.destroy();
                trendChart = null;
            }
            if (debtChart) {
                debtChart.destroy();
                debtChart = null;
            }
            // Destroy Monte Carlo specific charts
            if (window.trendChartInstance) {
                window.trendChartInstance.destroy();
                window.trendChartInstance = null;
            }
            if (window.terminalDistributionChartInstance) {
                window.terminalDistributionChartInstance.destroy();
                window.terminalDistributionChartInstance = null;
            }
            if (window.sblocUtilizationChartInstance) {
                window.sblocUtilizationChartInstance.destroy();
                window.sblocUtilizationChartInstance = null;
            }
            if (window.marginCallRiskChartInstance) {
                window.marginCallRiskChartInstance.destroy();
                window.marginCallRiskChartInstance = null;
            }
            if (window.liquiditySafetyBufferChartInstance) {
                window.liquiditySafetyBufferChartInstance.destroy();
                window.liquiditySafetyBufferChartInstance = null;
            }
            if (window.netWorthPercentilesChartInstance) {
                window.netWorthPercentilesChartInstance.destroy();
                window.netWorthPercentilesChartInstance = null;
            }

            // Clear results when switching modes
            document.getElementById('results').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';

            // Hide TOC button when navigating away from results
            hideTOCButton();

            // Clean up mode-specific content to prevent display bugs
            const resultsDiv = document.getElementById('results');

            // If switching TO Single Asset mode, hide Monte Carlo elements
            if (mode === 'single') {
                const monteCarloSummaryCard = resultsDiv.querySelector('.monte-carlo-summary-card');
                if (monteCarloSummaryCard) {
                    monteCarloSummaryCard.style.display = 'none';
                }
                const performanceSummaryCard = resultsDiv.querySelector('.performance-summary-card');
                if (performanceSummaryCard) {
                    performanceSummaryCard.style.display = 'none';
                }
                const assetsCorrelationCard = resultsDiv.querySelector('.assets-correlation-card');
                if (assetsCorrelationCard) {
                    assetsCorrelationCard.style.display = 'none';
                }
                const expectedReturnCard = resultsDiv.querySelector('.expected-return-card');
                if (expectedReturnCard) {
                    expectedReturnCard.style.display = 'none';
                }
                const returnProbCard = resultsDiv.querySelector('.return-prob-card');
                if (returnProbCard) {
                    returnProbCard.style.display = 'none';
                }
                const monteCarloChartsSection = document.getElementById('monteCarloChartsSection');
                if (monteCarloChartsSection) {
                    monteCarloChartsSection.style.display = 'none';
                }
            }

            // Clear Key Metrics content to prevent stale data from previous mode
            const keyMetrics = document.getElementById('keyMetrics');
            if (keyMetrics) {
                keyMetrics.innerHTML = '';
            }
        }

        // Helper function to get asset type display label and CSS class
        function getAssetTypeInfo(assetClass) {
            switch (assetClass) {
                case 'bond':
                    return { label: 'BOND', cssClass: 'bond' };
                case 'commodity':
                    return { label: 'COMMODITY', cssClass: 'commodity' };
                case 'equity_index':
                    return { label: 'INDEX', cssClass: 'index' };
                case 'equity_stock':
                default:
                    return { label: 'STOCK', cssClass: '' };
            }
        }

        // Helper function to calculate asset statistics
        function getAssetStats(assetName) {
            const returns = getAssetHistoricalReturns(assetName);
            if (!returns || returns.length === 0) {
                return { years: 0, avgReturn: 0, volatility: 0 };
            }

            const returnValues = returns.map(r => r.return);
            const years = returnValues.length;
            const avgReturn = returnValues.reduce((sum, r) => sum + r, 0) / years;
            const variance = returnValues.reduce((sum, r) => sum + Math.pow(r - avgReturn, 2), 0) / years;
            const volatility = Math.sqrt(variance);

            return { years, avgReturn, volatility };
        }

        // Populate Monte Carlo asset listbox with available assets
        function populateMonteCarloListbox() {
            const listbox = document.getElementById('monteCarloAssetListbox');
            if (!listbox) return;

            // Get all asset names
            const allAssets = Object.keys(historicalDataLibrary);

            // Debug: log selected assets
            console.log('Selected portfolio assets:', Object.keys(selectedPortfolioAssets));

            // Filter out already selected assets and sort alphabetically
            const availableAssets = allAssets
                .filter(asset => {
                    const isSelected = selectedPortfolioAssets[asset] !== undefined;
                    console.log(`Asset "${asset}": selected=${isSelected}`);
                    return !isSelected;
                })
                .sort((a, b) => a.localeCompare(b));

            console.log('Available assets for listbox:', availableAssets);

            // Clear listbox
            listbox.innerHTML = '';

            if (availableAssets.length === 0) {
                listbox.innerHTML = '<div class="asset-listbox-empty">All assets have been added to your portfolio</div>';
                return;
            }

            // Add each available asset as a listbox item
            availableAssets.forEach(assetName => {
                const item = document.createElement('div');
                item.className = 'asset-listbox-item';
                item.dataset.assetName = assetName;
                item.setAttribute('tabindex', '0');
                item.setAttribute('role', 'option');

                // Get asset class and statistics
                const assetClass = getAssetClass(assetName);
                const typeInfo = getAssetTypeInfo(assetClass);
                const stats = getAssetStats(assetName);

                // Create content container (left side)
                const contentDiv = document.createElement('div');
                contentDiv.className = 'asset-listbox-item-content';

                // Create header row (name + badge)
                const headerDiv = document.createElement('div');
                headerDiv.className = 'asset-listbox-item-header';

                // Add asset name
                const nameSpan = document.createElement('span');
                nameSpan.className = 'asset-listbox-item-name';
                nameSpan.textContent = assetName;
                headerDiv.appendChild(nameSpan);

                // Add type badge
                const badge = document.createElement('span');
                badge.className = 'asset-listbox-item-badge' + (typeInfo.cssClass ? ' ' + typeInfo.cssClass : '');
                badge.textContent = typeInfo.label;
                headerDiv.appendChild(badge);

                contentDiv.appendChild(headerDiv);

                // Add stats row
                const statsSpan = document.createElement('span');
                statsSpan.className = 'asset-listbox-item-stats';
                statsSpan.textContent = `${stats.years} years | Avg: ${stats.avgReturn.toFixed(1)}% | Vol: ${stats.volatility.toFixed(1)}%`;
                contentDiv.appendChild(statsSpan);

                item.appendChild(contentDiv);

                // Add button (right side)
                const addBtn = document.createElement('button');
                addBtn.className = 'asset-listbox-item-add-btn';
                addBtn.innerHTML = '+';
                addBtn.title = 'Click to add to portfolio';
                addBtn.type = 'button';

                // Single click on button to add asset
                addBtn.addEventListener('click', (e) => {
                    e.stopPropagation();  // Prevent row highlight from triggering
                    addAssetToPortfolioFromListbox(assetName);
                });

                item.appendChild(addBtn);

                // Double-click to add
                item.addEventListener('dblclick', () => {
                    addAssetToPortfolioFromListbox(assetName);
                });

                // Single click to highlight
                item.addEventListener('click', function() {
                    // Remove previous selection
                    document.querySelectorAll('.asset-listbox-item').forEach(i => {
                        i.style.backgroundColor = '';
                    });
                    // Highlight this item
                    this.style.backgroundColor = 'rgba(0, 76, 69, 0.15)';
                });

                // Keyboard support: Enter key to add
                item.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        addAssetToPortfolioFromListbox(assetName);
                    }
                });

                listbox.appendChild(item);
            });
        }

        // Add asset from listbox (triggered by double-click)
        function addAssetToPortfolioFromListbox(assetName) {
            if (!assetName) return;

            if (selectedPortfolioAssets[assetName]) {
                showToast('Asset already in portfolio', 'warning', 2000);
                return;
            }

            // Add asset with default weight
            const numAssets = Object.keys(selectedPortfolioAssets).length;
            const defaultWeight = numAssets === 0 ? 100 : 0;
            selectedPortfolioAssets[assetName] = defaultWeight;

            // Repopulate listbox first (removes added asset) - must happen before updatePortfolioUI
            populateMonteCarloListbox();

            // Then update portfolio UI
            updatePortfolioUI();

            // Show toast feedback
            showToast(`${assetName} added to portfolio`, 'success', 2000);
        }

        // Remove asset from portfolio
        function removeAssetFromPortfolio(assetName) {
            delete selectedPortfolioAssets[assetName];
            updatePortfolioUI();

            // Add asset back to listbox
            populateMonteCarloListbox();

            // Show toast feedback
            showToast(`${assetName} removed from portfolio`, 'info', 2000);
        }

        // Update asset weight
        function updateAssetWeight(assetName, weight) {
            selectedPortfolioAssets[assetName] = parseFloat(weight) || 0;
            updateWeightDistribution();
            autoSaveLastPortfolio(); // Auto-save on weight change
        }

        // Balance all weights equally
        function balanceWeights() {
            const assetNames = Object.keys(selectedPortfolioAssets);
            if (assetNames.length === 0) return;

            const equalWeight = 100 / assetNames.length;
            assetNames.forEach(name => {
                selectedPortfolioAssets[name] = equalWeight;
            });

            updatePortfolioUI();
            autoSaveLastPortfolio(); // Auto-save after balancing
            showToast('Weights balanced equally', 'success', 2000);
        }

        // Clear all assets from portfolio
        async function clearAllAssets() {
            const assetNames = Object.keys(selectedPortfolioAssets);
            if (assetNames.length === 0) return;

            const assetCount = assetNames.length;
            const assetList = assetNames.join(', ');

            const confirmClear = await showConfirm(
                `Are you sure you want to remove all ${assetCount} asset${assetCount === 1 ? '' : 's'} from your portfolio?\n\n${assetList}`,
                'Clear All Assets',
                true  // isDeleteAction = true for warning styling
            );

            if (!confirmClear) {
                showToast('Clear cancelled', 'info', 2000);
                return;
            }

            // Clear all assets
            selectedPortfolioAssets = {};

            // Update UI
            updatePortfolioUI();

            // Add assets back to listbox
            populateMonteCarloListbox();

            // Auto-save
            autoSaveLastPortfolio();

            // Show success message
            showToast(`All ${assetCount} asset${assetCount === 1 ? '' : 's'} cleared from portfolio`, 'success', 3000);
        }

        // Update portfolio UI (asset list and weight distribution)
        function updatePortfolioUI() {
            const assetsList = document.getElementById('selectedAssetsList');
            const assetNames = Object.keys(selectedPortfolioAssets);
            const clearAllBtn = document.getElementById('clearAllAssetsBtn');

            if (assetNames.length === 0) {
                assetsList.innerHTML = '<div style="color: var(--md-sys-color-on-surface-variant); padding: 16px; text-align: center; font-size: 13px;">No assets selected. Add assets to create your portfolio.</div>';
                document.getElementById('correlationMatrixSection').style.display = 'none';
                // Hide Clear All button when no assets
                if (clearAllBtn) clearAllBtn.style.display = 'none';
            } else {
                assetsList.innerHTML = assetNames.map((name, i) => {
                    const color = ASSET_COLORS[i % ASSET_COLORS.length];
                    const assetClass = getAssetClass(name);
                    const typeInfo = getAssetTypeInfo(assetClass);
                    const stats = getAssetStats(name);
                    const badgeClass = typeInfo.cssClass ? ' ' + typeInfo.cssClass : '';
                    return `
                        <div class="asset-weight-item">
                            <div class="asset-color-indicator" style="background-color: ${color};" title="Color matches Weight Distribution bar"></div>
                            <div class="asset-info-section">
                                <div class="asset-info-header">
                                    <span class="asset-name">${name}</span>
                                    <span class="asset-info-badge${badgeClass}">${typeInfo.label}</span>
                                </div>
                                <span class="asset-info-stats">Avg: ${stats.avgReturn.toFixed(1)}% | Vol: ${stats.volatility.toFixed(1)}%</span>
                            </div>
                            <input type="number"
                                   value="${selectedPortfolioAssets[name].toFixed(1)}"
                                   min="0"
                                   max="100"
                                   step="0.1"
                                   onchange="updateAssetWeight('${name}', this.value)"
                                   class="text-base">
                            <span class="percent-label">%</span>
                            <button type="button" class="remove-asset-btn" onclick="removeAssetFromPortfolio('${name}')" title="Remove asset">
                                <span class="material-icons" style="font-size: 18px;">close</span>
                            </button>
                        </div>
                    `;
                }).join('');

                // Show correlation matrix if 2+ assets
                if (assetNames.length >= 2) {
                    document.getElementById('correlationMatrixSection').style.display = 'block';
                    updateCorrelationMatrix();
                } else {
                    document.getElementById('correlationMatrixSection').style.display = 'none';
                }

                // Show Clear All button when assets exist
                if (clearAllBtn) clearAllBtn.style.display = 'inline-flex';
            }

            updateWeightDistribution();
        }

        // Update weight distribution bar
        function updateWeightDistribution() {
            const bar = document.getElementById('weightDistributionBar');
            const totalLabel = document.getElementById('totalWeightLabel');
            const assetNames = Object.keys(selectedPortfolioAssets);

            if (assetNames.length === 0) {
                bar.innerHTML = '<div class="flex-center-justify" class="w-full-text-sm-on-surface-variant">No assets selected</div>';
                totalLabel.textContent = 'Total: 0%';
                totalLabel.style.color = 'var(--md-sys-color-on-surface-variant)';
                return;
            }

            const totalWeight = assetNames.reduce((sum, name) => sum + selectedPortfolioAssets[name], 0);

            bar.innerHTML = assetNames.map((name, i) => {
                const weight = selectedPortfolioAssets[name];
                const percentage = totalWeight > 0 ? (weight / totalWeight) * 100 : 0;
                const color = ASSET_COLORS[i % ASSET_COLORS.length];

                return `
                    <div class="weight-segment" style="width: ${percentage}%; background-color: ${color};" title="${name}: ${weight.toFixed(1)}%">
                        ${percentage > 8 ? `${weight.toFixed(0)}%` : ''}
                    </div>
                `;
            }).join('');

            // Update total label with color coding
            totalLabel.textContent = `Total: ${totalWeight.toFixed(1)}%`;
            if (Math.abs(totalWeight - 100) < 0.1) {
                totalLabel.style.color = '#16A34A'; // Green
            } else {
                totalLabel.style.color = '#EAB308'; // Orange warning
            }
        }

        // Calculate and display correlation matrix
        function updateCorrelationMatrix() {
            const assetNames = Object.keys(selectedPortfolioAssets);
            if (assetNames.length < 2) return;

            const matrix = document.getElementById('correlationMatrix');

            // Helper function to get correlation cell color (matching the results table)
            const getCorrelationColor = (corr) => {
                if (corr >= 0.95) return 'rgb(0, 95, 87)'; // Strong positive - darkest teal green
                if (corr >= 0.7) return 'rgb(0, 76, 69)'; // Moderate positive - dark teal green
                if (corr >= 0.4) return 'rgb(20, 60, 56)'; // Weak positive - medium teal green
                if (corr >= 0.1) return 'rgba(156, 163, 175, 0.2)'; // Very weak - light gray
                if (corr >= -0.1) return 'rgba(156, 163, 175, 0.1)'; // Near zero - very light gray
                if (corr >= -0.4) return 'rgba(239, 68, 68, 0.2)'; // Weak negative - light red
                if (corr >= -0.7) return 'rgba(239, 68, 68, 0.4)'; // Moderate negative - medium red
                return 'rgba(239, 68, 68, 0.6)'; // Strong negative - dark red
            };

            // Calculate correlations based on historical data
            const correlations = {};
            assetNames.forEach(asset1 => {
                correlations[asset1] = {};
                assetNames.forEach(asset2 => {
                    if (asset1 === asset2) {
                        correlations[asset1][asset2] = 1.0;
                    } else {
                        // Calculate correlation from historical data
                        const data1 = getAssetHistoricalReturns(asset1);
                        const data2 = getAssetHistoricalReturns(asset2);
                        correlations[asset1][asset2] = calculateCorrelation(data1, data2);
                    }
                });
            });

            // Build correlation matrix HTML
            let html = '<thead><tr><th></th>';
            assetNames.forEach(name => {
                html += `<th class="text-xs">${name}</th>`;
            });
            html += '</tr></thead><tbody>';

            assetNames.forEach(asset1 => {
                html += `<tr><th style="text-align: left; font-size: 11px;">${asset1}</th>`;
                assetNames.forEach(asset2 => {
                    const corr = correlations[asset1][asset2];
                    const bgColor = getCorrelationColor(corr);
                    // Use CSS variables that adapt to theme: high correlation (>= 0.4) uses --correlation-high-text, low uses --correlation-low-text
                    const textColorVar = (corr >= 0.4) ? 'var(--correlation-high-text)' : 'var(--correlation-low-text)';
                    html += `<td class="correlation-cell" style="background-color: ${bgColor}; color: ${textColorVar} !important;">${corr.toFixed(2)}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody>';

            matrix.innerHTML = html;
        }

        // Get historical returns array for an asset with year alignment
        // Returns array of {year, return} objects for proper correlation calculation
        function getAssetHistoricalReturns(assetName) {
            if (!historicalDataLibrary[assetName]) return [];

            const dataText = historicalDataLibrary[assetName];
            const returns = [];
            const lines = dataText.trim().split('\n');

            lines.forEach(line => {
                const match = line.match(/(\d{4})[:\s]+(-?[\d,]+\.?\d*)%?/);
                if (match) {
                    const year = parseInt(match[1]);
                    const value = match[2].trim();
                    if (value !== 'N/A' && !value.toLowerCase().includes('n/a')) {
                        const returnPct = parseFloat(match[2].replace(/,/g, ''));
                        returns.push({ year, return: returnPct });
                    }
                }
            });

            return returns;
        }

        // Calculate Pearson correlation coefficient with year-based alignment
        // This ensures we compare returns from the SAME calendar years, not just array indices
        // Critical fix: prevents spurious zero correlations from misaligned time windows
        function calculateCorrelation(data1, data2) {
            if (data1.length === 0 || data2.length === 0) return 0;

            // Create year-indexed maps for O(1) lookup
            const map1 = new Map(data1.map(d => [d.year, d.return]));
            const map2 = new Map(data2.map(d => [d.year, d.return]));

            // Find overlapping years (intersection of both datasets)
            const overlappingYears = [...map1.keys()].filter(year => map2.has(year));

            // Need at least 2 overlapping years to calculate meaningful correlation
            if (overlappingYears.length < 2) return 0;

            // Extract aligned returns for the same calendar years
            const x = overlappingYears.map(year => map1.get(year));
            const y = overlappingYears.map(year => map2.get(year));

            // Pearson correlation formula: r = [nxy - xy] / sqrt([nx - (x)][ny - (y)])
            const n = x.length;
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
            const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
            const sumY2 = y.reduce((sum, yi) => sum + yi * yi, 0);

            const numerator = (n * sumXY) - (sumX * sumY);
            const denominator = Math.sqrt(((n * sumX2) - (sumX * sumX)) * ((n * sumY2) - (sumY * sumY)));

            if (denominator === 0) return 0;

            return numerator / denominator;
        }

        // ========== Portfolio Presets Functions ==========

        // Save current portfolio to presets
        async function saveCurrentPortfolio() {
            const assetNames = Object.keys(selectedPortfolioAssets);

            if (assetNames.length === 0) {
                showToast('No assets to save. Add assets to your portfolio first.', 'warning', 3000);
                return;
            }

            const totalWeight = assetNames.reduce((sum, name) => sum + selectedPortfolioAssets[name], 0);
            if (Math.abs(totalWeight - 100) > 0.1) {
                showToast('Portfolio weights must total 100% before saving', 'warning', 3000);
                return;
            }

            // Check if a preset is currently selected
            const selector = document.getElementById('portfolioPresetSelector');
            const currentlySelectedPreset = selector?.value || '';

            // Use selected preset name as default, or create new name
            const defaultName = currentlySelectedPreset || `Portfolio ${new Date().toLocaleDateString()}`;
            const promptMessage = currentlySelectedPreset
                ? `Overwrite "${currentlySelectedPreset}" or enter a new name:`
                : 'Enter a name for this portfolio preset:';

            const presetName = await showPrompt(
                promptMessage,
                defaultName,
                'Save Portfolio'
            );
            if (!presetName) {
                showToast('Save cancelled', 'info', 2000);
                return;
            }

            const presets = JSON.parse(localStorage.getItem('bbd_portfolio_presets') || '{}');

            if (presets[presetName]) {
                const overwrite = await showConfirm(
                    `A preset named "${presetName}" already exists. Overwrite it?`,
                    'Overwrite Preset?'
                );
                if (!overwrite) {
                    showToast('Save cancelled', 'info', 2000);
                    return;
                }
            }

            const currentParams = collectCurrentParameters();

            presets[presetName] = {
                assets: { ...selectedPortfolioAssets },
                savedDate: new Date().toISOString(),
                totalWeight: totalWeight,
                params: currentParams
            };

            localStorage.setItem('bbd_portfolio_presets', JSON.stringify(presets));
            populatePresetSelector();
            document.getElementById('portfolioPresetSelector').value = presetName;
            showToast(`Portfolio "${presetName}" saved successfully!`, 'success', 3000);
        }

        // Load selected portfolio from presets
        async function loadSelectedPortfolio() {
            const selector = document.getElementById('portfolioPresetSelector');
            const presetName = selector.value;

            if (!presetName) {
                showToast('Please select a portfolio to load', 'warning', 2000);
                return;
            }

            const presets = JSON.parse(localStorage.getItem('bbd_portfolio_presets') || '{}');
            const preset = presets[presetName];

            if (!preset) {
                showToast('Portfolio preset not found', 'error', 3000);
                return;
            }

            const currentAssets = Object.keys(selectedPortfolioAssets);
            if (currentAssets.length > 0) {
                const confirmLoad = await showConfirm(
                    'Loading this preset will replace your current portfolio. Continue?',
                    'Load Portfolio'
                );
                if (!confirmLoad) {
                    showToast('Load cancelled', 'info', 2000);
                    return;
                }
            }

            selectedPortfolioAssets = { ...preset.assets };
            populateMonteCarloListbox();
            updatePortfolioUI();

            // Populate parameters if they exist
            if (preset.params) {
                populateUIFromParameters(preset.params);
                showToast(`Portfolio "${presetName}" loaded with saved parameters!`, 'success', 3000);
            } else {
                // Legacy portfolio without parameters - use current UI defaults
                console.log(`Portfolio "${presetName}" has no saved parameters - using current UI values`);
                showToast(`Portfolio "${presetName}" loaded (using current parameter settings)`, 'success', 3000);
            }
        }

        // Delete selected portfolio preset
        async function deleteSelectedPortfolio() {
            const selector = document.getElementById('portfolioPresetSelector');
            const presetName = selector.value;

            if (!presetName) {
                showToast('Please select a portfolio to delete', 'warning', 2000);
                return;
            }

            const confirmDelete = await showConfirm(
                `Are you sure you want to delete the portfolio preset "${presetName}"?`,
                'Delete Portfolio',
                true  // isDeleteAction = true for red styling
            );
            if (!confirmDelete) {
                showToast('Delete cancelled', 'info', 2000);
                return;
            }

            const presets = JSON.parse(localStorage.getItem('bbd_portfolio_presets') || '{}');
            delete presets[presetName];
            localStorage.setItem('bbd_portfolio_presets', JSON.stringify(presets));
            populatePresetSelector();
            showToast(`Portfolio "${presetName}" deleted successfully!`, 'success', 3000);
        }

        // Populate preset selector dropdown
        function populatePresetSelector() {
            const selector = document.getElementById('portfolioPresetSelector');
            if (!selector) return;

            const presets = JSON.parse(localStorage.getItem('bbd_portfolio_presets') || '{}');
            const presetNames = Object.keys(presets).sort();

            selector.innerHTML = '<option value="">-- Presets --</option>';

            presetNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                const preset = presets[name];
                const assetCount = Object.keys(preset.assets).length;
                const date = new Date(preset.savedDate).toLocaleDateString();
                option.textContent = `${name} (${assetCount} assets, ${date})`;
                selector.appendChild(option);
            });
        }

        // Collect all current simulation parameters from UI
        function collectCurrentParameters() {
            // Simulation settings
            const numSimulations = parseInt(document.getElementById('numSimulations').value);
            const returnModel = document.getElementById('returnModel')?.value || 'bootstrap';
            const inflationRate = parseFloat(document.getElementById('inflationRate').value);

            // BBD Strategy core
            const startValue = parseFloat(document.getElementById('startValue').value);
            const initialLocBalance = parseFloat(document.getElementById('locBalance').value) || 0;
            const startYear = parseInt(document.getElementById('startYear').value);
            const withdrawalStartYear = parseInt(document.getElementById('withdrawalStartYear').value);
            const period = parseInt(document.getElementById('period').value);
            const sblocRate = parseFloat(document.getElementById('sblocRate').value);
            const maxBorrowing = parseFloat(document.getElementById('maxBorrowing').value);
            const maintenanceMargin = parseFloat(document.getElementById('maintenanceMargin').value);
            const liquidationHaircut = parseFloat(document.getElementById('liquidationHaircut').value);

            // Withdrawals
            const annualWithdrawal = parseFloat(document.getElementById('annualWithdrawal').value);
            const annualRaise = parseFloat(document.getElementById('annualRaise').value);
            const monthlyWithdrawal = document.getElementById('monthlyWithdrawal').checked;

            // Chapters
            const enableChapters = document.getElementById('enableChapters').checked;
            const chapter2YearsAfter = parseInt(document.getElementById('chapter2YearsAfter').value);
            const chapter2ReductionPct = parseFloat(document.getElementById('chapter2ReductionPct').value);
            const chapter3YearsAfter = parseInt(document.getElementById('chapter3YearsAfter').value);
            const chapter3ReductionPct = parseFloat(document.getElementById('chapter3ReductionPct').value);

            // Tax modeling
            const enableTaxModeling = document.getElementById('enableTaxModeling')?.checked || false;
            const taxAdvantaged = document.getElementById('taxAdvantaged')?.checked || false;
            const dividendYield = parseFloat(document.getElementById('dividendYield')?.value || 0);
            const ordinaryTaxRate = parseFloat(document.getElementById('ordinaryTaxRate')?.value || 0);
            const ltcgTaxRate = parseFloat(document.getElementById('ltcgTaxRate')?.value || 0);

            return {
                numSimulations,
                returnModel,
                inflationRate,
                startValue,
                initialLocBalance,
                startYear,
                withdrawalStartYear,
                period,
                sblocRate,
                maxBorrowing,
                maintenanceMargin,
                liquidationHaircut,
                annualWithdrawal,
                annualRaise,
                monthlyWithdrawal,
                enableChapters,
                chapter2YearsAfter,
                chapter2ReductionPct,
                chapter3YearsAfter,
                chapter3ReductionPct,
                enableTaxModeling,
                taxAdvantaged,
                dividendYield,
                ordinaryTaxRate,
                ltcgTaxRate
            };
        }

        // Populate UI from saved parameters
        function populateUIFromParameters(params) {
            if (!params) {
                console.log('No parameters to populate');
                return;
            }

            // Simulation settings
            if (params.numSimulations !== undefined) {
                document.getElementById('numSimulations').value = params.numSimulations;
            }
            if (params.returnModel !== undefined) {
                document.getElementById('returnModel').value = params.returnModel;
            }
            if (params.inflationRate !== undefined) {
                document.getElementById('inflationRate').value = params.inflationRate;
            }

            // BBD Strategy core
            if (params.startValue !== undefined) {
                document.getElementById('startValue').value = params.startValue;
            }
            if (params.initialLocBalance !== undefined) {
                document.getElementById('locBalance').value = params.initialLocBalance;
            }
            if (params.startYear !== undefined) {
                document.getElementById('startYear').value = params.startYear;
            }
            if (params.withdrawalStartYear !== undefined) {
                document.getElementById('withdrawalStartYear').value = params.withdrawalStartYear;
            }
            if (params.period !== undefined) {
                document.getElementById('period').value = params.period;
            }
            if (params.sblocRate !== undefined) {
                document.getElementById('sblocRate').value = params.sblocRate;
            }
            if (params.maxBorrowing !== undefined) {
                document.getElementById('maxBorrowing').value = params.maxBorrowing;
            }
            if (params.maintenanceMargin !== undefined) {
                document.getElementById('maintenanceMargin').value = params.maintenanceMargin;
            }
            if (params.liquidationHaircut !== undefined) {
                document.getElementById('liquidationHaircut').value = params.liquidationHaircut;
            }

            // Withdrawals
            if (params.annualWithdrawal !== undefined) {
                document.getElementById('annualWithdrawal').value = params.annualWithdrawal;
            }
            if (params.annualRaise !== undefined) {
                document.getElementById('annualRaise').value = params.annualRaise;
            }
            if (params.monthlyWithdrawal !== undefined) {
                document.getElementById('monthlyWithdrawal').checked = params.monthlyWithdrawal;
            }

            // Chapters
            if (params.enableChapters !== undefined) {
                document.getElementById('enableChapters').checked = params.enableChapters;
                toggleChaptersInputs();  // Update UI visibility
            }
            if (params.chapter2YearsAfter !== undefined) {
                document.getElementById('chapter2YearsAfter').value = params.chapter2YearsAfter;
            }
            if (params.chapter2ReductionPct !== undefined) {
                document.getElementById('chapter2ReductionPct').value = params.chapter2ReductionPct;
            }
            if (params.chapter3YearsAfter !== undefined) {
                document.getElementById('chapter3YearsAfter').value = params.chapter3YearsAfter;
            }
            if (params.chapter3ReductionPct !== undefined) {
                document.getElementById('chapter3ReductionPct').value = params.chapter3ReductionPct;
            }

            // Tax modeling
            if (params.enableTaxModeling !== undefined) {
                document.getElementById('enableTaxModeling').checked = params.enableTaxModeling;
                toggleTaxInputs();  // Update UI visibility
            }
            if (params.taxAdvantaged !== undefined) {
                document.getElementById('taxAdvantaged').checked = params.taxAdvantaged;
            }
            if (params.dividendYield !== undefined) {
                document.getElementById('dividendYield').value = params.dividendYield;
            }
            if (params.ordinaryTaxRate !== undefined) {
                document.getElementById('ordinaryTaxRate').value = params.ordinaryTaxRate;
            }
            if (params.ltcgTaxRate !== undefined) {
                document.getElementById('ltcgTaxRate').value = params.ltcgTaxRate;
            }

            console.log('UI populated from parameters:', params);
        }

        // Auto-save current portfolio to last portfolio
        function autoSaveLastPortfolio() {
            const assetNames = Object.keys(selectedPortfolioAssets);
            if (assetNames.length === 0) {
                console.log('autoSaveLastPortfolio: No assets to save');
                return;
            }

            const totalWeight = assetNames.reduce((sum, name) => sum + selectedPortfolioAssets[name], 0);
            console.log('autoSaveLastPortfolio: totalWeight =', totalWeight, 'assets:', selectedPortfolioAssets);

            if (Math.abs(totalWeight - 100) < 0.1) {
                const currentParams = collectCurrentParameters();

                const portfolioData = {
                    assets: { ...selectedPortfolioAssets },
                    savedDate: new Date().toISOString(),
                    params: currentParams
                };
                localStorage.setItem('bbd_last_portfolio', JSON.stringify(portfolioData));
                console.log('autoSaveLastPortfolio: Saved portfolio to localStorage:', portfolioData);
            } else {
                console.log('autoSaveLastPortfolio: NOT saving - weights do not total 100% (total:', totalWeight, ')');
            }
        }

        // Load last portfolio if exists
        function loadLastPortfolioIfExists() {
            const lastPortfolio = JSON.parse(localStorage.getItem('bbd_last_portfolio') || 'null');

            console.log('loadLastPortfolioIfExists called');
            console.log('lastPortfolio from localStorage:', lastPortfolio);
            console.log('currentAssets:', Object.keys(selectedPortfolioAssets));

            if (lastPortfolio && Object.keys(lastPortfolio.assets).length > 0) {
                const currentAssets = Object.keys(selectedPortfolioAssets);

                // Only auto-restore if current portfolio is empty
                if (currentAssets.length === 0) {
                    console.log('Restoring portfolio:', lastPortfolio.assets);
                    selectedPortfolioAssets = { ...lastPortfolio.assets };
                    populateMonteCarloListbox();
                    updatePortfolioUI();

                    // Populate parameters if they exist
                    if (lastPortfolio.params) {
                        populateUIFromParameters(lastPortfolio.params);
                        console.log('Restored parameters from last portfolio:', lastPortfolio.params);
                        showToast('Last portfolio and parameters restored', 'info', 2000);
                    } else {
                        // Legacy portfolio without parameters
                        console.log('Last portfolio has no saved parameters - using current UI values');
                        showToast('Last portfolio restored (using current parameter settings)', 'info', 2000);
                    }
                } else {
                    console.log('Skipping restore - current portfolio not empty');
                }
            } else {
                console.log('No last portfolio found in localStorage or portfolio is empty');
            }
        }

        // Import portfolio from ticker file
        async function loadTickerFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const result = parseTickerFile(text);

                if (result.matched.length === 0 && result.unmatched.length === 0) {
                    showToast('No valid tickers found in file', 'error', 4000);
                    event.target.value = '';
                    return;
                }

                if (result.matched.length === 0) {
                    await showImportSummary(result, file.name);
                    showToast('No matching assets found in file', 'error', 4000);
                    event.target.value = '';
                    return;
                }

                // Confirm if current portfolio will be replaced
                if (Object.keys(selectedPortfolioAssets).length > 0) {
                    const proceed = await showConfirm(
                        'This will replace your current portfolio. Continue?',
                        'Import Ticker File'
                    );
                    if (!proceed) {
                        event.target.value = ''; // Reset file input
                        return;
                    }
                }

                // Apply the matched assets and weights
                selectedPortfolioAssets = {};
                result.matched.forEach(({ asset, weight }) => {
                    selectedPortfolioAssets[asset] = weight;
                });

                // Update UI
                populateMonteCarloListbox();
                updatePortfolioUI();

                // Show detailed summary
                await showImportSummary(result, file.name);

                // Reset file input for re-uploads
                event.target.value = '';

            } catch (error) {
                console.error('Error loading ticker file:', error);
                showToast('Error loading ticker file: ' + error.message, 'error', 4000);
                event.target.value = '';
            }
        }

        // Parse ticker file and match to available assets
        function parseTickerFile(text) {
            const matched = [];
            const unmatched = [];
            const lines = text.split('\n').filter(line => line.trim());

            // Get all available assets
            const availableAssets = Object.keys(historicalDataLibrary);

            for (const line of lines) {
                // Parse format: "COMPANY NAME    WEIGHT%"
                // Use regex to capture company name and percentage
                const match = line.match(/^(?:\s*\d+)?(.+?)\s+([\d.]+)%\s*$/);

                if (!match) continue;

                const companyName = match[1].trim();
                const weight = parseFloat(match[2]);

                if (isNaN(weight) || weight <= 0) continue;

                // Try to match company name to available assets
                const matchedAsset = findMatchingAsset(companyName, availableAssets);

                if (matchedAsset) {
                    matched.push({ asset: matchedAsset, weight, original: companyName });
                } else {
                    unmatched.push({ original: companyName, weight });
                }
            }

            return { matched, unmatched };
        }

        // Find matching asset using fuzzy matching
        function findMatchingAsset(companyName, availableAssets) {
            const normalized = normalizeAssetName(companyName);

            // 1. Try exact match first
            for (const asset of availableAssets) {
                if (normalizeAssetName(asset) === normalized) {
                    return asset;
                }
            }

            // 2. Try partial match (asset name contains company name or vice versa)
            for (const asset of availableAssets) {
                const normalizedAsset = normalizeAssetName(asset);
                if (normalizedAsset.includes(normalized) || normalized.includes(normalizedAsset)) {
                    return asset;
                }
            }

            // 3. Try significant word matching (ignoring common words)
            const significantWords = getSignificantWords(normalized);
            if (significantWords.length > 0) {
                for (const asset of availableAssets) {
                    const assetWords = getSignificantWords(normalizeAssetName(asset));
                    const matchCount = significantWords.filter(word => assetWords.includes(word)).length;

                    // If majority of significant words match, consider it a match
                    if (matchCount >= Math.min(2, significantWords.length)) {
                        return asset;
                    }
                }
            }

            return null;
        }

        // Normalize asset name for comparison
        function normalizeAssetName(name) {
            return name
                .toUpperCase()
                .replace(/[.,]/g, '') // Remove periods and commas
                .replace(/\s+/g, ' ') // Normalize whitespace
                .replace(/\bINC\b|\bCORP\b|\bCO\b|\bLTD\b|\bLLC\b|\bPLC\b|\bNV\b/g, '') // Remove corporate suffixes
                .replace(/\bCL [A-Z]\b/g, '') // Remove class designations
                .replace(/\bNEW\b/g, '') // Remove "NEW"
                .replace(/\bDE\b/g, '') // Remove state abbreviations
                .trim();
        }

        // Extract significant words (ignore common words)
        function getSignificantWords(normalizedName) {
            const commonWords = new Set(['THE', 'AND', 'OF', 'GROUP', 'INTERNATIONAL', 'COMPANIES']);
            return normalizedName
                .split(' ')
                .filter(word => word.length > 2 && !commonWords.has(word));
        }

        // Show import summary modal
        function showImportSummary(result, fileName) {
            return new Promise((resolve) => {
                const modal = document.getElementById('importSummaryModal');
                const titleEl = document.getElementById('importSummaryTitle');
                const contentEl = document.getElementById('importSummaryContent');
                const closeBtn = document.getElementById('importSummaryClose');

                const totalTickers = result.matched.length + result.unmatched.length;
                const totalWeight = result.matched.reduce((sum, item) => sum + item.weight, 0);

                // Build summary content
                let html = `
                    <div style="background-color: var(--md-sys-color-surface-variant); padding: 16px; border-radius: 6px; margin-bottom: 16px;">
                        <div style="font-size: 14px; color: var(--md-sys-color-on-surface-variant); margin-bottom: 8px;">
                            <strong>File:</strong> ${fileName}
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                            <div>
                                <div style="font-size: 24px; font-weight: 600; color: var(--md-sys-color-primary);">${totalTickers}</div>
                                <div class="text-sm text-surface-variant">Total Tickers</div>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: 600; color: #2e7d32;">${result.matched.length}</div>
                                <div class="text-sm text-surface-variant">Matched</div>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: 600; color: ${result.unmatched.length > 0 ? '#d32f2f' : 'var(--md-sys-color-on-surface-variant)'};">${result.unmatched.length}</div>
                                <div class="text-sm text-surface-variant">Unmatched</div>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: 600; color: var(--md-sys-color-secondary);">${totalWeight.toFixed(1)}%</div>
                                <div class="text-sm text-surface-variant">Total Weight</div>
                            </div>
                        </div>
                    </div>
                `;

                // Matched assets section
                if (result.matched.length > 0) {
                    html += `
                        <div class="mb-20">
                            <h4 style="font-size: 16px; font-weight: 600; color: #2e7d32; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <span class="material-icons" class="text-xl">check_circle</span>
                                Successfully Matched (${result.matched.length})
                            </h4>
                            <div style="background-color: var(--md-sys-color-surface-container); border-radius: 4px; overflow: hidden;">
                                <table class="table-collapse-text-sm">
                                    <thead>
                                        <tr style="background-color: var(--md-sys-color-surface-container-high);">
                                            <th class="table-header-p-10">Original Ticker</th>
                                            <th class="table-header-p-10">Matched Asset</th>
                                            <th style="padding: 10px; text-align: right; font-weight: 600; border-bottom: 2px solid var(--md-sys-color-outline);">Weight</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;

                    result.matched.forEach((item, index) => {
                        const bgColor = index % 2 === 0 ? 'transparent' : 'var(--md-sys-color-surface-container-low)';
                        html += `
                            <tr style="background-color: ${bgColor};">
                                <td style="padding: 10px; border-bottom: 1px solid var(--md-sys-color-outline-variant);">${item.original}</td>
                                <td style="padding: 10px; border-bottom: 1px solid var(--md-sys-color-outline-variant); font-weight: 500; color: var(--md-sys-color-primary);">${item.asset}</td>
                                <td style="padding: 10px; text-align: right; border-bottom: 1px solid var(--md-sys-color-outline-variant); font-weight: 600;">${item.weight.toFixed(2)}%</td>
                            </tr>
                        `;
                    });

                    html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }

                // Unmatched assets section
                if (result.unmatched.length > 0) {
                    html += `
                        <div class="mb-20">
                            <h4 style="font-size: 16px; font-weight: 600; color: #d32f2f; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <span class="material-icons" class="text-xl">error</span>
                                Could Not Match (${result.unmatched.length})
                            </h4>
                            <div class="unmatched-section" style="background-color: #ffebee; border-radius: 4px; padding: 12px; border-left: 4px solid #d32f2f;">
                                <div style="font-size: 12px; color: #c62828; margin-bottom: 8px;">
                                    These tickers were not found in the available historical data library:
                                </div>
                                <div class="unmatched-table-container" style="background-color: white; border-radius: 6px; overflow: hidden;">
                                    <table class="table-collapse-text-sm">
                                        <thead>
                                            <tr style="background-color: #ffcdd2;">
                                                <th style="padding: 8px; text-align: left; font-weight: 600; border-bottom: 2px solid #ef5350;">Ticker Name</th>
                                                <th style="padding: 8px; text-align: right; font-weight: 600; border-bottom: 2px solid #ef5350;">Weight</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                    `;

                    result.unmatched.forEach((item, index) => {
                        const bgColor = index % 2 === 0 ? 'white' : '#ffebee';
                        html += `
                            <tr style="background-color: ${bgColor};">
                                <td style="padding: 8px; border-bottom: 1px solid #ffcdd2;">${item.original}</td>
                                <td style="padding: 8px; text-align: right; border-bottom: 1px solid #ffcdd2; font-weight: 500;">${item.weight.toFixed(2)}%</td>
                            </tr>
                        `;
                    });

                    html += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                }

                contentEl.innerHTML = html;
                titleEl.textContent = `Portfolio Import Summary`;

                // Show modal
                modal.style.display = 'flex';

                // Close button handler
                const handleClose = () => {
                    modal.style.display = 'none';
                    closeBtn.removeEventListener('click', handleClose);
                    modal.removeEventListener('click', handleOverlayClick);
                    resolve();
                };

                // Overlay click handler
                const handleOverlayClick = (e) => {
                    if (e.target === modal) {
                        handleClose();
                    }
                };

                closeBtn.addEventListener('click', handleClose);
                modal.addEventListener('click', handleOverlayClick);
            });
        }

        // Custom Modal Dialog System
        /**
         * Show a confirmation dialog with OK/Cancel buttons
         * @param {string} message - The message to display
         * @param {string} title - The modal title (default: "Confirm")
         * @param {boolean} isDeleteAction - If true, styles OK button as delete action
         * @returns {Promise<boolean>} - Resolves to true if OK clicked, false if Cancel clicked
         */
        function showConfirm(message, title = 'Confirm', isDeleteAction = false) {
            return new Promise((resolve) => {
                const modal = document.getElementById('customConfirmModal');
                const titleEl = document.getElementById('confirmModalTitle');
                const messageEl = document.getElementById('confirmModalMessage');
                const cancelBtn = document.getElementById('confirmModalCancel');
                const okBtn = document.getElementById('confirmModalOK');

                // Set content
                titleEl.textContent = title;
                messageEl.textContent = message;

                // Style OK button for delete actions
                if (isDeleteAction) {
                    okBtn.classList.add('delete-action');
                } else {
                    okBtn.classList.remove('delete-action');
                }

                // Show modal
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';

                // Focus OK button
                setTimeout(() => okBtn.focus(), 100);

                // Event handlers
                const handleCancel = () => {
                    cleanup();
                    resolve(false);
                };

                const handleOK = () => {
                    cleanup();
                    resolve(true);
                };

                const handleKeydown = (e) => {
                    if (e.key === 'Escape') {
                        handleCancel();
                    } else if (e.key === 'Enter') {
                        handleOK();
                    }
                };

                const cleanup = () => {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                    cancelBtn.removeEventListener('click', handleCancel);
                    okBtn.removeEventListener('click', handleOK);
                    document.removeEventListener('keydown', handleKeydown);
                };

                // Attach event listeners
                cancelBtn.addEventListener('click', handleCancel);
                okBtn.addEventListener('click', handleOK);
                document.addEventListener('keydown', handleKeydown);

                // Close modal on overlay click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        handleCancel();
                    }
                });
            });
        }

        /**
         * Show a prompt dialog with text input and OK/Cancel buttons
         * @param {string} message - The message to display
         * @param {string} defaultValue - Default value for the input (default: "")
         * @param {string} title - The modal title (default: "Input Required")
         * @returns {Promise<string|null>} - Resolves to input value if OK clicked, null if Cancel clicked
         */
        function showPrompt(message, defaultValue = '', title = 'Input Required') {
            return new Promise((resolve) => {
                const modal = document.getElementById('customPromptModal');
                const titleEl = document.getElementById('promptModalTitle');
                const messageEl = document.getElementById('promptModalMessage');
                const inputEl = document.getElementById('promptModalInput');
                const cancelBtn = document.getElementById('promptModalCancel');
                const okBtn = document.getElementById('promptModalOK');

                // Set content
                titleEl.textContent = title;
                messageEl.textContent = message;
                inputEl.value = defaultValue;

                // Show modal
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';

                // Focus and select input
                setTimeout(() => {
                    inputEl.focus();
                    inputEl.select();
                }, 100);

                // Event handlers
                const handleCancel = () => {
                    cleanup();
                    resolve(null);
                };

                const handleOK = () => {
                    const value = inputEl.value.trim();
                    if (!value) {
                        showToast('Please enter a value', 'warning', 2000);
                        inputEl.focus();
                        return;
                    }
                    cleanup();
                    resolve(value);
                };

                const handleKeydown = (e) => {
                    if (e.key === 'Escape') {
                        handleCancel();
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        handleOK();
                    }
                };

                const cleanup = () => {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                    cancelBtn.removeEventListener('click', handleCancel);
                    okBtn.removeEventListener('click', handleOK);
                    inputEl.removeEventListener('keydown', handleKeydown);
                };

                // Attach event listeners
                cancelBtn.addEventListener('click', handleCancel);
                okBtn.addEventListener('click', handleOK);
                inputEl.addEventListener('keydown', handleKeydown);

                // Close modal on overlay click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        handleCancel();
                    }
                });
            });
        }

        // Update start years based on historical data
        function updateStartYearsFromHistoricalData(dataText) {
            const lines = dataText.split('\n');
            let firstValidYear = null;

            for (const line of lines) {
                const match = line.match(/(\d{4})[:\s]+(.+)/);
                if (match) {
                    const year = parseInt(match[1]);
                    const value = match[2].trim();

                    // Check if the value is not N/A
                    if (value !== 'N/A' && !value.toLowerCase().includes('n/a')) {
                        firstValidYear = year;
                        break;
                    }
                }
            }

            // Update the year fields if we found a valid year
            if (firstValidYear) {
                document.getElementById('startYear').value = firstValidYear;
                document.getElementById('withdrawalStartYear').value = firstValidYear;
            }
        }

        // Fetch Historical Data using selected provider (with caching and year remapping)
        async function fetchHistoricalData(forceRefresh = false) {
            const assetName = document.getElementById('assetName').value.trim().toUpperCase();
            const startYear = parseInt(document.getElementById('startYear').value);
            const period = parseInt(document.getElementById('period').value);

            if (!assetName) {
                showToast('Please enter an asset symbol', 'warning', 3000);
                return;
            }

            // Check selected data source
            const selectedSource = settingsState.selectedSource;

            if (selectedSource === 'manual') {
                showToast('Manual entry mode selected\nPlease configure a data source in Settings or enter data manually.', 'info', 4000);
                showSettings();
                return;
            }

            const provider = dataProviders[selectedSource];
            if (!provider) {
                showToast('Invalid data source selected\nPlease check Settings.', 'error', 3000);
                return;
            }

            // Check for API key if required
            const apiKey = settingsState.apiKeys[selectedSource];
            if (provider.requiresApiKey && !apiKey) {
                showToast(`${provider.name} requires an API key\nPlease configure it in Settings.`, 'warning', 4000);
                showSettings();
                return;
            }

            try {
                const button = event?.target;
                const originalText = button?.textContent;

                // CHECK CACHE FIRST (unless force refresh)
                if (!forceRefresh) {
                    const cachedData = getCachedHistoricalData(assetName, selectedSource);
                    if (cachedData) {
                        // Use cached data - NO EXPIRATION CHECK!
                        if (button) button.textContent = 'Loading from cache...';

                        // Remap years to simulation period
                        const remappedData = remapYearsToSimulation(cachedData.data, startYear, period);

                        // Display remapped data
                        let formattedData = '';
                        remappedData.forEach(item => {
                            formattedData += `${item.year}: ${item.return.toFixed(2)}%\n`;
                        });
                        document.getElementById('historicalData').value = formattedData.trim();

                        const fetchDate = new Date(cachedData.fetchedAt).toLocaleDateString();
                        showToast(`Loaded from cache\nFetched ${fetchDate}  ${cachedData.data.length} years through ${cachedData.lastYear}`, 'success', 4000);

                        if (button) button.textContent = originalText || 'Fetch Historical Data';
                        return;
                    }
                }

                // FETCH FROM API (if not in cache OR force refresh)
                if (button) button.textContent = `Fetching from ${provider.name}...`;

                // Build endpoint
                let endpoint = provider.requiresApiKey
                    ? provider.endpoint(assetName, apiKey)
                    : provider.endpoint(assetName);

                // Apply CORS proxy if configured
                if (settingsState.corsProxyUrl) {
                    endpoint = settingsState.corsProxyUrl + encodeURIComponent(endpoint);
                }

                const response = await fetch(endpoint);

                // Check for HTTP 429 (Rate Limit)
                if (response.status === 429) {
                    showToast(`Rate limit exceeded\n${provider.name} is rate limiting. Try loading from cache or wait before retrying.`, 'warning', 6000);
                    if (button) button.textContent = originalText || 'Fetch Historical Data';
                    return;
                }

                const data = await response.json();

                // Parse response using provider's parser (now returns all years without filtering)
                const rawReturns = provider.parseResponse(data, startYear, period);

                if (!rawReturns || rawReturns.length === 0) {
                    showToast(`No data returned\n${provider.name} returned no data. Check the symbol and try again.`, 'warning', 4000);
                    if (button) button.textContent = originalText || 'Fetch Historical Data';
                    return;
                }

                // CACHE THE RAW DATA (permanently - no expiration)
                setCachedHistoricalData(assetName, selectedSource, rawReturns);

                // REMAP years to simulation period for display
                const remappedData = remapYearsToSimulation(rawReturns, startYear, period);

                // Display remapped data
                let formattedData = '';
                remappedData.forEach(item => {
                    formattedData += `${item.year}: ${item.return.toFixed(2)}%\n`;
                });
                document.getElementById('historicalData').value = formattedData.trim();

                const lastYear = rawReturns.length > 0 ? Math.max(...rawReturns.map(r => r.year)) : 0;
                showToast(`Data fetched and cached!\n${rawReturns.length} years of data through ${lastYear}`, 'success', 4000);

                if (button) button.textContent = originalText || 'Fetch Historical Data';

            } catch (error) {
                showToast(`Error fetching data\n${error.message}\n\nTip: If CORS error, configure proxy in Settings > Advanced.`, 'error', 6000);
                const button = event?.target;
                if (button) button.textContent = 'Fetch Historical Data';
            }
        }

        function calculateAnnualReturns(timeSeries, startYear, period) {
            const dates = Object.keys(timeSeries).sort();
            const yearlyPrices = {};

            // Get December closing price for each year - collect ALL years
            dates.forEach(date => {
                const year = parseInt(date.substring(0, 4));
                const month = parseInt(date.substring(5, 7));

                // Remove year filtering - collect all available data
                if (month === 12) {
                    yearlyPrices[year] = parseFloat(timeSeries[date]['5. adjusted close']);
                }
            });

            // Calculate returns for all consecutive years
            const returns = [];
            const years = Object.keys(yearlyPrices).map(Number).sort();

            for (let i = 1; i < years.length; i++) {
                const prevYear = years[i - 1];
                const currentYear = years[i];
                const returnPct = ((yearlyPrices[currentYear] - yearlyPrices[prevYear]) / yearlyPrices[prevYear]) * 100;
                returns.push({ year: currentYear, return: returnPct });
            }

            return returns;
        }

        // Parse historical data
        function parseHistoricalData(dataText) {
            const lines = dataText.trim().split('\n');
            const returns = {};

            lines.forEach(line => {
                // Match year followed by percentage value (handles commas in numbers)
                const match = line.match(/(\d{4})[:\s]+(-?[\d,]+\.?\d*)%?/);
                if (match) {
                    const year = parseInt(match[1]);
                    // Remove commas before parsing
                    const returnPct = parseFloat(match[2].replace(/,/g, ''));
                    returns[year] = returnPct / 100; // Convert to decimal
                }
            });

            return returns;
        }

        // Remap historical years to simulation period
        function remapYearsToSimulation(returnsArray, startYear, period) {
            if (!returnsArray || returnsArray.length === 0) {
                return [];
            }

            // Sort returns by year (ascending)
            const sortedReturns = [...returnsArray].sort((a, b) => a.year - b.year);

            // Take the most recent N years (where N = period)
            const recentYears = sortedReturns.slice(-period);

            // Map them sequentially to [startYear, startYear+1, ..., startYear+period-1]
            const remappedReturns = recentYears.map((item, index) => ({
                year: startYear + index,
                return: item.return
            }));

            return remappedReturns;
        }

        // Calculate equivalent salary considering taxes
        function calculateSalaryEquivalent(annualWithdrawal) {
            // Simplified tax calculation: assuming ~25% effective tax rate on salary
            // The withdrawal is tax-free (borrowed), so equivalent salary needs to be higher
            const effectiveTaxRate = 0.25;
            const equivalentSalary = annualWithdrawal / (1 - effectiveTaxRate);
            return equivalentSalary;
        }

        // Run simulation
        document.getElementById('simulatorForm').addEventListener('submit', function(e) {
            e.preventDefault();

            if (currentSimulationMode === 'montecarlo') {
                runMonteCarloSimulation();
            } else {
                runSimulation();
            }
        });

        function runSimulation() {
            // Get inputs
            const assetName = document.getElementById('assetName').value;
            const startValue = parseFloat(document.getElementById('startValue').value);
            const initialLocBalance = parseFloat(document.getElementById('locBalance').value) || 0;
            const startYear = parseInt(document.getElementById('startYear').value);
            const withdrawalStartYear = parseInt(document.getElementById('withdrawalStartYear').value);
            const period = parseInt(document.getElementById('period').value);
            const sblocRate = parseFloat(document.getElementById('sblocRate').value) / 100;
            const maxBorrowing = parseFloat(document.getElementById('maxBorrowing').value) / 100;
            const annualWithdrawal = parseFloat(document.getElementById('annualWithdrawal').value);
            const monthlyWithdrawal = document.getElementById('monthlyWithdrawal').checked;
            const annualRaise = parseFloat(document.getElementById('annualRaise').value) / 100;
            const historicalData = parseHistoricalData(document.getElementById('historicalData').value);

            // Get chapter parameters
            const enableChapters = document.getElementById('enableChapters').checked;
            const chapter2YearsAfter = enableChapters ? parseInt(document.getElementById('chapter2YearsAfter').value) : null;
            const chapter2ReductionPct = enableChapters ? parseFloat(document.getElementById('chapter2ReductionPct').value) : 0;
            const chapter3YearsAfter = enableChapters ? parseInt(document.getElementById('chapter3YearsAfter').value) : null;
            const chapter3ReductionPct = enableChapters ? parseFloat(document.getElementById('chapter3ReductionPct').value) : 0;

            // Calculate chapter start years
            // First withdrawal year is withdrawalStartYear (since condition is currentYear >= withdrawalStartYear)
            let chapter2StartYear = null;
            let chapter3StartYear = null;
            if (enableChapters && chapter2YearsAfter) {
                const firstWithdrawalYear = withdrawalStartYear;
                chapter2StartYear = firstWithdrawalYear + chapter2YearsAfter;
                if (chapter3YearsAfter) {
                    chapter3StartYear = chapter2StartYear + chapter3YearsAfter;
                }
            }

            // Initialize simulation
            const results = [];
            let portfolioValue = startValue;
            let locBalance = initialLocBalance;
            let currentWithdrawal = annualWithdrawal;
            let marginCallTriggered = false;
            let yearOfMarginCall = null;
            let withdrawalYearCount = 0;

            // Run simulation for period+1 iterations to generate data from year 0 to year period
            for (let year = 0; year <= period; year++) {
                const currentYear = startYear + year;
                const yearReturn = historicalData[currentYear] || 0;

                // Determine if we should withdraw this year
                let shouldWithdraw = currentYear >= withdrawalStartYear;

                if (shouldWithdraw) {
                    // Calculate base withdrawal for this year
                    if (withdrawalYearCount > 0) {
                        currentWithdrawal = annualWithdrawal * Math.pow(1 + annualRaise, withdrawalYearCount);
                    } else {
                        currentWithdrawal = annualWithdrawal;
                    }

                    // Calculate chapter multiplier
                    let chapterMultiplier = 1.0;
                    if (enableChapters) {
                        if (chapter3StartYear && currentYear >= chapter3StartYear) {
                            // Chapter 3: cumulative reductions
                            chapterMultiplier = (1 - chapter2ReductionPct / 100) * (1 - chapter3ReductionPct / 100);
                        } else if (chapter2StartYear && currentYear >= chapter2StartYear) {
                            // Chapter 2: apply only chapter 2 reduction
                            chapterMultiplier = (1 - chapter2ReductionPct / 100);
                        }
                        // else Chapter 1: use default multiplier (1.0)
                    }

                    // Apply chapter multiplier to base withdrawal
                    currentWithdrawal = currentWithdrawal * chapterMultiplier;

                    // Monthly compounding if selected
                    if (monthlyWithdrawal) {
                        // Convert annual return to monthly geometric return
                        const monthlyReturn = Math.pow(1 + yearReturn, 1/12) - 1;
                        const monthlySblocRate = Math.pow(1 + sblocRate, 1/12) - 1;
                        const monthlyWithdrawalAmount = currentWithdrawal / 12;

                        for (let month = 0; month < 12; month++) {
                            // Apply portfolio return first
                            portfolioValue = portfolioValue * (1 + monthlyReturn);

                            // Apply interest to existing LOC balance
                            locBalance = locBalance * (1 + monthlySblocRate);

                            // Borrow from LOC for withdrawal
                            locBalance += monthlyWithdrawalAmount;
                        }
                    } else {
                        // Annual withdrawal: borrow at beginning of year
                        locBalance += currentWithdrawal;

                        // Apply portfolio return for the year
                        portfolioValue = portfolioValue * (1 + yearReturn);

                        // Apply annual interest to LOC balance (including new withdrawal)
                        locBalance = locBalance * (1 + sblocRate);
                    }

                    withdrawalYearCount++;
                } else {
                    // No withdrawal yet
                    portfolioValue = portfolioValue * (1 + yearReturn);

                    // Still apply interest to existing LOC balance if any
                    if (locBalance > 0) {
                        locBalance = locBalance * (1 + sblocRate);
                    }

                    currentWithdrawal = 0;
                }

                // Calculate metrics
                const maxLoc = portfolioValue * maxBorrowing;
                const locUsedPct = maxLoc > 0 ? (locBalance / maxLoc) * 100 : 0;
                const netPortfolio = portfolioValue - locBalance;

                // Check for margin call
                if (locUsedPct >= 100 && !marginCallTriggered) {
                    marginCallTriggered = true;
                    yearOfMarginCall = currentYear;
                }

                results.push({
                    year: currentYear,
                    returnPct: yearReturn * 100,
                    portfolioValue: portfolioValue,
                    withdrawal: currentWithdrawal,
                    locBalance: locBalance,
                    locUsedPct: locUsedPct,
                    netPortfolio: netPortfolio,
                    maxLoc: maxLoc
                });
            }

            displayResults(results, {
                assetName,
                startValue,
                startYear,
                withdrawalStartYear,
                period,
                sblocRate: sblocRate * 100,
                maxBorrowing: maxBorrowing * 100,
                annualWithdrawal,
                annualRaise: annualRaise * 100,
                marginCallTriggered,
                yearOfMarginCall,
                historicalData,
                enableChapters,
                chapter2StartYear,
                chapter2ReductionPct,
                chapter3StartYear,
                chapter3ReductionPct
            });

            // Auto-collapse parameters panel on mobile after successful simulation
            collapseMobilePanel();
        }

        // Liquidity Stress Testing Functions

        /**
         * Calculate liquidity metrics for a single year in a simulation
         * @param {number} portfolioValue - Current portfolio value
         * @param {number} locBalance - Current LOC balance
         * @param {number} maxBorrowing - Maximum borrowing percentage (as decimal)
         * @returns {Object} Liquidity metrics
         */
        function calculateLiquidityMetrics(portfolioValue, locBalance, maxBorrowing) {
            const maxLoc = portfolioValue * maxBorrowing;
            const locUsedPct = maxLoc > 0 ? (locBalance / maxLoc) * 100 : 0;
            const availableCredit = Math.max(0, maxLoc - locBalance);
            const distanceToMarginCall = Math.max(0, 100 - locUsedPct); // percentage points
            const safetyBuffer = availableCredit; // dollar amount

            return {
                maxLoc,
                locUsedPct,
                availableCredit,
                distanceToMarginCall,
                safetyBuffer
            };
        }

        /**
         * Run stress test scenarios on current portfolio state
         * @param {number} portfolioValue - Current portfolio value
         * @param {number} locBalance - Current LOC balance
         * @param {number} maxBorrowing - Maximum borrowing percentage (as decimal)
         * @returns {Object} Stress test results
         */
        function calculateStressTests(portfolioValue, locBalance, maxBorrowing) {
            const scenarios = [10, 20, 30, 40]; // Portfolio drop percentages
            const results = {};

            scenarios.forEach(dropPct => {
                const stressedValue = portfolioValue * (1 - dropPct / 100);
                const metrics = calculateLiquidityMetrics(stressedValue, locBalance, maxBorrowing);
                const wouldTriggerMarginCall = metrics.locUsedPct >= 100;

                results[`drop${dropPct}`] = {
                    dropPct,
                    newPortfolioValue: stressedValue,
                    newLocUsedPct: metrics.locUsedPct,
                    distanceToMarginCall: metrics.distanceToMarginCall,
                    marginCallTriggered: wouldTriggerMarginCall
                };
            });

            return results;
        }

        /**
         * Calculate months/days until margin call at current withdrawal rate
         * @param {number} availableCredit - Current available credit
         * @param {number} monthlyWithdrawal - Monthly withdrawal amount
         * @param {number} monthlySblocRate - Monthly SBLOC interest rate
         * @returns {Object} Time until margin call
         */
        function calculateTimeToMarginCall(availableCredit, monthlyWithdrawal, monthlySblocRate) {
            if (monthlyWithdrawal <= 0) {
                return { months: Infinity, days: Infinity, isInfinite: true };
            }

            // Simplified calculation: how many months of withdrawals fit in available credit
            // (ignoring compounding interest for simplicity - real calculation would be more complex)
            const approximateMonths = availableCredit / monthlyWithdrawal;
            const months = Math.floor(approximateMonths);
            const days = Math.floor(approximateMonths * 30); // Approximate

            return {
                months,
                days,
                isInfinite: months > 120 // If > 10 years, treat as effectively infinite
            };
        }

        /**
         * Aggregate liquidity statistics across all Monte Carlo simulations
         * @param {Array} allSimulations - All simulation results
         * @param {number} period - Number of years
         * @param {Object} params - Simulation parameters
         * @returns {Object} Aggregated liquidity stats
         */
        function aggregateLiquidityStats(allSimulations, period, params) {
            const percentiles = [10, 50, 90];
            const liquidityData = {};

            // Initialize data structure for each percentile
            percentiles.forEach(p => {
                liquidityData[p] = [];
            });

            // Calculate distance to margin call for each year across all simulations
            // Process all period+1 data points (indices 0 to period)
            for (let yearIdx = 0; yearIdx <= period; yearIdx++) {
                const yearDistances = [];
                const yearSafetyBuffers = [];

                allSimulations.forEach(sim => {
                    if (sim[yearIdx]) {
                        const distance = Math.max(0, 100 - sim[yearIdx].locUsedPct);
                        const buffer = sim[yearIdx].portfolioValue * params.maxBorrowing - sim[yearIdx].locBalance;
                        yearDistances.push(distance);
                        yearSafetyBuffers.push(Math.max(0, buffer));
                    }
                });

                // Sort to find percentiles
                yearDistances.sort((a, b) => a - b);
                yearSafetyBuffers.sort((a, b) => a - b);

                percentiles.forEach(p => {
                    const index = Math.floor((p / 100) * yearDistances.length);
                    const safeIndex = Math.floor((p / 100) * yearSafetyBuffers.length);

                    liquidityData[p].push({
                        year: params.startYear + yearIdx,
                        distanceToMarginCall: yearDistances[Math.min(index, yearDistances.length - 1)] || 0,
                        safetyBuffer: yearSafetyBuffers[Math.min(safeIndex, yearSafetyBuffers.length - 1)] || 0
                    });
                });
            }

            // Calculate safety buffer percentiles and find worst case across all simulations
            const allSafetyBuffers = [];
            const allLocUtilizations = [];
            let minDistanceToMarginCall = Infinity;
            let mostDangerousYear = null;
            let worstCaseLocUsedPct = 0;
            let dangerousYearDetails = null;

            allSimulations.forEach(sim => {
                sim.forEach(yearData => {
                    const distance = Math.max(0, 100 - yearData.locUsedPct);
                    allSafetyBuffers.push(distance);
                    allLocUtilizations.push(yearData.locUsedPct);

                    if (distance < minDistanceToMarginCall) {
                        minDistanceToMarginCall = distance;
                        mostDangerousYear = yearData.year;
                        worstCaseLocUsedPct = yearData.locUsedPct;
                        dangerousYearDetails = {
                            portfolioValue: yearData.portfolioValue,
                            locBalance: yearData.locBalance,
                            locUsedPct: yearData.locUsedPct,
                            maxLoc: yearData.maxLoc,
                            year: yearData.year
                        };
                    }
                });
            });

            // Calculate 10th percentile safety buffer
            allSafetyBuffers.sort((a, b) => a - b);
            const p10Index = Math.floor(0.10 * allSafetyBuffers.length);
            const p10SafetyBuffer = allSafetyBuffers.length > 0 ? allSafetyBuffers[p10Index] : 0;

            // Calculate 90th percentile LOC utilization
            allLocUtilizations.sort((a, b) => a - b);
            const p90Index = Math.floor(0.90 * allLocUtilizations.length);
            const p90LocUtilization = allLocUtilizations.length > 0 ? allLocUtilizations[p90Index] : 0;

            // Calculate median (P50) LOC utilization
            const p50Index = Math.floor(0.50 * allLocUtilizations.length);
            const medianLocUtilization = allLocUtilizations.length > 0 ? allLocUtilizations[p50Index] : 0;

            // Count high-risk years (utilization > 70%)
            const highRiskYears = allLocUtilizations.filter(util => util > 70).length;
            const totalYears = allLocUtilizations.length;
            const highRiskYearsPct = totalYears > 0 ? (highRiskYears / totalYears) * 100 : 0;

            return {
                liquidityData,
                minDistanceToMarginCall: Math.max(0, minDistanceToMarginCall === Infinity ? 0 : minDistanceToMarginCall),
                p10SafetyBuffer: p10SafetyBuffer,
                p90LocUtilization: p90LocUtilization,
                medianLocUtilization: medianLocUtilization,
                highRiskYears: highRiskYears,
                highRiskYearsPct: highRiskYearsPct,
                mostDangerousYear,
                worstCaseLocUsedPct,
                dangerousYearDetails
            };
        }

        // Monte Carlo Progress Helper Functions
        const statusMessages = [
            "Exploring parallel universes...",
            "Calculating quantum probabilities...",
            "Simulating market chaos...",
            "Rolling the dice thousands of times...",
            "Mapping financial futures...",
            "Computing portfolio outcomes...",
            "Analyzing risk scenarios...",
            "Forecasting wealth trajectories..."
        ];

        let statusMessageInterval = null;

        function showMonteCarloProgress(totalSimulations, returnModel = 'bootstrap') {
            const overlay = document.getElementById('monteCarloProgressOverlay');
            if (!overlay) return;

            // Reset progress elements
            document.getElementById('progressBarFill').style.width = '0%';
            document.getElementById('progressPercentage').textContent = '0%';
            document.getElementById('progressCounter').textContent = `0 / ${totalSimulations.toLocaleString()}`;

            // Set return model badge with color-coded styling
            const badge = document.getElementById('returnModelBadge');
            if (badge) {
                // Get regime mode for regime-switching model
                const regimeMode = typeof getRegimeMode === 'function' ? getRegimeMode() : 'conservative';
                const isHistoricalMode = regimeMode === 'historical';
                const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';

                const modelInfo = {
                    'bootstrap': {
                        label: ' Bootstrap Resampling',
                        bg: 'rgba(0, 131, 110, 0.15)',
                        color: isDarkMode ? '#2DD4BF' : '#00836E',
                        border: '1px solid rgba(0, 131, 110, 0.3)'
                    },
                    'regime': {
                        label: isHistoricalMode
                            ? ' Regime-Switching (Historical)'
                            : ' Regime-Switching (Conservative)',
                        bg: isHistoricalMode
                            ? 'rgba(59, 130, 246, 0.15)'
                            : 'rgba(234, 179, 8, 0.15)',
                        color: isHistoricalMode
                            ? (isDarkMode ? '#60A5FA' : '#1e40af')
                            : (isDarkMode ? '#FCD34D' : '#854d0e'),
                        border: isHistoricalMode
                            ? '1px solid rgba(59, 130, 246, 0.4)'
                            : '1px solid rgba(234, 179, 8, 0.4)'
                    },
                    'fat-tail': {
                        label: ' Fat-Tailed Distribution',
                        bg: 'rgba(239, 68, 68, 0.15)',
                        color: isDarkMode ? '#F87171' : '#ef4444',
                        border: '1px solid rgba(239, 68, 68, 0.3)'
                    }
                };

                const info = modelInfo[returnModel] || modelInfo['bootstrap'];
                badge.textContent = info.label;
                badge.style.backgroundColor = info.bg;
                badge.style.color = info.color;
                badge.style.border = info.border;
            }

            // Start rotating status messages
            let messageIndex = 0;
            const statusMessageEl = document.getElementById('progressStatusMessage');
            statusMessageEl.textContent = statusMessages[messageIndex];

            statusMessageInterval = setInterval(() => {
                messageIndex = (messageIndex + 1) % statusMessages.length;
                statusMessageEl.textContent = statusMessages[messageIndex];
            }, 2500);

            // Show overlay with animation
            overlay.style.display = 'flex';
        }

        function updateMonteCarloProgress(completed, total, percentage) {
            document.getElementById('progressBarFill').style.width = percentage + '%';
            document.getElementById('progressPercentage').textContent = Math.round(percentage) + '%';
            document.getElementById('progressCounter').textContent =
                `${completed.toLocaleString()} / ${total.toLocaleString()}`;
        }

        function hideMonteCarloProgress() {
            const overlay = document.getElementById('monteCarloProgressOverlay');
            if (!overlay) return;

            // Stop status message rotation
            if (statusMessageInterval) {
                clearInterval(statusMessageInterval);
                statusMessageInterval = null;
            }

            // Fade out animation
            overlay.style.opacity = '0';
            overlay.style.transition = 'opacity 0.4s ease';

            setTimeout(() => {
                overlay.style.display = 'none';
                overlay.style.opacity = '1';
                overlay.style.transition = '';
            }, 400);
        }

        // Regime-Switching Model Helper Functions

        /**
         * Regime configuration for both Historical and Conservative modes
         * Historical: Calibrated to S&P 500 1950-2024 performance (~7-8% CAGR)
         * Conservative: Stress-testing with extended crash durations (~3% CAGR)
         */
        const REGIME_CONFIG = {
            historical: {
                // Transition probabilities calibrated to historical regime durations
                // Bull ~9yr, Bear ~1.8yr, Crash ~1yr, Recovery ~1.5yr
                transitions: {
                    bull:     { bull: 0.89, bear: 0.06, crash: 0.02, recovery: 0.03 },
                    bear:     { bull: 0.05, bear: 0.45, crash: 0.20, recovery: 0.30 },
                    crash:    { bull: 0.00, bear: 0.20, crash: 0.10, recovery: 0.70 }, // Faster exit
                    recovery: { bull: 0.50, bear: 0.05, crash: 0.02, recovery: 0.43 }  // Faster to bull
                },
                // Survivorship bias adjustment (percentage points)
                survivorshipBias: 1.5,
                // Base regime parameters
                baseParams: {
                    bull: {
                        meanMultiplier: 1.0,
                        meanAdjustment: 0,
                        volMultiplier: 0.80,
                        correlationSpike: 0.0
                    },
                    bear: {
                        meanMultiplier: 0.30,
                        meanAdjustment: -10,
                        volMultiplier: 1.60,
                        correlationSpike: 0.35
                    },
                    crash: {
                        meanMultiplier: 0.0,
                        meanAdjustment: -30,
                        volMultiplier: 2.50,
                        correlationSpike: 0.65
                    },
                    recovery: {
                        meanMultiplier: 0.75,
                        meanAdjustment: 10,
                        volMultiplier: 1.30,
                        correlationSpike: 0.20
                    }
                },
                // Asset class overrides for bear markets
                bearMarketOverrides: {
                    commodity: {
                        meanMultiplier: 0.90,
                        meanAdjustment: 4,
                        volMultiplier: 1.30,
                        correlationSpike: 0.08
                    },
                    bond: {
                        meanMultiplier: 1.0,
                        meanAdjustment: 5,
                        volMultiplier: 1.20,
                        correlationSpike: -0.12
                    },
                    equity_index: {
                        meanMultiplier: 0.30,
                        meanAdjustment: -10,
                        volMultiplier: 1.60,
                        correlationSpike: 0.35
                    },
                    equity_stock: {
                        meanMultiplier: 0.25,
                        meanAdjustment: -12,
                        volMultiplier: 1.80,
                        correlationSpike: 0.45
                    }
                },
                // Asset class overrides for crash markets
                crashMarketOverrides: {
                    commodity: {
                        meanMultiplier: 0.75,
                        meanAdjustment: 8,
                        volMultiplier: 1.80,
                        correlationSpike: 0.05
                    },
                    bond: {
                        meanMultiplier: 1.0,
                        meanAdjustment: 6,
                        volMultiplier: 1.60,
                        correlationSpike: -0.25
                    },
                    equity_index: {
                        meanMultiplier: 0.0,
                        meanAdjustment: -30,
                        volMultiplier: 2.50,
                        correlationSpike: 0.65
                    },
                    equity_stock: {
                        meanMultiplier: 0.0,
                        meanAdjustment: -36,
                        volMultiplier: 3.00,
                        correlationSpike: 0.75
                    }
                }
            },
            conservative: {
                // Original stress-testing transition probabilities
                // Bull ~9yr, Bear ~1.8yr, Crash ~1.5yr (extended), Recovery ~1.8yr
                transitions: {
                    bull:     { bull: 0.89, bear: 0.06, crash: 0.02, recovery: 0.03 },
                    bear:     { bull: 0.05, bear: 0.45, crash: 0.20, recovery: 0.30 },
                    crash:    { bull: 0.00, bear: 0.15, crash: 0.35, recovery: 0.50 },
                    recovery: { bull: 0.45, bear: 0.08, crash: 0.02, recovery: 0.45 }
                },
                // Survivorship bias adjustment (percentage points)
                survivorshipBias: 2.0,
                // Base regime parameters (original stress-testing values)
                baseParams: {
                    bull: {
                        meanMultiplier: 1.0,
                        meanAdjustment: 0,
                        volMultiplier: 0.75,
                        correlationSpike: 0.0
                    },
                    bear: {
                        meanMultiplier: 0.25,
                        meanAdjustment: -12,
                        volMultiplier: 1.80,
                        correlationSpike: 0.40
                    },
                    crash: {
                        meanMultiplier: 0.0,
                        meanAdjustment: -35,
                        volMultiplier: 3.00,
                        correlationSpike: 0.70
                    },
                    recovery: {
                        meanMultiplier: 0.70,
                        meanAdjustment: 8,
                        volMultiplier: 1.40,
                        correlationSpike: 0.25
                    }
                },
                // Asset class overrides for bear markets (original values)
                bearMarketOverrides: {
                    commodity: {
                        meanMultiplier: 0.85,
                        meanAdjustment: 3,
                        volMultiplier: 1.40,
                        correlationSpike: 0.10
                    },
                    bond: {
                        meanMultiplier: 1.0,
                        meanAdjustment: 4,
                        volMultiplier: 1.30,
                        correlationSpike: -0.15
                    },
                    equity_index: {
                        meanMultiplier: 0.25,
                        meanAdjustment: -12,
                        volMultiplier: 1.80,
                        correlationSpike: 0.40
                    },
                    equity_stock: {
                        meanMultiplier: 0.20,
                        meanAdjustment: -14,
                        volMultiplier: 2.00,
                        correlationSpike: 0.50
                    }
                },
                // Asset class overrides for crash markets (original values)
                crashMarketOverrides: {
                    commodity: {
                        meanMultiplier: 0.70,
                        meanAdjustment: 10,
                        volMultiplier: 2.00,
                        correlationSpike: 0.05
                    },
                    bond: {
                        meanMultiplier: 1.0,
                        meanAdjustment: 8,
                        volMultiplier: 1.80,
                        correlationSpike: -0.30
                    },
                    equity_index: {
                        meanMultiplier: 0.0,
                        meanAdjustment: -35,
                        volMultiplier: 3.00,
                        correlationSpike: 0.70
                    },
                    equity_stock: {
                        meanMultiplier: 0.0,
                        meanAdjustment: -42,
                        volMultiplier: 3.50,
                        correlationSpike: 0.80
                    }
                }
            }
        };

        /**
         * Get survivorship bias adjustment for the selected mode
         * @param {string} mode - 'historical' or 'conservative'
         * @returns {number} - Survivorship bias in percentage points
         */
        function getSurvivorshipBias(mode = 'conservative') {
            return REGIME_CONFIG[mode].survivorshipBias;
        }

        /**
         * Get the currently selected regime mode
         * @returns {string} 'historical' or 'conservative'
         */
        function getRegimeMode() {
            const checkedRadio = document.querySelector('input[name="regimeMode"]:checked');
            return checkedRadio ? checkedRadio.value : 'conservative';
        }

        /**
         * Show/hide regime mode toggle based on return model selection
         * Call this whenever the return model dropdown changes
         */
        function updateRegimeModeToggleVisibility() {
            const returnModel = document.getElementById('returnModel');
            const toggleContainer = document.getElementById('regimeModeToggle');

            if (!returnModel || !toggleContainer) return;

            if (returnModel.value === 'regime') {
                toggleContainer.classList.remove('hidden');
            } else {
                toggleContainer.classList.add('hidden');
            }
        }

        /**
         * Update the description text when regime mode changes
         */
        function updateRegimeModeDescription() {
            const mode = getRegimeMode();
            const descriptionEl = document.getElementById('regimeModeDescription');

            if (!descriptionEl) return;

            const descriptions = {
                historical: 'Calibrated to historical S&P 500 data (1950-2024). Recommended for baseline retirement planning.',
                conservative: 'Stress-testing parameters with extended crash durations. Recommended for evaluating worst-case scenarios.'
            };

            descriptionEl.style.opacity = '0';
            setTimeout(() => {
                descriptionEl.textContent = descriptions[mode];
                descriptionEl.style.opacity = '1';
            }, 150);
        }

        /**
         * Generate market regime path (Bull, Bear, Crash, Recovery states)
         * @param {number} years - Number of years to simulate
         * @param {string} mode - 'historical' or 'conservative'
         * @returns {Array} - Array of regime states ('bull', 'bear', 'crash', 'recovery')
         */
        function generateRegimePath(years, mode = 'conservative') {
            const regimes = [];
            let currentRegime = 'bull'; // Start in bull market

            // Get transition probabilities for the selected mode from REGIME_CONFIG
            const transitions = REGIME_CONFIG[mode].transitions;

            for (let year = 0; year < years; year++) {
                regimes.push(currentRegime);

                // Determine next regime based on transition probabilities
                const rand = Math.random();
                const probs = transitions[currentRegime];

                let cumulative = 0;
                for (const [nextRegime, prob] of Object.entries(probs)) {
                    cumulative += prob;
                    if (rand < cumulative) {
                        currentRegime = nextRegime;
                        break;
                    }
                }
            }

            return regimes;
        }

        /**
         * Get return adjustment parameters based on market regime, asset class, and mode
         * @param {string} regime - 'bull', 'bear', 'crash', or 'recovery'
         * @param {string} assetClass - 'equity_stock', 'equity_index', 'commodity', or 'bond'
         * @param {string} mode - 'historical' or 'conservative'
         * @returns {object} - {meanMultiplier, meanAdjustment, volMultiplier, correlationSpike}
         */
        function getRegimeParameters(regime, assetClass = 'equity_stock', mode = 'conservative') {
            const config = REGIME_CONFIG[mode];

            // Get base parameters for regime
            const params = config.baseParams[regime] || config.baseParams.bull;

            // Apply asset class overrides for bear and crash regimes
            if (regime === 'bear' && config.bearMarketOverrides[assetClass]) {
                return { ...config.bearMarketOverrides[assetClass] };
            }

            if (regime === 'crash' && config.crashMarketOverrides[assetClass]) {
                return { ...config.crashMarketOverrides[assetClass] };
            }

            return { ...params };
        }

        /**
         * Get fat-tail distribution parameters based on asset class
         * @param {string} assetClass - 'equity_stock', 'equity_index', 'commodity', or 'bond'
         * @returns {object} - {survivorshipBias, volatilityScaling, degreesOfFreedom, skewMultiplier}
         */
        function getFatTailParameters(assetClass = 'equity_stock') {
            const params = {
                equity_stock: {
                    survivorshipBias: 4.5,       // Individual stocks have highest survivorship bias
                    volatilityScaling: 1.25,     // More volatile than indices
                    degreesOfFreedom: 4,         // Fatter tails (more extreme events)
                    skewMultiplier: 1.15         // Crashes hit harder than rallies
                },
                equity_index: {
                    survivorshipBias: 2.5,       // Indices rebalance, lower survivorship bias
                    volatilityScaling: 1.15,     // Baseline volatility scaling
                    degreesOfFreedom: 5,         // Standard fat tails
                    skewMultiplier: 1.10         // Moderate crash asymmetry
                },
                commodity: {
                    survivorshipBias: 1.0,       // Gold always existed, minimal bias
                    volatilityScaling: 1.10,     // Lower volatility amplification
                    degreesOfFreedom: 6,         // Lighter tails than equities
                    skewMultiplier: 1.05         // More symmetric distribution
                },
                bond: {
                    survivorshipBias: 1.5,       // Low survivorship bias
                    volatilityScaling: 1.05,     // Bonds less volatile
                    degreesOfFreedom: 7,         // Lightest tails
                    skewMultiplier: 1.0          // No skew adjustment
                }
            };

            return params[assetClass] || params.equity_stock;
        }

        /**
         * Sample return from historical data with regime adjustments
         * @param {Array} historicalReturns - Array of annual returns (percentage)
         * @param {string} regime - Current market regime
         * @param {string} returnModel - 'bootstrap', 'regime', or 'fat-tail'
         * @param {string} assetClass - Asset class for regime adjustments
         * @param {string} regimeMode - 'historical' or 'conservative' (only used for regime model)
         * @returns {number} - Annual return as decimal
         */
        function sampleReturn(historicalReturns, regime, returnModel, assetClass = 'equity_stock', regimeMode = 'conservative') {
            if (historicalReturns.length === 0) return 0;

            if (returnModel === 'bootstrap') {
                // Standard bootstrap sampling
                const randomIndex = Math.floor(Math.random() * historicalReturns.length);
                return historicalReturns[randomIndex] / 100;
            }

            if (returnModel === 'regime') {
                // Calculate historical mean and std dev
                const rawMean = historicalReturns.reduce((sum, r) => sum + r, 0) / historicalReturns.length;
                const variance = historicalReturns.reduce((sum, r) => sum + Math.pow(r - rawMean, 2), 0) / historicalReturns.length;
                const stdDev = Math.sqrt(variance);

                // Apply survivorship bias adjustment based on mode
                const survivorshipBiasAdjustment = getSurvivorshipBias(regimeMode);
                const mean = rawMean - survivorshipBiasAdjustment;

                // Get regime parameters for the selected mode
                const params = getRegimeParameters(regime, assetClass, regimeMode);

                // Adjust mean based on regime:
                // - Bull: Use adjusted mean (1.0x multiplier, no absolute adjustment)
                // - Bear: Generate negative returns (0.0x multiplier + absolute -15%)
                // - Recovery: Use 90% of adjusted mean (0.9x multiplier)
                const adjustedMean = (mean * params.meanMultiplier) + params.meanAdjustment;
                const adjustedStdDev = stdDev * params.volMultiplier;

                // Generate normal random variable (Box-Muller transform)
                const u1 = Math.random();
                const u2 = Math.random();
                const z = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);

                const sampledReturn = adjustedMean + (z * adjustedStdDev);

                // Clamp extreme returns to prevent numerical instability
                // Lower bound -99%: Portfolio retains 1% value, can still recover
                // Upper bound +500%: Generous ceiling for recovery rallies
                // Note: Crash regime with 3.5x vol on high-growth stocks can produce
                // extreme draws; clamping ensures simulation stability
                const clampedReturn = Math.max(-99, Math.min(500, sampledReturn));
                return clampedReturn / 100;
            }

            if (returnModel === 'fat-tail') {
                // Fat-tailed distribution using Student's t-distribution with asset class-specific enhancements
                // Calculate historical mean and standard deviation
                const rawMean = historicalReturns.reduce((sum, r) => sum + r, 0) / historicalReturns.length;
                const variance = historicalReturns.reduce((sum, r) => sum + Math.pow(r - rawMean, 2), 0) / historicalReturns.length;
                const stdDev = Math.sqrt(variance);

                // Get asset class-specific parameters
                const fatTailParams = getFatTailParameters(assetClass);

                // Apply survivorship bias adjustment (varies by asset class)
                // Individual stocks have higher bias than indices; commodities have minimal bias
                const adjustedMean = rawMean - fatTailParams.survivorshipBias;

                // Increase volatility to account for unobserved tail risks (varies by asset class)
                // Historical data may underestimate true volatility due to limited sample size
                const adjustedStdDev = stdDev * fatTailParams.volatilityScaling;

                // Generate Student's t random variable with asset class-specific degrees of freedom
                // Lower df = fatter tails (more extreme events). Individual stocks use df=4, indices df=5, etc.
                const df = fatTailParams.degreesOfFreedom;
                let chiSquared = 0;
                for (let i = 0; i < df; i++) {
                    // Clamp u1 away from 0 to prevent log(0) = -Infinity
                    const u1 = Math.max(1e-10, Math.random());
                    const u2 = Math.random();
                    const z = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
                    chiSquared += z * z;
                }

                // Clamp chiSquared away from zero to prevent division by zero / Infinity
                // Minimum value ensures t-scaling stays reasonable (< 20)
                // Formula: sqrt(df / chiSquared). If chiSquared too small, scaling explodes.
                // For df=4: min chiSquared = 0.01 ensures sqrt(4/0.01) = sqrt(400) = 20 max
                // For df=7: min chiSquared = 0.01225 ensures sqrt(7/0.01225) = sqrt(571)  24 max
                const minChiSquared = df / 400;  // Adaptive based on df
                chiSquared = Math.max(minChiSquared, chiSquared);
                const tScaling = Math.sqrt(df / chiSquared);

                // Generate standard normal for numerator with same safety clamp
                const u1 = Math.max(1e-10, Math.random());
                const u2 = Math.random();
                const zNormal = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);

                // Apply negative skew adjustment: make left tail heavier (varies by asset class)
                // This models the asymmetry observed in real market crashes (down more than up)
                // Individual stocks have stronger asymmetry; commodities more symmetric
                const skewAdjustment = zNormal < 0 ? fatTailParams.skewMultiplier : 1.0;

                // Combine all adjustments
                const sampledReturn = adjustedMean + (zNormal * tScaling * adjustedStdDev * skewAdjustment);

                // Final safety check: cap extreme returns at 200% to prevent portfolio explosion
                // This still allows for extreme events but prevents numerical instability
                const clampedReturn = Math.max(-200, Math.min(200, sampledReturn));
                return clampedReturn / 100;
            }

            // Default fallback
            const randomIndex = Math.floor(Math.random() * historicalReturns.length);
            return historicalReturns[randomIndex] / 100;
        }

        // Run "Sell Assets" simulation for a single path
        // This simulates the traditional approach: selling assets each year for income and paying capital gains tax
        function runSellAssetsPath(params) {
            const {
                startValue,
                initialCostBasis,
                period,
                startYear,
                withdrawalStartYear,
                annualWithdrawal,
                annualRaise,
                ltcgTaxRate,
                dividendYield,
                ordinaryTaxRate,
                monthlyWithdrawal,
                enableChapters,
                chapter2StartYear,
                chapter2ReductionPct,
                chapter3StartYear,
                chapter3ReductionPct,
                returnsArray  // Array of annual returns for this path
            } = params;

            let portfolioValue = startValue;
            let costBasis = initialCostBasis || startValue;
            const results = [];
            let totalTaxesPaid = 0;

            // Failure tracking
            let failed = false;
            let failureYear = null;
            let failureReason = null;
            let totalWithdrawalShortfall = 0;  // Track cumulative underfunding

            const numPeriodsPerYear = monthlyWithdrawal ? 12 : 1;

            // Run simulation for period+1 iterations to generate data from year 0 to year period
            for (let yearOffset = 0; yearOffset <= period; yearOffset++) {
                const currentYear = startYear + yearOffset;
                const portfolioReturn = returnsArray[yearOffset] || 0;

                // Check if already failed in previous year
                if (failed) {
                    // Continue recording zero values for remaining years
                    results.push({
                        year: currentYear,
                        returnPct: portfolioReturn * 100,
                        portfolioValue: 0,
                        costBasis: 0,
                        withdrawal: 0,
                        requestedWithdrawal: 0,
                        withdrawalShortfall: 0,
                        capitalGainsTax: 0,
                        dividendTax: 0,
                        totalTaxThisYear: 0,
                        totalTaxesPaid: totalTaxesPaid,
                        netWorth: 0,
                        failed: true
                    });
                    continue;
                }

                // Apply dividend tax by LIQUIDATING portfolio (Sell Assets Strategy)
                let dividendTax = 0;
                if (dividendYield > 0 && ordinaryTaxRate > 0) {
                    const dividendIncome = portfolioValue * dividendYield;
                    dividendTax = dividendIncome * ordinaryTaxRate;

                    // Check if can afford dividend tax
                    if (dividendTax > portfolioValue) {
                        dividendTax = portfolioValue;  // Take what's left
                        portfolioValue = 0;
                    } else {
                        portfolioValue -= dividendTax;
                    }
                    totalTaxesPaid += dividendTax;
                }

                // Calculate withdrawal for this year
                let requestedWithdrawal = 0;
                let actualWithdrawal = 0;
                let withdrawalShortfall = 0;

                if (currentYear >= withdrawalStartYear) {
                    const yearsSinceStart = currentYear - withdrawalStartYear;
                    requestedWithdrawal = annualWithdrawal * Math.pow(1 + annualRaise, yearsSinceStart);

                    // Calculate and apply chapter multiplier
                    let chapterMultiplier = 1.0;
                    if (enableChapters) {
                        if (chapter3StartYear && currentYear >= chapter3StartYear) {
                            chapterMultiplier = (1 - chapter2ReductionPct / 100) * (1 - chapter3ReductionPct / 100);
                        } else if (chapter2StartYear && currentYear >= chapter2StartYear) {
                            chapterMultiplier = (1 - chapter2ReductionPct / 100);
                        }
                    }
                    requestedWithdrawal *= chapterMultiplier;
                }

                // Calculate capital gains tax on withdrawal
                // Need to sell enough to cover both withdrawal AND the tax itself
                let capitalGainsTax = 0;
                let totalAmountToSell = 0;

                if (requestedWithdrawal > 0 && portfolioValue > 0) {
                    // Calculate average cost basis per dollar
                    const basisPerDollar = portfolioValue > 0 ? costBasis / portfolioValue : 0;

                    // We need: amountToSell = withdrawal + tax
                    // Tax = (amountToSell - amountToSell * basisPerDollar) * taxRate
                    // Tax = amountToSell * (1 - basisPerDollar) * taxRate
                    // withdrawal = amountToSell - tax
                    // withdrawal = amountToSell - amountToSell * (1 - basisPerDollar) * taxRate
                    // withdrawal = amountToSell * (1 - (1 - basisPerDollar) * taxRate)
                    // amountToSell = withdrawal / (1 - (1 - basisPerDollar) * taxRate)

                    const taxableGainPerDollar = Math.max(0, 1 - basisPerDollar);
                    const denominator = 1 - (taxableGainPerDollar * ltcgTaxRate);

                    if (denominator > 0) {
                        totalAmountToSell = requestedWithdrawal / denominator;
                    } else {
                        // Edge case: tax rate is so high that we can't mathematically solve
                        // Fall back to approximation
                        totalAmountToSell = requestedWithdrawal * 1.5; // Conservative estimate
                    }

                    // Check if portfolio can fund the withdrawal
                    if (totalAmountToSell > portfolioValue) {
                        // WITHDRAWAL SHORTFALL - can't fund full withdrawal
                        const availableForWithdrawal = portfolioValue;

                        // Calculate how much actual withdrawal this provides after tax
                        const basisOfAvailable = availableForWithdrawal * basisPerDollar;
                        const gainOnAvailable = Math.max(0, availableForWithdrawal - basisOfAvailable);
                        capitalGainsTax = gainOnAvailable * ltcgTaxRate;
                        actualWithdrawal = availableForWithdrawal - capitalGainsTax;

                        withdrawalShortfall = requestedWithdrawal - actualWithdrawal;
                        totalWithdrawalShortfall += withdrawalShortfall;

                        // Deplete portfolio
                        totalAmountToSell = portfolioValue;
                        costBasis = 0;
                        portfolioValue = 0;
                        totalTaxesPaid += capitalGainsTax;

                        // Mark as failed - portfolio depleted
                        failed = true;
                        failureYear = currentYear;
                        failureReason = 'portfolio_depleted';

                    } else {
                        // Normal case - can fund full withdrawal
                        actualWithdrawal = requestedWithdrawal;

                        const basisOfSoldAssets = totalAmountToSell * basisPerDollar;
                        const capitalGain = Math.max(0, totalAmountToSell - basisOfSoldAssets);
                        capitalGainsTax = capitalGain * ltcgTaxRate;
                        totalTaxesPaid += capitalGainsTax;

                        portfolioValue -= totalAmountToSell;
                        costBasis -= basisOfSoldAssets;
                    }
                } else if (requestedWithdrawal > 0 && portfolioValue <= 0) {
                    // Portfolio already depleted, can't fund any withdrawal
                    withdrawalShortfall = requestedWithdrawal;
                    totalWithdrawalShortfall += withdrawalShortfall;
                    actualWithdrawal = 0;

                    if (!failed) {
                        failed = true;
                        failureYear = currentYear;
                        failureReason = 'portfolio_depleted';
                    }
                }

                // Apply returns (only if portfolio has value)
                if (portfolioValue > 0) {
                    if (numPeriodsPerYear === 12) {
                        const monthlyReturn = Math.pow(1 + portfolioReturn, 1/12) - 1;
                        for (let month = 0; month < 12; month++) {
                            portfolioValue *= (1 + monthlyReturn);
                        }
                    } else {
                        portfolioValue *= (1 + portfolioReturn);
                    }
                }

                // Cost basis does NOT grow with market returns
                // It only changes when assets are bought or sold
                // Unrealized gains remain untaxed until realized through sale

                // Safety check for numerical issues
                if (!isFinite(portfolioValue) || portfolioValue < 0) {
                    portfolioValue = 0;
                    costBasis = 0;
                    if (!failed) {
                        failed = true;
                        failureYear = currentYear;
                        failureReason = 'numerical_instability';
                    }
                }

                results.push({
                    year: currentYear,
                    returnPct: portfolioReturn * 100,
                    portfolioValue: portfolioValue,
                    costBasis: costBasis,
                    withdrawal: actualWithdrawal,
                    requestedWithdrawal: requestedWithdrawal,
                    withdrawalShortfall: withdrawalShortfall,
                    capitalGainsTax: capitalGainsTax,
                    dividendTax: dividendTax,
                    totalTaxThisYear: capitalGainsTax + dividendTax,
                    totalTaxesPaid: totalTaxesPaid,
                    netWorth: portfolioValue,
                    failed: failed
                });
            }

            return {
                results: results,
                terminalValue: portfolioValue,
                terminalCostBasis: costBasis,
                totalTaxesPaid: totalTaxesPaid,
                finalNetWorth: portfolioValue,
                // Failure information
                failed: failed,
                failureYear: failureYear,
                failureReason: failureReason,
                totalWithdrawalShortfall: totalWithdrawalShortfall
            };
        }

        // Monte Carlo Simulation
        async function runMonteCarloSimulation() {
            // Validate portfolio weights
            const assetNames = Object.keys(selectedPortfolioAssets);
            if (assetNames.length === 0) {
                showToast('Please add at least one asset to your portfolio', 'error', 4000);
                return;
            }

            const totalWeight = assetNames.reduce((sum, name) => sum + selectedPortfolioAssets[name], 0);
            if (Math.abs(totalWeight - 100) > 0.1) {
                showToast(`Portfolio weights must total 100% (currently ${totalWeight.toFixed(1)}%)`, 'error', 4000);
                return;
            }

            // Get common parameters
            const startValue = parseFloat(document.getElementById('startValue').value);
            const initialLocBalance = parseFloat(document.getElementById('locBalance').value) || 0;
            const startYear = parseInt(document.getElementById('startYear').value);
            const withdrawalStartYear = parseInt(document.getElementById('withdrawalStartYear').value);
            const period = parseInt(document.getElementById('period').value);
            const sblocRate = parseFloat(document.getElementById('sblocRate').value) / 100;
            const maxBorrowing = parseFloat(document.getElementById('maxBorrowing').value) / 100;
            const maintenanceMargin = parseFloat(document.getElementById('maintenanceMargin').value) / 100;
            const liquidationHaircut = parseFloat(document.getElementById('liquidationHaircut').value) / 100;
            const annualWithdrawal = parseFloat(document.getElementById('annualWithdrawal').value);
            const monthlyWithdrawal = document.getElementById('monthlyWithdrawal').checked;
            const annualRaise = parseFloat(document.getElementById('annualRaise').value) / 100;
            const numSimulations = parseInt(document.getElementById('numSimulations').value);
            const inflationRate = parseFloat(document.getElementById('inflationRate').value) / 100;

            // Get return model selection
            const returnModel = document.getElementById('returnModel')?.value || 'bootstrap';

            // Get tax modeling parameters
            const enableTaxModeling = document.getElementById('enableTaxModeling')?.checked || false;
            const taxAdvantaged = document.getElementById('taxAdvantaged')?.checked || false;
            const dividendYield = enableTaxModeling && !taxAdvantaged ? parseFloat(document.getElementById('dividendYield')?.value || 0) / 100 : 0;
            const ordinaryTaxRate = enableTaxModeling && !taxAdvantaged ? parseFloat(document.getElementById('ordinaryTaxRate')?.value || 0) / 100 : 0;
            const ltcgTaxRate = enableTaxModeling && !taxAdvantaged ? parseFloat(document.getElementById('ltcgTaxRate')?.value || 0) / 100 : 0;

            // Get chapter parameters
            const enableChapters = document.getElementById('enableChapters').checked;
            const chapter2YearsAfter = enableChapters ? parseInt(document.getElementById('chapter2YearsAfter').value) : null;
            const chapter2ReductionPct = enableChapters ? parseFloat(document.getElementById('chapter2ReductionPct').value) : 0;
            const chapter3YearsAfter = enableChapters ? parseInt(document.getElementById('chapter3YearsAfter').value) : null;
            const chapter3ReductionPct = enableChapters ? parseFloat(document.getElementById('chapter3ReductionPct').value) : 0;

            // Calculate chapter start years
            // First withdrawal year is withdrawalStartYear (since condition is currentYear >= withdrawalStartYear)
            let chapter2StartYear = null;
            let chapter3StartYear = null;
            if (enableChapters && chapter2YearsAfter) {
                const firstWithdrawalYear = withdrawalStartYear;
                chapter2StartYear = firstWithdrawalYear + chapter2YearsAfter;
                if (chapter3YearsAfter) {
                    chapter3StartYear = chapter2StartYear + chapter3YearsAfter;
                }
            }

            // Show progress overlay
            showMonteCarloProgress(numSimulations, returnModel);

            // Small delay to ensure overlay is visible before computation starts
            await new Promise(resolve => setTimeout(resolve, 100));

            // Prepare historical return data for each asset
            // Extract just the return values (numbers) for Monte Carlo sampling
            const assetReturnsData = {};
            assetNames.forEach(assetName => {
                const yearReturnData = getAssetHistoricalReturns(assetName);
                // Convert {year, return} objects to simple array of return percentages for sampling
                assetReturnsData[assetName] = yearReturnData.map(d => d.return);
            });

            // Run simulations in batches with progress updates
            const allSimulations = [];
            const allSellSimulations = [];  // Track sell strategy simulations
            const allBBDDividendTaxes = [];  // Track BBD dividend taxes for each simulation
            const numPeriodsPerYear = monthlyWithdrawal ? 12 : 1;

            // Determine batch size and delay based on total simulations
            // Delay values are calibrated to keep total visual progress time ~1100ms regardless of simulation count
            const batchSize = 100;
            const delayPerBatch = numSimulations <= 1000 ? 21 :
                                  numSimulations <= 5000 ? 15 :
                                  numSimulations <= 10000 ? 11 :
                                  numSimulations <= 50000 ? 2 : 1;

            for (let batchStart = 0; batchStart < numSimulations; batchStart += batchSize) {
                const batchEnd = Math.min(batchStart + batchSize, numSimulations);

                // Run this batch of simulations
                for (let simNum = batchStart; simNum < batchEnd; simNum++) {
                let portfolioValue = startValue;
                let locBalance = initialLocBalance;
                let costBasis = startValue; // Track cost basis for capital gains
                const simulationResults = [];
                let marginCallTriggered = false;
                const portfolioReturnsPath = [];  // Store returns for sell strategy comparison
                let totalDividendTaxesPaid = 0; // Track cumulative dividend taxes
                let cumulativeWithdrawal = 0; // Track cumulative withdrawals

                // Get the selected regime mode for this simulation
                const regimeMode = typeof getRegimeMode === 'function' ? getRegimeMode() : 'conservative';

                // Generate regime path for this simulation (if using regime model)
                // Generate period+1 regimes to match simulation length
                const regimePath = returnModel === 'regime' ? generateRegimePath(period + 1, regimeMode) : [];

                // Run simulation for period+1 iterations to generate data from year 0 to year period
                for (let yearOffset = 0; yearOffset <= period; yearOffset++) {
                    const currentYear = startYear + yearOffset;
                    const currentRegime = returnModel === 'regime' ? regimePath[yearOffset] : 'bull';

                    // Generate weighted portfolio return for this year using new sampling method
                    let portfolioReturn = 0;

                    // ISSUE 1 FIX: For bootstrap model, use block bootstrap to preserve asset correlations
                    // Sample the same historical year index for all assets to maintain their natural correlations
                    let sharedYearIndex = null;
                    if (returnModel === 'bootstrap') {
                        // Find minimum historical data length across all assets
                        const minHistoricalYears = Math.min(...assetNames.map(name => assetReturnsData[name].length));
                        sharedYearIndex = Math.floor(Math.random() * minHistoricalYears);
                    }

                    assetNames.forEach(assetName => {
                        const assetReturns = assetReturnsData[assetName];
                        if (assetReturns.length > 0) {
                            let assetReturn;
                            if (returnModel === 'bootstrap' && sharedYearIndex !== null) {
                                // Use shared year index to preserve correlations
                                assetReturn = assetReturns[sharedYearIndex] / 100;
                            } else {
                                // For regime and fat-tail models, sample independently (synthetic returns)
                                const assetClass = getAssetClass(assetName);
                                assetReturn = sampleReturn(assetReturns, currentRegime, returnModel, assetClass, regimeMode);
                            }
                            const weight = selectedPortfolioAssets[assetName] / 100;
                            portfolioReturn += assetReturn * weight;
                        }
                    });

                    // Store return for sell strategy comparison
                    portfolioReturnsPath.push(portfolioReturn);

                    // Apply dividend tax - BORROW via SBLOC instead of liquidating
                    if (dividendYield > 0 && ordinaryTaxRate > 0) {
                        const dividendIncome = portfolioValue * dividendYield;
                        const dividendTax = dividendIncome * ordinaryTaxRate;
                        locBalance += dividendTax; // Borrow to pay dividend taxes (true BBD)
                        totalDividendTaxesPaid += dividendTax; // Track cumulative dividend taxes
                    }

                    // Calculate withdrawal for this year
                    let currentWithdrawal = 0;
                    if (currentYear >= withdrawalStartYear) {
                        const yearsSinceStart = currentYear - withdrawalStartYear;
                        currentWithdrawal = annualWithdrawal * Math.pow(1 + annualRaise, yearsSinceStart);

                        // Calculate and apply chapter multiplier
                        let chapterMultiplier = 1.0;
                        if (enableChapters) {
                            if (chapter3StartYear && currentYear >= chapter3StartYear) {
                                // Chapter 3: cumulative reductions
                                chapterMultiplier = (1 - chapter2ReductionPct / 100) * (1 - chapter3ReductionPct / 100);
                            } else if (chapter2StartYear && currentYear >= chapter2StartYear) {
                                // Chapter 2: apply only chapter 2 reduction
                                chapterMultiplier = (1 - chapter2ReductionPct / 100);
                            }
                            // else Chapter 1: use default multiplier (1.0)
                        }
                        currentWithdrawal *= chapterMultiplier;
                    }

                    // Update cumulative withdrawal tracking
                    cumulativeWithdrawal += currentWithdrawal;

                    // Apply returns and withdrawals
                    if (numPeriodsPerYear === 12) {
                        const monthlyReturn = Math.pow(1 + portfolioReturn, 1/12) - 1;
                        const monthlyInterest = Math.pow(1 + sblocRate, 1/12) - 1;
                        const monthlyWithdrawalAmount = currentWithdrawal / 12;

                        for (let month = 0; month < 12; month++) {
                            portfolioValue *= (1 + monthlyReturn);
                            locBalance *= (1 + monthlyInterest);
                            locBalance += monthlyWithdrawalAmount;
                        }
                    } else {
                        // Annual withdrawal: borrow at beginning of year
                        locBalance += currentWithdrawal;
                        portfolioValue *= (1 + portfolioReturn);
                        locBalance *= (1 + sblocRate);
                    }

                    // Safety check: If portfolio goes negative or NaN, simulation has failed
                    if (!isFinite(portfolioValue) || portfolioValue < 0) {
                        portfolioValue = 0;
                        simulationResults.push({
                            year: currentYear,
                            returnPct: portfolioReturn * 100,
                            portfolioValue: 0,
                            locBalance: locBalance,
                            locUsedPct: 0,
                            netPortfolio: -locBalance,
                            maxLoc: 0,
                            marginCall: true,
                            liquidation: false,
                            failed: true,
                            withdrawal: currentWithdrawal,
                            cumulativeWithdrawal: cumulativeWithdrawal
                        });
                        break; // Stop this simulation
                    }

                    // Calculate metrics
                    let maxLoc = portfolioValue * maxBorrowing;
                    const currentLTV = portfolioValue > 0 ? (locBalance / portfolioValue) : 0;
                    let locUsedPct = maxLoc > 0 ? (locBalance / maxLoc) * 100 : 0;
                    let netPortfolio = portfolioValue - locBalance;

                    // Check for margin call and forced liquidation
                    let liquidationOccurred = false;
                    if (currentLTV >= maxBorrowing && !marginCallTriggered) {
                        marginCallTriggered = true;
                        liquidationOccurred = true;

                        // Forced liquidation: sell assets with haircut to restore safe LTV
                        const targetLTV = maintenanceMargin * 0.8; // Target 80% of maintenance margin
                        const targetLoc = portfolioValue * targetLTV;
                        const excessLoc = locBalance - targetLoc;

                        if (excessLoc > 0) {
                            // Sell assets to pay down LOC
                            const assetsToSell = excessLoc / (1 - liquidationHaircut);

                            // Calculate capital gains tax on forced liquidation if enabled
                            let capitalGainsTax = 0;
                            if (ltcgTaxRate > 0 && costBasis > 0) {
                                const assetBasisSold = (assetsToSell / portfolioValue) * costBasis;
                                const capitalGain = Math.max(0, assetsToSell - assetBasisSold);
                                capitalGainsTax = capitalGain * ltcgTaxRate;
                            }

                            portfolioValue -= assetsToSell;
                            locBalance -= (assetsToSell * (1 - liquidationHaircut));
                            portfolioValue -= capitalGainsTax; // Further reduce by tax

                            // Update cost basis proportionally
                            if (costBasis > 0 && portfolioValue > 0) {
                                costBasis = costBasis * (portfolioValue / (portfolioValue + assetsToSell + capitalGainsTax));
                            }
                        }

                        // Recalculate after liquidation
                        maxLoc = portfolioValue * maxBorrowing;
                        locUsedPct = maxLoc > 0 ? (locBalance / maxLoc) * 100 : 0;
                        netPortfolio = portfolioValue - locBalance;

                        // If still underwater or net worth  0, mark as complete failure
                        if (netPortfolio <= 0 || portfolioValue <= 0) {
                            portfolioValue = 0;
                            netPortfolio = -locBalance;
                            // Break out of year loop - simulation failed
                            simulationResults.push({
                                year: currentYear,
                                returnPct: portfolioReturn * 100,
                                portfolioValue: 0,
                                locBalance: locBalance,
                                locUsedPct: 0,
                                netPortfolio: netPortfolio,
                                maxLoc: 0,
                                marginCall: true,
                                liquidation: liquidationOccurred,
                                failed: true,
                                withdrawal: currentWithdrawal,
                                cumulativeWithdrawal: cumulativeWithdrawal
                            });
                            break; // Stop this simulation
                        }
                    }

                    simulationResults.push({
                        year: currentYear,
                        returnPct: portfolioReturn * 100,
                        portfolioValue: portfolioValue,
                        locBalance: locBalance,
                        locUsedPct: locUsedPct,
                        netPortfolio: netPortfolio,
                        maxLoc: maxLoc,
                        marginCall: marginCallTriggered,
                        liquidation: liquidationOccurred,
                        inWarningZone: currentLTV >= maintenanceMargin && currentLTV < maxBorrowing,
                        withdrawal: currentWithdrawal,
                        cumulativeWithdrawal: cumulativeWithdrawal
                    });
                }

                allSimulations.push(simulationResults);
                allBBDDividendTaxes.push(totalDividendTaxesPaid);  // Store BBD dividend taxes

                // Run corresponding sell strategy simulation with same returns path
                if (ltcgTaxRate > 0 || true) {  // Always run comparison
                    const sellResult = runSellAssetsPath({
                        startValue: startValue,
                        initialCostBasis: startValue,
                        period: period,
                        startYear: startYear,
                        withdrawalStartYear: withdrawalStartYear,
                        annualWithdrawal: annualWithdrawal,
                        annualRaise: annualRaise,
                        ltcgTaxRate: ltcgTaxRate,
                        dividendYield: dividendYield,
                        ordinaryTaxRate: ordinaryTaxRate,
                        monthlyWithdrawal: monthlyWithdrawal,
                        enableChapters: enableChapters,
                        chapter2StartYear: chapter2StartYear,
                        chapter2ReductionPct: chapter2ReductionPct,
                        chapter3StartYear: chapter3StartYear,
                        chapter3ReductionPct: chapter3ReductionPct,
                        returnsArray: portfolioReturnsPath
                    });
                    allSellSimulations.push(sellResult);
                }
                }

                // Update progress after each batch
                const progress = (batchEnd / numSimulations) * 100;
                updateMonteCarloProgress(batchEnd, numSimulations, progress);

                // Artificial delay for visual effect (skip delay for final batch to show 100% immediately)
                if (batchEnd < numSimulations) {
                    await new Promise(resolve => setTimeout(resolve, delayPerBatch));
                }
            }

            // Ensure final progress shows 100% before hiding
            updateMonteCarloProgress(numSimulations, numSimulations, 100);

            // Small delay to let user see 100% completion
            await new Promise(resolve => setTimeout(resolve, 300));

            // Hide progress overlay
            hideMonteCarloProgress();

            // Calculate percentiles and statistics
            const monteCarloResults = calculateMonteCarloStatistics(allSimulations, assetNames, {
                sellSimulations: allSellSimulations,  // Pass sell simulations for comparison
                bbdDividendTaxes: allBBDDividendTaxes,  // Pass BBD dividend taxes
                startValue,
                startYear,
                withdrawalStartYear,
                period,
                sblocRate: sblocRate * 100,
                maxBorrowing: maxBorrowing,  // Keep as decimal (0.65)
                maintenanceMargin: maintenanceMargin,  // Add maintenance margin
                liquidationHaircut: liquidationHaircut,  // Add liquidation haircut
                annualWithdrawal,
                annualRaise: annualRaise * 100,
                numSimulations,
                returnModel,
                inflationRate: inflationRate * 100,  // Add inflation rate (convert back to percentage)
                withdrawMonthly: numPeriodsPerYear === 12,  // Add withdrawal frequency
                initialLocBalance,  // Add initial LOC balance
                enableChapters,
                chapter2StartYear,
                chapter2ReductionPct,
                chapter3StartYear,
                chapter3ReductionPct,
                dividendYield: dividendYield * 100,  // Add dividend yield (convert to percentage)
                ordinaryTaxRate: ordinaryTaxRate * 100  // Add ordinary tax rate (convert to percentage)
            });

            // Display Monte Carlo results
            displayMonteCarloResults(monteCarloResults);

            // Auto-collapse parameters panel on mobile after successful simulation
            collapseMobilePanel();

            // Auto-save the portfolio configuration after successful simulation
            autoSaveLastPortfolio();

            // Show completion toast
            showToast(`Monte Carlo simulation complete! Analyzed ${numSimulations.toLocaleString()} scenarios.`, 'success', 3000);
        }

        // Calculate theoretical debt (withdrawals + interest + dividend taxes, no margin call paydowns)
        function calculateTheoreticalDebt(params) {
            const { annualWithdrawal, annualRaise, sblocRate, period, withdrawMonthly,
                    startYear, withdrawalStartYear,
                    initialLocBalance, startValue, dividendYield, ordinaryTaxRate, medianPortfolioCAGR } = params;

            let theoreticalDebt = initialLocBalance || 0;
            let portfolioValue = startValue || 10000000;  // Track portfolio for dividend tax calculation
            const numPeriodsPerYear = withdrawMonthly ? 12 : 1;

            // Convert rates from percentage to decimal (params stores as percentage like 7.4)
            const sblocRateDecimal = sblocRate / 100;
            const dividendYieldDecimal = (dividendYield || 0) / 100;
            const ordinaryTaxRateDecimal = (ordinaryTaxRate || 0) / 100;

            // Use actual median portfolio CAGR from simulations (or 10% default)
            const assumedPortfolioReturn = medianPortfolioCAGR || 0.10;

            console.log(` Theoretical Debt Calculation Starting:`);
            console.log(`   Portfolio Growth Rate: ${(assumedPortfolioReturn * 100).toFixed(2)}%`);
            console.log(`   Dividend Yield: ${dividendYieldDecimal * 100}%`);
            console.log(`   Ordinary Tax Rate: ${ordinaryTaxRateDecimal * 100}%`);

            // Run simulation for period+1 iterations to generate data from year 0 to year period
            for (let year = 0; year <= period; year++) {
                const currentYear = startYear + year;

                // Calculate dividend tax if enabled (borrowed via SBLOC in true BBD)
                let dividendTax = 0;
                if (dividendYieldDecimal > 0 && ordinaryTaxRateDecimal > 0) {
                    const dividendIncome = portfolioValue * dividendYieldDecimal;
                    dividendTax = dividendIncome * ordinaryTaxRateDecimal;
                }

                // Calculate withdrawal for this year (matching simulation logic)
                let currentWithdrawal = 0;
                if (currentYear >= withdrawalStartYear) {
                    const yearsSinceStart = currentYear - withdrawalStartYear;
                    currentWithdrawal = annualWithdrawal * Math.pow(1 + annualRaise / 100, yearsSinceStart);
                }

                // Add dividend tax FIRST (at start of year), matching actual simulation order
                theoreticalDebt += dividendTax;

                // Apply interest and withdrawals
                if (numPeriodsPerYear === 12) {
                    const monthlyInterest = Math.pow(1 + sblocRateDecimal, 1/12) - 1;
                    const monthlyWithdrawalAmount = currentWithdrawal / 12;

                    for (let month = 0; month < 12; month++) {
                        theoreticalDebt *= (1 + monthlyInterest);
                        theoreticalDebt += monthlyWithdrawalAmount;
                    }
                } else {
                    // Annual withdrawal: borrow at beginning of year
                    theoreticalDebt += currentWithdrawal;
                    theoreticalDebt *= (1 + sblocRateDecimal);
                }

                // Grow portfolio for next year's dividend tax calculation
                portfolioValue *= (1 + assumedPortfolioReturn);
            }

            console.log(` Theoretical Debt Calculation Complete:`);
            console.log(`   Final Portfolio Value: $${portfolioValue.toLocaleString()}`);
            console.log(`   Final Theoretical Debt: $${theoreticalDebt.toLocaleString()}`);

            return theoreticalDebt;
        }

        // Calculate statistics from all Monte Carlo simulations
        function calculateMonteCarloStatistics(allSimulations, assetNames, params) {
            // BUG FIX: Use the intended period from params, not the first simulation's length
            // The first simulation may have had a margin call and stopped early,
            // which would cause the extraction loop to only extract partial data
            const period = params.period;
            const percentiles = [10, 25, 50, 75, 90];
            const percentilesData = {};

            percentiles.forEach(p => {
                percentilesData[p] = [];
            });

            // PATH-COHERENT PERCENTILES: Industry-standard approach
            // Each percentile represents ONE SPECIFIC simulation path from start to finish
            // This matches how professional portfolio analysts and financial planning tools work

            // Step 1: Rank all simulations by their TERMINAL (final) net worth
            const simulationRankings = allSimulations.map((sim, simIdx) => {
                const lastYear = sim[sim.length - 1];
                return {
                    simIdx: simIdx,
                    terminalNetWorth: lastYear.netPortfolio,
                    simulation: sim
                };
            })
            // CRITICAL: Filter out invalid terminal values (NaN, Infinity) BEFORE sorting
            // This ensures percentile paths match the terminalStats percentiles
            .filter(ranking => isFinite(ranking.terminalNetWorth));

            // Sort by terminal net worth (lowest to highest)
            simulationRankings.sort((a, b) => a.terminalNetWorth - b.terminalNetWorth);

            // Step 2: Identify which specific simulations represent each percentile
            const percentileSimulations = {};
            percentiles.forEach(p => {
                const index = Math.min(
                    Math.floor((p / 100) * simulationRankings.length),
                    simulationRankings.length - 1
                );
                percentileSimulations[p] = simulationRankings[index].simIdx;

                // Debug logging for median percentile
                if (p === 50) {
                    console.log(` BBD Median (50th percentile) selection:`);
                    console.log(`   Total valid simulations: ${simulationRankings.length}`);
                    console.log(`   Calculated index: ${index}`);
                    console.log(`   Formula: Math.min(Math.floor((50/100) * ${simulationRankings.length}), ${simulationRankings.length - 1})`);
                    console.log(`   Selected simulation #${simulationRankings[index].simIdx}`);
                    console.log(`   That simulation's terminal value: $${simulationRankings[index].terminalNetWorth.toLocaleString()}`);
                    console.log(`   Verification: Should match terminalStats.median from above`);
                }
            });

            // Step 3: Extract the COMPLETE PATH for each percentile simulation
            // This ensures the median line (for example) represents ONE real, coherent path
            // that an investor could actually experience
            const inflationRate = params.inflationRate || 0; // Get inflation rate from params

            // Process all period+1 data points (indices 0 to period)
            for (let yearIdx = 0; yearIdx <= period; yearIdx++) {
                percentiles.forEach(p => {
                    const simIdx = percentileSimulations[p];
                    const sim = allSimulations[simIdx];

                    // Debug logging for median percentile data extraction
                    if (p === 50 && yearIdx === 0) {
                        console.log(` Extracting data for 50th percentile (median):`);
                        console.log(`   Using simulation index: ${simIdx}`);
                        console.log(`   Simulation array length: ${sim.length}`);
                        console.log(`   First year data:`, sim[0]);
                        console.log(`   Last year data:`, sim[sim.length - 1]);
                        console.log(`   Last year netPortfolio: ${sim[sim.length - 1].netPortfolio}`);
                    }

                    // Calculate inflation adjustment factor for this year
                    const inflationFactor = Math.pow(1 + inflationRate / 100, yearIdx);

                    // Extract data from this specific simulation for this year
                    if (sim[yearIdx]) {
                        // Calculate real (inflation-adjusted) values
                        const realPortfolioValue = sim[yearIdx].portfolioValue / inflationFactor;
                        const realLocBalance = sim[yearIdx].locBalance / inflationFactor;
                        const realNetPortfolio = sim[yearIdx].netPortfolio / inflationFactor;

                        const dataPoint = {
                            year: sim[yearIdx].year,
                            portfolioValue: sim[yearIdx].portfolioValue,
                            locBalance: sim[yearIdx].locBalance,
                            netPortfolio: sim[yearIdx].netPortfolio,
                            locUsedPct: sim[yearIdx].locUsedPct,
                            realPortfolioValue: realPortfolioValue,
                            realLocBalance: realLocBalance,
                            realNetPortfolio: realNetPortfolio,
                            withdrawal: sim[yearIdx].withdrawal || 0,
                            cumulativeWithdrawal: sim[yearIdx].cumulativeWithdrawal || 0
                        };

                        // Debug logging for median percentile
                        if (p === 50 && (yearIdx === 0 || yearIdx === period - 1)) {
                            console.log(`   Year ${yearIdx} (${dataPoint.year}): netPortfolio = ${dataPoint.netPortfolio}`);
                        }

                        percentilesData[p].push(dataPoint);
                    } else {
                        // Simulation failed before this year (margin call)
                        // Use last known values or zeros
                        const lastYear = sim[sim.length - 1];
                        percentilesData[p].push({
                            year: params.startYear + yearIdx,
                            portfolioValue: 0,
                            locBalance: lastYear.locBalance,
                            netPortfolio: 0,
                            locUsedPct: 100,
                            realPortfolioValue: 0,
                            realLocBalance: lastYear.locBalance / inflationFactor,
                            realNetPortfolio: 0,
                            withdrawal: lastYear.withdrawal || 0,
                            cumulativeWithdrawal: lastYear.cumulativeWithdrawal || 0
                        });
                    }
                });
            }

            // Result: Each percentile line now represents one real simulation path
            // - 10th percentile = the complete journey of simulation X (one of the worst outcomes)
            // - 50th percentile = the complete journey of simulation Y (median outcome)
            // - 90th percentile = the complete journey of simulation Z (one of the best outcomes)
            // This matches industry standards (Vanguard, MoneyGuidePro, eMoney, etc.)

            // Calculate success rate (no margin calls + positive final net worth)
            let successfulSimulations = 0;
            let marginCallCount = 0;
            let depletionFailures = 0; // Failed due to running out of money (no margin call)
            const terminalValues = [];

            allSimulations.forEach(sim => {
                const lastYear = sim[sim.length - 1];
                terminalValues.push(lastYear.netPortfolio);

                const hasMarginCall = sim.some(year => year.marginCall);
                if (hasMarginCall) {
                    marginCallCount++;
                }

                if (!hasMarginCall && lastYear.netPortfolio > 0) {
                    successfulSimulations++;
                } else if (!hasMarginCall && lastYear.netPortfolio <= 0) {
                    depletionFailures++;
                }
            });

            const successRate = (successfulSimulations / allSimulations.length) * 100;
            const marginCallRate = (marginCallCount / allSimulations.length) * 100;
            const depletionFailureRate = (depletionFailures / allSimulations.length) * 100;

            // Terminal value statistics
            // CRITICAL: Filter BEFORE sorting to avoid NaN corruption of sort order
            // NaN comparisons always return false, breaking sort algorithms
            const validTerminalValues = terminalValues.filter(v => isFinite(v));
            const excludedCount = terminalValues.length - validTerminalValues.length;

            if (excludedCount > 0) {
                console.warn(`Monte Carlo: Excluded ${excludedCount} simulations with invalid terminal values (NaN/Infinity)`);
            }

            // Now sort the VALID values only
            validTerminalValues.sort((a, b) => a - b);

            // Calculate actual percentiles for terminal values
            const getPercentile = (arr, percentile) => {
                if (arr.length === 0) return 0;
                const index = Math.floor((percentile / 100) * arr.length);
                return arr[Math.min(index, arr.length - 1)];
            };

            const terminalStats = {
                min: validTerminalValues[0] || 0,
                max: validTerminalValues[validTerminalValues.length - 1] || 0,
                percentile10: getPercentile(validTerminalValues, 10),
                percentile25: getPercentile(validTerminalValues, 25),
                median: getPercentile(validTerminalValues, 50),
                percentile75: getPercentile(validTerminalValues, 75),
                percentile90: getPercentile(validTerminalValues, 90),
                mean: validTerminalValues.length > 0 ?
                    validTerminalValues.reduce((sum, val) => sum + val, 0) / validTerminalValues.length : 0,
                stdDev: 0,
                validCount: validTerminalValues.length,
                excludedCount: excludedCount
            };

            // Debug logging for terminal stats median calculation
            const medianIndex = Math.floor((50 / 100) * validTerminalValues.length);
            console.log(` BBD Terminal Stats Median calculation:`);
            console.log(`   Total valid terminal values: ${validTerminalValues.length}`);
            console.log(`   Median index: ${medianIndex}`);
            console.log(`   Median value: $${terminalStats.median.toLocaleString()}`);
            console.log(`   Actual element at index ${Math.min(medianIndex, validTerminalValues.length - 1)}: $${validTerminalValues[Math.min(medianIndex, validTerminalValues.length - 1)].toLocaleString()}`);

            // Calculate standard deviation only from valid values
            if (validTerminalValues.length > 0) {
                const variance = validTerminalValues.reduce((sum, val) =>
                    sum + Math.pow(val - terminalStats.mean, 2), 0) / validTerminalValues.length;
                terminalStats.stdDev = Math.sqrt(variance);
            }

            // CRITICAL VALIDATION: Ensure percentiles are monotonically non-decreasing
            // This catches bugs in percentile calculation logic
            const percentileSequence = [
                { name: '10th', value: terminalStats.percentile10 },
                { name: '25th', value: terminalStats.percentile25 },
                { name: '50th (median)', value: terminalStats.median },
                { name: '75th', value: terminalStats.percentile75 },
                { name: '90th', value: terminalStats.percentile90 }
            ];

            for (let i = 1; i < percentileSequence.length; i++) {
                if (percentileSequence[i].value < percentileSequence[i-1].value) {
                    const errorMsg = `Percentile monotonicity violation: ${percentileSequence[i-1].name} (${percentileSequence[i-1].value.toFixed(2)}) > ${percentileSequence[i].name} (${percentileSequence[i].value.toFixed(2)})`;
                    console.error('Monte Carlo Statistics Error:', errorMsg);
                    console.error('Valid terminal values count:', validTerminalValues.length);
                    console.error('Excluded count:', excludedCount);
                    throw new Error(`Data integrity error in Monte Carlo results: ${errorMsg}. This indicates a bug in the percentile calculation logic.`);
                }
            }

            // Calculate liquidity stress metrics
            const liquidityStats = aggregateLiquidityStats(allSimulations, period, {
                startYear: params.startYear,
                maxBorrowing: params.maxBorrowing / 100
            });

            // Process sell strategy simulations if available
            let sellStrategyStats = null;
            if (params.sellSimulations && params.sellSimulations.length > 0) {
                const sellSimulations = params.sellSimulations;

                // Calculate sell strategy failure metrics
                let sellFailureCount = 0;
                let sellSuccessCount = 0;
                const sellFailureYears = [];
                const sellFailureReasons = { portfolio_depleted: 0, numerical_instability: 0 };

                sellSimulations.forEach(sellSim => {
                    if (sellSim.failed) {
                        sellFailureCount++;
                        if (sellSim.failureYear) sellFailureYears.push(sellSim.failureYear);
                        if (sellSim.failureReason && sellFailureReasons.hasOwnProperty(sellSim.failureReason)) {
                            sellFailureReasons[sellSim.failureReason]++;
                        }
                    } else if (sellSim.finalNetWorth > 0) {
                        sellSuccessCount++;
                    } else {
                        // Terminal value is zero or negative but wasn't marked failed during simulation
                        sellFailureCount++;
                    }
                });

                const sellSuccessRate = (sellSuccessCount / sellSimulations.length) * 100;
                const sellFailureRate = (sellFailureCount / sellSimulations.length) * 100;

                // Calculate average failure year (for failed simulations)
                const avgFailureYear = sellFailureYears.length > 0
                    ? sellFailureYears.reduce((a, b) => a + b, 0) / sellFailureYears.length
                    : null;

                // Rank sell simulations by terminal net worth
                const sellRankings = sellSimulations.map((sellSim, idx) => ({
                    simIdx: idx,
                    terminalNetWorth: sellSim.finalNetWorth,
                    totalTaxesPaid: sellSim.totalTaxesPaid,
                    simulation: sellSim
                }))
                // CRITICAL: Filter out invalid terminal values (NaN, Infinity) BEFORE sorting
                // This ensures percentile paths match the sellStrategyStats percentiles
                .filter(ranking => isFinite(ranking.terminalNetWorth));

                sellRankings.sort((a, b) => a.terminalNetWorth - b.terminalNetWorth);

                // Extract percentile simulations for sell strategy
                const sellPercentileSimulations = {};
                const sellPercentilesData = {};
                percentiles.forEach(p => {
                    const index = Math.min(
                        Math.floor((p / 100) * sellRankings.length),
                        sellRankings.length - 1
                    );
                    sellPercentileSimulations[p] = sellRankings[index]?.simIdx ?? 0;
                    sellPercentilesData[p] = [];
                });

                // Build sell percentiles data paths
                // Process all period+1 data points (indices 0 to period)
                for (let yearIdx = 0; yearIdx <= period; yearIdx++) {
                    const inflationFactor = Math.pow(1 + inflationRate / 100, yearIdx);

                    percentiles.forEach(p => {
                        const simIdx = sellPercentileSimulations[p];
                        const sellSim = sellSimulations[simIdx];

                        if (sellSim && sellSim.results[yearIdx]) {
                            const yearData = sellSim.results[yearIdx];
                            sellPercentilesData[p].push({
                                year: yearData.year,
                                portfolioValue: yearData.portfolioValue,
                                netWorth: yearData.netWorth,
                                totalTaxesPaid: yearData.totalTaxesPaid,
                                capitalGainsTax: yearData.capitalGainsTax,
                                dividendTax: yearData.dividendTax,
                                realNetWorth: yearData.netWorth / inflationFactor,
                                // Include failure and shortfall info
                                failed: yearData.failed,
                                withdrawalShortfall: yearData.withdrawalShortfall || 0
                            });
                        }
                    });
                }

                // Calculate sell strategy terminal statistics
                const sellTerminalValues = sellSimulations.map(s => s.finalNetWorth).filter(v => isFinite(v));
                sellTerminalValues.sort((a, b) => a - b);

                const sellTerminalStats = {
                    min: sellTerminalValues[0] || 0,
                    max: sellTerminalValues[sellTerminalValues.length - 1] || 0,
                    percentile10: getPercentile(sellTerminalValues, 10),
                    percentile25: getPercentile(sellTerminalValues, 25),
                    median: getPercentile(sellTerminalValues, 50),
                    percentile75: getPercentile(sellTerminalValues, 75),
                    percentile90: getPercentile(sellTerminalValues, 90),
                    mean: sellTerminalValues.reduce((sum, val) => sum + val, 0) / sellTerminalValues.length
                };

                // Calculate tax statistics
                const totalTaxesPaidArray = sellSimulations.map(s => s.totalTaxesPaid);
                const avgTaxesPaid = totalTaxesPaidArray.reduce((sum, val) => sum + val, 0) / totalTaxesPaidArray.length;
                const medianTaxesPaid = getPercentile(totalTaxesPaidArray.sort((a, b) => a - b), 50);

                // Calculate withdrawal shortfall statistics
                const totalShortfalls = sellSimulations.map(s => s.totalWithdrawalShortfall || 0);
                const simulationsWithShortfall = totalShortfalls.filter(s => s > 0).length;
                const shortfallRate = (simulationsWithShortfall / sellSimulations.length) * 100;

                sellStrategyStats = {
                    percentilesData: sellPercentilesData,
                    terminalStats: sellTerminalStats,
                    avgTaxesPaid: avgTaxesPaid,
                    medianTaxesPaid: medianTaxesPaid,
                    percentileTaxes: {
                        p10: sellSimulations[sellPercentileSimulations[10]]?.totalTaxesPaid ?? 0,
                        p25: sellSimulations[sellPercentileSimulations[25]]?.totalTaxesPaid ?? 0,
                        p50: sellSimulations[sellPercentileSimulations[50]]?.totalTaxesPaid ?? 0,
                        p75: sellSimulations[sellPercentileSimulations[75]]?.totalTaxesPaid ?? 0,
                        p90: sellSimulations[sellPercentileSimulations[90]]?.totalTaxesPaid ?? 0
                    },
                    // Success/failure metrics
                    successRate: sellSuccessRate,
                    failureRate: sellFailureRate,
                    failureCount: sellFailureCount,
                    avgFailureYear: avgFailureYear,
                    failureReasons: sellFailureReasons,
                    shortfallRate: shortfallRate,
                    simulationsWithShortfall: simulationsWithShortfall
                };

                // Log sell strategy statistics for debugging
                console.log(' Sell Assets Strategy Statistics:');
                console.log(`   Success Rate: ${sellSuccessRate.toFixed(1)}%`);
                console.log(`   Failure Rate: ${sellFailureRate.toFixed(1)}%`);
                console.log(`   Failure Count: ${sellFailureCount} / ${sellSimulations.length}`);
                if (avgFailureYear) {
                    console.log(`   Avg Failure Year: ${avgFailureYear.toFixed(1)}`);
                }
                console.log(`   Failure Reasons:`, sellFailureReasons);
                console.log(`   Shortfall Rate: ${shortfallRate.toFixed(1)}%`);
            }

            // Calculate BBD dividend tax statistics
            const bbdDividendTaxes = params.bbdDividendTaxes || [];
            const validBBDDividendTaxes = bbdDividendTaxes.filter(tax => isFinite(tax));
            const sortedBBDDividendTaxes = [...validBBDDividendTaxes].sort((a, b) => a - b);
            const medianBBDDividendTax = sortedBBDDividendTaxes.length > 0
                ? getPercentile(sortedBBDDividendTaxes, 50)
                : 0;

            return {
                allSimulations,
                percentilesData,
                successRate,
                marginCallRate,
                depletionFailureRate,
                terminalStats,
                terminalValues,
                assetNames,
                params,
                liquidityStats,
                sellStrategyStats,  // Add sell strategy statistics
                medianBBDDividendTax  // Add BBD dividend tax median
            };
        }

        // Analyze results and generate warnings
        function analyzeResults(mcResults, params) {
            const warnings = [];
            const { terminalStats, successRate, marginCallRate } = mcResults;

            // Calculate implied CAGR from median result
            // Note: CAGR is mathematically undefined for negative terminal wealth
            const years = params.period;
            const startValue = params.startValue;
            const medianFinal = terminalStats.median;
            const impliedCAGR = (medianFinal > 0 && startValue > 0) ?
                (Math.pow(medianFinal / startValue, 1/years) - 1) * 100 :
                null; // null indicates undefined/not applicable

            // Warning 1: Unrealistic CAGR (context-aware based on active model)
            const returnModel = params.returnModel || 'bootstrap';

            if (impliedCAGR !== null && impliedCAGR > 15) {
                let suggestion = '';

                if (returnModel === 'bootstrap') {
                    suggestion = 'Try using "Regime-Switching" or "Fat-Tailed Distribution" for more realistic results.';
                } else if (returnModel === 'regime') {
                    suggestion = 'Your portfolio shows very high growth. This could mean: (1) your stocks spend most time going up, (2) you own exceptionally high-growth companies, or (3) your portfolio mix is optimistic. Try "Fat-Tailed Distribution" for more conservative modeling, or add more diversification (bonds, value stocks, or increase S&P 500 to 50%+).';
                } else if (returnModel === 'fat-tail') {
                    suggestion = 'You\'re using the most conservative model available, yet growth is still very high. This suggests your portfolio may be heavily concentrated in exceptional growth stocks. Consider adding bonds or value stocks, increasing S&P 500 to 40%+, or reducing your planned withdrawals.';
                }

                warnings.push({
                    type: 'critical',
                    title: 'Growth Rate Looks Too High',
                    message: `Your results show ${impliedCAGR.toFixed(1)}% annual growth. This is much higher than the stock market's typical 10% long-term average. ${suggestion}`
                });
            } else if (impliedCAGR !== null && impliedCAGR > 12) {
                let suggestion = '';

                if (returnModel === 'bootstrap') {
                    suggestion = ' Try "Regime-Switching" or "Fat-Tailed Distribution" for more conservative estimates.';
                } else if (returnModel === 'regime') {
                    suggestion = ' This growth rate is reasonable but higher than the S&P 500\'s historical average. Your portfolio may be concentrated in growth stocks.';
                } else if (returnModel === 'fat-tail') {
                    suggestion = ' This growth rate is within reasonable bounds for a growth-focused portfolio, but it\'s still above typical market averages.';
                }

                warnings.push({
                    type: 'warning',
                    title: 'Above-Average Growth Rate',
                    message: `Your results show ${impliedCAGR.toFixed(1)}% annual growth, which is higher than the typical 8-10% long-term market average. While possible, this may be optimistic.${suggestion}`
                });
            }

            // Warning 2: Very high success rate with aggressive borrowing
            const initialLTV = params.maxBorrowing > 50 ? 'aggressive' : 'moderate';
            if (successRate > 90 && initialLTV === 'aggressive') {
                warnings.push({
                    type: 'warning',
                    title: 'Success Rate May Be Optimistic',
                    message: `A ${successRate.toFixed(1)}% success rate with ${params.maxBorrowing}% max borrowing seems optimistic. Real-world sequence risk, correlation spikes during crises, and model limitations may result in lower actual success rates.`
                });
            }

            // Warning 3: Low diversification
            if (mcResults.assetNames.length < 5) {
                warnings.push({
                    type: 'warning',
                    title: 'Concentration Risk',
                    message: `Your portfolio contains only ${mcResults.assetNames.length} asset${mcResults.assetNames.length === 1 ? '' : 's'}. Individual stock risk is high. During market crises, concentrated portfolios experience higher volatility and margin call risk. Consider adding more assets or using a broad index fund.`
                });
            }

            // Warning 4: High margin call rate
            if (marginCallRate > 20) {
                warnings.push({
                    type: 'critical',
                    title: 'High Margin Call Risk',
                    message: `${marginCallRate.toFixed(1)}% of simulations triggered margin calls. This indicates significant risk of forced liquidation during market downturns. Consider reducing withdrawal amounts, lowering max LTV, or increasing starting capital.`
                });
            } else if (marginCallRate > 10) {
                warnings.push({
                    type: 'warning',
                    title: 'Elevated Margin Call Risk',
                    message: `${marginCallRate.toFixed(1)}% of simulations experienced margin calls. While manageable, this suggests notable sequence risk if markets decline early in retirement.`
                });
            }

            // Info: Model being used
            const returnModelName = params.returnModel || 'bootstrap';
            // Get regime mode for dynamic description
            const currentRegimeMode = typeof getRegimeMode === 'function' ? getRegimeMode() : 'conservative';
            const isHistoricalMode = currentRegimeMode === 'historical';

            const modelDescriptions = {
                'bootstrap': {
                    short: 'Historical Bootstrap',
                    explanation: 'Randomly samples from actual historical returns to build future scenarios.',
                    how: 'Takes real monthly returns from your selected assets and shuffles them like a deck of cards to create thousands of possible futures.',
                    when: 'Best for: Moderate risk tolerance. Assumes the future will be similar to the past.',
                    caveat: 'Limitation: May include survivorship bias from historically high-performing periods and doesn\'t account for regime changes or extreme events.'
                },
                'regime': {
                    short: isHistoricalMode
                        ? 'Regime-Switching (Bull/Bear/Crash/Recovery)   Historical Mode'
                        : 'Regime-Switching (Bull/Bear/Crash/Recovery)   Conservative Mode',
                    explanation: 'Models distinct market regimes including bull markets, bear markets, acute crashes, and recovery phases.',
                    how: isHistoricalMode
                        ? 'Markets transition between four states using a Markov chain calibrated to historical S&P 500 data (1950-2024). Bull markets average 9 years, bear markets 1.8 years, crashes last ~1 year with quick recovery, and recoveries bridge back to normal.'
                        : 'Markets transition between four states using stress-testing parameters. Bull markets average 9 years, bear markets 1.8 years, crashes are extended (~1.5 years) with slower recovery, modeling worst-case scenarios.',
                    when: isHistoricalMode
                        ? 'Best for: Baseline retirement planning. Uses realistic parameters calibrated to historical market data.'
                        : 'Best for: Stress-testing and worst-case analysis. Extended crash durations test strategy resilience.',
                    caveat: isHistoricalMode
                        ? 'Note: Calibrated to historical data with ~15-18% probability of loss over 30 years. More nuanced than bootstrap as it explicitly models regime persistence and safe-haven asset behavior.'
                        : 'Note: Conservative parameters with ~36% probability of loss over 30 years. Use this to stress-test your strategy against prolonged market downturns.'
                },
                'fat-tail': {
                    short: 'Fat-Tailed Distribution',
                    explanation: 'Accounts for extreme market events (crashes and rallies) that happen more often than normal distributions predict.',
                    how: 'Uses statistical distributions that allow for rare but severe market moves (like 2008 or March 2020) that are underrepresented in historical data.',
                    when: 'Best for: Conservative planning and stress-testing. Want to prepare for worst-case scenarios.',
                    caveat: 'Warning: This model will show more extreme outcomes (both positive and negative), resulting in wider ranges and potentially lower success rates.'
                }
            };

            const modelInfo = modelDescriptions[returnModelName];
            const detailedMessage = `
                <strong>${modelInfo.explanation}</strong><br>
                <strong>How it works:</strong> ${modelInfo.how}<br>
                <strong>When to use:</strong> ${modelInfo.when}<br>
                <em>${modelInfo.caveat}</em>
            `;

            warnings.push({
                type: 'info',
                title: `Return Model: ${modelInfo.short}`,
                message: detailedMessage
            });

            return { warnings, impliedCAGR };
        }

        // Calculate Time-Weighted Rate of Return (TWRR) for a percentile path
        function calculateTWRR(percentilePath, useReal = false) {
            if (!percentilePath || percentilePath.length < 2) return 0;

            let product = 1;
            const valueKey = useReal ? 'realPortfolioValue' : 'portfolioValue';

            for (let i = 1; i < percentilePath.length; i++) {
                const prevValue = percentilePath[i-1][valueKey];
                const currValue = percentilePath[i][valueKey];

                if (prevValue > 0) {
                    const periodReturn = (currValue - prevValue) / prevValue;
                    product *= (1 + periodReturn);
                }
            }

            const years = percentilePath.length - 1;
            if (years <= 0) return 0;

            const twrr = (Math.pow(product, 1/years) - 1) * 100;
            return twrr;
        }

        // Calculate Annual Mean Return for a percentile path
        function calculateAnnualMeanReturn(percentilePath, useReal = false) {
            if (!percentilePath || percentilePath.length < 2) return 0;

            let returns = [];
            const valueKey = useReal ? 'realPortfolioValue' : 'portfolioValue';

            for (let i = 1; i < percentilePath.length; i++) {
                const prevValue = percentilePath[i-1][valueKey];
                const currValue = percentilePath[i][valueKey];

                if (prevValue > 0) {
                    const periodReturn = ((currValue - prevValue) / prevValue) * 100;
                    returns.push(periodReturn);
                }
            }

            if (returns.length === 0) return 0;
            const meanReturn = returns.reduce((sum, r) => sum + r, 0) / returns.length;
            return meanReturn;
        }

        // Calculate Annualized Volatility for a percentile path
        function calculateAnnualizedVolatility(percentilePath, useReal = false) {
            if (!percentilePath || percentilePath.length < 2) return 0;

            let returns = [];
            const valueKey = useReal ? 'realPortfolioValue' : 'portfolioValue';

            for (let i = 1; i < percentilePath.length; i++) {
                const prevValue = percentilePath[i-1][valueKey];
                const currValue = percentilePath[i][valueKey];

                if (prevValue > 0) {
                    const periodReturn = ((currValue - prevValue) / prevValue) * 100;
                    returns.push(periodReturn);
                }
            }

            if (returns.length === 0) return 0;

            const meanReturn = returns.reduce((sum, r) => sum + r, 0) / returns.length;
            const variance = returns.reduce((sum, r) => sum + Math.pow(r - meanReturn, 2), 0) / returns.length;
            const volatility = Math.sqrt(variance);
            return volatility;
        }

        // Calculate Performance Summary for all percentiles
        function calculatePerformanceSummary(percentilesData) {
            const percentiles = [10, 25, 50, 75, 90];
            const performanceSummary = {};

            percentiles.forEach(p => {
                const path = percentilesData[p];
                if (!path || path.length === 0) {
                    performanceSummary[p] = {
                        twrrNominal: 0,
                        twrrReal: 0,
                        endBalanceNominal: 0,
                        endBalanceReal: 0,
                        annualMeanReturnNominal: 0,
                        annualizedVolatility: 0
                    };
                    return;
                }

                const lastYear = path[path.length - 1];

                performanceSummary[p] = {
                    twrrNominal: calculateTWRR(path, false),
                    twrrReal: calculateTWRR(path, true),
                    endBalanceNominal: lastYear.portfolioValue || 0,
                    endBalanceReal: lastYear.realPortfolioValue || 0,
                    annualMeanReturnNominal: calculateAnnualMeanReturn(path, false),
                    annualizedVolatility: calculateAnnualizedVolatility(path, false)
                };
            });

            return performanceSummary;
        }

        // Calculate per-asset statistics (expected return and volatility)
        function calculateAssetStatistics(assetNames) {
            const assetStats = {};

            assetNames.forEach(assetName => {
                const returns = getAssetHistoricalReturns(assetName);

                if (returns.length === 0) {
                    assetStats[assetName] = {
                        expectedReturn: 0,
                        volatility: 0,
                        dataPoints: 0
                    };
                    return;
                }

                // Calculate mean return
                const returnValues = returns.map(r => r.return);
                const meanReturn = returnValues.reduce((sum, r) => sum + r, 0) / returnValues.length;

                // Calculate standard deviation (volatility)
                const variance = returnValues.reduce((sum, r) => sum + Math.pow(r - meanReturn, 2), 0) / returnValues.length;
                const volatility = Math.sqrt(variance);

                assetStats[assetName] = {
                    expectedReturn: meanReturn,
                    volatility: volatility,
                    dataPoints: returns.length
                };
            });

            return assetStats;
        }

        // Calculate correlation matrix for all assets
        function calculateCorrelationMatrix(assetNames) {
            const correlationMatrix = {};
            const assetReturns = {};

            // Get historical returns for all assets
            assetNames.forEach(assetName => {
                assetReturns[assetName] = getAssetHistoricalReturns(assetName);
            });

            // Calculate pairwise correlations
            assetNames.forEach(asset1 => {
                correlationMatrix[asset1] = {};
                assetNames.forEach(asset2 => {
                    if (asset1 === asset2) {
                        correlationMatrix[asset1][asset2] = 1.0;
                    } else {
                        const corr = calculateCorrelation(assetReturns[asset1], assetReturns[asset2]);
                        correlationMatrix[asset1][asset2] = corr;
                    }
                });
            });

            return correlationMatrix;
        }

        // Calculate expected returns over different time horizons using compound growth
        function calculateMultiHorizonReturns(percentilesData, params) {
            const horizons = [1, 3, 5, 10, 15];
            const percentiles = [10, 25, 50, 75, 90];
            const horizonReturns = {};

            percentiles.forEach(p => {
                horizonReturns[p] = {};
                const path = percentilesData[p];

                horizons.forEach(horizon => {
                    if (horizon > path.length - 1) {
                        // If simulation period is shorter than horizon, return null
                        // For a period of N years, we have indices 0 to N, so we can calculate up to N-year horizon
                        horizonReturns[p][horizon] = null;
                        return;
                    }

                    // Calculate CAGR over the specific horizon
                    const startValue = path[0].portfolioValue;
                    const endValue = path[horizon].portfolioValue;

                    if (startValue <= 0) {
                        horizonReturns[p][horizon] = 0;
                        return;
                    }

                    const cagr = (Math.pow(endValue / startValue, 1 / horizon) - 1) * 100;
                    horizonReturns[p][horizon] = cagr;
                });
            });

            return horizonReturns;
        }

        // Calculate probability of achieving various return thresholds over different time horizons
        function calculateReturnProbabilities(allSimulations, params) {
            const horizons = [1, 3, 5, 10, 15];
            const thresholds = [0, 2.5, 5.0, 7.5, 10.0, 12.5]; // Return thresholds in %
            const probabilities = {};

            thresholds.forEach(threshold => {
                probabilities[threshold] = {};

                horizons.forEach(horizon => {
                    if (horizon > params.period) {
                        // Cannot calculate horizon that exceeds period length
                        // For a period of N years, we have indices 0 to N, so we can calculate up to N-year horizon
                        probabilities[threshold][horizon] = null;
                        return;
                    }

                    let successCount = 0;
                    let validSimulations = 0;

                    allSimulations.forEach(sim => {
                        if (sim.length > horizon) {
                            const startValue = sim[0].portfolioValue;
                            const endValue = sim[horizon].portfolioValue;

                            if (startValue > 0) {
                                validSimulations++;
                                const cagr = (Math.pow(endValue / startValue, 1 / horizon) - 1) * 100;
                                if (cagr >= threshold) {
                                    successCount++;
                                }
                            }
                        }
                    });

                    probabilities[threshold][horizon] = validSimulations > 0
                        ? (successCount / validSimulations) * 100
                        : 0;
                });
            });

            return probabilities;
        }

        // Display Monte Carlo simulation results
        function displayMonteCarloResults(mcResults) {
            // Store results globally for theme updates
            currentMonteCarloResults = mcResults;
            currentMonteCarloPercentilesData = mcResults.percentilesData;
            currentMonteCarloParams = mcResults.params;

            // Hide empty state and show results section
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('results').style.display = 'block';

            // Hide back to results button when viewing results
            hideBackToResultsButton();

            const { percentilesData, successRate, marginCallRate, terminalStats, assetNames, params, sellStrategyStats, liquidityStats } = mcResults;
            const medianPath = percentilesData[50];

            // Extract sell strategy data for card comparison
            const sellSuccessRate = sellStrategyStats?.successRate ?? null;
            const successAdvantage = sellSuccessRate !== null ? (successRate - sellSuccessRate).toFixed(1) : null;

            // Extract sell terminal values for Portfolio Growth card comparison
            const sellTerminalMedian = sellStrategyStats?.terminalStats?.median ?? null;
            const terminalValueDiff = sellTerminalMedian !== null ? terminalStats.median - sellTerminalMedian : null;
            const terminalValueAdvantagePercent = sellTerminalMedian !== null && sellTerminalMedian > 0
                ? ((terminalValueDiff / sellTerminalMedian) * 100).toFixed(1)
                : null;

            // Extract liquidity stats for card footer
            const p90LocUtilization = liquidityStats?.p90LocUtilization ?? null;
            const p10SafetyBuffer = liquidityStats?.p10SafetyBuffer ?? null;
            const mostDangerousYear = liquidityStats?.mostDangerousYear ?? null;
            const medianLocUtilization = liquidityStats?.medianLocUtilization ?? null;
            const highRiskYears = liquidityStats?.highRiskYears ?? 0;
            const highRiskYearsPct = liquidityStats?.highRiskYearsPct ?? 0;

            // Extract failure breakdown
            const depletionFailureRate = mcResults.depletionFailureRate ?? 0;

            // Calculate median portfolio CAGR from actual simulation results
            let medianPortfolioCAGR = 0.10; // Default fallback
            if (medianPath && medianPath.length > 0) {
                const startPortfolio = medianPath[0].portfolioValue;
                const endPortfolio = medianPath[medianPath.length - 1].portfolioValue;
                const years = medianPath.length;
                if (startPortfolio > 0 && endPortfolio > 0) {
                    medianPortfolioCAGR = Math.pow(endPortfolio / startPortfolio, 1 / years) - 1;
                }
                console.log(` Median Portfolio CAGR Calculation:`);
                console.log(`   Start Portfolio: $${startPortfolio.toLocaleString()}`);
                console.log(`   End Portfolio: $${endPortfolio.toLocaleString()}`);
                console.log(`   Years: ${years}`);
                console.log(`   Calculated CAGR: ${(medianPortfolioCAGR * 100).toFixed(2)}%`);
            }

            // ISSUE 5 FIX: Use actual median simulation LOC balance instead of theoretical calculation
            // This ensures "Planned Debt" matches what actually happens in the median simulation path
            let plannedDebt = 0;
            if (medianPath && medianPath.length > 0) {
                plannedDebt = medianPath[medianPath.length - 1].locBalance;
                console.log(` Planned Debt (from Median Simulation):`);
                console.log(`   Final LOC Balance: $${plannedDebt.toLocaleString()}`);
            } else {
                // Fallback to theoretical calculation if median path unavailable
                plannedDebt = calculateTheoreticalDebt({
                    ...params,
                    medianPortfolioCAGR: medianPortfolioCAGR
                });
                console.log(` Planned Debt (Theoretical Fallback):`);
                console.log(`   Using CAGR: ${(medianPortfolioCAGR * 100).toFixed(2)}%`);
                console.log(`   Calculated Planned Debt: $${plannedDebt.toLocaleString()}`);
            }

            // Analyze results and generate warnings
            const analysis = analyzeResults(mcResults, params);
            const { warnings, impliedCAGR } = analysis;

            // Determine CSS classes for dynamic styling
            const successClass = successRate >= 80 ? 'success-excellent' :
                                successRate >= 50 ? 'success-moderate' : 'success-poor';

            const cagrClass = impliedCAGR === null ? 'cagr-undefined' :
                             impliedCAGR > 15 ? 'cagr-high' :
                             impliedCAGR > 8 ? 'cagr-good' : 'cagr-excellent';

            const marginClass = marginCallRate < 20 ? 'margin-low' :
                               marginCallRate < 40 ? 'margin-moderate' : 'margin-high';

            // Check if escape velocity is unlocked
            const showEscapeVelocityBanner = successRate >= 80;

            // Check if encouragement banner should be shown
            const showEncouragementBanner = successRate < 80;

            // Display all portfolio assets as chips with color coding matching weight bar
            const assetsPreview = assetNames.map((name, index) => {
                const colorIndex = index % ASSET_COLORS.length;
                const bgColor = ASSET_COLORS[colorIndex];
                return `<span class="asset-chip" style="background-color: ${bgColor}; color: white;">${name}</span>`;
            }).join('');

            // Create weight distribution bar for portfolio (legacy - kept for compatibility)
            const totalWeight = assetNames.reduce((sum, name) => sum + selectedPortfolioAssets[name], 0);
            const portfolioWeightBar = assetNames.map((name, index) => {
                const weight = selectedPortfolioAssets[name];
                const widthPercent = (weight / totalWeight) * 100;
                const colorIndex = index % ASSET_COLORS.length;
                const bgColor = ASSET_COLORS[colorIndex];

                // Smart label logic based on segment width
                let label = '';
                if (widthPercent < 8) {
                    label = `${weight.toFixed(1)}%`;
                } else if (widthPercent < 15) {
                    label = `${name.substring(0, 8)} ${weight.toFixed(1)}%`;
                } else {
                    label = `${name} ${weight.toFixed(1)}%`;
                }

                return `<div class="weight-segment" style="width: ${widthPercent}%; background-color: ${bgColor};">${label}</div>`;
            }).join('');

            const portfolioWeightBarHTML = `<div class="portfolio-weight-bar">${portfolioWeightBar}</div>`;

            // Create donut chart conic-gradient and legend for new design
            // Sort assets by weight (descending) for better visualization
            const sortedAssets = assetNames
                .map((name, index) => ({
                    name,
                    weight: selectedPortfolioAssets[name],
                    percent: (selectedPortfolioAssets[name] / totalWeight) * 100,
                    color: ASSET_COLORS[index % ASSET_COLORS.length]
                }))
                .sort((a, b) => b.weight - a.weight);

            // Build conic-gradient stops for donut chart
            let currentAngle = 0;
            const gradientStops = sortedAssets.map(asset => {
                const startAngle = currentAngle;
                const endAngle = currentAngle + (asset.percent / 100) * 360;
                currentAngle = endAngle;
                return `${asset.color} ${startAngle}deg ${endAngle}deg`;
            }).join(', ');

            const donutGradient = `conic-gradient(from 0deg, ${gradientStops})`;

            // Create legend items with progress bar fill
            // Bar width is relative to the largest holding (largest = 100% fill)
            const maxPercent = sortedAssets.length > 0 ? sortedAssets[0].percent : 100;
            const portfolioLegendItems = sortedAssets.map(asset => {
                const barWidth = (asset.percent / maxPercent) * 100;
                return `
                <div class="portfolio-legend-item">
                    <div class="portfolio-legend-bar" style="background-color: ${asset.color}; width: ${barWidth}%;"></div>
                    <div class="portfolio-legend-color" style="background-color: ${asset.color};"></div>
                    <div class="portfolio-legend-name">${asset.name}</div>
                    <div class="portfolio-legend-percent">${asset.percent.toFixed(1)}%</div>
                </div>
            `}).join('');

            // Determine overall status - aligned with Escape Velocity threshold (successRate >= 80)
            // NOTE: Moved here to be available for keyMetricsHTML generation
            const getOverallStatus = () => {
                if (successRate >= 80) return 'green';  // Escape Velocity Unlocked threshold
                if (successRate >= 60) return 'yellow';
                return 'red';
            };
            const overallStatus = getOverallStatus();

            // Get status banner content - moved here for keyMetricsHTML integration
            const getStatusBannerContent = () => {
                if (overallStatus === 'green') {
                    let message = `Your ${params.period}-year strategy shows strong fundamentals with ${successRate.toFixed(1)}% success rate.`;
                    if (marginCallRate > 10) {
                        message += ` Note: ${marginCallRate.toFixed(1)}% margin call probability - consider a cash buffer.`;
                    }
                    return {
                        icon: 'check_circle',
                        title: 'Strategy On Track',
                        message: message
                    };
                } else if (overallStatus === 'yellow') {
                    let message = `${successRate.toFixed(1)}% success rate is below 80% target.`;
                    if (marginCallRate > 10) {
                        message += ` ${marginCallRate.toFixed(1)}% margin call probability adds risk.`;
                    }
                    message += ` Consider reducing withdrawals or adjusting leverage.`;
                    return {
                        icon: 'warning',
                        title: 'Monitor Closely',
                        message: message
                    };
                } else {
                    return {
                        icon: 'error',
                        title: 'Needs Attention',
                        message: `High risk detected: ${successRate.toFixed(1)}% success rate with ${marginCallRate.toFixed(1)}% margin call probability. Significant adjustments recommended.`
                    };
                }
            };
            const statusBanner = getStatusBannerContent();

            // Create Monte Carlo specific summary with new grouped layout
            const keyMetricsHTML = `
                ${showEscapeVelocityBanner ? `
                <div class="escape-velocity-banner">
                    <div class="escape-velocity-content">
                        <div class="flex-center-justify">
                            <span class="escape-velocity-emoji"></span>
                            <p class="escape-velocity-text">Escape Velocity Unlocked!</p>
                        </div>
                    </div>
                </div>
                ` : ''}
                ${showEncouragementBanner ? `
                <div class="encouragement-banner">
                    <div class="encouragement-content">
                        <div class="flex-center-justify">
                            <span class="encouragement-emoji"></span>
                            <p class="encouragement-text">Not ready yet, but keep it going!</p>
                        </div>
                    </div>
                </div>
                ` : ''}

                <!-- Integrated Status Banner -->
                <div class="guardrails-status-banner status-${overallStatus}" id="section-status-banner">
                    <div class="status-icon-container">
                        <span class="material-icons">${statusBanner.icon}</span>
                    </div>
                    <div class="status-content">
                        <h2 class="status-title">${statusBanner.title}</h2>
                        <p class="status-message">${statusBanner.message}</p>
                    </div>
                </div>

                <!-- Tier 1: Hero Metrics (Guardrails Style) -->
                <div class="hero-metrics-row">
                    <!-- Card 1: Strategy Success -->
                    <div class="hero-metric-card ${successClass}">
                        <div class="card-header">
                            <div class="card-title-group">
                                <h4 class="card-title">Strategy Success</h4>
                                <p class="card-subtitle">BBD SUCCESS RATE</p>
                            </div>
                            <div class="card-status-badge">
                                <span class="material-icons">${successRate >= 80 ? 'check_circle' : successRate >= 50 ? 'warning' : 'error'}</span>
                            </div>
                        </div>
                        <div class="card-metrics">
                            <div class="metric-primary">
                                <span class="metric-value">${successRate.toFixed(1)}</span>
                                <span class="metric-suffix">%</span>
                            </div>
                            <p class="metric-label">Probability of Success</p>
                            ${sellSuccessRate !== null ? `
                            <div class="metric-secondary">
                                <div class="secondary-item">
                                    <span class="secondary-value ${parseFloat(successAdvantage) >= 0 ? 'positive' : 'negative'}">${successAdvantage}</span>
                                    <span class="secondary-label">vs Sell Assets</span>
                                </div>
                                <div class="secondary-item">
                                    <span class="secondary-value">${sellSuccessRate.toFixed(1)}%</span>
                                    <span class="secondary-label">Sell Success Rate</span>
                                </div>
                            </div>
                            <div class="metric-secondary">
                                <div class="secondary-item">
                                    <span class="secondary-value">${medianLocUtilization !== null ? medianLocUtilization.toFixed(1) + '%' : '--'}</span>
                                    <span class="secondary-label">Median Utilization</span>
                                </div>
                                <div class="secondary-item">
                                    <span class="secondary-value">${highRiskYearsPct.toFixed(1)}%</span>
                                    <span class="secondary-label">Years Above 70%</span>
                                </div>
                            </div>
                            ` : `
                            <div class="metric-secondary">
                                <div class="secondary-item">
                                    <span class="secondary-value">${terminalStats.percentile10 >= 0 ? formatCurrency(terminalStats.percentile10) : '$0'}</span>
                                    <span class="secondary-label">P10 Net Worth</span>
                                </div>
                                <div class="secondary-item">
                                    <span class="secondary-value">${formatCurrency(terminalStats.median)}</span>
                                    <span class="secondary-label">P50 Net Worth</span>
                                </div>
                            </div>
                            <div class="metric-secondary">
                                <div class="secondary-item">
                                    <span class="secondary-value">${medianLocUtilization !== null ? medianLocUtilization.toFixed(1) + '%' : '--'}</span>
                                    <span class="secondary-label">Median Utilization</span>
                                </div>
                                <div class="secondary-item">
                                    <span class="secondary-value">${highRiskYearsPct.toFixed(1)}%</span>
                                    <span class="secondary-label">Years Above 70%</span>
                                </div>
                            </div>
                            `}
                        </div>
                        <div class="worst-case">
                            <span class="material-icons worst-case-icon">${successRate >= 80 ? 'trending_up' : 'schedule'}</span>
                            <span class="worst-case-text">${successRate >= 80
                                ? `Target: <span class="worst-case-value" style="color: #10B981;">80%</span> exceeded`
                                : `Target: 80%  Gap: <span class="worst-case-value">${(80 - successRate).toFixed(1)}%</span>`}</span>
                        </div>
                    </div>

                    <!-- Card 2: Portfolio Growth -->
                    <div class="hero-metric-card ${cagrClass}">
                        <div class="card-header">
                            <div class="card-title-group">
                                <h4 class="card-title">Portfolio Growth${impliedCAGR !== null && impliedCAGR > 15 ? ' <span class="high-growth-badge">HIGH GROWTH</span>' : ''}</h4>
                                <p class="card-subtitle">IMPLIED CAGR (MEDIAN)</p>
                            </div>
                            <div class="card-status-badge" ${impliedCAGR !== null && impliedCAGR > 15 ? `title="High Growth Portfolio: CAGR above 15% is exceptional. Historical stock market averages ~10% annually. High projections may reflect survivorship bias or concentrated positions in past winners. Consider diversifying or stress-testing with conservative assumptions."` : ''}>
                                <span class="material-icons">${impliedCAGR === null ? 'help_outline' : impliedCAGR > 15 ? 'trending_up' : 'trending_down'}</span>
                            </div>
                        </div>
                        <div class="card-metrics">
                            <div class="metric-primary">
                                <span class="metric-value">${impliedCAGR === null ? 'n/a' : impliedCAGR.toFixed(1)}</span>
                                ${impliedCAGR !== null ? '<span class="metric-suffix">%</span>' : ''}
                            </div>
                            <p class="metric-label">Compound Annual Growth Rate${impliedCAGR !== null && impliedCAGR > 15 ? ' <span class="material-icons cagr-info-icon" title="High Growth: CAGR above 15% is exceptional. Historical stock market averages ~10% annually. High projections may reflect survivorship bias or concentrated growth stock positions.">info_outline</span>' : ''}</p>
                            <div class="metric-secondary">
                                <div class="secondary-item">
                                    <span class="secondary-value">${formatCurrency(params.startValue)}</span>
                                    <span class="secondary-label">Starting Value</span>
                                </div>
                                <div class="secondary-item">
                                    <span class="secondary-value">${formatCurrency(terminalStats.median)}</span>
                                    <span class="secondary-label">Median Terminal</span>
                                </div>
                            </div>
                            ${sellTerminalMedian !== null ? `
                            <div class="metric-secondary">
                                <div class="secondary-item">
                                    <span class="secondary-value ${terminalValueDiff >= 0 ? 'positive' : 'negative'}">${terminalValueDiff >= 0 ? '' : ''}${formatCurrency(terminalValueDiff)} (${terminalValueDiff >= 0 ? '' : ''}${terminalValueAdvantagePercent}%)</span>
                                    <span class="secondary-label">vs Sell Assets</span>
                                </div>
                                <div class="secondary-item">
                                    <span class="secondary-value">${formatCurrency(sellTerminalMedian)}</span>
                                    <span class="secondary-label">Sell Terminal</span>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        <div class="worst-case">
                            <span class="material-icons worst-case-icon">trending_down</span>
                            <span class="worst-case-text">P10 outcome: <span class="worst-case-value">${formatCurrency(terminalStats.percentile10)}</span></span>
                        </div>
                    </div>

                    <!-- Card 3: Leverage Safety -->
                    <div class="hero-metric-card ${marginClass}">
                        <div class="card-header">
                            <div class="card-title-group">
                                <h4 class="card-title">Leverage Safety</h4>
                                <p class="card-subtitle">MARGIN CALL RISK</p>
                            </div>
                            <div class="card-status-badge">
                                <span class="material-icons">${marginCallRate < 20 ? 'verified_user' : marginCallRate < 40 ? 'warning' : 'gpp_bad'}</span>
                            </div>
                        </div>
                        <div class="card-metrics">
                            <div class="metric-primary">
                                <span class="metric-value">${marginCallRate.toFixed(1)}</span>
                                <span class="metric-suffix">%</span>
                            </div>
                            <p class="metric-label">Margin Call Probability</p>
                            <div class="metric-secondary">
                                <div class="secondary-item">
                                    <span class="secondary-value">${p90LocUtilization !== null ? p90LocUtilization.toFixed(1) + '%' : '--'}</span>
                                    <span class="secondary-label">Peak Utilization (P90)</span>
                                </div>
                                <div class="secondary-item">
                                    <span class="secondary-value">${p10SafetyBuffer !== null ? p10SafetyBuffer.toFixed(1) + '%' : '--'}</span>
                                    <span class="secondary-label">Safety Buffer (P10)</span>
                                </div>
                            </div>
                            <div class="metric-secondary">
                                <div class="secondary-item">
                                    <span class="secondary-value">${medianLocUtilization !== null ? medianLocUtilization.toFixed(1) + '%' : '--'}</span>
                                    <span class="secondary-label">Median Utilization</span>
                                </div>
                                <div class="secondary-item">
                                    <span class="secondary-value">${highRiskYearsPct.toFixed(1)}%</span>
                                    <span class="secondary-label">Years Above 70%</span>
                                </div>
                            </div>
                        </div>
                        <div class="worst-case">
                            <span class="material-icons worst-case-icon">${mostDangerousYear ? 'event' : 'info'}</span>
                            <span class="worst-case-text">${mostDangerousYear
                                ? `Most dangerous year: <span class="worst-case-value">${mostDangerousYear}</span>`
                                : 'Risk assessment available in stress testing'}</span>
                        </div>
                    </div>
                </div>

                <!-- Integrated Portfolio & Parameters Section -->
                <div class="params-summary-container">
                    <!-- Portfolio Section -->
                    <div class="portfolio-integrated-section">
                        <div class="portfolio-integrated-header">
                            <div class="portfolio-integrated-icon">
                                <span class="material-icons">pie_chart</span>
                            </div>
                            <div class="portfolio-integrated-title-group">
                                <h3>Portfolio Composition</h3>
                                <div class="portfolio-integrated-count">${assetNames.length} Assets</div>
                            </div>
                        </div>

                        <div class="portfolio-donut-container">
                            <div class="portfolio-donut-wrapper">
                                <div class="portfolio-donut" style="background: ${donutGradient};">
                                    <div class="portfolio-donut-center">
                                        <div class="portfolio-donut-center-value">${assetNames.length}</div>
                                        <div class="portfolio-donut-center-label">Assets</div>
                                    </div>
                                </div>
                            </div>
                            <div class="portfolio-legend">
                                ${portfolioLegendItems}
                            </div>
                        </div>
                    </div>

                    <!-- Divider -->
                    <div class="section-divider-integrated"></div>

                    <!-- Parameters Grid -->
                    <div class="params-grid">
                        <div class="param-item">
                            <div class="param-label">Starting Portfolio</div>
                            <div class="param-value param-value-highlight">$${params.startValue.toLocaleString()}</div>
                        </div>
                        <div class="param-item">
                            <div class="param-label">Time Horizon</div>
                            <div class="param-value">${params.period} years</div>
                        </div>
                        <div class="param-item">
                            <div class="param-label">Annual Withdrawal</div>
                            <div class="param-value param-value-highlight">$${params.annualWithdrawal.toLocaleString()}</div>
                        </div>
                        <div class="param-item">
                            <div class="param-label">Withdrawal Growth</div>
                            <div class="param-value">${(params.annualRaise).toFixed(1)}% / year</div>
                        </div>
                        <div class="param-item">
                            <div class="param-label">SBLOC Interest Rate</div>
                            <div class="param-value">${(params.sblocRate).toFixed(2)}%</div>
                        </div>
                        <div class="param-item">
                            <div class="param-label">Max Borrowing</div>
                            <div class="param-value">${(params.maxBorrowing * 100).toFixed(0)}%</div>
                        </div>
                        <div class="param-item">
                            <div class="param-label">Maintenance Margin</div>
                            <div class="param-value">${(params.maintenanceMargin * 100).toFixed(0)}%</div>
                        </div>
                        <div class="param-item">
                            <div class="param-label">Simulations Run</div>
                            <div class="param-value">${params.numSimulations.toLocaleString()}</div>
                        </div>
                    </div>
                </div>

                <!-- Tier 2: Outcome Spectrum -->
                <div class="outcome-spectrum">
                    <div class="spectrum-header">Terminal Net Worth Distribution</div>
                    <div class="spectrum-container">
                        <div class="percentile-marker worst">
                            <div class="percentile-label">10th Percentile<br>(Worst Case)</div>
                            <div class="percentile-value">${formatCurrency(terminalStats.percentile10)}</div>
                        </div>
                        <div class="percentile-marker median">
                            <div class="percentile-label">Median<br>(50th Percentile)</div>
                            <div class="percentile-value">${formatCurrency(terminalStats.median)}</div>
                        </div>
                        <div class="percentile-marker best">
                            <div class="percentile-label">90th Percentile<br>(Best Case)</div>
                            <div class="percentile-value">${formatCurrency(terminalStats.percentile90)}</div>
                        </div>
                    </div>
                </div>

                <!-- Total Debt By End of Period - Dual View -->
                <div style="margin-top: 32px;">
                    <div class="spectrum-header mb-8">Total Debt By End of Period (${params.period} Years)</div>
                    <div style="font-size: 13px; color: var(--md-sys-color-on-surface-variant); margin-bottom: 20px; line-height: 1.6;">
                        Understanding your debt accumulation from two perspectives:
                    </div>

                    <!-- Theoretical Debt (Consistent) 
                    <div class="planned-debt-card" style="margin-bottom: 24px; padding: 20px; border-radius: 6px; border-left: 4px solid var(--md-sys-color-secondary);">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                            <span class="material-icons" style="color: var(--md-sys-color-secondary); font-size: 24px;">calculate</span>
                            <div>
                                <div style="font-size: 16px; font-weight: 600; color: var(--md-sys-color-secondary);">Planned Debt (Median Scenario) after ${params.period} years</div>
                                <div class="text-sm-mt-2-on-surface-variant">Actual LOC balance from the median (50th percentile) simulation path</div>
                            </div>
                        </div>
                        <div class="planned-debt-value" style="text-align: center; padding: 20px; border-radius: 5px; margin-bottom: 12px;">
                            <div style="font-size: 32px; font-weight: 700; color: var(--md-sys-color-secondary);">${formatCurrency(plannedDebt)}</div>
                        </div>
                        <div class="text-sm-lh-relaxed-on-surface-variant">
                            <strong>What this shows:</strong> The actual line-of-credit balance from the median (50th percentile) simulation. This includes all withdrawals, interest charges, and dividend taxes that occurred in that specific path, accounting for market volatility. This represents the debt level you'd experience in a typical simulation outcome.
                        </div>
                    </div>
                    -->

                    <!-- Actual Debt (Varies by Percentile) -->
                    <div style="padding: 20px; background: rgba(0, 131, 110, 0.08); border-radius: 6px; border-left: 4px solid var(--md-sys-color-primary);">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                            <span class="material-icons" style="color: var(--md-sys-color-primary); font-size: 24px;">account_balance</span>
                            <div>
                                <div style="font-size: 16px; font-weight: 600; color: var(--md-sys-color-primary);">Actual LOC Balance (By Scenario) after ${params.period} years</div>
                                <div class="text-sm-mt-2-on-surface-variant">After margin call liquidations and portfolio dynamics</div>
                            </div>
                        </div>
                        <div class="spectrum-container mb-12">
                            <div class="percentile-marker worst">
                                <div class="percentile-label">10th Percentile<br>(Worst Case)</div>
                                <div class="percentile-value">${formatCurrency(percentilesData[10][percentilesData[10].length - 1].locBalance)}</div>
                            </div>
                            <div class="percentile-marker median">
                                <div class="percentile-label">Median<br>(50th Percentile)</div>
                                <div class="percentile-value">${formatCurrency(percentilesData[50][percentilesData[50].length - 1].locBalance)}</div>
                            </div>
                            <div class="percentile-marker best">
                                <div class="percentile-label">90th Percentile<br>(Best Case)</div>
                                <div class="percentile-value">${formatCurrency(percentilesData[90][percentilesData[90].length - 1].locBalance)}</div>
                            </div>
                        </div>
                        <div class="text-sm-lh-relaxed-on-surface-variant">
                            <strong>What this shows:</strong> The actual LOC balance at the end of each simulation path. This varies by percentile because:
                            <ul style="margin: 8px 0 0 20px; padding: 0;">
                                <li><strong>Margin calls trigger asset sales</strong> that pay down debt (reducing the balance)</li>
                                <li><strong>Failed simulations</strong> (worst cases) may end early, accumulating less total debt</li>
                                <li><strong>Successful simulations</strong> run the full period without forced liquidations</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Tier 3: Metadata -->
                <div class="metadata-row">
                    <!-- Number of Simulation 
                    <div class="metadata-card">
                        <span class="material-icons metadata-icon">scatter_plot</span>
                        <div class="metadata-content">
                            <div class="metadata-label">Simulations</div>
                            <div class="metadata-value">${params.numSimulations.toLocaleString()}</div>
                        </div>
                    </div>
                    -->
                    <!-- Portfolio metadata card hidden - now integrated with parameters section above
                    <div class="metadata-card portfolio-assets-card">
                        <span class="material-icons metadata-icon">pie_chart</span>
                        <div class="metadata-content">
                            <div class="metadata-label">Portfolio (${assetNames.length} Assets)</div>
                            <div class="assets-preview">
                                ${assetsPreview}
                            </div>
                            ${portfolioWeightBarHTML}
                        </div>
                    </div>
                    -->
                </div>
            `;

            document.getElementById('keyMetrics').innerHTML = keyMetricsHTML;

            // Monte Carlo Summary Text
            const endYear = params.startYear + params.period;

            // Build withdrawal description accounting for chapter strategy
            let withdrawalDescription = `annual withdrawals of <strong>$${params.annualWithdrawal.toLocaleString()}</strong>
                    (increasing by ${params.annualRaise.toFixed(1)}% annually)`;

            // Add chapter information if enabled
            if (params.enableChapters && params.chapter2StartYear) {
                withdrawalDescription += `<br><strong>Chapter 2 (${params.chapter2StartYear}):</strong> `;
                if (params.chapter2ReductionPct > 0) {
                    withdrawalDescription += `${params.chapter2ReductionPct}% reduction`;
                } else if (params.chapter2ReductionPct < 0) {
                    withdrawalDescription += `${Math.abs(params.chapter2ReductionPct)}% increase`;
                } else {
                    withdrawalDescription += `no change`;
                }

                if (params.chapter3StartYear) {
                    withdrawalDescription += `<br><strong>Chapter 3 (${params.chapter3StartYear}):</strong> `;
                    if (params.chapter3ReductionPct > 0) {
                        withdrawalDescription += `${params.chapter3ReductionPct}% reduction`;
                    } else if (params.chapter3ReductionPct < 0) {
                        withdrawalDescription += `${Math.abs(params.chapter3ReductionPct)}% increase`;
                    } else {
                        withdrawalDescription += `no change`;
                    }
                }
            }

            // Calculate additional metrics for guardrails display
            // Note: sellSuccessRate already declared above, use sellStrategyStats directly
            const guardrailsSellRate = mcResults.sellStrategyStats?.successRate || 0;
            const bbdAdvantage = successRate - guardrailsSellRate;
            // Use actual liquidityStats fields: p90LocUtilization is worst-case (90th percentile) utilization
            const medianPeakLTV = mcResults.liquidityStats?.p90LocUtilization || 0;
            // worstCaseLocUsedPct is the absolute worst utilization seen across all simulations
            const p10PeakLTV = mcResults.liquidityStats?.worstCaseLocUsedPct || 0;
            // minDistanceToMarginCall is how far from 100% utilization at worst point
            const maxSurvivableDrop = mcResults.liquidityStats?.minDistanceToMarginCall || 0;

            // Determine card statuses
            const getSuccessCardStatus = () => {
                if (successRate >= 80) return 'green';
                if (successRate >= 60) return 'yellow';
                return 'red';
            };

            const getLeverageCardStatus = () => {
                // medianPeakLTV is actually p90LocUtilization (90th percentile worst case)
                // maxSurvivableDrop is the buffer to margin call at worst point
                if (medianPeakLTV <= 60 && maxSurvivableDrop >= 30) return 'green';
                if (medianPeakLTV <= 80 && maxSurvivableDrop >= 15) return 'yellow';
                return 'red';
            };

            const getMarginCallCardStatus = () => {
                if (marginCallRate <= 5) return 'green';
                if (marginCallRate <= 15) return 'yellow';
                return 'red';
            };

            // Build actionable recommendations
            const buildRecommendations = () => {
                const recs = [];

                // Critical issues first
                if (marginCallRate > 20) {
                    recs.push({
                        type: 'critical',
                        icon: 'error_outline',
                        message: `High margin call risk: ${marginCallRate.toFixed(1)}% of simulations triggered forced liquidation`,
                        action: `Reduce max LTV to ${Math.max(40, (params.maxBorrowing * 100) - 10).toFixed(0)}% or decrease annual withdrawal by 10%`
                    });
                }

                if (successRate < 60) {
                    recs.push({
                        type: 'critical',
                        icon: 'trending_down',
                        message: `Low success rate: Only ${successRate.toFixed(1)}% of simulations maintain positive net worth`,
                        action: `Consider reducing withdrawal from $${params.annualWithdrawal.toLocaleString()} to $${Math.round(params.annualWithdrawal * 0.85).toLocaleString()}`
                    });
                } else if (successRate < 80) {
                    recs.push({
                        type: 'warning',
                        icon: 'trending_down',
                        message: `Success rate below target: ${successRate.toFixed(1)}% is under the 80% recommended threshold`,
                        action: `Consider reducing withdrawal by 10% to improve success rate`
                    });
                }

                // Warning issues
                if (marginCallRate > 10 && marginCallRate <= 20) {
                    recs.push({
                        type: 'warning',
                        icon: 'warning_amber',
                        message: `Elevated leverage risk: ${marginCallRate.toFixed(1)}% margin call probability in worst scenarios`,
                        action: `Build $${Math.round(params.annualWithdrawal * 1.5).toLocaleString()} cash buffer or reduce withdrawals by 10%`
                    });
                }

                if (impliedCAGR !== null && impliedCAGR > 12) {
                    const currentRegimeMode = params.regimeMode || 'conservative';
                    const isConservativeMode = currentRegimeMode === 'conservative';
                    recs.push({
                        type: 'warning',
                        icon: 'analytics',
                        message: `Above-average growth assumption: ${impliedCAGR.toFixed(1)}% implied CAGR exceeds typical 8-10% market average`,
                        action: isConservativeMode
                            ? `Already stress-testing with Conservative mode. High CAGR may reflect concentrated growth positions or survivorship bias in historical data`
                            : `Results may be optimistic. Consider using Conservative regime mode for stress testing`
                    });
                }

                // Opportunities
                if (bbdAdvantage > 5) {
                    recs.push({
                        type: 'opportunity',
                        icon: 'compare_arrows',
                        message: `BBD outperforms Sell Assets by ${bbdAdvantage.toFixed(1)} percentage points (${successRate.toFixed(1)}% vs ${guardrailsSellRate.toFixed(1)}%)`,
                        action: `Tax-efficient borrowing provides meaningful advantage over traditional liquidation`
                    });
                }

                // Info - Return Model with Regime Mode details
                const returnModelName = params.returnModel || 'bootstrap';
                const regimeMode = params.regimeMode || 'conservative';
                const modelShortNames = {
                    'bootstrap': 'Historical Bootstrap',
                    'regime': 'Regime-Switching',
                    'fat-tail': 'Fat-Tailed Distribution'
                };

                // Build return model description with regime mode context
                let modelDescription = modelShortNames[returnModelName];
                let modelAction = `${params.period}-year projection from ${params.startYear} to ${endYear}`;

                if (returnModelName === 'regime') {
                    const regimeModeLabel = regimeMode === 'historical' ? 'Historical' : 'Conservative';
                    modelDescription = `Regime-Switching (${regimeModeLabel} mode) with ${params.numSimulations.toLocaleString()} simulations over ${params.period} years`;

                    if (regimeMode === 'historical') {
                        modelAction = `Historical mode uses actual 1970-2023 regime frequencies. Bull markets last ~4 years, crashes ~0.6 years. Reflects optimistic long-term averages`;
                    } else {
                        modelAction = `Conservative mode assumes shorter bull runs (~2.5 years), longer bear/crash periods, and higher volatility. Better for stress-testing`;
                    }
                } else {
                    modelDescription = `${modelShortNames[returnModelName]} with ${params.numSimulations.toLocaleString()} simulations over ${params.period} years`;
                }

                recs.push({
                    type: 'info',
                    icon: 'info',
                    message: `Return model: ${modelDescription}`,
                    action: modelAction
                });

                return recs;
            };
            const recommendations = buildRecommendations();

            // Recommendations HTML - inserted after Key Metrics section
            const summaryHTML = `
                <div id="section-monte-carlo-results" class="monte-carlo-summary">
                    <section class="guardrails-recommendations">
                        <div class="guardrails-section-header">
                            <h3 class="guardrails-section-title">Recommendations</h3>
                        </div>

                        <div class="recommendations-container">
                            <div class="recommendations-header">
                                <div class="recommendations-title">
                                    <span class="material-icons">lightbulb</span>
                                    Actionable Insights
                                </div>
                                <span class="recommendations-count">${recommendations.length}</span>
                            </div>

                            <ul class="recommendations-list">
                                ${recommendations.map(rec => `
                                    <li class="recommendation-item ${rec.type}">
                                        <div class="recommendation-icon">
                                            <span class="material-icons">${rec.icon}</span>
                                        </div>
                                        <div class="recommendation-content">
                                            <p class="recommendation-message">${rec.message}</p>
                                            <p class="recommendation-action"><strong>Action:</strong> ${rec.action}</p>
                                        </div>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </section>
                </div>
            `;

            // Insert Recommendations after Key Metrics section (before charts)
            const resultsDiv = document.getElementById('results');
            let summaryCard = resultsDiv.querySelector('.monte-carlo-summary-card');
            if (!summaryCard) {
                summaryCard = document.createElement('div');
                summaryCard.className = 'card monte-carlo-summary-card';
                resultsDiv.insertBefore(summaryCard, resultsDiv.querySelector('.charts-grid'));
            }
            summaryCard.innerHTML = summaryHTML;

            // Calculate and insert Performance Summary table
            const performanceSummary = calculatePerformanceSummary(percentilesData);
            let performanceCard = resultsDiv.querySelector('.performance-summary-card');
            if (!performanceCard) {
                performanceCard = document.createElement('div');
                performanceCard.className = 'card performance-summary-card';
                // Insert after monte-carlo-summary-card but before charts-grid
                const chartsGrid = resultsDiv.querySelector('.charts-grid');
                resultsDiv.insertBefore(performanceCard, chartsGrid);
            }

            // Build Performance Summary table HTML
            const inflationRateDisplay = params.inflationRate || 0;
            const performanceHTML = `
                <div class="section-header"> Performance Summary</div>
                <div class="table-container" style="overflow-x: auto;">
                    <table class="performance-summary-table" style="width: 100%; border-collapse: collapse; background-color: var(--md-sys-color-surface); border-radius: 6px; overflow: hidden; box-shadow: var(--shadow-xs);">
                        <thead>
                            <tr style="background-color: var(--md-sys-color-surface-container-highest); border-bottom: 3px solid var(--md-sys-color-primary);">
                                <th style="padding: var(--spacing-lg); text-align: left; font-weight: 700; color: var(--md-sys-color-on-surface); font-size: var(--text-body-sm);">Metric</th>
                                <th style="padding: var(--spacing-lg); text-align: right; font-weight: 700; color: var(--md-sys-color-on-surface); font-size: var(--text-body-sm);">10th<br>Percentile</th>
                                <th style="padding: var(--spacing-lg); text-align: right; font-weight: 700; color: var(--md-sys-color-on-surface); font-size: var(--text-body-sm);">25th<br>Percentile</th>
                                <th style="padding: var(--spacing-lg); text-align: right; font-weight: 700; color: var(--md-sys-color-on-surface); font-size: var(--text-body-sm);">50th<br>Percentile</th>
                                <th style="padding: var(--spacing-lg); text-align: right; font-weight: 700; color: var(--md-sys-color-on-surface); font-size: var(--text-body-sm);">75th<br>Percentile</th>
                                <th style="padding: var(--spacing-lg); text-align: right; font-weight: 700; color: var(--md-sys-color-on-surface); font-size: var(--text-body-sm);">90th<br>Percentile</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="background-color: var(--md-sys-color-surface);">
                                <td style="padding: var(--spacing-lg); border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); font-weight: 600;">Time Weighted Rate of Return (nominal)</td>
                                <td style="padding: var(--spacing-lg); text-align: right; border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); color: ${performanceSummary[10].twrrNominal >= 0 ? 'var(--color-semantic-success)' : 'var(--color-semantic-danger)'}; font-weight: 500;">${performanceSummary[10].twrrNominal.toFixed(2)}%</td>
                                <td style="padding: var(--spacing-lg); text-align: right; border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); color: ${performanceSummary[25].twrrNominal >= 0 ? 'var(--color-semantic-success)' : 'var(--color-semantic-danger)'}; font-weight: 500;">${performanceSummary[25].twrrNominal.toFixed(2)}%</td>
                                <td style="padding: var(--spacing-lg); text-align: right; border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); color: ${performanceSummary[50].twrrNominal >= 0 ? 'var(--color-semantic-success)' : 'var(--color-semantic-danger)'}; font-weight: 500;">${performanceSummary[50].twrrNominal.toFixed(2)}%</td>
                                <td style="padding: var(--spacing-lg); text-align: right; border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); color: ${performanceSummary[75].twrrNominal >= 0 ? 'var(--color-semantic-success)' : 'var(--color-semantic-danger)'}; font-weight: 500;">${performanceSummary[75].twrrNominal.toFixed(2)}%</td>
                                <td style="padding: var(--spacing-lg); text-align: right; border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); color: ${performanceSummary[90].twrrNominal >= 0 ? 'var(--color-semantic-success)' : 'var(--color-semantic-danger)'}; font-weight: 500;">${performanceSummary[90].twrrNominal.toFixed(2)}%</td>
                            </tr>
                            <tr style="background-color: var(--md-sys-color-surface-container-low);">
                                <td style="padding: var(--spacing-lg); border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); font-weight: 600;">Time Weighted Rate of Return (real)</td>
                                <td style="padding: var(--spacing-lg); text-align: right; border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); color: ${performanceSummary[10].twrrReal >= 0 ? 'var(--color-semantic-success)' : 'var(--color-semantic-danger)'}; font-weight: 500;">${performanceSummary[10].twrrReal.toFixed(2)}%</td>
                                <td style="padding: var(--spacing-lg); text-align: right; border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); color: ${performanceSummary[25].twrrReal >= 0 ? 'var(--color-semantic-success)' : 'var(--color-semantic-danger)'}; font-weight: 500;">${performanceSummary[25].twrrReal.toFixed(2)}%</td>
                                <td style="padding: var(--spacing-lg); text-align: right; border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); color: ${performanceSummary[50].twrrReal >= 0 ? 'var(--color-semantic-success)' : 'var(--color-semantic-danger)'}; font-weight: 500;">${performanceSummary[50].twrrReal.toFixed(2)}%</td>
                                <td style="padding: var(--spacing-lg); text-align: right; border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); color: ${performanceSummary[75].twrrReal >= 0 ? 'var(--color-semantic-success)' : 'var(--color-semantic-danger)'}; font-weight: 500;">${performanceSummary[75].twrrReal.toFixed(2)}%</td>
                                <td style="padding: var(--spacing-lg); text-align: right; border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); color: ${performanceSummary[90].twrrReal >= 0 ? 'var(--color-semantic-success)' : 'var(--color-semantic-danger)'}; font-weight: 500;">${performanceSummary[90].twrrReal.toFixed(2)}%</td>
                            </tr>
                            <tr style="background-color: var(--md-sys-color-surface);">
                                <td style="padding: var(--spacing-lg); border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); font-weight: 600;">Portfolio End Balance (nominal)</td>
                                <td style="padding: var(--spacing-lg); text-align: right; border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); font-weight: 500;">$${performanceSummary[10].endBalanceNominal.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                                <td style="padding: var(--spacing-lg); text-align: right; border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); font-weight: 500;">$${performanceSummary[25].endBalanceNominal.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                                <td style="padding: var(--spacing-lg); text-align: right; border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); font-weight: 500;">$${performanceSummary[50].endBalanceNominal.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                                <td style="padding: var(--spacing-lg); text-align: right; border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); font-weight: 500;">$${performanceSummary[75].endBalanceNominal.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                                <td style="padding: var(--spacing-lg); text-align: right; border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); font-weight: 500;">$${performanceSummary[90].endBalanceNominal.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                            </tr>
                            <tr style="background-color: var(--md-sys-color-surface-container-low);">
                                <td style="padding: var(--spacing-lg); border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); font-weight: 600;">Portfolio End Balance (real)</td>
                                <td style="padding: var(--spacing-lg); text-align: right; border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); font-weight: 500;">$${performanceSummary[10].endBalanceReal.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                                <td style="padding: var(--spacing-lg); text-align: right; border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); font-weight: 500;">$${performanceSummary[25].endBalanceReal.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                                <td style="padding: var(--spacing-lg); text-align: right; border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); font-weight: 500;">$${performanceSummary[50].endBalanceReal.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                                <td style="padding: var(--spacing-lg); text-align: right; border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); font-weight: 500;">$${performanceSummary[75].endBalanceReal.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                                <td style="padding: var(--spacing-lg); text-align: right; border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); font-weight: 500;">$${performanceSummary[90].endBalanceReal.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                            </tr>
                            <tr style="background-color: var(--md-sys-color-surface);">
                                <td style="padding: var(--spacing-lg); border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); font-weight: 600;">Annual Mean Return (nominal)</td>
                                <td style="padding: var(--spacing-lg); text-align: right; border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); color: ${performanceSummary[10].annualMeanReturnNominal >= 0 ? 'var(--color-semantic-success)' : 'var(--color-semantic-danger)'}; font-weight: 500;">${performanceSummary[10].annualMeanReturnNominal.toFixed(2)}%</td>
                                <td style="padding: var(--spacing-lg); text-align: right; border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); color: ${performanceSummary[25].annualMeanReturnNominal >= 0 ? 'var(--color-semantic-success)' : 'var(--color-semantic-danger)'}; font-weight: 500;">${performanceSummary[25].annualMeanReturnNominal.toFixed(2)}%</td>
                                <td style="padding: var(--spacing-lg); text-align: right; border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); color: ${performanceSummary[50].annualMeanReturnNominal >= 0 ? 'var(--color-semantic-success)' : 'var(--color-semantic-danger)'}; font-weight: 500;">${performanceSummary[50].annualMeanReturnNominal.toFixed(2)}%</td>
                                <td style="padding: var(--spacing-lg); text-align: right; border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); color: ${performanceSummary[75].annualMeanReturnNominal >= 0 ? 'var(--color-semantic-success)' : 'var(--color-semantic-danger)'}; font-weight: 500;">${performanceSummary[75].annualMeanReturnNominal.toFixed(2)}%</td>
                                <td style="padding: var(--spacing-lg); text-align: right; border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); color: ${performanceSummary[90].annualMeanReturnNominal >= 0 ? 'var(--color-semantic-success)' : 'var(--color-semantic-danger)'}; font-weight: 500;">${performanceSummary[90].annualMeanReturnNominal.toFixed(2)}%</td>
                            </tr>
                            <tr style="background-color: var(--md-sys-color-surface-container-low);">
                                <td style="padding: var(--spacing-lg); font-size: var(--text-body-md); font-weight: 600;">Annualized Volatility</td>
                                <td style="padding: var(--spacing-lg); text-align: right; font-size: var(--text-body-md); font-weight: 500;">${performanceSummary[10].annualizedVolatility.toFixed(2)}%</td>
                                <td style="padding: var(--spacing-lg); text-align: right; font-size: var(--text-body-md); font-weight: 500;">${performanceSummary[25].annualizedVolatility.toFixed(2)}%</td>
                                <td style="padding: var(--spacing-lg); text-align: right; font-size: var(--text-body-md); font-weight: 500;">${performanceSummary[50].annualizedVolatility.toFixed(2)}%</td>
                                <td style="padding: var(--spacing-lg); text-align: right; font-size: var(--text-body-md); font-weight: 500;">${performanceSummary[75].annualizedVolatility.toFixed(2)}%</td>
                                <td style="padding: var(--spacing-lg); text-align: right; font-size: var(--text-body-md); font-weight: 500;">${performanceSummary[90].annualizedVolatility.toFixed(2)}%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <p style="margin-top: 16px; font-size: 13px; color: var(--md-sys-color-on-surface-variant); line-height: 1.6;">
                    <strong>Note:</strong> Real values are adjusted for ${inflationRateDisplay.toFixed(1)}% annual inflation.
                    TWRR (Time-Weighted Rate of Return) represents the geometric mean return across the simulation period,
                    which is the industry-standard metric for measuring investment performance.
                </p>
            `;
            performanceCard.innerHTML = performanceHTML;

            // Calculate asset statistics and correlations
            const assetStats = calculateAssetStatistics(assetNames);
            const correlationMatrix = calculateCorrelationMatrix(assetNames);

            // Create Simulated Assets - Correlations and Returns table
            let assetsCorrelationCard = resultsDiv.querySelector('.assets-correlation-card');
            if (!assetsCorrelationCard) {
                assetsCorrelationCard = document.createElement('div');
                assetsCorrelationCard.className = 'card assets-correlation-card';
                const chartsGrid = resultsDiv.querySelector('.charts-grid');
                resultsDiv.insertBefore(assetsCorrelationCard, chartsGrid);
            }

            // Helper function to get correlation cell color
            const getCorrelationColor = (corr) => {
                if (corr >= 0.95) return 'rgb(0, 95, 87)'; // Strong positive - darkest teal green
                if (corr >= 0.7) return 'rgb(0, 76, 69)'; // Moderate positive - dark teal green
                if (corr >= 0.4) return 'rgb(20, 60, 56)'; // Weak positive - medium teal green
                if (corr >= 0.1) return 'rgba(156, 163, 175, 0.2)'; // Very weak - light gray
                if (corr >= -0.1) return 'rgba(156, 163, 175, 0.1)'; // Near zero - very light gray
                if (corr >= -0.4) return 'rgba(239, 68, 68, 0.2)'; // Weak negative - light red
                if (corr >= -0.7) return 'rgba(239, 68, 68, 0.4)'; // Moderate negative - medium red
                return 'rgba(239, 68, 68, 0.6)'; // Strong negative - dark red
            };

            const assetsCorrelationHTML = `
                <div class="section-header"> Simulated Assets - Correlations and Returns</div>
                <div class="table-container" style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background-color: var(--md-sys-color-surface); border-radius: 6px; overflow: hidden; box-shadow: var(--shadow-xs);">
                        <thead>
                            <tr style="background-color: var(--md-sys-color-surface-container-highest); border-bottom: 3px solid var(--md-sys-color-primary);">
                                <th style="padding: var(--spacing-lg); text-align: left; font-weight: 700; color: var(--md-sys-color-on-surface); font-size: var(--text-body-sm); min-width: 140px;">Name</th>
                                ${assetNames.map(name => `
                                    <th style="padding: var(--spacing-lg); text-align: center; font-weight: 700; color: var(--md-sys-color-on-surface); font-size: var(--text-body-sm); min-width: 80px;">${name}</th>
                                `).join('')}
                                <th style="padding: var(--spacing-lg); text-align: right; font-weight: 700; color: var(--md-sys-color-on-surface); font-size: var(--text-body-sm); min-width: 140px;">Expected Annual<br>Return</th>
                                <th style="padding: var(--spacing-lg); text-align: right; font-weight: 700; color: var(--md-sys-color-on-surface); font-size: var(--text-body-sm); min-width: 140px;">Annualized<br>Volatility</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${assetNames.map((asset, idx) => `
                                <tr style="background-color: ${idx % 2 === 0 ? 'var(--md-sys-color-surface)' : 'var(--md-sys-color-surface-container-low)'};">
                                    <td style="padding: var(--spacing-lg); border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); font-weight: 600;">${asset}</td>
                                    ${assetNames.map(otherAsset => {
                                        const corr = correlationMatrix[asset][otherAsset];
                                        const bgColor = getCorrelationColor(corr);
                                        const isDiagonal = asset === otherAsset;
                                        // Use CSS variables that adapt to theme: high correlation (>= 0.4) uses --correlation-high-text, low uses --correlation-low-text
                                        const textColorVar = (corr >= 0.4) ? 'var(--correlation-high-text)' : 'var(--correlation-low-text)';
                                        return `
                                            <td style="padding: var(--spacing-lg); text-align: center; border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); font-weight: ${isDiagonal ? '700' : '500'}; background-color: ${bgColor}; color: ${textColorVar} !important;">
                                                ${corr.toFixed(2)}
                                            </td>
                                        `;
                                    }).join('')}
                                    <td style="padding: var(--spacing-lg); text-align: right; border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); font-weight: 600; color: ${assetStats[asset].expectedReturn >= 0 ? 'var(--color-semantic-success)' : 'var(--color-semantic-danger)'};">
                                        ${assetStats[asset].expectedReturn.toFixed(2)}%
                                    </td>
                                    <td style="padding: var(--spacing-lg); text-align: right; border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); font-weight: 500;">
                                        ${assetStats[asset].volatility.toFixed(2)}%
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 16px; padding: 16px; background: rgba(27, 75, 75, 0.05); border-left: 3px solid var(--md-sys-color-primary); border-radius: 6px;">
                    <p style="font-size: 13px; color: var(--md-sys-color-on-surface-variant); line-height: 1.7; margin-bottom: 12px;">
                        <strong style="color: var(--md-sys-color-on-surface);">Correlation Matrix:</strong>
                        Calculated using Pearson correlation coefficient on year-aligned historical returns. Values range from -1.0 (perfect negative correlation) to +1.0 (perfect positive correlation).
                        Diagonal cells (1.00) represent each asset correlated with itself.
                    </p>
                    <p style="font-size: 13px; color: var(--md-sys-color-on-surface-variant); line-height: 1.7; margin-bottom: 12px;">
                        <strong style="color: var(--md-sys-color-on-surface);">Expected Annual Return:</strong>
                        Arithmetic mean of all year-over-year returns from historical data. Formula: <code style="background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 3px; font-size: 12px;"> = ( r<sub>i</sub>) / n</code>
                        where r<sub>i</sub> represents each annual return and n is the number of years of data.
                    </p>
                    <p style="font-size: 13px; color: var(--md-sys-color-on-surface-variant); line-height: 1.7; margin: 0;">
                        <strong style="color: var(--md-sys-color-on-surface);">Annualized Volatility:</strong>
                        Standard deviation of annual returns, measuring return dispersion. Formula: <code style="background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 3px; font-size: 12px;"> = [(r<sub>i</sub> - ) / n]</code>.
                        Higher volatility indicates greater price fluctuation and risk. Used in modern portfolio theory to assess risk-adjusted returns.
                    </p>
                    <p style="font-size: 12px; color: var(--md-sys-color-on-surface-variant); line-height: 1.6; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(27, 75, 75, 0.1);">
                        <strong>Diversification Insight:</strong> Lower correlations (closer to 0 or negative) provide better diversification benefits.
                        Assets with correlations above 0.90 move very similarly and offer limited diversification value.
                    </p>
                </div>
            `;
            assetsCorrelationCard.innerHTML = assetsCorrelationHTML;

            // Calculate multi-horizon returns
            const horizonReturns = calculateMultiHorizonReturns(percentilesData, params);

            // Create Expected Annual Return table
            let expectedReturnCard = resultsDiv.querySelector('.expected-return-card');
            if (!expectedReturnCard) {
                expectedReturnCard = document.createElement('div');
                expectedReturnCard.className = 'card expected-return-card';
                const chartsGrid = resultsDiv.querySelector('.charts-grid');
                resultsDiv.insertBefore(expectedReturnCard, chartsGrid);
            }

            const horizons = [1, 3, 5, 10, 15];
            const expectedReturnHTML = `
                <div class="section-header"> Expected Annual Return</div>
                <div class="table-container" style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background-color: var(--md-sys-color-surface); border-radius: 6px; overflow: hidden; box-shadow: var(--shadow-xs);">
                        <thead>
                            <tr style="background-color: var(--md-sys-color-surface-container-highest); border-bottom: 3px solid var(--md-sys-color-primary);">
                                <th style="padding: var(--spacing-lg); text-align: left; font-weight: 700; color: var(--md-sys-color-on-surface); font-size: var(--text-body-sm);">Percentile</th>
                                ${horizons.map(h => `
                                    <th style="padding: var(--spacing-lg); text-align: right; font-weight: 700; color: var(--md-sys-color-on-surface); font-size: var(--text-body-sm);">${h} Year${h > 1 ? 's' : ''}</th>
                                `).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${[10, 25, 50, 75, 90].map((percentile, idx) => `
                                <tr style="background-color: ${idx % 2 === 0 ? 'var(--md-sys-color-surface)' : 'var(--md-sys-color-surface-container-low)'};">
                                    <td style="padding: var(--spacing-lg); border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); font-weight: 600;">${percentile}th Percentile</td>
                                    ${horizons.map(h => {
                                        const value = horizonReturns[percentile][h];
                                        const displayValue = value !== null ? `${value.toFixed(2)}%` : 'N/A';
                                        const color = value !== null && value >= 0 ? 'var(--color-semantic-success)' : 'var(--color-semantic-danger)';
                                        return `
                                            <td style="padding: var(--spacing-lg); text-align: right; border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); font-weight: 500; color: ${value !== null ? color : 'var(--md-sys-color-on-surface-variant)'};">
                                                ${displayValue}
                                            </td>
                                        `;
                                    }).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <p style="margin-top: 16px; font-size: 13px; color: var(--md-sys-color-on-surface-variant); line-height: 1.6;">
                    <strong>Note:</strong> Expected annual returns represent the compound annual growth rate (CAGR) over each time horizon,
                    showing how your portfolio is projected to perform over different investment periods.
                </p>
            `;
            expectedReturnCard.innerHTML = expectedReturnHTML;

            // Calculate return probabilities
            const returnProbabilities = calculateReturnProbabilities(mcResults.allSimulations, params);

            // Create Annual Return Probabilities table
            let returnProbCard = resultsDiv.querySelector('.return-prob-card');
            if (!returnProbCard) {
                returnProbCard = document.createElement('div');
                returnProbCard.className = 'card return-prob-card';
                const chartsGrid = resultsDiv.querySelector('.charts-grid');
                resultsDiv.insertBefore(returnProbCard, chartsGrid);
            }

            const thresholds = [0, 2.5, 5.0, 7.5, 10.0, 12.5];
            const returnProbHTML = `
                <div class="section-header"> Annual Return Probabilities</div>
                <div class="table-container" style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background-color: var(--md-sys-color-surface); border-radius: 6px; overflow: hidden; box-shadow: var(--shadow-xs);">
                        <thead>
                            <tr style="background-color: var(--md-sys-color-surface-container-highest); border-bottom: 3px solid var(--md-sys-color-primary);">
                                <th style="padding: var(--spacing-lg); text-align: left; font-weight: 700; color: var(--md-sys-color-on-surface); font-size: var(--text-body-sm);">Return</th>
                                ${horizons.map(h => `
                                    <th style="padding: var(--spacing-lg); text-align: right; font-weight: 700; color: var(--md-sys-color-on-surface); font-size: var(--text-body-sm);">${h} Year${h > 1 ? 's' : ''}</th>
                                `).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${thresholds.map((threshold, idx) => `
                                <tr style="background-color: ${idx % 2 === 0 ? 'var(--md-sys-color-surface)' : 'var(--md-sys-color-surface-container-low)'};">
                                    <td style="padding: var(--spacing-lg); border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); font-weight: 600);">>= ${threshold.toFixed(2)}%</td>
                                    ${horizons.map(h => {
                                        const prob = returnProbabilities[threshold][h];
                                        const displayValue = prob !== null ? `${prob.toFixed(2)}%` : 'N/A';
                                        // Color gradient: low probability = red, medium = yellow, high = green
                                        let color = 'var(--md-sys-color-on-surface-variant)';
                                        if (prob !== null) {
                                            if (prob >= 90) color = 'var(--color-semantic-success)';
                                            else if (prob >= 70) color = '#10b981';
                                            else if (prob >= 50) color = '#eab308';
                                            else if (prob >= 30) color = '#f59e0b';
                                            else color = 'var(--color-semantic-danger)';
                                        }
                                        return `
                                            <td style="padding: var(--spacing-lg); text-align: right; border-bottom: 1px solid var(--md-sys-color-surface-variant); font-size: var(--text-body-md); font-weight: 500; color: ${color};">
                                                ${displayValue}
                                            </td>
                                        `;
                                    }).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <p style="margin-top: 16px; font-size: 13px; color: var(--md-sys-color-on-surface-variant); line-height: 1.6;">
                    <strong>Note:</strong> Probabilities show the likelihood of achieving or exceeding each return threshold over different time horizons.
                    Higher probabilities (green) indicate more confidence in achieving that return level.
                </p>
            `;
            returnProbCard.innerHTML = returnProbHTML;

            // Populate Salary Equivalent section (adapted for Monte Carlo)
            const medianWithdrawal = params.annualWithdrawal; // Starting withdrawal amount
            const salaryEquiv = calculateSalaryEquivalent(medianWithdrawal);
            const taxSavings = salaryEquiv - medianWithdrawal;

            document.getElementById('salaryEquivalent').textContent =
                '$' + medianWithdrawal.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            document.getElementById('taxableEquivalent').textContent =
                '$' + salaryEquiv.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            document.getElementById('taxSavingsText').textContent =
                `Based on your withdrawal plan, you save approximately $${taxSavings.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} in annual taxes by using the Buy Borrow Die strategy (based on 2024 federal tax rates for single filer)`;

            // Populate Strategy Summary section (Monte Carlo specific)
            const medianFinalNetWorth = terminalStats.median;
            const strategySummaryHTML = `
                <p>This Monte Carlo analysis ran <strong>${params.numSimulations.toLocaleString()} probabilistic simulations</strong>
                using a hand-picked portfolio of <strong>${assetNames.join(', ')}</strong>.</p>

                <p>Starting with <strong>$${params.startValue.toLocaleString()}</strong>, the analysis models ${params.period} years
                (${params.startYear}-${endYear}) of the Buy Borrow Die strategy with annual withdrawals starting at
                <strong>$${params.annualWithdrawal.toLocaleString()}</strong> (increasing by ${params.annualRaise.toFixed(1)}% annually)
                through an SBLOC at ${params.sblocRate.toFixed(2)}% interest.</p>

                <p>The <strong>median outcome</strong> (50th percentile) shows a final net worth of
                <strong class="${medianFinalNetWorth >= 0 ? 'positive' : 'negative'}">
                $${medianFinalNetWorth.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</strong>,
                with <strong>${successRate.toFixed(1)}%</strong> of simulations resulting in successful outcomes
                (no margin calls and positive final value).</p>
            `;
            // Strategy summary is now part of consolidated Strategy Analysis section
            const summaryTextEl = document.getElementById('summaryText');
            if (summaryTextEl) summaryTextEl.innerHTML = strategySummaryHTML;

            // Generate Monte Carlo Executive Summary (if element exists)
            generateMonteCarloExecutiveSummary(mcResults);

            // Hide Single Asset charts and show Monte Carlo charts
            const originalChartsGrid = document.getElementById('section-charts');
            if (originalChartsGrid) {
                originalChartsGrid.style.display = 'none';
            }
            document.getElementById('monteCarloChartsSection').style.display = 'block';

            // Ensure Monte Carlo summary cards are visible
            const monteCarloSummaryCardDisplay = resultsDiv.querySelector('.monte-carlo-summary-card');
            if (monteCarloSummaryCardDisplay) {
                monteCarloSummaryCardDisplay.style.display = 'block';
            }
            const performanceSummaryCardDisplay = resultsDiv.querySelector('.performance-summary-card');
            if (performanceSummaryCardDisplay) {
                performanceSummaryCardDisplay.style.display = 'block';
            }
            const assetsCorrelationCardDisplay = resultsDiv.querySelector('.assets-correlation-card');
            if (assetsCorrelationCardDisplay) {
                assetsCorrelationCardDisplay.style.display = 'block';
            }
            const expectedReturnCardDisplay = resultsDiv.querySelector('.expected-return-card');
            if (expectedReturnCardDisplay) {
                expectedReturnCardDisplay.style.display = 'block';
            }
            const returnProbCardDisplay = resultsDiv.querySelector('.return-prob-card');
            if (returnProbCardDisplay) {
                returnProbCardDisplay.style.display = 'block';
            }

            // Hide Year-by-Year table (redundant with Percentile table)
            const yearByYearSection = document.getElementById('section-year-by-year');
            if (yearByYearSection) {
                yearByYearSection.style.display = 'none';
            }

            // Draw Monte Carlo charts
            drawProbabilityConeChart(percentilesData);
            drawMCSBLOCBalanceChart(percentilesData, params); // SBLOC Balance chart for main section
            drawSBLOCUtilizationChart(percentilesData, params);
            drawNetWorthPercentilesChart(percentilesData); // NEW: Net Worth Across Simulations
            drawMarginCallRiskChart(mcResults);
            drawTerminalDistributionChart(mcResults);

            // Draw liquidity stress testing dashboard and chart
            // Note: Dashboard must be populated first to create the canvas element
            populateLiquidityStressDashboard(mcResults.liquidityStats, params);
            drawLiquiditySafetyBufferChart(mcResults.liquidityStats, params);

            // Draw percentile table (includes withdrawal columns)
            drawPercentileTable(percentilesData);

            // Display strategy comparison if sell simulations are available
            if (mcResults.sellStrategyStats) {
                displayStrategyComparison(mcResults);
            }

            // Show TOC navigation button after successful simulation
            showTOCButton();

            // Show print button after simulation completes
            showPrintButton();
        }

        // Show TOC button after simulation completes
        function showTOCButton() {
            const tocToggle = document.getElementById('tocToggle');
            if (tocToggle) {
                tocToggle.classList.add('toc-active');
            }
            // Reinitialize TOC to pick up dynamically created sections
            if (typeof initTOC === 'function') {
                initTOC();
            }
        }

        // Hide TOC button when navigating away from results
        function hideTOCButton() {
            const tocToggle = document.getElementById('tocToggle');
            const tocNav = document.getElementById('tocNav');
            if (tocToggle) {
                tocToggle.classList.remove('toc-active');
                tocToggle.classList.remove('toc-open');
            }
            if (tocNav) {
                tocNav.classList.remove('visible');
            }
        }

        // Helper function to format currency
        function formatCurrency(value) {
            if (value >= 0) {
                return '$' + value.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            } else {
                return '-$' + Math.abs(value).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            }
        }

        // Helper function to get responsive font sizes based on screen width
        function getResponsiveFontSizes() {
            const width = window.innerWidth;
            if (width < 768) {
                // Mobile - smaller to match refined UI
                return {
                    title: 11,
                    legend: 9,
                    axisTicks: 8,
                    axisTitle: 9
                };
            } else if (width < 1024) {
                // Tablet - smaller to match refined UI
                return {
                    title: 12,
                    legend: 10,
                    axisTicks: 9,
                    axisTitle: 10
                };
            } else {
                // Desktop - smaller to match refined page content
                return {
                    title: 13,
                    legend: 10,
                    axisTicks: 9,
                    axisTitle: 10
                };
            }
        }

        // Helper function to get consistent font configurations for charts
        function getChartFontConfig(fontSizes) {
            const fontFamily = "'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif";
            return {
                title: {
                    size: fontSizes.title,
                    weight: 'normal',  // Lighter weight for refined appearance
                    family: fontFamily
                },
                legend: {
                    size: fontSizes.legend,
                    weight: 'normal',
                    family: fontFamily
                },
                axisTitle: {
                    size: fontSizes.axisTitle,
                    weight: 'normal',  // Lighter weight for refined appearance
                    family: fontFamily
                },
                axisTicks: {
                    size: fontSizes.axisTicks,
                    weight: 'normal',
                    family: fontFamily
                }
            };
        }

        // Draw Probability Cone Chart (replaces Trend Over Time for Monte Carlo)
        function drawProbabilityConeChart(percentilesData) {
            const ctx = document.getElementById('trendChart');
            if (!ctx) return;

            // Destroy existing chart
            if (window.trendChartInstance) {
                window.trendChartInstance.destroy();
            }

            const years = percentilesData[50].map(d => d.year);

            const datasets = [
                {
                    label: '90th Percentile (Best Case)',
                    data: percentilesData[90].map(d => d.netPortfolio),
                    borderColor: '#6BCB77',
                    backgroundColor: 'rgba(107, 203, 119, 0.15)',
                    borderWidth: 2,
                    fill: '+1',
                    tension: 0.3,
                    pointRadius: 0
                },
                {
                    label: '75th Percentile',
                    data: percentilesData[75].map(d => d.netPortfolio),
                    borderColor: '#00BFA5',
                    backgroundColor: 'rgba(0, 191, 165, 0.15)',
                    borderWidth: 1,
                    fill: '+1',
                    tension: 0.3,
                    pointRadius: 0
                },
                {
                    label: '50th Percentile (Median)',
                    data: percentilesData[50].map(d => d.netPortfolio),
                    borderColor: '#6C63FF',
                    backgroundColor: 'transparent',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.3,
                    pointRadius: 0
                },
                {
                    label: '25th Percentile',
                    data: percentilesData[25].map(d => d.netPortfolio),
                    borderColor: '#FFD93D',
                    backgroundColor: 'rgba(255, 217, 61, 0.15)',
                    borderWidth: 1,
                    fill: '+1',
                    tension: 0.3,
                    pointRadius: 0
                },
                {
                    label: '10th Percentile (Worst Case)',
                    data: percentilesData[10].map(d => d.netPortfolio),
                    borderColor: '#FF6B6B',
                    backgroundColor: 'rgba(255, 107, 107, 0.15)',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.3,
                    pointRadius: 0
                }
            ];

            const fontSizes = getResponsiveFontSizes();

            window.trendChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: years, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Probability Cone: Net Worth Over Time',
                            font: { size: fontSizes.title, weight: 'normal' },
                            color: getChartTextColor()
                        },
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: getChartTextColor(),
                                usePointStyle: true,
                                padding: window.innerWidth < 768 ? 8 : 12,
                                font: { size: fontSizes.legend }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Year',
                                font: { size: fontSizes.axisTicks },
                                color: getChartTextColor()
                            },
                            ticks: {
                                font: { size: fontSizes.axisTicks },
                                color: getChartTextColor()
                            },
                            grid: { color: getChartGridColor() }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Net Worth ($)',
                                font: { size: fontSizes.axisTicks },
                                color: getChartTextColor()
                            },
                            ticks: {
                                font: { size: fontSizes.axisTicks },
                                color: getChartTextColor(),
                                callback: function(value) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                }
                            },
                            grid: { color: getChartGridColor() }
                        }
                    }
                }
            });
        }

        // Draw SBLOC Balance Chart for Monte Carlo (median path with percentile bands)
        function drawMCSBLOCBalanceChart(percentilesData, params) {
            const ctx = document.getElementById('debtChart');
            if (!ctx) {
                console.error('debtChart canvas element not found');
                return;
            }

            // Destroy existing chart
            if (window.debtChartInstance) {
                window.debtChartInstance.destroy();
            }

            const medianData = percentilesData[50];
            const years = medianData.map(d => d.year);

            const fontSizes = getResponsiveFontSizes();
            const textColor = getChartTextColor();
            const gridColor = getChartGridColor();
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';

            // Color palette
            const balanceColor = isDark ? '#CE93D8' : '#8E24AA';
            const ratioColor = isDark ? '#FFB74D' : '#F57C00';

            window.debtChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: 'SBLOC Balance (Median)',
                            data: medianData.map(d => d.locBalance),
                            backgroundColor: isDark ? 'rgba(206, 147, 216, 0.7)' : 'rgba(142, 36, 170, 0.7)',
                            borderColor: balanceColor,
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'LOC Utilization % (Median)',
                            data: medianData.map(d => d.locUsedPct),
                            type: 'line',
                            borderColor: ratioColor,
                            backgroundColor: 'transparent',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.3,
                            yAxisID: 'y1',
                            pointRadius: 0
                        },
                        {
                            label: `Max Limit (${(params.maxBorrowing * 100).toFixed(0)}%)`,
                            data: Array(years.length).fill(params.maxBorrowing * 100),
                            type: 'line',
                            borderColor: '#DC2626',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            borderDash: [8, 4],
                            fill: false,
                            yAxisID: 'y1',
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'SBLOC Balance & Utilization (Median Scenario)',
                            font: { size: fontSizes.title, weight: 'normal' },
                            color: textColor
                        },
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: textColor,
                                usePointStyle: true,
                                font: { size: fontSizes.legend }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: isDark ? 'rgba(30, 30, 30, 0.95)' : 'rgba(255, 255, 255, 0.95)',
                            titleColor: textColor,
                            bodyColor: textColor,
                            borderColor: gridColor,
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                title: function(tooltipItems) {
                                    return 'Year ' + tooltipItems[0].label;
                                },
                                label: function(context) {
                                    if (context.datasetIndex === 0) {
                                        return context.dataset.label + ': $' +
                                            context.parsed.y.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                                    } else {
                                        return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Year',
                                font: { size: fontSizes.axisTicks },
                                color: textColor
                            },
                            ticks: { color: textColor, font: { size: fontSizes.axisTicks } },
                            grid: { color: gridColor }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: 'SBLOC Balance ($)',
                                font: { size: fontSizes.axisTicks },
                                color: textColor
                            },
                            ticks: {
                                color: textColor,
                                font: { size: fontSizes.axisTicks },
                                callback: function(value) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                }
                            },
                            grid: { color: gridColor }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: 'LOC Utilization (%)',
                                font: { size: fontSizes.axisTicks },
                                color: textColor
                            },
                            ticks: {
                                color: textColor,
                                font: { size: fontSizes.axisTicks },
                                callback: function(value) {
                                    return value.toFixed(0) + '%';
                                }
                            },
                            grid: { display: false },
                            max: Math.max(100, params.maxBorrowing * 100 * 1.2)
                        }
                    }
                }
            });
        }

        // Draw Terminal Value Distribution Histogram
        function drawTerminalDistributionChart(mcResults) {
            const ctx = document.getElementById('terminalDistributionChart');
            if (!ctx) {
                console.error('Canvas element terminalDistributionChart not found');
                return;
            }

            // Destroy existing chart
            if (window.terminalDistributionChartInstance) {
                window.terminalDistributionChartInstance.destroy();
            }

            const { terminalValues, terminalStats } = mcResults;
            console.log('Drawing Terminal Distribution Chart', { numValues: terminalValues.length, min: terminalStats.min, max: terminalStats.max });

            // Create histogram bins
            const numBins = 30;
            const min = terminalStats.min;
            const max = terminalStats.max;
            const binWidth = (max - min) / numBins;
            const bins = Array(numBins).fill(0);
            const binLabels = [];

            for (let i = 0; i < numBins; i++) {
                binLabels.push((min + i * binWidth + binWidth / 2) / 1000000);
            }

            terminalValues.forEach(value => {
                const binIndex = Math.min(Math.floor((value - min) / binWidth), numBins - 1);
                bins[binIndex]++;
            });

            console.log('Terminal Distribution - bins:', bins.length, 'total count:', bins.reduce((a,b) => a+b, 0));

            try {
                window.terminalDistributionChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: binLabels.map(v => v.toFixed(1) + 'M'),
                        datasets: [{
                            label: 'Number of Simulations',
                            data: bins,
                            backgroundColor: '#004C45',
                            borderColor: '#004C45',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Terminal Net Worth Distribution',
                                font: { size: 14, weight: 'normal' },
                                color: getChartTextColor()
                            },
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                callbacks: {
                                    title: function(context) {
                                        return 'Net Worth: $' + context[0].label;
                                    },
                                    label: function(context) {
                                        return context.parsed.y + ' simulations';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Final Net Worth ($M)', color: getChartTextColor() },
                                ticks: { color: getChartTextColor(), maxRotation: 45, minRotation: 45 },
                                grid: { display: false }
                            },
                            y: {
                                title: { display: true, text: 'Frequency', color: getChartTextColor() },
                                ticks: { color: getChartTextColor() },
                                grid: { color: getChartGridColor() }
                            }
                        }
                    }
                });

                console.log('Terminal Distribution Chart created successfully');
            } catch (error) {
                console.error('Error creating Terminal Distribution Chart:', error);
            }
        }

        // Draw Year-by-Year Percentile Table (with withdrawal columns)
        function drawPercentileTable(percentilesData) {
            const resultsDiv = document.getElementById('results');
            let tableCard = resultsDiv.querySelector('.percentile-table-card');

            if (!tableCard) {
                tableCard = document.createElement('div');
                tableCard.className = 'card percentile-table-card';
                tableCard.id = 'section-percentile-table';
                tableCard.style.marginTop = '24px';
                resultsDiv.appendChild(tableCard);
            }

            const percentiles = [10, 25, 50, 75, 90];
            // Use median data for withdrawal values (deterministic - same across all simulations)
            const medianData = percentilesData[50];

            let tableHTML = `
                <div class="section-header"> Year-by-Year Percentile Analysis</div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th colspan="2" style="text-align: center; border-left: 2px solid var(--border-color);">Withdrawals</th>
                                ${percentiles.map((p, i) => `<th${i === 0 ? ' style="border-left: 2px solid var(--border-color);"' : ''}>${p}th %ile Net Worth</th>`).join('')}
                            </tr>
                            <tr>
                                <th></th>
                                <th style="border-left: 2px solid var(--border-color); font-weight: 500; font-size: 0.85em;">Annual</th>
                                <th style="font-weight: 500; font-size: 0.85em;">Cumulative</th>
                                ${percentiles.map((p, i) => `<th${i === 0 ? ' style="border-left: 2px solid var(--border-color);"' : ''}></th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
            `;

            medianData.forEach((yearData, yearIdx) => {
                const year = yearData.year;
                const withdrawal = yearData.withdrawal || 0;
                const cumulative = yearData.cumulativeWithdrawal || 0;

                tableHTML += `<tr>
                    <td>${year}</td>
                    <td style="border-left: 2px solid var(--border-color);">${formatCurrency(withdrawal)}</td>
                    <td>${formatCurrency(cumulative)}</td>`;

                percentiles.forEach((p, i) => {
                    const netWorth = percentilesData[p][yearIdx].netPortfolio;
                    const className = netWorth < 0 ? 'negative' : netWorth > percentilesData[p][0].netPortfolio * 2 ? 'positive' : '';
                    const borderStyle = i === 0 ? ' style="border-left: 2px solid var(--border-color);"' : '';
                    tableHTML += `<td class="${className}"${borderStyle}>${formatCurrency(netWorth)}</td>`;
                });
                tableHTML += '</tr>';
            });

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;

            tableCard.innerHTML = tableHTML;
        }

        // Draw SBLOC Utilization Percentiles Chart
        function drawSBLOCUtilizationChart(percentilesData, params) {
            const ctx = document.getElementById('sblocUtilizationChart');
            if (!ctx) return;

            // Destroy existing chart
            if (window.sblocUtilizationChartInstance) {
                window.sblocUtilizationChartInstance.destroy();
            }

            const years = percentilesData[50].map(d => d.year);
            const percentiles = [10, 25, 50, 75, 90];

            const datasets = percentiles.map((p) => {
                const colors = {
                    10: { color: '#EF4444', label: '10th %ile (Worst)', width: 2 },
                    25: { color: '#FBBF24', label: '25th %ile', width: 1.5 },
                    50: { color: '#4C6FFF', label: '50th %ile (Median)', width: 3 },
                    75: { color: '#22C55E', label: '75th %ile', width: 1.5 },
                    90: { color: '#4ADE80', label: '90th %ile (Best)', width: 2 }
                };

                return {
                    label: colors[p].label,
                    data: percentilesData[p].map(d => d.locUsedPct),
                    borderColor: colors[p].color,
                    backgroundColor: 'transparent',
                    borderWidth: colors[p].width,
                    fill: false,
                    tension: 0.3,
                    pointRadius: 0
                };
            });

            // Add max borrowing limit line
            datasets.push({
                label: `Max Borrowing Limit (${(params.maxBorrowing * 100).toFixed(0)}%)`,
                data: Array(years.length).fill(params.maxBorrowing * 100),
                borderColor: '#DC2626',
                backgroundColor: 'transparent',
                borderWidth: 2,
                borderDash: [8, 4],
                fill: false,
                pointRadius: 0
            });

            const fontSizes = getResponsiveFontSizes();
            const fontConfig = getChartFontConfig(fontSizes);

            // Get current theme colors
            const textColor = getChartTextColor();
            const gridColor = getChartGridColor();

            window.sblocUtilizationChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: years, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        title: {
                            display: true,
                            text: 'SBLOC Usage % Across Simulations',
                            font: fontConfig.title,
                            color: textColor
                        },
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: textColor,
                                usePointStyle: true,
                                padding: window.innerWidth < 768 ? 8 : 10,
                                font: fontConfig.legend
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Year',
                                font: fontConfig.axisTitle,
                                color: textColor
                            },
                            ticks: {
                                font: fontConfig.axisTicks,
                                color: textColor
                            },
                            grid: { color: gridColor }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'SBLOC Utilization %',
                                font: fontConfig.axisTitle,
                                color: textColor
                            },
                            ticks: {
                                font: fontConfig.axisTicks,
                                color: textColor,
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: { color: gridColor }
                        }
                    }
                }
            });
        }

        // Draw Margin Call Risk by Year Chart
        function drawMarginCallRiskChart(mcResults) {
            const ctx = document.getElementById('marginCallRiskChart');
            if (!ctx) {
                console.error('Canvas element marginCallRiskChart not found');
                return;
            }

            if (window.marginCallRiskChartInstance) {
                window.marginCallRiskChartInstance.destroy();
            }

            const { allSimulations, params } = mcResults;
            console.log('Drawing Margin Call Risk Chart', { numSimulations: allSimulations.length, numYears: params.period });
            const numYears = params.period;
            const numSimulations = params.numSimulations;

            // Calculate margin call rate for each year
            const marginCallsByYear = Array(numYears).fill(0);

            allSimulations.forEach(sim => {
                sim.forEach((yearData, index) => {
                    if (yearData.marginCall) {
                        marginCallsByYear[index]++;
                    }
                });
            });

            // Convert to percentages
            const marginCallRates = marginCallsByYear.map(count => (count / numSimulations) * 100);
            const years = Array.from({ length: numYears }, (_, i) => params.startYear + i);

            console.log('Margin Call Rates:', marginCallRates);
            console.log('Years:', years);

            if (marginCallRates.length === 0 || years.length === 0) {
                console.error('Empty data arrays for Margin Call Risk Chart');
                return;
            }

            // Color-code bars based on risk level
            const backgroundColors = marginCallRates.map(rate => {
                if (rate === 0) return '#16A34A'; // Green (no risk)
                if (rate < 10) return '#10B981'; // Teal (low risk)
                if (rate < 25) return '#EAB308'; // Orange (moderate risk)
                return '#EF4444'; // Red (high risk)
            });

            try {
                window.marginCallRiskChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: years,
                        datasets: [{
                            label: 'Margin Call Risk',
                            data: marginCallRates,
                            backgroundColor: backgroundColors,
                            borderColor: backgroundColors.map(c => c),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Percentage of Simulations with Margin Calls by Year',
                                font: { size: 14, weight: 'normal' },
                                color: getChartTextColor()
                            },
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                callbacks: {
                                    label: function(context) {
                                        return 'Margin Call Risk: ' + context.parsed.y.toFixed(1) + '%';
                                    },
                                    afterLabel: function(context) {
                                        const rate = context.parsed.y;
                                        if (rate === 0) return ' No Risk';
                                        if (rate < 10) return ' Low Risk';
                                        if (rate < 25) return ' Moderate Risk';
                                        return ' High Risk';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Year',
                                    color: getChartTextColor()
                                },
                                ticks: {
                                    color: getChartTextColor()
                                },
                                grid: { color: getChartGridColor() }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Margin Call Risk (%)',
                                    color: getChartTextColor()
                                },
                                ticks: {
                                    color: getChartTextColor(),
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                },
                                grid: { color: getChartGridColor() },
                                min: 0,
                                max: 100
                            }
                        }
                    }
                });

                console.log('Margin Call Risk Chart created successfully');
            } catch (error) {
                console.error('Error creating Margin Call Risk Chart:', error);
            }
        }

        // Draw Liquidity Safety Buffer Chart
        function drawLiquiditySafetyBufferChart(liquidityStats, params) {
            const ctx = document.getElementById('liquiditySafetyBufferChart');
            if (!ctx) {
                console.error('Canvas element liquiditySafetyBufferChart not found');
                return;
            }

            // Destroy existing chart
            if (window.liquiditySafetyBufferChartInstance) {
                window.liquiditySafetyBufferChartInstance.destroy();
            }

            const { liquidityData } = liquidityStats;
            const years = liquidityData[50].map(d => d.year);

            // Convert distance to margin call (percentage points) to chart data
            const p10Distance = liquidityData[10].map(d => d.distanceToMarginCall);
            const p50Distance = liquidityData[50].map(d => d.distanceToMarginCall);
            const p90Distance = liquidityData[90].map(d => d.distanceToMarginCall);

            console.log('Drawing Liquidity Safety Buffer Chart', {
                numYears: years.length,
                minDistance: Math.min(...p10Distance),
                maxDistance: Math.max(...p90Distance)
            });

            try {
                window.liquiditySafetyBufferChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: years,
                        datasets: [
                            {
                                label: '10th Percentile (Worst Case)',
                                data: p10Distance,
                                borderColor: '#DC2626',
                                backgroundColor: 'rgba(239, 83, 80, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.1
                            },
                            {
                                label: '50th Percentile (Median)',
                                data: p50Distance,
                                borderColor: '#004C45',
                                backgroundColor: 'rgba(0, 76, 69, 0.2)',
                                borderWidth: 3,
                                fill: false,
                                tension: 0.1
                            },
                            {
                                label: '90th Percentile (Best Case)',
                                data: p90Distance,
                                borderColor: '#16A34A',
                                backgroundColor: 'rgba(102, 187, 106, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Distance to Margin Call Over Time (Percentage Points)',
                                font: { size: 14, weight: 'normal' },
                                color: getChartTextColor()
                            },
                            legend: {
                                display: true,
                                position: 'top',
                                labels: { color: getChartTextColor(), font: { size: 11 } }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                callbacks: {
                                    title: function(context) {
                                        return 'Year: ' + context[0].label;
                                    },
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '% pts';
                                    },
                                    afterBody: function(context) {
                                        const distance = context[0].parsed.y;
                                        if (distance < 10) {
                                            return ' CRITICAL DANGER ZONE';
                                        } else if (distance < 25) {
                                            return ' WARNING ZONE';
                                        } else {
                                            return ' SAFE ZONE';
                                        }
                                    }
                                }
                            },
                            annotation: {
                                annotations: {
                                    dangerZone: {
                                        type: 'box',
                                        yMin: 0,
                                        yMax: 10,
                                        backgroundColor: 'rgba(239, 83, 80, 0.15)',
                                        borderWidth: 0,
                                        label: {
                                            display: true,
                                            content: 'DANGER ZONE',
                                            position: 'start',
                                            color: '#B71C1C',
                                            font: { size: 10, weight: 'bold' }
                                        }
                                    },
                                    warningZone: {
                                        type: 'box',
                                        yMin: 10,
                                        yMax: 25,
                                        backgroundColor: 'rgba(255, 152, 0, 0.1)',
                                        borderWidth: 0,
                                        label: {
                                            display: true,
                                            content: 'WARNING',
                                            position: 'start',
                                            color: '#E65100',
                                            font: { size: 10, weight: 'bold' }
                                        }
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Year', color: getChartTextColor() },
                                ticks: { color: getChartTextColor() },
                                grid: { color: getChartGridColor() }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Distance to Margin Call (% pts - Higher is Safer)',
                                    color: getChartTextColor()
                                },
                                ticks: {
                                    color: getChartTextColor(),
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                },
                                grid: { color: getChartGridColor() },
                                min: 0,
                                max: 100
                            }
                        }
                    }
                });

                console.log('Liquidity Safety Buffer Chart created successfully');

                // Force chart to recalculate dimensions after initialization
                setTimeout(() => {
                    if (window.liquiditySafetyBufferChartInstance) {
                        window.liquiditySafetyBufferChartInstance.resize();
                    }
                }, 0);
            } catch (error) {
                console.error('Error creating Liquidity Safety Buffer Chart:', error);
            }
        }

        // Draw Net Worth Across Simulations (Percentiles) Chart
        function drawNetWorthPercentilesChart(percentilesData) {
            const ctx = document.getElementById('netWorthPercentilesChart');
            if (!ctx) {
                console.error('Canvas element netWorthPercentilesChart not found');
                return;
            }

            // Destroy existing chart
            if (window.netWorthPercentilesChartInstance) {
                window.netWorthPercentilesChartInstance.destroy();
            }

            const years = percentilesData[50].map(d => d.year);

            // Create datasets for percentile lines with fill between bands
            const datasets = [
                {
                    label: '90th Percentile (Best Case)',
                    data: percentilesData[90].map(d => d.netPortfolio),
                    borderColor: '#16A34A',
                    backgroundColor: 'rgba(22, 163, 74, 0.15)',
                    borderWidth: 2,
                    fill: '+1',
                    tension: 0.3,
                    pointRadius: 0
                },
                {
                    label: '75th Percentile',
                    data: percentilesData[75].map(d => d.netPortfolio),
                    borderColor: '#10B981',
                    backgroundColor: 'rgba(16, 185, 129, 0.12)',
                    borderWidth: 1.5,
                    fill: '+1',
                    tension: 0.3,
                    pointRadius: 0
                },
                {
                    label: '50th Percentile (Median)',
                    data: percentilesData[50].map(d => d.netPortfolio),
                    borderColor: '#004C45',
                    backgroundColor: 'transparent',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.3,
                    pointRadius: 0
                },
                {
                    label: '25th Percentile',
                    data: percentilesData[25].map(d => d.netPortfolio),
                    borderColor: '#EAB308',
                    backgroundColor: 'rgba(234, 179, 8, 0.12)',
                    borderWidth: 1.5,
                    fill: '+1',
                    tension: 0.3,
                    pointRadius: 0
                },
                {
                    label: '10th Percentile (Worst Case)',
                    data: percentilesData[10].map(d => d.netPortfolio),
                    borderColor: '#EF4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.15)',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.3,
                    pointRadius: 0
                }
            ];

            console.log('Drawing Net Worth Percentiles Chart', {
                numYears: years.length,
                percentiles: Object.keys(percentilesData)
            });

            try {
                window.netWorthPercentilesChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: years,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Probability Cone: Net Worth Over Time',
                                font: { size: 14, weight: 'normal' },
                                color: getChartTextColor()
                            },
                            legend: {
                                display: true,
                                position: 'bottom',
                                labels: {
                                    color: getChartTextColor(),
                                    usePointStyle: true,
                                    padding: window.innerWidth < 768 ? 8 : 12,
                                    font: { size: 11 }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                callbacks: {
                                    title: function(context) {
                                        return 'Year: ' + context[0].label;
                                    },
                                    label: function(context) {
                                        const value = context.parsed.y;
                                        const formatted = value >= 0
                                            ? '$' + value.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })
                                            : '-$' + Math.abs(value).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                                        return context.dataset.label + ': ' + formatted;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Year',
                                    color: getChartTextColor()
                                },
                                ticks: {
                                    color: getChartTextColor()
                                },
                                grid: {
                                    color: getChartGridColor()
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Net Worth ($)',
                                    color: getChartTextColor()
                                },
                                ticks: {
                                    color: getChartTextColor(),
                                    callback: function(value) {
                                        return '$' + (value / 1000000).toFixed(1) + 'M';
                                    }
                                },
                                grid: {
                                    color: getChartGridColor()
                                }
                            }
                        }
                    }
                });

                console.log('Net Worth Percentiles Chart created successfully');
            } catch (error) {
                console.error('Error creating Net Worth Percentiles Chart:', error);
            }
        }

        // Display BBD vs Sell Assets Strategy Comparison
        function displayStrategyComparison(mcResults) {
            const strategySection = document.getElementById('strategyAnalysisSection');
            if (!strategySection) return;

            const { sellStrategyStats, terminalStats, successRate, marginCallRate, percentilesData, medianBBDDividendTax } = mcResults;
            if (!sellStrategyStats) return;

            // Show consolidated strategy analysis section
            strategySection.style.display = 'block';

            // Get input parameters
            const annualWithdrawalForCalc = parseFloat(document.getElementById('annualWithdrawal').value);
            const sblocRateForCalc = parseFloat(document.getElementById('sblocRate').value) / 100;
            const periodForCalc = parseInt(document.getElementById('period').value);
            const numSimulations = parseInt(document.getElementById('numSimulations').value);
            const startValue = parseFloat(document.getElementById('startValue').value);
            const maxBorrowing = parseFloat(document.getElementById('maxBorrowing').value) / 100;
            const maintenanceMargin = parseFloat(document.getElementById('maintenanceMargin').value) / 100;
            const sblocRate = sblocRateForCalc;
            const period = periodForCalc;
            const annualWithdrawal = annualWithdrawalForCalc;

            // Update header subtitle
            const startYear = parseInt(document.getElementById('startYear').value);
            document.getElementById('saSubtitle').textContent =
                `Based on ${numSimulations.toLocaleString()} Monte Carlo simulations over ${period} years (${startYear}-${startYear + period})`;

            // Calculate key metrics
            const terminalDiff = terminalStats.median - sellStrategyStats.terminalStats.median;
            const taxSavings = sellStrategyStats.medianTaxesPaid;
            const sellSuccessRateValue = sellStrategyStats.successRate ?? 100;
            const sellFailureRateValue = sellStrategyStats.failureRate ?? 0;
            const medianAdvantage = ((terminalDiff / sellStrategyStats.terminalStats.median) * 100).toFixed(1);
            const withdrawalRate = (annualWithdrawal / startValue * 100).toFixed(2);
            const maxLocAvailable = startValue * maxBorrowing;
            const locHeadroom = ((maxLocAvailable - annualWithdrawal) / maxLocAvailable * 100).toFixed(1);

            // Calculate cumulative interest
            let theoreticalDebtForSummary = 0;
            for (let i = 0; i < periodForCalc; i++) {
                theoreticalDebtForSummary *= (1 + sblocRateForCalc);
                theoreticalDebtForSummary += annualWithdrawalForCalc;
            }
            const totalWithdrawalsForSummary = annualWithdrawalForCalc * periodForCalc;
            const cumulativeInterestLifetime = Math.max(0, theoreticalDebtForSummary - totalWithdrawalsForSummary);

            // Determine verdict based on nuanced criteria
            let verdictClass, verdictIcon, verdictHeadline, verdictRationale;
            const successRateGap = sellSuccessRateValue - successRate;

            if (terminalDiff > 0 && successRate >= 75) {
                verdictClass = 'favorable';
                verdictIcon = 'check';
                verdictHeadline = 'BBD Recommended';
                verdictRationale = `BBD strategy shows strong advantage with +${medianAdvantage}% higher median wealth and ${successRate.toFixed(1)}% success rate`;
            } else if (terminalDiff > 0 && successRate >= 60) {
                verdictClass = 'favorable';
                verdictIcon = 'check';
                verdictHeadline = 'BBD Favorable';
                verdictRationale = `BBD edges ahead with +${medianAdvantage}% higher median wealth, though ${marginCallRate.toFixed(1)}% margin call risk warrants consideration`;
            } else if (successRateGap > 15 || (terminalDiff > 0 && successRate >= 50 && successRate < 60)) {
                verdictClass = 'consider-both';
                verdictIcon = 'balance';
                verdictHeadline = 'Consider Both Strategies';
                verdictRationale = `Trade-offs exist: BBD offers ${terminalDiff >= 0 ? '+' : ''}${medianAdvantage}% wealth advantage but Sell Assets has ${successRateGap.toFixed(1)}% higher success rate`;
            } else if (terminalDiff <= 0 || successRate < 50) {
                verdictClass = 'unfavorable';
                verdictIcon = 'account_balance';
                verdictHeadline = 'Sell Assets Favorable';
                verdictRationale = `Sell Assets provides better risk-adjusted outcome with ${sellSuccessRateValue.toFixed(1)}% success rate and lower leverage risk`;
            } else {
                verdictClass = 'moderate';
                verdictIcon = 'warning';
                verdictHeadline = 'BBD Has Moderate Risk';
                verdictRationale = `BBD offers potential upside but ${marginCallRate.toFixed(1)}% margin call risk requires careful consideration`;
            }

            // Update verdict banner
            const verdictBanner = document.getElementById('saVerdictBanner');
            verdictBanner.className = 'sa-verdict-banner ' + verdictClass;
            document.getElementById('saVerdictIcon').textContent = verdictIcon;
            document.getElementById('saVerdictHeadline').textContent = verdictHeadline;
            document.getElementById('saVerdictRationale').textContent = verdictRationale;

            // Update success dial
            const dialCircumference = 157;
            const dialOffset = dialCircumference - (dialCircumference * successRate / 100);
            document.getElementById('saDialProgress').setAttribute('stroke-dashoffset', dialOffset);
            document.getElementById('saDialValue').textContent = successRate.toFixed(0) + '%';

            // Populate BBD metrics
            document.getElementById('bbdTerminalMedian').textContent = formatCurrency(terminalStats.median);

            const bbdSuccessRateEl = document.getElementById('bbdSuccessRate');
            bbdSuccessRateEl.textContent = successRate.toFixed(1) + '%';
            // Apply color coding based on success rate thresholds
            if (successRate >= 95) {
                bbdSuccessRateEl.style.color = 'var(--success)';
            } else if (successRate >= 80) {
                bbdSuccessRateEl.style.color = 'var(--warning)';
            } else {
                bbdSuccessRateEl.style.color = 'var(--error)';
            }

            document.getElementById('bbdCumulativeInterest').textContent = formatCurrency(cumulativeInterestLifetime);
            document.getElementById('bbdDividendTaxes').textContent = formatCurrency(medianBBDDividendTax || 0);

            const riskColor = marginCallRate >= 20 ? 'var(--error)' : marginCallRate >= 10 ? 'var(--warning)' : 'var(--success)';
            const bbdRiskEl = document.getElementById('bbdRiskFactor');
            bbdRiskEl.textContent = marginCallRate.toFixed(1) + '% margin call';
            bbdRiskEl.style.color = riskColor;

            // Populate Sell metrics
            document.getElementById('sellTerminalMedian').textContent = formatCurrency(sellStrategyStats.terminalStats.median);
            document.getElementById('sellTaxesPaid').textContent = formatCurrency(sellStrategyStats.medianTaxesPaid);

            const sellSuccessRateEl = document.getElementById('sellSuccessRate');
            const sellSuccessRateSubtextEl = document.getElementById('sellSuccessRateSubtext');
            const sellRiskFactorEl = document.getElementById('sellRiskFactor');

            if (sellSuccessRateEl) {
                sellSuccessRateEl.textContent = sellSuccessRateValue.toFixed(1) + '%';
                if (sellSuccessRateValue >= 95) {
                    sellSuccessRateEl.style.color = 'var(--success)';
                } else if (sellSuccessRateValue >= 80) {
                    sellSuccessRateEl.style.color = 'var(--warning)';
                } else {
                    sellSuccessRateEl.style.color = 'var(--error)';
                }
            }

            if (sellSuccessRateSubtextEl) {
                if (sellFailureRateValue > 0) {
                    sellSuccessRateSubtextEl.textContent = `${sellFailureRateValue.toFixed(1)}% portfolio depletion risk`;
                    sellSuccessRateSubtextEl.style.color = 'var(--warning)';
                } else {
                    sellSuccessRateSubtextEl.textContent = 'No portfolio depletion';
                    sellSuccessRateSubtextEl.style.color = '';
                }
            }

            if (sellRiskFactorEl) {
                if (sellFailureRateValue === 0) {
                    sellRiskFactorEl.textContent = 'None (No depletion risk)';
                    sellRiskFactorEl.style.color = 'var(--success)';
                } else if (sellFailureRateValue < 5) {
                    sellRiskFactorEl.textContent = `Low (${sellFailureRateValue.toFixed(1)}% depletion)`;
                    sellRiskFactorEl.style.color = 'var(--success)';
                } else if (sellFailureRateValue < 15) {
                    sellRiskFactorEl.textContent = `Moderate (${sellFailureRateValue.toFixed(1)}% depletion)`;
                    sellRiskFactorEl.style.color = 'var(--warning)';
                } else {
                    sellRiskFactorEl.textContent = `High (${sellFailureRateValue.toFixed(1)}% depletion)`;
                    sellRiskFactorEl.style.color = 'var(--error)';
                }
            }

            // Populate differential cards
            document.getElementById('taxSavingsAmount').textContent = formatCurrency(taxSavings);

            const terminalDiffEl = document.getElementById('terminalDifference');
            terminalDiffEl.textContent = (terminalDiff >= 0 ? '+' : '') + formatCurrency(terminalDiff);
            terminalDiffEl.style.color = terminalDiff >= 0 ? 'var(--success)' : 'var(--error)';

            const estateDiffEl = document.getElementById('estateValueDiff');
            estateDiffEl.textContent = formatCurrency(terminalStats.median);
            estateDiffEl.style.color = 'var(--success)';

            // Populate explanation section
            const explanationTitle = terminalDiff > 0 ? 'Why BBD Performs Well in Your Scenario' : 'Why Sell Assets Performs Better';
            document.getElementById('saExplanationTitle').textContent = explanationTitle;

            document.getElementById('saInsightQuote').textContent =
                `"${successRate.toFixed(1)}% of scenarios avoid margin calls while achieving ${terminalDiff >= 0 ? '+' : ''}${medianAdvantage}% ${terminalDiff >= 0 ? 'higher' : 'lower'} median wealth versus selling assets."`;

            document.getElementById('saInsightText').textContent =
                `Your ${withdrawalRate}% withdrawal rate on a ${formatCurrency(startValue)} portfolio ${terminalDiff > 0 ? 'creates favorable borrowing conditions' : 'presents challenges for leverage'}. With ${formatCurrency(maxLocAvailable)} in borrowing capacity (${(maxBorrowing * 100).toFixed(0)}% LOC limit) and ${locHeadroom}% headroom above your ${formatCurrency(annualWithdrawal)} annual need, the ${(maintenanceMargin * 100).toFixed(0)}% maintenance margin threshold results in ${marginCallRate.toFixed(1)}% margin call probability across ${period} years.`;

            // Populate benefit cards
            document.getElementById('saTaxDeferralValue').textContent = formatCurrency(taxSavings);
            document.getElementById('saTaxDeferralText').textContent =
                taxSavings > 0
                    ? `By borrowing instead of selling, your entire portfolio remains invested. The Sell strategy must liquidate extra assets annually for capital gains taxes, removing approximately ${formatCurrency(taxSavings)} over ${period} years.`
                    : `By borrowing instead of selling, your ${formatCurrency(startValue)} portfolio remains fully invested and compounds.`;

            document.getElementById('saCompoundingValue').textContent = formatCurrency(Math.abs(terminalDiff));
            document.getElementById('saCompoundingText').textContent =
                taxSavings > 0
                    ? `Tax drag on sold assets compounds over ${period} years at market rates into the ${Math.abs(parseFloat(medianAdvantage)).toFixed(1)}% difference observed in median outcomes.`
                    : `By preserving capital that would otherwise be withdrawn, BBD allows full compounding over the ${period}-year period.`;

            // Populate considerations list
            const considerationsList = document.getElementById('saConsiderationsList');
            considerationsList.innerHTML = `
                <div class="sa-consideration-item">
                    <div class="sa-consideration-icon warning">
                        <span class="material-icons">trending_up</span>
                    </div>
                    <div class="sa-consideration-content">
                        <div class="sa-consideration-title">Margin Call Risk (${marginCallRate.toFixed(1)}%)</div>
                        <div class="sa-consideration-text"><span class="sa-consideration-label warning">Warning:</span> In ${Math.round(marginCallRate)} out of 100 scenarios, forced liquidation during market downturns can significantly impair wealth accumulation.</div>
                    </div>
                </div>
                <div class="sa-consideration-item">
                    <div class="sa-consideration-icon warning">
                        <span class="material-icons">shuffle</span>
                    </div>
                    <div class="sa-consideration-content">
                        <div class="sa-consideration-title">Sequence of Returns Risk</div>
                        <div class="sa-consideration-text"><span class="sa-consideration-label warning">Warning:</span> Early market crashes have disproportionate impact on leverage strategies; success depends heavily on timing.</div>
                    </div>
                </div>
                <div class="sa-consideration-item">
                    <div class="sa-consideration-icon info">
                        <span class="material-icons">percent</span>
                    </div>
                    <div class="sa-consideration-content">
                        <div class="sa-consideration-title">Interest Rate Sensitivity</div>
                        <div class="sa-consideration-text"><span class="sa-consideration-label note">Note:</span> If SBLOC rates rise significantly above ${(sblocRate * 100).toFixed(2)}%, the strategy becomes less attractive.</div>
                    </div>
                </div>
                <div class="sa-consideration-item">
                    <div class="sa-consideration-icon info">
                        <span class="material-icons">psychology</span>
                    </div>
                    <div class="sa-consideration-content">
                        <div class="sa-consideration-title">Behavioral Factors</div>
                        <div class="sa-consideration-text"><span class="sa-consideration-label note">Note:</span> Borrowing against volatile assets can be psychologically challenging during market downturns.</div>
                    </div>
                </div>
                <div class="sa-consideration-item">
                    <div class="sa-consideration-icon info">
                        <span class="material-icons">gavel</span>
                    </div>
                    <div class="sa-consideration-content">
                        <div class="sa-consideration-title">Regulatory Risk</div>
                        <div class="sa-consideration-text"><span class="sa-consideration-label note">Note:</span> Lender policies, margin requirements, or tax laws may change over ${period} years.</div>
                    </div>
                </div>
                <div class="sa-consideration-item">
                    <div class="sa-consideration-icon action">
                        <span class="material-icons">account_balance_wallet</span>
                    </div>
                    <div class="sa-consideration-content">
                        <div class="sa-consideration-title">Liquidity Constraints</div>
                        <div class="sa-consideration-text"><span class="sa-consideration-label action">Action:</span> Ensure you have emergency reserves separate from this leveraged portfolio.</div>
                    </div>
                </div>
            `;

            // Generate dynamic next steps based on portfolio status
            const generateDynamicNextSteps = () => {
                const steps = [];

                // Determine portfolio risk level
                const isCritical = successRate < 40 || marginCallRate > 40;
                const isWarning = !isCritical && (successRate < 60 || marginCallRate > 20);
                const isModerate = !isCritical && !isWarning && ((successRate >= 60 && successRate < 80) || (marginCallRate > 10 && marginCallRate <= 20));
                const isLowRisk = !isCritical && !isWarning && !isModerate;

                // Determine CSS class based on risk
                const riskClass = isCritical ? 'critical' : isWarning ? 'warning' : '';

                if (isCritical || isWarning) {
                    // High Risk: Focus on reducing risk

                    // Calculate dynamic optimal withdrawal based on target success rate
                    const targetSuccessRate = isCritical ? 90 : 80; // Critical: aim for 90%, Warning: aim for 80%
                    const successGap = targetSuccessRate - successRate;

                    // Heuristic: Each 1% withdrawal reduction improves success rate by ~0.7-1.0%
                    // Use conservative 0.75 multiplier for estimation
                    const estimatedReductionNeeded = Math.min(successGap / 0.75, 30); // Cap at 30% max

                    // Round to nearest 5% for cleaner recommendations
                    const recommendedReduction = Math.ceil(estimatedReductionNeeded / 5) * 5;
                    const reductionMultiplier = 1 - (recommendedReduction / 100);
                    const newWithdrawal = Math.round(annualWithdrawal * reductionMultiplier);

                    steps.push({
                        icon: '<span class="material-icons">payments</span>',
                        title: 'Reduce Annual Withdrawal',
                        text: `Lower from $${annualWithdrawal.toLocaleString()} to $${newWithdrawal.toLocaleString()} (${recommendedReduction}% reduction) to target ${targetSuccessRate}% success rate`,
                        riskClass
                    });
                    steps.push({
                        icon: '<span class="material-icons">trending_down</span>',
                        title: 'Lower Maximum LTV',
                        text: `Reduce max LTV from ${(maxBorrowing * 100).toFixed(0)}% to ${Math.max(40, (maxBorrowing * 100) - 10).toFixed(0)}% for safety buffer`,
                        riskClass
                    });
                    steps.push({
                        icon: '<span class="material-icons">account_balance_wallet</span>',
                        title: 'Build Cash Buffer',
                        text: `Set aside $${Math.round(annualWithdrawal * 2).toLocaleString()} for 2 years of emergency reserves`,
                        riskClass
                    });
                    steps.push({
                        icon: '<span class="material-icons">swap_horiz</span>',
                        title: 'Consider Sell Assets',
                        text: `${sellSuccessRateValue.toFixed(1)}% success rate may be more suitable for your risk tolerance`,
                        riskClass
                    });
                } else if (isModerate) {
                    // Moderate Risk: Fine-tuning recommended

                    // Calculate dynamic optimal withdrawal for moderate risk
                    const targetSuccessRate = 85; // Moderate: aim for 85%
                    const successGap = targetSuccessRate - successRate;

                    // Only recommend reduction if below target
                    if (successGap > 0) {
                        // Heuristic: Each 1% withdrawal reduction improves success rate by ~0.75%
                        const estimatedReductionNeeded = Math.min(successGap / 0.75, 20); // Cap at 20% for moderate

                        // Round to nearest 1% for precision (smaller adjustments)
                        const recommendedReduction = Math.max(1, Math.round(estimatedReductionNeeded));
                        const reductionMultiplier = 1 - (recommendedReduction / 100);
                        const newWithdrawal = Math.round(annualWithdrawal * reductionMultiplier);

                        steps.push({
                            icon: '<span class="material-icons">tune</span>',
                            title: 'Fine-tune Withdrawal',
                            text: `Reduce from $${annualWithdrawal.toLocaleString()} to $${newWithdrawal.toLocaleString()} (${recommendedReduction}% reduction) to target ${targetSuccessRate}% success rate`,
                            riskClass: ''
                        });
                    } else {
                        // Already at or above target - suggest optimization
                        steps.push({
                            icon: '<span class="material-icons">tune</span>',
                            title: 'Optimize Withdrawal',
                            text: `Consider increasing withdrawal slightly or reallocating to reduce volatility`,
                            riskClass: ''
                        });
                    }
                    steps.push({
                        icon: '<span class="material-icons">balance</span>',
                        title: 'Adjust Portfolio Weights',
                        text: 'Optimize asset allocation to balance risk/return trade-offs',
                        riskClass: ''
                    });
                    steps.push({
                        icon: '<span class="material-icons">build</span>',
                        title: 'Review Leverage Settings',
                        text: `Consider lowering max LTV or building a $${Math.round(annualWithdrawal * 1.5).toLocaleString()} cash buffer`,
                        riskClass: ''
                    });
                    steps.push({
                        icon: '<span class="material-icons">receipt_long</span>',
                        title: 'Tax Professional',
                        text: 'Optimize SBLOC structure and dividend/interest tax efficiency',
                        riskClass: ''
                    });
                } else {
                    // Low Risk: Standard professional advice
                    steps.push({
                        icon: '<span class="material-icons">bar_chart</span>',
                        title: 'Review Charts',
                        text: 'Examine probability cone and terminal value distribution',
                        riskClass: ''
                    });
                    steps.push({
                        icon: '<span class="material-icons">balance</span>',
                        title: 'Adjust Weights',
                        text: 'Optimize portfolio allocation for risk/return',
                        riskClass: ''
                    });
                    steps.push({
                        icon: '<span class="material-icons">gavel</span>',
                        title: 'Estate Attorney',
                        text: 'Structure the strategy properly for your estate',
                        riskClass: ''
                    });
                    steps.push({
                        icon: '<span class="material-icons">receipt_long</span>',
                        title: 'Tax Professional',
                        text: 'Optimize SBLOC structure for tax efficiency',
                        riskClass: ''
                    });
                }

                return steps;
            };

            // Populate next steps grid
            const nextStepsGrid = document.getElementById('saNextStepsGrid');
            if (nextStepsGrid) {
                const steps = generateDynamicNextSteps();
                nextStepsGrid.innerHTML = steps.map(step => `
                    <div class="sa-next-step-card ${step.riskClass}">
                        <span class="sa-next-step-icon">${step.icon}</span>
                        <span class="sa-next-step-title">${step.title}</span>
                        <span class="sa-next-step-text">${step.text}</span>
                    </div>
                `).join('');
            }

            // Create comparison charts
            createComparisonCharts(mcResults);
        }

        // Legacy recommendation code removed - now integrated into Strategy Analysis section
        // The old generateLegacyRecommendation function and its 600+ lines of HTML templates
        // have been consolidated into the displayStrategyComparison function above

        /* BEGIN DEAD CODE - Safe to remove entirely
        if (false) {
            const _placeholder = `Why It Works Section...`;

                        <!-- Benefit Cards -->
                        <div class="sr-section-header">How BBD Creates Wealth Advantage</div>
                        <div class="sr-benefits-grid">
                            <div class="sr-benefit-card">
                                <div class="sr-benefit-header">
                                    <div class="sr-benefit-icon teal"></div>
                                    <div class="sr-benefit-title">Tax Deferral Benefit</div>
                                </div>
                                <div class="sr-benefit-value">${formatCurrency(taxSavings)}</div>
                                <div class="sr-benefit-text">
                                    ${taxSavings > 0
                                        ? `By borrowing instead of selling, your entire portfolio remains invested. The Sell strategy must liquidate extra assets annually for capital gains taxes, removing approximately ${formatCurrency(taxSavings)} over ${period} years.`
                                        : `By borrowing instead of selling, your ${formatCurrency(startValue)} portfolio remains fully invested and compounds.`}
                                </div>
                            </div>
                            <div class="sr-benefit-card">
                                <div class="sr-benefit-header">
                                    <div class="sr-benefit-icon purple"></div>
                                    <div class="sr-benefit-title">Compounding Advantage</div>
                                </div>
                                <div class="sr-benefit-value">${formatCurrency(Math.abs(terminalDiff))}</div>
                                <div class="sr-benefit-text">
                                    ${taxSavings > 0
                                        ? `Tax drag on sold assets compounds over ${period} years at market rates into the ${medianAdvantage}% difference observed in median outcomes.`
                                        : `By preserving capital that would otherwise be withdrawn, BBD allows full compounding over the ${period}-year period.`}
                                </div>
                            </div>
                        </div>
                        <div class="sr-benefit-note">
                            Note: This analysis assumes consistent tax rates and that investment returns exceed borrowing costs on average,
                            which has historically been true for diversified equity portfolios but is not guaranteed for any future period.
                        </div>

                        <!-- Actionable Insights -->
                        <div class="sr-section-header">Important Considerations</div>
                        <div class="sr-insights-container">
                            <div class="sr-insights-header">
                                <div class="sr-insights-title">
                                    <span class="material-icons">lightbulb</span>
                                    Actionable Insights
                                </div>
                                <span class="sr-insights-count">6</span>
                            </div>
                            <div class="sr-risks-list">
                                <div class="sr-risk-card">
                                    <div class="sr-risk-icon high">
                                        <span class="material-icons">trending_up</span>
                                    </div>
                                    <div class="sr-risk-content">
                                        <div class="sr-risk-title">Margin Call Risk (${marginCallRate.toFixed(1)}%)</div>
                                        <div class="sr-risk-text"><span class="sr-risk-label warning">Warning:</span> In ${Math.round(marginCallRate)} out of 100 scenarios, forced liquidation during market downturns can significantly impair wealth accumulation.</div>
                                    </div>
                                </div>
                                <div class="sr-risk-card">
                                    <div class="sr-risk-icon high">
                                        <span class="material-icons">shuffle</span>
                                    </div>
                                    <div class="sr-risk-content">
                                        <div class="sr-risk-title">Sequence of Returns Risk</div>
                                        <div class="sr-risk-text"><span class="sr-risk-label warning">Warning:</span> Early market crashes have disproportionate impact on leverage strategies; success depends heavily on timing.</div>
                                    </div>
                                </div>
                                <div class="sr-risk-card">
                                    <div class="sr-risk-icon medium">
                                        <span class="material-icons">percent</span>
                                    </div>
                                    <div class="sr-risk-content">
                                        <div class="sr-risk-title">Interest Rate Sensitivity</div>
                                        <div class="sr-risk-text"><span class="sr-risk-label note">Note:</span> If SBLOC rates rise significantly above ${(sblocRate * 100).toFixed(2)}%, the strategy becomes less attractive.</div>
                                    </div>
                                </div>
                                <div class="sr-risk-card">
                                    <div class="sr-risk-icon medium">
                                        <span class="material-icons">psychology</span>
                                    </div>
                                    <div class="sr-risk-content">
                                        <div class="sr-risk-title">Behavioral Factors</div>
                                        <div class="sr-risk-text"><span class="sr-risk-label note">Note:</span> Borrowing against volatile assets can be psychologically challenging during market downturns.</div>
                                    </div>
                                </div>
                                <div class="sr-risk-card">
                                    <div class="sr-risk-icon low">
                                        <span class="material-icons">gavel</span>
                                    </div>
                                    <div class="sr-risk-content">
                                        <div class="sr-risk-title">Regulatory Risk</div>
                                        <div class="sr-risk-text"><span class="sr-risk-label note">Note:</span> Lender policies, margin requirements, or tax laws may change over ${period} years.</div>
                                    </div>
                                </div>
                                <div class="sr-risk-card">
                                    <div class="sr-risk-icon low">
                                        <span class="material-icons">account_balance_wallet</span>
                                    </div>
                                    <div class="sr-risk-content">
                                        <div class="sr-risk-title">Liquidity Constraints</div>
                                        <div class="sr-risk-text"><span class="sr-risk-label action">Action:</span> Ensure you have emergency reserves separate from this leveraged portfolio.</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Alternative Approaches -->
                        <div class="sr-section-header">Alternative Approaches to Consider</div>
                        <div class="sr-alternatives-grid">
                            <div class="sr-alternative-card">
                                <span class="sr-alternative-icon"></span>
                                <div class="sr-alternative-title">Hybrid Strategy</div>
                                <div class="sr-alternative-text">Use BBD for 60-70% of withdrawals and sell assets for the remainder</div>
                            </div>
                            <div class="sr-alternative-card">
                                <span class="sr-alternative-icon"></span>
                                <div class="sr-alternative-title">Dynamic Approach</div>
                                <div class="sr-alternative-text">Switch to selling if SBLOC rates spike or portfolio drops significantly</div>
                            </div>
                            <div class="sr-alternative-card">
                                <span class="sr-alternative-icon"></span>
                                <div class="sr-alternative-title">Tax-Optimized Selling</div>
                                <div class="sr-alternative-text">Use tax-loss harvesting, qualified dividends, and Roth conversions</div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (terminalDiff > 0 && successRate >= 50) {
                // Calculate required changes for safer profile
                const targetWithdrawalForSafety = startValue * 0.03;
                const withdrawalReduction = annualWithdrawal - targetWithdrawalForSafety;
                const targetPortfolioForCurrentWithdrawal = annualWithdrawal / 0.03;
                const portfolioIncrease = targetPortfolioForCurrentWithdrawal - startValue;

                // Calculate dial ring progress
                const dialCircumference = 157;
                const dialOffset = dialCircumference - (dialCircumference * successRate / 100);

                recommendation = `
                    <!-- Status Banner -->
                    <div class="sr-status-banner moderate">
                        <div class="sr-status-icon moderate"></div>
                        <div class="sr-status-content">
                            <h3 class="sr-status-headline">BBD Strategy Has Moderate Risk with Potential Upside</h3>
                            <p class="sr-status-subtext">Based on ${numSimulations.toLocaleString()} Monte Carlo simulations</p>
                        </div>
                        <div class="sr-success-dial">
                            <div class="sr-dial-ring">
                                <svg width="64" height="64" viewBox="0 0 64 64">
                                    <circle class="bg-ring" cx="32" cy="32" r="25" fill="none" stroke-width="6"/>
                                    <circle class="progress-ring" cx="32" cy="32" r="25" fill="none" stroke-width="6"
                                        stroke-dasharray="${dialCircumference}" stroke-dashoffset="${dialOffset}" style="stroke: var(--warning);"/>
                                </svg>
                                <div class="sr-dial-value">${successRate.toFixed(0)}%</div>
                            </div>
                            <span class="sr-dial-label">Success</span>
                        </div>
                    </div>

                    <!-- Disclaimer -->
                    <div class="sr-disclaimer">
                        <div class="sr-disclaimer-icon">!</div>
                        <div class="sr-disclaimer-text">
                            <span class="sr-disclaimer-tag">Simulation-Based</span>
                            This scenario presents a meaningful risk-reward tradeoff that requires careful consideration of your personal circumstances.
                        </div>
                    </div>

                    <div class="sr-content">
                        <!-- Hero Metrics Grid -->
                        <div class="sr-metrics-grid">
                            <div class="sr-metric-card">
                                <span class="sr-metric-icon"></span>
                                <div class="sr-metric-label">Outcome Advantage</div>
                                <div class="sr-metric-value positive">+${formatCurrency(Math.abs(terminalDiff))}</div>
                                <div class="sr-metric-delta">+${medianAdvantage}% vs Sell</div>
                            </div>
                            <div class="sr-metric-card">
                                <span class="sr-metric-icon"></span>
                                <div class="sr-metric-label">Success Rate</div>
                                <div class="sr-metric-value" style="color: var(--warning);">${successRate.toFixed(1)}%</div>
                                <div class="sr-metric-delta negative">${Math.round(marginCallRate)} of 100 face margin calls</div>
                            </div>
                            <div class="sr-metric-card">
                                <span class="sr-metric-icon"></span>
                                <div class="sr-metric-label">Tax Savings</div>
                                <div class="sr-metric-value">${formatCurrency(taxSavings)}</div>
                                <div class="sr-metric-delta">~${formatCurrency(annualTaxCost)}/year</div>
                            </div>
                            <div class="sr-metric-card">
                                <span class="sr-metric-icon"></span>
                                <div class="sr-metric-label">Margin Call Risk</div>
                                <div class="sr-metric-value negative">${marginCallRate.toFixed(1)}%</div>
                                <div class="sr-metric-delta negative">of scenarios</div>
                            </div>
                        </div>

                        <!-- Understanding Section -->
                        <div class="sr-section-header">Understanding the Risk-Reward Tradeoff</div>
                        <div class="sr-insight-card" style="border-color: rgba(234, 179, 8, 0.2);">
                            <div class="sr-insight-quote" style="border-left-color: var(--warning);">
                                "BBD delivers ${medianAdvantage}% higher median wealth, but achieves this in only ${successRate.toFixed(1)}% of scenarios."
                            </div>
                            <div class="sr-insight-text">
                                Your ${withdrawalRate}% withdrawal rate creates tension between tax efficiency and leverage safety.
                                With ${formatCurrency(maxLocAvailable)} LOC capacity and ${locHeadroom}% headroom, significant market downturns (20-30% drops)
                                can breach the ${(maintenanceMargin * 100).toFixed(0)}% maintenance threshold, triggering forced liquidations.
                            </div>
                        </div>

                        <!-- Actionable Insights -->
                        <div class="sr-section-header">Key Considerations</div>
                        <div class="sr-insights-container">
                            <div class="sr-insights-header">
                                <div class="sr-insights-title">
                                    <span class="material-icons">lightbulb</span>
                                    Actionable Insights
                                </div>
                                <span class="sr-insights-count">3</span>
                            </div>
                            <div class="sr-risks-list">
                                <div class="sr-risk-card">
                                    <div class="sr-risk-icon high">
                                        <span class="material-icons">trending_up</span>
                                    </div>
                                    <div class="sr-risk-content">
                                        <div class="sr-risk-title">Margin Call Risk (${marginCallRate.toFixed(1)}%)</div>
                                        <div class="sr-risk-text"><span class="sr-risk-label warning">Warning:</span> In ${Math.round(marginCallRate)} out of 100 scenarios, forced liquidation during downturns significantly impairs outcomes.</div>
                                    </div>
                                </div>
                                <div class="sr-risk-card">
                                    <div class="sr-risk-icon medium">
                                        <span class="material-icons">psychology</span>
                                    </div>
                                    <div class="sr-risk-content">
                                        <div class="sr-risk-title">Risk Tolerance Required</div>
                                        <div class="sr-risk-text"><span class="sr-risk-label note">Note:</span> Are you comfortable with ${marginCallRate.toFixed(1)}% chance of forced liquidation for ${medianAdvantage}% higher median wealth?</div>
                                    </div>
                                </div>
                                <div class="sr-risk-card">
                                    <div class="sr-risk-icon medium">
                                        <span class="material-icons">spa</span>
                                    </div>
                                    <div class="sr-risk-content">
                                        <div class="sr-risk-title">Behavioral Challenge</div>
                                        <div class="sr-risk-text"><span class="sr-risk-label note">Note:</span> Can you maintain discipline during 30%+ market drops while carrying leverage?</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Strategies to Improve -->
                        <div class="sr-section-header">Strategies to Improve Safety Profile</div>
                        <div class="sr-alternatives-grid">
                            <div class="sr-alternative-card">
                                <span class="sr-alternative-icon"></span>
                                <div class="sr-alternative-title">Reduce Withdrawals</div>
                                <div class="sr-alternative-text">Lower to ${formatCurrency(targetWithdrawalForSafety)}/year (3% rate)</div>
                            </div>
                            <div class="sr-alternative-card">
                                <span class="sr-alternative-icon"></span>
                                <div class="sr-alternative-title">Grow Portfolio</div>
                                <div class="sr-alternative-text">Target ${formatCurrency(targetPortfolioForCurrentWithdrawal)} for safer rate</div>
                            </div>
                            <div class="sr-alternative-card" style="border-color: #6C63FF; background: rgba(108, 99, 255, 0.03);">
                                <span class="sr-alternative-icon"></span>
                                <div class="sr-alternative-title">Hybrid (Recommended)</div>
                                <div class="sr-alternative-text">BBD for 50-60% of withdrawals</div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (terminalDiff > 0) {
                // Calculate what would be needed to make BBD viable
                const targetSuccessRate = 70;
                const currentFailureRate = marginCallRate;
                const targetWithdrawalForViability = startValue * 0.025;
                const withdrawalReduction = annualWithdrawal - targetWithdrawalForViability;

                // Calculate dial ring progress
                const dialCircumference = 157;
                const dialOffset = dialCircumference - (dialCircumference * successRate / 100);

                recommendation = `
                    <!-- Status Banner -->
                    <div class="sr-status-banner unfavorable">
                        <div class="sr-status-icon unfavorable"></div>
                        <div class="sr-status-content">
                            <h3 class="sr-status-headline">BBD Strategy Shows Unfavorable Risk-Reward Profile</h3>
                            <p class="sr-status-subtext">Based on ${numSimulations.toLocaleString()} Monte Carlo simulations</p>
                        </div>
                        <div class="sr-success-dial">
                            <div class="sr-dial-ring">
                                <svg width="64" height="64" viewBox="0 0 64 64">
                                    <circle class="bg-ring" cx="32" cy="32" r="25" fill="none" stroke-width="6"/>
                                    <circle class="progress-ring" cx="32" cy="32" r="25" fill="none" stroke-width="6"
                                        stroke-dasharray="${dialCircumference}" stroke-dashoffset="${dialOffset}" style="stroke: var(--error);"/>
                                </svg>
                                <div class="sr-dial-value">${successRate.toFixed(0)}%</div>
                            </div>
                            <span class="sr-dial-label">Success</span>
                        </div>
                    </div>

                    <!-- Disclaimer -->
                    <div class="sr-disclaimer">
                        <div class="sr-disclaimer-icon">!</div>
                        <div class="sr-disclaimer-text">
                            <span class="sr-disclaimer-tag">High Risk</span>
                            BBD carries elevated risk in your scenario despite showing higher median outcomes. Consider the Sell strategy instead.
                        </div>
                    </div>

                    <div class="sr-content">
                        <!-- Hero Metrics Grid -->
                        <div class="sr-metrics-grid">
                            <div class="sr-metric-card">
                                <span class="sr-metric-icon"></span>
                                <div class="sr-metric-label">Margin Call Risk</div>
                                <div class="sr-metric-value negative">${marginCallRate.toFixed(1)}%</div>
                                <div class="sr-metric-delta negative">${Math.round(marginCallRate)} of 100 scenarios</div>
                            </div>
                            <div class="sr-metric-card">
                                <span class="sr-metric-icon"></span>
                                <div class="sr-metric-label">Success Rate</div>
                                <div class="sr-metric-value negative">${successRate.toFixed(1)}%</div>
                                <div class="sr-metric-delta negative">Too low for reliable outcomes</div>
                            </div>
                            <div class="sr-metric-card">
                                <span class="sr-metric-icon"></span>
                                <div class="sr-metric-label">BBD Advantage</div>
                                <div class="sr-metric-value">+${formatCurrency(Math.abs(terminalDiff))}</div>
                                <div class="sr-metric-delta">+${medianAdvantage}% (if successful)</div>
                            </div>
                            <div class="sr-metric-card">
                                <span class="sr-metric-icon"></span>
                                <div class="sr-metric-label">Tax Savings</div>
                                <div class="sr-metric-value">${formatCurrency(taxSavings)}</div>
                                <div class="sr-metric-delta">Often offset by losses</div>
                            </div>
                        </div>

                        <!-- Risk Explanation -->
                        <div class="sr-section-header">Why Risk Outweighs Potential Reward</div>
                        <div class="sr-insight-card" style="border-color: rgba(239, 68, 68, 0.2); background: linear-gradient(135deg, rgba(239, 68, 68, 0.06) 0%, rgba(239, 68, 68, 0.02) 100%);">
                            <div class="sr-insight-quote" style="border-left-color: var(--error);">
                                "Only ${successRate.toFixed(1)}% of simulations avoid margin callsnearly a coin flip over ${period} years."
                            </div>
                            <div class="sr-insight-text">
                                Your ${withdrawalRate}% withdrawal rate (${formatCurrency(annualWithdrawal)}/year) from a ${formatCurrency(startValue)} portfolio
                                leaves limited safety margin. With ${locHeadroom}% headroom, even moderate 15-20% market downturns can breach the
                                ${(maintenanceMargin * 100).toFixed(0)}% maintenance threshold, forcing liquidation at the worst times.
                            </div>
                        </div>

                        <!-- Actionable Insights -->
                        <div class="sr-section-header">Why Margin Calls Undermine BBD Benefits</div>
                        <div class="sr-insights-container">
                            <div class="sr-insights-header">
                                <div class="sr-insights-title">
                                    <span class="material-icons">lightbulb</span>
                                    Actionable Insights
                                </div>
                                <span class="sr-insights-count">3</span>
                            </div>
                            <div class="sr-risks-list">
                                <div class="sr-risk-card">
                                    <div class="sr-risk-icon high">
                                        <span class="material-icons">trending_down</span>
                                    </div>
                                    <div class="sr-risk-content">
                                        <div class="sr-risk-title">Forced Sales at Market Lows</div>
                                        <div class="sr-risk-text"><span class="sr-risk-label warning">Warning:</span> Margin calls occur when portfolio values drop, forcing asset sales at depressed prices rather than waiting for recovery.</div>
                                    </div>
                                </div>
                                <div class="sr-risk-card">
                                    <div class="sr-risk-icon high">
                                        <span class="material-icons">show_chart</span>
                                    </div>
                                    <div class="sr-risk-content">
                                        <div class="sr-risk-title">Lost Recovery Potential</div>
                                        <div class="sr-risk-text"><span class="sr-risk-label warning">Warning:</span> Assets sold during downturns miss subsequent rebounds, permanently reducing long-term wealth accumulation.</div>
                                    </div>
                                </div>
                                <div class="sr-risk-card">
                                    <div class="sr-risk-icon high">
                                        <span class="material-icons">money_off</span>
                                    </div>
                                    <div class="sr-risk-content">
                                        <div class="sr-risk-title">Tax Savings Offset</div>
                                        <div class="sr-risk-text"><span class="sr-risk-label warning">Warning:</span> The ${formatCurrency(taxSavings)} tax benefit is often completely negated by losses from poorly-timed forced sales.</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recommended Alternative -->
                        <div class="sr-section-header">Recommended: Sell Assets Strategy</div>
                        <div class="sr-benefits-grid">
                            <div class="sr-benefit-card" style="border-color: var(--success);">
                                <div class="sr-benefit-header">
                                    <div class="sr-benefit-icon teal"></div>
                                    <div class="sr-benefit-title">Reliability</div>
                                </div>
                                <div class="sr-benefit-value" style="color: var(--success);">${sellSuccessRateValue.toFixed(1)}%</div>
                                <div class="sr-benefit-text">No margin call risk provides peace of mind and predictable outcomes.</div>
                            </div>
                            <div class="sr-benefit-card">
                                <div class="sr-benefit-header">
                                    <div class="sr-benefit-icon purple"></div>
                                    <div class="sr-benefit-title">Control</div>
                                </div>
                                <div class="sr-benefit-value">You Decide</div>
                                <div class="sr-benefit-text">No forced liquidationsyou control timing of sales and can be tax-strategic.</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // BBD median is actually worse than Sell median
                const underperformancePct = ((Math.abs(terminalDiff) / sellStrategyStats.terminalStats.median) * 100).toFixed(1);

                recommendation = `
                    <!-- Status Banner -->
                    <div class="sr-status-banner unfavorable">
                        <div class="sr-status-icon unfavorable"></div>
                        <div class="sr-status-content">
                            <h3 class="sr-status-headline">Sell Assets Strategy Outperforms BBD</h3>
                            <p class="sr-status-subtext">Based on ${numSimulations.toLocaleString()} Monte Carlo simulations</p>
                        </div>
                        <div class="sr-success-dial">
                            <div class="sr-dial-ring">
                                <svg width="64" height="64" viewBox="0 0 64 64">
                                    <circle class="bg-ring" cx="32" cy="32" r="25" fill="none" stroke-width="6"/>
                                    <circle class="progress-ring" cx="32" cy="32" r="25" fill="none" stroke-width="6"
                                        stroke-dasharray="157" stroke-dashoffset="${157 - (157 * sellSuccessRateValue / 100)}" style="stroke: var(--success);"/>
                                </svg>
                                <div class="sr-dial-value">${sellSuccessRateValue.toFixed(0)}%</div>
                            </div>
                            <span class="sr-dial-label">Sell Success</span>
                        </div>
                    </div>

                    <!-- Disclaimer -->
                    <div class="sr-disclaimer">
                        <div class="sr-disclaimer-icon">!</div>
                        <div class="sr-disclaimer-text">
                            <span class="sr-disclaimer-tag">BBD Not Recommended</span>
                            Margin call risk outweighs tax benefits in your scenario. Sell Assets strategy produces better outcomes.
                        </div>
                    </div>

                    <div class="sr-content">
                        <!-- Hero Metrics Grid -->
                        <div class="sr-metrics-grid">
                            <div class="sr-metric-card highlight" style="border-color: var(--success);">
                                <span class="sr-metric-icon"></span>
                                <div class="sr-metric-label">Sell Advantage</div>
                                <div class="sr-metric-value positive">+${formatCurrency(Math.abs(terminalDiff))}</div>
                                <div class="sr-metric-delta">+${underperformancePct}% vs BBD</div>
                            </div>
                            <div class="sr-metric-card">
                                <span class="sr-metric-icon"></span>
                                <div class="sr-metric-label">Sell Reliability</div>
                                <div class="sr-metric-value positive">${sellSuccessRateValue.toFixed(1)}%</div>
                                <div class="sr-metric-delta">No margin call risk</div>
                            </div>
                            <div class="sr-metric-card">
                                <span class="sr-metric-icon"></span>
                                <div class="sr-metric-label">BBD Margin Calls</div>
                                <div class="sr-metric-value negative">${marginCallRate.toFixed(1)}%</div>
                                <div class="sr-metric-delta negative">${Math.round(marginCallRate)} of 100 scenarios</div>
                            </div>
                            <div class="sr-metric-card">
                                <span class="sr-metric-icon"></span>
                                <div class="sr-metric-label">BBD Tax Savings</div>
                                <div class="sr-metric-value">${formatCurrency(taxSavings)}</div>
                                <div class="sr-metric-delta negative">Offset by losses</div>
                            </div>
                        </div>

                        <!-- Explanation -->
                        <div class="sr-section-header">Why Sell Outperforms Despite Higher Taxes</div>
                        <div class="sr-insight-card" style="border-color: rgba(22, 163, 74, 0.2); background: linear-gradient(135deg, rgba(22, 163, 74, 0.06) 0%, rgba(22, 163, 74, 0.02) 100%);">
                            <div class="sr-insight-quote" style="border-left-color: var(--success);">
                                "Sell produces ${formatCurrency(Math.abs(terminalDiff))} more wealth despite paying ${formatCurrency(taxSavings)} in taxes."
                            </div>
                            <div class="sr-insight-text">
                                Your ${withdrawalRate}% withdrawal rate creates conditions where margin call risk destroys more value than taxes cost.
                                The ${marginCallRate.toFixed(1)}% forced liquidation rate concentrates asset sales during market lows, creating "anti-compounding"
                                that exceeds the tax drag of gradual, controlled selling.
                            </div>
                        </div>

                        <!-- Sell Strategy Benefits -->
                        <div class="sr-section-header">Sell Strategy Advantages</div>
                        <div class="sr-benefits-grid">
                            <div class="sr-benefit-card" style="border-color: var(--success);">
                                <div class="sr-benefit-header">
                                    <div class="sr-benefit-icon teal"></div>
                                    <div class="sr-benefit-title">Predictable Outcomes</div>
                                </div>
                                <div class="sr-benefit-value" style="color: var(--success);">${sellSuccessRateValue.toFixed(1)}%</div>
                                <div class="sr-benefit-text">Reliable wealth trajectory with no forced liquidation risk during market stress.</div>
                            </div>
                            <div class="sr-benefit-card">
                                <div class="sr-benefit-header">
                                    <div class="sr-benefit-icon purple"></div>
                                    <div class="sr-benefit-title">Full Control</div>
                                </div>
                                <div class="sr-benefit-value">You Decide</div>
                                <div class="sr-benefit-text">Choose when to sell, enabling tax-loss harvesting and strategic gain realization.</div>
                            </div>
                        </div>

                        <!-- Tax Optimization Tips -->
                        <div class="sr-section-header">Optimize Your Sell Strategy</div>
                        <div class="sr-alternatives-grid">
                            <div class="sr-alternative-card">
                                <span class="sr-alternative-icon"></span>
                                <div class="sr-alternative-title">Tax-Loss Harvesting</div>
                                <div class="sr-alternative-text">Offset gains by selling losing positions</div>
                            </div>
                            <div class="sr-alternative-card">
                                <span class="sr-alternative-icon"></span>
                                <div class="sr-alternative-title">Long-Term Gains</div>
                                <div class="sr-alternative-text">Prioritize assets held >1 year for lower rates</div>
                            </div>
                            <div class="sr-alternative-card">
                                <span class="sr-alternative-icon"></span>
                                <div class="sr-alternative-title">Roth Conversions</div>
                                <div class="sr-alternative-text">Convert in low-income years for tax-free growth</div>
                            </div>
                        </div>
                    </div>
                `;
        }
        END DEAD CODE */

        // Create comparison charts
        function createComparisonCharts(mcResults) {
            const { percentilesData, sellStrategyStats } = mcResults;

            // Add null checks
            if (!sellStrategyStats || !sellStrategyStats.percentilesData) {
                console.warn('Sell strategy stats not available for comparison charts');
                return;
            }

            const medianBBD = percentilesData[50];
            const medianSell = sellStrategyStats.percentilesData[50];

            // Debug logging and validation
            console.log('=== Comparison Chart Data Validation ===');
            console.log('BBD Median Path (length):', medianBBD ? medianBBD.length : 'undefined');
            console.log('Sell Median Path (length):', medianSell ? medianSell.length : 'undefined');

            // Validate data exists before creating charts
            if (!medianBBD || medianBBD.length === 0) {
                console.error(' Cannot create comparison charts: BBD median data is missing or empty');
                return;
            }
            if (!medianSell || medianSell.length === 0) {
                console.error(' Cannot create comparison charts: Sell median data is missing or empty');
                return;
            }

            if (medianBBD && medianBBD.length > 0) {
                const lastBBD = medianBBD[medianBBD.length - 1];
                console.log(' BBD Chart Validation:');
                console.log('   Chart array length:', medianBBD.length);
                console.log('   Last entry year:', lastBBD.year);
                console.log('   Last entry netPortfolio:', lastBBD.netPortfolio);
                console.log('   First few netPortfolio values:', medianBBD.slice(0, 3).map(d => d.netPortfolio));
                console.log('   Last few netPortfolio values:', medianBBD.slice(-3).map(d => d.netPortfolio));
                console.log('');
                console.log('BBD Chart Terminal netPortfolio:', lastBBD.netPortfolio);
                console.log('BBD Summary Terminal (from terminalStats):', mcResults.terminalStats.median);

                // Validate consistency
                const difference = Math.abs(lastBBD.netPortfolio - mcResults.terminalStats.median);
                console.log('Calculated difference:', difference);
                if (difference > 1) {  // Allow $1 rounding error
                    console.error(' MISMATCH: BBD chart terminal value does not match summary!');
                    console.error('   Chart shows:', lastBBD.netPortfolio);
                    console.error('   Summary shows:', mcResults.terminalStats.median);
                    console.error('   Difference:', difference);
                    console.error('   Difference as %:', ((difference / mcResults.terminalStats.median) * 100).toFixed(2) + '%');
                } else {
                    console.log(' BBD chart and summary values match');
                }
            }

            if (medianSell && medianSell.length > 0) {
                const lastSell = medianSell[medianSell.length - 1];
                console.log('');
                console.log(' Sell Chart Validation:');
                console.log('   Chart array length:', medianSell.length);
                console.log('   Last entry year:', lastSell.year);
                console.log('   Last entry netWorth:', lastSell.netWorth);
                console.log('   First few netWorth values:', medianSell.slice(0, 3).map(d => d.netWorth));
                console.log('   Last few netWorth values:', medianSell.slice(-3).map(d => d.netWorth));
                console.log('');
                console.log('Sell Chart Terminal netWorth:', lastSell.netWorth);
                console.log('Sell Summary Terminal (from terminalStats):', sellStrategyStats.terminalStats.median);

                // Validate consistency
                const difference = Math.abs(lastSell.netWorth - sellStrategyStats.terminalStats.median);
                console.log('Calculated difference:', difference);
                if (difference > 1) {  // Allow $1 rounding error
                    console.error(' MISMATCH: Sell chart terminal value does not match summary!');
                    console.error('   Chart shows:', lastSell.netWorth);
                    console.error('   Summary shows:', sellStrategyStats.terminalStats.median);
                    console.error('   Difference:', difference);
                    console.error('   Difference as %:', ((difference / sellStrategyStats.terminalStats.median) * 100).toFixed(2) + '%');
                } else {
                    console.log(' Sell chart and summary values match');
                }
            }
            console.log('========================================');

            // Chart 1: Net Worth Over Time
            const netWorthCtx = document.getElementById('comparisonNetWorthChart');
            if (netWorthCtx) {
                if (window.comparisonNetWorthChartInstance) {
                    window.comparisonNetWorthChartInstance.destroy();
                }

                const years = medianBBD.map(d => d.year);

                window.comparisonNetWorthChartInstance = new Chart(netWorthCtx, {
                    type: 'line',
                    data: {
                        labels: years,
                        datasets: [
                            {
                                label: 'Buy Borrow Die (Net Worth)',
                                data: medianBBD.map(d => d.netPortfolio),
                                borderColor: '#2e7d32',
                                backgroundColor: 'rgba(46, 125, 50, 0.1)',
                                borderWidth: 3,
                                fill: false,
                                tension: 0.3,
                                pointRadius: 0
                            },
                            {
                                label: 'Sell Assets (Net Worth)',
                                data: medianSell.map(d => d.netWorth),
                                borderColor: '#1976d2',
                                backgroundColor: 'rgba(25, 118, 210, 0.1)',
                                borderWidth: 3,
                                fill: false,
                                tension: 0.3,
                                pointRadius: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: getChartTextColor(),
                                    usePointStyle: true,
                                    padding: 15
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.9)',
                                padding: 16,
                                titleFont: { size: 14, weight: 'bold' },
                                bodyFont: { size: 13 },
                                bodySpacing: 8,
                                callbacks: {
                                    title: function(context) {
                                        return 'Year ' + context[0].label;
                                    },
                                    label: function(context) {
                                        return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                    },
                                    afterBody: function(context) {
                                        if (context.length === 2) {
                                            const bbdValue = context[0].dataset.label.includes('Buy Borrow Die') ? context[0].parsed.y : context[1].parsed.y;
                                            const sellValue = context[0].dataset.label.includes('Sell Assets') ? context[0].parsed.y : context[1].parsed.y;
                                            const diff = bbdValue - sellValue;
                                            const pctDiff = sellValue !== 0 ? ((diff / sellValue) * 100).toFixed(1) : 'N/A';
                                            return [
                                                '',
                                                '',
                                                'Difference: ' + formatCurrency(diff),
                                                (pctDiff !== 'N/A' ? (diff >= 0 ? ' BBD ahead by ' : ' BBD behind by ') + pctDiff + '%' : '')
                                            ];
                                        }
                                        return [];
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Year', color: getChartTextColor() },
                                ticks: { color: getChartTextColor() },
                                grid: { color: getChartGridColor() }
                            },
                            y: {
                                title: { display: true, text: 'Net Worth ($)', color: getChartTextColor() },
                                ticks: {
                                    color: getChartTextColor(),
                                    callback: function(value) {
                                        return '$' + (value / 1000000).toFixed(1) + 'M';
                                    }
                                },
                                grid: { color: getChartGridColor() }
                            }
                        }
                    }
                });
            }

            // Chart 2: Cumulative Tax Impact vs Interest Cost
            const taxCtx = document.getElementById('comparisonTaxChart');
            if (taxCtx) {
                if (window.comparisonTaxChartInstance) {
                    window.comparisonTaxChartInstance.destroy();
                }

                const years = medianSell.map(d => d.year);
                const cumulativeTaxes = medianSell.map(d => d.totalTaxesPaid);

                // Debug: Check for tax discrepancy
                console.log('Tax Data Validation:');
                console.log('Chart last year cumulative taxes:', cumulativeTaxes[cumulativeTaxes.length - 1]);
                console.log('Summary median taxes paid:', sellStrategyStats.medianTaxesPaid);
                console.log('Last year in medianSell:', medianSell[medianSell.length - 1].year);
                console.log('Simulation period:', mcResults.params.period);

                // Calculate cumulative interest paid for BBD
                // We need to calculate cumulative interest by simulating the loan growth
                const params = mcResults.params;
                const annualWithdrawal = params.annualWithdrawal;
                // Convert SBLOC rate to decimal (it's stored as percentage, e.g., 7.4 means 7.4%)
                const sblocRate = params.sblocRate / 100;

                // Debug: Check what data we have
                console.log('BBD Interest Calculation Debug:');
                console.log('Annual withdrawal:', annualWithdrawal);
                console.log('SBLOC rate (%):', params.sblocRate);
                console.log('SBLOC rate (decimal):', sblocRate);
                console.log('First year locBalance:', medianBBD[0].locBalance);
                console.log('Last year locBalance:', medianBBD[medianBBD.length - 1].locBalance);

                // Calculate cumulative interest by tracking theoretical debt growth
                const bbdInterest = [];
                let theoreticalDebt = 0; // Track what debt WOULD be with just withdrawals + interest

                for (let i = 0; i < medianBBD.length; i++) {
                    // Add interest on existing debt
                    theoreticalDebt *= (1 + sblocRate);
                    // Add new withdrawal
                    theoreticalDebt += annualWithdrawal;
                    // Cumulative interest = theoretical debt - total withdrawals
                    const totalWithdrawals = annualWithdrawal * (i + 1);
                    const cumulativeInterest = theoreticalDebt - totalWithdrawals;
                    bbdInterest.push(Math.max(0, cumulativeInterest));
                }

                console.log('Calculated BBD interest array (first 5):', bbdInterest.slice(0, 5));
                console.log('Calculated BBD interest (last):', bbdInterest[bbdInterest.length - 1]);

                window.comparisonTaxChartInstance = new Chart(taxCtx, {
                    type: 'line',
                    data: {
                        labels: years,
                        datasets: [
                            {
                                label: 'Sell Assets (Cumulative Taxes)',
                                data: cumulativeTaxes,
                                borderColor: '#c62828',
                                backgroundColor: 'rgba(198, 40, 40, 0.2)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.3,
                                pointRadius: 0
                            },
                            {
                                label: 'Buy Borrow Die (Cumulative Interest)',
                                data: bbdInterest,
                                borderColor: '#2e7d32',
                                backgroundColor: 'rgba(46, 125, 50, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.3,
                                pointRadius: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: getChartTextColor(),
                                    usePointStyle: true,
                                    padding: 15
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.9)',
                                padding: 16,
                                titleFont: { size: 14, weight: 'bold' },
                                bodyFont: { size: 13 },
                                bodySpacing: 8,
                                callbacks: {
                                    title: function(context) {
                                        return 'Year ' + context[0].label;
                                    },
                                    label: function(context) {
                                        return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                    },
                                    afterBody: function(context) {
                                        if (context.length === 2) {
                                            const sellTaxes = context[0].dataset.label.includes('Sell Assets') ? context[0].parsed.y : context[1].parsed.y;
                                            const bbdInterestCost = context[0].dataset.label.includes('Buy Borrow Die') ? context[0].parsed.y : context[1].parsed.y;
                                            const yearIndex = context[0].dataIndex;
                                            const yearData = medianSell[yearIndex];

                                            const difference = sellTaxes - bbdInterestCost;
                                            const lines = [
                                                '',
                                                '',
                                                'Cost Difference: ' + formatCurrency(difference),
                                                (difference > 0 ? ' BBD saves: ' : ' BBD costs more: ') + formatCurrency(Math.abs(difference))
                                            ];

                                            if (yearData && yearData.capitalGainsTax > 0) {
                                                lines.push('');
                                                lines.push('Tax Breakdown (Sell):');
                                                lines.push('   Capital Gains: ' + formatCurrency(yearData.capitalGainsTax));
                                            }
                                            if (yearData && yearData.dividendTax > 0) {
                                                lines.push('   Dividend Tax: ' + formatCurrency(yearData.dividendTax));
                                            }

                                            return lines;
                                        }
                                        return [];
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Year', color: getChartTextColor() },
                                ticks: { color: getChartTextColor() },
                                grid: { color: getChartGridColor() }
                            },
                            y: {
                                title: { display: true, text: 'Cumulative Cost ($)', color: getChartTextColor() },
                                ticks: {
                                    color: getChartTextColor(),
                                    callback: function(value) {
                                        return '$' + (value / 1000000).toFixed(2) + 'M';
                                    }
                                },
                                grid: { color: getChartGridColor() }
                            }
                        }
                    }
                });
            }

            // Chart 3: Terminal Distribution Comparison (Bar chart)
            const distCtx = document.getElementById('comparisonDistributionChart');
            if (distCtx) {
                if (window.comparisonDistributionChartInstance) {
                    window.comparisonDistributionChartInstance.destroy();
                }

                const percentiles = ['10th', '25th', '50th', '75th', '90th'];
                const bbdValues = [
                    mcResults.terminalStats.percentile10,
                    mcResults.terminalStats.percentile25,
                    mcResults.terminalStats.median,
                    mcResults.terminalStats.percentile75,
                    mcResults.terminalStats.percentile90
                ];
                const sellValues = [
                    sellStrategyStats.terminalStats.percentile10,
                    sellStrategyStats.terminalStats.percentile25,
                    sellStrategyStats.terminalStats.median,
                    sellStrategyStats.terminalStats.percentile75,
                    sellStrategyStats.terminalStats.percentile90
                ];

                window.comparisonDistributionChartInstance = new Chart(distCtx, {
                    type: 'bar',
                    data: {
                        labels: percentiles,
                        datasets: [
                            {
                                label: 'Buy Borrow Die',
                                data: bbdValues,
                                backgroundColor: 'rgba(46, 125, 50, 0.7)',
                                borderColor: '#2e7d32',
                                borderWidth: 2
                            },
                            {
                                label: 'Sell Assets',
                                data: sellValues,
                                backgroundColor: 'rgba(25, 118, 210, 0.7)',
                                borderColor: '#1976d2',
                                borderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: getChartTextColor(),
                                    usePointStyle: true,
                                    padding: 15
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.9)',
                                padding: 16,
                                titleFont: { size: 14, weight: 'bold' },
                                bodyFont: { size: 13 },
                                bodySpacing: 8,
                                callbacks: {
                                    title: function(context) {
                                        return context[0].label + ' Percentile Outcome';
                                    },
                                    label: function(context) {
                                        return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                    },
                                    afterBody: function(context) {
                                        if (context.length === 2) {
                                            const bbdValue = context[0].dataset.label === 'Buy Borrow Die' ? context[0].parsed.y : context[1].parsed.y;
                                            const sellValue = context[0].dataset.label === 'Sell Assets' ? context[0].parsed.y : context[1].parsed.y;
                                            const diff = bbdValue - sellValue;
                                            const pctDiff = sellValue !== 0 ? ((diff / sellValue) * 100).toFixed(1) : 'N/A';

                                            const percentileLabel = context[0].label;
                                            let interpretation = '';
                                            if (percentileLabel === '10th') {
                                                interpretation = '(Worst-case scenario)';
                                            } else if (percentileLabel === '50th') {
                                                interpretation = '(Most likely outcome)';
                                            } else if (percentileLabel === '90th') {
                                                interpretation = '(Best-case scenario)';
                                            }

                                            return [
                                                '',
                                                interpretation,
                                                '',
                                                'Difference: ' + formatCurrency(diff),
                                                (pctDiff !== 'N/A' ? (diff >= 0 ? ' BBD advantage: +' : ' BBD disadvantage: ') + pctDiff + '%' : '')
                                            ];
                                        }
                                        return [];
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Percentile', color: getChartTextColor() },
                                ticks: { color: getChartTextColor() },
                                grid: { color: getChartGridColor() }
                            },
                            y: {
                                title: { display: true, text: 'Terminal Net Worth ($)', color: getChartTextColor() },
                                ticks: {
                                    color: getChartTextColor(),
                                    callback: function(value) {
                                        return '$' + (value / 1000000).toFixed(1) + 'M';
                                    }
                                },
                                grid: { color: getChartGridColor() }
                            }
                        }
                    }
                });
            }
        }

        // Populate Liquidity Stress Testing Dashboard
        function populateLiquidityStressDashboard(liquidityStats, params) {
            const dashboardDiv = document.getElementById('liquidityStressDashboard');
            if (!dashboardDiv) return;

            const { minDistanceToMarginCall, p10SafetyBuffer, p90LocUtilization, mostDangerousYear, worstCaseLocUsedPct, dangerousYearDetails } = liquidityStats;

            // Calculate median scenario stress tests
            const medianYear50 = liquidityStats.liquidityData[50][Math.floor(liquidityStats.liquidityData[50].length / 2)];
            if (!medianYear50) return;

            // Get the actual values from the median percentile data
            const medianPortfolio = params.startValue * 1.5; // Approximate - would need actual median portfolio value
            const medianLOC = medianPortfolio * (params.maxBorrowing / 200); // Approximate 50% utilization
            const maxBorrowing = params.maxBorrowing / 100;

            // Calculate stress test scenarios for median case
            const stressTests = calculateStressTests(medianPortfolio, medianLOC, maxBorrowing);

            // Determine overall status
            const minDistance = Math.min(...liquidityStats.liquidityData[10].map(d => d.distanceToMarginCall));
            let statusIcon, statusTitle, statusDescription, statusClass;

            if (minDistance < 10) {
                statusIcon = '';
                statusTitle = 'CRITICAL LIQUIDITY RISK';
                statusDescription = `In worst-case scenarios (10th percentile), the portfolio comes within ${minDistance.toFixed(1)}% points of triggering a margin call. Immediate parameter adjustments recommended.`;
                statusClass = 'danger';
            } else if (minDistance < 25) {
                statusIcon = '';
                statusTitle = 'MODERATE LIQUIDITY RISK';
                statusDescription = `The portfolio maintains a ${minDistance.toFixed(1)}% point safety buffer in worst-case scenarios. Consider increasing this buffer to reduce margin call risk.`;
                statusClass = 'warning';
            } else {
                statusIcon = '';
                statusTitle = 'HEALTHY LIQUIDITY POSITION';
                statusDescription = `Even in worst-case scenarios (10th percentile), the portfolio maintains a ${minDistance.toFixed(1)}% point safety buffer from margin calls. Strategy shows strong resilience.`;
                statusClass = 'safe';
            }

            // Build the HTML
            let dashboardHTML = `
                <div class="liquidity-status-banner ${statusClass}">
                    <div class="liquidity-status-icon">${statusIcon}</div>
                    <div class="liquidity-status-content">
                        <div class="liquidity-status-title">${statusTitle}</div>
                        <div class="liquidity-status-description">${statusDescription}</div>
                    </div>
                </div>

                <h4 style="margin-bottom: 16px; color: var(--md-sys-color-on-surface); font-size: 16px; font-weight: 600;">
                    Stress Test Scenarios (Median Case)
                </h4>
                <p style="margin-bottom: 16px; color: var(--md-sys-color-on-surface-variant); font-size: 14px;">
                    What happens if your portfolio drops suddenly? These scenarios test margin call risk at different market decline levels.
                </p>

                <div class="liquidity-dashboard-grid">
            `;

            // Add stress test cards
            [10, 20, 30, 40].forEach(dropPct => {
                const test = stressTests[`drop${dropPct}`];
                const cardClass = test.marginCallTriggered ? 'danger' : (test.newLocUsedPct > 75 ? 'warning' : 'safe');
                const badgeClass = test.marginCallTriggered ? 'danger' : (test.newLocUsedPct > 75 ? 'warning' : 'safe');
                const badgeText = test.marginCallTriggered ? 'MARGIN CALL' : (test.newLocUsedPct > 75 ? 'HIGH RISK' : 'SAFE');

                dashboardHTML += `
                    <div class="stress-test-card ${cardClass}">
                        <div class="stress-test-header">
                            <div class="stress-test-title">Portfolio Drops ${dropPct}%</div>
                            <div class="stress-test-badge ${badgeClass}">${badgeText}</div>
                        </div>
                        <div class="stress-test-body">
                            <div class="stress-test-metric">
                                <span class="stress-test-metric-label">New Portfolio Value:</span>
                                <span class="stress-test-metric-value">$${(test.newPortfolioValue / 1000).toFixed(0)}K</span>
                            </div>
                            <div class="stress-test-metric">
                                <span class="stress-test-metric-label">LOC Utilization:</span>
                                <span class="stress-test-metric-value">${test.newLocUsedPct.toFixed(1)}%</span>
                            </div>
                            <div class="stress-test-metric">
                                <span class="stress-test-metric-label">Distance to Margin Call:</span>
                                <span class="stress-test-metric-value">${test.distanceToMarginCall.toFixed(1)}% pts</span>
                            </div>
                        </div>
                    </div>
                `;
            });

            dashboardHTML += `
                </div>

                <div style="background: var(--md-sys-color-surface-container-high); border-radius: 6px; padding: 16px; margin-top: 16px;">
                    <h4 style="margin-bottom: 12px; color: var(--md-sys-color-on-surface); font-size: 15px; font-weight: 600;">
                        Key Liquidity Metrics
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                        <div>
                            <div class="text-sm-on-surface-variant-mb-4">10th Percentile Safety Buffer</div>
                            <div style="font-size: 18px; font-weight: 700; color: var(--md-sys-color-primary);">
                                ${p10SafetyBuffer.toFixed(1)}% pts
                            </div>
                            <div style="font-size: 11px; color: var(--md-sys-color-on-surface-variant); margin-top: 4px; opacity: 0.8;">
                                Worst 10% of scenarios have at least this buffer
                            </div>
                            <div style="margin-top: 8px; padding: 10px; background: rgba(33, 150, 243, 0.08); border-radius: 4px; border-left: 3px solid #2196F3;">
                                <div style="font-size: 11px; font-weight: 600; color: #2196F3; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">
                                    Understanding This Metric
                                </div>
                                <div style="font-size: 12px; line-height: 1.5; color: var(--md-sys-color-on-surface-variant);">
                                    <div style="margin-bottom: 4px;">
                                        <strong>What it means:</strong> Even in the worst 10% of all simulated scenarios, your safety buffer never drops below this value.
                                    </div>
                                    <div style="margin-bottom: 4px;">
                                        <strong>Why percentiles matter:</strong> The absolute minimum can be an extreme outlier. This shows realistic worst-case risk.
                                    </div>
                                    <div>
                                        <strong>How to interpret:</strong> Higher values = more robust strategy. <20% = tight margins, >30% = comfortable cushion.
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="text-sm-on-surface-variant-mb-4">Most Dangerous Year</div>
                            <div style="font-size: 18px; font-weight: 700; color: #FF6B6B;">
                                ${mostDangerousYear || 'N/A'}
                            </div>
                            ${dangerousYearDetails ? `
                                <div style="margin-top: 8px; padding: 10px; background: rgba(255, 107, 107, 0.08); border-radius: 4px; border-left: 3px solid #FF6B6B;">
                                    <div style="font-size: 11px; font-weight: 600; color: #FF6B6B; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">
                                        Why This Year Is Most Dangerous
                                    </div>
                                    <div style="font-size: 12px; line-height: 1.5; color: var(--md-sys-color-on-surface-variant);">
                                        <div style="margin-bottom: 4px;">
                                            <strong>LOC Utilization:</strong> ${dangerousYearDetails.locUsedPct.toFixed(1)}%
                                            <span style="color: #FF6B6B;">(${(100 - dangerousYearDetails.locUsedPct).toFixed(1)}% pts from margin call)</span>
                                        </div>
                                        <div style="margin-bottom: 4px;">
                                            <strong>Borrowed:</strong> $${(dangerousYearDetails.locBalance / 1000000).toFixed(2)}M of $${(dangerousYearDetails.maxLoc / 1000000).toFixed(2)}M limit
                                        </div>
                                        <div>
                                            <strong>Portfolio Value:</strong> $${(dangerousYearDetails.portfolioValue / 1000000).toFixed(2)}M
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        <div>
                            <div class="text-sm-on-surface-variant-mb-4">90th Percentile LOC Utilization</div>
                            <div style="font-size: 18px; font-weight: 700; color: ${p90LocUtilization >= 100 ? '#DC2626' : (p90LocUtilization > 75 ? '#FFA726' : '#16A34A')};">
                                ${p90LocUtilization.toFixed(1)}%
                            </div>
                            <div style="font-size: 11px; color: var(--md-sys-color-on-surface-variant); margin-top: 4px; opacity: 0.8;">
                                In 90% of scenarios, utilization stays below this
                            </div>
                            <div style="margin-top: 8px; padding: 10px; background: ${p90LocUtilization >= 100 ? 'rgba(220, 38, 38, 0.08)' : 'rgba(255, 167, 38, 0.08)'}; border-radius: 4px; border-left: 3px solid ${p90LocUtilization >= 100 ? '#DC2626' : '#FFA726'};">
                                <div style="font-size: 11px; font-weight: 600; color: ${p90LocUtilization >= 100 ? '#DC2626' : '#FFA726'}; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">
                                    What This Means
                                </div>
                                <div style="font-size: 12px; line-height: 1.5; color: var(--md-sys-color-on-surface-variant);">
                                    <div style="margin-bottom: 4px;">
                                        <strong>Definition:</strong> In 90% of simulations, your LOC utilization never exceeds this value. Represents realistic worst-case.
                                    </div>
                                    <div style="margin-bottom: 4px;">
                                        <strong>Margin call threshold:</strong> 100% utilization triggers forced liquidation with haircut penalties.
                                    </div>
                                    <div>
                                        <strong>${p90LocUtilization >= 100 ? 'Above 100%' : p90LocUtilization > 75 ? '75-100%' : 'Below 75%'}:</strong> ${p90LocUtilization >= 100 ? 'In worst 10% of scenarios, margin calls occur. Consider reducing withdrawal rate or increasing starting capital.' : p90LocUtilization > 75 ? 'Gets close to margin call in worst scenarios. Some risk but manageable.' : 'Comfortable distance from margin call in 90% of scenarios. Strong liquidity position.'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 24px;">
                    <h4 style="margin-bottom: 12px; color: var(--md-sys-color-on-surface); font-size: 15px; font-weight: 600;">
                        Safety Buffer Over Time
                    </h4>
                    <p style="margin-bottom: 16px; color: var(--md-sys-color-on-surface-variant); font-size: 13px;">
                        Track how your distance to margin call evolves across different market scenarios over the simulation period.
                    </p>
                    <div style="background: var(--md-sys-color-surface); border-radius: 8px; padding: 16px; height: 300px;">
                        <canvas id="liquiditySafetyBufferChart"></canvas>
                    </div>
                </div>

                <div style="margin-top: 16px; padding: 12px; background: var(--md-sys-color-surface-container); border-radius: 4px; border-left: 4px solid var(--md-sys-color-primary);">
                    <p style="font-size: 13px; color: var(--md-sys-color-on-surface-variant); margin: 0;">
                        <strong> Interpretation:</strong> The stress tests show how close you'd come to a margin call if your portfolio dropped suddenly.
                        "Distance to Margin Call" represents percentage points of safety buffer. Higher values indicate greater resilience to market volatility.
                    </p>
                </div>
            `;

            dashboardDiv.innerHTML = dashboardHTML;
        }

        // Generate Executive Summary for Monte Carlo Results
        function generateMonteCarloExecutiveSummary(mcResults) {
            const { percentilesData, successRate, marginCallRate, terminalStats, assetNames, params } = mcResults;

            // Determine viability status
            const isViable = successRate >= 75;
            const isModerate = successRate >= 50 && successRate < 75;

            // Status configuration
            let statusClass = 'favorable';
            let statusIcon = '';
            let statusHeadline = 'Strategy Shows Strong Viability';
            let badgeText = 'Viable';
            let badgeClass = 'favorable';

            if (isModerate) {
                statusClass = 'moderate';
                statusIcon = '';
                statusHeadline = 'Strategy Has Moderate Risk';
                badgeText = 'Moderate Risk';
                badgeClass = 'moderate';
            } else if (!isViable && !isModerate) {
                statusClass = 'unfavorable';
                statusIcon = '';
                statusHeadline = 'Strategy Carries High Risk';
                badgeText = 'High Risk';
                badgeClass = 'unfavorable';
            }

            // Calculate dial ring progress
            const dialCircumference = 157;
            const dialOffset = dialCircumference - (dialCircumference * successRate / 100);

            // Extract key values
            const p10Value = percentilesData[10][percentilesData[10].length - 1].netPortfolio;
            const p90Value = percentilesData[90][percentilesData[90].length - 1].netPortfolio;
            const medianValue = terminalStats.median;

            // Generate portfolio chips HTML
            const portfolioChipsHTML = assetNames.map(name => {
                // Get asset icon based on name
                let icon = '';
                const nameLower = name.toLowerCase();
                if (nameLower.includes('gold') || nameLower.includes('gld')) icon = '';
                else if (nameLower.includes('bond') || nameLower.includes('bnd')) icon = '';
                else if (nameLower.includes('vanguard') || nameLower.includes('vti') || nameLower.includes('idx')) icon = '';
                else if (nameLower.includes('google') || nameLower.includes('goog')) icon = '';
                else if (nameLower.includes('apple') || nameLower.includes('aapl')) icon = '';
                else if (nameLower.includes('rivian') || nameLower.includes('tesla')) icon = '';
                else if (nameLower.includes('qualcomm') || nameLower.includes('qcom')) icon = '';
                return `<span class="es-chip"><span class="es-chip-icon">${icon}</span>${name}</span>`;
            }).join('');

            // Build dynamic next steps based on portfolio risk level
            const generateDynamicNextStepsHTML = () => {
                const steps = [];

                // Determine portfolio risk level
                const isCritical = successRate < 40 || marginCallRate > 40;
                const isWarning = !isCritical && (successRate < 60 || marginCallRate > 20);
                const isModerate = !isCritical && !isWarning && ((successRate >= 60 && successRate < 80) || (marginCallRate > 10 && marginCallRate <= 20));

                // Determine CSS class based on risk
                const riskClass = isCritical ? 'critical' : isWarning ? 'warning' : '';

                // Extract params for use in steps
                const annualWithdrawal = params.annualWithdrawal;
                const maxBorrowing = params.maxBorrowing;

                if (isCritical || isWarning) {
                    // High Risk: Focus on reducing risk

                    // Calculate dynamic optimal withdrawal based on target success rate
                    const targetSuccessRate = isCritical ? 90 : 80; // Critical: aim for 90%, Warning: aim for 80%
                    const successGap = targetSuccessRate - successRate;

                    // Heuristic: Each 1% withdrawal reduction improves success rate by ~0.7-1.0%
                    // Use conservative 0.75 multiplier for estimation
                    const estimatedReductionNeeded = Math.min(successGap / 0.75, 30); // Cap at 30% max

                    // Round to nearest 5% for cleaner recommendations
                    const recommendedReduction = Math.ceil(estimatedReductionNeeded / 5) * 5;
                    const reductionMultiplier = 1 - (recommendedReduction / 100);
                    const newWithdrawal = Math.round(annualWithdrawal * reductionMultiplier);

                    steps.push({
                        icon: '<span class="material-icons">payments</span>',
                        title: 'Reduce Annual Withdrawal',
                        text: `Lower from $${annualWithdrawal.toLocaleString()} to $${newWithdrawal.toLocaleString()} (${recommendedReduction}% reduction) to target ${targetSuccessRate}% success rate`,
                        riskClass
                    });
                    steps.push({
                        icon: '<span class="material-icons">trending_down</span>',
                        title: 'Lower Maximum LTV',
                        text: `Reduce max LTV from ${maxBorrowing.toFixed(0)}% to ${Math.max(40, maxBorrowing - 10).toFixed(0)}% for safety buffer`,
                        riskClass
                    });
                    steps.push({
                        icon: '<span class="material-icons">account_balance_wallet</span>',
                        title: 'Build Cash Buffer',
                        text: `Set aside $${Math.round(annualWithdrawal * 2).toLocaleString()} for 2 years of emergency reserves`,
                        riskClass
                    });
                    steps.push({
                        icon: '<span class="material-icons">swap_horiz</span>',
                        title: 'Consider Sell Assets',
                        text: 'Traditional strategy may be more suitable for your risk tolerance',
                        riskClass
                    });
                } else if (isModerate) {
                    // Moderate Risk: Fine-tuning recommended

                    // Calculate dynamic optimal withdrawal for moderate risk
                    const targetSuccessRate = 85; // Moderate: aim for 85%
                    const successGap = targetSuccessRate - successRate;

                    // Only recommend reduction if below target
                    if (successGap > 0) {
                        // Heuristic: Each 1% withdrawal reduction improves success rate by ~0.75%
                        const estimatedReductionNeeded = Math.min(successGap / 0.75, 20); // Cap at 20% for moderate

                        // Round to nearest 1% for precision (smaller adjustments)
                        const recommendedReduction = Math.max(1, Math.round(estimatedReductionNeeded));
                        const reductionMultiplier = 1 - (recommendedReduction / 100);
                        const newWithdrawal = Math.round(annualWithdrawal * reductionMultiplier);

                        steps.push({
                            icon: '<span class="material-icons">tune</span>',
                            title: 'Fine-tune Withdrawal',
                            text: `Reduce from $${annualWithdrawal.toLocaleString()} to $${newWithdrawal.toLocaleString()} (${recommendedReduction}% reduction) to target ${targetSuccessRate}% success rate`,
                            riskClass: ''
                        });
                    } else {
                        // Already at or above target - suggest optimization
                        steps.push({
                            icon: '<span class="material-icons">tune</span>',
                            title: 'Optimize Withdrawal',
                            text: `Consider increasing withdrawal slightly or reallocating to reduce volatility`,
                            riskClass: ''
                        });
                    }
                    steps.push({
                        icon: '<span class="material-icons">balance</span>',
                        title: 'Adjust Portfolio Weights',
                        text: 'Optimize asset allocation to balance risk/return trade-offs',
                        riskClass: ''
                    });
                    steps.push({
                        icon: '<span class="material-icons">build</span>',
                        title: 'Review Leverage Settings',
                        text: `Consider lowering max LTV or building a $${Math.round(annualWithdrawal * 1.5).toLocaleString()} cash buffer`,
                        riskClass: ''
                    });
                    steps.push({
                        icon: '<span class="material-icons">receipt_long</span>',
                        title: 'Tax Professional',
                        text: 'Optimize SBLOC structure and dividend/interest tax efficiency',
                        riskClass: ''
                    });
                } else {
                    // Low Risk: Standard professional advice
                    steps.push({
                        icon: '<span class="material-icons">bar_chart</span>',
                        title: 'Review Charts',
                        text: 'Examine probability cone and terminal value distribution',
                        riskClass: ''
                    });
                    steps.push({
                        icon: '<span class="material-icons">balance</span>',
                        title: 'Adjust Weights',
                        text: 'Optimize portfolio allocation for risk/return',
                        riskClass: ''
                    });
                    steps.push({
                        icon: '<span class="material-icons">gavel</span>',
                        title: 'Estate Attorney',
                        text: 'Structure the strategy properly for your estate',
                        riskClass: ''
                    });
                    steps.push({
                        icon: '<span class="material-icons">receipt_long</span>',
                        title: 'Tax Professional',
                        text: 'Optimize SBLOC structure for tax efficiency',
                        riskClass: ''
                    });
                }

                return steps.map(step => `
                    <div class="es-next-step-card ${step.riskClass}">
                        <span class="es-next-step-icon">${step.icon}</span>
                        <div class="es-next-step-title">${step.title}</div>
                        <div class="es-next-step-text">${step.text}</div>
                    </div>
                `).join('');
            };

            const dynamicNextStepsHTML = generateDynamicNextStepsHTML();

            // Generate full HTML
            const summaryHTML = `
                <!-- Hero Summary -->
                <div class="es-hero-summary ${statusClass}">
                    <div class="es-hero-checkmark ${statusClass}">
                        <svg viewBox="0 0 24 24">
                            ${statusClass === 'favorable'
                                ? '<polyline points="20 6 9 17 4 12"></polyline>'
                                : statusClass === 'moderate'
                                    ? '<line x1="12" y1="8" x2="12" y2="12"></line><circle cx="12" cy="16" r="0.5" fill="currentColor"></circle>'
                                    : '<line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>'
                            }
                        </svg>
                    </div>
                    <div class="es-hero-content">
                        <div class="es-hero-badge ${badgeClass}">${badgeText}</div>
                        <div class="es-hero-text">
                            ${isViable
                                ? `With a <strong>${successRate.toFixed(1)}%</strong> success rate and median net worth of <strong>$${(medianValue / 1000000).toFixed(2)}M</strong>, the BBD strategy shows strong viability for your ${params.period}-year planning horizon. The ${marginCallRate.toFixed(1)}% margin call rate is within acceptable bounds.`
                                : isModerate
                                    ? `The <strong>${successRate.toFixed(1)}%</strong> success rate indicates moderate viability. Consider adjusting parametersreducing withdrawals or increasing initial capitalto improve outcomes and reduce the ${marginCallRate.toFixed(1)}% margin call risk.`
                                    : `With only <strong>${successRate.toFixed(1)}%</strong> success rate and <strong>${marginCallRate.toFixed(1)}%</strong> margin call risk, this configuration carries significant risk. Strongly consider reducing withdrawal amounts or increasing initial portfolio value.`
                            }
                        </div>
                        <div class="es-hero-subtext">Based on ${params.numSimulations.toLocaleString()} Monte Carlo simulations over ${params.period} years</div>
                    </div>
                    <div class="sr-success-dial">
                        <div class="sr-dial-ring">
                            <svg width="64" height="64" viewBox="0 0 64 64">
                                <circle class="bg-ring" cx="32" cy="32" r="25" fill="none" stroke-width="6"/>
                                <circle class="progress-ring" cx="32" cy="32" r="25" fill="none" stroke-width="6"
                                    stroke-dasharray="${dialCircumference}" stroke-dashoffset="${dialOffset}"
                                    style="stroke: var(--${statusClass === 'favorable' ? 'success' : statusClass === 'moderate' ? 'warning' : 'error'});"/>
                            </svg>
                            <div class="sr-dial-value">${successRate.toFixed(0)}%</div>
                        </div>
                        <span class="sr-dial-label">Success</span>
                    </div>
                </div>

                <div class="sr-content">
                    <!-- Strategy Overview -->
                    <div class="es-overview-card">
                        <div class="es-overview-text">
                            This Monte Carlo analysis examines the viability of implementing the <strong>Buy Borrow Die (BBD)</strong>
                            strategy over a <strong>${params.period}-year period</strong>. By running <strong>${params.numSimulations.toLocaleString()}
                            probabilistic simulations</strong>, we assess the range of possible outcomes across different market scenarios.
                        </div>
                        <div class="es-portfolio-chips">
                            ${portfolioChipsHTML}
                        </div>
                    </div>

                    <!-- Key Metrics Grid -->
                    <div class="sr-section-header">Key Findings</div>
                    <div class="sr-metrics-grid">
                        <div class="sr-metric-card">
                            <span class="sr-metric-icon"></span>
                            <div class="sr-metric-label">Margin Call Rate</div>
                            <div class="sr-metric-value ${marginCallRate <= 20 ? 'positive' : marginCallRate <= 35 ? '' : 'negative'}">${marginCallRate.toFixed(1)}%</div>
                            <div class="sr-metric-delta">${marginCallRate.toFixed(0)} of 100 simulations</div>
                        </div>
                        <div class="sr-metric-card">
                            <span class="sr-metric-icon"></span>
                            <div class="sr-metric-label">Median Net Worth</div>
                            <div class="sr-metric-value">$${(medianValue / 1000000).toFixed(2)}M</div>
                            <div class="sr-metric-delta">50th percentile outcome</div>
                        </div>
                        <div class="sr-metric-card">
                            <span class="sr-metric-icon"></span>
                            <div class="sr-metric-label">Best Case (P90)</div>
                            <div class="sr-metric-value positive">$${(p90Value / 1000000).toFixed(2)}M</div>
                            <div class="sr-metric-delta">90th percentile</div>
                        </div>
                        <div class="sr-metric-card">
                            <span class="sr-metric-icon"></span>
                            <div class="sr-metric-label">Worst Case (P10)</div>
                            <div class="sr-metric-value ${p10Value >= 0 ? '' : 'negative'}">$${(p10Value / 1000000).toFixed(2)}M</div>
                            <div class="sr-metric-delta">10th percentile</div>
                        </div>
                    </div>

                    <!-- Strategic Considerations -->
                    <div class="sr-section-header">Strategic Considerations</div>
                    <div class="es-considerations-grid">
                        <div class="es-consideration-card benefit">
                            <div class="es-consideration-icon benefit"></div>
                            <div class="es-consideration-content">
                                <div class="es-consideration-title">Tax Efficiency</div>
                                <div class="es-consideration-text">All withdrawals are borrowed funds, creating no taxable events during your lifetime</div>
                            </div>
                        </div>
                        <div class="es-consideration-card benefit">
                            <div class="es-consideration-icon benefit"></div>
                            <div class="es-consideration-content">
                                <div class="es-consideration-title">Portfolio Diversification</div>
                                <div class="es-consideration-text">Using ${assetNames.length} assets reduces concentration risk</div>
                            </div>
                        </div>
                        <div class="es-consideration-card ${marginCallRate > 25 ? 'risk' : 'neutral'}">
                            <div class="es-consideration-icon ${marginCallRate > 25 ? 'risk' : 'neutral'}">${marginCallRate > 25 ? '' : ''}</div>
                            <div class="es-consideration-content">
                                <div class="es-consideration-title">Margin Call Risk</div>
                                <div class="es-consideration-text">${marginCallRate.toFixed(1)}% of scenarios experienced borrowing limit violations</div>
                            </div>
                        </div>
                        <div class="es-consideration-card neutral">
                            <div class="es-consideration-icon neutral"></div>
                            <div class="es-consideration-content">
                                <div class="es-consideration-title">Market Uncertainty</div>
                                <div class="es-consideration-text">Monte Carlo simulation accounts for various market conditions</div>
                            </div>
                        </div>
                    </div>

                    <!-- Recommended Next Steps -->
                    <div class="sr-section-header">Recommended Next Steps</div>
                    <div class="es-next-steps-grid">
                        ${dynamicNextStepsHTML}
                    </div>
                </div>
            `;

            // Executive summary element may not exist if consolidated into Strategy Analysis
            const executiveSummaryEl = document.getElementById('executiveSummaryContent');
            if (executiveSummaryEl) executiveSummaryEl.innerHTML = summaryHTML;
        }

        function displayResults(results, params) {
            // Hide empty state and show results section
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('results').style.display = 'block';

            // Hide back to results button when viewing results
            hideBackToResultsButton();

            // Restore Single Asset layout: show original charts, hide Monte Carlo section
            const resultsDiv = document.getElementById('results');
            const originalChartsGrid = document.getElementById('section-charts');
            if (originalChartsGrid) {
                originalChartsGrid.style.display = 'grid';
            }
            document.getElementById('monteCarloChartsSection').style.display = 'none';

            // Hide Monte Carlo-specific summary card that may be present from previous run
            const monteCarloSummaryCard = resultsDiv.querySelector('.monte-carlo-summary-card');
            if (monteCarloSummaryCard) {
                monteCarloSummaryCard.style.display = 'none';
            }

            // Hide Performance Summary card that may be present from previous Monte Carlo run
            const performanceSummaryCard = resultsDiv.querySelector('.performance-summary-card');
            if (performanceSummaryCard) {
                performanceSummaryCard.style.display = 'none';
            }

            // Hide Assets Correlation card
            const assetsCorrelationCard = resultsDiv.querySelector('.assets-correlation-card');
            if (assetsCorrelationCard) {
                assetsCorrelationCard.style.display = 'none';
            }

            // Hide Expected Return card
            const expectedReturnCard = resultsDiv.querySelector('.expected-return-card');
            if (expectedReturnCard) {
                expectedReturnCard.style.display = 'none';
            }

            // Hide Return Probabilities card
            const returnProbCard = resultsDiv.querySelector('.return-prob-card');
            if (returnProbCard) {
                returnProbCard.style.display = 'none';
            }

            // Hide Monte Carlo percentile table (Year-by-Year Percentile Analysis)
            const percentileTableCard = resultsDiv.querySelector('.percentile-table-card');
            if (percentileTableCard) {
                percentileTableCard.style.display = 'none';
            }

            // Show Year-by-Year table
            const yearByYearSection = document.getElementById('section-year-by-year');
            if (yearByYearSection) {
                yearByYearSection.style.display = 'block';
            }

            // Salary Equivalent with Tax Savings
            const salaryEquiv = calculateSalaryEquivalent(params.annualWithdrawal);
            const taxSavings = salaryEquiv - params.annualWithdrawal;

            document.getElementById('salaryEquivalent').textContent =
                '$' + params.annualWithdrawal.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            document.getElementById('taxableEquivalent').textContent =
                '$' + salaryEquiv.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            document.getElementById('taxSavingsText').textContent =
                `You save approximately $${taxSavings.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} in annual taxes by using the Buy Borrow Die strategy (based on 2024 federal tax rates for single filer)`;

            // Summary Text
            const lastResult = results[results.length - 1];
            const finalNetWorth = lastResult.netPortfolio;
            const totalBorrowed = lastResult.locBalance;
            // Calculate CAGR: ((Final Value / Initial Value) ^ (1 / Years)) - 1
            const firstResult = results[0];
            const cagr = (Math.pow(lastResult.portfolioValue / firstResult.portfolioValue, 1 / params.period) - 1) * 100;

            const withdrawalYears = params.startYear + params.period - params.withdrawalStartYear;
            const endYear = params.startYear + params.period;

            let summaryHTML = `
                <p>Starting with <strong>$${params.startValue.toLocaleString()}</strong> invested in <strong>${params.assetName}</strong>,
                this simulation models a ${params.period}-year Buy Borrow Die strategy from ${params.startYear} to ${endYear}.</p>
            `;

            // Add growth period paragraph only if there was a growth period
            if (params.withdrawalStartYear > params.startYear) {
                summaryHTML += `
                    <p>The portfolio grew without withdrawals from ${params.startYear} to ${params.withdrawalStartYear - 1}.
                    Annual withdrawals of <strong>$${params.annualWithdrawal.toLocaleString()}</strong> began in ${params.withdrawalStartYear}
                    with a <strong>${params.annualRaise.toFixed(1)}%</strong> annual increase. Borrowing occurred through a securities-backed
                    line of credit (SBLOC) at <strong>${params.sblocRate.toFixed(2)}%</strong> interest.</p>
                `;
            } else {
                summaryHTML += `
                    <p>Annual withdrawals of <strong>$${params.annualWithdrawal.toLocaleString()}</strong> began immediately in ${params.withdrawalStartYear}
                    with a <strong>${params.annualRaise.toFixed(1)}%</strong> annual increase. Borrowing occurred through a securities-backed
                    line of credit (SBLOC) at <strong>${params.sblocRate.toFixed(2)}%</strong> interest.</p>
                `;
            }

            summaryHTML += `
                <p>After ${params.period} years, the portfolio grew to <strong>$${lastResult.portfolioValue.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</strong>,
                with total debt of <strong>$${totalBorrowed.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</strong>,
                resulting in a net worth of <strong class="${finalNetWorth >= 0 ? 'positive' : 'negative'}">
                $${finalNetWorth.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</strong>.</p>
            `;

            // Summary text element may not exist if consolidated into Strategy Analysis
            const summaryTextElement = document.getElementById('summaryText');
            if (summaryTextElement) summaryTextElement.innerHTML = summaryHTML;

            // Executive Summary
            generateExecutiveSummary(results, params);

            // Key Metrics
            const totalWithdrawn = results.reduce((sum, r) => sum + r.withdrawal, 0);

            // Find margin call info
            let marginCallValue = 'None';
            let marginCallCardClass = 'margin-call-safe';
            let marginCallTextClass = 'positive';
            if (params.marginCallTriggered && params.yearOfMarginCall) {
                const marginCallResult = results.find(r => r.year === params.yearOfMarginCall);
                if (marginCallResult) {
                    marginCallValue = `${marginCallResult.locUsedPct.toFixed(1)}% / ${params.yearOfMarginCall}`;
                    marginCallCardClass = 'margin-call-warning';
                    marginCallTextClass = 'negative';
                }
            }

            const metricsHTML = `
                <!-- Tier 1: Hero Metrics -->
                <div class="hero-metrics-row">
                    <div class="hero-metric-card ${marginCallCardClass}">
                        <div class="metric-icon"></div>
                        <div class="metric-label">Margin Call Year</div>
                        <div class="metric-value">${marginCallValue}</div>
                    </div>
                    <div class="hero-metric-card">
                        <div class="metric-icon"></div>
                        <div class="metric-label">Final Net Worth</div>
                        <div class="metric-value ${finalNetWorth >= 0 ? 'positive' : 'negative'}">
                            $${(finalNetWorth / 1000000).toFixed(2)}M
                        </div>
                    </div>
                    <div class="hero-metric-card">
                        <div class="metric-icon"></div>
                        <div class="metric-label">CAGR</div>
                        <div class="metric-value ${cagr >= 0 ? 'positive' : 'negative'}">
                            ${cagr.toFixed(2)}%
                        </div>
                    </div>
                </div>

                <!-- Tier 2: Secondary Metrics -->
                <div class="secondary-metrics-row">
                    <div class="secondary-metric-card">
                        <span class="material-icons metric-icon-secondary">payments</span>
                        <div class="metric-content">
                            <div class="metric-label-secondary">Total Withdrawn</div>
                            <div class="metric-value-secondary">$${(totalWithdrawn / 1000000).toFixed(2)}M</div>
                        </div>
                    </div>
                    <div class="secondary-metric-card">
                        <span class="material-icons metric-icon-secondary">credit_card</span>
                        <div class="metric-content">
                            <div class="metric-label-secondary">Total Debt</div>
                            <div class="metric-value-secondary">$${(totalBorrowed / 1000000).toFixed(2)}M</div>
                        </div>
                    </div>
                    <div class="secondary-metric-card">
                        <span class="material-icons metric-icon-secondary">show_chart</span>
                        <div class="metric-content">
                            <div class="metric-label-secondary">Final Year Withdrawal</div>
                            <div class="metric-value-secondary">$${(lastResult.withdrawal / 1000).toFixed(0)}K</div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('keyMetrics').innerHTML = metricsHTML;

            // Year by Year Table
            let tableHTML = '';
            results.forEach(result => {
                tableHTML += `
                    <tr>
                        <td><strong>${result.year}</strong></td>
                        <td class="${result.returnPct >= 0 ? 'positive' : 'negative'}">${result.returnPct.toFixed(2)}%</td>
                        <td>$${result.portfolioValue.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                        <td>$${result.withdrawal.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                        <td>$${result.locBalance.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                        <td class="${result.locUsedPct > params.maxBorrowing ? 'negative' : ''}">${result.locUsedPct.toFixed(1)}%</td>
                        <td class="${result.netPortfolio >= 0 ? 'positive' : 'negative'}">
                            $${result.netPortfolio.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                        </td>
                    </tr>
                `;
            });
            document.getElementById('yearTableBody').innerHTML = tableHTML;

            // Store results and params for theme switching
            currentResults = results;
            currentParams = params;

            // Charts
            createTrendChart(results);
            createDebtChart(results, params.maxBorrowing);

            // Show print button after simulation completes
            showPrintButton();

            // Show TOC navigation button after successful simulation
            showTOCButton();

            // Scroll to results
            document.querySelector('.main-content').scrollTop = 0;
        }

        // Helper function to get chart text color that works in both light and dark mode
        function getChartTextColor() {
            const theme = document.documentElement.getAttribute('data-theme');
            const color = getComputedStyle(document.documentElement).getPropertyValue('--md-sys-color-on-surface').trim();

            // If the color is empty or invalid, fall back to a sensible default based on theme
            if (!color) {
                const isDark = theme === 'dark';
                const fallback = isDark ? '#E8EAF6' : '#1D1B20';
                return fallback;
            }
            return color;
        }

        // Helper function to get chart grid color that works in both light and dark mode
        function getChartGridColor() {
            const theme = document.documentElement.getAttribute('data-theme');
            const isDark = theme === 'dark';
            // In dark mode, use light grid lines; in light mode, use dark grid lines
            return isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        }

        function createTrendChart(results) {
            const ctx = document.getElementById('trendChart');

            if (trendChart) {
                trendChart.destroy();
            }

            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? '#E6E0E9' : '#1D1B20';
            const gridColor = isDark ? '#49454F' : '#E7E0EC';

            // Color palette optimized for both light and dark modes
            const assetsColor = isDark ? '#A8C5FF' : '#4A7BCC';
            const debtColor = isDark ? '#FF8A80' : '#D32F2F';
            const netWorthColor = isDark ? '#81C784' : '#388E3C';

            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: results.map(r => r.year),
                    datasets: [
                        {
                            label: 'Assets',
                            data: results.map(r => r.portfolioValue),
                            borderColor: assetsColor,
                            backgroundColor: isDark ? 'rgba(168, 197, 255, 0.1)' : 'rgba(74, 123, 204, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'Debt',
                            data: results.map(r => r.locBalance),
                            borderColor: debtColor,
                            backgroundColor: isDark ? 'rgba(255, 138, 128, 0.1)' : 'rgba(211, 47, 47, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'Net Worth',
                            data: results.map(r => r.netPortfolio),
                            borderColor: netWorthColor,
                            backgroundColor: isDark ? 'rgba(129, 199, 132, 0.1)' : 'rgba(56, 142, 60, 0.1)',
                            borderWidth: 4,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 3,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: textColor,
                                font: { size: 14, family: 'Roboto' }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: isDark ? 'rgba(30, 30, 30, 0.95)' : 'rgba(255, 255, 255, 0.95)',
                            titleColor: textColor,
                            bodyColor: textColor,
                            borderColor: gridColor,
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                title: function(tooltipItems) {
                                    return 'Year ' + tooltipItems[0].label;
                                },
                                label: function(context) {
                                    return context.dataset.label + ': $' +
                                        context.parsed.y.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        },
                        y: {
                            ticks: {
                                color: textColor,
                                callback: function(value) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                }
                            },
                            grid: { color: gridColor }
                        }
                    }
                }
            });
        }

        function createDebtChart(results, maxBorrowing) {
            const ctx = document.getElementById('debtChart');

            if (!ctx) {
                console.error('debtChart canvas element not found');
                return;
            }

            if (debtChart) {
                debtChart.destroy();
            }

            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? '#E6E0E9' : '#1D1B20';
            const gridColor = isDark ? '#49454F' : '#E7E0EC';

            // Color palette optimized for both light and dark modes
            const balanceColor = isDark ? '#00836E' : '#004C45';
            const ratioColor = isDark ? '#FFB74D' : '#F57C00';

            debtChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: results.map(r => r.year),
                    datasets: [
                        {
                            label: 'Balance: Borrowed for Income + Interest',
                            data: results.map(r => r.locBalance),
                            backgroundColor: isDark ? 'rgba(206, 147, 216, 0.7)' : 'rgba(142, 36, 170, 0.7)',
                            borderColor: balanceColor,
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Debt to LOC Limit Ratio',
                            data: results.map(r => r.locUsedPct),
                            type: 'line',
                            borderColor: ratioColor,
                            backgroundColor: isDark ? 'rgba(255, 183, 77, 0.1)' : 'rgba(245, 124, 0, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.1,
                            yAxisID: 'y1',
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: textColor,
                                font: { size: 14, family: 'Roboto' }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: isDark ? 'rgba(30, 30, 30, 0.95)' : 'rgba(255, 255, 255, 0.95)',
                            titleColor: textColor,
                            bodyColor: textColor,
                            borderColor: gridColor,
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                title: function(tooltipItems) {
                                    return 'Year ' + tooltipItems[0].label;
                                },
                                label: function(context) {
                                    if (context.datasetIndex === 0) {
                                        return context.dataset.label + ': $' +
                                            context.parsed.y.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                                    } else {
                                        return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            ticks: {
                                color: textColor,
                                callback: function(value) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                }
                            },
                            grid: { color: gridColor },
                            title: {
                                display: true,
                                text: 'LOC Balance ($)',
                                color: textColor
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            ticks: {
                                color: textColor,
                                callback: function(value) {
                                    return value.toFixed(0) + '%';
                                }
                            },
                            grid: { display: false },
                            title: {
                                display: true,
                                text: 'LOC Used (%)',
                                color: textColor
                            },
                            max: Math.max(100, maxBorrowing * 1.2)
                        }
                    }
                }
            });
        }

        function updateChartTheme() {
            // Update single simulation charts
            if (currentResults && currentParams) {
                createTrendChart(currentResults);
                createDebtChart(currentResults, currentParams.maxBorrowing);
            }

            // Update Monte Carlo charts
            if (currentMonteCarloPercentilesData && currentMonteCarloResults && currentMonteCarloParams) {
                drawProbabilityConeChart(currentMonteCarloPercentilesData);
                drawMCSBLOCBalanceChart(currentMonteCarloPercentilesData, currentMonteCarloParams);
                drawSBLOCUtilizationChart(currentMonteCarloPercentilesData, currentMonteCarloParams);
                drawNetWorthPercentilesChart(currentMonteCarloPercentilesData); // NEW: Net Worth Across Simulations
                drawMarginCallRiskChart(currentMonteCarloResults);
                drawTerminalDistributionChart(currentMonteCarloResults);
                // Update liquidity stress testing chart
                if (currentMonteCarloResults.liquidityStats) {
                    drawLiquiditySafetyBufferChart(currentMonteCarloResults.liquidityStats, currentMonteCarloParams);
                }
                // Update comparison charts (Visual Comparison section)
                createComparisonCharts(currentMonteCarloResults);
            }
        }

        // Provide guidance for avoiding margin calls
        function findMarginCallAvoidanceStrategy(params, results) {
            if (!params.marginCallTriggered || !params.yearOfMarginCall) {
                return null;
            }

            return `Consider reducing your annual withdrawal amount, using the Withdrawal Chapters feature to reduce spending over time, or increasing your initial portfolio value.`;
        }

        function generateExecutiveSummary(results, params) {
            const lastResult = results[results.length - 1];
            const finalNetWorth = lastResult.netPortfolio;
            const totalBorrowed = lastResult.locBalance;
            // Calculate CAGR: ((Final Value / Initial Value) ^ (1 / Years)) - 1
            const firstResult = results[0];
            const cagr = (Math.pow(lastResult.portfolioValue / firstResult.portfolioValue, 1 / params.period) - 1) * 100;
            const totalWithdrawn = results.reduce((sum, r) => sum + r.withdrawal, 0);
            const netWorthIncrease = ((finalNetWorth - params.startValue) / params.startValue) * 100;
            const maxLocUsed = Math.max(...results.map(r => r.locUsedPct));

            // Strategy Overview
            const withdrawalYears = params.startYear + params.period - params.withdrawalStartYear;
            const growthYears = params.withdrawalStartYear - params.startYear;

            let overviewHTML = `This analysis examines the viability of implementing the Buy Borrow Die (BBD) strategy with <strong>${params.assetName}</strong> over a ${params.period}-year period.`;
            if (growthYears > 0) {
                overviewHTML += ` It takes the historical performance of the asset and applies it to the current year and ${params.period}-years out to simulate real-world turbulence of markets ups and downs.`;
            } else {
                overviewHTML += ` It takes the historical performance of the asset and applies it to simulate real-world turbulence of markets ups and downs.`;
            }
            const strategyOverviewEl = document.getElementById('strategyOverview');
            if (strategyOverviewEl) strategyOverviewEl.innerHTML = overviewHTML;

            // Strategy Outcome
            const isViable = finalNetWorth > 0 && !params.marginCallTriggered;
            let outcomeHTML = '';
            if (isViable) {
                outcomeHTML = `<span class="check"> STRATEGY VIABLE:</span> The Buy Borrow Die strategy appears viable with these parameters. Your net worth grows while maintaining tax-efficient withdrawals.`;
            } else if (finalNetWorth <= 0) {
                outcomeHTML = `<span class="check" style="color: #DC2626;"> STRATEGY AT RISK:</span> The strategy depletes your net worth by year ${params.startYear + params.period}. Consider reducing withdrawal amounts or adjusting parameters.`;
            } else if (params.marginCallTriggered) {
                outcomeHTML = `<span class="check" class="text-warning-orange"> MARGIN CALL RISK:</span> LOC utilization exceeded ${params.maxBorrowing.toFixed(0)}% limit in ${params.yearOfMarginCall}. This would trigger a margin call requiring immediate action.`;

                // Add recommendation for avoiding margin call
                const recommendation = findMarginCallAvoidanceStrategy(params, results);
                if (recommendation) {
                    outcomeHTML += `<br><br><strong> Recommendation:</strong> ${recommendation}`;
                }
            } else {
                outcomeHTML = `<span class="check" class="text-warning-orange"> CAUTION:</span> Review your parameters carefully to ensure strategy viability.`;
            }
            const outcomeBoxEl = document.getElementById('outcomeBox');
            if (outcomeBoxEl) outcomeBoxEl.innerHTML = outcomeHTML;

            // Key Findings
            const keyFindingsHTML = `
                <li><strong>Initial Portfolio Value:</strong> $${params.startValue.toLocaleString()} in ${params.assetName}</li>
                <li><strong>CAGR (Compounded Annual Growth Rate):</strong> ${cagr.toFixed(2)}%</li>
                <li><strong>Final Portfolio Value:</strong> $${lastResult.portfolioValue.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</li>
                <li><strong>Total Debt Accumulated:</strong> $${totalBorrowed.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</li>
                <li><strong>Net Worth:</strong> $${finalNetWorth.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} (${netWorthIncrease >= 0 ? '+' : ''}${netWorthIncrease.toFixed(2)}% vs. initial)</li>
                <li><strong>Final LOC Utilization:</strong> ${lastResult.locUsedPct.toFixed(1)}% (limit: ${params.maxBorrowing}%)</li>
                <li><strong>Total Withdrawn:</strong> $${totalWithdrawn.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</li>
                <li><strong>Years of Withdrawals:</strong> ${withdrawalYears} year(s)</li>
            `;
            const keyFindingsListEl = document.getElementById('keyFindingsList');
            if (keyFindingsListEl) keyFindingsListEl.innerHTML = keyFindingsHTML;

            // Strategic Considerations
            const strategicHTML = `
                <li><strong>Tax Efficiency:</strong> All withdrawals are borrowed funds, creating no taxable events during your lifetime</li>
                <li><strong>Estate Planning:</strong> Upon death, your heirs receive a step-up in cost basis, potentially eliminating capital gains tax</li>
                <li><strong>Interest Cost:</strong> SBLOC interest (${params.sblocRate.toFixed(2)}%) is the primary ongoing cost</li>
                <li><strong>Market Risk:</strong> Strategy depends on asset appreciation exceeding the interest rate over time</li>
            `;
            const strategicConsiderationsListEl = document.getElementById('strategicConsiderationsList');
            if (strategicConsiderationsListEl) strategicConsiderationsListEl.innerHTML = strategicHTML;

            // Next Steps
            const nextStepsHTML = `
                <li>Consult with an estate planning attorney to structure the strategy properly</li>
                <li>Work with a tax professional to optimize the SBLOC structure</li>
                <li>Review and rebalance annually to maintain appropriate loan-to-value ratios</li>
                <li>Consider diversification within your portfolio to manage risk</li>
            `;
            const nextStepsListEl = document.getElementById('nextStepsList');
            if (nextStepsListEl) nextStepsListEl.innerHTML = nextStepsHTML;
        }

        // Store results for theme updates
        window.addEventListener('beforeunload', () => {
            // Results would need to be stored if we want to persist theme changes
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Load settings from localStorage
            loadSettings();

            // Initialize theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            const themeIcon = document.getElementById('theme-icon');
            if (themeIcon) {
                themeIcon.textContent = savedTheme === 'dark' ? 'dark_mode' : 'light_mode';
            }

            // CRITICAL FIX: Wait for historical data to load before initializing Monte Carlo mode
            // This prevents correlation matrix from showing all zeros when "Last portfolio restored" runs
            // The correlation matrix needs historicalDataLibrary to be populated to calculate correlations
            try {
                await loadHistoricalDataLibrary();
                console.log(' Historical data loaded successfully before mode initialization');
            } catch (error) {
                console.error('Error loading historical data:', error);
                // Continue anyway - mode will work but correlations may be empty
            }

            // Initialize Monte Carlo mode (ensures dynamic elements are properly set up)
            // This handles: portfolio presets visibility, run button text, auto-restore last portfolio
            // Now runs AFTER historical data is loaded, so correlation matrix displays correctly
            switchSimulationMode('montecarlo');

            // Initialize tax inputs visibility based on checkbox state
            toggleTaxInputs();

            // Initialize regime mode toggle visibility and event listeners
            updateRegimeModeToggleVisibility();

            // Add event listener for return model dropdown
            const returnModelSelect = document.getElementById('returnModel');
            if (returnModelSelect) {
                returnModelSelect.addEventListener('change', updateRegimeModeToggleVisibility);
            }

            // Add event listeners for regime mode radio buttons
            document.querySelectorAll('input[name="regimeMode"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    updateRegimeModeDescription();
                    // Save settings when regime mode changes
                    if (typeof saveSettings === 'function') {
                        settingsState.regimeMode = getRegimeMode();
                        saveSettings();
                    }
                });
            });

            // Add window resize listener to recalculate chart dimensions
            let resizeTimeout;
            let lastWidth = window.innerWidth;

            const resizeCharts = () => {
                // Resize all active chart instances
                // Reset canvas display size to force Chart.js to recalculate
                const charts = [
                    { instance: window.liquiditySafetyBufferChartInstance, id: 'liquiditySafetyBufferChart' },
                    { instance: window.marginCallRiskChartInstance, id: 'marginCallRiskChart' },
                    { instance: window.terminalDistributionChartInstance, id: 'terminalDistributionChart' },
                    { instance: window.sblocUtilizationChartInstance, id: 'sblocUtilizationChart' },
                    { instance: window.netWorthPercentilesChartInstance, id: 'netWorthPercentilesChart' }
                ];

                charts.forEach(({ instance, id }) => {
                    if (instance) {
                        try {
                            const canvas = document.getElementById(id);
                            if (canvas) {
                                // Reset canvas width/height attributes that Chart.js sets
                                // This forces Chart.js to recalculate based on current container size
                                canvas.removeAttribute('width');
                                canvas.removeAttribute('height');
                            }
                            instance.resize();
                            instance.draw();
                        } catch (e) {
                            console.error(`Error resizing chart ${id}:`, e);
                        }
                    }
                });
            };

            window.addEventListener('resize', () => {
                const currentWidth = window.innerWidth;
                const isShrinking = currentWidth < lastWidth;

                // Always debounce resize events to ensure Chart.js has time to recalculate
                // Use shorter delay for shrinking to respond quickly to overflow
                clearTimeout(resizeTimeout);
                const delay = isShrinking ? 100 : 250;
                resizeTimeout = setTimeout(() => {
                    resizeCharts();
                    lastWidth = currentWidth;
                }, delay);
            });
        });

        /* ========================================
           TOC Navigation - Scroll Spy & Smooth Scroll
           ======================================== */

        // Cleanup previous observers if reinitializing
        if (window.tocObservers) {
            window.tocObservers.forEach(obs => obs.disconnect());
        }
        window.tocObservers = [];

        // Section mapping - defined at module scope for access in click handlers
        const tocSectionMap = {
            'results': 'results',
            'recommendations': 'section-monte-carlo-results',
            'monte-carlo': 'monteCarloChartsSection',
            'stress-testing': 'section-stress-testing',
            'salary-equivalent': 'section-salary-equivalent',
            'strategy-analysis': 'strategyAnalysisSection'
        };

        function initTOC() {
            const tocNav = document.getElementById('tocNav');
            const tocToggle = document.getElementById('tocToggle');

            // Exit if TOC elements don't exist
            if (!tocNav || !tocToggle) return;

            const tocItems = document.querySelectorAll('.toc-nav-item');
            const sections = [];

            // Build sections array from the map
            tocItems.forEach(item => {
                const sectionKey = item.getAttribute('data-section');
                const elementId = tocSectionMap[sectionKey];
                const element = elementId ? document.getElementById(elementId) : null;
                if (element) {
                    sections.push({
                        id: sectionKey,
                        element: element,
                        navItem: item
                    });
                }
            });

            // Update visibility of conditional TOC items (shown only after Monte Carlo simulation)
            function updateConditionalSections() {
                const statusBannerSection = document.getElementById('section-status-banner');
                const recommendationsSection = document.getElementById('section-monte-carlo-results');
                const monteCarloChartsSection = document.getElementById('monteCarloChartsSection');

                // Results TOC item (visible when results section exists)
                const resultsItem = document.querySelector('.toc-nav-item[data-section="results"]');
                if (resultsItem) {
                    const isVisible = document.getElementById('results') !== null;
                    resultsItem.classList.toggle('toc-hidden', !isVisible);
                }

                // Recommendations TOC item (visible when recommendations section exists)
                const recommendationsItem = document.querySelector('.toc-nav-item[data-section="recommendations"]');
                if (recommendationsItem) {
                    const isVisible = recommendationsSection !== null;
                    recommendationsItem.classList.toggle('toc-hidden', !isVisible);
                }

                // Monte Carlo Charts TOC item (visible when MC charts section is displayed)
                const monteCarloItem = document.querySelector('.toc-nav-item[data-section="monte-carlo"]');
                if (monteCarloItem) {
                    const isVisible = monteCarloChartsSection && monteCarloChartsSection.style.display !== 'none';
                    monteCarloItem.classList.toggle('toc-hidden', !isVisible);
                }

                // Stress Testing TOC item (visible when MC charts section is displayed, since it's inside)
                const stressTestingItem = document.querySelector('.toc-nav-item[data-section="stress-testing"]');
                if (stressTestingItem) {
                    const isVisible = monteCarloChartsSection && monteCarloChartsSection.style.display !== 'none';
                    stressTestingItem.classList.toggle('toc-hidden', !isVisible);
                }
            }

            // Intersection Observer for scroll spy
            const observerOptions = {
                root: null,
                rootMargin: '-20% 0px -70% 0px',
                threshold: 0
            };

            const scrollObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const section = sections.find(s => s.element === entry.target);
                        if (section) {
                            tocItems.forEach(item => item.classList.remove('active'));
                            section.navItem.classList.add('active');
                        }
                    }
                });
            }, observerOptions);

            // Store observer for cleanup
            window.tocObservers.push(scrollObserver);

            // Observe all sections
            sections.forEach(section => {
                if (section.element) {
                    scrollObserver.observe(section.element);
                }
            });

            // Smooth scroll on click - TOC stays open until user closes it
            tocItems.forEach(item => {
                // Remove href to prevent default anchor behavior
                item.removeAttribute('href');

                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();

                    const sectionKey = item.getAttribute('data-section');
                    const elementId = tocSectionMap[sectionKey];
                    const targetElement = elementId ? document.getElementById(elementId) : null;

                    console.log('TOC click:', sectionKey, '-> element:', elementId, targetElement ? 'found' : 'not found');

                    if (targetElement) {
                        // Manual scroll within .main-content only (prevents document scroll)
                        const mainContent = document.querySelector('.main-content');
                        if (mainContent) {
                            // Calculate element's position relative to main-content
                            const containerRect = mainContent.getBoundingClientRect();
                            const elementRect = targetElement.getBoundingClientRect();
                            const scrollOffset = 24; // Breathing room from top

                            // Calculate target scroll position
                            const targetScrollTop = mainContent.scrollTop + (elementRect.top - containerRect.top) - scrollOffset;

                            // Smooth scroll within main-content only
                            mainContent.scrollTo({
                                top: Math.max(0, targetScrollTop),
                                behavior: 'smooth'
                            });
                        }

                        // Update active state immediately
                        tocItems.forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                    }
                    // TOC stays open - user must click toggle button to close
                });
            });

            // Watch for simulation mode changes
            const mcSection = document.getElementById('monteCarloChartsSection');
            const compCard = document.getElementById('comparisonCard');

            if (mcSection) {
                const mcObserver = new MutationObserver(updateConditionalSections);
                mcObserver.observe(mcSection, { attributes: true, attributeFilter: ['style'] });
                window.tocObservers.push(mcObserver);
            }

            if (compCard) {
                const compObserver = new MutationObserver(updateConditionalSections);
                compObserver.observe(compCard, { attributes: true, attributeFilter: ['style'] });
                window.tocObservers.push(compObserver);
            }

            // TOC stays open until user clicks toggle button - no click-outside-to-close

            // Initial check after a short delay to ensure sections are initialized
            requestAnimationFrame(updateConditionalSections);
        }

        function toggleTOC() {
            const tocNav = document.getElementById('tocNav');
            const tocToggle = document.getElementById('tocToggle');
            if (!tocNav || !tocToggle) return;

            tocNav.classList.toggle('visible');
            tocToggle.classList.toggle('toc-open');
        }

        // Initialize TOC when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initTOC);
        } else {
            initTOC();
        }

        // ========================================
        // Print Report Functionality
        // ========================================

        /**
         * Opens a new browser window with a print-optimized version of the simulation report.
         * Converts Chart.js canvases to images and generates a complete, self-contained HTML document.
         */
        function openPrintWindow() {
            // Collect all chart images
            const chartImages = collectChartImages();

            // Generate the print-ready HTML content
            const printContent = generatePrintHTML(chartImages);

            // Open a new window and write the content
            const printWindow = window.open('', '_blank', 'width=1000,height=800');
            if (!printWindow) {
                alert('Please allow pop-ups to open the print report.');
                return;
            }

            printWindow.document.write(printContent);
            printWindow.document.close();
        }

        /**
         * Collects all Chart.js canvas elements and converts them to base64 images.
         * @returns {Object} Object containing chart image data URLs
         */
        function collectChartImages() {
            const images = {};

            // List of chart instances and their corresponding canvas IDs
            const chartConfigs = [
                { instance: window.sblocUtilizationChartInstance, id: 'sblocUtilizationChart', name: 'SBLOC Utilization' },
                { instance: window.netWorthPercentilesChartInstance, id: 'netWorthPercentilesChart', name: 'Net Worth Percentiles' },
                { instance: window.marginCallRiskChartInstance, id: 'marginCallRiskChart', name: 'Margin Call Risk' },
                { instance: window.terminalDistributionChartInstance, id: 'terminalDistributionChart', name: 'Terminal Distribution' },
                { instance: window.liquiditySafetyBufferChartInstance, id: 'liquiditySafetyBufferChart', name: 'Liquidity Safety Buffer' },
                { instance: window.comparisonNetWorthChartInstance, id: 'comparisonNetWorthChart', name: 'Comparison Net Worth' },
                { instance: window.comparisonTaxChartInstance, id: 'comparisonTaxChart', name: 'Comparison Tax' },
                { instance: window.comparisonDistributionChartInstance, id: 'comparisonDistributionChart', name: 'Comparison Distribution' },
                { instance: trendChart, id: 'trendChart', name: 'Net Worth Trend' },
                { instance: debtChart, id: 'debtChart', name: 'SBLOC Balance' }
            ];

            chartConfigs.forEach(config => {
                const canvas = document.getElementById(config.id);
                if (canvas && config.instance) {
                    try {
                        // Temporarily set white background for better printing
                        const ctx = canvas.getContext('2d');
                        const originalFillStyle = ctx.fillStyle;

                        // Create a temporary canvas with white background
                        const tempCanvas = document.createElement('canvas');
                        tempCanvas.width = canvas.width;
                        tempCanvas.height = canvas.height;
                        const tempCtx = tempCanvas.getContext('2d');

                        // Fill with white background
                        tempCtx.fillStyle = '#FFFFFF';
                        tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

                        // Draw the original chart on top
                        tempCtx.drawImage(canvas, 0, 0);

                        images[config.id] = tempCanvas.toDataURL('image/png', 1.0);
                    } catch (e) {
                        console.warn(`Could not capture chart ${config.id}:`, e);
                    }
                }
            });

            return images;
        }

        /**
         * Extracts key metrics and portfolio data for print layout.
         * @returns {Object} Object containing all extracted metrics
         */
        function extractPrintMetrics() {
            // Extract portfolio assets from the global selectedPortfolioAssets
            const assets = [];
            const assetColors = [
                '#4C6FFF', '#A855F7', '#38BDF8', '#22C55E', '#F97316',
                '#6B8CFF', '#C196FF', '#5DDBF1', '#4ADE80', '#FBBF24'
            ];

            if (typeof selectedPortfolioAssets !== 'undefined' && selectedPortfolioAssets) {
                Object.entries(selectedPortfolioAssets).forEach(([name, weight], index) => {
                    assets.push({
                        name: name,
                        weight: weight,
                        color: assetColors[index % assetColors.length]
                    });
                });
            }

            // Extract form values for simulation parameters
            const startValue = parseFloat(document.getElementById('startValue')?.value) || 0;
            const period = parseInt(document.getElementById('period')?.value) || 20;
            const annualWithdrawal = parseFloat(document.getElementById('annualWithdrawal')?.value) || 0;
            const annualRaise = parseFloat(document.getElementById('annualRaise')?.value) || 0;
            const sblocRate = parseFloat(document.getElementById('sblocRate')?.value) || 0;
            const maxBorrowing = parseFloat(document.getElementById('maxBorrowing')?.value) || 65;
            const maintenanceMargin = parseFloat(document.getElementById('maintenanceMargin')?.value) || 50;
            const numSimulations = parseInt(document.getElementById('numSimulations')?.value) || 5000;

            // Extract return model and regime mode
            const returnModel = document.getElementById('returnModel')?.value || 'bootstrap';
            const regimeMode = document.querySelector('input[name="regimeMode"]:checked')?.value || 'conservative';

            // Extract Status Banner data
            const statusBannerEl = document.querySelector('.status-banner-card .guardrails-status-banner');
            let statusBannerStatus = 'green';
            let statusBannerTitle = '';
            let statusBannerMessage = '';
            if (statusBannerEl) {
                if (statusBannerEl.classList.contains('status-yellow')) statusBannerStatus = 'yellow';
                else if (statusBannerEl.classList.contains('status-red')) statusBannerStatus = 'red';
                statusBannerTitle = statusBannerEl.querySelector('.status-title')?.textContent || '';
                statusBannerMessage = statusBannerEl.querySelector('.status-message')?.textContent || '';
            }

            // Extract Recommendations from the new section
            const recommendations = [];
            const recommendationsSection = document.querySelector('#section-monte-carlo-results .recommendations-list');
            if (recommendationsSection) {
                const recItems = recommendationsSection.querySelectorAll('.recommendation-item');
                recItems.forEach(item => {
                    const type = item.classList.contains('critical') ? 'critical' :
                                 item.classList.contains('warning') ? 'warning' :
                                 item.classList.contains('opportunity') ? 'opportunity' : 'info';
                    const message = item.querySelector('.recommendation-message')?.textContent || '';
                    const action = item.querySelector('.recommendation-action')?.textContent?.replace('Action:', '').trim() || '';
                    recommendations.push({ type, message, action });
                });
            }

            // Extract success rate and hero card metrics from displayed results
            const keyMetricsEl = document.getElementById('keyMetrics');
            let successRate = 0;
            let hasEscapeVelocity = false;
            let sellSuccessRate = null;
            let successAdvantage = null;
            let impliedCAGR = null;
            let startingValue = startValue;
            let medianTerminal = null;
            let p10Outcome = null;
            let sellTerminalMedian = null;
            let terminalValueAdvantage = null;
            // Leverage Safety card metrics
            let leveragePeakLTV = null;
            let leverageBufferToMarginCall = null;
            let leverageWorstCase = null;
            // Margin Call Risk card metrics
            let marginCallRate = null;
            let liquidationHaircut = null;
            let marginWarningZone = null;
            let marginCallTarget = null;
            // Legacy fields for backward compatibility
            let p90LocUtilization = null;
            let p10SafetyBuffer = null;
            let mostDangerousYear = null;

            if (keyMetricsEl) {
                // Check for escape velocity banner
                hasEscapeVelocity = keyMetricsEl.querySelector('.escape-velocity-banner') !== null;

                // Find all hero metric cards and extract their data
                const heroCards = keyMetricsEl.querySelectorAll('.hero-metric-card');
                heroCards.forEach(card => {
                    const title = card.querySelector('.card-title')?.textContent || '';
                    const mainValue = card.querySelector('.metric-value')?.textContent || '';
                    const secondaryItems = card.querySelectorAll('.secondary-item');
                    const worstCase = card.querySelector('.worst-case-text');

                    if (title.includes('Strategy Success')) {
                        successRate = parseFloat(mainValue) || 0;
                        secondaryItems.forEach(item => {
                            const label = item.querySelector('.secondary-label')?.textContent || '';
                            const value = item.querySelector('.secondary-value')?.textContent || '';
                            if (label.includes('vs Sell')) {
                                successAdvantage = parseFloat(value) || null;
                            } else if (label.includes('Sell Success')) {
                                sellSuccessRate = parseFloat(value) || null;
                            }
                        });
                    } else if (title.includes('Portfolio Growth')) {
                        impliedCAGR = parseFloat(mainValue) || null;
                        secondaryItems.forEach(item => {
                            const label = item.querySelector('.secondary-label')?.textContent || '';
                            const value = item.querySelector('.secondary-value')?.textContent || '';
                            if (label.includes('Median Terminal')) {
                                medianTerminal = value;
                            } else if (label.includes('vs Sell')) {
                                terminalValueAdvantage = value;
                            } else if (label.includes('Sell Terminal')) {
                                sellTerminalMedian = value;
                            }
                        });
                        if (worstCase) {
                            const p10Match = worstCase.textContent.match(/P10 outcome:\s*([\-\$\d,]+)/);
                            if (p10Match) p10Outcome = p10Match[1];
                        }
                    } else if (title.includes('Leverage Safety')) {
                        leveragePeakLTV = parseFloat(mainValue) || null;
                        p90LocUtilization = leveragePeakLTV; // backward compat
                        secondaryItems.forEach(item => {
                            const label = item.querySelector('.secondary-label')?.textContent || '';
                            const value = item.querySelector('.secondary-value')?.textContent || '';
                            if (label.includes('Buffer') || label.includes('Safety')) {
                                leverageBufferToMarginCall = parseFloat(value) || null;
                                p10SafetyBuffer = leverageBufferToMarginCall;
                            } else if (label.includes('Margin Call Trigger') || label.includes('Max')) {
                                // Max borrowing percentage
                            }
                        });
                        if (worstCase) {
                            leverageWorstCase = worstCase.textContent || '';
                        }
                    } else if (title.includes('Margin Call')) {
                        marginCallRate = parseFloat(mainValue) || null;
                        secondaryItems.forEach(item => {
                            const label = item.querySelector('.secondary-label')?.textContent || '';
                            const value = item.querySelector('.secondary-value')?.textContent || '';
                            if (label.includes('Liquidation') || label.includes('Haircut')) {
                                liquidationHaircut = parseFloat(value) || null;
                            } else if (label.includes('Warning') || label.includes('Zone')) {
                                marginWarningZone = parseFloat(value) || null;
                            }
                        });
                        if (worstCase) {
                            marginCallTarget = worstCase.textContent || '';
                        }
                    }
                });
            }

            // Extract Performance Summary table data
            let performanceSummaryData = null;
            const performanceSummaryCard = document.querySelector('.performance-summary-card');
            if (performanceSummaryCard) {
                const table = performanceSummaryCard.querySelector('.performance-summary-table');
                if (table) {
                    performanceSummaryData = {
                        twrrNominal: {},
                        twrrReal: {},
                        endBalanceNominal: {},
                        endBalanceReal: {}
                    };

                    const rows = table.querySelectorAll('tbody tr');
                    rows.forEach((row, index) => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 6) {
                            const percentiles = [10, 25, 50, 75, 90];
                            if (index === 0) { // TWRR Nominal
                                percentiles.forEach((p, i) => {
                                    performanceSummaryData.twrrNominal[p] = cells[i + 1]?.textContent || '--';
                                });
                            } else if (index === 1) { // TWRR Real
                                percentiles.forEach((p, i) => {
                                    performanceSummaryData.twrrReal[p] = cells[i + 1]?.textContent || '--';
                                });
                            } else if (index === 2) { // End Balance Nominal
                                percentiles.forEach((p, i) => {
                                    performanceSummaryData.endBalanceNominal[p] = cells[i + 1]?.textContent || '--';
                                });
                            } else if (index === 3) { // End Balance Real
                                percentiles.forEach((p, i) => {
                                    performanceSummaryData.endBalanceReal[p] = cells[i + 1]?.textContent || '--';
                                });
                            }
                        }
                    });
                }
            }

            // Extract additional liquidity metrics from Strategy Success card
            let medianLocUtilization = null;
            let highRiskYearsPct = null;
            const successCard = Array.from(keyMetricsEl?.querySelectorAll('.hero-metric-card') || [])
                .find(card => card.querySelector('.card-title')?.textContent.includes('Strategy Success'));
            if (successCard) {
                const secondaryItems = successCard.querySelectorAll('.secondary-item');
                secondaryItems.forEach(item => {
                    const label = item.querySelector('.secondary-label')?.textContent || '';
                    const value = item.querySelector('.secondary-value')?.textContent || '';
                    if (label.includes('Median Utilization')) {
                        medianLocUtilization = parseFloat(value) || null;
                    } else if (label.includes('Years Above')) {
                        highRiskYearsPct = parseFloat(value) || null;
                    }
                });
            }

            return {
                assets,
                startValue,
                period,
                annualWithdrawal,
                annualRaise,
                sblocRate,
                maxBorrowing,
                maintenanceMargin,
                numSimulations,
                // Return model info
                returnModel,
                regimeMode,
                // Status Banner
                statusBannerStatus,
                statusBannerTitle,
                statusBannerMessage,
                // Recommendations
                recommendations,
                // Success metrics
                successRate,
                hasEscapeVelocity,
                sellSuccessRate,
                successAdvantage,
                // Portfolio Growth metrics
                impliedCAGR,
                medianTerminal,
                p10Outcome,
                sellTerminalMedian,
                terminalValueAdvantage,
                // Leverage Safety metrics
                leveragePeakLTV,
                leverageBufferToMarginCall,
                leverageWorstCase,
                // Margin Call Risk metrics
                marginCallRate,
                liquidationHaircut,
                marginWarningZone,
                marginCallTarget,
                // Legacy fields (backward compat)
                p90LocUtilization,
                p10SafetyBuffer,
                mostDangerousYear,
                // Additional liquidity metrics
                medianLocUtilization,
                highRiskYearsPct,
                // Performance Summary
                performanceSummaryData
            };
        }

        /**
         * Generates the Performance Summary table HTML for print.
         * @param {Object} performanceSummaryData - Object containing TWRR and End Balance data for percentiles
         * @param {number} inflationRate - Inflation rate used in simulation
         * @returns {string} HTML string for the Performance Summary table section
         */
        function generatePerformanceSummaryPrintHTML(performanceSummaryData, inflationRate) {
            if (!performanceSummaryData) {
                return '';
            }

            const colors = {
                primary: '#00796B',
                primaryLight: '#E0F2F1',
                success: '#10B981',
                successLight: '#D1FAE5',
                error: '#EF4444',
                errorLight: '#FEE2E2',
                textPrimary: '#1A1F36',
                textSecondary: '#4E5D78',
                surface: '#FFFFFF',
                surfaceVariant: '#F7F9FB',
                border: '#E2E8F0',
                borderLight: '#F1F5F9'
            };

            const percentiles = [10, 25, 50, 75, 90];

            return `
                <div class="print-section page-break-before">
                    <h2 class="section-title">Performance Summary</h2>
                    <p class="section-subtitle">Detailed performance metrics across probability distributions</p>

                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; background: ${colors.surface}; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0, 121, 107, 0.08);">
                            <thead>
                                <tr style="background: linear-gradient(135deg, #1B4B4B 0%, ${colors.primary} 100%);">
                                    <th style="padding: 12px 16px; text-align: left; font-weight: 700; color: white; font-size: 10pt; border-right: 1px solid rgba(255,255,255,0.1);">Metric</th>
                                    ${percentiles.map(p => `
                                        <th style="padding: 12px 16px; text-align: right; font-weight: 700; color: white; font-size: 10pt; border-right: 1px solid rgba(255,255,255,0.1);">
                                            ${p}th<br><span style="font-size: 8pt; font-weight: 400; opacity: 0.8;">Percentile</span>
                                        </th>
                                    `).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="background: ${colors.surface};">
                                    <td style="padding: 12px 16px; border-bottom: 1px solid ${colors.borderLight}; font-size: 10pt; font-weight: 600; color: ${colors.textPrimary};">
                                        Time Weighted Rate of Return (nominal)
                                    </td>
                                    ${percentiles.map(p => {
                                        const value = performanceSummaryData.twrrNominal[p];
                                        const isNegative = value && value.includes('-');
                                        return `
                                            <td style="padding: 12px 16px; text-align: right; border-bottom: 1px solid ${colors.borderLight}; font-size: 10pt; font-weight: 500; color: ${isNegative ? colors.error : colors.success}; font-family: 'JetBrains Mono', monospace;">
                                                ${value}
                                            </td>
                                        `;
                                    }).join('')}
                                </tr>
                                <tr style="background: ${colors.surfaceVariant};">
                                    <td style="padding: 12px 16px; border-bottom: 1px solid ${colors.borderLight}; font-size: 10pt; font-weight: 600; color: ${colors.textPrimary};">
                                        Time Weighted Rate of Return (real)
                                    </td>
                                    ${percentiles.map(p => {
                                        const value = performanceSummaryData.twrrReal[p];
                                        const isNegative = value && value.includes('-');
                                        return `
                                            <td style="padding: 12px 16px; text-align: right; border-bottom: 1px solid ${colors.borderLight}; font-size: 10pt; font-weight: 500; color: ${isNegative ? colors.error : colors.success}; font-family: 'JetBrains Mono', monospace;">
                                                ${value}
                                            </td>
                                        `;
                                    }).join('')}
                                </tr>
                                <tr style="background: ${colors.surface};">
                                    <td style="padding: 12px 16px; border-bottom: 1px solid ${colors.borderLight}; font-size: 10pt; font-weight: 600; color: ${colors.textPrimary};">
                                        Portfolio End Balance (nominal)
                                    </td>
                                    ${percentiles.map(p => `
                                        <td style="padding: 12px 16px; text-align: right; border-bottom: 1px solid ${colors.borderLight}; font-size: 10pt; font-weight: 500; color: ${colors.textPrimary}; font-family: 'JetBrains Mono', monospace;">
                                            ${performanceSummaryData.endBalanceNominal[p]}
                                        </td>
                                    `).join('')}
                                </tr>
                                <tr style="background: ${colors.surfaceVariant};">
                                    <td style="padding: 12px 16px; font-size: 10pt; font-weight: 600; color: ${colors.textPrimary};">
                                        Portfolio End Balance (real)
                                    </td>
                                    ${percentiles.map(p => `
                                        <td style="padding: 12px 16px; text-align: right; font-size: 10pt; font-weight: 500; color: ${colors.textPrimary}; font-family: 'JetBrains Mono', monospace;">
                                            ${performanceSummaryData.endBalanceReal[p]}
                                        </td>
                                    `).join('')}
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    ${inflationRate ? `
                        <p style="margin-top: 12px; font-size: 9pt; color: ${colors.textSecondary}; font-style: italic;">
                            <strong>Note:</strong> Real returns are adjusted for ${inflationRate}% annual inflation.
                            Time Weighted Rate of Return (TWRR) measures portfolio performance independent of cash flows, providing an accurate measure of investment skill and market conditions.
                        </p>
                    ` : ''}
                </div>
            `;
        }

        /**
         * Generates the Strategy Guardrails & Portfolio Overview section HTML for print.
         * Redesigned with ZenDeep Finance design system - includes hero metric cards.
         * @param {Object} metrics - Object containing extracted metrics
         * @returns {string} HTML string for the section
         */
        function generatePortfolioCompositionPrintHTML(metrics) {
            const { assets, startValue, period, annualWithdrawal, annualRaise,
                    sblocRate, maxBorrowing, maintenanceMargin, numSimulations,
                    returnModel, regimeMode,
                    statusBannerStatus, statusBannerTitle, statusBannerMessage,
                    recommendations,
                    successRate, hasEscapeVelocity,
                    sellSuccessRate, successAdvantage, impliedCAGR, medianTerminal,
                    p10Outcome, sellTerminalMedian, terminalValueAdvantage,
                    leveragePeakLTV, leverageBufferToMarginCall, leverageWorstCase,
                    marginCallRate, liquidationHaircut, marginWarningZone, marginCallTarget,
                    p90LocUtilization, p10SafetyBuffer, mostDangerousYear,
                    medianLocUtilization, highRiskYearsPct } = metrics;

            // ZenDeep Finance Design System Colors
            const colors = {
                primary: '#00796B',
                primaryLight: '#E0F2F1',
                primaryDark: '#004D40',
                success: '#10B981',
                successLight: '#D1FAE5',
                warning: '#F59E0B',
                warningLight: '#FEF3C7',
                error: '#EF4444',
                errorLight: '#FEE2E2',
                info: '#0EA5E9',
                infoLight: '#E0F2FE',
                textPrimary: '#1A1F36',
                textSecondary: '#4E5D78',
                textDisabled: '#94A3B8',
                surface: '#FFFFFF',
                surfaceVariant: '#F7F9FB',
                border: '#E2E8F0',
                borderLight: '#F1F5F9'
            };

            // Determine status colors for each card
            const getSuccessStatus = (rate) => {
                if (rate >= 80) return { color: colors.success, bg: colors.successLight, icon: '' };
                if (rate >= 50) return { color: colors.warning, bg: colors.warningLight, icon: '' };
                return { color: colors.error, bg: colors.errorLight, icon: '!' };
            };

            const getMarginStatus = (rate) => {
                if (rate === null) return { color: colors.info, bg: colors.infoLight, icon: '?' };
                if (rate < 20) return { color: colors.success, bg: colors.successLight, icon: '' };
                if (rate < 40) return { color: colors.warning, bg: colors.warningLight, icon: '' };
                return { color: colors.error, bg: colors.errorLight, icon: '!' };
            };

            const getCAGRStatus = (cagr) => {
                if (cagr === null) return { color: colors.info, bg: colors.infoLight, icon: '?' };
                if (cagr > 15) return { color: colors.warning, bg: colors.warningLight, icon: '' };
                return { color: colors.info, bg: colors.infoLight, icon: '' };
            };

            const getLeverageStatus = (peakLTV) => {
                if (peakLTV === null) return { color: colors.info, bg: colors.infoLight, icon: '?' };
                if (peakLTV <= 60) return { color: colors.success, bg: colors.successLight, icon: '' };
                if (peakLTV <= 80) return { color: colors.warning, bg: colors.warningLight, icon: '' };
                return { color: colors.error, bg: colors.errorLight, icon: '!' };
            };

            const getStatusBannerColors = (status) => {
                if (status === 'green') return { color: colors.success, bg: colors.successLight, border: colors.success };
                if (status === 'yellow') return { color: colors.warning, bg: colors.warningLight, border: colors.warning };
                return { color: colors.error, bg: colors.errorLight, border: colors.error };
            };

            const successStatus = getSuccessStatus(successRate);
            const marginStatus = getMarginStatus(marginCallRate);
            const cagrStatus = getCAGRStatus(impliedCAGR);
            const leverageStatus = getLeverageStatus(leveragePeakLTV || p90LocUtilization);
            const bannerColors = getStatusBannerColors(statusBannerStatus);

            // Generate portfolio table rows
            const portfolioRows = assets.map(asset => `
                <tr>
                    <td style="padding: 10px 14px; border-bottom: 1px solid ${colors.borderLight}; font-family: 'Inter', system-ui, sans-serif; font-size: 11px; color: ${colors.textPrimary};">
                        <span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background-color: ${asset.color}; margin-right: 10px; vertical-align: middle;"></span>
                        <span style="vertical-align: middle;">${asset.name}</span>
                    </td>
                    <td style="padding: 10px 14px; border-bottom: 1px solid ${colors.borderLight}; text-align: right; font-family: 'Inter', system-ui, sans-serif; font-size: 11px; font-weight: 600; color: ${colors.textPrimary};">${asset.weight.toFixed(1)}%</td>
                </tr>
            `).join('');

            // Escape velocity badge
            const escapeVelocityBadge = hasEscapeVelocity ? `
                <div style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; background: ${colors.successLight}; border: 1px solid ${colors.success}; border-radius: 50px; font-family: 'Inter', system-ui, sans-serif; font-size: 10px; font-weight: 600; color: ${colors.success}; text-transform: uppercase; letter-spacing: 0.5px;">
                    <span style="font-size: 12px;"></span>
                    Escape Velocity
                </div>
            ` : '';

            // Helper for formatting currency
            const formatValue = (val) => {
                if (val === null || val === undefined) return '--';
                if (typeof val === 'string') return val;
                return '$' + val.toLocaleString();
            };

            // Return model display name
            const returnModelNames = {
                'bootstrap': 'Historical Bootstrap',
                'regime': 'Regime-Switching',
                'fat-tail': 'Fat-Tailed Distribution'
            };
            const returnModelDisplay = returnModelNames[returnModel] || returnModel;
            const regimeModeDisplay = returnModel === 'regime' ? ` (${regimeMode === 'historical' ? 'Historical' : 'Conservative'})` : '';

            // Generate recommendations HTML for print
            const recommendationsHTML = recommendations && recommendations.length > 0 ? `
                <!-- Recommendations Section -->
                <div style="margin-top: 24px; background: ${colors.surface}; border: 1px solid ${colors.border}; border-radius: 12px; padding: 16px; box-shadow: 0 1px 3px rgba(0, 121, 107, 0.05);">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 14px;">
                        <span style="font-size: 16px;"></span>
                        <h3 style="font-family: 'Plus Jakarta Sans', 'Inter', system-ui, sans-serif; font-size: 12px; font-weight: 700; color: ${colors.textPrimary}; margin: 0;">Actionable Insights</h3>
                        <span style="font-size: 9px; color: ${colors.primary}; background: ${colors.primaryLight}; padding: 3px 10px; border-radius: 50px; font-weight: 600;">${recommendations.length}</span>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        ${recommendations.map(rec => {
                            const typeColors = {
                                'critical': { bg: colors.errorLight, border: colors.error, icon: '' },
                                'warning': { bg: colors.warningLight, border: colors.warning, icon: '' },
                                'opportunity': { bg: colors.successLight, border: colors.success, icon: '' },
                                'info': { bg: colors.infoLight, border: colors.info, icon: '' }
                            };
                            const tc = typeColors[rec.type] || typeColors.info;
                            return `
                                <div style="display: flex; gap: 10px; padding: 10px 12px; background: ${tc.bg}; border-left: 3px solid ${tc.border}; border-radius: 6px;">
                                    <span style="font-size: 14px; flex-shrink: 0;">${tc.icon}</span>
                                    <div style="flex: 1;">
                                        <p style="margin: 0 0 4px 0; font-size: 10px; color: ${colors.textPrimary}; line-height: 1.4;">${rec.message}</p>
                                        ${rec.action ? `<p style="margin: 0; font-size: 9px; color: ${colors.textSecondary};"><strong>Action:</strong> ${rec.action}</p>` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            ` : '';

            return `
                <!-- Strategy Guardrails & Portfolio Overview - ZenDeep Finance Design -->
                <div class="print-portfolio-section" style="font-family: 'Inter', system-ui, sans-serif;">

                    <!-- Section Header with Escape Velocity Badge -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 2px solid ${colors.border};">
                        <div>
                            <h2 style="font-family: 'Plus Jakarta Sans', 'Inter', system-ui, sans-serif; font-size: 18pt; font-weight: 700; color: ${colors.textPrimary}; margin: 0 0 4px 0; letter-spacing: -0.02em;">Portfolio Strategy Overview</h2>
                            <p style="font-size: 10px; color: ${colors.textSecondary}; margin: 0;">Monte Carlo Simulation Results  ${numSimulations.toLocaleString()} scenarios analyzed</p>
                        </div>
                        ${escapeVelocityBadge}
                    </div>

                    <!-- Status Banner (below Escape Velocity indicator) -->
                    ${statusBannerTitle ? `
                    <div style="display: flex; align-items: center; gap: 16px; padding: 16px 20px; margin-bottom: 20px; background: linear-gradient(135deg, ${bannerColors.bg} 0%, ${colors.surface} 100%); border: 1px solid ${bannerColors.border}; border-left: 5px solid ${bannerColors.color}; border-radius: 10px;">
                        <div style="width: 44px; height: 44px; border-radius: 50%; background: ${bannerColors.bg}; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <span style="font-size: 22px; color: ${bannerColors.color};">${statusBannerStatus === 'green' ? '' : statusBannerStatus === 'yellow' ? '' : '!'}</span>
                        </div>
                        <div style="flex: 1;">
                            <h3 style="margin: 0 0 4px 0; font-family: 'Plus Jakarta Sans', 'Inter', system-ui, sans-serif; font-size: 14px; font-weight: 700; color: ${bannerColors.color};">${statusBannerTitle}</h3>
                            <p style="margin: 0; font-size: 10px; color: ${colors.textSecondary}; line-height: 1.4;">${statusBannerMessage}</p>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Hero Metric Cards - 2x2 Grid -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px;">
                        <!-- Card 1: Strategy Success -->
                        <div style="position: relative; background: ${colors.surface}; border: 1px solid ${colors.border}; border-radius: 12px; padding: 16px; box-shadow: 0 1px 3px rgba(0, 121, 107, 0.05);">
                            <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(135deg, ${successStatus.color} 0%, ${successStatus.color}88 100%); border-radius: 12px 12px 0 0;"></div>
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; padding-top: 4px;">
                                <div>
                                    <h4 style="font-family: 'Plus Jakarta Sans', 'Inter', system-ui, sans-serif; font-size: 11px; font-weight: 700; color: ${colors.textPrimary}; margin: 0 0 2px 0;">Strategy Success</h4>
                                    <p style="font-size: 8px; color: ${colors.textDisabled}; text-transform: uppercase; letter-spacing: 0.5px; margin: 0;">BBD SUCCESS RATE</p>
                                </div>
                                <div style="width: 28px; height: 28px; border-radius: 50%; background: ${successStatus.bg}; display: flex; align-items: center; justify-content: center;">
                                    <span style="color: ${successStatus.color}; font-size: 14px; font-weight: bold;">${successStatus.icon}</span>
                                </div>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <span style="font-family: 'Plus Jakarta Sans', 'Inter', system-ui, sans-serif; font-size: 28px; font-weight: 800; color: ${successStatus.color}; letter-spacing: -0.02em; line-height: 1;">${successRate.toFixed(1)}</span>
                                <span style="font-size: 14px; font-weight: 600; color: ${colors.textSecondary};">%</span>
                            </div>
                            <p style="font-size: 9px; color: ${colors.textSecondary}; margin: 0 0 12px 0;">Probability of Success</p>
                            ${sellSuccessRate !== null ? `
                            <div style="display: flex; justify-content: space-between; padding-top: 10px; border-top: 1px solid ${colors.borderLight};">
                                <div>
                                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 11px; font-weight: 600; color: ${successAdvantage >= 0 ? colors.success : colors.error};">${successAdvantage >= 0 ? '+' : ''}${successAdvantage}</div>
                                    <div style="font-size: 8px; color: ${colors.textDisabled};">vs Sell Assets</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 11px; font-weight: 600; color: ${colors.textPrimary};">${sellSuccessRate.toFixed(1)}%</div>
                                    <div style="font-size: 8px; color: ${colors.textDisabled};">Sell Success Rate</div>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding-top: 10px; border-top: 1px solid ${colors.borderLight};">
                                <div>
                                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 11px; font-weight: 600; color: ${colors.textPrimary};">${medianLocUtilization !== null ? medianLocUtilization.toFixed(1) + '%' : '--'}</div>
                                    <div style="font-size: 8px; color: ${colors.textDisabled};">Median Utilization</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 11px; font-weight: 600; color: ${colors.textPrimary};">${highRiskYearsPct.toFixed(1)}%</div>
                                    <div style="font-size: 8px; color: ${colors.textDisabled};">Years Above 70%</div>
                                </div>
                            </div>
                            ` : ''}
                            <div style="display: flex; align-items: center; gap: 6px; padding: 6px 8px; margin-top: 10px; background: ${colors.surfaceVariant}; border-radius: 6px;">
                                <span style="font-size: 10px; color: ${colors.textDisabled};"></span>
                                <span style="font-size: 8px; color: ${colors.textSecondary};">${successRate >= 80
                                    ? `Target: <span style="color: ${colors.success}; font-weight: 600;">80%</span> exceeded`
                                    : `Target: 80%  Gap: <span style="color: ${colors.error}; font-weight: 600;">${(80 - successRate).toFixed(1)}%</span>`}</span>
                            </div>
                        </div>

                        <!-- Card 2: Portfolio Growth -->
                        <div style="position: relative; background: ${colors.surface}; border: 1px solid ${colors.border}; border-radius: 12px; padding: 16px; box-shadow: 0 1px 3px rgba(0, 121, 107, 0.05);">
                            <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(135deg, ${cagrStatus.color} 0%, ${cagrStatus.color}88 100%); border-radius: 12px 12px 0 0;"></div>
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; padding-top: 4px;">
                                <div>
                                    <h4 style="font-family: 'Plus Jakarta Sans', 'Inter', system-ui, sans-serif; font-size: 11px; font-weight: 700; color: ${colors.textPrimary}; margin: 0 0 2px 0;">Portfolio Growth</h4>
                                    <p style="font-size: 8px; color: ${colors.textDisabled}; text-transform: uppercase; letter-spacing: 0.5px; margin: 0;">IMPLIED CAGR (MEDIAN)</p>
                                </div>
                                <div style="width: 28px; height: 28px; border-radius: 50%; background: ${cagrStatus.bg}; display: flex; align-items: center; justify-content: center;">
                                    <span style="color: ${cagrStatus.color}; font-size: 14px; font-weight: bold;">${cagrStatus.icon}</span>
                                </div>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <span style="font-family: 'Plus Jakarta Sans', 'Inter', system-ui, sans-serif; font-size: 28px; font-weight: 800; color: ${cagrStatus.color}; letter-spacing: -0.02em; line-height: 1;">${impliedCAGR !== null ? impliedCAGR.toFixed(1) : 'n/a'}</span>
                                ${impliedCAGR !== null ? `<span style="font-size: 14px; font-weight: 600; color: ${colors.textSecondary};">%</span>` : ''}
                            </div>
                            <p style="font-size: 9px; color: ${colors.textSecondary}; margin: 0 0 12px 0;">Compound Annual Growth Rate</p>
                            <div style="display: flex; justify-content: space-between; padding-top: 10px; border-top: 1px solid ${colors.borderLight};">
                                <div>
                                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 11px; font-weight: 600; color: ${colors.textPrimary};">$${startValue.toLocaleString()}</div>
                                    <div style="font-size: 8px; color: ${colors.textDisabled};">Starting Value</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 11px; font-weight: 600; color: ${colors.textPrimary};">${medianTerminal || '--'}</div>
                                    <div style="font-size: 8px; color: ${colors.textDisabled};">Median Terminal</div>
                                </div>
                            </div>
                            ${sellTerminalMedian ? `
                            <div style="display: flex; justify-content: space-between; padding-top: 10px; border-top: 1px solid ${colors.borderLight};">
                                <div>
                                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 11px; font-weight: 600; color: ${terminalValueAdvantage && terminalValueAdvantage.startsWith('+') ? colors.success : colors.error};">${terminalValueAdvantage || '--'}</div>
                                    <div style="font-size: 8px; color: ${colors.textDisabled};">vs Sell Assets</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 11px; font-weight: 600; color: ${colors.textPrimary};">${sellTerminalMedian}</div>
                                    <div style="font-size: 8px; color: ${colors.textDisabled};">Sell Terminal</div>
                                </div>
                            </div>
                            ` : ''}
                            <div style="display: flex; align-items: center; gap: 6px; padding: 6px 8px; margin-top: 10px; background: ${colors.surfaceVariant}; border-radius: 6px;">
                                <span style="font-size: 10px; color: ${colors.textDisabled};"></span>
                                <span style="font-size: 8px; color: ${colors.textSecondary};">P10 outcome: <span style="color: ${colors.error}; font-weight: 600;">${p10Outcome || '--'}</span></span>
                            </div>
                        </div>

                        <!-- Card 3: Leverage Safety -->
                        <div style="position: relative; background: ${colors.surface}; border: 1px solid ${colors.border}; border-radius: 12px; padding: 16px; box-shadow: 0 1px 3px rgba(0, 121, 107, 0.05);">
                            <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(135deg, ${leverageStatus.color} 0%, ${leverageStatus.color}88 100%); border-radius: 12px 12px 0 0;"></div>
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; padding-top: 4px;">
                                <div>
                                    <h4 style="font-family: 'Plus Jakarta Sans', 'Inter', system-ui, sans-serif; font-size: 11px; font-weight: 700; color: ${colors.textPrimary}; margin: 0 0 2px 0;">Leverage Safety</h4>
                                    <p style="font-size: 8px; color: ${colors.textDisabled}; text-transform: uppercase; letter-spacing: 0.5px; margin: 0;">SBLOC UTILIZATION</p>
                                </div>
                                <div style="width: 28px; height: 28px; border-radius: 50%; background: ${leverageStatus.bg}; display: flex; align-items: center; justify-content: center;">
                                    <span style="color: ${leverageStatus.color}; font-size: 14px; font-weight: bold;">${leverageStatus.icon}</span>
                                </div>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <span style="font-family: 'Plus Jakarta Sans', 'Inter', system-ui, sans-serif; font-size: 28px; font-weight: 800; color: ${leverageStatus.color}; letter-spacing: -0.02em; line-height: 1;">${(leveragePeakLTV || p90LocUtilization) !== null ? (leveragePeakLTV || p90LocUtilization).toFixed(1) : '--'}</span>
                                ${(leveragePeakLTV || p90LocUtilization) !== null ? `<span style="font-size: 14px; font-weight: 600; color: ${colors.textSecondary};">%</span>` : ''}
                            </div>
                            <p style="font-size: 9px; color: ${colors.textSecondary}; margin: 0 0 12px 0;">90th Percentile Peak LTV</p>
                            <div style="display: flex; justify-content: space-between; padding-top: 10px; border-top: 1px solid ${colors.borderLight};">
                                <div>
                                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 11px; font-weight: 600; color: ${colors.textPrimary};">${(leverageBufferToMarginCall || p10SafetyBuffer) !== null ? (leverageBufferToMarginCall || p10SafetyBuffer).toFixed(1) + '%' : '--'}</div>
                                    <div style="font-size: 8px; color: ${colors.textDisabled};">Buffer to Margin Call</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 11px; font-weight: 600; color: ${colors.textPrimary};">${maxBorrowing.toFixed(0)}%</div>
                                    <div style="font-size: 8px; color: ${colors.textDisabled};">Margin Call Trigger</div>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding-top: 10px; border-top: 1px solid ${colors.borderLight};">
                                <div>
                                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 11px; font-weight: 600; color: ${colors.textPrimary};">${medianLocUtilization !== null ? medianLocUtilization.toFixed(1) + '%' : '--'}</div>
                                    <div style="font-size: 8px; color: ${colors.textDisabled};">Median Utilization</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 11px; font-weight: 600; color: ${colors.textPrimary};">${highRiskYearsPct.toFixed(1)}%</div>
                                    <div style="font-size: 8px; color: ${colors.textDisabled};">Years Above 70%</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px; padding: 6px 8px; margin-top: 10px; background: ${colors.surfaceVariant}; border-radius: 6px;">
                                <span style="font-size: 10px; color: ${colors.textDisabled};"></span>
                                <span style="font-size: 8px; color: ${colors.textSecondary};">${leverageWorstCase || 'Worst case utilization in stress testing'}</span>
                            </div>
                        </div>

                        <!-- Card 4: Margin Call Risk -->
                        <div style="position: relative; background: ${colors.surface}; border: 1px solid ${colors.border}; border-radius: 12px; padding: 16px; box-shadow: 0 1px 3px rgba(0, 121, 107, 0.05);">
                            <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(135deg, ${marginStatus.color} 0%, ${marginStatus.color}88 100%); border-radius: 12px 12px 0 0;"></div>
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; padding-top: 4px;">
                                <div>
                                    <h4 style="font-family: 'Plus Jakarta Sans', 'Inter', system-ui, sans-serif; font-size: 11px; font-weight: 700; color: ${colors.textPrimary}; margin: 0 0 2px 0;">Margin Call Risk</h4>
                                    <p style="font-size: 8px; color: ${colors.textDisabled}; text-transform: uppercase; letter-spacing: 0.5px; margin: 0;">FORCED LIQUIDATION</p>
                                </div>
                                <div style="width: 28px; height: 28px; border-radius: 50%; background: ${marginStatus.bg}; display: flex; align-items: center; justify-content: center;">
                                    <span style="color: ${marginStatus.color}; font-size: 14px; font-weight: bold;">${marginStatus.icon}</span>
                                </div>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <span style="font-family: 'Plus Jakarta Sans', 'Inter', system-ui, sans-serif; font-size: 28px; font-weight: 800; color: ${marginStatus.color}; letter-spacing: -0.02em; line-height: 1;">${marginCallRate !== null ? marginCallRate.toFixed(1) : '--'}</span>
                                ${marginCallRate !== null ? `<span style="font-size: 14px; font-weight: 600; color: ${colors.textSecondary};">%</span>` : ''}
                            </div>
                            <p style="font-size: 9px; color: ${colors.textSecondary}; margin: 0 0 12px 0;">Simulations with Margin Calls</p>
                            <div style="display: flex; justify-content: space-between; padding-top: 10px; border-top: 1px solid ${colors.borderLight};">
                                <div>
                                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 11px; font-weight: 600; color: ${colors.textPrimary};">${liquidationHaircut !== null ? liquidationHaircut.toFixed(1) + '%' : '--'}</div>
                                    <div style="font-size: 8px; color: ${colors.textDisabled};">Liquidation Haircut</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 11px; font-weight: 600; color: ${colors.textPrimary};">${marginWarningZone !== null ? marginWarningZone.toFixed(0) + '%' : maintenanceMargin.toFixed(0) + '%'}</div>
                                    <div style="font-size: 8px; color: ${colors.textDisabled};">Warning Zone</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px; padding: 6px 8px; margin-top: 10px; background: ${colors.surfaceVariant}; border-radius: 6px;">
                                <span style="font-size: 10px; color: ${colors.textDisabled};"></span>
                                <span style="font-size: 8px; color: ${colors.textSecondary};">${marginCallRate !== null && marginCallRate <= 5
                                    ? `Target: <span style="color: ${colors.success}; font-weight: 600;">Met (&lt;5%)</span>`
                                    : `Target: &lt;5% recommended`}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Two Column Layout: Portfolio + Parameters -->
                    <div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px;">
                        <!-- Left: Portfolio Composition Table -->
                        <div style="background: ${colors.surface}; border: 1px solid ${colors.border}; border-radius: 12px; padding: 16px; box-shadow: 0 1px 3px rgba(0, 121, 107, 0.05);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px;">
                                <h3 style="font-family: 'Plus Jakarta Sans', 'Inter', system-ui, sans-serif; font-size: 12px; font-weight: 700; color: ${colors.textPrimary}; margin: 0;">Portfolio Composition</h3>
                                <span style="font-size: 9px; color: ${colors.primary}; background: ${colors.primaryLight}; padding: 3px 10px; border-radius: 50px; font-weight: 600;">${assets.length} Assets</span>
                            </div>
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: ${colors.surfaceVariant};">
                                        <th style="padding: 8px 14px; text-align: left; font-size: 9px; font-weight: 600; color: ${colors.textSecondary}; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid ${colors.border};">Asset</th>
                                        <th style="padding: 8px 14px; text-align: right; font-size: 9px; font-weight: 600; color: ${colors.textSecondary}; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid ${colors.border};">Allocation</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${portfolioRows}
                                </tbody>
                            </table>
                        </div>

                        <!-- Right: Key Parameters Grid -->
                        <div style="background: ${colors.surface}; border: 1px solid ${colors.border}; border-radius: 12px; padding: 16px; box-shadow: 0 1px 3px rgba(0, 121, 107, 0.05);">
                            <h3 style="font-family: 'Plus Jakarta Sans', 'Inter', system-ui, sans-serif; font-size: 12px; font-weight: 700; color: ${colors.textPrimary}; margin: 0 0 14px 0;">Simulation Parameters</h3>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                                <!-- Row 1 -->
                                <div style="text-align: center; padding: 12px 8px; background: ${colors.surfaceVariant}; border-radius: 8px;">
                                    <div style="font-size: 8px; text-transform: uppercase; letter-spacing: 0.5px; color: ${colors.textDisabled}; margin-bottom: 6px;">Starting Portfolio</div>
                                    <div style="font-family: 'Plus Jakarta Sans', 'Inter', system-ui, sans-serif; font-size: 14px; font-weight: 700; color: ${colors.textPrimary};">$${startValue.toLocaleString()}</div>
                                </div>
                                <div style="text-align: center; padding: 12px 8px; background: ${colors.surfaceVariant}; border-radius: 8px;">
                                    <div style="font-size: 8px; text-transform: uppercase; letter-spacing: 0.5px; color: ${colors.textDisabled}; margin-bottom: 6px;">Time Horizon</div>
                                    <div style="font-family: 'Plus Jakarta Sans', 'Inter', system-ui, sans-serif; font-size: 14px; font-weight: 700; color: ${colors.textPrimary};">${period} years</div>
                                </div>
                                <div style="text-align: center; padding: 12px 8px; background: ${colors.surfaceVariant}; border-radius: 8px;">
                                    <div style="font-size: 8px; text-transform: uppercase; letter-spacing: 0.5px; color: ${colors.textDisabled}; margin-bottom: 6px;">Annual Withdrawal</div>
                                    <div style="font-family: 'Plus Jakarta Sans', 'Inter', system-ui, sans-serif; font-size: 14px; font-weight: 700; color: ${colors.textPrimary};">$${annualWithdrawal.toLocaleString()}</div>
                                </div>
                                <div style="text-align: center; padding: 12px 8px; background: ${colors.surfaceVariant}; border-radius: 8px;">
                                    <div style="font-size: 8px; text-transform: uppercase; letter-spacing: 0.5px; color: ${colors.textDisabled}; margin-bottom: 6px;">Withdrawal Growth</div>
                                    <div style="font-family: 'Plus Jakarta Sans', 'Inter', system-ui, sans-serif; font-size: 14px; font-weight: 700; color: ${colors.textPrimary};">${annualRaise.toFixed(1)}%/yr</div>
                                </div>
                                <!-- Row 2 -->
                                <div style="text-align: center; padding: 12px 8px; background: ${colors.surfaceVariant}; border-radius: 8px;">
                                    <div style="font-size: 8px; text-transform: uppercase; letter-spacing: 0.5px; color: ${colors.textDisabled}; margin-bottom: 6px;">SBLOC Rate</div>
                                    <div style="font-family: 'Plus Jakarta Sans', 'Inter', system-ui, sans-serif; font-size: 14px; font-weight: 700; color: ${colors.textPrimary};">${sblocRate.toFixed(1)}%</div>
                                </div>
                                <div style="text-align: center; padding: 12px 8px; background: ${colors.surfaceVariant}; border-radius: 8px;">
                                    <div style="font-size: 8px; text-transform: uppercase; letter-spacing: 0.5px; color: ${colors.textDisabled}; margin-bottom: 6px;">Max Borrowing</div>
                                    <div style="font-family: 'Plus Jakarta Sans', 'Inter', system-ui, sans-serif; font-size: 14px; font-weight: 700; color: ${colors.textPrimary};">${maxBorrowing.toFixed(0)}%</div>
                                </div>
                                <div style="text-align: center; padding: 12px 8px; background: ${colors.surfaceVariant}; border-radius: 8px;">
                                    <div style="font-size: 8px; text-transform: uppercase; letter-spacing: 0.5px; color: ${colors.textDisabled}; margin-bottom: 6px;">Maint. Margin</div>
                                    <div style="font-family: 'Plus Jakarta Sans', 'Inter', system-ui, sans-serif; font-size: 14px; font-weight: 700; color: ${colors.textPrimary};">${maintenanceMargin.toFixed(0)}%</div>
                                </div>
                                <div style="text-align: center; padding: 12px 8px; background: ${colors.surfaceVariant}; border-radius: 8px;">
                                    <div style="font-size: 8px; text-transform: uppercase; letter-spacing: 0.5px; color: ${colors.textDisabled}; margin-bottom: 6px;">Simulations</div>
                                    <div style="font-family: 'Plus Jakarta Sans', 'Inter', system-ui, sans-serif; font-size: 14px; font-weight: 700; color: ${colors.textPrimary};">${numSimulations.toLocaleString()}</div>
                                </div>
                                <!-- Row 3: Return Model (spans 2 columns) -->
                                <div style="grid-column: span 2; text-align: center; padding: 12px 8px; background: ${colors.primaryLight}; border-radius: 8px; border: 1px solid ${colors.primary}22;">
                                    <div style="font-size: 8px; text-transform: uppercase; letter-spacing: 0.5px; color: ${colors.primary}; margin-bottom: 6px;">Return Model</div>
                                    <div style="font-family: 'Plus Jakarta Sans', 'Inter', system-ui, sans-serif; font-size: 13px; font-weight: 700; color: ${colors.primary};">${returnModelDisplay}${regimeModeDisplay}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    ${recommendationsHTML}
                </div>
            `;
        }

        /**
         * Generates the Executive Summary section HTML for print with styled cards and grids.
         * Extracts data from the existing DOM elements and transforms plain bullet lists into
         * professional styled metrics grids, consideration cards, and numbered action items.
         * @param {string} strategyOverview - HTML content for strategy overview
         * @param {string} outcomeBox - HTML content for strategy outcome
         * @param {string} keyFindingsList - HTML content from the key findings <ul>
         * @param {string} strategicConsiderationsList - HTML content from strategic considerations <ul>
         * @param {string} nextStepsList - HTML content from next steps <ul>
         * @returns {string} Styled HTML string for the Executive Summary section
         */
        function generateExecutiveSummaryPrintHTML(strategyOverview, outcomeBox, keyFindingsList, strategicConsiderationsList, nextStepsList) {
            // Parse Key Findings from list items
            const keyFindingsData = parseKeyFindingsFromList(keyFindingsList);

            // Parse Strategic Considerations from list items
            const strategicData = parseStrategicConsiderationsFromList(strategicConsiderationsList);

            // Parse Next Steps from list items
            const nextStepsData = parseNextStepsFromList(nextStepsList);

            // Generate Key Findings metrics grid HTML
            const keyFindingsHTML = generateKeyFindingsGridHTML(keyFindingsData);

            // Generate Strategic Considerations cards HTML
            const strategicHTML = generateStrategicConsiderationsHTML(strategicData);

            // Generate Next Steps numbered list HTML
            const nextStepsHTML = generateNextStepsHTML(nextStepsData);

            return `
                <!-- Executive Summary -->
                <div class="print-section executive-section">
                    <h2 class="section-title">Executive Summary</h2>

                    <div class="section">
                        <div class="section-title">Strategy Overview</div>
                        <div class="overview-text">${strategyOverview}</div>
                    </div>

                    <div class="section">
                        <div class="section-title">Strategy Outcome</div>
                        <div class="outcome-box">${outcomeBox}</div>
                    </div>

                    ${keyFindingsHTML}

                    ${strategicHTML}

                    ${nextStepsHTML}
                </div>
            `;
        }

        /**
         * Parses Key Findings data from HTML list items.
         * Extracts metric labels and values for grid display.
         * @param {string} listHTML - The innerHTML of the <ul> element
         * @returns {Object} Parsed data with metrics array and portfolio info
         */
        function parseKeyFindingsFromList(listHTML) {
            const data = {
                metrics: [],
                portfolioComposition: '',
                netWorthRange: ''
            };

            // Create a temporary element to parse HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = `<ul>${listHTML}</ul>`;
            const items = tempDiv.querySelectorAll('li');

            items.forEach(item => {
                const text = item.textContent;
                const strongEl = item.querySelector('strong');
                const label = strongEl ? strongEl.textContent.replace(':', '').trim() : '';
                const value = strongEl ? text.replace(strongEl.textContent, '').trim() : text.trim();

                // Categorize the data
                if (label.includes('Portfolio Composition')) {
                    data.portfolioComposition = value;
                } else if (label.includes('Net Worth Range')) {
                    data.netWorthRange = value;
                } else if (label.includes('Simulations Run')) {
                    data.metrics.push({ label: 'Simulations', value: value, highlight: '' });
                } else if (label.includes('Success Rate')) {
                    const rate = parseFloat(value) || 0;
                    let highlight = 'success';
                    if (rate < 50) highlight = 'danger';
                    else if (rate < 75) highlight = 'warning';
                    data.metrics.push({ label: 'Success Rate', value: value, highlight: highlight });
                } else if (label.includes('Margin Call Rate')) {
                    const rate = parseFloat(value) || 0;
                    let highlight = '';
                    if (rate > 30) highlight = 'danger';
                    else if (rate > 15) highlight = 'warning';
                    data.metrics.push({ label: 'Margin Call Risk', value: value, highlight: highlight });
                } else if (label.includes('Median Final Net Worth')) {
                    data.metrics.push({ label: 'Median Final', value: value, highlight: '' });
                } else if (label.includes('Best Case')) {
                    data.metrics.push({ label: 'Best Case (90th)', value: value, highlight: '' });
                } else if (label.includes('Worst Case')) {
                    data.metrics.push({ label: 'Worst Case (10th)', value: value, highlight: '' });
                }
            });

            return data;
        }

        /**
         * Generates the Key Findings metrics grid HTML.
         * @param {Object} data - Parsed key findings data
         * @returns {string} HTML string for the metrics grid
         */
        function generateKeyFindingsGridHTML(data) {
            // Find specific metrics by label
            const findMetric = (label) => data.metrics.find(m => m.label === label);

            const successRate = findMetric('Success Rate');
            const marginCallRisk = findMetric('Margin Call Risk');
            const worstCase = findMetric('Worst Case (10th)');
            const medianFinal = findMetric('Median Final');
            const bestCase = findMetric('Best Case (90th)');

            // Helper to generate a metric card
            const createCard = (metric) => {
                if (!metric) return '';
                const highlightClass = metric.highlight ? `highlight-${metric.highlight}` : '';
                return `
                    <div class="exec-metric-card ${highlightClass}">
                        <div class="exec-metric-label">${metric.label}</div>
                        <div class="exec-metric-value">${metric.value}</div>
                    </div>
                `;
            };

            // Row 1: Success Rate and Margin Call Risk (2 columns)
            const row1Cards = [successRate, marginCallRisk].map(createCard).join('');

            // Row 2: Worst Case, Median Final, Best Case (3 columns, in that order)
            const row2Cards = [worstCase, medianFinal, bestCase].map(createCard).join('');

            // Build tagline with portfolio and range info
            let tagline = '';
            if (data.portfolioComposition || data.netWorthRange) {
                const parts = [];
                if (data.netWorthRange) {
                    parts.push(`<strong>Net Worth Range (10th-90th):</strong> ${data.netWorthRange}`);
                }
                if (data.portfolioComposition) {
                    parts.push(`<strong>Portfolio:</strong> ${data.portfolioComposition}`);
                }
                tagline = `
                    <div class="exec-portfolio-tagline">
                        ${parts.join(' &nbsp;|&nbsp; ')}
                    </div>
                `;
            }

            return `
                <div class="exec-key-findings">
                    <div class="exec-section-header">
                        <span class="header-icon">&#128200;</span>
                        KEY FINDINGS
                    </div>
                    <div class="exec-metrics-grid exec-metrics-row-2">
                        ${row1Cards}
                    </div>
                    <div class="exec-metrics-grid exec-metrics-row-3">
                        ${row2Cards}
                    </div>
                    ${tagline}
                </div>
            `;
        }

        /**
         * Parses Strategic Considerations data from HTML list items.
         * @param {string} listHTML - The innerHTML of the <ul> element
         * @returns {Array} Array of consideration objects with title, text, and icon
         */
        function parseStrategicConsiderationsFromList(listHTML) {
            const considerations = [];
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = `<ul>${listHTML}</ul>`;
            const items = tempDiv.querySelectorAll('li');

            // Icon mapping based on consideration topic
            const iconMap = {
                'Tax': '&#128176;',           // Money bag
                'Portfolio': '&#128202;',      // Chart
                'Probability': '&#128200;',    // Trending up
                'Margin': '&#9888;',           // Warning
                'Market': '&#127760;',         // Globe
                'Interest': '&#128181;',       // Dollar bills
                'Diversification': '&#128204;' // Pie chart
            };

            items.forEach(item => {
                const strongEl = item.querySelector('strong');
                const title = strongEl ? strongEl.textContent.replace(':', '').trim() : 'Consideration';
                const text = strongEl ? item.textContent.replace(strongEl.textContent, '').trim() : item.textContent.trim();

                // Find matching icon
                let icon = '&#128161;'; // Default lightbulb
                for (const [keyword, iconCode] of Object.entries(iconMap)) {
                    if (title.includes(keyword)) {
                        icon = iconCode;
                        break;
                    }
                }

                considerations.push({ title, text, icon });
            });

            return considerations;
        }

        /**
         * Generates the Strategic Considerations cards HTML.
         * @param {Array} considerations - Array of consideration objects
         * @returns {string} HTML string for the considerations section
         */
        function generateStrategicConsiderationsHTML(considerations) {
            const rows = considerations.map(item => `
                <div class="exec-consideration-row">
                    <div class="exec-consideration-icon">${item.icon}</div>
                    <div class="exec-consideration-content">
                        <div class="exec-consideration-title">${item.title}</div>
                        <div class="exec-consideration-text">${item.text}</div>
                    </div>
                </div>
            `).join('');

            return `
                <div class="exec-strategic-considerations">
                    <div class="exec-section-header">
                        <span class="header-icon">&#128161;</span>
                        STRATEGIC CONSIDERATIONS
                    </div>
                    <div class="exec-considerations-container">
                        <div class="exec-considerations-list">
                            ${rows}
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Parses Next Steps data from HTML list items.
         * @param {string} listHTML - The innerHTML of the <ul> element
         * @returns {Array} Array of step objects with text, type, and label
         */
        function parseNextStepsFromList(listHTML) {
            const steps = [];
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = `<ul>${listHTML}</ul>`;
            const items = tempDiv.querySelectorAll('li');

            items.forEach(item => {
                const text = item.innerHTML;
                let type = 'normal';
                let content = text;

                // Check for warning recommendations
                if (text.includes('Recommendation:') || text.includes('&#9888;')) {
                    type = 'warning';
                }
                // Check for suggestions
                else if (text.includes('Suggestion:') || text.includes('&#128161;')) {
                    type = 'suggestion';
                }

                steps.push({ content, type });
            });

            return steps;
        }

        /**
         * Generates the Next Steps numbered list HTML.
         * @param {Array} steps - Array of step objects
         * @returns {string} HTML string for the next steps section
         */
        function generateNextStepsHTML(steps) {
            let stepNumber = 1;
            const stepItems = steps.map(step => {
                let itemClass = '';
                let numberDisplay = stepNumber;

                if (step.type === 'warning') {
                    itemClass = 'warning-step';
                    numberDisplay = '!';
                } else if (step.type === 'suggestion') {
                    itemClass = 'suggestion-step';
                    numberDisplay = '&#10003;';
                }

                const html = `
                    <div class="exec-step-item ${itemClass}">
                        <div class="exec-step-number">${numberDisplay}</div>
                        <div class="exec-step-content">${step.content}</div>
                    </div>
                `;

                // Only increment step number for normal steps
                if (step.type === 'normal') {
                    stepNumber++;
                }

                return html;
            }).join('');

            return `
                <div class="exec-next-steps">
                    <div class="exec-section-header">
                        <span class="header-icon">&#127919;</span>
                        RECOMMENDED NEXT STEPS
                    </div>
                    <div class="exec-steps-list">
                        ${stepItems}
                    </div>
                </div>
            `;
        }

        /**
         * Extracts liquidity stress testing data from the DOM for print formatting.
         * @param {HTMLElement} dashboardEl - The liquidity stress dashboard element
         * @returns {Object} Extracted data for print formatting
         */
        function extractLiquidityStressDataForPrint(dashboardEl) {
            const data = {
                riskBanner: { status: 'safe', icon: '', title: '', description: '' },
                stressTests: [],
                metrics: {
                    p10SafetyBuffer: { value: '', explanation: '' },
                    mostDangerousYear: { value: '', details: '' },
                    p90LocUtilization: { value: '', explanation: '', colorClass: 'safe' }
                }
            };

            // Extract risk banner info
            const banner = dashboardEl.querySelector('.liquidity-status-banner');
            if (banner) {
                if (banner.classList.contains('danger')) data.riskBanner.status = 'danger';
                else if (banner.classList.contains('warning')) data.riskBanner.status = 'warning';
                else data.riskBanner.status = 'safe';

                const iconEl = banner.querySelector('.liquidity-status-icon');
                const titleEl = banner.querySelector('.liquidity-status-title');
                const descEl = banner.querySelector('.liquidity-status-description');

                data.riskBanner.icon = iconEl ? iconEl.textContent : '';
                data.riskBanner.title = titleEl ? titleEl.textContent : '';
                data.riskBanner.description = descEl ? descEl.textContent : '';
            }

            // Extract stress test cards
            const stressCards = dashboardEl.querySelectorAll('.stress-test-card');
            stressCards.forEach(card => {
                const testData = {
                    title: '',
                    status: 'safe',
                    badgeText: 'SAFE',
                    metrics: []
                };

                // Determine status from card class
                if (card.classList.contains('danger')) {
                    testData.status = 'danger';
                    testData.badgeText = 'MARGIN CALL';
                } else if (card.classList.contains('warning')) {
                    testData.status = 'warning';
                    testData.badgeText = 'HIGH RISK';
                }

                // Extract title
                const titleEl = card.querySelector('.stress-test-title');
                if (titleEl) testData.title = titleEl.textContent;

                // Extract badge text (may override)
                const badgeEl = card.querySelector('.stress-test-badge');
                if (badgeEl) testData.badgeText = badgeEl.textContent;

                // Extract metrics
                const metricEls = card.querySelectorAll('.stress-test-metric');
                metricEls.forEach(metric => {
                    const labelEl = metric.querySelector('.stress-test-metric-label');
                    const valueEl = metric.querySelector('.stress-test-metric-value');
                    if (labelEl && valueEl) {
                        testData.metrics.push({
                            label: labelEl.textContent.replace(':', ''),
                            value: valueEl.textContent
                        });
                    }
                });

                data.stressTests.push(testData);
            });

            // Extract key liquidity metrics from the metrics grid section
            // Look for the section containing "10th Percentile Safety Buffer"
            const allDivs = dashboardEl.querySelectorAll('div');
            allDivs.forEach(div => {
                const text = div.textContent;

                // Find 10th Percentile Safety Buffer
                if (div.classList.contains('text-sm-on-surface-variant-mb-4') &&
                    text.includes('10th Percentile Safety Buffer')) {
                    const parent = div.parentElement;
                    if (parent) {
                        const valueEl = parent.querySelector('div[style*="font-size: 18px"]');
                        if (valueEl) data.metrics.p10SafetyBuffer.value = valueEl.textContent;

                        // Get explanation text
                        const explanationBox = parent.querySelector('div[style*="background: rgba(33, 150, 243"]');
                        if (explanationBox) {
                            data.metrics.p10SafetyBuffer.explanation = explanationBox.textContent;
                        }
                    }
                }

                // Find Most Dangerous Year
                if (div.classList.contains('text-sm-on-surface-variant-mb-4') &&
                    text.includes('Most Dangerous Year')) {
                    const parent = div.parentElement;
                    if (parent) {
                        const valueEl = parent.querySelector('div[style*="font-size: 18px"]');
                        if (valueEl) data.metrics.mostDangerousYear.value = valueEl.textContent;

                        // Get details
                        const detailsBox = parent.querySelector('div[style*="background: rgba(255, 107, 107"]');
                        if (detailsBox) {
                            data.metrics.mostDangerousYear.details = detailsBox.innerHTML;
                        }
                    }
                }

                // Find 90th Percentile LOC Utilization
                if (div.classList.contains('text-sm-on-surface-variant-mb-4') &&
                    text.includes('90th Percentile LOC Utilization')) {
                    const parent = div.parentElement;
                    if (parent) {
                        const valueEl = parent.querySelector('div[style*="font-size: 18px"]');
                        if (valueEl) {
                            data.metrics.p90LocUtilization.value = valueEl.textContent;
                            // Determine color class from inline style
                            const style = valueEl.getAttribute('style') || '';
                            if (style.includes('#DC2626')) data.metrics.p90LocUtilization.colorClass = 'danger';
                            else if (style.includes('#FFA726')) data.metrics.p90LocUtilization.colorClass = 'warning';
                            else data.metrics.p90LocUtilization.colorClass = 'safe';
                        }

                        // Get explanation
                        const explanationBox = parent.querySelector('div[style*="border-left: 3px solid"]');
                        if (explanationBox) {
                            data.metrics.p90LocUtilization.explanation = explanationBox.innerHTML;
                        }
                    }
                }
            });

            return data;
        }

        /**
         * Generates print-formatted HTML for the liquidity stress testing dashboard.
         * @param {Object} stressData - Data extracted from the dashboard
         * @param {Object} chartImages - Chart images including liquiditySafetyBufferChart
         * @returns {string} Print-formatted HTML string
         */
        function generateLiquidityStressPrintHTML(stressData, chartImages) {
            const { riskBanner, stressTests, metrics } = stressData;

            // Build stress test cards HTML
            let stressCardsHTML = '';
            stressTests.forEach(test => {
                let metricsHTML = '';
                test.metrics.forEach(m => {
                    metricsHTML += `
                        <div class="print-stress-metric">
                            <span class="print-stress-metric-label">${m.label}</span>
                            <span class="print-stress-metric-value">${m.value}</span>
                        </div>
                    `;
                });

                stressCardsHTML += `
                    <div class="print-stress-card ${test.status}">
                        <div class="print-stress-header">
                            <span class="print-stress-title">${test.title}</span>
                            <span class="print-stress-badge ${test.status}">${test.badgeText}</span>
                        </div>
                        <div class="print-stress-metrics">
                            ${metricsHTML}
                        </div>
                    </div>
                `;
            });

            // Build metrics section HTML
            const p10ValueColor = 'primary';
            const dangerYearColor = 'danger';

            return `
                <div class="print-section">
                    <h2 class="section-title">Liquidity Stress Testing Dashboard</h2>

                    <div class="print-liquidity-dashboard">
                        <!-- Risk Status Banner -->
                        <div class="print-risk-banner ${riskBanner.status}">
                            <div class="print-risk-icon">${riskBanner.icon}</div>
                            <div class="print-risk-content">
                                <div class="print-risk-title">${riskBanner.title}</div>
                                <div class="print-risk-description">${riskBanner.description}</div>
                            </div>
                        </div>

                        <!-- Stress Test Scenarios Header -->
                        <h4 style="font-size: 11pt; font-weight: 600; color: #1B4B4B; margin-bottom: 8px;">Stress Test Scenarios (Median Case)</h4>
                        <p style="font-size: 9pt; color: #666; margin-bottom: 16px;">What happens if your portfolio drops suddenly? These scenarios test margin call risk at different market decline levels.</p>

                        <!-- Stress Test Cards Grid -->
                        <div class="print-stress-grid">
                            ${stressCardsHTML}
                        </div>

                        <!-- Key Liquidity Metrics -->
                        <div class="print-liquidity-metrics">
                            <h4>Key Liquidity Metrics</h4>
                            <div class="print-liquidity-metrics-grid">
                                <!-- 10th Percentile Safety Buffer -->
                                <div class="print-liquidity-metric-card">
                                    <div class="print-liquidity-metric-label">10th Percentile Safety Buffer</div>
                                    <div class="print-liquidity-metric-value ${p10ValueColor}">${metrics.p10SafetyBuffer.value}</div>
                                    <div style="font-size: 9pt; color: #666;">Worst 10% of scenarios have at least this buffer</div>
                                    <div class="print-metric-explanation">
                                        <div class="print-metric-explanation-title">Understanding This Metric</div>
                                        <div class="print-metric-explanation-text">
                                            <strong>What it means:</strong> Even in the worst 10% of all simulated scenarios, your safety buffer never drops below this value.<br>
                                            <strong>Why percentiles matter:</strong> The absolute minimum can be an extreme outlier. This shows realistic worst-case risk.<br>
                                            <strong>How to interpret:</strong> Higher values = more robust strategy. Below 20% = tight margins, above 30% = comfortable cushion.
                                        </div>
                                    </div>
                                </div>

                                <!-- Most Dangerous Year -->
                                <div class="print-liquidity-metric-card">
                                    <div class="print-liquidity-metric-label">Most Dangerous Year</div>
                                    <div class="print-liquidity-metric-value ${dangerYearColor}">${metrics.mostDangerousYear.value}</div>
                                    ${metrics.mostDangerousYear.details ? `
                                    <div class="print-metric-explanation danger">
                                        <div class="print-metric-explanation-title">Why This Year Is Most Dangerous</div>
                                        <div class="print-metric-explanation-text">${metrics.mostDangerousYear.details}</div>
                                    </div>
                                    ` : ''}
                                </div>

                                <!-- 90th Percentile LOC Utilization -->
                                <div class="print-liquidity-metric-card">
                                    <div class="print-liquidity-metric-label">90th Percentile LOC Utilization</div>
                                    <div class="print-liquidity-metric-value ${metrics.p90LocUtilization.colorClass}">${metrics.p90LocUtilization.value}</div>
                                    <div style="font-size: 9pt; color: #666;">In 90% of scenarios, utilization stays below this</div>
                                    ${metrics.p90LocUtilization.explanation ? `
                                    <div class="print-metric-explanation ${metrics.p90LocUtilization.colorClass === 'danger' ? 'danger' : metrics.p90LocUtilization.colorClass === 'warning' ? 'warning' : ''}">
                                        <div class="print-metric-explanation-title">What This Means</div>
                                        <div class="print-metric-explanation-text">
                                            <strong>Definition:</strong> In 90% of simulations, your LOC utilization never exceeds this value. Represents realistic worst-case.<br>
                                            <strong>Margin call threshold:</strong> 100% utilization triggers forced liquidation with haircut penalties.
                                        </div>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>

                        <!-- Safety Buffer Over Time Chart -->
                        ${chartImages.liquiditySafetyBufferChart ? `
                        <div class="print-safety-buffer-chart">
                            <h4>Safety Buffer Over Time</h4>
                            <p>Track how your distance to margin call evolves across different market scenarios over the simulation period.</p>
                            <img src="${chartImages.liquiditySafetyBufferChart}" alt="Safety Buffer Over Time Chart" class="chart-image">
                        </div>
                        ` : ''}

                        <!-- Interpretation Footer -->
                        <div class="print-interpretation">
                            <p><strong>Interpretation:</strong> The stress tests show how close you'd come to a margin call if your portfolio dropped suddenly. "Distance to Margin Call" represents percentage points of safety buffer. Higher values indicate greater resilience to market volatility.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Extracts Strategy Analysis data from the DOM for print formatting.
         * @param {HTMLElement} strategySection - The strategy analysis section element
         * @returns {Object} Extracted strategy analysis data
         */
        function extractStrategyAnalysisDataForPrint(strategySection) {
            if (!strategySection || strategySection.style.display === 'none') {
                return null;
            }

            return {
                subtitle: document.getElementById('saSubtitle')?.textContent || '',
                verdictHeadline: document.getElementById('saVerdictHeadline')?.textContent || '',
                verdictRationale: document.getElementById('saVerdictRationale')?.textContent || '',
                dialValue: document.getElementById('saDialValue')?.textContent || '',

                // BBD Strategy metrics
                bbdTerminalMedian: document.getElementById('bbdTerminalMedian')?.textContent || '',
                bbdSuccessRate: document.getElementById('bbdSuccessRate')?.textContent || '',
                bbdCumulativeInterest: document.getElementById('bbdCumulativeInterest')?.textContent || '',
                bbdDividendTaxes: document.getElementById('bbdDividendTaxes')?.textContent || '',
                bbdRiskFactor: document.getElementById('bbdRiskFactor')?.textContent || '',

                // Sell Assets Strategy metrics
                sellTerminalMedian: document.getElementById('sellTerminalMedian')?.textContent || '',
                sellSuccessRate: document.getElementById('sellSuccessRate')?.textContent || '',
                sellTaxesPaid: document.getElementById('sellTaxesPaid')?.textContent || '',
                sellRiskFactor: document.getElementById('sellRiskFactor')?.textContent || '',

                // Wealth Differential
                terminalDifference: document.getElementById('terminalDifference')?.textContent || '',
                taxSavingsAmount: document.getElementById('taxSavingsAmount')?.textContent || '',
                estateValueDiff: document.getElementById('estateValueDiff')?.textContent || '',

                // Why Strategy Performs Well
                explanationTitle: document.getElementById('saExplanationTitle')?.textContent || '',
                insightQuote: document.getElementById('saInsightQuote')?.textContent || '',
                insightText: document.getElementById('saInsightText')?.textContent || '',
                taxDeferralValue: document.getElementById('saTaxDeferralValue')?.textContent || '',
                taxDeferralText: document.getElementById('saTaxDeferralText')?.textContent || '',
                compoundingValue: document.getElementById('saCompoundingValue')?.textContent || '',
                compoundingText: document.getElementById('saCompoundingText')?.textContent || '',

                // Important Considerations
                considerationsList: document.getElementById('saConsiderationsList')?.innerHTML || ''
            };
        }

        /**
         * Generates print-formatted HTML for the Strategy Analysis section.
         * @param {Object} data - Data extracted from the strategy analysis section
         * @param {Object} chartImages - Chart images including comparison charts
         * @returns {string} Print-formatted HTML string
         */
        function generateStrategyAnalysisPrintHTML(data, chartImages) {
            if (!data) return '';

            return `
                <div class="print-section page-break-before">
                    <h2 class="section-title">Strategy Analysis</h2>
                    <p style="font-size: 10pt; color: #666; margin-bottom: 16px;">${data.subtitle}</p>

                    <!-- Verdict Banner -->
                    <div style="background: linear-gradient(135deg, #E8F5F3 0%, #F0F9FF 100%); border-left: 4px solid #00796B; padding: 20px; margin-bottom: 24px; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="font-size: 16pt; font-weight: 700; color: #1B4B4B; margin: 0 0 8px 0;">${data.verdictHeadline}</h3>
                                <p style="font-size: 10pt; color: #555; margin: 0;">${data.verdictRationale}</p>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24pt; font-weight: 700; color: #00796B;">${data.dialValue}</div>
                                <div style="font-size: 9pt; color: #666;">Success</div>
                            </div>
                        </div>
                    </div>

                    <!-- Side-by-Side Comparison -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                        <!-- BBD Column -->
                        <div style="background: #F0F9FF; border: 2px solid #00796B; border-radius: 8px; padding: 16px;">
                            <h4 style="font-size: 12pt; font-weight: 600; color: #00796B; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 16pt;"></span> Buy Borrow Die
                            </h4>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div>
                                    <div style="font-size: 9pt; color: #666;">Terminal Net Worth</div>
                                    <div style="font-size: 13pt; font-weight: 600; color: #1B4B4B;">${data.bbdTerminalMedian}</div>
                                </div>
                                <div>
                                    <div style="font-size: 9pt; color: #666;">Success Rate</div>
                                    <div style="font-size: 13pt; font-weight: 600; color: #1B4B4B;">${data.bbdSuccessRate}</div>
                                </div>
                                <div>
                                    <div style="font-size: 9pt; color: #666;">Lifetime Cost</div>
                                    <div style="font-size: 13pt; font-weight: 600; color: #D97706;">${data.bbdCumulativeInterest}</div>
                                    <div style="font-size: 8pt; color: #888;">interest paid</div>
                                </div>
                                <div>
                                    <div style="font-size: 9pt; color: #666;">Dividend Taxes</div>
                                    <div style="font-size: 13pt; font-weight: 600; color: #DC2626;">${data.bbdDividendTaxes}</div>
                                </div>
                                <div>
                                    <div style="font-size: 9pt; color: #666;">Primary Risk</div>
                                    <div style="font-size: 11pt; font-weight: 600; color: #DC2626;">${data.bbdRiskFactor}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Sell Assets Column -->
                        <div style="background: #FEF3F2; border: 2px solid #6366F1; border-radius: 8px; padding: 16px;">
                            <h4 style="font-size: 12pt; font-weight: 600; color: #6366F1; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 16pt;"></span> Sell Assets
                            </h4>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div>
                                    <div style="font-size: 9pt; color: #666;">Terminal Net Worth</div>
                                    <div style="font-size: 13pt; font-weight: 600; color: #1B4B4B;">${data.sellTerminalMedian}</div>
                                </div>
                                <div>
                                    <div style="font-size: 9pt; color: #666;">Success Rate</div>
                                    <div style="font-size: 13pt; font-weight: 600; color: #1B4B4B;">${data.sellSuccessRate}</div>
                                </div>
                                <div>
                                    <div style="font-size: 9pt; color: #666;">Lifetime Cost</div>
                                    <div style="font-size: 13pt; font-weight: 600; color: #DC2626;">${data.sellTaxesPaid}</div>
                                    <div style="font-size: 8pt; color: #888;">taxes paid</div>
                                </div>
                                <div>
                                    <div style="font-size: 9pt; color: #666;">Primary Risk</div>
                                    <div style="font-size: 11pt; font-weight: 600; color: #16A34A;">${data.sellRiskFactor}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Wealth Differential -->
                    <div style="background: #FFF7ED; border: 1px solid #F59E0B; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                        <h4 style="font-size: 11pt; font-weight: 600; color: #1B4B4B; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 14pt;"></span> Wealth Differential
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                            <div style="text-align: center;">
                                <div style="font-size: 9pt; color: #666;">BBD vs Sell</div>
                                <div style="font-size: 14pt; font-weight: 700; color: #00796B;">${data.terminalDifference}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 9pt; color: #666;">Tax Savings</div>
                                <div style="font-size: 14pt; font-weight: 700; color: #00796B;">${data.taxSavingsAmount}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 9pt; color: #666;">Estate Value (BBD)</div>
                                <div style="font-size: 14pt; font-weight: 700; color: #00796B;">${data.estateValueDiff}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Why Strategy Performs Well -->
                    <div style="margin-bottom: 24px;">
                        <h4 style="font-size: 11pt; font-weight: 600; color: #1B4B4B; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 14pt;"></span> ${data.explanationTitle}
                        </h4>
                        <div style="background: #E8F5F3; border-left: 3px solid #00796B; padding: 12px 16px; margin-bottom: 16px; font-style: italic; font-size: 10pt; color: #1B4B4B;">
                            ${data.insightQuote}
                        </div>
                        <p style="font-size: 10pt; color: #555; margin-bottom: 16px;">${data.insightText}</p>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div style="background: #F0F9FF; border-radius: 8px; padding: 16px;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                    <span style="font-size: 18pt; color: #00796B;"></span>
                                    <div>
                                        <div style="font-size: 10pt; font-weight: 600; color: #1B4B4B;">Tax Deferral Benefit</div>
                                        <div style="font-size: 12pt; font-weight: 700; color: #00796B;">${data.taxDeferralValue}</div>
                                    </div>
                                </div>
                                <p style="font-size: 9pt; color: #666; margin: 0;">${data.taxDeferralText}</p>
                            </div>

                            <div style="background: #F5F3FF; border-radius: 8px; padding: 16px;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                    <span style="font-size: 18pt; color: #6366F1;"></span>
                                    <div>
                                        <div style="font-size: 10pt; font-weight: 600; color: #1B4B4B;">Compounding Advantage</div>
                                        <div style="font-size: 12pt; font-weight: 700; color: #6366F1;">${data.compoundingValue}</div>
                                    </div>
                                </div>
                                <p style="font-size: 9pt; color: #666; margin: 0;">${data.compoundingText}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Visual Comparison Charts -->
                    <div style="margin-bottom: 24px;">
                        <h4 style="font-size: 11pt; font-weight: 600; color: #1B4B4B; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 14pt;"></span> Visual Comparison
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            ${chartImages.comparisonNetWorthChart ? `
                            <div>
                                <h5 style="font-size: 10pt; font-weight: 600; color: #555; margin: 0 0 8px 0;">Net Worth Over Time (Median)</h5>
                                <img src="${chartImages.comparisonNetWorthChart}" alt="Net Worth Comparison" style="width: 100%; border-radius: 4px;">
                            </div>
                            ` : ''}
                            ${chartImages.comparisonTaxChart ? `
                            <div>
                                <h5 style="font-size: 10pt; font-weight: 600; color: #555; margin: 0 0 8px 0;">Cumulative Costs: Taxes vs Interest</h5>
                                <img src="${chartImages.comparisonTaxChart}" alt="Tax Comparison" style="width: 100%; border-radius: 4px;">
                            </div>
                            ` : ''}
                        </div>
                        ${chartImages.comparisonDistributionChart ? `
                        <div>
                            <h5 style="font-size: 10pt; font-weight: 600; color: #555; margin: 0 0 8px 0;">Terminal Value Distribution (All Percentiles)</h5>
                            <img src="${chartImages.comparisonDistributionChart}" alt="Distribution Comparison" style="width: 100%; border-radius: 4px;">
                        </div>
                        ` : ''}
                    </div>

                    <!-- Important Considerations -->
                    <div>
                        <h4 style="font-size: 11pt; font-weight: 600; color: #1B4B4B; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 14pt;"></span> Important Considerations
                        </h4>
                        <div style="background: #FEF3F2; border: 1px solid #F87171; border-radius: 8px; padding: 16px;">
                            ${data.considerationsList}
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Generates Executive Summary HTML for Monte Carlo mode print view.
         * Extracts content from the MC-specific DOM structure.
         * @returns {string} HTML string for the Executive Summary section
         */
        function generateMCExecutiveSummaryPrintHTML() {
            const executiveSummaryContent = document.getElementById('executiveSummaryContent');
            if (!executiveSummaryContent) {
                return '';
            }

            // Extract hero summary text
            const heroText = executiveSummaryContent.querySelector('.es-hero-text')?.innerHTML || '';
            const heroSubtext = executiveSummaryContent.querySelector('.es-hero-subtext')?.textContent || '';
            const heroBadge = executiveSummaryContent.querySelector('.es-hero-badge')?.textContent || '';

            // Determine status class from badge
            let statusClass = 'favorable';
            if (heroBadge.toLowerCase().includes('moderate')) {
                statusClass = 'moderate';
            } else if (heroBadge.toLowerCase().includes('high risk')) {
                statusClass = 'unfavorable';
            }

            // Extract Key Findings metrics
            const metricsGrid = executiveSummaryContent.querySelector('.sr-metrics-grid');
            let keyFindingsHTML = '';
            if (metricsGrid) {
                const metricCards = metricsGrid.querySelectorAll('.sr-metric-card');
                const metrics = [];
                metricCards.forEach(card => {
                    const icon = card.querySelector('.sr-metric-icon')?.textContent || '';
                    const label = card.querySelector('.sr-metric-label')?.textContent || '';
                    const value = card.querySelector('.sr-metric-value')?.textContent || '';
                    const delta = card.querySelector('.sr-metric-delta')?.textContent || '';
                    const valueClass = card.querySelector('.sr-metric-value')?.classList.contains('positive') ? 'highlight-success' :
                                       card.querySelector('.sr-metric-value')?.classList.contains('negative') ? 'highlight-danger' : '';
                    metrics.push({ icon, label, value, delta, valueClass });
                });

                // Build metrics grid (2x2)
                if (metrics.length > 0) {
                    const row1 = metrics.slice(0, 2).map(m => `
                        <div class="exec-metric-card ${m.valueClass === 'highlight-success' ? 'highlight-success' : m.valueClass === 'highlight-danger' ? 'highlight-danger' : ''}">
                            <div class="exec-metric-label">${m.label}</div>
                            <div class="exec-metric-value">${m.value}</div>
                        </div>
                    `).join('');
                    const row2 = metrics.slice(2, 4).map(m => `
                        <div class="exec-metric-card ${m.valueClass === 'highlight-success' ? 'highlight-success' : m.valueClass === 'highlight-danger' ? 'highlight-danger' : ''}">
                            <div class="exec-metric-label">${m.label}</div>
                            <div class="exec-metric-value">${m.value}</div>
                        </div>
                    `).join('');

                    keyFindingsHTML = `
                        <div class="exec-key-findings">
                            <div class="exec-section-header">
                                <span class="header-icon"></span>
                                KEY FINDINGS
                            </div>
                            <div class="exec-metrics-grid exec-metrics-row-2">${row1}</div>
                            <div class="exec-metrics-grid exec-metrics-row-2">${row2}</div>
                        </div>
                    `;
                }
            }

            // Extract Strategic Considerations
            const considerationsGrid = executiveSummaryContent.querySelector('.es-considerations-grid');
            let strategicHTML = '';
            if (considerationsGrid) {
                const cards = considerationsGrid.querySelectorAll('.es-consideration-card');
                const rows = [];
                cards.forEach(card => {
                    const icon = card.querySelector('.es-consideration-icon')?.textContent || '';
                    const title = card.querySelector('.es-consideration-title')?.textContent || '';
                    const text = card.querySelector('.es-consideration-text')?.textContent || '';
                    rows.push(`
                        <div class="exec-consideration-row">
                            <div class="exec-consideration-icon">${icon}</div>
                            <div class="exec-consideration-content">
                                <div class="exec-consideration-title">${title}</div>
                                <div class="exec-consideration-text">${text}</div>
                            </div>
                        </div>
                    `);
                });

                if (rows.length > 0) {
                    strategicHTML = `
                        <div class="exec-strategic-considerations">
                            <div class="exec-section-header">
                                <span class="header-icon"></span>
                                STRATEGIC CONSIDERATIONS
                            </div>
                            <div class="exec-considerations-container">
                                <div class="exec-considerations-list">
                                    ${rows.join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            // Extract Next Steps
            const nextStepsGrid = executiveSummaryContent.querySelector('.es-next-steps-grid');
            let nextStepsHTML = '';
            if (nextStepsGrid) {
                const cards = nextStepsGrid.querySelectorAll('.es-next-step-card');
                const steps = [];
                let stepNum = 1;
                cards.forEach(card => {
                    const title = card.querySelector('.es-next-step-title')?.textContent || '';
                    const text = card.querySelector('.es-next-step-text')?.textContent || '';
                    const isWarning = card.classList.contains('warning');
                    steps.push(`
                        <div class="exec-step-item ${isWarning ? 'warning-step' : ''}">
                            <div class="exec-step-number">${stepNum}</div>
                            <div class="exec-step-content">
                                <strong>${title}:</strong> ${text}
                            </div>
                        </div>
                    `);
                    stepNum++;
                });

                if (steps.length > 0) {
                    nextStepsHTML = `
                        <div class="exec-next-steps">
                            <div class="exec-section-header">
                                <span class="header-icon"></span>
                                RECOMMENDED NEXT STEPS
                            </div>
                            <div class="exec-steps-list">
                                ${steps.join('')}
                            </div>
                        </div>
                    `;
                }
            }

            return `
                <!-- Executive Summary (Monte Carlo) -->
                <div class="print-section executive-section">
                    <h2 class="section-title">Executive Summary</h2>

                    <div class="section">
                        <div class="section-title">Strategy Overview</div>
                        <div class="overview-text">${heroText}</div>
                        <div style="font-size: 9pt; color: #666; margin-top: 8px; font-style: italic;">${heroSubtext}</div>
                    </div>

                    <div class="section">
                        <div class="section-title">Strategy Outcome</div>
                        <div class="outcome-box" style="display: flex; align-items: center; gap: 12px;">
                            <span style="padding: 6px 14px; border-radius: 20px; font-size: 11pt; font-weight: 600;
                                background: ${statusClass === 'favorable' ? 'linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)' : statusClass === 'moderate' ? 'linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%)' : 'linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%)'};
                                color: ${statusClass === 'favorable' ? '#16A34A' : statusClass === 'moderate' ? '#D97706' : '#DC2626'};
                                border: 1px solid ${statusClass === 'favorable' ? '#4CAF50' : statusClass === 'moderate' ? '#F59E0B' : '#EF4444'};">
                                ${heroBadge}
                            </span>
                        </div>
                    </div>

                    ${keyFindingsHTML}

                    ${strategicHTML}

                    ${nextStepsHTML}
                </div>
            `;
        }

        /**
         * Generates the complete HTML document for the print window.
         * @param {Object} chartImages - Object containing chart image data URLs
         * @returns {string} Complete HTML document string
         */
        function generatePrintHTML(chartImages) {
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const timeStr = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });

            // Collect section contents - extract values for clean print layout
            const salaryEquivalent = document.getElementById('salaryEquivalent')?.textContent || '$0';
            const taxableEquivalent = document.getElementById('taxableEquivalent')?.textContent || '$0';
            const taxSavingsText = document.getElementById('taxSavingsText')?.textContent || '';
            const summaryText = document.getElementById('summaryText')?.innerHTML || '';

            // Check if we're in Monte Carlo mode
            const monteCarloSection = document.getElementById('monteCarloChartsSection');
            const isMonteCarlo = monteCarloSection && monteCarloSection.style.display !== 'none';

            // Extract portfolio and key metrics data for clean print layout
            const printMetrics = extractPrintMetrics();
            const portfolioCompositionHTML = generatePortfolioCompositionPrintHTML(printMetrics);

            // Generate Executive Summary HTML based on mode
            let executiveSummaryHTML = '';

            if (isMonteCarlo) {
                // Monte Carlo mode - extract from MC Executive Summary structure
                executiveSummaryHTML = generateMCExecutiveSummaryPrintHTML();
            } else {
                // Single-asset mode - use original extraction
                const strategyOverview = document.getElementById('strategyOverview')?.innerHTML || '';
                const outcomeBox = document.getElementById('outcomeBox')?.innerHTML || '';
                const keyFindingsList = document.getElementById('keyFindingsList')?.innerHTML || '';
                const strategicConsiderationsList = document.getElementById('strategicConsiderationsList')?.innerHTML || '';
                const nextStepsList = document.getElementById('nextStepsList')?.innerHTML || '';

                executiveSummaryHTML = generateExecutiveSummaryPrintHTML(
                    strategyOverview,
                    outcomeBox,
                    keyFindingsList,
                    strategicConsiderationsList,
                    nextStepsList
                );
            }

            // Generate Performance Summary table (only in Monte Carlo mode)
            let performanceSummaryHTML = '';
            if (isMonteCarlo && printMetrics.performanceSummaryData) {
                const inflationRate = parseFloat(document.getElementById('inflationRate')?.value) || 0;
                performanceSummaryHTML = generatePerformanceSummaryPrintHTML(printMetrics.performanceSummaryData, inflationRate);
            }

            // Check if comparison section is visible
            const comparisonCard = document.getElementById('comparisonCard');
            const showComparison = comparisonCard && comparisonCard.style.display !== 'none';

            // Collect comparison metrics if visible
            let comparisonHTML = '';
            if (showComparison) {
                const bbdTerminalMedian = document.getElementById('bbdTerminalMedian')?.textContent || '';
                const bbdSuccessRate = document.getElementById('bbdSuccessRate')?.textContent || '';
                const bbdCumulativeInterest = document.getElementById('bbdCumulativeInterest')?.textContent || '';
                const bbdDividendTaxes = document.getElementById('bbdDividendTaxes')?.textContent || '';
                const bbdRiskFactor = document.getElementById('bbdRiskFactor')?.textContent || '';
                const sellTerminalMedian = document.getElementById('sellTerminalMedian')?.textContent || '';
                const sellSuccessRate = document.getElementById('sellSuccessRate')?.textContent || '';
                const sellTaxesPaid = document.getElementById('sellTaxesPaid')?.textContent || '';
                const sellRiskFactor = document.getElementById('sellRiskFactor')?.textContent || '';
                const taxSavingsAmount = document.getElementById('taxSavingsAmount')?.textContent || '';
                const terminalDifference = document.getElementById('terminalDifference')?.textContent || '';
                const estateValueDiff = document.getElementById('estateValueDiff')?.textContent || '';
                const comparisonRecommendation = document.getElementById('comparisonRecommendation')?.innerHTML || '';

                comparisonHTML = `
                    <div class="print-section page-break-before">
                        <h2 class="section-title">Strategy Comparison: Buy Borrow Die vs. Sell Assets</h2>

                        <div class="comparison-intro">
                            <p>This comparison shows two wealth management strategies using <strong>identical market returns</strong> for each simulation:</p>
                            <ul>
                                <li><strong>Buy Borrow Die (BBD):</strong> Borrow against assets for income, pay no taxes until death (step-up basis), but face margin call risk</li>
                                <li><strong>Sell Assets:</strong> Sell assets annually for income, pay capital gains taxes each year, no leverage risk</li>
                            </ul>
                        </div>

                        <div class="comparison-grid">
                            <div class="strategy-box bbd-box">
                                <h3>Buy Borrow Die Strategy</h3>
                                <div class="metric-item">
                                    <span class="metric-label">Terminal Net Worth (Median)</span>
                                    <span class="metric-value highlight-success">${bbdTerminalMedian}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Success Rate</span>
                                    <span class="metric-value">${bbdSuccessRate}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Cumulative Interest (Lifetime)</span>
                                    <span class="metric-value highlight-warning">${bbdCumulativeInterest}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Dividend Taxes (Median, Lifetime)</span>
                                    <span class="metric-value highlight-error">${bbdDividendTaxes}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Risk Factor</span>
                                    <span class="metric-value">${bbdRiskFactor}</span>
                                </div>
                            </div>

                            <div class="strategy-box sell-box">
                                <h3>Sell Assets Strategy</h3>
                                <div class="metric-item">
                                    <span class="metric-label">Terminal Net Worth (Median)</span>
                                    <span class="metric-value highlight-primary">${sellTerminalMedian}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Success Rate</span>
                                    <span class="metric-value">${sellSuccessRate}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Taxes Paid (Median, Lifetime)</span>
                                    <span class="metric-value highlight-error">${sellTaxesPaid}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Risk Factor</span>
                                    <span class="metric-value highlight-success">${sellRiskFactor}</span>
                                </div>
                            </div>
                        </div>

                        <div class="differential-summary">
                            <h3>Wealth Differential Analysis</h3>
                            <div class="diff-grid">
                                <div class="diff-item">
                                    <span class="diff-label">Tax Savings (BBD Advantage)</span>
                                    <span class="diff-value highlight-success">${taxSavingsAmount}</span>
                                </div>
                                <div class="diff-item">
                                    <span class="diff-label">Terminal Value Difference</span>
                                    <span class="diff-value">${terminalDifference}</span>
                                </div>
                                <div class="diff-item">
                                    <span class="diff-label">Estate Value (w/ Step-Up)</span>
                                    <span class="diff-value">${estateValueDiff}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Strategy Comparison Charts Row -->
                        <div class="mc-charts-grid">
                            ${chartImages.comparisonNetWorthChart ? `
                            <div class="mc-chart-card">
                                <div class="mc-chart-header">
                                    <span class="material-icons">show_chart</span>
                                    <h4>Net Worth Over Time (Median Scenario)</h4>
                                </div>
                                <div class="mc-chart-body">
                                    <img src="${chartImages.comparisonNetWorthChart}" alt="Comparison Net Worth Chart" class="chart-image">
                                </div>
                            </div>
                            ` : ''}

                            ${chartImages.comparisonTaxChart ? `
                            <div class="mc-chart-card">
                                <div class="mc-chart-header">
                                    <span class="material-icons">account_balance_wallet</span>
                                    <h4>Cumulative Costs: Taxes vs Interest</h4>
                                </div>
                                <div class="mc-chart-body">
                                    <img src="${chartImages.comparisonTaxChart}" alt="Comparison Tax Chart" class="chart-image">
                                </div>
                            </div>
                            ` : ''}
                        </div>

                        ${chartImages.comparisonDistributionChart ? `
                        <div class="chart-section">
                            <h4>Terminal Value Distribution (All Percentiles)</h4>
                            <img src="${chartImages.comparisonDistributionChart}" alt="Comparison Distribution Chart" class="chart-image">
                        </div>
                        ` : ''}
                    </div>
                `;
            }

            // Check if Monte Carlo section is visible (check both class and inline style)
            const mcSection = document.getElementById('monteCarloChartsSection');
            const showMonteCarlo = mcSection && (mcSection.style.display === 'block' || (!mcSection.classList.contains('hidden') && mcSection.style.display !== 'none'));

            // Generate Monte Carlo Charts HTML
            let monteCarloChartsHTML = '';
            if (showMonteCarlo) {
                monteCarloChartsHTML = `
                    <div class="print-section">
                        <h2 class="section-title">Monte Carlo Simulation Charts</h2>

                        <!-- Row 1: Net Worth Over Time & SBLOC Balance -->
                        <div class="mc-charts-grid">
                            ${chartImages.trendChart ? `
                            <div class="mc-chart-card">
                                <div class="mc-chart-header">
                                    <span class="material-icons">trending_up</span>
                                    <h4>Net Worth Over Time</h4>
                                </div>
                                <div class="mc-chart-body">
                                    <img src="${chartImages.trendChart}" alt="Net Worth Over Time Chart" class="chart-image">
                                </div>
                            </div>
                            ` : ''}

                            ${chartImages.debtChart ? `
                            <div class="mc-chart-card">
                                <div class="mc-chart-header">
                                    <span class="material-icons">account_balance</span>
                                    <h4>SBLOC Balance to SBLOC% Used</h4>
                                </div>
                                <div class="mc-chart-body">
                                    <img src="${chartImages.debtChart}" alt="SBLOC Balance Chart" class="chart-image">
                                </div>
                            </div>
                            ` : ''}
                        </div>

                        <!-- Row 2: SBLOC Utilization & Net Worth Percentiles -->
                        <div class="mc-charts-grid">
                            ${chartImages.sblocUtilizationChart ? `
                            <div class="mc-chart-card">
                                <div class="mc-chart-header">
                                    <span class="material-icons">credit_card</span>
                                    <h4>SBLOC Usage % Over Time (Percentiles)</h4>
                                </div>
                                <div class="mc-chart-body">
                                    <img src="${chartImages.sblocUtilizationChart}" alt="SBLOC Utilization Chart" class="chart-image">
                                </div>
                            </div>
                            ` : ''}

                            ${chartImages.netWorthPercentilesChart ? `
                            <div class="mc-chart-card">
                                <div class="mc-chart-header">
                                    <span class="material-icons">insights</span>
                                    <h4>Net Worth Across Simulations (Percentiles)</h4>
                                </div>
                                <div class="mc-chart-body">
                                    <img src="${chartImages.netWorthPercentilesChart}" alt="Net Worth Percentiles Chart" class="chart-image">
                                </div>
                            </div>
                            ` : ''}
                        </div>

                        <!-- Row 3: Margin Call Risk & Terminal Distribution -->
                        <div class="mc-charts-grid">
                            ${chartImages.marginCallRiskChart ? `
                            <div class="mc-chart-card">
                                <div class="mc-chart-header">
                                    <span class="material-icons">warning</span>
                                    <h4>Margin Call Risk by Year</h4>
                                </div>
                                <div class="mc-chart-body">
                                    <img src="${chartImages.marginCallRiskChart}" alt="Margin Call Risk Chart" class="chart-image">
                                </div>
                            </div>
                            ` : ''}

                            ${chartImages.terminalDistributionChart ? `
                            <div class="mc-chart-card">
                                <div class="mc-chart-header">
                                    <span class="material-icons">bar_chart</span>
                                    <h4>Terminal Net Worth Distribution</h4>
                                </div>
                                <div class="mc-chart-body">
                                    <img src="${chartImages.terminalDistributionChart}" alt="Terminal Distribution Chart" class="chart-image">
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            // Generate Strategic Recommendation HTML (separate from comparison for proper placement)
            let strategicRecommendationHTML = '';
            if (showComparison) {
                const comparisonRecommendation = document.getElementById('comparisonRecommendation')?.innerHTML || '';
                strategicRecommendationHTML = `
                    <div class="print-section">
                        <div class="recommendation-box">
                            <h3>Strategic Recommendation</h3>
                            <div class="recommendation-content">${comparisonRecommendation}</div>
                        </div>
                    </div>
                `;
            }

            // Generate Strategy Analysis section for print
            let strategyAnalysisHTML = '';
            const strategyAnalysisSection = document.getElementById('strategyAnalysisSection');
            if (strategyAnalysisSection && strategyAnalysisSection.style.display !== 'none') {
                const strategyData = extractStrategyAnalysisDataForPrint(strategyAnalysisSection);
                strategyAnalysisHTML = generateStrategyAnalysisPrintHTML(strategyData, chartImages);
            }

            // Generate liquidity stress testing section with proper print formatting
            // HIDDEN: Stress Testing Dashboard removed from print view
            let stressTestingHTML = '';
            /*
            const liquidityDashboardEl = document.getElementById('liquidityStressDashboard');
            if (liquidityDashboardEl && liquidityDashboardEl.innerHTML.trim() !== '') {
                // Extract data from the DOM for print-specific formatting
                const stressData = extractLiquidityStressDataForPrint(liquidityDashboardEl);
                stressTestingHTML = generateLiquidityStressPrintHTML(stressData, chartImages);
            }
            */

            // Generate Year-by-Year Percentile Analysis table for print
            let yearByYearTableHTML = '';
            if (isMonteCarlo) {
                const percentileTableEl = document.querySelector('.percentile-table-card');
                if (percentileTableEl) {
                    // Extract table data from DOM
                    const tableEl = percentileTableEl.querySelector('table');
                    if (tableEl) {
                        const rows = tableEl.querySelectorAll('tbody tr');
                        const tableRows = [];
                        rows.forEach(row => {
                            const cells = row.querySelectorAll('td');
                            if (cells.length >= 8) {
                                tableRows.push({
                                    year: cells[0]?.textContent || '',
                                    annualWithdrawal: cells[1]?.textContent || '',
                                    cumulativeWithdrawal: cells[2]?.textContent || '',
                                    p10: cells[3]?.textContent || '',
                                    p25: cells[4]?.textContent || '',
                                    p50: cells[5]?.textContent || '',
                                    p75: cells[6]?.textContent || '',
                                    p90: cells[7]?.textContent || ''
                                });
                            }
                        });

                        if (tableRows.length > 0) {
                            yearByYearTableHTML = `
                                <div class="print-section page-break-before">
                                    <h2 class="section-title">Year-by-Year Percentile Analysis</h2>
                                    <p class="section-subtitle">Detailed projection of net worth across probability distributions</p>
                                    <div class="percentile-table-wrapper">
                                        <table class="percentile-table">
                                            <thead>
                                                <tr>
                                                    <th rowspan="2">Year</th>
                                                    <th colspan="2" class="withdrawal-group">Withdrawals</th>
                                                    <th colspan="5" class="networth-group">Net Worth by Percentile</th>
                                                </tr>
                                                <tr>
                                                    <th class="withdrawal-col">Annual</th>
                                                    <th class="withdrawal-col">Cumulative</th>
                                                    <th class="p10">10th</th>
                                                    <th class="p25">25th</th>
                                                    <th class="p50">50th</th>
                                                    <th class="p75">75th</th>
                                                    <th class="p90">90th</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${tableRows.map(row => `
                                                    <tr>
                                                        <td class="year-col">${row.year}</td>
                                                        <td class="withdrawal-col"><strong>${row.annualWithdrawal}</strong></td>
                                                        <td class="withdrawal-col"><strong>${row.cumulativeWithdrawal}</strong></td>
                                                        <td class="p10">${row.p10}</td>
                                                        <td class="p25">${row.p25}</td>
                                                        <td class="p50">${row.p50}</td>
                                                        <td class="p75">${row.p75}</td>
                                                        <td class="p90">${row.p90}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="percentile-legend">
                                        <span class="legend-item"><span class="legend-dot p10-dot"></span>10th: Worst case (90% do better)</span>
                                        <span class="legend-item"><span class="legend-dot p50-dot"></span>50th: Median outcome</span>
                                        <span class="legend-item"><span class="legend-dot p90-dot"></span>90th: Best case (only 10% do better)</span>
                                    </div>
                                </div>
                            `;
                        }
                    }
                }
            }

            return `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Strategy Simulation Report - ${dateStr}</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* Reset and Base Styles */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 11pt;
            line-height: 1.5;
            color: #1a1a2e;
            background: #ffffff;
            padding: 0;
            margin: 0;
        }

        /* Print Button */
        .print-button-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .print-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 14px 14px;
            background: linear-gradient(135deg, #1B4B4B 0%, #00796B 100%);
            color: #FFFFFF;
            border: none;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(27, 75, 75, 0.3);
            transition: all 0.2s ease;
        }

        .print-btn:hover {
            background: linear-gradient(135deg, #0F3333 0%, #00695C 100%);
            box-shadow: 0 6px 16px rgba(27, 75, 75, 0.4);
            transform: translateY(-2px);
        }

        .print-btn .material-icons {
            font-size: 30px;
        }

        @media print {
            .print-button-container {
                display: none !important;
            }
        }

        /* Page Layout */
        .report-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 50px;
        }

        /* Header */
        .report-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 3px solid #00796B;
        }

        .report-title {
            font-size: 28pt;
            font-weight: 700;
            color: #1B4B4B;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .report-subtitle {
            font-size: 12pt;
            color: #666;
            margin-bottom: 16px;
        }

        .report-date {
            font-size: 10pt;
            color: #888;
        }

        /* Section Styles */
        .print-section {
            margin-bottom: 36px;
            break-inside: avoid;
        }

        .section-title {
            font-size: 16pt;
            font-weight: 600;
            color: #1B4B4B;
            margin-bottom: 20px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }

        /* Print Portfolio Section - Clean Layout */
        .print-portfolio-section {
            break-inside: avoid;
        }

        .print-portfolio-section .section-title {
            font-size: 16pt;
            font-weight: 600;
            color: #1B4B4B;
            margin-bottom: 20px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }

        /* Key Metrics Grid */
        .metrics-container {
            break-inside: avoid;
        }

        .metrics-container .hero-metrics-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .metrics-container .hero-metric-card {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            text-align: left;
            break-inside: avoid;
        }

        .metrics-container .hero-metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #00796B;
            border-radius: 8px 8px 0 0;
        }

        .metrics-container .hero-metric-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .metrics-container .hero-metric-card .card-title {
            font-size: 10pt;
            font-weight: 700;
            color: #1a1a2e;
            margin: 0;
        }

        .metrics-container .hero-metric-card .card-subtitle {
            font-size: 7pt;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 0;
        }

        .metrics-container .hero-metric-card .card-status-badge {
            display: none;
        }

        .metrics-container .metric-icon {
            display: none;
        }

        .metrics-container .metric-label {
            font-size: 8pt;
            font-weight: 500;
            color: #666;
            margin-top: 4px;
        }

        .metrics-container .metric-value {
            font-size: 16pt;
            font-weight: 700;
            color: #1a1a2e;
        }

        .metrics-container .metric-suffix {
            font-size: 10pt;
            font-weight: 600;
            color: #666;
        }

        .metrics-container .hero-metric-card .metric-secondary {
            display: flex;
            justify-content: space-between;
            padding-top: 8px;
            margin-top: 8px;
            border-top: 1px solid #e0e0e0;
        }

        .metrics-container .hero-metric-card .secondary-value {
            font-size: 9pt;
            font-weight: 600;
            color: #1a1a2e;
        }

        .metrics-container .hero-metric-card .secondary-value.positive {
            color: #16A34A;
        }

        .metrics-container .hero-metric-card .secondary-label {
            font-size: 7pt;
            color: #888;
        }

        .metrics-container .hero-metric-card .worst-case {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 8px;
            margin-top: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            font-size: 7pt;
            color: #666;
        }

        .metrics-container .hero-metric-card .worst-case .material-icons {
            font-size: 10pt;
        }

        .metrics-container .hero-metric-card .worst-case-value {
            font-weight: 600;
            color: #FF6B6B;
        }

        .metrics-container .secondary-metrics-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .metrics-container .secondary-metric-card {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 16px;
            text-align: center;
            break-inside: avoid;
        }

        .metrics-container .portfolio-composition {
            margin-top: 20px;
        }

        .metrics-container .portfolio-assets-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .metrics-container .asset-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #e8f5e9;
            border: 1px solid #c8e6c9;
            border-radius: 20px;
            font-size: 10pt;
        }

        /* Chart Styles */
        .chart-section {
            margin: 24px 0;
            break-inside: avoid;
        }

        .chart-section h4 {
            font-size: 11pt;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            text-align: center;
        }

        .chart-image {
            width: 100%;
            max-width: 100%;
            height: auto;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            display: block;
        }

        .charts-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        .chart-half {
            break-inside: avoid;
        }

        .chart-half h4 {
            font-size: 10pt;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }

        .chart-half .chart-image {
            width: 100%;
        }

        /* Monte Carlo Chart Cards with Teal Headers */
        .mc-charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        .mc-chart-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            break-inside: avoid;
            page-break-inside: avoid;
            background: #ffffff;
        }

        .mc-chart-header {
            background: linear-gradient(135deg, #00796B 0%, #004D40 100%);
            color: #ffffff;
            padding: 10px 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mc-chart-header .material-icons {
            font-size: 18px;
            opacity: 0.9;
        }

        .mc-chart-header h4 {
            margin: 0;
            font-size: 10pt;
            font-weight: 600;
            color: #ffffff;
        }

        .mc-chart-body {
            padding: 12px;
            background: #ffffff;
        }

        .mc-chart-body .chart-image {
            width: 100%;
            border: none;
            border-radius: 4px;
        }

        /* Salary Equivalent */
        .salary-section {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-radius: 12px;
            margin: 24px 0;
            break-inside: avoid;
        }

        .salary-section h3 {
            font-size: 12pt;
            font-weight: 500;
            color: #2e7d32;
            margin-bottom: 12px;
        }

        .salary-amount {
            font-size: 32pt;
            font-weight: 700;
            color: #1b5e20;
            margin-bottom: 16px;
        }

        .salary-equivalent-text {
            font-size: 10pt;
            color: #388e3c;
            margin-bottom: 8px;
        }

        .taxable-amount {
            font-size: 20pt;
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 12px;
        }

        .tax-savings-text {
            font-size: 9pt;
            color: #666;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Strategy Summary */
        .summary-section {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 24px;
            margin: 24px 0;
            break-inside: avoid;
        }

        .summary-section p {
            margin-bottom: 12px;
            line-height: 1.7;
        }

        /* Executive Summary */
        .executive-section {
            margin: 24px 0;
        }

        .executive-section .section {
            margin-bottom: 20px;
            break-inside: avoid;
        }

        .executive-section .section-title {
            font-size: 12pt;
            font-weight: 600;
            color: #1B4B4B;
            margin-bottom: 12px;
            border-bottom: none;
            padding-bottom: 0;
        }

        .executive-section .overview-text {
            background: #f0f7f7;
            padding: 16px;
            border-radius: 6px;
            border-left: 4px solid #00796B;
            line-height: 1.7;
        }

        .executive-section .outcome-box {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        .executive-section ul {
            margin-left: 20px;
            line-height: 1.8;
        }

        .executive-section li {
            margin-bottom: 8px;
        }

        /* ========================================
           Executive Summary - Redesigned Print Styles
           ======================================== */

        /* Key Findings Metrics Grid */
        .exec-key-findings {
            break-inside: avoid;
            margin-bottom: 24px;
        }

        .exec-section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13pt;
            font-weight: 600;
            color: #1B4B4B;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }

        .exec-section-header .header-icon {
            font-size: 18px;
        }

        .exec-metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .exec-metrics-grid.exec-metrics-row-2 {
            grid-template-columns: repeat(2, 1fr);
            margin-bottom: 12px;
        }

        .exec-metrics-grid.exec-metrics-row-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .exec-metric-card {
            background: #f8fafa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px 12px;
            text-align: center;
            break-inside: avoid;
        }

        .exec-metric-card.highlight-success {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-color: #4CAF50;
        }

        .exec-metric-card.highlight-warning {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-color: #F59E0B;
        }

        .exec-metric-card.highlight-danger {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-color: #EF4444;
        }

        .exec-metric-label {
            font-size: 9pt;
            font-weight: 500;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .exec-metric-value {
            font-size: 16pt;
            font-weight: 700;
            color: #1a1a2e;
        }

        .exec-metric-card.highlight-success .exec-metric-value {
            color: #16A34A;
        }

        .exec-metric-card.highlight-warning .exec-metric-value {
            color: #D97706;
        }

        .exec-metric-card.highlight-danger .exec-metric-value {
            color: #DC2626;
        }

        .exec-portfolio-tagline {
            background: #f0f5f4;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px 16px;
            font-size: 10pt;
            color: #333;
            line-height: 1.5;
        }

        .exec-portfolio-tagline strong {
            color: #1B4B4B;
        }

        /* Strategic Considerations Cards */
        .exec-strategic-considerations {
            break-inside: avoid;
            margin-bottom: 24px;
        }

        .exec-considerations-list {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .exec-consideration-row {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            padding: 14px 16px;
            border-bottom: 1px solid #e8e8e8;
        }

        .exec-consideration-row:nth-child(odd) {
            background: #f8fafa;
        }

        .exec-consideration-row:nth-child(even) {
            background: #ffffff;
        }

        .exec-consideration-row:first-child {
            border-radius: 8px 8px 0 0;
        }

        .exec-consideration-row:last-child {
            border-radius: 0 0 8px 8px;
            border-bottom: none;
        }

        .exec-consideration-icon {
            font-size: 20px;
            flex-shrink: 0;
            width: 28px;
            text-align: center;
        }

        .exec-consideration-content {
            flex: 1;
        }

        .exec-consideration-title {
            font-size: 10pt;
            font-weight: 600;
            color: #1B4B4B;
            margin-bottom: 4px;
        }

        .exec-consideration-text {
            font-size: 9.5pt;
            color: #555;
            line-height: 1.5;
        }

        .exec-considerations-container {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        /* Recommended Next Steps */
        .exec-next-steps {
            break-inside: avoid;
            margin-bottom: 24px;
        }

        .exec-steps-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .exec-step-item {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            padding: 12px 16px;
            background: #f8fafa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .exec-step-item.warning-step {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-color: #F59E0B;
        }

        .exec-step-item.suggestion-step {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-color: #3B82F6;
        }

        .exec-step-number {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #1B4B4B 0%, #00796B 100%);
            color: #ffffff;
            font-size: 11pt;
            font-weight: 700;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .exec-step-item.warning-step .exec-step-number {
            background: linear-gradient(135deg, #D97706 0%, #F59E0B 100%);
        }

        .exec-step-item.suggestion-step .exec-step-number {
            background: linear-gradient(135deg, #2563EB 0%, #3B82F6 100%);
        }

        .exec-step-content {
            flex: 1;
            font-size: 10pt;
            color: #333;
            line-height: 1.5;
        }

        .exec-step-content strong {
            color: #1B4B4B;
        }

        .exec-step-item.warning-step .exec-step-content strong {
            color: #B45309;
        }

        .exec-step-item.suggestion-step .exec-step-content strong {
            color: #1D4ED8;
        }

        /* Stress Testing Dashboard */
        .stress-dashboard {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            break-inside: avoid;
        }

        .stress-dashboard .stress-metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .stress-dashboard .stress-metric-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 16px;
            text-align: center;
        }

        /* Liquidity Stress Testing Dashboard - Print Styles */
        .print-liquidity-dashboard {
            break-inside: avoid;
        }

        .print-risk-banner {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 24px;
        }

        .print-risk-banner.safe {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 2px solid #16A34A;
        }

        .print-risk-banner.warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
            border: 2px solid #EAB308;
        }

        .print-risk-banner.danger {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border: 2px solid #DC2626;
        }

        .print-risk-icon {
            font-size: 36px;
            flex-shrink: 0;
        }

        .print-risk-content {
            flex: 1;
        }

        .print-risk-title {
            font-size: 14pt;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .print-risk-banner.safe .print-risk-title { color: #155724; }
        .print-risk-banner.warning .print-risk-title { color: #856404; }
        .print-risk-banner.danger .print-risk-title { color: #721c24; }

        .print-risk-description {
            font-size: 10pt;
            line-height: 1.5;
            color: #333;
        }

        /* Stress Test Scenarios Grid */
        .print-stress-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .print-stress-card {
            background: #ffffff;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #e0e0e0;
            break-inside: avoid;
        }

        .print-stress-card.safe {
            border-left: 4px solid #16A34A;
        }

        .print-stress-card.warning {
            border-left: 4px solid #EAB308;
        }

        .print-stress-card.danger {
            border-left: 4px solid #DC2626;
        }

        .print-stress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e8e8e8;
        }

        .print-stress-title {
            font-size: 11pt;
            font-weight: 600;
            color: #1B4B4B;
        }

        .print-stress-badge {
            font-size: 9pt;
            font-weight: 700;
            padding: 3px 10px;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .print-stress-badge.safe {
            background: #d4edda;
            color: #155724;
        }

        .print-stress-badge.warning {
            background: #fff3cd;
            color: #856404;
        }

        .print-stress-badge.danger {
            background: #f8d7da;
            color: #721c24;
        }

        .print-stress-metrics {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .print-stress-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 10pt;
        }

        .print-stress-metric-label {
            color: #666;
        }

        .print-stress-metric-value {
            font-weight: 600;
            color: #1a1a2e;
        }

        /* Key Liquidity Metrics - Print */
        .print-liquidity-metrics {
            background: #f8fafa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
            break-inside: avoid;
        }

        .print-liquidity-metrics h4 {
            font-size: 12pt;
            font-weight: 600;
            color: #1B4B4B;
            margin-bottom: 16px;
        }

        .print-liquidity-metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .print-liquidity-metric-card {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 16px;
        }

        .print-liquidity-metric-label {
            font-size: 9pt;
            color: #666;
            margin-bottom: 6px;
        }

        .print-liquidity-metric-value {
            font-size: 16pt;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .print-liquidity-metric-value.primary { color: #1B4B4B; }
        .print-liquidity-metric-value.danger { color: #DC2626; }
        .print-liquidity-metric-value.warning { color: #EAB308; }
        .print-liquidity-metric-value.safe { color: #16A34A; }

        .print-metric-explanation {
            background: #f0f7ff;
            border-left: 3px solid #2196F3;
            padding: 10px;
            border-radius: 0 4px 4px 0;
            margin-top: 10px;
        }

        .print-metric-explanation.danger {
            background: #fff5f5;
            border-left-color: #DC2626;
        }

        .print-metric-explanation.warning {
            background: #fffbeb;
            border-left-color: #EAB308;
        }

        .print-metric-explanation-title {
            font-size: 9pt;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .print-metric-explanation.danger .print-metric-explanation-title { color: #DC2626; }
        .print-metric-explanation.warning .print-metric-explanation-title { color: #B45309; }
        .print-metric-explanation .print-metric-explanation-title { color: #1565c0; }

        .print-metric-explanation-text {
            font-size: 9pt;
            line-height: 1.5;
            color: #333;
        }

        .print-metric-explanation-text strong {
            color: #1a1a2e;
        }

        /* Safety Buffer Chart Section */
        .print-safety-buffer-chart {
            margin: 24px 0;
            break-inside: avoid;
        }

        .print-safety-buffer-chart h4 {
            font-size: 11pt;
            font-weight: 600;
            color: #1B4B4B;
            margin-bottom: 8px;
        }

        .print-safety-buffer-chart p {
            font-size: 9pt;
            color: #666;
            margin-bottom: 12px;
        }

        /* Interpretation Footer */
        .print-interpretation {
            background: #f0f7f7;
            border-left: 4px solid #00796B;
            padding: 16px;
            border-radius: 0 6px 6px 0;
            margin-top: 20px;
        }

        .print-interpretation p {
            font-size: 10pt;
            color: #333;
            line-height: 1.6;
            margin: 0;
        }

        /* Comparison Section */
        .comparison-intro {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 24px;
        }

        .comparison-intro p {
            margin-bottom: 12px;
        }

        .comparison-intro ul {
            margin-left: 24px;
            line-height: 1.8;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        .strategy-box {
            border-radius: 8px;
            padding: 20px;
            break-inside: avoid;
        }

        .bbd-box {
            background: #e8f5e9;
            border: 2px solid #4caf50;
        }

        .sell-box {
            background: #e3f2fd;
            border: 2px solid #2196f3;
        }

        .strategy-box h3 {
            font-size: 13pt;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .bbd-box h3 {
            color: #2e7d32;
        }

        .sell-box h3 {
            color: #1565c0;
        }

        .metric-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .metric-item:last-child {
            border-bottom: none;
        }

        .metric-item .metric-label {
            font-size: 9pt;
            color: #666;
        }

        .metric-item .metric-value {
            font-size: 12pt;
            font-weight: 600;
        }

        .highlight-success { color: #2e7d32; }
        .highlight-warning { color: #f57c00; }
        .highlight-error { color: #c62828; }
        .highlight-primary { color: #1565c0; }

        .differential-summary {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 24px;
            break-inside: avoid;
        }

        .differential-summary h3 {
            font-size: 12pt;
            font-weight: 600;
            margin-bottom: 16px;
            color: #333;
        }

        .diff-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .diff-item {
            text-align: center;
        }

        .diff-label {
            display: block;
            font-size: 9pt;
            color: #666;
            margin-bottom: 6px;
        }

        .diff-value {
            font-size: 16pt;
            font-weight: 700;
        }

        .recommendation-box {
            background: #f0f7f7;
            border-left: 4px solid #00796B;
            padding: 20px;
            border-radius: 0 8px 8px 0;
            break-inside: avoid;
        }

        .recommendation-box h3 {
            font-size: 12pt;
            font-weight: 600;
            color: #1B4B4B;
            margin-bottom: 12px;
        }

        .recommendation-content {
            line-height: 1.7;
        }

        /* Page Break Controls */
        .page-break-before {
            break-before: page;
            page-break-before: always;
        }

        .page-break-after {
            break-after: page;
            page-break-after: always;
        }

        .no-break {
            break-inside: avoid;
            page-break-inside: avoid;
        }

        /* Year-by-Year Percentile Table Styles */
        .percentile-table-wrapper {
            overflow-x: auto;
            margin: 16px 0;
        }

        .percentile-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9pt;
            background: #ffffff;
        }

        .percentile-table thead tr:first-child th {
            background: linear-gradient(135deg, #1B4B4B 0%, #00796B 100%);
            color: #ffffff;
            font-weight: 600;
            padding: 10px 8px;
            text-align: center;
            border: 1px solid #00695C;
        }

        .percentile-table thead tr:nth-child(2) th {
            background: #E8F5E9;
            color: #1B4B4B;
            font-weight: 600;
            padding: 8px 6px;
            text-align: right;
            font-size: 8pt;
            border: 1px solid #C8E6C9;
        }

        .percentile-table thead th.withdrawal-group {
            background: linear-gradient(135deg, #1565C0 0%, #1976D2 100%);
            border-color: #1565C0;
        }

        .percentile-table thead th.networth-group {
            background: linear-gradient(135deg, #1B4B4B 0%, #00796B 100%);
        }

        .percentile-table tbody td {
            padding: 6px 8px;
            text-align: right;
            border: 1px solid #e0e0e0;
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            font-size: 8pt;
        }

        .percentile-table tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        .percentile-table tbody tr:hover {
            background: #E8F5E9;
        }

        .percentile-table td.year-col {
            font-weight: 600;
            text-align: center;
            background: #f5f5f5;
        }

        .percentile-table td.withdrawal-col {
            color: #1565C0;
        }

        .percentile-table td.p10 {
            color: #EF4444;
        }

        .percentile-table td.p25 {
            color: #F59E0B;
        }

        .percentile-table td.p50 {
            color: #1B4B4B;
            font-weight: 600;
            background: rgba(0, 121, 107, 0.05);
        }

        .percentile-table td.p75 {
            color: #22C55E;
        }

        .percentile-table td.p90 {
            color: #10B981;
        }

        .percentile-legend {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-top: 12px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 6px;
            font-size: 8pt;
            color: #666;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .p10-dot { background: #EF4444; }
        .p50-dot { background: #1B4B4B; }
        .p90-dot { background: #10B981; }

        .section-subtitle {
            font-size: 10pt;
            color: #666;
            margin: -8px 0 16px 0;
        }

        /* Footer */
        .report-footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            text-align: center;
            font-size: 9pt;
            color: #888;
        }

        /* Print Specific Styles */
        @media print {
            .percentile-table-wrapper {
                overflow: visible;
            }

            .percentile-table {
                break-inside: auto;
            }

            .percentile-table thead {
                display: table-header-group;
            }

            .percentile-table tbody tr {
                break-inside: avoid;
            }
            body {
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }

            @page {
                size: auto;
                margin: 15mm 12mm 15mm 12mm;
            }

            .report-container {
                max-width: 100%;
                padding: 0;
            }

            .charts-row {
                break-inside: avoid;
            }

            .mc-charts-grid {
                break-inside: avoid;
            }

            .mc-chart-card {
                break-inside: avoid;
                page-break-inside: avoid;
            }

            .print-section {
                break-inside: avoid;
            }

            .print-portfolio-section {
                break-inside: avoid;
            }

            .print-portfolio-section table {
                break-inside: avoid;
            }

            h1, h2, h3, h4 {
                break-after: avoid;
            }

            img {
                break-inside: avoid;
                max-width: 100% !important;
            }
        }

        /* Responsive for screen viewing */
        @media screen and (max-width: 768px) {
            .report-container {
                padding: 20px;
            }

            .charts-row {
                grid-template-columns: 1fr;
            }

            .mc-charts-grid {
                grid-template-columns: 1fr;
            }

            .comparison-grid {
                grid-template-columns: 1fr;
            }

            .diff-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .metrics-container .hero-metrics-row {
                grid-template-columns: 1fr;
            }

            .metrics-container .secondary-metrics-row {
                grid-template-columns: repeat(2, 1fr);
            }

            /* Print Portfolio Section - Mobile responsive */
            .print-portfolio-section > div:nth-child(2) {
                grid-template-columns: 1fr !important;
            }

            .print-portfolio-section > div:last-child > div:last-child {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            /* Liquidity Stress Dashboard - Mobile responsive */
            .print-stress-grid {
                grid-template-columns: 1fr;
            }

            .print-liquidity-metrics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Print Button -->
    <div class="print-button-container">
        <button class="print-btn" onclick="window.print()">
            <span class="material-icons">print</span>
        </button>
    </div>

    <div class="report-container">
        <!-- Header -->
        <header class="report-header">
            <h1 class="report-title">Portfolio Strategy Simulation Report</h1>
            <p class="report-subtitle">Tax-Efficient Retirement Planning with BBD Strategy & Monte Carlo Analysis</p>
            <p class="report-date">Generated on ${dateStr} at ${timeStr}</p>
        </header>

        <!-- Key Metrics / Portfolio Composition -->
        <div class="print-section">
            ${portfolioCompositionHTML}
        </div>

        ${stressTestingHTML}

        <!-- Salary Equivalent -->
        <div class="print-section">
            <div class="salary-section">
                <h3>Your Annual Withdrawal Tax-Free</h3>
                <div class="salary-amount">${salaryEquivalent}</div>
                <div class="salary-equivalent-text">Is equivalent to earning a taxable salary of:</div>
                <div class="taxable-amount">${taxableEquivalent}</div>
                <p class="tax-savings-text">${taxSavingsText}</p>
            </div>
        </div>

        ${executiveSummaryHTML}

        ${performanceSummaryHTML}

        ${strategyAnalysisHTML}

        ${monteCarloChartsHTML}

        ${yearByYearTableHTML}

        ${strategicRecommendationHTML}

        <!-- Footer -->
        <footer class="report-footer">
            <p>This report was generated by Portfolio Strategy Simulator</p>
            <p>The projections shown are based on Monte Carlo simulations and historical data. Past performance does not guarantee future results.</p>
        </footer>
    </div>
</body>
</html>
            `;
        }

        /**
         * Shows the print button after a simulation is completed.
         */
        function showPrintButton() {
            const printContainer = document.getElementById('printReportContainer');
            if (printContainer) {
                printContainer.style.display = 'flex';
            }
        }

        /**
         * Hides the print button.
         */
        function hidePrintButton() {
            const printContainer = document.getElementById('printReportContainer');
            if (printContainer) {
                printContainer.style.display = 'none';
            }
        }

        // ========================================
        // Back to Results Button Functionality
        // ========================================

        /**
         * Shows the "Back to Results" button when viewing welcome guide with existing results.
         * Only displays if simulation results exist in the DOM.
         */
        function showBackToResultsButton() {
            const backContainer = document.getElementById('backToResultsContainer');
            const resultsDiv = document.getElementById('results');

            // Only show if results exist (checking for populated key metrics as proxy)
            const keyMetrics = resultsDiv?.querySelector('#keyMetrics');
            const hasResults = keyMetrics && keyMetrics.children.length > 0;

            if (backContainer && hasResults) {
                backContainer.style.display = 'flex';
            }
        }

        /**
         * Hides the "Back to Results" button.
         */
        function hideBackToResultsButton() {
            const backContainer = document.getElementById('backToResultsContainer');
            if (backContainer) {
                backContainer.style.display = 'none';
            }
        }

        /**
         * Returns to results view and restores scroll position.
         * Manages visibility of all floating action buttons.
         */
        function returnToResults() {
            // Hide welcome guide, show results
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('results').style.display = 'block';

            // Hide back button, show TOC and Print buttons
            hideBackToResultsButton();
            showTOCButton();
            showPrintButton();

            // Restore scroll position from sessionStorage
            const savedScrollPos = sessionStorage.getItem('resultsScrollPosition');
            if (savedScrollPos !== null) {
                const mainContent = document.querySelector('.main-content');
                if (mainContent) {
                    // Parse and apply saved scroll position
                    mainContent.scrollTop = parseInt(savedScrollPos, 10);
                }
            }
        }
    </script>

    <!-- Monte Carlo Progress Overlay -->
    <div id="monteCarloProgressOverlay" class="monte-carlo-overlay hidden">
        <div class="progress-card">
            <div class="text-center">
                <span class="material-icons progress-icon">scatter_plot</span>
                <h2 class="progress-title">Running Monte Carlo Simulation</h2>
                <p class="progress-subtitle">
                    Calculating probability distributions across thousands of scenarios...
                </p>
                <div id="returnModelBadge" style="display: inline-block; margin-top: 12px; padding: 8px 16px; border-radius: 5px; font-size: 13px; font-weight: 600; letter-spacing: 0.3px;"></div>
            </div>

            <div class="progress-bar-container">
                <div id="progressBarFill" class="progress-bar-fill" style="width: 0%;"></div>
            </div>

            <div class="progress-stats">
                <span id="progressPercentage" class="progress-percentage">0%</span>
                <span id="progressCounter" class="progress-counter">0 / 5,000</span>
            </div>

            <div id="progressStatusMessage" class="progress-status-message">
                Exploring parallel universes...
            </div>
        </div>
    </div>

    <!-- TOC Navigation -->
    <button id="tocToggle" class="toc-toggle" onclick="toggleTOC()" aria-label="Toggle table of contents">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <line x1="6" y1="12" x2="18" y2="12"></line>
            <line x1="12" y1="6" x2="12" y2="18"></line>
        </svg>
    </button>

    <nav id="tocNav" class="toc-nav" aria-label="Table of contents">
        <div class="toc-header">Contents</div>
        <ul class="toc-nav-list">
            <li><a href="#results" class="toc-nav-item" data-section="results">
                <span class="toc-nav-icon"></span>
                <span class="toc-nav-label">Overview</span>
            </a></li>
            <li><a href="#section-monte-carlo-results" class="toc-nav-item" data-section="recommendations">
                <span class="toc-nav-icon"></span>
                <span class="toc-nav-label">Recommendations</span>
            </a></li>
            <li><a href="#monteCarloChartsSection" class="toc-nav-item" data-section="monte-carlo">
                <span class="toc-nav-icon"></span>
                <span class="toc-nav-label">Charts</span>
            </a></li>
            <!-- Hidden: Stress Testing section
            <li><a href="#section-stress-testing" class="toc-nav-item" data-section="stress-testing">
                <span class="toc-nav-icon"></span>
                <span class="toc-nav-label">Stress Testing</span>
            </a></li>
            -->
            <li><a href="#section-salary-equivalent" class="toc-nav-item" data-section="salary-equivalent">
                <span class="toc-nav-icon"></span>
                <span class="toc-nav-label">Salary Equivalent</span>
            </a></li>
            <li><a href="#strategyAnalysisSection" class="toc-nav-item" data-section="strategy-analysis">
                <span class="toc-nav-icon"></span>
                <span class="toc-nav-label">Strategy Analysis</span>
            </a></li>
        </ul>
    </nav>

    <!-- Back to Results Button -->
    <div class="back-to-results-container" id="backToResultsContainer" style="display: none;">
        <button class="back-to-results-btn" id="backToResultsBtn" onclick="returnToResults()"
                title="Back to Results" aria-label="Return to simulation results">
            <span class="material-icons">arrow_back</span>
            <span class="back-to-results-label">Back to Results</span>
        </button>
    </div>
</body>
</html>