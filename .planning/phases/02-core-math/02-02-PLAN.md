---
phase: 02-core-math
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified: [src/math/correlation.ts, src/math/distributions.ts, src/math/index.ts]
autonomous: true

must_haves:
  truths:
    - "Cholesky decomposition produces valid L where L*L^T approximates input matrix"
    - "Pearson correlation calculation produces values in [-1, 1] range"
    - "Normal distribution samples have approximately correct mean and stddev"
    - "Correlated samples preserve input correlation structure"
  artifacts:
    - path: "src/math/correlation.ts"
      provides: "Correlation calculation and Cholesky decomposition"
      exports: ["pearsonCorrelation", "correlationMatrix", "choleskyDecomposition"]
    - path: "src/math/distributions.ts"
      provides: "Random number generation"
      exports: ["normalRandom", "lognormalRandom", "correlatedSamples"]
    - path: "src/math/index.ts"
      provides: "Math module barrel export"
  key_links:
    - from: "correlation.ts"
      to: "statistics.ts"
      via: "imports mean, stddev for correlation calculation"
      pattern: "import.*from.*statistics"
    - from: "distributions.ts"
      to: "correlation.ts"
      via: "imports choleskyDecomposition for correlated samples"
      pattern: "import.*choleskyDecomposition"
    - from: "distributions.ts"
      to: "precision.ts"
      via: "imports utilities"
---

<objective>
Implement correlation calculation, Cholesky decomposition, and distribution sampling for correlated asset returns.

Purpose: Enable correlation-aware multi-asset return generation (requirement SIM-07) and Pearson correlation calculation (requirement CALC-06).
Output: Correlation functions (pearsonCorrelation, correlationMatrix, choleskyDecomposition) and distribution sampling (normalRandom, lognormalRandom, correlatedSamples).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-math/02-01-PLAN.md

@src/types/portfolio.ts
@src/types/simulation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create correlation functions</name>
  <files>src/math/correlation.ts</files>
  <action>
Create correlation calculation and Cholesky decomposition:

**pearsonCorrelation(x: number[], y: number[]): number**
- Formula: Σ((xi - x̄)(yi - ȳ)) / (n * σx * σy)
- Import mean and stddev from statistics.ts
- Return NaN if arrays have different lengths or length < 2
- Clamp result to [-1, 1] to handle floating point edge cases

**correlationMatrix(assetReturns: number[][]): number[][]**
- Input: Array of return arrays, one per asset
- Output: n×n symmetric correlation matrix
- Diagonal is always 1.0
- Use pearsonCorrelation for each pair
- Return type matches CorrelationMatrix.matrix from types/portfolio.ts

**choleskyDecomposition(matrix: number[][]): number[][] | null**
- Input: Symmetric positive-definite correlation matrix
- Output: Lower triangular matrix L where L*L^T = input
- Return null if matrix is not positive-definite (negative sqrt encountered)
- Algorithm:
  ```
  for j = 0 to n-1:
    for i = j to n-1:
      sum = matrix[i][j]
      for k = 0 to j-1:
        sum -= L[i][k] * L[j][k]
      if i == j:
        if sum <= 0: return null  // not positive-definite
        L[i][j] = sqrt(sum)
      else:
        L[i][j] = sum / L[j][j]
  ```

**Why Cholesky:** Used to generate correlated random samples. Given uncorrelated standard normal samples Z, correlated samples are Y = L*Z where L is Cholesky factor.

**Use precision utilities** from precision.ts for comparisons and output rounding.
  </action>
  <verify>npm run build succeeds with no TypeScript errors</verify>
  <done>Correlation functions compile and export correctly</done>
</task>

<task type="auto">
  <name>Task 2: Create distribution sampling functions</name>
  <files>src/math/distributions.ts</files>
  <action>
Create random number generators for Monte Carlo simulation:

**normalRandom(mean?: number, stddev?: number): number**
- Default mean=0, stddev=1 (standard normal)
- Use Box-Muller transform:
  ```
  u1 = Math.random()
  u2 = Math.random()
  z = sqrt(-2 * ln(u1)) * cos(2π * u2)
  return mean + z * stddev
  ```
- Box-Muller produces two independent samples; can cache second one for efficiency but simpler to just generate fresh each call

**lognormalRandom(mu?: number, sigma?: number): number**
- Default mu=0, sigma=1
- Formula: exp(normalRandom(mu, sigma))
- Always returns positive values
- mu and sigma are parameters of the underlying normal distribution

**correlatedSamples(n: number, correlationMatrix: number[][]): number[][]**
- Generate n sets of correlated standard normal samples
- Import choleskyDecomposition from correlation.ts
- Algorithm:
  1. Compute L = choleskyDecomposition(correlationMatrix)
  2. If L is null, throw error (invalid correlation matrix)
  3. For each of n samples:
     a. Generate k independent standard normals (k = matrix size)
     b. Multiply: correlated = L * uncorrelated (matrix-vector multiplication)
  4. Return array of n correlated sample vectors

**Return type:** number[][] where outer array is samples, inner is assets
Example: correlatedSamples(1000, corrMatrix) returns 1000 samples for each asset
  </action>
  <verify>npm run build succeeds with no TypeScript errors</verify>
  <done>Distribution functions compile and export correctly</done>
</task>

<task type="auto">
  <name>Task 3: Create math module barrel export</name>
  <files>src/math/index.ts</files>
  <action>
Create barrel export for all math functions:

```typescript
// Precision utilities
export { sum, round, almostEqual, EPSILON } from './precision';

// Statistical functions
export { mean, variance, stddev, percentile } from './statistics';

// Correlation functions
export { pearsonCorrelation, correlationMatrix, choleskyDecomposition } from './correlation';

// Distribution functions
export { normalRandom, lognormalRandom, correlatedSamples } from './distributions';
```

This allows clean imports: `import { mean, correlatedSamples } from '@/math'` or `import { mean, correlatedSamples } from '../math'`

Verify all exports compile by running build.
  </action>
  <verify>npm run build succeeds, all exports accessible</verify>
  <done>Math module fully exportable from single entry point</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `tsc --noEmit` passes
- [ ] All functions export from src/math/index.ts
- [ ] Correlation matrix produces symmetric results
- [ ] Cholesky handles positive-definite matrices
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Requirements SIM-07 and CALC-06 foundations complete
- Ready for Phase 3 simulation engine
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-math/02-02-SUMMARY.md`
</output>
