---
phase: 02-core-math
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/math/statistics.ts, src/math/precision.ts, src/types/math.ts]
autonomous: true

must_haves:
  truths:
    - "Mean calculation matches simple-statistics library"
    - "Standard deviation calculation uses N-1 denominator (sample)"
    - "Percentile calculation handles edge cases (empty array, single value)"
    - "Precision utilities prevent floating point accumulation errors"
  artifacts:
    - path: "src/math/statistics.ts"
      provides: "Core statistical functions"
      exports: ["mean", "variance", "stddev", "percentile", "sum"]
    - path: "src/math/precision.ts"
      provides: "Decimal precision handling"
      exports: ["round", "EPSILON", "almostEqual"]
    - path: "src/types/math.ts"
      provides: "Math type definitions"
  key_links:
    - from: "statistics.ts"
      to: "precision.ts"
      via: "imports round for output precision"
      pattern: "import.*from.*precision"
---

<objective>
Implement core statistical functions and precision utilities for Monte Carlo simulation.

Purpose: Provide accurate, tested statistical primitives that form the foundation for correlation calculations and simulation engine.
Output: Statistical functions (mean, variance, stddev, percentile, sum) and precision utilities (round, almostEqual, EPSILON).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-02-SUMMARY.md

@src/types/index.ts
@src/types/simulation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create precision utilities</name>
  <files>src/math/precision.ts</files>
  <action>
Create precision handling utilities for financial calculations:

1. Define EPSILON constant (1e-10) for floating point comparisons
2. Create `round(value: number, decimals: number): number` - round to specified decimal places using Math.round with power of 10 multiplier
3. Create `almostEqual(a: number, b: number, epsilon?: number): boolean` - compare floats within epsilon tolerance
4. Create `sum(values: number[]): number` - Kahan summation algorithm to minimize floating point accumulation errors

**Why Kahan summation:** Standard JS array.reduce accumulates floating point errors over thousands of iterations (30+ years Ã— 1000+ simulations). Kahan's compensated summation algorithm maintains precision by tracking lost bits.

**Implementation notes:**
- Export all functions as named exports
- Use strict TypeScript types
- No external dependencies (pure functions)
  </action>
  <verify>npm run build succeeds with no TypeScript errors</verify>
  <done>Precision utilities compile and are ready for use by statistics module</done>
</task>

<task type="auto">
  <name>Task 2: Create statistical functions</name>
  <files>src/math/statistics.ts, src/types/math.ts</files>
  <action>
Create core statistical functions:

1. First create `src/types/math.ts` with:
   - `StatisticalResult` interface (value: number, sampleSize: number)

2. Then create `src/math/statistics.ts`:

**mean(values: number[]): number**
- Return 0 for empty array
- Use Kahan sum from precision.ts divided by length

**variance(values: number[], population?: boolean): number**
- Default to sample variance (N-1 denominator)
- If population=true, use N denominator
- Return 0 for array length < 2 when sample variance

**stddev(values: number[], population?: boolean): number**
- Square root of variance
- Pass population flag through

**percentile(values: number[], p: number): number**
- p is 0-100 (not 0-1)
- Handle edge cases: empty array returns 0, single value returns that value
- Use linear interpolation between floor and ceil indices
- Formula: index = (p/100) * (n-1), interpolate between sorted[floor] and sorted[ceil]

**Import and use:**
- Import `sum` from precision.ts for mean calculation
- Import `round` for output precision (6 decimal places default)

**Important:** These match simple-statistics library behavior for validation purposes.
  </action>
  <verify>npm run build succeeds, tsc --noEmit passes</verify>
  <done>All statistical functions compile and export correctly</done>
</task>

<task type="auto">
  <name>Task 3: Update types index and verify exports</name>
  <files>src/types/index.ts</files>
  <action>
Add math types to the types index:

1. Add `export * from './math';` to src/types/index.ts
2. Verify all exports are accessible by importing in a test check

Run `npm run build` to verify the entire module structure compiles correctly.
  </action>
  <verify>npm run build succeeds, all exports are accessible</verify>
  <done>Math types integrated into type system</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `tsc --noEmit` passes
- [ ] All functions export correctly from src/math/statistics.ts
- [ ] All functions export correctly from src/math/precision.ts
- [ ] Types export from src/types/index.ts
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Statistical functions ready for use by correlation module
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-math/02-01-SUMMARY.md`
</output>
