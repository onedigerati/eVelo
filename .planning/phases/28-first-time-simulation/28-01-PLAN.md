---
phase: 28-first-time-simulation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/app-root.ts
  - src/components/ui/portfolio-composition.ts
autonomous: true

must_haves:
  truths:
    - "First-time users see choice modal when clicking 'Run Your First Simulation'"
    - "'Run Demo (60/40)' button loads SPY 60% / AGG 40% portfolio and runs simulation"
    - "'Create My Portfolio' button hides welcome screen and highlights portfolio section"
    - "Cancel button returns to welcome screen without side effects"
    - "Demo simulation shows toast notification explaining what was loaded"
  artifacts:
    - path: "src/components/app-root.ts"
      provides: "Choice modal flow for first-time simulation"
      contains: "Run Demo (60/40)"
    - path: "src/components/ui/portfolio-composition.ts"
      provides: "setWeights public method for programmatic portfolio setup"
      exports: "setWeights"
  key_links:
    - from: "src/components/app-root.ts"
      to: "modal-dialog"
      via: "show() method with type: 'choice'"
      pattern: "type:\\s*['\"]choice['\"]"
    - from: "src/components/app-root.ts"
      to: "portfolio-composition"
      via: "setWeights() method call"
      pattern: "setWeights\\("
---

<objective>
Implement choice-based modal dialog for first-time simulation experience.

Purpose: When first-time users click "Run Your First Simulation" on the welcome screen, they see a clear choice: run an instant demo with a 60/40 portfolio, or create their own custom portfolio first. This reduces confusion and provides value quickly.

Output: Modified app-root.ts with choice modal flow, portfolio-composition.ts with setWeights() public method.
</objective>

<execution_context>
@C:\Users\ungac\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ungac\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-first-time-simulation-experience/28-RESEARCH.md
@src/components/app-root.ts
@src/components/ui/portfolio-composition.ts
@src/components/ui/modal-dialog.ts
@src/components/ui/welcome-screen.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add setWeights() public method to portfolio-composition.ts</name>
  <files>src/components/ui/portfolio-composition.ts</files>
  <action>
Add a public `setWeights(weights: Record<string, number>)` method to the PortfolioComposition class that:

1. Clears existing selectedAssets array
2. For each symbol in the weights object:
   - Find the asset in availableAssets
   - If found, add to selectedAssets with the specified weight
   - Assign colors from ASSET_COLORS palette
3. Call renderAvailableAssets() and renderSelectedAssets()
4. Call markDirty() and dispatchPortfolioChange()

Add this method near the existing getWeights() method (around line 2058). Follow the existing patterns:

```typescript
/**
 * Set portfolio weights programmatically
 * @param weights - Record of symbol to weight (0-100 scale)
 */
public setWeights(weights: Record<string, number>): void {
  // Clear existing selection
  this.selectedAssets = [];

  // Add each asset with its weight
  for (const [symbol, weight] of Object.entries(weights)) {
    const asset = this.availableAssets.find(a => a.symbol === symbol);
    if (!asset) {
      console.warn(`Asset ${symbol} not found in available assets`);
      continue;
    }

    // Assign color
    const usedColors = new Set(this.selectedAssets.map(a => a.color));
    let color = asset.color;
    for (const c of ASSET_COLORS) {
      if (!usedColors.has(c)) {
        color = c;
        break;
      }
    }

    this.selectedAssets.push({
      ...asset,
      color,
      weight,
    });
  }

  this.renderAvailableAssets();
  this.renderSelectedAssets();
  this.markDirty();
  this.dispatchPortfolioChange();
}
```

Ensure the method is exported (public visibility).
  </action>
  <verify>TypeScript compiles without errors: `npm run build`</verify>
  <done>portfolio-composition.ts has public setWeights() method that clears and sets portfolio weights programmatically</done>
</task>

<task type="auto">
  <name>Task 2: Implement choice modal flow in app-root.ts quick-start handler</name>
  <files>src/components/app-root.ts</files>
  <action>
Modify the `'quick-start'` event listener in app-root.ts (around line 1452) to:

1. Show a choice modal instead of immediately triggering simulation
2. Handle three outcomes: 'alternate' (run demo), 'confirm' (create portfolio), 'cancel' (stay on welcome)

Replace the existing quick-start listener:

```typescript
// Quick-start: show choice modal for first-time users
this.addEventListener('quick-start', async () => {
  const modal = this.$('#app-modal') as any;

  const result = await modal.show({
    title: 'Run Your First Simulation',
    subtitle: 'Choose how to get started with the Buy-Borrow-Die strategy simulator:',
    type: 'choice',
    confirmText: 'Create My Portfolio',
    alternateText: 'Run Demo (60/40)',
    cancelText: 'Cancel'
  });

  if (result === 'alternate') {
    // Run demo with 60/40 SPY/AGG portfolio
    this.loadDemoPortfolio();
    // Hide welcome and trigger simulation
    welcome?.classList.add('hidden');
    runBtn?.click();
  } else if (result === 'confirm') {
    // Open custom portfolio setup
    welcome?.classList.add('hidden');
    this.highlightPortfolioSection();
  }
  // result === 'cancel' - stay on welcome screen (do nothing)
});
```

Add two helper methods to the AppRoot class:

```typescript
/**
 * Load demo portfolio: 60% SPY, 40% AGG
 */
private loadDemoPortfolio(): void {
  const portfolioComp = this.$('#portfolio-composition') as (PortfolioComposition & {
    setWeights(weights: Record<string, number>): void;
  }) | null;

  if (portfolioComp) {
    portfolioComp.setWeights({
      SPY: 60,
      AGG: 40
    });
  }

  // Show toast explaining what was loaded
  const toastContainer = this.$('toast-container') as any;
  toastContainer?.show(
    'Running demo with 60/40 portfolio (S&P 500 / US Bonds)',
    'info'
  );
}

/**
 * Highlight portfolio section for custom setup
 */
private highlightPortfolioSection(): void {
  const portfolioComp = this.$('#portfolio-composition') as HTMLElement | null;

  if (portfolioComp) {
    // Scroll to portfolio section
    portfolioComp.scrollIntoView({ behavior: 'smooth', block: 'start' });

    // Add temporary highlight animation
    portfolioComp.classList.add('highlight-pulse');
    setTimeout(() => {
      portfolioComp.classList.remove('highlight-pulse');
    }, 2000);
  }

  // Show toast with guidance
  const toastContainer = this.$('toast-container') as any;
  toastContainer?.show(
    'Add assets to build your portfolio, then run simulation',
    'info'
  );
}
```

Add CSS for the highlight-pulse animation in the styles() method:

```css
/* Highlight pulse animation for portfolio section guidance */
@keyframes highlight-pulse {
  0%, 100% {
    box-shadow: none;
  }
  50% {
    box-shadow: 0 0 0 4px rgba(13, 148, 136, 0.4);
  }
}

portfolio-composition.highlight-pulse {
  animation: highlight-pulse 1s ease-in-out 2;
  border-radius: var(--border-radius-md, 8px);
}
```
  </action>
  <verify>
1. `npm run build` compiles without errors
2. Start dev server: `npm run dev`
3. Open http://localhost:5173 in browser
4. Click "Run Your First Simulation" on welcome screen
5. Verify choice modal appears with three buttons: Cancel, Run Demo (60/40), Create My Portfolio
6. Click "Run Demo (60/40)" - verify toast shows, simulation runs with 60/40 portfolio
7. Refresh page, click "Run Your First Simulation", click "Create My Portfolio" - verify welcome hides, portfolio section highlights
8. Refresh page, click "Run Your First Simulation", click "Cancel" - verify returns to welcome screen
  </verify>
  <done>Choice modal appears on first simulation, offering demo run or custom portfolio setup</done>
</task>

<task type="auto">
  <name>Task 3: Ensure keyboard accessibility and mobile-friendly behavior</name>
  <files>src/components/app-root.ts</files>
  <action>
Verify and enhance accessibility of the choice modal flow:

1. The modal-dialog.ts already handles keyboard (Enter to confirm, Escape to cancel) - no changes needed there

2. In app-root.ts, ensure the highlightPortfolioSection method works on mobile:
   - The scrollIntoView behavior is already 'smooth' which works on mobile
   - Add a small delay before scroll on mobile to allow welcome screen hide animation

Update highlightPortfolioSection to be more robust:

```typescript
/**
 * Highlight portfolio section for custom setup
 */
private highlightPortfolioSection(): void {
  // Small delay to allow welcome screen to hide
  setTimeout(() => {
    const portfolioComp = this.$('#portfolio-composition') as HTMLElement | null;

    if (portfolioComp) {
      // Scroll to portfolio section (in sidebar on desktop, or visible area on mobile)
      portfolioComp.scrollIntoView({ behavior: 'smooth', block: 'start' });

      // Add temporary highlight animation
      portfolioComp.classList.add('highlight-pulse');
      setTimeout(() => {
        portfolioComp.classList.remove('highlight-pulse');
      }, 2000);
    }

    // Show toast with guidance
    const toastContainer = this.$('toast-container') as any;
    toastContainer?.show(
      'Add assets to build your portfolio, then run simulation',
      'info'
    );
  }, 100);
}
```

3. Test that the highlight-pulse animation respects reduced motion preference:

Add to styles():

```css
/* Respect reduced motion preference */
@media (prefers-reduced-motion: reduce) {
  portfolio-composition.highlight-pulse {
    animation: none;
    box-shadow: 0 0 0 4px rgba(13, 148, 136, 0.4);
  }
}
```
  </action>
  <verify>
1. `npm run build` compiles without errors
2. Test with keyboard only: Tab to "Run Your First Simulation", Enter to activate, Tab through modal buttons, Enter to select
3. Test with browser DevTools in mobile viewport (375x667): click "Create My Portfolio", verify scroll and highlight work
4. Test with DevTools "Emulate prefers-reduced-motion: reduce": verify animation is replaced with static highlight
  </verify>
  <done>Choice modal is keyboard accessible and works correctly on mobile devices</done>
</task>

</tasks>

<verification>
1. Build succeeds: `npm run build`
2. First-time user flow works:
   - Welcome screen shows choice modal on "Run Your First Simulation" click
   - "Run Demo (60/40)" loads portfolio, runs simulation, shows results
   - "Create My Portfolio" hides welcome, scrolls to and highlights portfolio section
   - "Cancel" returns to welcome screen with no changes
3. Mobile: Modal displays correctly, buttons are touch-friendly, scroll behavior works
4. Keyboard: Full flow navigable with Tab and Enter keys
5. Dark theme: Modal and highlights render correctly in dark mode
</verification>

<success_criteria>
- [ ] portfolio-composition.ts has setWeights() public method
- [ ] app-root.ts shows choice modal on 'quick-start' event
- [ ] "Run Demo (60/40)" loads 60% SPY / 40% AGG and runs simulation
- [ ] "Create My Portfolio" hides welcome and highlights portfolio section
- [ ] "Cancel" returns to welcome screen
- [ ] Toast notifications explain what's happening
- [ ] Works on mobile with touch-friendly buttons
- [ ] Keyboard accessible
- [ ] Build compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/28-first-time-simulation/28-01-SUMMARY.md`
</output>
