---
phase: 29-print-optimized-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["29-01"]
files_modified:
  - src/components/app-root.ts
autonomous: false

must_haves:
  truths:
    - "Clicking print icon opens a new browser window with print-optimized content"
    - "Print window contains key metrics, parameter summary, and chart images"
    - "Charts render correctly as static images in print window"
    - "Print window has a Print button that triggers browser print dialog"
    - "Print layout uses light theme regardless of app theme setting"
    - "Mobile users can access print feature"
    - "Print icon is keyboard accessible"
  artifacts:
    - path: "src/components/app-root.ts"
      provides: "Complete print button click handler wiring"
      contains: "openPrintWindow"
  key_links:
    - from: "src/components/app-root.ts"
      to: "src/utils/print-utils.ts"
      via: "import and function calls"
      pattern: "import.*print-utils"
    - from: "src/components/app-root.ts"
      to: "results-dashboard shadowRoot"
      via: "extractAllChartImages with dashboard.shadowRoot"
      pattern: "extractAllChartImages.*shadowRoot"
---

<objective>
Wire the print button to extract dashboard data and open a print-friendly preview window.

Purpose: Complete the print feature by connecting the UI button to the utility functions, enabling users to generate and print simulation reports.

Output: Fully functional print workflow - click print icon, new window opens with formatted report, Print button triggers browser print dialog.
</objective>

<execution_context>
@C:\Users\ungac\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ungac\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/29-print-optimized-dashboard/29-RESEARCH.md
@.planning/phases/29-print-optimized-dashboard/29-01-SUMMARY.md
@src/components/app-root.ts
@src/utils/print-utils.ts
@src/components/ui/results-dashboard.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire print button click handler with dashboard data extraction</name>
  <files>src/components/app-root.ts</files>
  <action>
Complete the print button wiring in app-root.ts:

1. **Add import at top of file**
```typescript
import { extractAllChartImages, generatePrintHtml, openPrintWindow, PrintableData } from '../utils/print-utils';
```

2. **Replace placeholder click handler with full implementation**

In the afterRender() method, find the print button click handler and replace with:

```typescript
const printBtn = this.$('#btn-print');
printBtn?.addEventListener('click', () => {
  // Get results dashboard element
  const dashboard = this.$('#results') as any;
  if (!dashboard || !this._simulationResult) {
    const toastContainer = this.$('toast-container') as any;
    toastContainer?.show('No simulation results to print', 'warning');
    return;
  }

  // Access the inner results-dashboard through comparison-dashboard
  // comparison-dashboard wraps results-dashboard internally
  const resultsDashboard = dashboard.shadowRoot?.querySelector('results-dashboard');
  const dashboardShadowRoot = resultsDashboard?.shadowRoot;

  if (!dashboardShadowRoot) {
    console.error('Could not access results dashboard shadow root');
    const toastContainer = this.$('toast-container') as any;
    toastContainer?.show('Could not access dashboard for printing', 'error');
    return;
  }

  // Extract chart images from dashboard
  const chartImages = extractAllChartImages(dashboardShadowRoot);

  // Collect metrics from simulation result
  const stats = this._simulationResult.statistics;
  const config = this._simulationConfig || this.collectSimulationParams().config;

  // Build printable data
  const printData: PrintableData = {
    keyMetrics: {
      initialValue: config.initialValue,
      terminalValue: stats.median,
      successRate: stats.successRate,
      cagr: this.calculateCAGRFromResult(),
      withdrawalRate: config.sbloc?.annualWithdrawal || 0
    },
    paramSummary: {
      timeHorizon: config.timeHorizon,
      iterations: config.iterations,
      inflationRate: config.inflationRate,
      sblocRate: config.sbloc?.interestRate || 0,
      maxLtv: config.sbloc?.targetLTV || 0
    },
    chartImages,
    timestamp: new Date().toLocaleString()
  };

  // Generate and open print window
  const htmlContent = generatePrintHtml(printData);
  const printWindow = openPrintWindow(htmlContent);

  if (printWindow) {
    const toastContainer = this.$('toast-container') as any;
    toastContainer?.show('Print preview opened in new window', 'info');
  }
});
```

3. **Add helper method for CAGR calculation**

Add this private method to AppRoot class:

```typescript
/**
 * Calculate CAGR from current simulation result
 */
private calculateCAGRFromResult(): number {
  if (!this._simulationResult) return 0;

  const { config } = this.collectSimulationParams();
  const initialValue = config.initialValue;
  const terminalValue = this._simulationResult.statistics.median;
  const years = config.timeHorizon;

  if (initialValue <= 0 || terminalValue <= 0 || years <= 0) return 0;

  return Math.pow(terminalValue / initialValue, 1 / years) - 1;
}
```

4. **Store simulation config on successful run**

In the existing simulation run success handler (after `this._simulationResult = result;`), add:

```typescript
// Store config for print feature
this._simulationConfig = config;
```

And add the private field at the top of the class:

```typescript
/** Stored simulation config for print feature */
private _simulationConfig: SimulationConfig | null = null;
```

Note: The field may already exist as it's used for param-summary. If so, just ensure it's being set.

5. **Import SimulationConfig type if not already imported**

Ensure the SimulationConfig type is imported at the top of the file.
  </action>
  <verify>
`npm run build` succeeds without TypeScript errors
Run a simulation, click print button - new window opens with report
Console shows no errors during print workflow
  </verify>
  <done>
Print button click extracts chart images from dashboard, generates HTML, opens print window with formatted report
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete print feature: print icon in header (conditional), click opens print-friendly window with:
- eVelo branding and timestamp
- Key metrics summary (initial value, terminal value, success rate, CAGR, withdrawal)
- Parameter summary (time horizon, iterations, inflation, SBLOC rate, max LTV)
- Chart images (probability cone, histogram, SBLOC charts)
- Print and Close buttons in top-right corner
- Light theme colors (even when app is in dark mode)
  </what-built>
  <how-to-verify>
1. **Initial state check:**
   - Load the app fresh (or refresh page)
   - Confirm print icon is NOT visible in header (no simulation yet)

2. **Run a simulation:**
   - Use default or demo portfolio
   - Click "Run Monte Carlo Simulation"
   - After completion, confirm print icon APPEARS in header (printer icon)

3. **Test print workflow:**
   - Click the print icon
   - New browser window should open with "eVelo Simulation Report"
   - Verify content includes:
     - Header with "eVelo Simulation Report" title
     - Timestamp showing current date/time
     - Key Metrics section with values from simulation
     - Parameter Summary section
     - Chart images (probability cone, histogram, any SBLOC charts if applicable)
   - Print and Close buttons should be visible at top-right

4. **Test Print button:**
   - Click "Print Report" button in print window
   - Browser print dialog should open
   - Cancel the print (don't actually print)

5. **Test Close button:**
   - Click "Close" button
   - Print window should close

6. **Test light theme forcing:**
   - If app is in dark mode, verify print window still uses light theme
   - Background should be white, text should be dark

7. **Test mobile access:**
   - If possible, test on mobile device or use browser dev tools mobile view
   - Print icon should be accessible and clickable
   - Print window should open (may vary by mobile browser)

8. **Test keyboard accessibility:**
   - Use Tab to navigate to print icon
   - Press Enter - should trigger print workflow
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Print icon hidden before first simulation
3. Print icon appears after simulation completes
4. Click print icon opens new window with formatted report
5. Report contains key metrics, parameters, and chart images
6. Print button in report triggers browser print dialog
7. Close button closes the print window
8. Report uses light theme colors regardless of app theme
9. Feature works on mobile viewports
10. Print icon accessible via keyboard navigation
</verification>

<success_criteria>
- Complete print workflow functional end-to-end
- Report contains all dashboard visualizations as images
- Print dialog accessible from report window
- Light theme forced for print-friendly output
- No JavaScript errors in console during workflow
- Accessible with keyboard
</success_criteria>

<output>
After completion, create `.planning/phases/29-print-optimized-dashboard/29-02-SUMMARY.md`
</output>
