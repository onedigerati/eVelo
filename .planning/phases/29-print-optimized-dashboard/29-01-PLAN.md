---
phase: 29-print-optimized-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/utils/print-utils.ts
  - src/components/app-root.ts
autonomous: true

must_haves:
  truths:
    - "Print utility functions exist for chart image extraction"
    - "Print utility functions exist for generating print window HTML"
    - "Print icon appears in header only when simulation results exist"
    - "Print icon styling matches existing header icons"
  artifacts:
    - path: "src/utils/print-utils.ts"
      provides: "Chart image extraction and print window generation utilities"
      exports: ["extractChartImages", "generatePrintHtml", "openPrintWindow"]
      min_lines: 150
    - path: "src/components/app-root.ts"
      provides: "Print button in header with conditional visibility"
      contains: "btn-print"
  key_links:
    - from: "src/utils/print-utils.ts"
      to: "Chart.js toBase64Image API"
      via: "chart.toBase64Image() method call"
      pattern: "toBase64Image"
    - from: "src/components/app-root.ts"
      to: "simulation-complete event"
      via: "event listener shows print button"
      pattern: "simulation-complete.*btn-print"
---

<objective>
Create print infrastructure: utility functions for chart image extraction and HTML generation, plus add a conditional print icon to the header.

Purpose: This plan establishes the foundation for the print feature - the utilities needed to convert dashboard content to printable format, and the UI element to trigger printing.

Output: print-utils.ts with all helper functions, and print button visible in header after simulation runs.
</objective>

<execution_context>
@C:\Users\ungac\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ungac\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/29-print-optimized-dashboard/29-RESEARCH.md
@src/components/app-root.ts
@src/charts/base-chart.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create print utility functions</name>
  <files>src/utils/print-utils.ts</files>
  <action>
Create a new utility module for print-related functions:

1. **extractChartImage(shadowRoot, selector): string | null**
   - Navigate shadow DOM to find chart component by selector
   - Access the Chart.js instance via `(element as any).chart`
   - Call `chart.toBase64Image('image/png', 1.0)` to export
   - Return the data URL or null if not found

2. **extractAllChartImages(dashboard): ChartImages**
   - Interface `ChartImages` with optional string fields: probabilityCone, histogram, sblocBalance, marginCall, bbdComparison, comparisonLine, cumulativeCosts, terminalComparison, sblocUtilization
   - Call extractChartImage for each chart selector:
    - `#cone-chart` for probabilityCone
    - `#histogram-chart` for histogram
    - `#sbloc-balance-chart` for sblocBalance
    - `#margin-call-chart` for marginCall
    - `#bbd-comparison-chart` for bbdComparison
    - `#comparison-line-chart` for comparisonLine
    - `#cumulative-costs-chart` for cumulativeCosts
    - `#terminal-comparison-chart` for terminalComparison
    - `#sbloc-utilization-chart` for sblocUtilization

3. **extractTableHtml(shadowRoot, selector): string**
   - Find table element in shadow DOM
   - Clone it and return outerHTML
   - Handle case where table not found (return empty string)

4. **generatePrintHtml(data: PrintableData): string**
   - Interface `PrintableData` with:
    - keyMetrics: { initialValue, terminalValue, successRate, cagr, withdrawalRate }
    - paramSummary: { timeHorizon, iterations, inflationRate, sblocRate, maxLtv }
    - chartImages: ChartImages
    - timestamp: string
   - Generate complete HTML document with:
    - DOCTYPE, html, head with title "eVelo Simulation Report"
    - Inline CSS with light theme colors (always light for print)
    - Header with eVelo branding and timestamp
    - Sections with break-inside: avoid for page breaks
    - Print action buttons (Print, Close) hidden via @media print
    - Key metrics summary section
    - Parameter summary section
    - Chart images wrapped in .section elements
    - @page rule for letter portrait with 0.75in margins

5. **openPrintWindow(htmlContent: string): Window | null**
   - Call window.open('', '_blank', 'width=900,height=700')
   - If null, show alert about popup blocker
   - Write htmlContent using printWindow.document.write()
   - Call printWindow.document.close()
   - Return the window reference

Export all functions and interfaces from the module.

Use the research code examples as reference but adapt to actual chart selectors in results-dashboard.ts.
  </action>
  <verify>
TypeScript compiles without errors: `npm run build` succeeds
File exists at src/utils/print-utils.ts with all 5 functions exported
  </verify>
  <done>
print-utils.ts exists with extractChartImage, extractAllChartImages, extractTableHtml, generatePrintHtml, openPrintWindow functions and ChartImages, PrintableData interfaces exported
  </done>
</task>

<task type="auto">
  <name>Task 2: Add conditional print button to header</name>
  <files>src/components/app-root.ts</files>
  <action>
Modify app-root.ts to add a print button to the header:

1. **Add print button to template (in header-buttons div, before btn-guide)**
   - Button with id="btn-print", class="header-btn hidden"
   - aria-label="Print report", title="Print report"
   - SVG icon (printer icon from Feather/Lucide):
```html
<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
  <polyline points="6 9 6 2 18 2 18 9"></polyline>
  <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
  <rect x="6" y="14" width="12" height="8"></rect>
</svg>
```

2. **Add .hidden style for header-btn** (if not already present)
```css
.header-btn.hidden {
  display: none;
}
```

3. **In afterRender(), add event listener for simulation-complete**
   - On simulation-complete event, remove 'hidden' class from btn-print
```javascript
document.addEventListener('simulation-complete', () => {
  const printBtn = this.$('#btn-print');
  printBtn?.classList.remove('hidden');
});
```

4. **Keep print button click handler as placeholder (empty for now)**
   - Will be wired in Plan 02
```javascript
const printBtn = this.$('#btn-print');
printBtn?.addEventListener('click', () => {
  // Will be wired in Plan 02
  console.log('Print button clicked - handler will be added in Plan 02');
});
```

Button should be positioned before the guide button in the header-buttons div to maintain logical ordering (Print, Guide, Theme, Settings).
  </action>
  <verify>
`npm run build` succeeds
Dev server shows print button appearing after running a simulation
Print button hidden on initial page load (before any simulation)
Print button matches styling of other header buttons (circular, 40x40px)
  </verify>
  <done>
Print button appears in header only after simulation-complete event fires, styled consistently with other header buttons, click logs placeholder message
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without TypeScript errors
2. src/utils/print-utils.ts exists and exports all 5 functions
3. Print button hidden on initial app load
4. Run a simulation - print button appears in header
5. Print button styling matches guide/theme/settings buttons (circular, proper hover states)
6. Click print button - console shows placeholder message
</verification>

<success_criteria>
- Print utilities module created with all helper functions
- Print button conditionally visible in header based on simulation state
- No TypeScript compilation errors
- Visual consistency with existing header design
</success_criteria>

<output>
After completion, create `.planning/phases/29-print-optimized-dashboard/29-01-SUMMARY.md`
</output>
