---
phase: 09-theming-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/theme-service.ts
  - src/charts/theme.ts
  - src/styles/tokens.css
  - src/main.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Theme service singleton manages current theme state"
    - "Theme is loaded from IndexedDB before components render (no FOUC)"
    - "data-theme attribute is set on document.documentElement"
    - "Chart.js color configurations exist for light and dark themes"
  artifacts:
    - path: "src/services/theme-service.ts"
      provides: "Theme management singleton with init/setTheme/getTheme"
      exports: ["ThemeService", "initTheme", "setTheme", "getTheme", "onThemeChange"]
    - path: "src/charts/theme.ts"
      provides: "Light and dark chart color configurations"
      exports: ["lightChartTheme", "darkChartTheme", "getChartTheme"]
    - path: "src/styles/tokens.css"
      provides: "Extended dark theme CSS custom properties"
      contains: "[data-theme=\"dark\"]"
  key_links:
    - from: "src/main.ts"
      to: "src/services/theme-service.ts"
      via: "initTheme() call before app-root"
      pattern: "initTheme\\(\\)"
    - from: "src/services/theme-service.ts"
      to: "src/data/db.ts"
      via: "Dexie settings table read"
      pattern: "db\\.settings"
---

<objective>
Create the theme infrastructure: theme service singleton, Chart.js color configurations, and CSS token extensions for dark theme.

Purpose: Establish the foundation for light/dark theme switching without any visible UI. This includes FOUC prevention by loading theme preference before components render.

Output: Theme service, chart theme configs, extended CSS tokens - all ready for theme toggle component in Plan 02.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-theming-polish/09-RESEARCH.md

# Existing theme infrastructure
@src/styles/tokens.css
@src/data/schemas/settings.ts
@src/data/db.ts
@src/charts/types.ts
@src/main.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create theme service singleton</name>
  <files>src/services/theme-service.ts</files>
  <action>
Create theme service singleton that manages application theme state.

**Exports:**
- `initTheme(): Promise<void>` - Load theme from IndexedDB and apply to DOM (call before app renders)
- `setTheme(theme: 'light' | 'dark' | 'system'): Promise<void>` - Change theme and persist
- `getTheme(): 'light' | 'dark' | 'system'` - Get current user preference
- `getResolvedTheme(): 'light' | 'dark'` - Get actual applied theme (resolves 'system')
- `onThemeChange(callback: (theme: 'light' | 'dark') => void): () => void` - Subscribe to changes

**Implementation details:**
- Store current theme in module-level variable (no class needed, just functions)
- `initTheme()` reads from `db.settings.get('settings')`, defaults to 'system'
- Resolve 'system' using `window.matchMedia('(prefers-color-scheme: dark)')`
- Set `document.documentElement.setAttribute('data-theme', resolvedTheme)`
- Listen for system preference changes via `matchMedia.addEventListener('change', ...)`
- Dispatch CustomEvent 'theme-change' on window for chart updates
- Export type `ThemePreference = 'light' | 'dark' | 'system'`

**Pattern from research:**
```typescript
const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
const prefersDark = mediaQuery.matches;
```

Use existing `db` from `src/data/db.ts` for IndexedDB access.
  </action>
  <verify>
File exists with all exports. TypeScript compiles without errors.
`npm run build` succeeds.
  </verify>
  <done>Theme service provides init, set, get, and subscribe functions for theme management.</done>
</task>

<task type="auto">
  <name>Task 2: Create Chart.js theme configurations</name>
  <files>src/charts/theme.ts</files>
  <action>
Create Chart.js color configurations for light and dark themes.

**Exports:**
- `lightChartTheme: ChartTheme` - Colors optimized for light backgrounds
- `darkChartTheme: ChartTheme` - Colors optimized for dark backgrounds
- `getChartTheme(): ChartTheme` - Returns theme based on current data-theme attribute

**ChartTheme interface already exists in types.ts** - reuse it.

**Light theme (already defined as DEFAULT_CHART_THEME in types.ts):**
- Use existing DEFAULT_CHART_THEME values
- grid: '#e2e8f0', text: '#1e293b', background: '#ffffff'

**Dark theme:**
- Brighten percentile colors for visibility on dark background
- percentiles.p90: '#4ade80' (green-400, brighter than p90 light)
- percentiles.p75: '#a7f3d0' (emerald-200)
- percentiles.p50: '#60a5fa' (blue-400)
- percentiles.p25: '#fcd34d' (amber-300)
- percentiles.p10: '#f87171' (red-400)
- positive: '#22c55e' (green-500)
- negative: '#f87171' (red-400)
- grid: '#334155' (slate-700)
- text: '#f1f5f9' (slate-100)
- background: '#0f172a' (slate-900)
- primary: '#60a5fa' (blue-400)
- secondary: '#94a3b8' (slate-400)
- accent: '#a78bfa' (violet-400)

**getChartTheme() implementation:**
```typescript
export function getChartTheme(): ChartTheme {
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  return isDark ? darkChartTheme : lightChartTheme;
}
```
  </action>
  <verify>
File exports lightChartTheme, darkChartTheme, getChartTheme.
`npm run build` succeeds with no type errors.
  </verify>
  <done>Chart color configurations exist for both themes with getChartTheme() helper.</done>
</task>

<task type="auto">
  <name>Task 3: Initialize theme in main.ts before app renders</name>
  <files>src/main.ts, src/styles/tokens.css</files>
  <action>
**Update main.ts:**
- Import `initTheme` from theme service
- Call `initTheme()` before importing app-root component
- This prevents FOUC (Flash of Unstyled Content)

**Pattern:**
```typescript
import './style.css';
import { initTheme } from './services/theme-service';

// Initialize theme before components render to prevent FOUC
initTheme().then(() => {
  import('./components/app-root');
});

console.log('eVelo starting...');
```

**Verify tokens.css dark theme variables:**
- Confirm `[data-theme="dark"]` block has all necessary overrides
- Add any missing variables needed for components:
  - `--modal-backdrop: rgba(0, 0, 0, 0.5)` for dark (keep same)
  - `--modal-backdrop-blur: 4px` (keep same)
  - `--surface-hover: rgba(255, 255, 255, 0.1)` for dark theme hover states

The existing dark theme block in tokens.css is mostly complete. Only add missing variables if needed.
  </action>
  <verify>
`npm run dev` starts server. Page loads without flash of wrong theme colors.
Check browser DevTools: `document.documentElement.getAttribute('data-theme')` returns 'light' or 'dark'.
  </verify>
  <done>Theme initializes before app renders. No FOUC visible on page load.</done>
</task>

</tasks>

<verification>
1. `npm run build` - No TypeScript errors
2. `npm run dev` - App loads without theme flash
3. Browser console: No errors related to theme service
4. DevTools Elements: `<html data-theme="light">` or `data-theme="dark"` present
5. Manual test: Change system theme preference, reload page - theme follows system
</verification>

<success_criteria>
- Theme service singleton created with init/set/get/subscribe API
- Chart.js color configurations exist for light and dark themes
- Theme loads from IndexedDB before components render (no FOUC)
- System preference detection works via matchMedia
- All files compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-theming-polish/09-01-SUMMARY.md`
</output>
