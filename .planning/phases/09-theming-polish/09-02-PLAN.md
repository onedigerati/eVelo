---
phase: 09-theming-polish
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/components/ui/theme-toggle.ts
  - src/components/ui/index.ts
  - src/components/ui/settings-panel.ts
  - src/charts/base-chart.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can toggle between light and dark themes"
    - "Theme preference persists across sessions"
    - "Charts update colors when theme changes"
    - "Theme toggle appears in settings panel"
  artifacts:
    - path: "src/components/ui/theme-toggle.ts"
      provides: "Theme toggle Web Component with light/dark/system buttons"
      exports: ["ThemeToggle"]
    - path: "src/charts/base-chart.ts"
      provides: "Theme change listener in BaseChart"
      contains: "theme-change"
  key_links:
    - from: "src/components/ui/theme-toggle.ts"
      to: "src/services/theme-service.ts"
      via: "setTheme() call on button click"
      pattern: "setTheme\\("
    - from: "src/charts/base-chart.ts"
      to: "src/charts/theme.ts"
      via: "getChartTheme() for color config"
      pattern: "getChartTheme\\(\\)"
    - from: "src/components/ui/settings-panel.ts"
      to: "src/components/ui/theme-toggle.ts"
      via: "theme-toggle element in template"
      pattern: "<theme-toggle"
---

<objective>
Create theme toggle component and integrate with settings panel. Wire Chart.js components to respond to theme changes.

Purpose: Enable users to switch themes and see changes reflected immediately across the entire UI including charts. Theme preference persists via IndexedDB.

Output: Working theme toggle in settings, charts that update on theme change.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-theming-polish/09-RESEARCH.md
@.planning/phases/09-theming-polish/09-01-SUMMARY.md

# Components to modify
@src/components/ui/settings-panel.ts
@src/charts/base-chart.ts
@src/charts/theme.ts
@src/services/theme-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create theme toggle component</name>
  <files>src/components/ui/theme-toggle.ts, src/components/ui/index.ts</files>
  <action>
Create ThemeToggle Web Component with three options: Light, Dark, System.

**Component structure:**
- Extends BaseComponent
- Three buttons styled as segmented control (radio-button-like appearance)
- Active button has highlighted background
- Uses CSS custom properties for theme-aware styling

**Template:**
```html
<div class="theme-toggle" role="radiogroup" aria-label="Theme selection">
  <button data-theme="light" role="radio" aria-checked="false" aria-label="Light theme">
    <svg><!-- sun icon --></svg>
    <span>Light</span>
  </button>
  <button data-theme="dark" role="radio" aria-checked="false" aria-label="Dark theme">
    <svg><!-- moon icon --></svg>
    <span>Dark</span>
  </button>
  <button data-theme="system" role="radio" aria-checked="false" aria-label="System theme">
    <svg><!-- computer icon --></svg>
    <span>System</span>
  </button>
</div>
```

**SVG icons (inline, 16x16):**
- Sun: simple circle with rays
- Moon: crescent shape
- Computer/Monitor: simple rectangle with stand

**Behavior:**
- Import `setTheme, getTheme, onThemeChange` from theme-service
- On button click, call `setTheme(theme)`
- Update aria-checked and active class based on current theme
- Subscribe to theme changes to sync state if changed elsewhere

**Styles:**
- Horizontal button group with rounded corners on ends
- Active button: teal background, white text
- Inactive button: transparent background, secondary text
- Hover: subtle background highlight
- Uses CSS custom properties for theme-aware colors

**Register element:**
```typescript
customElements.define('theme-toggle', ThemeToggle);
```

**Update index.ts:**
Add export for theme-toggle.ts
  </action>
  <verify>
`npm run build` succeeds.
Component renders three buttons in settings panel (after Task 2).
  </verify>
  <done>ThemeToggle component exists with light/dark/system options and ARIA attributes.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate theme toggle into settings panel</name>
  <files>src/components/ui/settings-panel.ts</files>
  <action>
Add theme selection section to settings panel above API Keys section.

**Add to template (before api-keys-section):**
```html
<section class="theme-section">
  <h3>Appearance</h3>
  <p class="section-info">Choose your preferred color theme.</p>
  <theme-toggle></theme-toggle>
</section>
```

**Import theme-toggle:**
```typescript
import './theme-toggle';
```

**Styling:**
- Theme section uses same styling as other sections
- Consistent padding and border-bottom

No changes to save logic needed - theme-toggle handles persistence directly via theme-service.
  </action>
  <verify>
Open settings panel. Theme section appears at top.
Click Light/Dark/System buttons - theme changes immediately.
Close and reopen settings - selection persists.
  </verify>
  <done>Settings panel includes theme toggle section. Theme changes apply immediately.</done>
</task>

<task type="auto">
  <name>Task 3: Wire Chart.js components to theme changes</name>
  <files>src/charts/base-chart.ts</files>
  <action>
Update BaseChart to listen for theme-change events and update chart colors.

**Add to BaseChart class:**

1. Import chart theme helper:
```typescript
import { getChartTheme } from './theme';
```

2. Add connectedCallback override:
```typescript
connectedCallback(): void {
  super.connectedCallback();
  window.addEventListener('theme-change', this.handleThemeChange);
}
```

3. Add disconnectedCallback update:
```typescript
disconnectedCallback(): void {
  super.disconnectedCallback();
  window.removeEventListener('theme-change', this.handleThemeChange);
  // existing chart destroy logic
}
```

4. Add theme change handler:
```typescript
private handleThemeChange = (): void => {
  if (!this.chart) return;

  const theme = getChartTheme();
  const options = this.chart.options;

  // Update scale colors
  if (options.scales) {
    const xScale = options.scales.x;
    const yScale = options.scales.y;

    if (xScale) {
      if (xScale.grid) xScale.grid.color = theme.grid;
      if (xScale.ticks) xScale.ticks.color = theme.text;
      if (xScale.title) xScale.title.color = theme.text;
    }

    if (yScale) {
      if (yScale.grid) yScale.grid.color = theme.grid;
      if (yScale.ticks) yScale.ticks.color = theme.text;
      if (yScale.title) yScale.title.color = theme.text;
    }
  }

  // Update legend colors
  if (options.plugins?.legend?.labels) {
    options.plugins.legend.labels.color = theme.text;
  }

  this.chart.update('none'); // Update without animation
};
```

Note: This updates scale/legend colors. Individual chart types may need to override this method to update dataset colors (like percentile bands). Consider adding a protected `updateThemeColors()` method that subclasses can override.
  </action>
  <verify>
1. Run simulation to generate charts
2. Open settings, switch theme
3. Charts should update grid/text colors immediately without re-running simulation
4. No console errors about undefined properties
  </verify>
  <done>All charts respond to theme changes. Grid and text colors update dynamically.</done>
</task>

</tasks>

<verification>
1. `npm run build` - No TypeScript errors
2. `npm run dev` - Open settings panel
3. Theme toggle shows Light/Dark/System buttons
4. Click Dark - entire UI switches to dark theme immediately
5. Charts update colors (grid lines, axis labels, legends)
6. Refresh page - theme preference persists
7. Click System - follows OS preference
8. Change OS theme - app follows automatically
</verification>

<success_criteria>
- Theme toggle component renders with three options
- Clicking theme button changes theme immediately
- Theme preference persists across page refreshes
- Charts update colors when theme changes (grid, text, legend)
- ARIA attributes correct for accessibility
- No console errors during theme switching
</success_criteria>

<output>
After completion, create `.planning/phases/09-theming-polish/09-02-SUMMARY.md`
</output>
