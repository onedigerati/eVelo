---
phase: 23-reference-methodology-alignment
plan: 06
type: execute
wave: 2
depends_on: [23-05]
files_modified:
  - src/simulation/monte-carlo.ts
  - src/sbloc/engine.ts
autonomous: true

must_haves:
  truths:
    - "BBD strategy borrows to pay dividend taxes"
    - "Dividend tax increases LOC balance, not portfolio reduction"
    - "Tax modeling enabled affects BBD strategy mechanics"
  artifacts:
    - path: "src/simulation/monte-carlo.ts"
      provides: "Dividend tax borrowing in BBD iteration"
      contains: "dividendTax.*locBalance"
    - path: "src/sbloc/engine.ts"
      provides: "Optional dividend tax handling in SBLOC step"
      contains: "dividendTax"
  key_links:
    - from: "src/simulation/monte-carlo.ts"
      to: "src/sbloc/engine.ts"
      via: "stepSBLOCYear with dividend tax"
      pattern: "dividendTax"
---

<objective>
Implement BBD dividend tax handling via SBLOC borrowing.

Purpose: In the BBD strategy, dividend taxes are paid by BORROWING against the SBLOC, not by selling assets. This preserves the portfolio value while increasing the loan balance. The reference application explicitly handles this, allowing BBD to maintain compound growth on the full portfolio while Sell strategy must liquidate to pay the same taxes.

Output: BBD iteration applies dividend taxes by adding to LOC balance instead of reducing portfolio.
</objective>

<execution_context>
@C:\Users\ungac\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ungac\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/23-reference-methodology-alignment/23-REFERENCE-METHODOLOGY.md
@src/simulation/monte-carlo.ts
@src/sbloc/engine.ts
@src/sbloc/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dividend tax handling to SBLOC step function</name>
  <files>src/sbloc/engine.ts, src/sbloc/types.ts</files>
  <action>
1. Update SBLOCConfig in types.ts to include dividend tax parameters:
```typescript
export interface SBLOCConfig {
  // ... existing fields ...

  /** Dividend yield for tax calculation (e.g., 0.02 for 2%) */
  dividendYield?: number;
  /** Ordinary income tax rate for dividends (e.g., 0.37 for 37%) */
  dividendTaxRate?: number;
}
```

2. Update SBLOCYearResult in types.ts:
```typescript
export interface SBLOCYearResult {
  // ... existing fields ...

  /** Dividend tax added to loan this year */
  dividendTaxBorrowed: number;
}
```

3. Update stepSBLOCYear in engine.ts to handle dividend taxes:
```typescript
export function stepSBLOCYear(
  prevState: SBLOCState,
  config: SBLOCConfig,
  portfolioReturn: number,
  year: number,
  monthlyMode: boolean = false
): SBLOCYearResult {
  // ... existing code ...

  // Calculate dividend tax (BORROW to pay, BBD-style)
  // This happens BEFORE withdrawals and returns in the order of operations
  let dividendTaxBorrowed = 0;
  if (config.dividendYield && config.dividendTaxRate &&
      config.dividendYield > 0 && config.dividendTaxRate > 0) {
    const dividendIncome = currentPortfolioValue * config.dividendYield;
    dividendTaxBorrowed = dividendIncome * config.dividendTaxRate;

    // BBD strategy: BORROW to pay dividend taxes (portfolio stays whole)
    loanBalance += dividendTaxBorrowed;

    console.log(`[SBLOC] Year ${year}: Borrowed $${dividendTaxBorrowed.toFixed(0)} for dividend tax`);
  }

  // ... rest of existing logic (withdrawals, returns, margin calls) ...

  return {
    newState: {
      // ... existing state ...
    },
    interestCharged,
    marginCallTriggered,
    liquidationEvent,
    portfolioFailed,
    dividendTaxBorrowed, // Add to result
  };
}
```

Important: The dividend tax borrowing should happen EARLY in the order of operations:
1. Apply dividend tax (borrow via SBLOC)
2. Process withdrawals (borrow via SBLOC)
3. Apply returns
4. Apply interest
5. Check margin call
  </action>
  <verify>
Run `npm run build` to verify compilation.
Check that dividendTaxBorrowed is in the return type.
  </verify>
  <done>
SBLOC engine handles dividend taxes by adding to loan balance in BBD fashion.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire dividend tax config through Monte Carlo</name>
  <files>src/simulation/monte-carlo.ts</files>
  <action>
Update Monte Carlo to pass dividend tax configuration to SBLOC:

1. When constructing sblocConfig for each year, include dividend tax params:
```typescript
const sblocConfig: SBLOCEngineConfig = {
  annualInterestRate: config.sbloc.interestRate,
  maxLTV: config.sbloc.targetLTV,
  maintenanceMargin: config.sbloc.maintenanceMargin,
  liquidationHaircut: config.sbloc.liquidationHaircut,
  annualWithdrawal: effectiveWithdrawal,
  compoundingFrequency: 'annual',
  startYear: sblocWithdrawalStartYear,
  // NEW: Dividend tax parameters from tax modeling config
  dividendYield: config.taxModeling?.enabled && !config.taxModeling?.taxAdvantaged
    ? config.taxModeling.dividendYield
    : 0,
  dividendTaxRate: config.taxModeling?.enabled && !config.taxModeling?.taxAdvantaged
    ? config.taxModeling.ordinaryTaxRate
    : 0,
};
```

2. Track total dividend taxes borrowed across iterations:
```typescript
let totalDividendTaxesBorrowed: number[] | null = null;

if (config.sbloc) {
  // ... existing tracking arrays ...
  totalDividendTaxesBorrowed = new Array(iterations).fill(0);
}
```

3. In the year loop, accumulate dividend taxes:
```typescript
// After stepSBLOCYear call
if (totalDividendTaxesBorrowed && yearResult.dividendTaxBorrowed) {
  totalDividendTaxesBorrowed[i] += yearResult.dividendTaxBorrowed;
}
```

4. Add to debug stats:
```typescript
// In debugStats computation
if (totalDividendTaxesBorrowed) {
  const medianDivTax = percentile(totalDividendTaxesBorrowed, 50);
  console.log(`[MC Debug] Dividend Taxes Borrowed (BBD):`);
  console.log(`[MC Debug]   Median: $${medianDivTax.toFixed(0)}`);
}
```

5. Log when dividend tax borrowing is active:
```typescript
if (config.taxModeling?.enabled && !config.taxModeling?.taxAdvantaged) {
  console.log(`[MC] BBD dividend tax borrowing enabled: ${(config.taxModeling.dividendYield * 100).toFixed(1)}% yield @ ${(config.taxModeling.ordinaryTaxRate * 100).toFixed(0)}% rate`);
}
```
  </action>
  <verify>
Run `npm run build` to verify compilation.
Run simulation with tax modeling enabled.
Check console for "BBD dividend tax borrowing enabled" message.
Check debug stats for dividend taxes borrowed.
  </verify>
  <done>
Monte Carlo passes dividend tax config to SBLOC and tracks total borrowed for taxes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update estate analysis to account for dividend tax borrowing</name>
  <files>src/simulation/monte-carlo.ts</files>
  <action>
The estate analysis currently computes BBD vs Sell comparison. Update to properly account for dividend taxes:

```typescript
// Compute estate analysis (median case)
const finalStates = sblocStates.map(iterStates => iterStates[timeHorizon - 1]);
const medianLoan = percentile(finalStates.map(s => s?.loanBalance ?? 0), 50);
const medianNetWorth = statistics.median;
const bbdNetEstate = medianNetWorth;

// For Sell strategy comparison, use integrated sell strategy results if available
let sellNetEstate: number;
if (sellStrategyOutput) {
  // Use actual sell strategy median from integrated calculation
  sellNetEstate = sellStrategyOutput.median;
} else {
  // Fallback: estimate taxes if sold
  const medianGrossPortfolio = medianNetWorth + medianLoan;
  const embeddedGains = Math.max(0, medianGrossPortfolio - initialValue);
  const taxesIfSold = embeddedGains * (config.taxModeling?.ltcgTaxRate ?? 0.238);
  sellNetEstate = medianGrossPortfolio - taxesIfSold;
}

// Calculate total taxes for each strategy
let bbdTotalTaxes = 0;
if (totalDividendTaxesBorrowed) {
  // BBD pays dividend taxes by borrowing (they're in the loan)
  bbdTotalTaxes = percentile(totalDividendTaxesBorrowed, 50);
}

let sellTotalTaxes = 0;
if (sellStrategyOutput) {
  sellTotalTaxes = sellStrategyOutput.medianTotalTaxes;
}

// Log comparison for debugging
console.log(`[MC Debug] Estate Analysis:`);
console.log(`[MC Debug]   BBD Net Estate: $${bbdNetEstate.toFixed(0)} (after ${medianLoan.toFixed(0)} loan)`);
console.log(`[MC Debug]   BBD Dividend Tax Borrowed: $${bbdTotalTaxes.toFixed(0)}`);
console.log(`[MC Debug]   Sell Net Estate: $${sellNetEstate.toFixed(0)}`);
console.log(`[MC Debug]   Sell Total Taxes: $${sellTotalTaxes.toFixed(0)}`);
console.log(`[MC Debug]   BBD Advantage: $${(bbdNetEstate - sellNetEstate).toFixed(0)}`);

estateAnalysis = {
  bbdNetEstate,
  sellNetEstate,
  bbdAdvantage: bbdNetEstate - sellNetEstate,
};
```

The key insight is:
- BBD borrows to pay dividend taxes -> taxes are "in the loan" at death, forgiven/settled via estate
- Sell pays dividend taxes from portfolio -> portfolio reduced, less compound growth
- This is a significant BBD advantage the reference app models
  </action>
  <verify>
Run `npm run build` to verify compilation.
Run simulation and compare estate analysis with dividend taxes enabled vs disabled.
With dividend taxes enabled, BBD advantage should increase (borrows vs pays from portfolio).
  </verify>
  <done>
Estate analysis properly accounts for BBD dividend tax borrowing and uses integrated sell strategy results.
  </done>
</task>

</tasks>

<verification>
1. Run `npm run build` - should complete without errors
2. Run `npm run test` - all tests should pass
3. Run simulation with tax modeling enabled:
   - Dividend Yield: 2%
   - Ordinary Tax Rate: 37%
4. Check console for dividend tax borrowing logs
5. Compare BBD vs Sell with dividend taxes enabled vs disabled
6. BBD advantage should be larger when dividend taxes enabled
</verification>

<success_criteria>
- SBLOCConfig includes dividendYield and dividendTaxRate
- stepSBLOCYear adds dividend tax to loanBalance (not reduces portfolio)
- Monte Carlo passes tax config to SBLOC
- Dividend taxes tracked and reported in debug stats
- Estate analysis uses integrated sell strategy results
- BBD advantage properly reflects dividend tax borrowing benefit
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/23-reference-methodology-alignment/23-06-SUMMARY.md`
</output>
