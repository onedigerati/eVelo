---
phase: 23-reference-methodology-alignment
plan: 08
type: execute
wave: 3
depends_on: [23-04, 23-06]
files_modified:
  - src/simulation/types.ts
  - src/simulation/monte-carlo.ts
autonomous: true

must_haves:
  truths:
    - "Chapter system reduces withdrawals at specified years"
    - "Chapter 2 and Chapter 3 reductions can be configured"
    - "Reductions are cumulative (Chapter 3 applies on top of Chapter 2)"
  artifacts:
    - path: "src/simulation/types.ts"
      provides: "WithdrawalChaptersConfig with chapter definitions"
      contains: "chapter2ReductionPct"
    - path: "src/simulation/monte-carlo.ts"
      provides: "Chapter multiplier calculation in year loop"
      contains: "chapterMultiplier"
  key_links:
    - from: "src/simulation/monte-carlo.ts"
      to: "src/simulation/types.ts"
      via: "WithdrawalChaptersConfig type"
      pattern: "chapter.*Multiplier.*1\\s*-.*reductionPct"
---

<objective>
Implement withdrawal chapter system for multi-phase withdrawal strategies.

Purpose: The reference application supports a "chapter" system where withdrawals can be reduced at specific years (e.g., reduce 25% at year 15, reduce another 25% at year 25). This models lifestyle changes like kids leaving home or paying off a mortgage. Currently eVelo has the types defined but doesn't implement the logic.

Output: Monte Carlo applies chapter multipliers to withdrawals at configured years, with cumulative reductions.
</objective>

<execution_context>
@C:\Users\ungac\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ungac\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/23-reference-methodology-alignment/23-REFERENCE-METHODOLOGY.md
@src/simulation/types.ts
@src/simulation/monte-carlo.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify and document WithdrawalChaptersConfig</name>
  <files>src/simulation/types.ts</files>
  <action>
The types already exist in types.ts. Verify they match the reference and add documentation:

```typescript
/**
 * Withdrawal chapter configuration for multi-phase strategies
 *
 * A "chapter" represents a life phase with different withdrawal needs.
 * Example: Kids leave home (chapter 2), mortgage paid off (chapter 3).
 *
 * yearsAfterStart: Years after withdrawal start year to begin this chapter
 * reductionPercent: Percentage to reduce from previous level (positive = reduce)
 */
export interface WithdrawalChapter {
  /** Years after withdrawal start to begin this chapter */
  yearsAfterStart: number;
  /** Reduction percentage (positive = reduce, e.g., 25 means 25% reduction) */
  reductionPercent: number;
}

/**
 * Withdrawal chapters configuration
 *
 * Enables multi-phase withdrawal strategies where withdrawal amounts
 * decrease at specified milestones. Reductions are cumulative:
 *
 * Example with $200K/year, 25% chapter 2 at year 15, 30% chapter 3 at year 25:
 * - Years 1-14: $200K (base withdrawal)
 * - Years 15-24: $150K ($200K * 0.75)
 * - Years 25+: $105K ($200K * 0.75 * 0.70)
 */
export interface WithdrawalChaptersConfig {
  /** Whether multi-phase withdrawal is enabled */
  enabled: boolean;
  /** Chapter 2 configuration (first reduction) */
  chapter2?: WithdrawalChapter;
  /** Chapter 3 configuration (second reduction, cumulative with chapter 2) */
  chapter3?: WithdrawalChapter;
}
```

Verify these types are exported from the types module.
  </action>
  <verify>
Run `npm run build` to verify compilation.
Check that WithdrawalChaptersConfig is exported.
  </verify>
  <done>
WithdrawalChaptersConfig types documented and verified.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement chapter multiplier calculation</name>
  <files>src/simulation/monte-carlo.ts</files>
  <action>
Add chapter multiplier logic to the Monte Carlo year loop:

1. Add helper function for chapter multiplier calculation:
```typescript
/**
 * Calculate withdrawal chapter multiplier for a given year
 *
 * Chapters represent life phases with reduced withdrawal needs.
 * Reductions are cumulative: chapter 3 multiplier includes chapter 2 reduction.
 *
 * @param config Withdrawal chapters configuration
 * @param currentYear Current simulation year (0-indexed)
 * @param withdrawalStartYear Year withdrawals began (0-indexed)
 * @returns Multiplier to apply to base withdrawal (0-1)
 */
function calculateChapterMultiplier(
  config: WithdrawalChaptersConfig | undefined,
  currentYear: number,
  withdrawalStartYear: number
): number {
  if (!config?.enabled) {
    return 1.0;
  }

  const yearsIntoWithdrawals = currentYear - withdrawalStartYear;
  if (yearsIntoWithdrawals < 0) {
    return 1.0;
  }

  let multiplier = 1.0;

  // Check chapter 2
  if (config.chapter2 && yearsIntoWithdrawals >= config.chapter2.yearsAfterStart) {
    multiplier *= (1 - config.chapter2.reductionPercent / 100);
  }

  // Check chapter 3 (cumulative with chapter 2)
  if (config.chapter3 && yearsIntoWithdrawals >= config.chapter3.yearsAfterStart) {
    multiplier *= (1 - config.chapter3.reductionPercent / 100);
  }

  return multiplier;
}
```

2. Update effective withdrawal calculation in the year loop:
```typescript
// Current code calculates withdrawal with raise rate
const yearsOfWithdrawals = Math.max(0, year - sblocWithdrawalStartYear);
const baseWithdrawal = year >= sblocWithdrawalStartYear
  ? sblocBaseWithdrawal * Math.pow(1 + sblocRaiseRate, yearsOfWithdrawals)
  : 0;

// NEW: Apply chapter multiplier
const chapterMultiplier = calculateChapterMultiplier(
  config.withdrawalChapters,
  year,
  sblocWithdrawalStartYear
);
const effectiveWithdrawal = baseWithdrawal * chapterMultiplier;
```

3. Log chapter changes when they occur (once per iteration, track with flag):
```typescript
// At iteration start
let chapter2Logged = false;
let chapter3Logged = false;

// In year loop, after chapter multiplier calc
if (i === 0) { // Only log for first iteration
  if (config.withdrawalChapters?.chapter2 &&
      yearsOfWithdrawals === config.withdrawalChapters.chapter2.yearsAfterStart &&
      !chapter2Logged) {
    console.log(`[MC] Chapter 2 begins at year ${year}: withdrawal reduced by ${config.withdrawalChapters.chapter2.reductionPercent}%`);
    chapter2Logged = true;
  }
  if (config.withdrawalChapters?.chapter3 &&
      yearsOfWithdrawals === config.withdrawalChapters.chapter3.yearsAfterStart &&
      !chapter3Logged) {
    console.log(`[MC] Chapter 3 begins at year ${year}: withdrawal reduced by ${config.withdrawalChapters.chapter3.reductionPercent}% (cumulative)`);
    chapter3Logged = true;
  }
}
```
  </action>
  <verify>
Run `npm run build` to verify compilation.
Configure chapters (e.g., chapter2 at year 15 with 25% reduction).
Run simulation and verify console shows chapter transitions.
Check cumulative withdrawals match expected pattern.
  </verify>
  <done>
Chapter multiplier logic implemented and applied to effective withdrawals.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update cumulative withdrawal tracking for chapters</name>
  <files>src/simulation/monte-carlo.ts</files>
  <action>
Update the calculateCumulativeWithdrawals function to account for chapters:

```typescript
/**
 * Calculate cumulative withdrawals for all years, accounting for:
 * - Annual raises
 * - Withdrawal start year
 * - Chapter reductions
 */
function calculateCumulativeWithdrawals(
  timeHorizon: number,
  baseWithdrawal: number,
  raiseRate: number,
  startYear: number,
  chapters?: WithdrawalChaptersConfig
): number[] {
  const result: number[] = [];
  let cumulative = 0;

  for (let year = 1; year <= timeHorizon; year++) {
    const simYear = year - 1;
    if (simYear >= startYear) {
      const yearsOfWithdrawals = simYear - startYear;

      // Base withdrawal with raises
      const baseWithRaises = baseWithdrawal * Math.pow(1 + raiseRate, yearsOfWithdrawals);

      // Apply chapter multiplier
      const chapterMultiplier = calculateChapterMultiplier(chapters, simYear, startYear);
      const withdrawal = baseWithRaises * chapterMultiplier;

      cumulative += withdrawal;
    }
    result.push(cumulative);
  }

  return result;
}
```

Also update calculateCumulativeWithdrawalAtYear similarly:
```typescript
function calculateCumulativeWithdrawalAtYear(
  year: number,
  baseWithdrawal: number,
  raiseRate: number,
  startYear: number,
  chapters?: WithdrawalChaptersConfig
): number {
  let cumulative = 0;

  for (let y = 1; y <= year; y++) {
    const simYear = y - 1;
    if (simYear >= startYear) {
      const yearsOfWithdrawals = simYear - startYear;
      const baseWithRaises = baseWithdrawal * Math.pow(1 + raiseRate, yearsOfWithdrawals);
      const chapterMultiplier = calculateChapterMultiplier(chapters, simYear, startYear);
      cumulative += baseWithRaises * chapterMultiplier;
    }
  }

  return cumulative;
}
```

Update the calls to these functions to pass the chapters config:
```typescript
sblocTrajectory = {
  // ...
  cumulativeWithdrawals: calculateCumulativeWithdrawals(
    timeHorizon,
    sblocBaseWithdrawal,
    sblocRaiseRate,
    sblocWithdrawalStartYear,
    config.withdrawalChapters  // Add chapters parameter
  ),
  // ...
};
```
  </action>
  <verify>
Run `npm run build` to verify compilation.
Check SBLOC trajectory shows reduced withdrawals after chapter start years.
  </verify>
  <done>
Cumulative withdrawal tracking accounts for chapter reductions.
  </done>
</task>

</tasks>

<verification>
1. Run `npm run build` - should complete without errors
2. Run `npm run test` - all tests should pass
3. Configure simulation with:
   - Chapters enabled
   - Chapter 2: start year 15, reduction 25%
   - Chapter 3: start year 25, reduction 30%
4. Run simulation and verify:
   - Console shows chapter transition messages
   - Withdrawals reduce at chapter start years
   - Chapter 3 reduction is cumulative (0.75 * 0.70 = 0.525 of base)
5. Check SBLOC trajectory cumulative withdrawals match expectations
</verification>

<success_criteria>
- calculateChapterMultiplier function returns correct multipliers
- Chapter multiplier applied to effective withdrawal in year loop
- Cumulative withdrawal functions account for chapters
- Console logging shows chapter transitions
- Reductions are cumulative (Chapter 3 on top of Chapter 2)
- SBLOC trajectory shows reduced withdrawals after chapter years
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/23-reference-methodology-alignment/23-08-SUMMARY.md`
</output>
