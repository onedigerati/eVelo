---
phase: 23-reference-methodology-alignment
plan: 04
type: execute
wave: 2
depends_on: [23-02, 23-03]
files_modified:
  - src/simulation/regime-switching.ts
  - src/simulation/monte-carlo.ts
autonomous: true

must_haves:
  truths:
    - "Regime model applies survivorship bias adjustment to returns"
    - "Historical mode uses 1.5% bias adjustment"
    - "Conservative mode uses 2.0% bias adjustment"
  artifacts:
    - path: "src/simulation/regime-switching.ts"
      provides: "Survivorship bias adjustment in return generation"
      contains: "survivorshipBias"
  key_links:
    - from: "src/simulation/regime-switching.ts"
      to: "src/simulation/types.ts"
      via: "RegimeCalibrationMode import"
      pattern: "survivorshipBias.*1\\.5|2\\.0"
---

<objective>
Add survivorship bias adjustment to the regime-switching model.

Purpose: Historical return data has survivorship bias because failed companies are removed from indices. The reference application adjusts for this by subtracting 1.5% (historical) or 2.0% (conservative) from expected returns. Without this, simulations overestimate future returns.

Output: Updated regime-switching functions that apply survivorship bias based on calibration mode.
</objective>

<execution_context>
@C:\Users\ungac\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ungac\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/23-reference-methodology-alignment/23-REFERENCE-METHODOLOGY.md
@src/simulation/regime-switching.ts
@src/simulation/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add survivorship bias constants to types.ts</name>
  <files>src/simulation/types.ts</files>
  <action>
Add survivorship bias constants to types.ts:

```typescript
// ============================================================================
// Survivorship Bias Constants
// ============================================================================

/**
 * Survivorship bias adjustment by calibration mode
 *
 * Historical index returns are inflated because failed companies are
 * removed from indices. We adjust expected returns downward to account
 * for this. Source: Reference PortfolioStrategySimulator.html
 *
 * - Historical (1.5%): Standard academic adjustment
 * - Conservative (2.0%): More pessimistic for stress testing
 */
export const SURVIVORSHIP_BIAS: Record<RegimeCalibrationMode, number> = {
  historical: 0.015,   // 1.5% subtracted from annual returns
  conservative: 0.020, // 2.0% subtracted from annual returns
};
```
  </action>
  <verify>
Run `npm run build` to verify compilation.
Check that SURVIVORSHIP_BIAS is exported from types.ts.
  </verify>
  <done>
SURVIVORSHIP_BIAS constants defined for both calibration modes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply survivorship bias in regime return generation</name>
  <files>src/simulation/regime-switching.ts</files>
  <action>
Update regime-switching.ts to apply survivorship bias:

1. Import the constant:
```typescript
import {
  DEFAULT_TRANSITION_MATRIX,
  DEFAULT_REGIME_PARAMS,
  SURVIVORSHIP_BIAS,
  type RegimeCalibrationMode,
} from './types';
```

2. Update generateRegimeReturns to accept calibration mode:
```typescript
/**
 * Generate returns using regime-switching model
 *
 * @param years Number of years to generate
 * @param rng Random number generator (0-1)
 * @param initialRegime Starting market regime (default: 'bull')
 * @param matrix Transition probability matrix
 * @param params Return distribution parameters per regime
 * @param calibrationMode Calibration mode for survivorship bias (default: 'historical')
 * @returns Object with returns array and regime sequence
 */
export function generateRegimeReturns(
  years: number,
  rng: () => number,
  initialRegime: MarketRegime = 'bull',
  matrix?: TransitionMatrix,
  params?: RegimeParamsMap,
  calibrationMode: RegimeCalibrationMode = 'historical'
): RegimeReturnsResult {
  const effectiveMatrix = matrix ?? DEFAULT_TRANSITION_MATRIX;
  const effectiveParams = params ?? DEFAULT_REGIME_PARAMS;

  // Get survivorship bias for this mode
  const bias = SURVIVORSHIP_BIAS[calibrationMode];

  const returns: number[] = [];
  const regimes: MarketRegime[] = [];
  let currentRegime = initialRegime;

  for (let year = 0; year < years; year++) {
    regimes.push(currentRegime);

    // Generate return from current regime's distribution
    const { mean, stddev } = effectiveParams[currentRegime];

    // CRITICAL: Apply survivorship bias adjustment to mean
    const adjustedMean = mean - bias;

    const rawReturn = normalRandom(adjustedMean, stddev, rng);

    // Floor at -1 (total loss) and cap at reasonable high (500%)
    const yearReturn = Math.max(-1, Math.min(5, rawReturn));
    returns.push(yearReturn);

    currentRegime = nextRegime(currentRegime, effectiveMatrix, rng);
  }

  return { returns, regimes };
}
```

3. Update generateCorrelatedRegimeReturns similarly:
```typescript
export function generateCorrelatedRegimeReturns(
  years: number,
  numAssets: number,
  correlationMatrix: number[][],
  rng: () => number,
  initialRegime: MarketRegime = 'bull',
  matrix?: TransitionMatrix,
  params?: RegimeParamsMap,
  assetRegimeParams?: RegimeParamsMap[],
  calibrationMode: RegimeCalibrationMode = 'historical'
): CorrelatedRegimeReturnsResult {
  const effectiveMatrix = matrix ?? DEFAULT_TRANSITION_MATRIX;
  const effectiveParams = params ?? DEFAULT_REGIME_PARAMS;

  // Get survivorship bias for this mode
  const bias = SURVIVORSHIP_BIAS[calibrationMode];

  // Generate regime sequence first
  const regimes: MarketRegime[] = [];
  let currentRegime = initialRegime;

  for (let year = 0; year < years; year++) {
    regimes.push(currentRegime);
    currentRegime = nextRegime(currentRegime, effectiveMatrix, rng);
  }

  // Initialize returns arrays
  const returns: number[][] = Array.from(
    { length: numAssets },
    () => new Array(years)
  );

  // Generate returns for each year
  for (let year = 0; year < years; year++) {
    const regime = regimes[year];

    if (assetRegimeParams && assetRegimeParams.length === numAssets) {
      // Asset-specific parameters with survivorship bias
      const uncorrelated = assetRegimeParams.map(assetParams => {
        const { mean, stddev } = assetParams[regime];
        const adjustedMean = mean - bias; // Apply bias
        return normalRandom(adjustedMean, stddev, rng);
      });

      const correlated = correlatedSamples(
        numAssets,
        correlationMatrix,
        rng,
        0,
        1
      );

      for (let asset = 0; asset < numAssets; asset++) {
        const { mean, stddev } = assetRegimeParams[asset][regime];
        const adjustedMean = mean - bias; // Apply bias
        const rawReturn = adjustedMean + stddev * correlated[asset];
        returns[asset][year] = Math.max(-1, Math.min(5, rawReturn));
      }
    } else {
      // Shared parameters with survivorship bias
      const { mean, stddev } = effectiveParams[regime];
      const adjustedMean = mean - bias; // Apply bias

      const yearReturns = correlatedSamples(
        numAssets,
        correlationMatrix,
        rng,
        adjustedMean,
        stddev
      );

      for (let asset = 0; asset < numAssets; asset++) {
        returns[asset][year] = Math.max(-1, Math.min(5, yearReturns[asset]));
      }
    }
  }

  return { returns, regimes };
}
```

4. Add return clamping constants (matching reference):
```typescript
/** Minimum return clamp (-99% for regime model, allows some recovery) */
const MIN_RETURN_CLAMP = -0.99;

/** Maximum return clamp (+500% for extreme recovery scenarios) */
const MAX_RETURN_CLAMP = 5.0;
```
  </action>
  <verify>
Run `npm run build` to verify compilation.
Check that calibrationMode parameter is accepted.
  </verify>
  <done>
Regime-switching functions apply survivorship bias adjustment based on calibration mode.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire calibration mode through Monte Carlo</name>
  <files>src/simulation/monte-carlo.ts</files>
  <action>
Update monte-carlo.ts to pass calibration mode to regime functions:

1. Update the generateIterationReturns call for regime method:
```typescript
if (method === 'regime') {
  const { returns } = generateCorrelatedRegimeReturns(
    years,
    numAssets,
    portfolio.correlationMatrix,
    rng,
    'bull', // initialRegime
    undefined, // matrix (use default or conservative)
    undefined, // shared params (not used when assetRegimeParams provided)
    assetRegimeParams,
    regimeCalibration // Pass calibration mode for survivorship bias
  );
  return returns;
}
```

2. Add console logging for survivorship bias:
```typescript
if (resamplingMethod === 'regime') {
  const calibrationMode = config.regimeCalibration ?? 'historical';
  const bias = calibrationMode === 'conservative' ? 2.0 : 1.5;
  console.log(`[MC] Regime model with ${calibrationMode} survivorship bias (-${bias}%)`);
}
```

3. Use conservative transition matrix when mode is conservative:
```typescript
import {
  DEFAULT_TRANSITION_MATRIX,
  CONSERVATIVE_TRANSITION_MATRIX,
  // ...
} from './types';

// In generateIterationReturns:
if (method === 'regime') {
  const matrix = regimeCalibration === 'conservative'
    ? CONSERVATIVE_TRANSITION_MATRIX
    : DEFAULT_TRANSITION_MATRIX;

  const { returns } = generateCorrelatedRegimeReturns(
    years,
    numAssets,
    portfolio.correlationMatrix,
    rng,
    'bull',
    matrix, // Use mode-specific matrix
    undefined,
    assetRegimeParams,
    regimeCalibration ?? 'historical'
  );
  return returns;
}
```
  </action>
  <verify>
Run `npm run build` to verify compilation.
Run simulation with Regime-Switching model.
Check console shows survivorship bias message.
Compare "Historical" vs "Conservative" mode results - Conservative should show lower returns.
  </verify>
  <done>
Monte Carlo passes calibration mode to regime-switching, applying appropriate survivorship bias and transition matrix.
  </done>
</task>

</tasks>

<verification>
1. Run `npm run build` - should complete without errors
2. Run `npm run test` - all tests should pass
3. Run simulation with Regime-Switching Historical mode - check for 1.5% bias message
4. Run simulation with Regime-Switching Conservative mode - check for 2.0% bias message
5. Compare CAGR between modes - Conservative should be lower
</verification>

<success_criteria>
- SURVIVORSHIP_BIAS constant exists with correct values (1.5%, 2.0%)
- generateRegimeReturns applies survivorship bias to means
- generateCorrelatedRegimeReturns applies survivorship bias
- Monte Carlo uses correct bias based on calibration mode
- Conservative mode uses conservative transition matrix
- Return clamping at -99% to +500%
- Console logging confirms bias application
</success_criteria>

<output>
After completion, create `.planning/phases/23-reference-methodology-alignment/23-04-SUMMARY.md`
</output>
