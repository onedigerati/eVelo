---
phase: 32-historical-asset-data-management
plan: 03
type: execute
wave: 3
depends_on: ["32-01", "32-02"]
files_modified:
  - src/components/ui/settings-panel.ts
  - src/components/app-root.ts
  - src/data/services/preset-service.ts
autonomous: false

must_haves:
  truths:
    - "User can access historical data viewer from settings panel"
    - "Simulation uses custom data when available for a symbol"
    - "User sees visual indicator when custom data is active"
  artifacts:
    - path: "src/components/ui/settings-panel.ts"
      provides: "Button to open historical data viewer"
      contains: "historical-data-viewer"
    - path: "src/data/services/preset-service.ts"
      provides: "getEffectiveData function that checks custom data first"
      exports: ["getEffectiveData"]
  key_links:
    - from: "src/components/ui/settings-panel.ts"
      to: "src/components/ui/historical-data-viewer.ts"
      via: "historical-data-viewer element creation"
      pattern: "historical-data-viewer"
    - from: "src/data/services/preset-service.ts"
      to: "src/data/services/custom-data-service.ts"
      via: "getCustomData import and call"
      pattern: "import.*getCustomData.*from.*custom-data-service"
---

<objective>
Integrate the historical data management feature into the application: add access point in settings panel, wire custom data into simulation flow, and verify the complete user experience.

Purpose: Complete the historical data management feature by connecting UI components to the application flow and ensuring custom data is actually used by the simulation engine.

Output: Fully integrated feature accessible from settings panel, with custom data taking precedence over bundled data in simulations.
</objective>

<execution_context>
@C:\Users\ungac\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ungac\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/32-historical-asset-data-management/32-RESEARCH.md
@.planning/phases/32-historical-asset-data-management/32-01-SUMMARY.md
@.planning/phases/32-historical-asset-data-management/32-02-SUMMARY.md

# Integration points
@src/components/ui/settings-panel.ts
@src/components/app-root.ts
@src/data/services/preset-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add historical data viewer access to settings panel</name>
  <files>
    src/components/ui/settings-panel.ts
  </files>
  <action>
Update `src/components/ui/settings-panel.ts` to add a section for Historical Data Management:

1. Import the historical-data-viewer component at the top:
   ```typescript
   import './historical-data-viewer';
   ```

2. Add a new section in the template after existing settings sections:
   ```html
   <div class="settings-section">
     <h3>Historical Data</h3>
     <p class="section-description">
       View, export, or import custom historical asset data used by the simulation.
     </p>
     <button class="btn btn-secondary" id="manage-data-btn">
       Manage Historical Data
     </button>
   </div>
   ```

3. Add the historical-data-viewer element at the end of the template (before closing div):
   ```html
   <historical-data-viewer></historical-data-viewer>
   ```

4. In afterRender(), add click handler for the manage data button:
   ```typescript
   this.$('#manage-data-btn')?.addEventListener('click', () => {
     const viewer = this.$('historical-data-viewer') as HTMLElement & { show: () => void };
     viewer?.show();
   });
   ```

5. Add styles for the new section:
   ```css
   .section-description {
     font-size: 0.875rem;
     color: var(--text-secondary, #6b7280);
     margin: 4px 0 12px;
   }
   ```
  </action>
  <verify>
    - `npm run build` succeeds
    - Settings panel shows "Historical Data" section
    - "Manage Historical Data" button opens the viewer modal
  </verify>
  <done>
    Settings panel updated with Historical Data section and button that opens the historical data viewer modal.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire custom data into simulation data flow</name>
  <files>
    src/data/services/preset-service.ts
  </files>
  <action>
Update `src/data/services/preset-service.ts` to support custom data:

1. Add import for custom data service:
   ```typescript
   import { getCustomData, hasCustomData } from './custom-data-service';
   ```

2. Add a new async function that returns custom data if available, otherwise bundled:
   ```typescript
   /**
    * Get effective data for a symbol (custom data takes precedence)
    *
    * This is the recommended function to use when fetching data for simulation.
    * It checks for user-imported custom data first, falling back to bundled presets.
    *
    * @param symbol - The symbol to look up
    * @returns PresetData if found (custom or bundled), undefined otherwise
    */
   export async function getEffectiveData(symbol: string): Promise<PresetData | undefined> {
     const upperSymbol = symbol.toUpperCase();

     // Check for custom data first
     const customData = await getCustomData(upperSymbol);
     if (customData) {
       return {
         symbol: customData.symbol,
         name: customData.name,
         assetClass: customData.assetClass,
         startDate: customData.startDate,
         endDate: customData.endDate,
         returns: customData.returns
       };
     }

     // Fall back to bundled preset
     return BUNDLED_PRESETS[upperSymbol];
   }

   /**
    * Check if a symbol has custom data that overrides bundled data
    *
    * @param symbol - The symbol to check
    * @returns true if custom data exists for this symbol
    */
   export async function hasCustomDataForSymbol(symbol: string): Promise<boolean> {
     return hasCustomData(symbol.toUpperCase());
   }

   /**
    * Get list of symbols that have custom data overrides
    *
    * @returns Array of symbols with custom data
    */
   export async function getCustomizedSymbols(): Promise<string[]> {
     const { getCustomSymbols } = await import('./custom-data-service');
     return getCustomSymbols();
   }
   ```

3. Update `src/data/services/index.ts` to export the new functions.
  </action>
  <verify>
    - `npm run build` succeeds
    - getEffectiveData, hasCustomDataForSymbol, getCustomizedSymbols are exported
  </verify>
  <done>
    Preset service updated with getEffectiveData function that checks custom data first, and helper functions for checking/listing custom data.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete historical data management feature</name>
  <what-built>
Complete historical asset data management feature:
- Data infrastructure (Papa Parse, validation, IndexedDB persistence)
- UI components (data table, file drop zone, viewer modal)
- Settings panel integration
- Custom data priority in simulation data flow
  </what-built>
  <how-to-verify>
**Step 1: Access the feature**
1. Open the application
2. Click the Settings (gear) icon in the header
3. Scroll to find "Historical Data" section
4. Click "Manage Historical Data" button
5. Verify modal opens with symbol selector and data table

**Step 2: Test data viewing**
1. Select different symbols from dropdown (SPY, QQQ, AGG, etc.)
2. Verify data table updates with returns data
3. Verify positive returns show in green, negative in red
4. Verify table scrolls smoothly with large datasets
5. Verify record count and date range shown in footer

**Step 3: Test CSV export**
1. With a symbol selected, click "Export CSV"
2. Verify file downloads as `{SYMBOL}_historical_data.csv`
3. Open file in Excel/text editor
4. Verify format: `year,annual_return` header with data rows
5. Verify returns are decimals (e.g., 0.1488 not 14.88%)

**Step 4: Test JSON export**
1. Click "Export JSON"
2. Verify file downloads as `{SYMBOL}_historical_data.json`
3. Open file in text editor
4. Verify JSON structure includes version, exportedAt, symbol, name, returns array

**Step 5: Test CSV import**
1. Click "Import Custom Data"
2. Verify file drop zone appears
3. Create a test CSV file:
   ```
   year,annual_return
   2020,0.1588
   2021,0.2688
   2022,-0.1858
   2023,0.2545
   2024,0.2506
   ```
4. Drag and drop or click to upload
5. Verify validation success message with data point count
6. Click "Confirm Import"
7. Verify "Custom Data" badge appears
8. Verify data table shows imported values

**Step 6: Test validation errors**
1. Click "Import Custom Data" again
2. Create an invalid CSV file (missing column, bad values):
   ```
   year,return
   2020,abc
   2020,0.10
   ```
3. Upload the invalid file
4. Verify specific error messages appear (duplicate year, invalid return, missing column)
5. Click "Try Again" to return to drop zone

**Step 7: Test reset to default**
1. With custom data loaded, click "Reset to Default"
2. Verify "Custom Data" badge disappears
3. Verify data table shows original bundled data

**Step 8: Test persistence**
1. Import custom data for SPY
2. Close the modal
3. Refresh the page
4. Open settings and Historical Data again
5. Verify custom data is still present (badge shows)

**Step 9: Test dark theme**
1. Toggle to dark theme
2. Open historical data viewer
3. Verify all elements are readable and properly styled
4. Verify data table has appropriate dark theme colors

**Step 10: Test mobile view**
1. Use browser dev tools to simulate mobile viewport (375px wide)
2. Open historical data viewer
3. Verify modal takes full screen
4. Verify buttons and controls are touch-friendly
5. Verify table is scrollable

**Expected outcomes:**
- All 10 success criteria from Phase 32 are met
- No console errors
- Smooth user experience across all interactions
  </how-to-verify>
  <resume-signal>
Type "approved" if all verification steps pass, or describe any issues found.
  </resume-signal>
</task>

</tasks>

<verification>
After all tasks complete (including human verification):

1. **Build check:**
   ```
   npm run build
   ```

2. **Integration check:**
   - Settings panel has Historical Data section
   - Button opens viewer modal
   - Export/import work end-to-end

3. **Data flow check:**
   - Import custom data
   - Run simulation with that asset
   - Verify simulation uses custom data (check debug panel if available)
</verification>

<success_criteria>
From Phase 32 success criteria in ROADMAP.md:
1. User can view all bundled historical asset data (SPY, QQQ, IWM, AGG, etc.) in a clear, readable format
2. Data viewer shows year, annual return, and any additional metadata for each asset
3. User can export historical data in a standard format (CSV or JSON) for editing
4. User can import updated/custom historical data in the same format
5. Import validation provides clear error messages for format issues
6. Help documentation explains the data format, requirements, and how to edit safely
7. User guide explains what each column means and acceptable value ranges
8. Warning displayed when imported data differs significantly from expected patterns
9. Imported data persists across sessions (stored in IndexedDB)
10. User can reset to bundled defaults if custom data causes issues
</success_criteria>

<output>
After completion (including human verification approval), create `.planning/phases/32-historical-asset-data-management/32-03-SUMMARY.md`
</output>
