---
phase: 32-historical-asset-data-management
plan: 02
type: execute
wave: 2
depends_on: ["32-01"]
files_modified:
  - src/components/ui/data-table.ts
  - src/components/ui/file-drop-zone.ts
  - src/components/ui/historical-data-viewer.ts
  - src/components/index.ts
autonomous: true

must_haves:
  truths:
    - "User can view historical return data in a scrollable table"
    - "User can drag-and-drop CSV or JSON files for import"
    - "Modal displays bundled data with export options"
  artifacts:
    - path: "src/components/ui/data-table.ts"
      provides: "Virtual scrolling data table component"
      exports: ["DataTable"]
      min_lines: 100
    - path: "src/components/ui/file-drop-zone.ts"
      provides: "Drag-and-drop file upload component"
      exports: ["FileDropZone"]
      min_lines: 60
    - path: "src/components/ui/historical-data-viewer.ts"
      provides: "Main modal for viewing/managing historical data"
      exports: ["HistoricalDataViewer"]
      min_lines: 200
  key_links:
    - from: "src/components/ui/historical-data-viewer.ts"
      to: "src/data/services/preset-service.ts"
      via: "getPresetData import"
      pattern: "import.*getPresetData.*from.*preset-service"
    - from: "src/components/ui/file-drop-zone.ts"
      to: "parent component"
      via: "file-selected CustomEvent"
      pattern: "new CustomEvent.*file-selected"
---

<objective>
Create UI components for viewing and managing historical asset data: a virtual scrolling data table, a drag-and-drop file upload zone, and the main historical data viewer modal.

Purpose: Provide the user interface layer for the historical data management feature, enabling users to view, export, and import market data.

Output: Three Web Components that work together to display data, handle file uploads, and manage the import/export workflow.
</objective>

<execution_context>
@C:\Users\ungac\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ungac\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/32-historical-asset-data-management/32-RESEARCH.md
@.planning/phases/32-historical-asset-data-management/32-01-SUMMARY.md

# Component patterns
@src/components/base-component.ts
@src/components/ui/modal-dialog.ts

# Data services
@src/data/services/preset-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create virtual scrolling data table component</name>
  <files>
    src/components/ui/data-table.ts
    src/components/index.ts
  </files>
  <action>
Create `src/components/ui/data-table.ts`:

```typescript
/**
 * Virtual scrolling data table for displaying historical return data
 *
 * Only renders visible rows for performance with large datasets (30+ years).
 * Supports positive/negative value coloring.
 */

import { BaseComponent } from '../base-component';

interface DataRow {
  date: string;
  return: number;
}

export class DataTable extends BaseComponent {
  private _data: DataRow[] = [];
  private _visibleRows = 15;
  private _rowHeight = 40; // px
  private _scrollTop = 0;
  private _scrollHandler: ((e: Event) => void) | null = null;

  set data(value: DataRow[]) {
    this._data = value;
    this.render();
  }

  get data(): DataRow[] {
    return this._data;
  }

  protected template(): string {
    if (this._data.length === 0) {
      return `
        <div class="empty-state">
          <p>No data available</p>
        </div>
      `;
    }

    const totalHeight = this._data.length * this._rowHeight;
    const startIndex = Math.floor(this._scrollTop / this._rowHeight);
    const endIndex = Math.min(startIndex + this._visibleRows + 2, this._data.length);
    const offsetY = startIndex * this._rowHeight;

    const visibleData = this._data.slice(startIndex, endIndex);

    return `
      <div class="table-container" style="max-height: ${this._visibleRows * this._rowHeight + 44}px;">
        <table>
          <thead>
            <tr>
              <th>Year</th>
              <th>Annual Return</th>
            </tr>
          </thead>
        </table>
        <div class="table-body-scroll">
          <div class="table-spacer" style="height: ${totalHeight}px;">
            <table class="table-body" style="transform: translateY(${offsetY}px);">
              <tbody>
                ${visibleData.map(row => `
                  <tr>
                    <td>${this.formatDate(row.date)}</td>
                    <td class="${row.return >= 0 ? 'positive' : 'negative'}">
                      ${row.return >= 0 ? '+' : ''}${(row.return * 100).toFixed(2)}%
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="table-footer">
        <span>${this._data.length} records</span>
        <span>${this.formatDate(this._data[0]?.date)} - ${this.formatDate(this._data[this._data.length - 1]?.date)}</span>
      </div>
    `;
  }

  private formatDate(date: string): string {
    if (!date) return '';
    // If it's just a year (YYYY), return as-is
    if (/^\d{4}$/.test(date)) return date;
    // If it's a full date, extract year
    return date.substring(0, 4);
  }

  protected afterRender(): void {
    const scrollContainer = this.$('.table-body-scroll');
    if (scrollContainer && !this._scrollHandler) {
      this._scrollHandler = (e: Event) => {
        const newScrollTop = (e.target as HTMLElement).scrollTop;
        if (Math.abs(newScrollTop - this._scrollTop) >= this._rowHeight) {
          this._scrollTop = newScrollTop;
          this.updateVisibleRows();
        }
      };
      scrollContainer.addEventListener('scroll', this._scrollHandler, { passive: true });
    }
  }

  private updateVisibleRows(): void {
    const startIndex = Math.floor(this._scrollTop / this._rowHeight);
    const endIndex = Math.min(startIndex + this._visibleRows + 2, this._data.length);
    const offsetY = startIndex * this._rowHeight;
    const visibleData = this._data.slice(startIndex, endIndex);

    const tableBody = this.$('.table-body tbody');
    const tableWrapper = this.$('.table-body') as HTMLElement;

    if (tableBody && tableWrapper) {
      tableWrapper.style.transform = `translateY(${offsetY}px)`;
      tableBody.innerHTML = visibleData.map(row => `
        <tr>
          <td>${this.formatDate(row.date)}</td>
          <td class="${row.return >= 0 ? 'positive' : 'negative'}">
            ${row.return >= 0 ? '+' : ''}${(row.return * 100).toFixed(2)}%
          </td>
        </tr>
      `).join('');
    }
  }

  disconnectedCallback(): void {
    const scrollContainer = this.$('.table-body-scroll');
    if (scrollContainer && this._scrollHandler) {
      scrollContainer.removeEventListener('scroll', this._scrollHandler);
      this._scrollHandler = null;
    }
    super.disconnectedCallback();
  }

  protected styles(): string {
    return `
      :host {
        display: block;
      }

      .table-container {
        border: 1px solid var(--border-color, #e5e7eb);
        border-radius: var(--border-radius-md, 8px);
        overflow: hidden;
        background: var(--surface-primary, #fff);
      }

      .table-body-scroll {
        overflow-y: auto;
        max-height: ${this._visibleRows * this._rowHeight}px;
      }

      .table-spacer {
        position: relative;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
      }

      thead {
        background: var(--color-primary, #0d9488);
        color: white;
        position: sticky;
        top: 0;
        z-index: 1;
      }

      th, td {
        padding: 10px 16px;
        text-align: left;
        height: ${this._rowHeight}px;
        box-sizing: border-box;
      }

      th {
        font-weight: 600;
        font-size: 0.875rem;
      }

      th:last-child, td:last-child {
        text-align: right;
      }

      tbody tr:nth-child(even) {
        background: var(--surface-secondary, #f9fafb);
      }

      tbody tr:hover {
        background: var(--surface-hover, #f3f4f6);
      }

      td {
        font-family: var(--font-mono, monospace);
        font-size: 0.875rem;
      }

      .positive {
        color: var(--color-success, #059669);
      }

      .negative {
        color: var(--color-danger, #dc2626);
      }

      .table-footer {
        display: flex;
        justify-content: space-between;
        padding: 8px 16px;
        border-top: 1px solid var(--border-color, #e5e7eb);
        font-size: 0.75rem;
        color: var(--text-tertiary, #6b7280);
        background: var(--surface-secondary, #f9fafb);
      }

      .empty-state {
        padding: 32px;
        text-align: center;
        color: var(--text-tertiary, #6b7280);
      }

      /* Dark theme support */
      :host-context([data-theme="dark"]) .table-container {
        border-color: var(--border-color);
        background: var(--surface-primary);
      }

      :host-context([data-theme="dark"]) thead {
        background: var(--color-primary);
      }

      :host-context([data-theme="dark"]) tbody tr:nth-child(even) {
        background: var(--surface-secondary);
      }

      :host-context([data-theme="dark"]) tbody tr:hover {
        background: var(--surface-hover);
      }

      :host-context([data-theme="dark"]) .table-footer {
        background: var(--surface-secondary);
        border-color: var(--border-color);
      }
    `;
  }
}

customElements.define('data-table', DataTable);
```

Add export to `src/components/index.ts`.
  </action>
  <verify>
    - `npm run build` succeeds
    - DataTable component is exported from src/components/index.ts
  </verify>
  <done>
    Virtual scrolling data table created with sticky header, positive/negative coloring, record count footer, and dark theme support.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create file drop zone component</name>
  <files>
    src/components/ui/file-drop-zone.ts
    src/components/index.ts
  </files>
  <action>
Create `src/components/ui/file-drop-zone.ts`:

```typescript
/**
 * Drag-and-drop file upload component
 *
 * Accepts CSV and JSON files via drag-drop or click.
 * Emits 'file-selected' CustomEvent when file is chosen.
 */

import { BaseComponent } from '../base-component';

export class FileDropZone extends BaseComponent {
  private _isDragging = false;
  private _accept = '.csv,.json';

  static get observedAttributes(): string[] {
    return ['accept'];
  }

  attributeChangedCallback(name: string, oldValue: string | null, newValue: string | null): void {
    if (name === 'accept' && newValue) {
      this._accept = newValue;
    }
    super.attributeChangedCallback(name, oldValue, newValue);
  }

  protected template(): string {
    return `
      <div class="drop-zone ${this._isDragging ? 'dragging' : ''}">
        <input
          type="file"
          id="file-input"
          accept="${this._accept}"
          hidden
        />
        <label for="file-input" class="drop-label">
          <div class="icon">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
          </div>
          <span class="text">Drop CSV or JSON file here</span>
          <span class="subtext">or click to browse</span>
          <span class="hint">Supported formats: .csv, .json</span>
        </label>
      </div>
    `;
  }

  protected afterRender(): void {
    const dropZone = this.$('.drop-zone');
    const fileInput = this.$('#file-input') as HTMLInputElement;

    if (!dropZone || !fileInput) return;

    // Prevent default drag behaviors
    const preventDefaults = (e: Event) => {
      e.preventDefault();
      e.stopPropagation();
    };

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, preventDefaults);
    });

    // Visual feedback for drag
    dropZone.addEventListener('dragenter', () => {
      this._isDragging = true;
      dropZone.classList.add('dragging');
    });

    dropZone.addEventListener('dragleave', (e: Event) => {
      // Only remove dragging state if leaving the drop zone entirely
      const de = e as DragEvent;
      const rect = dropZone.getBoundingClientRect();
      if (
        de.clientX < rect.left ||
        de.clientX > rect.right ||
        de.clientY < rect.top ||
        de.clientY > rect.bottom
      ) {
        this._isDragging = false;
        dropZone.classList.remove('dragging');
      }
    });

    // Handle drop
    dropZone.addEventListener('drop', (e: Event) => {
      this._isDragging = false;
      dropZone.classList.remove('dragging');
      const de = e as DragEvent;
      const files = de.dataTransfer?.files;
      if (files?.length) {
        this.handleFile(files[0]);
      }
    });

    // Handle file input change
    fileInput.addEventListener('change', () => {
      if (fileInput.files?.length) {
        this.handleFile(fileInput.files[0]);
        fileInput.value = ''; // Reset for same file re-upload
      }
    });
  }

  private handleFile(file: File): void {
    // Validate file type
    const validTypes = ['text/csv', 'application/json', 'text/plain'];
    const validExtensions = ['.csv', '.json'];
    const hasValidExtension = validExtensions.some(ext =>
      file.name.toLowerCase().endsWith(ext)
    );

    if (!validTypes.includes(file.type) && !hasValidExtension) {
      this.dispatchEvent(new CustomEvent('file-error', {
        detail: { error: 'Invalid file type. Please upload a CSV or JSON file.' },
        bubbles: true,
        composed: true
      }));
      return;
    }

    this.dispatchEvent(new CustomEvent('file-selected', {
      detail: { file },
      bubbles: true,
      composed: true
    }));
  }

  protected styles(): string {
    return `
      :host {
        display: block;
      }

      .drop-zone {
        border: 2px dashed var(--border-color, #d1d5db);
        border-radius: var(--border-radius-lg, 12px);
        padding: 32px;
        text-align: center;
        transition: all 0.2s ease;
        cursor: pointer;
        background: var(--surface-secondary, #f9fafb);
      }

      .drop-zone:hover,
      .drop-zone.dragging {
        border-color: var(--color-primary, #0d9488);
        background: rgba(13, 148, 136, 0.05);
      }

      .drop-zone.dragging {
        border-style: solid;
        transform: scale(1.01);
      }

      .drop-label {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        cursor: pointer;
      }

      .icon {
        color: var(--color-primary, #0d9488);
        margin-bottom: 8px;
      }

      .text {
        font-size: 1rem;
        font-weight: 500;
        color: var(--text-primary, #111827);
      }

      .subtext {
        font-size: 0.875rem;
        color: var(--text-secondary, #6b7280);
      }

      .hint {
        font-size: 0.75rem;
        color: var(--text-tertiary, #9ca3af);
        margin-top: 8px;
      }

      /* Dark theme */
      :host-context([data-theme="dark"]) .drop-zone {
        border-color: var(--border-color);
        background: var(--surface-secondary);
      }

      :host-context([data-theme="dark"]) .drop-zone:hover,
      :host-context([data-theme="dark"]) .drop-zone.dragging {
        border-color: var(--color-primary);
        background: rgba(13, 148, 136, 0.1);
      }

      :host-context([data-theme="dark"]) .text {
        color: var(--text-primary);
      }

      :host-context([data-theme="dark"]) .subtext {
        color: var(--text-secondary);
      }

      :host-context([data-theme="dark"]) .hint {
        color: var(--text-tertiary);
      }
    `;
  }
}

customElements.define('file-drop-zone', FileDropZone);
```

Add export to `src/components/index.ts`.
  </action>
  <verify>
    - `npm run build` succeeds
    - FileDropZone component is exported from src/components/index.ts
  </verify>
  <done>
    File drop zone created with drag-and-drop support, file type validation, visual feedback during drag, and dark theme support.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create historical data viewer modal</name>
  <files>
    src/components/ui/historical-data-viewer.ts
    src/components/index.ts
  </files>
  <action>
Create `src/components/ui/historical-data-viewer.ts`:

```typescript
/**
 * Historical Data Viewer Modal
 *
 * Main component for viewing, exporting, and importing historical asset data.
 * Shows bundled preset data with options to export or import custom data.
 */

import { BaseComponent } from '../base-component';
import { getPresetSymbols, getPresetData, type PresetData } from '../../data/services/preset-service';
import { getCustomData, hasCustomData, saveCustomData, resetToDefaults } from '../../data/services/custom-data-service';
import { parseAndValidateCsv, parseAndValidateJson, type ValidationResult } from '../../data/validation/data-validator';
import Papa from 'papaparse';

import './data-table';
import './file-drop-zone';

type ViewMode = 'view' | 'import';

export class HistoricalDataViewer extends BaseComponent {
  private _visible = false;
  private _selectedSymbol = '';
  private _currentData: PresetData | null = null;
  private _isCustomData = false;
  private _viewMode: ViewMode = 'view';
  private _validationResult: ValidationResult | null = null;
  private _pendingFile: File | null = null;

  /**
   * Show the modal
   */
  public show(symbol?: string): void {
    this._visible = true;
    this._viewMode = 'view';
    this._validationResult = null;
    this._pendingFile = null;

    if (symbol) {
      this._selectedSymbol = symbol;
    } else {
      const symbols = getPresetSymbols();
      this._selectedSymbol = symbols[0] || '';
    }

    this.loadSymbolData();
    this.render();
  }

  /**
   * Hide the modal
   */
  public hide(): void {
    this._visible = false;
    this._validationResult = null;
    this._pendingFile = null;
    this.render();
  }

  private async loadSymbolData(): Promise<void> {
    if (!this._selectedSymbol) return;

    // Check for custom data first
    const customData = await getCustomData(this._selectedSymbol);
    if (customData) {
      this._currentData = {
        symbol: customData.symbol,
        name: customData.name,
        assetClass: customData.assetClass,
        startDate: customData.startDate,
        endDate: customData.endDate,
        returns: customData.returns
      };
      this._isCustomData = true;
    } else {
      this._currentData = getPresetData(this._selectedSymbol) || null;
      this._isCustomData = false;
    }

    this.render();
  }

  private handleSymbolChange(symbol: string): void {
    this._selectedSymbol = symbol;
    this._viewMode = 'view';
    this._validationResult = null;
    this.loadSymbolData();
  }

  private exportToCsv(): void {
    if (!this._currentData) return;

    const rows = this._currentData.returns.map(r => ({
      year: r.date,
      annual_return: r.return.toFixed(6)
    }));

    const csv = Papa.unparse(rows, { header: true, newline: '\n' });
    this.downloadFile(csv, `${this._currentData.symbol}_historical_data.csv`, 'text/csv');
  }

  private exportToJson(): void {
    if (!this._currentData) return;

    const json = JSON.stringify({
      version: 1,
      exportedAt: new Date().toISOString(),
      ...this._currentData
    }, null, 2);

    this.downloadFile(json, `${this._currentData.symbol}_historical_data.json`, 'application/json');
  }

  private downloadFile(content: string, filename: string, mimeType: string): void {
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  private async handleFileSelected(e: CustomEvent<{ file: File }>): Promise<void> {
    const file = e.detail.file;
    this._pendingFile = file;

    const content = await this.readFileAsText(file);
    const isJson = file.name.toLowerCase().endsWith('.json');

    if (isJson) {
      this._validationResult = parseAndValidateJson(content);
    } else {
      // For CSV, use current symbol and name
      this._validationResult = parseAndValidateCsv(
        content,
        this._selectedSymbol,
        this._currentData?.name || this._selectedSymbol
      );
    }

    this.render();
  }

  private readFileAsText(file: File): Promise<string> {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result as string);
      reader.onerror = () => reject(new Error('Failed to read file'));
      reader.readAsText(file);
    });
  }

  private async confirmImport(): Promise<void> {
    if (!this._validationResult?.valid || !this._validationResult.data) return;

    await saveCustomData(this._validationResult.data, 'user-import');

    // Dispatch event for parent components
    this.dispatchEvent(new CustomEvent('data-imported', {
      detail: { symbol: this._validationResult.data.symbol },
      bubbles: true,
      composed: true
    }));

    // Reload the symbol data
    this._selectedSymbol = this._validationResult.data.symbol;
    this._validationResult = null;
    this._pendingFile = null;
    this._viewMode = 'view';
    await this.loadSymbolData();
  }

  private cancelImport(): void {
    this._validationResult = null;
    this._pendingFile = null;
    this._viewMode = 'view';
    this.render();
  }

  private async handleReset(): Promise<void> {
    if (!this._selectedSymbol) return;

    await resetToDefaults(this._selectedSymbol);
    await this.loadSymbolData();

    this.dispatchEvent(new CustomEvent('data-reset', {
      detail: { symbol: this._selectedSymbol },
      bubbles: true,
      composed: true
    }));
  }

  protected template(): string {
    if (!this._visible) {
      return '';
    }

    const symbols = getPresetSymbols();

    return `
      <div class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="viewer-title">
        <div class="modal-container">
          <header class="modal-header">
            <h2 id="viewer-title">Historical Asset Data</h2>
            <button class="close-btn" aria-label="Close">&times;</button>
          </header>

          <div class="modal-body">
            <!-- Symbol selector -->
            <div class="symbol-selector">
              <label for="symbol-select">Select Asset:</label>
              <select id="symbol-select">
                ${symbols.map(s => `
                  <option value="${s}" ${s === this._selectedSymbol ? 'selected' : ''}>${s}</option>
                `).join('')}
              </select>
              ${this._isCustomData ? '<span class="custom-badge">Custom Data</span>' : ''}
            </div>

            ${this._viewMode === 'view' ? this.renderViewMode() : this.renderImportMode()}
          </div>
        </div>
      </div>
    `;
  }

  private renderViewMode(): string {
    return `
      <!-- Data info -->
      <div class="data-info">
        <h3>${this._currentData?.name || this._selectedSymbol}</h3>
        <p class="data-range">
          ${this._currentData ? `${this._currentData.startDate.substring(0, 4)} - ${this._currentData.endDate.substring(0, 4)}` : ''}
          ${this._currentData ? `(${this._currentData.returns.length} data points)` : ''}
        </p>
        ${this._isCustomData ? '<p class="custom-note">Using custom imported data</p>' : ''}
      </div>

      <!-- Data table -->
      <div class="table-wrapper">
        <data-table></data-table>
      </div>

      <!-- Action buttons -->
      <div class="action-buttons">
        <div class="export-group">
          <button class="btn btn-secondary" id="export-csv-btn">
            Export CSV
          </button>
          <button class="btn btn-secondary" id="export-json-btn">
            Export JSON
          </button>
        </div>
        <div class="import-group">
          <button class="btn btn-primary" id="import-btn">
            Import Custom Data
          </button>
          ${this._isCustomData ? `
            <button class="btn btn-warning" id="reset-btn">
              Reset to Default
            </button>
          ` : ''}
        </div>
      </div>

      <!-- Help section -->
      <details class="help-section">
        <summary>Help: Data Format</summary>
        <div class="help-content">
          <h4>CSV Format</h4>
          <pre>year,annual_return
1995,0.1488
1996,-0.0523
1997,0.2105</pre>
          <ul>
            <li><strong>year:</strong> Year or date (YYYY or YYYY-MM-DD)</li>
            <li><strong>annual_return:</strong> Decimal (0.10 = 10%, -0.05 = -5%)</li>
          </ul>

          <h4>JSON Format</h4>
          <pre>{
  "symbol": "SPY",
  "name": "S&P 500",
  "returns": [
    {"date": "1995", "return": 0.1488},
    {"date": "1996", "return": -0.0523}
  ]
}</pre>

          <h4>Important Notes</h4>
          <ul>
            <li>Returns are decimals, not percentages (10% = 0.10)</li>
            <li>Minimum 5 years of data required</li>
            <li>Years should not have gaps</li>
            <li>Custom data persists in browser storage</li>
            <li>Use "Reset to Default" to restore bundled data</li>
          </ul>
        </div>
      </details>
    `;
  }

  private renderImportMode(): string {
    return `
      <div class="import-section">
        <h3>Import Custom Data for ${this._selectedSymbol}</h3>

        ${!this._validationResult ? `
          <file-drop-zone accept=".csv,.json"></file-drop-zone>
        ` : this._validationResult.valid ? `
          <div class="validation-success">
            <div class="success-icon">&#x2713;</div>
            <h4>Validation Passed</h4>
            <p>Ready to import ${this._validationResult.data?.returns.length} data points</p>
            <p class="date-range">
              ${this._validationResult.data?.startDate} - ${this._validationResult.data?.endDate}
            </p>
            ${this._validationResult.warnings.length > 0 ? `
              <div class="warnings">
                <h5>Warnings (data will still be imported):</h5>
                <ul>
                  ${this._validationResult.warnings.map(w => `<li>${w.message}</li>`).join('')}
                </ul>
              </div>
            ` : ''}
            <div class="import-actions">
              <button class="btn btn-primary" id="confirm-import-btn">Confirm Import</button>
              <button class="btn btn-secondary" id="cancel-import-btn">Cancel</button>
            </div>
          </div>
        ` : `
          <div class="validation-error">
            <div class="error-icon">&#x2717;</div>
            <h4>Validation Failed</h4>
            <div class="error-list">
              <ul>
                ${this._validationResult.errors.map(e => `<li>${e.message}</li>`).join('')}
              </ul>
            </div>
            ${this._validationResult.warnings.length > 0 ? `
              <div class="warnings">
                <h5>Additional Warnings:</h5>
                <ul>
                  ${this._validationResult.warnings.map(w => `<li>${w.message}</li>`).join('')}
                </ul>
              </div>
            ` : ''}
            <div class="import-actions">
              <button class="btn btn-secondary" id="cancel-import-btn">Try Again</button>
            </div>
          </div>
        `}
      </div>
    `;
  }

  protected afterRender(): void {
    if (!this._visible) return;

    // Close button
    this.$('.close-btn')?.addEventListener('click', () => this.hide());

    // Overlay click to close
    this.$('.modal-overlay')?.addEventListener('click', (e) => {
      if ((e.target as Element).classList.contains('modal-overlay')) {
        this.hide();
      }
    });

    // Symbol select
    const symbolSelect = this.$('#symbol-select') as HTMLSelectElement;
    symbolSelect?.addEventListener('change', () => {
      this.handleSymbolChange(symbolSelect.value);
    });

    // Export buttons
    this.$('#export-csv-btn')?.addEventListener('click', () => this.exportToCsv());
    this.$('#export-json-btn')?.addEventListener('click', () => this.exportToJson());

    // Import button
    this.$('#import-btn')?.addEventListener('click', () => {
      this._viewMode = 'import';
      this.render();
    });

    // Reset button
    this.$('#reset-btn')?.addEventListener('click', () => this.handleReset());

    // File drop zone
    this.$('file-drop-zone')?.addEventListener('file-selected', (e) => {
      this.handleFileSelected(e as CustomEvent<{ file: File }>);
    });

    // Import confirmation
    this.$('#confirm-import-btn')?.addEventListener('click', () => this.confirmImport());
    this.$('#cancel-import-btn')?.addEventListener('click', () => this.cancelImport());

    // Set data table data
    const dataTable = this.$('data-table') as HTMLElement & { data: Array<{ date: string; return: number }> };
    if (dataTable && this._currentData) {
      dataTable.data = this._currentData.returns;
    }

    // Keyboard handling
    document.addEventListener('keydown', this.handleKeydown);
  }

  private handleKeydown = (e: KeyboardEvent): void => {
    if (e.key === 'Escape' && this._visible) {
      if (this._viewMode === 'import' && this._validationResult) {
        this.cancelImport();
      } else {
        this.hide();
      }
    }
  };

  disconnectedCallback(): void {
    document.removeEventListener('keydown', this.handleKeydown);
    super.disconnectedCallback();
  }

  protected styles(): string {
    return `
      :host {
        display: contents;
      }

      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 16px;
        backdrop-filter: blur(4px);
      }

      .modal-container {
        background: var(--surface-primary, #fff);
        border-radius: var(--border-radius-lg, 12px);
        max-width: 800px;
        width: 100%;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        box-shadow: var(--shadow-lg, 0 20px 25px -5px rgba(0, 0, 0, 0.1));
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 24px;
        border-bottom: 1px solid var(--border-color, #e5e7eb);
      }

      .modal-header h2 {
        margin: 0;
        font-size: 1.25rem;
        color: var(--text-primary, #111827);
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-tertiary, #9ca3af);
        padding: 4px 8px;
        border-radius: 4px;
      }

      .close-btn:hover {
        background: var(--surface-secondary, #f3f4f6);
        color: var(--text-primary, #111827);
      }

      .modal-body {
        padding: 24px;
        overflow-y: auto;
        flex: 1;
      }

      .symbol-selector {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
      }

      .symbol-selector label {
        font-weight: 500;
        color: var(--text-primary, #111827);
      }

      .symbol-selector select {
        padding: 8px 12px;
        border: 1px solid var(--border-color, #d1d5db);
        border-radius: var(--border-radius-md, 6px);
        font-size: 1rem;
        min-width: 100px;
        background: var(--surface-primary, #fff);
        color: var(--text-primary, #111827);
      }

      .custom-badge {
        background: var(--color-warning, #f59e0b);
        color: white;
        font-size: 0.75rem;
        padding: 2px 8px;
        border-radius: 9999px;
        font-weight: 500;
      }

      .data-info {
        margin-bottom: 16px;
      }

      .data-info h3 {
        margin: 0 0 4px 0;
        font-size: 1.125rem;
        color: var(--text-primary, #111827);
      }

      .data-range {
        margin: 0;
        font-size: 0.875rem;
        color: var(--text-secondary, #6b7280);
      }

      .custom-note {
        margin: 4px 0 0 0;
        font-size: 0.875rem;
        color: var(--color-warning, #d97706);
        font-style: italic;
      }

      .table-wrapper {
        margin-bottom: 20px;
      }

      .action-buttons {
        display: flex;
        justify-content: space-between;
        gap: 16px;
        flex-wrap: wrap;
        margin-bottom: 20px;
      }

      .export-group, .import-group {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .btn {
        padding: 8px 16px;
        border-radius: var(--border-radius-md, 6px);
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
      }

      .btn-primary {
        background: var(--color-primary, #0d9488);
        color: white;
      }

      .btn-primary:hover {
        background: var(--color-primary-dark, #0f766e);
      }

      .btn-secondary {
        background: var(--surface-secondary, #f3f4f6);
        color: var(--text-primary, #111827);
        border: 1px solid var(--border-color, #d1d5db);
      }

      .btn-secondary:hover {
        background: var(--surface-hover, #e5e7eb);
      }

      .btn-warning {
        background: var(--color-warning, #f59e0b);
        color: white;
      }

      .btn-warning:hover {
        background: #d97706;
      }

      .help-section {
        border: 1px solid var(--border-color, #e5e7eb);
        border-radius: var(--border-radius-md, 8px);
        background: var(--surface-secondary, #f9fafb);
      }

      .help-section summary {
        padding: 12px 16px;
        cursor: pointer;
        font-weight: 500;
        color: var(--text-primary, #111827);
      }

      .help-section summary:hover {
        background: var(--surface-hover, #f3f4f6);
      }

      .help-content {
        padding: 0 16px 16px;
      }

      .help-content h4 {
        margin: 16px 0 8px;
        font-size: 0.875rem;
        color: var(--text-primary, #111827);
      }

      .help-content pre {
        background: var(--surface-primary, #fff);
        border: 1px solid var(--border-color, #e5e7eb);
        border-radius: 4px;
        padding: 12px;
        font-size: 0.75rem;
        overflow-x: auto;
        margin: 0;
      }

      .help-content ul {
        margin: 8px 0;
        padding-left: 20px;
        font-size: 0.875rem;
        color: var(--text-secondary, #6b7280);
      }

      .help-content li {
        margin: 4px 0;
      }

      /* Import mode styles */
      .import-section {
        text-align: center;
      }

      .import-section h3 {
        margin: 0 0 20px 0;
        color: var(--text-primary, #111827);
      }

      .validation-success, .validation-error {
        padding: 24px;
        border-radius: var(--border-radius-lg, 12px);
        margin-top: 20px;
      }

      .validation-success {
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid var(--color-success, #10b981);
      }

      .validation-error {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid var(--color-danger, #ef4444);
      }

      .success-icon, .error-icon {
        font-size: 2rem;
        margin-bottom: 12px;
      }

      .success-icon {
        color: var(--color-success, #10b981);
      }

      .error-icon {
        color: var(--color-danger, #ef4444);
      }

      .validation-success h4, .validation-error h4 {
        margin: 0 0 8px 0;
      }

      .date-range {
        font-size: 0.875rem;
        color: var(--text-secondary, #6b7280);
      }

      .warnings {
        text-align: left;
        margin-top: 16px;
        padding: 12px;
        background: rgba(245, 158, 11, 0.1);
        border-radius: 8px;
      }

      .warnings h5 {
        margin: 0 0 8px 0;
        color: var(--color-warning, #d97706);
        font-size: 0.875rem;
      }

      .warnings ul, .error-list ul {
        margin: 0;
        padding-left: 20px;
        font-size: 0.875rem;
        text-align: left;
      }

      .error-list {
        text-align: left;
        margin: 16px 0;
      }

      .error-list li {
        color: var(--color-danger, #dc2626);
        margin: 4px 0;
      }

      .import-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
        margin-top: 20px;
      }

      /* Dark theme */
      :host-context([data-theme="dark"]) .modal-container {
        background: var(--surface-primary);
      }

      :host-context([data-theme="dark"]) .modal-header {
        border-color: var(--border-color);
      }

      :host-context([data-theme="dark"]) .modal-header h2 {
        color: var(--text-primary);
      }

      :host-context([data-theme="dark"]) .close-btn:hover {
        background: var(--surface-secondary);
        color: var(--text-primary);
      }

      :host-context([data-theme="dark"]) .symbol-selector label,
      :host-context([data-theme="dark"]) .data-info h3,
      :host-context([data-theme="dark"]) .import-section h3 {
        color: var(--text-primary);
      }

      :host-context([data-theme="dark"]) .symbol-selector select {
        background: var(--surface-secondary);
        border-color: var(--border-color);
        color: var(--text-primary);
      }

      :host-context([data-theme="dark"]) .help-section {
        background: var(--surface-secondary);
        border-color: var(--border-color);
      }

      :host-context([data-theme="dark"]) .help-content pre {
        background: var(--surface-primary);
        border-color: var(--border-color);
      }

      :host-context([data-theme="dark"]) .btn-secondary {
        background: var(--surface-secondary);
        color: var(--text-primary);
        border-color: var(--border-color);
      }

      :host-context([data-theme="dark"]) .btn-secondary:hover {
        background: var(--surface-hover);
      }

      @media (max-width: 640px) {
        .modal-container {
          max-height: 100vh;
          height: 100%;
          border-radius: 0;
        }

        .action-buttons {
          flex-direction: column;
        }

        .export-group, .import-group {
          width: 100%;
        }

        .btn {
          flex: 1;
        }
      }
    `;
  }
}

customElements.define('historical-data-viewer', HistoricalDataViewer);
```

Add export to `src/components/index.ts`.
  </action>
  <verify>
    - `npm run build` succeeds
    - HistoricalDataViewer component is exported from src/components/index.ts
    - All three components (DataTable, FileDropZone, HistoricalDataViewer) are defined
  </verify>
  <done>
    Historical data viewer modal created with symbol selection, data table display, CSV/JSON export, import workflow with validation feedback, reset to defaults, and comprehensive help documentation.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build verification:**
   ```
   npm run build
   ```
   Must complete without errors.

2. **Component registration check:**
   Open browser dev tools, verify custom elements are defined:
   ```javascript
   customElements.get('data-table')       // Should return class
   customElements.get('file-drop-zone')   // Should return class
   customElements.get('historical-data-viewer') // Should return class
   ```

3. **Visual test:**
   Create temporary test in app-root or console:
   ```javascript
   const viewer = document.createElement('historical-data-viewer');
   document.body.appendChild(viewer);
   viewer.show('SPY');
   ```
   - Verify modal appears with data table
   - Verify export buttons work
   - Verify import mode shows file drop zone
</verification>

<success_criteria>
1. DataTable component renders with virtual scrolling for large datasets
2. DataTable shows positive returns in green, negative in red
3. FileDropZone accepts drag-and-drop and click file selection
4. FileDropZone validates file types before emitting event
5. HistoricalDataViewer shows symbol selector with all bundled assets
6. HistoricalDataViewer displays data in DataTable component
7. Export CSV and JSON buttons download correctly formatted files
8. Import mode shows FileDropZone and validation results
9. Validation errors shown with specific messages
10. Validation warnings shown but allow import to proceed
11. Custom data badge shown when using imported data
12. Reset to default button removes custom data
13. Help section explains data format requirements
14. All components support dark theme
</success_criteria>

<output>
After completion, create `.planning/phases/32-historical-asset-data-management/32-02-SUMMARY.md`
</output>
