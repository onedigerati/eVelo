---
phase: 18-fix-regime-switching
plan: 03
type: execute
wave: 2
depends_on: ["18-02"]
files_modified:
  - src/simulation/regime-calibration.ts
autonomous: true

must_haves:
  truths:
    - "Conservative calibration produces lower expected returns than historical"
    - "Conservative calibration produces higher volatility than historical"
    - "Both historical and conservative modes produce valid regime parameters"
  artifacts:
    - path: "src/simulation/regime-calibration.ts"
      provides: "Conservative adjustment function"
      exports: ["applyConservativeAdjustment", "calibrateRegimeModelWithMode"]
  key_links:
    - from: "calibrateRegimeModelWithMode"
      to: "applyConservativeAdjustment"
      via: "mode parameter"
      pattern: "mode === 'conservative'"
---

<objective>
Implement Conservative calibration mode that applies stress-testing parameter adjustments to historical regime parameters.

Purpose: The regimeCalibration setting in the UI offers "Historical" and "Conservative" modes, but currently both produce identical results because the setting is never used. This plan implements the Conservative mode which reduces expected returns and increases volatility for risk-averse simulations.

Output: Extended regime-calibration.ts with applyConservativeAdjustment function and calibrateRegimeModelWithMode that accepts calibration mode parameter.
</objective>

<execution_context>
@C:\Users\ungac\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ungac\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-fix-regime-switching/18-RESEARCH.md

# Source files - need SUMMARY from 18-02 for calibration module context
@src/simulation/regime-calibration.ts
@src/simulation/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add conservative adjustment function</name>
  <files>src/simulation/regime-calibration.ts</files>
  <action>
Add the following functions to `src/simulation/regime-calibration.ts`:

```typescript
import type { RegimeParamsMap, MarketRegime, RegimeCalibrationMode } from './types';

/**
 * Apply conservative stress-testing adjustments to regime parameters
 *
 * Conservative adjustments based on Federal Reserve stress test methodology:
 * - Bull: Reduce mean by 1 stddev (or 1pp min), increase volatility 15%
 * - Bear: Reduce mean by 2pp, increase volatility 20%
 * - Crash: Reduce mean by 3pp, increase volatility 25%
 *
 * The rationale:
 * - Lower returns account for possibility of worse-than-historical outcomes
 * - Higher volatility increases uncertainty bands
 * - More aggressive adjustment for negative regimes (crash > bear > bull)
 *
 * @param historicalParams Regime parameters from historical calibration
 * @returns Adjusted parameters for conservative simulation
 */
export function applyConservativeAdjustment(
  historicalParams: RegimeParamsMap
): RegimeParamsMap {
  return {
    bull: {
      // Reduce mean by 1 stddev (minimum 1 percentage point)
      mean: historicalParams.bull.mean - Math.max(0.01, historicalParams.bull.stddev),
      // Increase volatility by 15%
      stddev: historicalParams.bull.stddev * 1.15,
    },
    bear: {
      // Make bear returns more negative (reduce by 2pp)
      mean: historicalParams.bear.mean - 0.02,
      // Increase bear volatility by 20%
      stddev: historicalParams.bear.stddev * 1.20,
    },
    crash: {
      // Make crashes worse (reduce by 3pp)
      mean: historicalParams.crash.mean - 0.03,
      // Increase crash volatility by 25%
      stddev: historicalParams.crash.stddev * 1.25,
    },
  };
}

/**
 * Calibrate regime model with explicit mode selection
 *
 * Main entry point for regime calibration that respects the user's
 * calibration mode preference (historical or conservative).
 *
 * @param historicalReturns Array of historical annual returns
 * @param mode Calibration mode: 'historical' for actual data, 'conservative' for stress-adjusted
 * @returns Regime parameters appropriate for the selected mode
 */
export function calibrateRegimeModelWithMode(
  historicalReturns: number[],
  mode: RegimeCalibrationMode
): RegimeParamsMap {
  // Step 1: Derive historical parameters from data
  const historicalParams = calibrateRegimeModel(historicalReturns);

  // Step 2: Apply mode-specific adjustment
  if (mode === 'conservative') {
    return applyConservativeAdjustment(historicalParams);
  }

  return historicalParams;
}
```

Implementation notes:
- Conservative adjustments based on Federal Reserve stress test methodology
- Bull mean reduced by 1 stddev (captures uncertainty in "good times")
- Bear/crash means reduced by fixed amounts (2pp and 3pp)
- All volatilities increased (15-25% depending on regime severity)
- calibrateRegimeModelWithMode is the new main entry point for use in simulation
  </action>
  <verify>
1. `grep "applyConservativeAdjustment" src/simulation/regime-calibration.ts` shows function exists
2. `grep "calibrateRegimeModelWithMode" src/simulation/regime-calibration.ts` shows function exists
3. `npx tsc --noEmit` passes
4. `npm run build` succeeds
  </verify>
  <done>
- applyConservativeAdjustment function added
- calibrateRegimeModelWithMode function added
- Both functions properly typed
- Conservative mode reduces returns and increases volatility
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify conservative mode produces expected changes</name>
  <files>src/simulation/regime-calibration.ts</files>
  <action>
Add a validation comment or simple test case at the end of the file to document expected behavior:

```typescript
/**
 * Expected behavior verification (development reference):
 *
 * Given historical params:
 *   bull: { mean: 0.12, stddev: 0.12 }
 *   bear: { mean: -0.05, stddev: 0.15 }
 *   crash: { mean: -0.25, stddev: 0.30 }
 *
 * Conservative adjustment produces:
 *   bull: { mean: 0.00, stddev: 0.138 }  // -0.12 (1 stddev), +15%
 *   bear: { mean: -0.07, stddev: 0.18 }  // -0.02 (2pp), +20%
 *   crash: { mean: -0.28, stddev: 0.375 } // -0.03 (3pp), +25%
 *
 * Net effect:
 * - Bull regime mean drops from +12% to 0%
 * - All regimes have higher volatility
 * - Expected long-term return is lower in conservative mode
 */
```

This documents the expected transformation for verification purposes.
  </action>
  <verify>
1. Documentation comment exists in file
2. Build still succeeds: `npm run build`
  </verify>
  <done>
- Expected behavior documented in code comments
- Conservative mode behavior is clear and verifiable
  </done>
</task>

</tasks>

<verification>
- `npm run build` completes without errors
- `npx tsc --noEmit` type checks pass
- applyConservativeAdjustment and calibrateRegimeModelWithMode are exported
- Conservative parameters have lower means and higher stddevs than historical
</verification>

<success_criteria>
1. applyConservativeAdjustment function implements Federal Reserve-style stress adjustments
2. calibrateRegimeModelWithMode accepts mode parameter and routes appropriately
3. Conservative mode produces lower expected returns across all regimes
4. Conservative mode produces higher volatility across all regimes
5. Both modes return valid RegimeParamsMap
6. Application builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/18-fix-regime-switching/18-03-SUMMARY.md`
</output>
