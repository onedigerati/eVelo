---
phase: 06-visualizations
plan: 04
type: execute
wave: 2
depends_on: ["06-01"]
files_modified: [src/charts/donut-chart.ts, src/charts/correlation-heatmap.ts, src/charts/index.ts]
autonomous: true

must_haves:
  truths:
    - "User can see portfolio composition as donut chart"
    - "User can see asset correlation matrix as heatmap"
    - "Charts display data correctly and are responsive"
  artifacts:
    - path: "src/charts/donut-chart.ts"
      provides: "Web Component for portfolio composition donut"
      min_lines: 70
      contains: "customElements.define"
    - path: "src/charts/correlation-heatmap.ts"
      provides: "Web Component for correlation matrix visualization"
      min_lines: 80
      contains: "customElements.define"
  key_links:
    - from: "src/charts/correlation-heatmap.ts"
      to: "chartjs-chart-matrix"
      via: "MatrixController import"
      pattern: "import.*MatrixController"
---

<objective>
Create donut chart for portfolio composition and heatmap for correlation matrix.

Purpose: Enable users to visualize portfolio weights and asset correlations.
Output: Two Chart.js Web Components (donut-chart, correlation-heatmap).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/charts/base-chart.ts
@src/charts/types.ts
@src/types/portfolio.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create portfolio donut chart component</name>
  <files>src/charts/donut-chart.ts</files>
  <action>
    Create DonutChart Web Component extending BaseChart.

    Requirements (VIZ-03):
    - Shows portfolio composition by asset weight
    - Each segment represents an asset with its allocation percentage
    - Center can show total or key metric
    - Legend shows asset names and weights

    Implementation:
    1. Extend BaseChart
    2. Accept data via property: public data: DonutChartData | null = null
    3. Implement getChartConfig() returning doughnut chart config:
       - type: 'doughnut'
       - data.labels: segment labels (asset names)
       - data.datasets[0].data: segment values (weights as percentages)
       - data.datasets[0].backgroundColor: array of colors

    4. Chart options:
       - cutout: '60%' (creates donut hole)
       - responsive: true
       - maintainAspectRatio: true (keep circular)

    5. Color palette for segments (predefined for up to 5 assets):
       - Asset 1: #2563eb (blue)
       - Asset 2: #16a34a (green)
       - Asset 3: #dc2626 (red)
       - Asset 4: #9333ea (purple)
       - Asset 5: #ea580c (orange)
       If more than 5, generate colors programmatically

    6. Legend: positioned at bottom, shows asset name + percentage
    7. Tooltip: Show "Asset Name: X%" on hover
    8. Center text (optional enhancement): Use afterDraw plugin to draw
       total value or "Portfolio" text in center
    9. Register component: customElements.define('donut-chart', DonutChart)
  </action>
  <verify>npm run build succeeds, component is defined</verify>
  <done>Donut chart renders portfolio composition correctly</done>
</task>

<task type="auto">
  <name>Task 2: Create correlation heatmap component</name>
  <files>src/charts/correlation-heatmap.ts</files>
  <action>
    Create CorrelationHeatmap Web Component extending BaseChart.

    Requirements (VIZ-04):
    - Shows correlation matrix between assets
    - Color scale from negative (red) to zero (white) to positive (blue)
    - Labels on both axes showing asset names
    - Cell values showing correlation coefficients

    Implementation:
    1. Extend BaseChart
    2. Import and register MatrixController and MatrixElement from chartjs-chart-matrix:
       ```typescript
       import { MatrixController, MatrixElement } from 'chartjs-chart-matrix';
       import { Chart } from 'chart.js';
       Chart.register(MatrixController, MatrixElement);
       ```

    3. Accept data via property: public data: HeatmapData | null = null
    4. Transform HeatmapData to chartjs-chart-matrix format:
       - data.datasets[0].data: array of { x: colIndex, y: rowIndex, v: correlationValue }
       - Flatten matrix to array of points

    5. Implement getChartConfig() returning matrix chart config:
       - type: 'matrix'
       - data.labels: asset names for both axes
       - data.datasets[0].data: flattened matrix points

    6. Color scale function for correlation values (-1 to +1):
       - -1.0: #dc2626 (red - strong negative)
       - -0.5: #fca5a5 (light red)
       -  0.0: #ffffff (white - no correlation)
       - +0.5: #93c5fd (light blue)
       - +1.0: #2563eb (blue - strong positive)
       Use interpolation for values between

    7. Element options:
       - width: calculate based on number of assets
       - height: calculate based on number of assets
       - borderWidth: 1
       - borderColor: '#e5e7eb'

    8. Scale configuration:
       - x: { type: 'category', labels: assetNames, position: 'top' }
       - y: { type: 'category', labels: assetNames }
       - Both with grid hidden

    9. Tooltip: Show "Asset A vs Asset B: X.XX" correlation
    10. Data labels: Display correlation value in each cell
        Use afterDraw to draw text on cells
    11. Register component: customElements.define('correlation-heatmap', CorrelationHeatmap)

    Helper function: interpolateColor(value: number): string
    - Takes correlation (-1 to 1), returns hex color
  </action>
  <verify>npm run build succeeds, component is defined</verify>
  <done>Correlation heatmap renders matrix with color scale correctly</done>
</task>

<task type="auto">
  <name>Task 3: Update module exports</name>
  <files>src/charts/index.ts</files>
  <action>
    Add exports for new chart components:

    export * from './donut-chart';
    export * from './correlation-heatmap';

    Final index.ts should export:
    - types
    - base-chart
    - probability-cone-chart
    - sbloc-balance-chart
    - histogram-chart
    - margin-call-chart
    - bbd-comparison-chart
    - donut-chart
    - correlation-heatmap
  </action>
  <verify>npm run build succeeds</verify>
  <done>All chart components exportable from charts module</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds without errors
- [ ] tsc --noEmit passes
- [ ] Both chart components registered as custom elements
- [ ] Heatmap uses chartjs-chart-matrix correctly
- [ ] Charts extend BaseChart properly
</verification>

<success_criteria>
- All tasks completed
- Donut chart visualizes portfolio composition (VIZ-03)
- Correlation heatmap shows asset correlations with color scale (VIZ-04)
- Components follow project patterns
- All Phase 6 visualization requirements covered
</success_criteria>

<output>
After completion, create `.planning/phases/06-visualizations/06-04-SUMMARY.md`
</output>
