---
phase: 06-visualizations
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified: [src/charts/histogram-chart.ts, src/charts/margin-call-chart.ts, src/charts/bbd-comparison-chart.ts, src/charts/index.ts]
autonomous: true

must_haves:
  truths:
    - "User can see terminal net worth distribution as histogram"
    - "User can see margin call risk probability by year as bar chart"
    - "User can see BBD vs Sell strategy comparison chart"
  artifacts:
    - path: "src/charts/histogram-chart.ts"
      provides: "Web Component for terminal value distribution"
      min_lines: 70
      contains: "customElements.define"
    - path: "src/charts/margin-call-chart.ts"
      provides: "Web Component for margin call probability bars"
      min_lines: 60
      contains: "customElements.define"
    - path: "src/charts/bbd-comparison-chart.ts"
      provides: "Web Component for BBD vs Sell comparison"
      min_lines: 70
      contains: "customElements.define"
  key_links:
    - from: "src/charts/histogram-chart.ts"
      to: "BaseChart"
      via: "extends BaseChart"
      pattern: "extends BaseChart"
---

<objective>
Create bar chart components for histogram, margin call risk, and BBD comparison.

Purpose: Enable users to visualize distributions, risks, and strategy comparisons.
Output: Three Chart.js bar chart Web Components.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/charts/base-chart.ts
@src/charts/types.ts
@src/calculations/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create histogram chart component</name>
  <files>src/charts/histogram-chart.ts</files>
  <action>
    Create HistogramChart Web Component extending BaseChart.

    Requirements (VIZ-02):
    - Shows terminal net worth distribution
    - X-axis: value ranges (bins)
    - Y-axis: frequency/count
    - Visualizes spread of simulation outcomes

    Implementation:
    1. Extend BaseChart
    2. Accept data via property: public data: HistogramData | null = null
    3. Implement getChartConfig() returning bar chart config:
       - type: 'bar'
       - X-axis labels: bin ranges formatted as "$X - $Y"
       - Y-axis: count of iterations in each bin
       - Bar color: gradient from red (low values) to green (high values)
         OR single color with opacity variation

    4. Configuration options:
       - barPercentage: 1 (no gap between bars for histogram look)
       - categoryPercentage: 1

    5. X-axis formatting: Compact currency notation for bin ranges
    6. Y-axis formatting: Integer count (iterations)
    7. Tooltip: Show bin range and count
    8. Register component: customElements.define('histogram-chart', HistogramChart)

    Helper function: createHistogramBins(values: number[], binCount = 20): HistogramData
    - Find min/max of values
    - Calculate bin width
    - Count values in each bin
    - Return HistogramData structure
  </action>
  <verify>npm run build succeeds, component is defined</verify>
  <done>Histogram chart renders distribution bins correctly</done>
</task>

<task type="auto">
  <name>Task 2: Create margin call probability chart</name>
  <files>src/charts/margin-call-chart.ts</files>
  <action>
    Create MarginCallChart Web Component extending BaseChart.

    Requirements (VIZ-05):
    - Shows margin call probability by year
    - X-axis: simulation years
    - Y-axis: probability percentage (0-100%)
    - Bar for each year showing annual probability
    - Optional: overlay line for cumulative probability

    Implementation:
    1. Extend BaseChart
    2. Accept data via property: public data: BarChartData | null = null
       Also accept: public cumulativeData?: number[] (for cumulative line overlay)
    3. Implement getChartConfig() returning mixed chart config:
       - Primary dataset: type 'bar' for annual probability
       - Secondary dataset (if cumulativeData): type 'line' for cumulative
       - Bar colors: gradient from green (low risk) to red (high risk)
         based on probability value

    4. Color scale function:
       - 0-5%: green (#22c55e)
       - 5-15%: yellow (#eab308)
       - 15-30%: orange (#f97316)
       - 30%+: red (#ef4444)

    5. Y-axis: percentage format (0-100%), max at 100 or auto
    6. X-axis: "Year 1", "Year 2", etc.
    7. Tooltip: "Year X: Y% annual probability (Z% cumulative)"
    8. Register component: customElements.define('margin-call-chart', MarginCallChart)
  </action>
  <verify>npm run build succeeds, component is defined</verify>
  <done>Margin call chart shows risk by year with color coding</done>
</task>

<task type="auto">
  <name>Task 3: Create BBD vs Sell comparison chart</name>
  <files>src/charts/bbd-comparison-chart.ts</files>
  <action>
    Create BBDComparisonChart Web Component extending BaseChart.

    Requirements (VIZ-07):
    - Shows BBD strategy vs traditional sell strategy
    - Side-by-side or stacked comparison
    - Shows net estate values and the advantage

    Implementation options:
    A. Grouped bar chart: BBD vs Sell net estate side by side
    B. Stacked bar showing components (portfolio, loan, taxes)
    C. Horizontal bar for clearer comparison

    Recommended: Option A (grouped vertical bars) with difference annotation

    1. Extend BaseChart
    2. Accept data via property: public data: BBDComparisonChartData | null = null
       Interface:
       - bbdNetEstate: number
       - sellNetEstate: number
       - bbdAdvantage: number
       - breakdown?: { taxes: number, loan: number }

    3. Implement getChartConfig():
       - type: 'bar'
       - Two bars: "BBD Strategy" and "Sell Strategy"
       - BBD bar: blue (#2563eb)
       - Sell bar: gray (#6b7280)
       - Add annotation showing difference (if Chart.js annotation plugin or custom)

    4. Y-axis: currency format
    5. Tooltip: Show full breakdown
    6. Add text annotation above bars showing advantage: "+$X BBD advantage"
       Use Chart.js datalabels plugin or custom afterDraw
    7. Register component: customElements.define('bbd-comparison-chart', BBDComparisonChart)

    Note: For annotation, can use afterDraw callback to draw custom text
    without adding another plugin dependency.
  </action>
  <verify>npm run build succeeds, component is defined</verify>
  <done>BBD comparison chart shows strategy comparison clearly</done>
</task>

<task type="auto">
  <name>Task 4: Update module exports</name>
  <files>src/charts/index.ts</files>
  <action>
    Add exports for new chart components:

    export * from './histogram-chart';
    export * from './margin-call-chart';
    export * from './bbd-comparison-chart';
  </action>
  <verify>npm run build succeeds</verify>
  <done>New chart components exportable from charts module</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds without errors
- [ ] tsc --noEmit passes
- [ ] All three chart components registered as custom elements
- [ ] Charts extend BaseChart properly
</verification>

<success_criteria>
- All tasks completed
- Histogram chart visualizes terminal value distribution (VIZ-02)
- Margin call chart shows risk by year with color coding (VIZ-05)
- BBD comparison chart shows strategy advantage (VIZ-07)
- Components follow project patterns
</success_criteria>

<output>
After completion, create `.planning/phases/06-visualizations/06-03-SUMMARY.md`
</output>
