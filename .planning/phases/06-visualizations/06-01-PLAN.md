---
phase: 06-visualizations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [package.json, src/charts/types.ts, src/charts/base-chart.ts, src/charts/index.ts]
autonomous: true

must_haves:
  truths:
    - "Chart.js and chartjs-chart-matrix are installed and importable"
    - "BaseChart component can render a canvas in Shadow DOM"
    - "Chart types are defined for all visualization requirements"
  artifacts:
    - path: "src/charts/types.ts"
      provides: "TypeScript interfaces for chart data structures"
      min_lines: 50
    - path: "src/charts/base-chart.ts"
      provides: "Abstract base class for Chart.js Web Components"
      min_lines: 60
      contains: "extends BaseComponent"
    - path: "src/charts/index.ts"
      provides: "Module barrel export"
  key_links:
    - from: "src/charts/base-chart.ts"
      to: "chart.js"
      via: "import Chart"
      pattern: "import.*Chart.*from.*chart.js"
---

<objective>
Set up Chart.js infrastructure with base chart component and type definitions.

Purpose: Establish foundation for all visualization components with proper Shadow DOM integration.
Output: Chart.js installed, types defined, reusable base chart component ready.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/components/base-component.ts
@src/types/index.ts
@src/calculations/types.ts
@src/simulation/types.ts
@src/sbloc/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Chart.js dependencies</name>
  <files>package.json</files>
  <action>
    Install Chart.js and the matrix chart plugin for heatmaps:
    - `npm install chart.js chartjs-chart-matrix`

    Chart.js 4.x is the current major version with tree-shaking support.
    chartjs-chart-matrix 3.x provides matrix/heatmap chart type.
  </action>
  <verify>npm list chart.js chartjs-chart-matrix shows both packages installed</verify>
  <done>Both packages in dependencies, importable in TypeScript</done>
</task>

<task type="auto">
  <name>Task 2: Create chart type definitions</name>
  <files>src/charts/types.ts</files>
  <action>
    Define TypeScript interfaces for chart data structures. Create types for:

    1. ProbabilityConeData - time series with percentile bands (p10, p25, p50, p75, p90)
       - years: number[]
       - bands: { p10: number[], p25: number[], p50: number[], p75: number[], p90: number[] }

    2. HistogramData - binned distribution
       - bins: { min: number, max: number, count: number }[]
       - binWidth: number

    3. DonutChartData - portfolio composition
       - segments: { label: string, value: number, color?: string }[]

    4. HeatmapData - correlation matrix
       - labels: string[]
       - matrix: number[][] (values -1 to 1)

    5. BarChartData - margin call probability by year
       - labels: string[]
       - values: number[]
       - colors?: string[]

    6. LineChartData - SBLOC balance, BBD vs Sell comparison
       - labels: string[] (x-axis)
       - datasets: { label: string, data: number[], color?: string }[]

    7. ChartTheme - color configuration
       - primary, secondary, accent colors
       - percentile band colors (p10, p25, p50, p75, p90)
       - positive/negative colors for BBD comparison

    Export DEFAULT_CHART_THEME with sensible defaults:
    - p90/p75: greens (optimistic)
    - p50: blue (median)
    - p25/p10: oranges/reds (pessimistic)
    - primary: #2563eb (blue-600)
  </action>
  <verify>tsc --noEmit passes with no errors</verify>
  <done>All chart data types defined and exportable</done>
</task>

<task type="auto">
  <name>Task 3: Create base chart component</name>
  <files>src/charts/base-chart.ts</files>
  <action>
    Create abstract BaseChart class extending BaseComponent that handles Chart.js + Shadow DOM integration.

    Key implementation details:
    1. Import Chart from 'chart.js/auto' (includes all controllers/elements)
    2. Import MatrixController, MatrixElement from 'chartjs-chart-matrix' and register them
    3. Store chart instance: protected chart: Chart | null = null
    4. Create canvas element in template() with id="chart-canvas"
    5. In afterRender():
       - Get canvas element via this.$('#chart-canvas')
       - Call abstract getChartConfig() to get Chart.js configuration
       - Create new Chart(canvas, config)
    6. In disconnectedCallback():
       - Destroy chart instance if exists: this.chart?.destroy()
    7. Add update() method to update chart data without full re-render:
       - this.chart.data = newData; this.chart.update()
    8. Abstract methods:
       - getChartConfig(): ChartConfiguration - subclasses implement

    Shadow DOM note: Chart.js works in Shadow DOM when canvas is created inside the shadow root.
    The key is getting the canvas AFTER it's in the DOM (in afterRender, not constructor).

    Styles: Set canvas container to position: relative for Chart.js responsive sizing.
  </action>
  <verify>tsc --noEmit passes, class is importable</verify>
  <done>BaseChart abstract class ready for chart subclasses</done>
</task>

<task type="auto">
  <name>Task 4: Create module barrel export</name>
  <files>src/charts/index.ts</files>
  <action>
    Create barrel export file for charts module:

    export * from './types';
    export * from './base-chart';

    This follows the established pattern from other modules (math, simulation, sbloc, calculations).
  </action>
  <verify>npm run build succeeds</verify>
  <done>Charts module exportable via src/charts/index.ts</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm list chart.js chartjs-chart-matrix shows both installed
- [ ] npm run build succeeds without errors
- [ ] tsc --noEmit passes
- [ ] src/charts/index.ts exports types and BaseChart
</verification>

<success_criteria>
- All tasks completed
- Chart.js and matrix plugin installed
- Type definitions cover all 7 visualization requirements
- BaseChart provides reusable Shadow DOM integration
- Module follows project conventions (barrel exports, abstract base class)
</success_criteria>

<output>
After completion, create `.planning/phases/06-visualizations/06-01-SUMMARY.md`
</output>
