---
phase: 15-dashboard-gap-fixes
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ui/results-dashboard.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "BBD vs Sell comparison line chart uses array index (idx) not year value"
    - "yearlyPercentiles accessed correctly at index position"
    - "Chart displays correct portfolio values for all years"
  artifacts:
    - path: "src/components/ui/results-dashboard.ts"
      provides: "Corrected array indexing in updateComparisonLineChart"
      contains: "yearlyPercentiles[idx]"
  key_links:
    - from: "updateComparisonLineChart"
      to: "yearlyPercentiles array"
      via: "idx parameter"
      pattern: "yearlyPercentiles\\[idx\\]"
---

<objective>
Fix GAP-VIZ-07: BBD vs Sell Comparison Array Indexing Issue

The updateComparisonLineChart() function uses `yearlyPercentiles[year]` where `year` is the actual year number, but `yearlyPercentiles` is a 0-indexed array. This causes incorrect or undefined array access.

Purpose: Change `year` to `idx` for correct array indexing.
Output: BBD vs Sell comparison line chart displays correct data.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-dashboard-calculations-review/14-GAP-FINDINGS.md

# File with bug
@src/components/ui/results-dashboard.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix array indexing in updateComparisonLineChart</name>
  <files>src/components/ui/results-dashboard.ts</files>
  <action>
    Update line 1387 in updateComparisonLineChart function:

    Change from:
    ```typescript
    const bbdValues = years.map((year, idx) => {
      const portfolio = this._data!.yearlyPercentiles[year]?.p50 || 0;
      const loan = traj.loanBalance.p50[idx] || 0;
      return portfolio - loan;
    });
    ```

    To:
    ```typescript
    const bbdValues = years.map((year, idx) => {
      const portfolio = this._data!.yearlyPercentiles[idx]?.p50 || 0;
      const loan = traj.loanBalance.p50[idx] || 0;
      return portfolio - loan;
    });
    ```

    The key change: `yearlyPercentiles[year]` -> `yearlyPercentiles[idx]`

    Rationale:
    - `year` is the year number from traj.years (e.g., 1, 2, 3...)
    - `idx` is the array index (0, 1, 2...)
    - yearlyPercentiles is 0-indexed, so we must use idx
  </action>
  <verify>
    Grep for "yearlyPercentiles\[year\]" in results-dashboard.ts should return no matches
    Grep for "yearlyPercentiles\[idx\]" should show the corrected line
  </verify>
  <done>updateComparisonLineChart uses `idx` for array access instead of `year`</done>
</task>

<task type="auto">
  <name>Task 2: Check for similar patterns in other functions</name>
  <files>src/components/ui/results-dashboard.ts</files>
  <action>
    Search for other instances where yearlyPercentiles might be accessed incorrectly:

    1. Search for `yearlyPercentiles[year]` pattern:
       `grep -n "yearlyPercentiles\[year\]" src/components/ui/results-dashboard.ts`

    2. Check updateSBLOCUtilizationChart (line ~1497) which has similar pattern:
       ```typescript
       const yearData = this._data!.yearlyPercentiles[year];
       ```
       This also needs to be changed to use `idx`:
       ```typescript
       const yearData = this._data!.yearlyPercentiles[idx];
       ```

    3. Verify the loop uses (year, idx) destructuring in the for loop or map callback.
  </action>
  <verify>
    `grep -n "yearlyPercentiles\[year\]" src/components/ui/results-dashboard.ts` returns no matches
  </verify>
  <done>All yearlyPercentiles array accesses use proper index variable (idx)</done>
</task>

<task type="auto">
  <name>Task 3: Verify fix with TypeScript compilation</name>
  <files>src/components/ui/results-dashboard.ts</files>
  <action>
    1. Run TypeScript compilation:
       `npm run build`

    2. Verify no type errors related to array access.

    3. Confirm the fix is syntactically correct.
  </action>
  <verify>
    `npm run build` completes without errors
  </verify>
  <done>TypeScript compiles successfully with corrected array indexing</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. No instances of `yearlyPercentiles[year]` in results-dashboard.ts
2. All yearlyPercentiles accesses use proper index variable
3. Build completes without errors
</verification>

<success_criteria>
GAP-VIZ-07 FIXED: Array indexing corrected in updateComparisonLineChart and updateSBLOCUtilizationChart:
- `yearlyPercentiles[year]` -> `yearlyPercentiles[idx]`
- Chart displays correct BBD net worth values for all years
- No undefined array access when simulation years start at different values
</success_criteria>

<output>
After completion, create `.planning/phases/15-dashboard-gap-fixes/15-03-SUMMARY.md`
</output>
