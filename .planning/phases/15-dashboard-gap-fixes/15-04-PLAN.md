---
phase: 15-dashboard-gap-fixes
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ui/results-dashboard.ts
  - src/charts/correlation-heatmap.ts
  - src/charts/types.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Fallback values (8%/16%) are clearly labeled as estimates"
    - "Users can distinguish calculated values from estimated defaults"
    - "Heatmap displays (est) suffix for assets without preset data"
  artifacts:
    - path: "src/components/ui/results-dashboard.ts"
      provides: "calculateAssetStatistics returns isEstimate flags"
      contains: "isEstimate"
    - path: "src/charts/correlation-heatmap.ts"
      provides: "Visual indicator for estimated values"
      contains: "est"
  key_links:
    - from: "src/components/ui/results-dashboard.ts"
      to: "src/charts/correlation-heatmap.ts"
      via: "HeatmapData with isEstimate metadata"
      pattern: "isEstimate.*true"
---

<objective>
Fix VIZ-04: Correlation Heatmap Misleading Fallback Values

The correlation heatmap uses fallback values (8% expected return, 16% volatility) when preset data is unavailable, but these are not labeled as estimates. Users may assume they are calculated from actual data.

Purpose: Add visual indicators to clearly label estimated values.
Output: Heatmap shows "(est)" suffix for fallback values.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-dashboard-calculations-review/14-GAP-FINDINGS.md

# Files to modify
@src/components/ui/results-dashboard.ts
@src/charts/correlation-heatmap.ts
@src/charts/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update calculateAssetStatistics to return estimate flags</name>
  <files>src/components/ui/results-dashboard.ts</files>
  <action>
    Modify the calculateAssetStatistics method (around line 1680) to return an additional array indicating which values are estimates.

    Change from:
    ```typescript
    private calculateAssetStatistics(symbols: string[]): {
      expectedReturns: number[];
      volatilities: number[];
    } {
      const expectedReturns: number[] = [];
      const volatilities: number[] = [];

      for (const symbol of symbols) {
        const presetData = getPresetData(symbol);

        if (presetData && presetData.returns.length > 0) {
          // ... calculate from data ...
          expectedReturns.push(annualReturn);
          volatilities.push(annualVol);
        } else {
          // Fallback values if preset data not available
          expectedReturns.push(0.08);
          volatilities.push(0.16);
        }
      }

      return { expectedReturns, volatilities };
    }
    ```

    To:
    ```typescript
    private calculateAssetStatistics(symbols: string[]): {
      expectedReturns: number[];
      volatilities: number[];
      isEstimate: boolean[];
    } {
      const expectedReturns: number[] = [];
      const volatilities: number[] = [];
      const isEstimate: boolean[] = [];

      for (const symbol of symbols) {
        const presetData = getPresetData(symbol);

        if (presetData && presetData.returns.length > 0) {
          // ... calculate from data ...
          expectedReturns.push(annualReturn);
          volatilities.push(annualVol);
          isEstimate.push(false);
        } else {
          // Fallback values if preset data not available
          // Mark as estimates so UI can indicate this to user
          expectedReturns.push(0.08);
          volatilities.push(0.16);
          isEstimate.push(true);
        }
      }

      return { expectedReturns, volatilities, isEstimate };
    }
    ```
  </action>
  <verify>
    Grep for "isEstimate" in results-dashboard.ts should show the new return field
  </verify>
  <done>calculateAssetStatistics returns isEstimate array indicating which values are fallbacks</done>
</task>

<task type="auto">
  <name>Task 2: Update heatmap data binding to include estimate flags</name>
  <files>src/components/ui/results-dashboard.ts</files>
  <action>
    Update the heatmap data binding (around line 778-789) to pass the isEstimate flags:

    Change from:
    ```typescript
    if (heatmap && this._correlationMatrix) {
      const assetStats = this.calculateAssetStatistics(this._correlationMatrix.labels);

      heatmap.data = {
        labels: this._correlationMatrix.labels,
        matrix: this._correlationMatrix.matrix,
        expectedReturns: assetStats.expectedReturns,
        volatilities: assetStats.volatilities,
      };
    }
    ```

    To:
    ```typescript
    if (heatmap && this._correlationMatrix) {
      const assetStats = this.calculateAssetStatistics(this._correlationMatrix.labels);

      heatmap.data = {
        labels: this._correlationMatrix.labels,
        matrix: this._correlationMatrix.matrix,
        expectedReturns: assetStats.expectedReturns,
        volatilities: assetStats.volatilities,
        isEstimate: assetStats.isEstimate,
      };
    }
    ```
  </action>
  <verify>
    Grep for "isEstimate: assetStats.isEstimate" in results-dashboard.ts should show the binding
  </verify>
  <done>Heatmap receives isEstimate metadata from calculateAssetStatistics</done>
</task>

<task type="auto">
  <name>Task 3: Update HeatmapData type and correlation-heatmap to display estimates</name>
  <files>src/charts/correlation-heatmap.ts, src/charts/types.ts</files>
  <action>
    1. First, update the HeatmapData type in src/charts/types.ts to include optional isEstimate:
       ```typescript
       export interface HeatmapData {
         labels: string[];
         matrix: number[][];
         expectedReturns?: number[];
         volatilities?: number[];
         isEstimate?: boolean[];  // Add this line
       }
       ```

    2. Then update correlation-heatmap.ts to display "(est)" suffix for estimated values.

       In the rendering section where expected returns and volatilities are displayed
       (likely in the header row or column labels), append "(est)" when isEstimate[i] is true:

       Example change pattern:
       ```typescript
       // When displaying expected return for asset i:
       const returnDisplay = `${(expectedReturns[i] * 100).toFixed(1)}%`;
       const label = isEstimate?.[i] ? `${returnDisplay} (est)` : returnDisplay;
       ```

       Or use italicized styling for estimates:
       ```typescript
       const className = isEstimate?.[i] ? 'estimated' : '';
       ```

    3. Add CSS class for estimated values if using styling approach:
       ```css
       .estimated {
         font-style: italic;
         opacity: 0.8;
       }
       ```
  </action>
  <verify>
    - HeatmapData type includes isEstimate?: boolean[]
    - correlation-heatmap.ts references isEstimate for display
    - `npm run build` completes without errors
  </verify>
  <done>Correlation heatmap displays "(est)" suffix or visual indicator for fallback values</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. calculateAssetStatistics returns isEstimate array
2. HeatmapData type includes isEstimate field
3. correlation-heatmap.ts displays visual indicator for estimated values
4. Build completes without errors
5. When an asset has no preset data, its return/volatility shows "(est)"
</verification>

<success_criteria>
VIZ-04 FIXED: Fallback values clearly labeled as estimates:
- calculateAssetStatistics returns `isEstimate: boolean[]`
- HeatmapData interface includes `isEstimate?: boolean[]`
- Correlation heatmap displays "(est)" suffix for assets using fallback 8%/16% values
- Users can distinguish calculated statistics from estimated defaults
</success_criteria>

<output>
After completion, create `.planning/phases/15-dashboard-gap-fixes/15-04-SUMMARY.md`
</output>
