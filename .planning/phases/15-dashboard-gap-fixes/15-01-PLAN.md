---
phase: 15-dashboard-gap-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/simulation/monte-carlo.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Percentile calculations use 0-100 scale (not 0-1)"
    - "P10 < P25 < P50 < P75 < P90 values are realistic portfolio values"
    - "SBLOC loan balance percentiles display correctly"
    - "Yearly percentiles display correctly in probability cone chart"
  artifacts:
    - path: "src/simulation/monte-carlo.ts"
      provides: "Corrected percentile() calls"
      contains: "percentile(yv, 10)"
  key_links:
    - from: "src/simulation/monte-carlo.ts"
      to: "src/math/statistics.ts"
      via: "percentile() function calls"
      pattern: "percentile\\(.*, (10|25|50|75|90)\\)"
---

<objective>
Fix GAP-01: Percentile Scale Mismatch in monte-carlo.ts

The percentile() function in statistics.ts expects values on the 0-100 scale, but monte-carlo.ts passes values on the 0-1 scale (0.1, 0.25, 0.5, 0.75, 0.9). This causes all percentile calculations to return extremely low values (near minimum).

Purpose: Correct all 13+ percentile() call sites to use proper 0-100 scale values.
Output: Corrected monte-carlo.ts with all percentiles calculating correctly.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-dashboard-calculations-review/14-GAP-FINDINGS.md

# Source file with bug
@src/simulation/monte-carlo.ts

# Reference for correct usage pattern
@src/calculations/metrics.ts (lines 151-155 show correct 0-100 scale)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix percentile scale in loanBalancesByYear calculation</name>
  <files>src/simulation/monte-carlo.ts</files>
  <action>
    Update lines 223-227 to use 0-100 scale for percentile calls:

    Change from:
    ```typescript
    loanBalance: {
      p10: loanBalancesByYear.map(yv => percentile(yv, 0.1)),
      p25: loanBalancesByYear.map(yv => percentile(yv, 0.25)),
      p50: loanBalancesByYear.map(yv => percentile(yv, 0.5)),
      p75: loanBalancesByYear.map(yv => percentile(yv, 0.75)),
      p90: loanBalancesByYear.map(yv => percentile(yv, 0.9)),
    },
    ```

    To:
    ```typescript
    loanBalance: {
      p10: loanBalancesByYear.map(yv => percentile(yv, 10)),
      p25: loanBalancesByYear.map(yv => percentile(yv, 25)),
      p50: loanBalancesByYear.map(yv => percentile(yv, 50)),
      p75: loanBalancesByYear.map(yv => percentile(yv, 75)),
      p90: loanBalancesByYear.map(yv => percentile(yv, 90)),
    },
    ```
  </action>
  <verify>Grep for "percentile(yv, 0." in monte-carlo.ts should return no matches for loanBalance section</verify>
  <done>loanBalance percentiles use 10, 25, 50, 75, 90 instead of 0.1, 0.25, 0.5, 0.75, 0.9</done>
</task>

<task type="auto">
  <name>Task 2: Fix percentile scale in medianLoan and statistics calculations</name>
  <files>src/simulation/monte-carlo.ts</files>
  <action>
    Update remaining percentile() calls to use 0-100 scale:

    Line 243 (cumulativeInterest median):
    - Change: `const medianLoan = percentile(yv, 0.5);`
    - To: `const medianLoan = percentile(yv, 50);`

    Line 254 (estateAnalysis median):
    - Change: `const medianLoan = percentile(finalStates.map(s => s?.loanBalance ?? 0), 0.5);`
    - To: `const medianLoan = percentile(finalStates.map(s => s?.loanBalance ?? 0), 50);`

    Line 335 (calculateStatistics median):
    - Change: `median: percentile(values, 0.5),`
    - To: `median: percentile(values, 50),`

    Lines 349-353 (calculateYearlyPercentiles):
    - Change all 0.1/0.25/0.5/0.75/0.9 to 10/25/50/75/90
  </action>
  <verify>Run `grep -n "percentile.*0\." src/simulation/monte-carlo.ts` should return no matches</verify>
  <done>All percentile() calls in monte-carlo.ts use 0-100 scale values</done>
</task>

<task type="auto">
  <name>Task 3: Verify fix with TypeScript compilation and test</name>
  <files>src/simulation/monte-carlo.ts</files>
  <action>
    1. Run TypeScript compilation to verify no type errors:
       `npm run build`

    2. If tests exist, run them:
       `npm test` (or skip if no simulation tests exist)

    3. Verify the pattern matches metrics.ts correct usage:
       Grep both files to confirm consistent 0-100 scale usage.
  </action>
  <verify>
    - `npm run build` completes without errors
    - Grep for "percentile.*[0-9][0-9])" shows consistent usage across codebase
  </verify>
  <done>TypeScript compiles successfully and percentile calls are consistent with metrics.ts pattern</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. No instances of `percentile(*, 0.X)` in monte-carlo.ts
2. All percentile calls use 10, 25, 50, 75, 90 values
3. Build completes without errors
4. Pattern matches metrics.ts lines 151-155
</verification>

<success_criteria>
GAP-01 FIXED: All 13+ percentile() calls in monte-carlo.ts corrected from 0-1 scale to 0-100 scale:
- `percentile(yv, 0.1)` -> `percentile(yv, 10)`
- `percentile(yv, 0.25)` -> `percentile(yv, 25)`
- `percentile(yv, 0.5)` -> `percentile(yv, 50)`
- `percentile(yv, 0.75)` -> `percentile(yv, 75)`
- `percentile(yv, 0.9)` -> `percentile(yv, 90)`
</success_criteria>

<output>
After completion, create `.planning/phases/15-dashboard-gap-fixes/15-01-SUMMARY.md`
</output>
