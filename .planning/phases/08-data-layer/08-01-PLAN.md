---
phase: 08-data-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/data/db.ts
  - src/data/schemas/portfolio.ts
  - src/data/schemas/market-data.ts
  - src/data/schemas/settings.ts
  - src/data/index.ts
autonomous: true

must_haves:
  truths:
    - "Database singleton initializes without error"
    - "Portfolio CRUD operations work (create, read, update, delete)"
    - "Market data can be stored and retrieved by symbol+source"
    - "Settings singleton can store API keys and preferences"
  artifacts:
    - path: "src/data/db.ts"
      provides: "Dexie database singleton with typed tables"
      contains: "class EveloDatabase extends Dexie"
    - path: "src/data/schemas/portfolio.ts"
      provides: "Portfolio and Asset interfaces for IndexedDB"
      exports: ["PortfolioRecord", "AssetRecord"]
    - path: "src/data/schemas/market-data.ts"
      provides: "Market data cache interface"
      exports: ["CachedMarketData", "DailyReturn"]
    - path: "src/data/schemas/settings.ts"
      provides: "User settings including API keys"
      exports: ["UserSettings"]
  key_links:
    - from: "src/data/db.ts"
      to: "src/data/schemas/*.ts"
      via: "imports interfaces for typed EntityTable"
      pattern: "import.*from.*schemas"
---

<objective>
Set up Dexie.js database with typed schemas for portfolios, market data cache, and user settings.

Purpose: Foundation for all data persistence in the app. Other plans depend on these schemas.
Output: Database singleton with three tables (portfolios, marketData, settings) and TypeScript interfaces.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-data-layer/08-RESEARCH.md

@src/types/portfolio.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Dexie.js and Bottleneck dependencies</name>
  <files>package.json</files>
  <action>
    Run: npm install dexie bottleneck

    These are the two core dependencies for Phase 8:
    - Dexie.js 4.x for IndexedDB (TypeScript-first, handles browser bugs)
    - Bottleneck 2.x for rate limiting (used in later plans for API clients)
  </action>
  <verify>npm ls dexie bottleneck shows both installed</verify>
  <done>Dependencies installed, package.json updated</done>
</task>

<task type="auto">
  <name>Task 2: Create database schemas</name>
  <files>src/data/schemas/portfolio.ts, src/data/schemas/market-data.ts, src/data/schemas/settings.ts</files>
  <action>
    Create src/data/schemas/ directory.

    **portfolio.ts:**
    - PortfolioRecord interface: id (auto), name, assets (AssetRecord[]), created, modified
    - AssetRecord interface: id, symbol, name, assetClass, weight
    - Note: Store dates as ISO strings for JSON serialization
    - Include version field for future migrations

    **market-data.ts:**
    - DailyReturn interface: date (string YYYY-MM-DD), return (number)
    - CachedMarketData interface: id (auto), symbol, source ('fmp'|'eodhd'|'alphavantage'|'tiingo'|'yahoo'), startDate, endDate, data (DailyReturn[]), fetchedAt
    - ApiSource type: 'fmp' | 'eodhd' | 'alphavantage' | 'tiingo' | 'yahoo'

    **settings.ts:**
    - UserSettings interface: id ('settings' singleton), corsProxyUrl?, apiKeys (partial record of API keys), preferredSource, theme
    - CorsProxyType: 'none' | 'allorigins' | 'corsproxy' | 'custom'
    - Default values helper function
  </action>
  <verify>tsc --noEmit passes</verify>
  <done>All schema interfaces export and compile</done>
</task>

<task type="auto">
  <name>Task 3: Create Dexie database singleton</name>
  <files>src/data/db.ts, src/data/index.ts</files>
  <action>
    **db.ts:**
    Import Dexie and EntityTable from 'dexie'.
    Import all schema interfaces.

    Create EveloDatabase class extending Dexie:
    - portfolios table: EntityTable<PortfolioRecord, 'id'>
    - marketData table: EntityTable<CachedMarketData, 'id'>
    - settings table: EntityTable<UserSettings, 'id'>

    Schema version 1:
    - portfolios: '++id, name, modified'
    - marketData: '++id, [symbol+source], fetchedAt'
    - settings: 'id'

    Export singleton: export const db = new EveloDatabase();

    Add Safari IndexedDB workaround at module level:
    ```typescript
    // Safari lazy-load workaround
    if (typeof window !== 'undefined' && 'indexedDB' in window) {
      window.indexedDB.open('__safari_workaround');
    }
    ```

    **index.ts:**
    Barrel export: export * from './db', export * from './schemas/...'
  </action>
  <verify>npm run build succeeds, database exports correctly</verify>
  <done>Database singleton created with typed tables and Safari workaround</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm install dexie bottleneck succeeds
- [ ] npm run build succeeds
- [ ] All schema interfaces export from src/data/index.ts
- [ ] Database class extends Dexie with typed EntityTable fields
</verification>

<success_criteria>
- Dependencies installed (dexie, bottleneck)
- Three schema files with TypeScript interfaces
- Database singleton with version 1 schema
- Barrel export from src/data/index.ts
</success_criteria>

<output>
After completion, create `.planning/phases/08-data-layer/08-01-SUMMARY.md`
</output>
