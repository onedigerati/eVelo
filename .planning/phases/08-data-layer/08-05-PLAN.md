---
phase: 08-data-layer
plan: 05
type: execute
wave: 3
depends_on: ["08-03"]
files_modified:
  - src/data/api/cors-proxy.ts
  - src/data/api/yahoo-api.ts
  - src/data/services/settings-service.ts
  - src/data/api/index.ts
  - src/data/services/index.ts
  - src/data/index.ts
autonomous: true

must_haves:
  truths:
    - "User can configure CORS proxy (none, allorigins, corsproxy, custom)"
    - "API calls use configured CORS proxy"
    - "Yahoo Finance client works as fallback"
    - "Settings persist in IndexedDB"
    - "API keys are stored securely in IndexedDB (not localStorage)"
  artifacts:
    - path: "src/data/api/cors-proxy.ts"
      provides: "CORS proxy URL generation utilities"
      exports: ["getCorsProxyUrl", "CORS_PROXY_OPTIONS", "CorsProxyConfig"]
    - path: "src/data/api/yahoo-api.ts"
      provides: "Yahoo Finance fallback client"
      exports: ["YahooApiClient"]
    - path: "src/data/services/settings-service.ts"
      provides: "User settings management"
      exports: ["getSettings", "saveSettings", "getApiKey", "setApiKey"]
  key_links:
    - from: "src/data/services/settings-service.ts"
      to: "src/data/db.ts"
      via: "db.settings table operations"
      pattern: "db\\.settings"
    - from: "src/data/api/*-api.ts"
      to: "src/data/api/cors-proxy.ts"
      via: "imports getCorsProxyUrl"
      pattern: "getCorsProxyUrl"
---

<objective>
Create CORS proxy configuration, Yahoo Finance fallback client, and settings persistence service.

Purpose: Enable API access from browser (CORS) and provide fallback when primary APIs unavailable.
Output: CORS proxy utilities, Yahoo client, and settings service with API key storage.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-data-layer/08-RESEARCH.md
@.planning/phases/08-data-layer/08-01-PLAN.md
@.planning/phases/08-data-layer/08-03-PLAN.md

@src/data/db.ts
@src/data/schemas/settings.ts
@src/data/api/base-api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CORS proxy configuration utilities</name>
  <files>src/data/api/cors-proxy.ts</files>
  <action>
    Types:
    - CorsProxyType: 'none' | 'allorigins' | 'corsproxy' | 'custom'
    - CorsProxyConfig: { type: CorsProxyType, customUrl?: string }

    Constants:
    - CORS_PROXY_OPTIONS object with functions for each proxy type:
      - none: (url) => url
      - allorigins: (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`
      - corsproxy: (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`
      - custom: (url) => url (uses customUrl prefix)

    Functions:

    getCorsProxyUrl(config: CorsProxyConfig): string | undefined
    - If type === 'none', return undefined
    - If type === 'custom' && customUrl, return customUrl (ensure trailing slash)
    - Otherwise return the proxy prefix for the type

    wrapUrlWithProxy(url: string, config: CorsProxyConfig): string
    - If config.type === 'none', return url unchanged
    - If config.type === 'custom', return customUrl + encodeURIComponent(url)
    - Otherwise use CORS_PROXY_OPTIONS[config.type](url)

    Note: Different proxies have different URL encoding requirements.
    allorigins uses raw?url=encoded, corsproxy uses /?encoded
  </action>
  <verify>tsc --noEmit passes, exports compile</verify>
  <done>CORS proxy configuration utilities created</done>
</task>

<task type="auto">
  <name>Task 2: Create Yahoo Finance fallback client</name>
  <files>src/data/api/yahoo-api.ts</files>
  <action>
    YahooApiClient extends RateLimitedApiClient.

    Note: Yahoo Finance has no official API. This uses the chart endpoint which may break.
    Use conservative rate limiting and treat as last-resort fallback.

    Rate limits (conservative):
    - maxConcurrent: 1
    - minTime: 2000 (1 request per 2 seconds)
    - No daily limit, but be conservative

    Constructor takes corsProxyUrl?: string (Yahoo requires CORS proxy from browser).

    getHistoricalData implementation:
    - URL: https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?period1=${startTimestamp}&period2=${endTimestamp}&interval=1d
    - period1/period2 are Unix timestamps (seconds)
    - Convert startDate/endDate strings to timestamps

    Response parsing (handle carefully - structure changes):
    - Response has: chart.result[0].timestamp[] and chart.result[0].indicators.adjclose[0].adjclose[]
    - Zip timestamps with adjclose values
    - Convert timestamps to YYYY-MM-DD dates
    - Calculate returns from adjacent adjclose values

    Error handling:
    - Check chart.error exists and throw descriptive error
    - Check result array is not empty
    - Gracefully handle missing adjclose data

    Export a warning constant:
    - YAHOO_DISCLAIMER = "Yahoo Finance is an unofficial API that may stop working without notice"
  </action>
  <verify>tsc --noEmit passes, YahooApiClient exports</verify>
  <done>Yahoo Finance fallback client created with disclaimer</done>
</task>

<task type="auto">
  <name>Task 3: Create settings service</name>
  <files>src/data/services/settings-service.ts, src/data/services/index.ts, src/data/index.ts</files>
  <action>
    Import db from '../db'.
    Import UserSettings from schemas.
    Import CorsProxyConfig from api/cors-proxy.

    Constants:
    - SETTINGS_ID = 'settings' as const (singleton key)
    - DEFAULT_SETTINGS: UserSettings with sensible defaults

    Functions:

    getSettings(): Promise<UserSettings>
    - Get from db.settings.get(SETTINGS_ID)
    - If not found, return DEFAULT_SETTINGS

    saveSettings(settings: Partial<UserSettings>): Promise<void>
    - Merge with existing settings
    - Always set id = SETTINGS_ID
    - Use db.settings.put()

    API key helpers:

    getApiKey(source: ApiSource): Promise<string | undefined>
    - Get settings, return apiKeys[source]

    setApiKey(source: ApiSource, key: string): Promise<void>
    - Update just that API key in settings

    clearApiKey(source: ApiSource): Promise<void>
    - Remove that API key

    CORS proxy helpers:

    getCorsConfig(): Promise<CorsProxyConfig>
    - Get settings, return { type: settings.corsProxyType, customUrl: settings.corsProxyUrl }

    setCorsConfig(config: CorsProxyConfig): Promise<void>
    - Update CORS settings

    Update services/index.ts to export settings-service.
    Update api/index.ts to export cors-proxy and yahoo-api.
    Update src/data/index.ts to be complete barrel export of all data modules.
  </action>
  <verify>npm run build succeeds, all modules export correctly</verify>
  <done>Settings service with API key and CORS management created</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds
- [ ] CORS proxy utilities export from src/data/api/cors-proxy.ts
- [ ] YahooApiClient exports from src/data/api/yahoo-api.ts
- [ ] Settings service exports: getSettings, saveSettings, getApiKey, setApiKey, getCorsConfig, setCorsConfig
- [ ] src/data/index.ts exports all data layer modules
</verification>

<success_criteria>
- CORS proxy supports 4 modes (none, allorigins, corsproxy, custom)
- Yahoo Finance client works as fallback with proper error handling
- Settings persist as singleton in IndexedDB
- API keys stored in IndexedDB, not localStorage
- Complete data layer exports from src/data/index.ts
</success_criteria>

<output>
After completion, create `.planning/phases/08-data-layer/08-05-SUMMARY.md`
</output>
