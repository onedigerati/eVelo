---
phase: 08-data-layer
plan: 04
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/data/services/portfolio-service.ts
  - src/data/services/index.ts
autonomous: true

must_haves:
  truths:
    - "User can save portfolio to IndexedDB"
    - "User can load portfolio from IndexedDB"
    - "User can export portfolio as JSON file download"
    - "User can import portfolio from JSON file"
    - "Imported portfolios are validated before storing"
  artifacts:
    - path: "src/data/services/portfolio-service.ts"
      provides: "Portfolio CRUD and export/import operations"
      exports: ["savePortfolio", "loadPortfolio", "exportPortfolios", "importPortfolios", "downloadAsFile"]
  key_links:
    - from: "src/data/services/portfolio-service.ts"
      to: "src/data/db.ts"
      via: "db.portfolios table operations"
      pattern: "db\\.portfolios"
---

<objective>
Create portfolio service for save/load/export/import operations with IndexedDB persistence.

Purpose: Enable users to save their portfolio configurations and transfer them between devices via export/import.
Output: Portfolio service with CRUD operations and JSON file export/import.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-data-layer/08-RESEARCH.md
@.planning/phases/08-data-layer/08-01-PLAN.md

@src/data/db.ts
@src/data/schemas/portfolio.ts
@src/types/portfolio.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create portfolio CRUD operations</name>
  <files>src/data/services/portfolio-service.ts</files>
  <action>
    Import db from '../db'.
    Import PortfolioRecord from schemas.

    CRUD functions:

    savePortfolio(portfolio: Omit<PortfolioRecord, 'id'>): Promise<number>
    - Set modified = new Date().toISOString()
    - If portfolio has id, update existing; otherwise create new
    - Return db.portfolios.put(portfolio)

    loadPortfolio(id: number): Promise<PortfolioRecord | undefined>
    - Return db.portfolios.get(id)

    loadAllPortfolios(): Promise<PortfolioRecord[]>
    - Return db.portfolios.orderBy('modified').reverse().toArray()

    deletePortfolio(id: number): Promise<void>
    - Return db.portfolios.delete(id)

    updatePortfolioName(id: number, name: string): Promise<void>
    - Update name and modified timestamp
  </action>
  <verify>tsc --noEmit passes, CRUD functions export</verify>
  <done>Portfolio CRUD operations created</done>
</task>

<task type="auto">
  <name>Task 2: Create export/import functionality</name>
  <files>src/data/services/portfolio-service.ts</files>
  <action>
    Add to portfolio-service.ts:

    Constants:
    - EXPORT_VERSION = 1

    Interfaces:
    - PortfolioExport: { version: number, exportedAt: string, portfolios: PortfolioRecord[] }

    Export functions:

    exportPortfolios(portfolios: PortfolioRecord[]): string
    - Create PortfolioExport object with version, exportedAt ISO string
    - Strip auto-generated IDs from portfolios (set to undefined)
    - Return JSON.stringify with indent=2 for readability

    importPortfolios(json: string): PortfolioRecord[]
    - Parse JSON
    - Validate version <= EXPORT_VERSION (throw if newer)
    - Validate portfolios is array
    - Validate each portfolio has required fields (name, assets)
    - Strip IDs (let Dexie assign new ones)
    - Set created to original, modified to now
    - Return validated portfolios array

    validatePortfolio(p: unknown): p is PortfolioRecord
    - Check required fields exist and have correct types
    - Check assets array is valid
    - Check weights sum to approximately 1 (within 0.01 tolerance)
  </action>
  <verify>tsc --noEmit passes, export/import functions work</verify>
  <done>Export/import with validation created</done>
</task>

<task type="auto">
  <name>Task 3: Create file download/upload helpers</name>
  <files>src/data/services/portfolio-service.ts, src/data/services/index.ts</files>
  <action>
    Add to portfolio-service.ts:

    downloadAsFile(content: string, filename: string): void
    - Create Blob with type 'application/json'
    - Create object URL
    - Create anchor element, set href and download attribute
    - Programmatically click to trigger download
    - Revoke object URL

    readFileAsText(file: File): Promise<string>
    - Return new Promise
    - Create FileReader
    - onload: resolve with reader.result as string
    - onerror: reject with reader.error
    - Call reader.readAsText(file)

    Convenience functions:

    exportAndDownload(portfolios: PortfolioRecord[], filename?: string): void
    - Default filename: `evelo-portfolios-${date}.json`
    - Call exportPortfolios then downloadAsFile

    importFromFile(file: File): Promise<PortfolioRecord[]>
    - Call readFileAsText then importPortfolios
    - Catch JSON parse errors and throw user-friendly message

    bulkImportPortfolios(portfolios: PortfolioRecord[]): Promise<number[]>
    - Use db.portfolios.bulkAdd
    - Return array of new IDs

    Update services/index.ts to export all portfolio-service functions.
  </action>
  <verify>npm run build succeeds, all portfolio functions export</verify>
  <done>File helpers and convenience functions created</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds
- [ ] CRUD operations: savePortfolio, loadPortfolio, loadAllPortfolios, deletePortfolio
- [ ] Export/import: exportPortfolios, importPortfolios with validation
- [ ] File helpers: downloadAsFile, readFileAsText
- [ ] Convenience: exportAndDownload, importFromFile, bulkImportPortfolios
</verification>

<success_criteria>
- All CRUD operations work with IndexedDB
- Export produces valid JSON with version and metadata
- Import validates schema and rejects invalid files
- File download triggers browser save dialog
- File upload parses and validates content
</success_criteria>

<output>
After completion, create `.planning/phases/08-data-layer/08-04-SUMMARY.md`
</output>
