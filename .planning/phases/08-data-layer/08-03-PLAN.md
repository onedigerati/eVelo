---
phase: 08-data-layer
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/data/api/rate-limits.ts
  - src/data/api/base-api.ts
  - src/data/api/fmp-api.ts
  - src/data/api/eodhd-api.ts
  - src/data/api/alpha-vantage-api.ts
  - src/data/api/tiingo-api.ts
  - src/data/api/index.ts
  - src/data/services/market-data-service.ts
autonomous: true

must_haves:
  truths:
    - "API calls are rate-limited per provider's free tier limits"
    - "Market data is cached in IndexedDB after fetch"
    - "Cached data is returned without API call if fresh"
    - "API errors are caught and reported gracefully"
  artifacts:
    - path: "src/data/api/base-api.ts"
      provides: "Rate-limited API client base class"
      exports: ["RateLimitedApiClient", "ApiConfig"]
    - path: "src/data/api/fmp-api.ts"
      provides: "Financial Modeling Prep API client"
      exports: ["FmpApiClient"]
    - path: "src/data/services/market-data-service.ts"
      provides: "Cache-aware market data fetching"
      exports: ["getCachedOrFetch", "fetchMarketData"]
  key_links:
    - from: "src/data/api/*-api.ts"
      to: "src/data/api/base-api.ts"
      via: "extends RateLimitedApiClient"
      pattern: "extends RateLimitedApiClient"
    - from: "src/data/services/market-data-service.ts"
      to: "src/data/db.ts"
      via: "uses db.marketData for caching"
      pattern: "db\\.marketData"
---

<objective>
Create rate-limited API clients for financial data providers with IndexedDB caching layer.

Purpose: Enable fetching historical market data from multiple providers with proper rate limiting and caching.
Output: Four API clients (FMP, EODHD, Alpha Vantage, Tiingo) and market data service with caching.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-data-layer/08-RESEARCH.md
@.planning/phases/08-data-layer/08-01-PLAN.md

@src/data/db.ts
@src/data/schemas/market-data.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create rate limiting configuration and base API client</name>
  <files>src/data/api/rate-limits.ts, src/data/api/base-api.ts</files>
  <action>
    Create src/data/api/ directory.

    **rate-limits.ts:**
    Export API_RATE_LIMITS const with per-provider limits:
    - fmp: { maxConcurrent: 1, reservoir: 250, reservoirRefreshInterval: 24*60*60*1000 }
    - eodhd: { maxConcurrent: 5, reservoir: 20, reservoirRefreshInterval: 24*60*60*1000 }
    - alphaVantage: { maxConcurrent: 1, reservoir: 25, reservoirRefreshInterval: 24*60*60*1000, minTime: 12000 }
    - tiingo: { maxConcurrent: 2, reservoir: 50, reservoirRefreshInterval: 60*60*1000 }

    **base-api.ts:**
    Import Bottleneck from 'bottleneck'.
    Import DailyReturn from schemas.

    ApiConfig interface: maxConcurrent, reservoirAmount?, reservoirRefreshInterval?, minTime?, corsProxyUrl?

    Abstract class RateLimitedApiClient:
    - protected limiter: Bottleneck
    - protected corsProxyUrl?: string
    - constructor(config: ApiConfig) - initialize Bottleneck with config
    - protected async fetch<T>(url: string, options?: RequestInit): Promise<T>
      - Wrap in limiter.schedule()
      - Prepend corsProxyUrl if configured
      - Handle response.ok check, throw on error
      - Return response.json()
    - abstract getHistoricalData(symbol: string, startDate: string, endDate: string): Promise<DailyReturn[]>

    Log rate limit events via limiter.on('failed').
  </action>
  <verify>tsc --noEmit passes, Bottleneck import resolves</verify>
  <done>Rate limits defined and base API client created</done>
</task>

<task type="auto">
  <name>Task 2: Create FMP and EODHD API clients</name>
  <files>src/data/api/fmp-api.ts, src/data/api/eodhd-api.ts</files>
  <action>
    **fmp-api.ts:**
    FmpApiClient extends RateLimitedApiClient.

    Constructor takes apiKey: string, corsProxyUrl?: string.
    Initializes with API_RATE_LIMITS.fmp settings.

    getHistoricalData implementation:
    - URL: https://financialmodelingprep.com/stable/historical-price-eod/full?symbol=${symbol}&from=${startDate}&to=${endDate}&apikey=${apiKey}
    - Response type: { historical: { date, changePercent, ... }[] }
    - Map to DailyReturn[]: { date, return: changePercent / 100 }
    - FMP returns newest first, so reverse the array

    **eodhd-api.ts:**
    EodhdApiClient extends RateLimitedApiClient.

    Constructor takes apiKey: string, corsProxyUrl?: string.
    Initializes with API_RATE_LIMITS.eodhd settings.

    getHistoricalData implementation:
    - EODHD uses exchange suffix: symbol.includes('.') ? symbol : `${symbol}.US`
    - URL: https://eodhd.com/api/eod/${fullSymbol}?from=${startDate}&to=${endDate}&api_token=${apiKey}&fmt=json
    - Response type: { date, adjusted_close, ... }[]
    - Calculate returns from adjusted_close: (curr - prev) / prev
    - Return DailyReturn[] (already in chronological order)
  </action>
  <verify>tsc --noEmit passes, both classes extend base correctly</verify>
  <done>FMP and EODHD API clients created</done>
</task>

<task type="auto">
  <name>Task 3: Create Alpha Vantage and Tiingo API clients</name>
  <files>src/data/api/alpha-vantage-api.ts, src/data/api/tiingo-api.ts, src/data/api/index.ts</files>
  <action>
    **alpha-vantage-api.ts:**
    AlphaVantageApiClient extends RateLimitedApiClient.

    Constructor takes apiKey: string, corsProxyUrl?: string.
    Initializes with API_RATE_LIMITS.alphaVantage settings.

    getHistoricalData implementation:
    - URL: https://www.alphavantage.co/query?function=TIME_SERIES_DAILY_ADJUSTED&symbol=${symbol}&outputsize=full&apikey=${apiKey}
    - Response type: { 'Time Series (Daily)': Record<string, { '5. adjusted close': string, ... }> }
    - Sort dates chronologically
    - Calculate returns from adjusted close values
    - Filter to requested date range

    **tiingo-api.ts:**
    TiingoApiClient extends RateLimitedApiClient.

    Constructor takes apiKey: string, corsProxyUrl?: string.
    Initializes with API_RATE_LIMITS.tiingo settings.

    getHistoricalData implementation:
    - Override fetch for header-based auth
    - URL: https://api.tiingo.com/tiingo/daily/${symbol}/prices?startDate=${startDate}&endDate=${endDate}
    - Headers: { 'Authorization': `Token ${apiKey}`, 'Content-Type': 'application/json' }
    - Response type: { date, adjClose, ... }[]
    - Calculate returns from adjClose
    - Parse date: split('T')[0] to get YYYY-MM-DD

    **api/index.ts:**
    Barrel export all API clients and types.
  </action>
  <verify>tsc --noEmit passes, all four API clients export</verify>
  <done>All four API clients created and exported</done>
</task>

<task type="auto">
  <name>Task 4: Create market data service with caching</name>
  <files>src/data/services/market-data-service.ts</files>
  <action>
    Import db from '../db'.
    Import DailyReturn, ApiSource, CachedMarketData from schemas.
    Import all API clients.

    Constants:
    - CACHE_DURATION_DAYS = 7

    getCachedOrFetch function:
    - Parameters: symbol, source, startDate, endDate, fetchFn
    - Query db.marketData.where('[symbol+source]').equals([symbol, source]).first()
    - If cached exists and fetchedAt > (now - CACHE_DURATION_DAYS), filter and return cached data
    - Otherwise call fetchFn, store result in db.marketData.put(), return fresh data

    fetchMarketData function:
    - Parameters: symbol, source, startDate, endDate, apiKey, corsProxyUrl?
    - Switch on source to instantiate appropriate API client
    - Wrap in getCachedOrFetch for automatic caching
    - Return Promise<DailyReturn[]>

    clearCache function:
    - Parameters: symbol?, source?
    - Clear all or filtered cached data

    getCacheStats function:
    - Return count and total size of cached data

    Update services/index.ts to export market-data-service.
  </action>
  <verify>npm run build succeeds, service exports all functions</verify>
  <done>Market data service with caching created</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds
- [ ] All four API clients extend RateLimitedApiClient
- [ ] market-data-service exports getCachedOrFetch, fetchMarketData, clearCache
- [ ] src/data/index.ts exports all API and service modules
</verification>

<success_criteria>
- Four API clients (FMP, EODHD, Alpha Vantage, Tiingo) with rate limiting
- Market data service with IndexedDB caching
- 7-day cache expiration
- All exports available from src/data/index.ts
</success_criteria>

<output>
After completion, create `.planning/phases/08-data-layer/08-03-SUMMARY.md`
</output>
