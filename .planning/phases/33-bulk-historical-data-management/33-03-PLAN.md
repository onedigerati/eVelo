---
phase: 33-bulk-historical-data-management
plan: 03
type: execute
wave: 3
depends_on: ["33-01", "33-02"]
files_modified:
  - src/components/ui/historical-data-viewer.ts
autonomous: true

must_haves:
  truths:
    - "User can access bulk operations from historical data viewer"
    - "Bulk import shows preview before committing"
    - "Reset all to defaults has two-step confirmation"
    - "Individual asset reset to defaults works"
  artifacts:
    - path: "src/components/ui/historical-data-viewer.ts"
      provides: "Extended viewer with bulk mode"
      min_lines: 1100
  key_links:
    - from: "src/components/ui/historical-data-viewer.ts"
      to: "src/data/services/bulk-export-service.ts"
      via: "exportAllToCsv import"
      pattern: "exportAllToCsv|exportAllToJson"
    - from: "src/components/ui/historical-data-viewer.ts"
      to: "src/components/ui/bulk-preview-table.ts"
      via: "component usage"
      pattern: "bulk-preview-table"
    - from: "src/components/ui/historical-data-viewer.ts"
      to: "src/data/formats/bulk-format-templates.ts"
      via: "template download"
      pattern: "downloadCsvTemplate|downloadJsonTemplate"
---

<objective>
Integrate bulk operations into the historical data viewer modal.

Purpose: Extend the existing HistoricalDataViewer with bulk mode for multi-asset import/export, preview-before-commit workflow, reset-all-to-defaults with two-step confirmation, and template downloads.

Output: Updated historical-data-viewer.ts with bulk operations tab/section, preview integration, and reset functionality.
</objective>

<execution_context>
@C:\Users\ungac\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ungac\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-bulk-historical-data-management/33-RESEARCH.md
@.planning/phases/33-bulk-historical-data-management/33-01-PLAN.md
@.planning/phases/33-bulk-historical-data-management/33-02-PLAN.md

# Existing component to extend
@src/components/ui/historical-data-viewer.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add bulk mode to historical data viewer</name>
  <files>src/components/ui/historical-data-viewer.ts</files>
  <action>
Extend HistoricalDataViewer with bulk operations mode:

1. Add new private properties:
   - _viewMode: 'view' | 'import' | 'bulk' = 'view'
   - _bulkValidationResult: BulkValidationResult | null = null
   - _showResetAllConfirm: boolean = false
   - _resetAllCheckbox: boolean = false

2. Add imports at top:
   - Import { exportAllToCsv, exportAllToJson } from bulk-export-service
   - Import { validateBulkCsv, validateBulkJson, type BulkValidationResult } from data-validator
   - Import { saveAllCustomData, resetAllToDefaults, getCustomSymbols } from custom-data-service
   - Import { downloadCsvTemplate, downloadJsonTemplate } from bulk-format-templates
   - Import './bulk-preview-table' to ensure component is registered

3. Add new renderBulkMode() method:
   - Header: "Bulk Operations"
   - Section: Bulk Export
     - Description: "Export all assets to a single file for backup or editing"
     - Two buttons: "Export All as CSV" and "Export All as JSON"
   - Section: Bulk Import
     - Description: "Import multiple assets at once from a single file"
     - Template download buttons: "Download CSV Template" and "Download JSON Template"
     - file-drop-zone component (reuse existing)
     - If _bulkValidationResult, show bulk-preview-table component
   - Section: Reset to Defaults
     - Description: "Delete all custom data and restore bundled defaults"
     - If no custom data: "No custom data to reset"
     - If custom data exists: Show count and "Reset All to Defaults" button (danger style)

4. Add renderResetAllConfirmation() method:
   - Modal overlay within the main modal
   - Warning message: "This will permanently delete custom data for X assets"
   - Checkbox: "I understand this cannot be undone"
   - Cancel button, Confirm button (disabled until checkbox checked)

5. Update template() method:
   - Add mode tab/toggle at top: "Single Asset" | "Bulk Operations"
   - Render appropriate mode content

6. Update renderFooterButtons():
   - In bulk mode: "Back to Single Asset" button, "Done" button

7. Add event handlers in afterRender():
   - Bulk export CSV button: call handleBulkExportCsv()
   - Bulk export JSON button: call handleBulkExportJson()
   - Template download buttons: call downloadCsvTemplate/downloadJsonTemplate
   - Bulk file drop: call handleBulkFileSelected(file)
   - Preview table events: preview-cancelled, preview-confirmed
   - Reset all button: show confirmation
   - Reset all confirm checkbox: toggle _resetAllCheckbox, enable/disable button
   - Reset all confirm button: call handleResetAll()

8. Add handler methods:
   - handleBulkExportCsv(): Call exportAllToCsv(), create blob, download
   - handleBulkExportJson(): Call exportAllToJson(), create blob, download
   - handleBulkFileSelected(file): Validate with validateBulkCsv/Json, set _bulkValidationResult
   - handleBulkPreviewConfirmed(validRows): Call saveAllCustomData, show success, refresh
   - handleResetAll(): Call resetAllToDefaults, dispatch event, refresh

9. Style updates:
   - Mode toggle/tabs styling
   - Bulk sections with proper spacing
   - Reset confirmation modal styling
   - Action button styling (danger for reset)
  </action>
  <verify>
npm run build passes.
Historical data viewer opens in both single and bulk modes.
  </verify>
  <done>
Bulk mode accessible via mode toggle.
Bulk export generates CSV/JSON with all assets.
Bulk import shows preview table before committing.
Reset all requires checkbox confirmation.
Template downloads work.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire bulk preview and confirmation flow</name>
  <files>src/components/ui/historical-data-viewer.ts</files>
  <action>
Complete the bulk import flow with preview integration:

1. In handleBulkFileSelected(file: File):
   - Read file content with file.text()
   - Detect format (JSON if .json extension, otherwise CSV)
   - Call validateBulkCsv or validateBulkJson
   - Set _bulkValidationResult
   - Render to show preview table

2. Configure bulk-preview-table in template:
   - Transform BulkValidationResult.assets to PreviewRow format
   - Pass rows property to component
   - Listen for preview-cancelled event: clear _bulkValidationResult, render
   - Listen for preview-confirmed event: call handleBulkPreviewConfirmed

3. In handleBulkPreviewConfirmed(event):
   - Extract validRows from event.detail
   - Map rows to PresetData format
   - Call saveAllCustomData with mapped data
   - Show success toast notification
   - Dispatch 'bulk-data-imported' event with count
   - Clear _bulkValidationResult
   - Switch to view mode or show success state

4. In handleResetAll():
   - Call resetAllToDefaults() (returns deleted count)
   - Hide confirmation modal
   - Show success toast with count
   - Dispatch 'all-data-reset' event with count
   - Reload data (call loadData or equivalent)

5. Add individual asset reset enhancement:
   - Existing resetToDefaults button already works
   - Add confirmation for consistency (optional - simple confirm() is acceptable)

6. Success state handling:
   - After bulk import: Show summary of imported assets
   - After reset all: Return to view mode showing bundled data
  </action>
  <verify>
npm run build passes.
Full bulk import flow: select file -> preview -> confirm -> save works.
Reset all flow: click -> checkbox -> confirm -> cleared works.
  </verify>
  <done>
Bulk import preview shows add/update/skip per asset.
Confirm imports only valid assets, skips invalid ones.
Success notification shows count of imported assets.
Reset all requires checkbox check before confirmation is enabled.
Events dispatched for integration with parent components.
  </done>
</task>

</tasks>

<verification>
1. npm run build completes without errors
2. Historical data viewer has bulk mode toggle
3. Bulk export downloads work (CSV and JSON)
4. Bulk import shows preview table with per-asset status
5. Confirm only imports valid assets
6. Reset all requires two-step confirmation
7. Template downloads work
</verification>

<success_criteria>
- User can switch between single asset and bulk operations modes
- Bulk export generates single file with all assets
- Bulk import shows preview with add/update/skip actions
- Only valid assets are imported on confirm
- Reset all requires checkbox + button confirmation
- Template downloads provide format guidance
- Events dispatched for parent component integration
</success_criteria>

<output>
After completion, create `.planning/phases/33-bulk-historical-data-management/33-03-SUMMARY.md`
</output>
