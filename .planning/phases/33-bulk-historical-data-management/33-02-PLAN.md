---
phase: 33-bulk-historical-data-management
plan: 02
type: execute
wave: 2
depends_on: ["33-01"]
files_modified:
  - src/components/ui/bulk-preview-table.ts
  - src/data/formats/bulk-format-templates.ts
autonomous: true

must_haves:
  truths:
    - "Preview table shows add/update/skip action per asset"
    - "Template downloads provide pre-filled example data"
    - "User can expand asset row to see validation details"
  artifacts:
    - path: "src/components/ui/bulk-preview-table.ts"
      provides: "Preview table component for bulk import"
      min_lines: 150
    - path: "src/data/formats/bulk-format-templates.ts"
      provides: "Template constants and download functions"
      exports: ["BULK_CSV_TEMPLATE", "BULK_JSON_TEMPLATE", "downloadCsvTemplate", "downloadJsonTemplate"]
  key_links:
    - from: "src/components/ui/bulk-preview-table.ts"
      to: "src/data/validation/data-validator.ts"
      via: "BulkValidationResult import"
      pattern: "BulkValidationResult|AssetValidationResult"
    - from: "src/data/formats/bulk-format-templates.ts"
      to: "Blob API"
      via: "download function"
      pattern: "URL.createObjectURL"
---

<objective>
Create the bulk preview table component and format template downloads.

Purpose: Enable users to see what will change before committing a bulk import, with expandable per-asset validation details. Provide downloadable CSV/JSON templates with example data for easy onboarding.

Output: New bulk-preview-table.ts component displaying add/update/skip actions per asset, and bulk-format-templates.ts with template constants and download functions.
</objective>

<execution_context>
@C:\Users\ungac\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ungac\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-bulk-historical-data-management/33-RESEARCH.md
@.planning/phases/33-bulk-historical-data-management/33-01-PLAN.md

# Existing patterns
@src/components/base-component.ts
@src/data/validation/data-validator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bulk preview table component</name>
  <files>src/components/ui/bulk-preview-table.ts</files>
  <action>
Create BulkPreviewTable component extending BaseComponent with:

1. Interface PreviewRow:
   - symbol: string
   - name: string
   - action: 'add' | 'update' | 'skip'
   - recordCount: number
   - status: 'valid' | 'warning' | 'error'
   - errors?: ValidationError[]
   - warnings?: ValidationWarning[]

2. Private properties:
   - _rows: PreviewRow[] = []
   - _expandedSymbols: Set<string> = new Set()

3. Public setter: set rows(value: PreviewRow[])
   - Updates _rows and calls render()

4. template() returns:
   - Table with columns: Symbol, Name, Action, Records, Status
   - Each row shows action badge (ADD/UPDATE/SKIP with color coding)
   - Status icon: checkmark for valid, warning for warning, X for error
   - Expand button if row has errors/warnings
   - Summary section: "X of Y assets ready to import"
   - Footer buttons: Cancel (btn-secondary), Import Valid Assets (X) (btn-primary, disabled if 0 valid)

5. renderRow(row) method:
   - Apply status class (status-valid, status-warning, status-error)
   - Action badge classes: action-add (green), action-update (teal), action-skip (gray)
   - Include expand/collapse button if errors or warnings exist

6. renderExpandedDetails(row) method:
   - Show errors list with error-item class
   - Show warnings list with warning-item class
   - Use colspan=5 for expanded row

7. afterRender() method:
   - Wire expand/collapse toggle buttons (click toggles symbol in _expandedSymbols set)
   - Wire cancel button: dispatch 'preview-cancelled' CustomEvent
   - Wire confirm button: dispatch 'preview-confirmed' CustomEvent with validRows in detail

8. styles() method:
   - Table styling matching existing modal patterns
   - Action badge styles (colored backgrounds)
   - Status indicator styles
   - Expanded details row styling
   - Dark theme support via :host-context([data-theme="dark"])

Register with customElements.define('bulk-preview-table', BulkPreviewTable)
  </action>
  <verify>
npm run build passes.
Component renders without errors when rows property is set.
  </verify>
  <done>
BulkPreviewTable displays add/update/skip per row with validation status.
Expand/collapse shows errors and warnings per asset.
Cancel and Confirm buttons dispatch appropriate events.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create format templates and download functions</name>
  <files>src/data/formats/bulk-format-templates.ts</files>
  <action>
Create new file src/data/formats/bulk-format-templates.ts with:

1. BULK_CSV_TEMPLATE constant (string):
```
symbol,name,asset_class,year,annual_return
SPY,S&P 500 ETF Trust,equity_index,1995,0.3758
SPY,S&P 500 ETF Trust,equity_index,1996,0.2296
SPY,S&P 500 ETF Trust,equity_index,1997,0.3336
SPY,S&P 500 ETF Trust,equity_index,1998,0.2858
SPY,S&P 500 ETF Trust,equity_index,1999,0.2104
CUSTOM1,My Custom Asset,equity_stock,2020,0.1250
CUSTOM1,My Custom Asset,equity_stock,2021,-0.0320
CUSTOM1,My Custom Asset,equity_stock,2022,0.0890
CUSTOM1,My Custom Asset,equity_stock,2023,0.2650
CUSTOM1,My Custom Asset,equity_stock,2024,0.1580
```
(5 years per asset to meet minimum requirement)

2. BULK_JSON_TEMPLATE constant (object):
{
  version: 1,
  exportedAt: "(generated on download)",
  assets: [
    {
      symbol: "SPY",
      name: "S&P 500 ETF Trust",
      assetClass: "equity_index",
      returns: [ 5 sample returns with dates and values ]
    },
    {
      symbol: "CUSTOM1",
      name: "My Custom Asset",
      assetClass: "equity_stock",
      returns: [ 5 sample returns ]
    }
  ]
}

3. downloadCsvTemplate(): void
   - Create Blob with BULK_CSV_TEMPLATE, type 'text/csv'
   - Create object URL
   - Create anchor element, set download to 'bulk_import_template.csv'
   - Click and cleanup (remove element, revoke URL)

4. downloadJsonTemplate(): void
   - Create copy of BULK_JSON_TEMPLATE with exportedAt set to current ISO string
   - JSON.stringify with 2-space indentation
   - Create Blob with type 'application/json'
   - Download as 'bulk_import_template.json'
   - Cleanup

Export all constants and functions.
  </action>
  <verify>
npm run build passes.
Import { downloadCsvTemplate, downloadJsonTemplate } from '...' compiles.
  </verify>
  <done>
BULK_CSV_TEMPLATE is a valid CSV string with 2 sample assets.
BULK_JSON_TEMPLATE is a valid object with PresetData-compatible structure.
Download functions create and trigger downloads with proper filenames.
  </done>
</task>

</tasks>

<verification>
1. npm run build completes without errors
2. BulkPreviewTable component registered and renders
3. Template download functions available for import
4. Preview table correctly shows action badges and status indicators
</verification>

<success_criteria>
- Preview table shows add/update/skip action per asset
- Rows can be expanded to show validation details
- Cancel button dispatches preview-cancelled event
- Confirm button dispatches preview-confirmed event with valid rows
- Template downloads provide pre-filled example data (5 years per asset)
- Both CSV and JSON templates available
</success_criteria>

<output>
After completion, create `.planning/phases/33-bulk-historical-data-management/33-02-SUMMARY.md`
</output>
