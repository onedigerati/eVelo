---
phase: 33-bulk-historical-data-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/data/services/bulk-export-service.ts
  - src/data/services/bulk-import-service.ts
  - src/data/validation/data-validator.ts
  - src/data/services/custom-data-service.ts
  - src/data/services/index.ts
autonomous: true

must_haves:
  truths:
    - "User can bulk export ALL assets to single CSV file"
    - "User can bulk export ALL assets to single JSON file"
    - "Bulk validation reports per-asset success/failure"
  artifacts:
    - path: "src/data/services/bulk-export-service.ts"
      provides: "Bulk export functions for CSV and JSON"
      exports: ["exportAllToCsv", "exportAllToJson"]
    - path: "src/data/services/bulk-import-service.ts"
      provides: "Bulk import parsing and preparation"
      exports: ["parseBulkCsv", "parseBulkJson"]
    - path: "src/data/validation/data-validator.ts"
      provides: "Bulk validation with per-asset reporting"
      exports: ["validateBulkCsv", "validateBulkJson", "BulkValidationResult"]
    - path: "src/data/services/custom-data-service.ts"
      provides: "Bulk save and reset functions"
      exports: ["saveAllCustomData", "resetAllToDefaults"]
  key_links:
    - from: "src/data/services/bulk-export-service.ts"
      to: "src/data/services/preset-service.ts"
      via: "getEffectiveData import"
      pattern: "getEffectiveData"
    - from: "src/data/services/bulk-import-service.ts"
      to: "src/data/validation/data-validator.ts"
      via: "parseAndValidateCsv import"
      pattern: "parseAndValidateCsv"
    - from: "src/data/services/custom-data-service.ts"
      to: "src/data/db.ts"
      via: "Dexie bulkAdd"
      pattern: "bulkAdd|bulkPut"
---

<objective>
Create bulk export/import services and extend validation for multi-asset operations.

Purpose: Enable exporting all assets to a single file and parsing bulk import files with per-asset validation feedback. This is the data layer foundation for bulk operations.

Output: New bulk-export-service.ts, bulk-import-service.ts, extended data-validator.ts with bulk validation, and extended custom-data-service.ts with bulk save/reset functions.
</objective>

<execution_context>
@C:\Users\ungac\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ungac\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-bulk-historical-data-management/33-RESEARCH.md

# Phase 32 infrastructure (foundation for bulk operations)
@src/data/services/preset-service.ts
@src/data/services/custom-data-service.ts
@src/data/validation/data-validator.ts
@src/data/db.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bulk export service</name>
  <files>src/data/services/bulk-export-service.ts</files>
  <action>
Create new bulk export service with:

1. Define BulkExportRow interface:
   - symbol: string
   - name: string
   - asset_class: string
   - year: string
   - annual_return: number

2. Implement exportAllToCsv():
   - Get all symbols from getPresetSymbols()
   - For each symbol, get data via getEffectiveData()
   - Create denormalized rows (one row per return, repeat symbol/name/asset_class)
   - Use Papa.unparse() with header: true, newline: '\n', escapeFormulae: true
   - Return CSV string

3. Implement exportAllToJson():
   - Get all symbols and their data via getEffectiveData()
   - Build JSON structure with version: 1, exportedAt ISO string, assets array
   - Return JSON.stringify with 2-space indentation

Import Papa from 'papaparse', getPresetSymbols and getEffectiveData from preset-service.
  </action>
  <verify>
npm run build passes without TypeScript errors.
Create test: import { exportAllToCsv, exportAllToJson } from './bulk-export-service' compiles.
  </verify>
  <done>
exportAllToCsv returns denormalized CSV string with all assets.
exportAllToJson returns JSON string with version, exportedAt, and assets array.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create bulk import service and extend validation</name>
  <files>
src/data/services/bulk-import-service.ts
src/data/validation/data-validator.ts
  </files>
  <action>
1. In data-validator.ts, add new types and functions:

Add BulkValidationResult interface:
- valid: boolean (true if at least one asset valid)
- assets: AssetValidationResult[]
- summary: { total, valid, warnings, errors }

Add AssetValidationResult interface:
- symbol: string
- name: string
- action: 'add' | 'update' | 'skip'
- recordCount: number
- result: ValidationResult (existing type)

Add validateBulkCsv(content: string): Promise<BulkValidationResult>
- Parse with Papa.parse header: true, skipEmptyLines: true
- Check for required columns: symbol, name, year, annual_return (asset_class optional)
- Group rows by symbol (normalize to uppercase)
- For each symbol group, create single-asset CSV and call parseAndValidateCsv
- Check if symbol has existing custom data (via hasCustomData) to set action
- Return BulkValidationResult with per-asset results

Add validateBulkJson(content: string): Promise<BulkValidationResult>
- Parse JSON, check for assets array
- For each asset, call parseAndValidateJson
- Check hasCustomData for action determination
- Return BulkValidationResult

2. Create bulk-import-service.ts:

Export parseBulkCsv(content: string): ParsedBulkData
- Returns structured data without validation (just parsing)

Export parseBulkJson(content: string): ParsedBulkData
- Returns structured data without validation

Import hasCustomData from custom-data-service.
  </action>
  <verify>
npm run build passes without TypeScript errors.
BulkValidationResult type is exported and usable.
Test bulk CSV validation logic manually or via dev console:
- Create test CSV: symbol,name,year,annual_return\nSPY,S&P 500,1995,0.10\nSPY,S&P 500,1996,0.12\nQQQ,Invesco,1995,0.15
- Call validateBulkCsv(testCsv)
- Verify result.assets.length === 2 (two symbols grouped)
- Verify result.assets[0].recordCount === 2 (SPY has 2 rows)
- Verify result.assets[0].action is 'add' or 'update' (action determined)
  </verify>
  <done>
validateBulkCsv groups rows by symbol and validates each asset independently.
validateBulkJson validates each asset in assets array.
Both return BulkValidationResult with per-asset success/failure/warning counts.
  </done>
</task>

<task type="auto">
  <name>Task 3: Extend custom-data-service with bulk operations</name>
  <files>
src/data/services/custom-data-service.ts
src/data/services/index.ts
  </files>
  <action>
1. In custom-data-service.ts, add:

saveAllCustomData(assets: PresetData[], source: 'user-import' | 'bundled-modified'): Promise<number[]>
- Delete existing data for all symbols in the array first
- Use db.customMarketData.where('symbol').anyOf(symbols).delete()
- Prepare CustomMarketData records for all assets
- Use db.customMarketData.bulkAdd(records, { allKeys: true })
- Return array of inserted IDs

resetAllToDefaults(): Promise<number>
- Get count of records first
- Use db.customMarketData.clear()
- Return count of deleted records

getCustomSymbols() already exists - verify it returns string[]

2. Update src/data/services/index.ts barrel exports:
- Add exports for new bulk-export-service functions
- Add exports for new bulk-import-service functions
- Export saveAllCustomData and resetAllToDefaults from custom-data-service

3. Update src/data/validation/data-validator.ts barrel export if needed (likely already has index.ts or is imported directly)
  </action>
  <verify>
npm run build passes.
Import { saveAllCustomData, resetAllToDefaults } from '../services/custom-data-service' works.
Import { exportAllToCsv, exportAllToJson } from '../services' works.
  </verify>
  <done>
saveAllCustomData efficiently saves multiple assets using Dexie bulkAdd.
resetAllToDefaults clears all custom data and returns count.
All new functions properly exported via barrel exports.
  </done>
</task>

</tasks>

<verification>
1. npm run build completes without errors
2. All new types are properly exported:
   - BulkValidationResult, AssetValidationResult from data-validator
   - exportAllToCsv, exportAllToJson from bulk-export-service
   - saveAllCustomData, resetAllToDefaults from custom-data-service
3. Bulk validation returns per-asset results with action field
</verification>

<success_criteria>
- Bulk export functions generate valid CSV/JSON with all assets
- Bulk validation reports per-asset success/failure
- Bulk save uses efficient Dexie bulkAdd
- Reset all clears entire customMarketData table
- All functions properly exported
</success_criteria>

<output>
After completion, create `.planning/phases/33-bulk-historical-data-management/33-01-SUMMARY.md`
</output>
