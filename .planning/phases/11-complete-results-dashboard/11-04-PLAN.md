---
phase: 11-complete-results-dashboard
plan: 04
type: execute
wave: 3
depends_on: ["11-03"]
files_modified:
  - src/components/ui/results-dashboard.ts
  - src/components/app-root.ts
autonomous: false

must_haves:
  truths:
    - "Margin call risk chart displays after simulation"
    - "SBLOC balance chart displays loan trajectory"
    - "BBD comparison chart shows strategy comparison"
  artifacts:
    - path: "src/components/ui/results-dashboard.ts"
      provides: "SBLOC chart sections"
      contains: "margin-call-chart"
  key_links:
    - from: "results-dashboard.ts"
      to: "margin-call-chart"
      via: "setData method"
      pattern: "margin-call-chart.*setData"
    - from: "results-dashboard.ts"
      to: "sbloc-balance-chart"
      via: "data property"
      pattern: "sbloc-balance-chart.*data"
    - from: "results-dashboard.ts"
      to: "bbd-comparison-chart"
      via: "setData method"
      pattern: "bbd-comparison-chart.*setData"
---

<objective>
Add SBLOC-related charts to results dashboard: margin call risk, SBLOC balance trajectory, and BBD vs Sell comparison.

Purpose: Visualize SBLOC risk and strategy benefits alongside simulation results.
Output: Results dashboard displays all 7 chart types when SBLOC simulation data is available.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Results dashboard (after Plans 01-03)
@src/components/ui/results-dashboard.ts

# Chart components to integrate
@src/charts/margin-call-chart.ts
@src/charts/sbloc-balance-chart.ts
@src/charts/bbd-comparison-chart.ts

# Simulation types with SBLOC data
@src/simulation/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add margin call risk chart section</name>
  <files>src/components/ui/results-dashboard.ts</files>
  <action>
    1. Import chart types:
       ```typescript
       import type { BarChartData, LineChartData } from '../../charts/types';
       import type { BBDComparisonChartData } from '../../charts/bbd-comparison-chart';
       ```
    2. Add margin call chart section to template (after correlation heatmap):
       ```html
       <section class="chart-section sbloc-section" id="margin-call-section">
         <h3>Margin Call Risk by Year</h3>
         <div class="chart-container">
           <margin-call-chart id="margin-call-chart"></margin-call-chart>
         </div>
       </section>
       ```
    3. Add CSS for `.sbloc-section { display: none; }` (hidden by default)
    4. Add CSS for `.sbloc-section.visible { display: block; }`
    5. In updateCharts(), conditionally show and populate:
       ```typescript
       const marginSection = this.$('#margin-call-section');
       const marginChart = this.$('#margin-call-chart') as HTMLElement & {
         setData(data: BarChartData, cumulative?: number[]): void
       };

       if (this._data?.marginCallStats && marginSection && marginChart) {
         marginSection.classList.add('visible');
         const stats = this._data.marginCallStats;
         marginChart.setData(
           {
             labels: stats.map(s => `Year ${s.year}`),
             values: stats.map(s => s.probability),
           },
           stats.map(s => s.cumulativeProbability)
         );
       } else {
         marginSection?.classList.remove('visible');
       }
       ```
  </action>
  <verify>npm run build succeeds</verify>
  <done>Margin call risk chart section added with conditional visibility</done>
</task>

<task type="auto">
  <name>Task 2: Add SBLOC balance trajectory chart section</name>
  <files>src/components/ui/results-dashboard.ts</files>
  <action>
    1. Add SBLOC balance section to template (after margin call):
       ```html
       <section class="chart-section sbloc-section" id="sbloc-balance-section">
         <h3>SBLOC Balance Over Time</h3>
         <div class="chart-container">
           <sbloc-balance-chart id="sbloc-balance-chart"></sbloc-balance-chart>
         </div>
       </section>
       ```
    2. In updateCharts(), populate SBLOC balance chart:
       ```typescript
       const sblocSection = this.$('#sbloc-balance-section');
       const sblocChart = this.$('#sbloc-balance-chart') as HTMLElement & { data: LineChartData | null };

       if (this._data?.sblocTrajectory && sblocSection && sblocChart) {
         sblocSection.classList.add('visible');
         const traj = this._data.sblocTrajectory;

         sblocChart.data = {
           labels: traj.years.map(y => `Year ${y}`),
           datasets: [
             {
               label: 'Loan Balance (Median)',
               data: traj.loanBalance.p50,
             },
             {
               label: 'Cumulative Withdrawals',
               data: traj.cumulativeWithdrawals,
             },
             {
               label: 'Cumulative Interest',
               data: traj.cumulativeInterest.p50,
             },
           ],
         };
       } else {
         sblocSection?.classList.remove('visible');
       }
       ```
  </action>
  <verify>npm run build succeeds</verify>
  <done>SBLOC balance chart section added with trajectory data</done>
</task>

<task type="auto">
  <name>Task 3: Add BBD vs Sell comparison chart section</name>
  <files>src/components/ui/results-dashboard.ts</files>
  <action>
    1. Add BBD comparison section (full-width, after SBLOC balance):
       ```html
       <section class="chart-section full-width sbloc-section" id="bbd-comparison-section">
         <h3>BBD Strategy vs Sell Assets Comparison</h3>
         <div class="chart-container bbd-container">
           <bbd-comparison-chart id="bbd-comparison-chart"></bbd-comparison-chart>
         </div>
       </section>
       ```
    2. Add CSS for `.bbd-container { height: 300px; }` (shorter height for bar chart)
    3. In updateCharts(), populate BBD chart:
       ```typescript
       const bbdSection = this.$('#bbd-comparison-section');
       const bbdChart = this.$('#bbd-comparison-chart') as HTMLElement & {
         setData(data: BBDComparisonChartData): void
       };

       if (this._data?.estateAnalysis && bbdSection && bbdChart) {
         bbdSection.classList.add('visible');
         bbdChart.setData({
           bbdNetEstate: this._data.estateAnalysis.bbdNetEstate,
           sellNetEstate: this._data.estateAnalysis.sellNetEstate,
           bbdAdvantage: this._data.estateAnalysis.bbdAdvantage,
         });
       } else {
         bbdSection?.classList.remove('visible');
       }
       ```
  </action>
  <verify>npm run build succeeds</verify>
  <done>BBD comparison chart section added with estate analysis data</done>
</task>

<task type="auto">
  <name>Task 4: Pass SBLOC config from app-root to simulation</name>
  <files>src/components/app-root.ts</files>
  <action>
    1. In collectSimulationParams(), add SBLOC config from UI:
       ```typescript
       // Get SBLOC settings from sidebar
       const ltvSlider = this.$('range-slider[suffix="%"]') as (RangeSlider & { value: number }) | null;
       const interestSlider = this.$$('range-slider[suffix="%"]')[1] as (RangeSlider & { value: number }) | null;

       // Find the sliders by their parent section or position
       const sblocSection = this.$('param-section[title="SBLOC Settings"]');
       const ltvValue = sblocSection?.querySelector('range-slider:first-of-type') as (RangeSlider & { value: number }) | null;
       const interestValue = sblocSection?.querySelector('range-slider:last-of-type') as (RangeSlider & { value: number }) | null;

       // Add SBLOC config
       const sblocConfig = {
         targetLTV: (ltvValue?.value ?? 50) / 100, // Convert % to decimal
         interestRate: (interestValue?.value ?? 6.5) / 100, // Convert % to decimal
         annualWithdrawal: 50000, // Fixed for now, could add slider
         maintenanceMargin: 0.70, // 70% margin call threshold
       };

       // Add to simulation config
       config.sbloc = sblocConfig;
       ```
    2. Note: The SBLOC settings sliders already exist in the sidebar template from Phase 7
  </action>
  <verify>npm run build succeeds, npm run dev - SBLOC charts appear after simulation</verify>
  <done>SBLOC config passed from UI sliders to simulation</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete results dashboard with all 7 charts and extended statistics</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Visit: http://localhost:5173
    3. Adjust SBLOC settings if desired (LTV, Interest Rate)
    4. Click "Run Simulation"
    5. Verify these charts appear:
       - Probability cone (portfolio projection)
       - Histogram (terminal value distribution)
       - Donut (portfolio composition)
       - Correlation heatmap (asset correlations)
       - Margin call risk (probability by year)
       - SBLOC balance (loan trajectory)
       - BBD comparison (strategy comparison)
    6. Verify statistics panel shows 8 metrics:
       - Median Value, Success Rate, CAGR, TWRR
       - Mean Value, Volatility, Std Deviation, Salary Equiv.
    7. Test mobile view (resize to <768px):
       - Charts stack in single column
       - Stats show in 2x4 grid
  </how-to-verify>
  <resume-signal>Type "approved" if all charts display correctly, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] All 7 charts display after simulation
- [ ] SBLOC charts only appear when SBLOC config is provided
- [ ] Extended statistics display correctly (8 metrics)
- [ ] Mobile layout works for all charts
- [ ] User approved visual verification
</verification>

<success_criteria>
- All tasks completed
- All 7 chart types display with real simulation data
- Extended statistics panel complete
- Responsive layout works on mobile
- User approved dashboard appearance
</success_criteria>

<output>
After completion, create `.planning/phases/11-complete-results-dashboard/11-04-SUMMARY.md`
</output>
