---
phase: 11-complete-results-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ui/results-dashboard.ts
autonomous: true

must_haves:
  truths:
    - "Donut chart displays portfolio composition after simulation"
    - "Correlation heatmap displays asset correlations"
  artifacts:
    - path: "src/components/ui/results-dashboard.ts"
      provides: "Donut chart and correlation heatmap sections"
      contains: "donut-chart"
  key_links:
    - from: "results-dashboard.ts"
      to: "donut-chart"
      via: "data property setter"
      pattern: "donut-chart.*data"
    - from: "results-dashboard.ts"
      to: "correlation-heatmap"
      via: "data property setter"
      pattern: "correlation-heatmap.*data"
---

<objective>
Add portfolio composition donut chart and asset correlation heatmap to results dashboard.

Purpose: Visualize asset allocation and correlations alongside simulation results.
Output: Results dashboard displays 4 charts: probability cone, histogram, donut, correlation heatmap.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing results dashboard
@src/components/ui/results-dashboard.ts

# Chart components to integrate
@src/charts/donut-chart.ts
@src/charts/correlation-heatmap.ts

# Chart type definitions
@src/charts/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add donut chart section to results dashboard</name>
  <files>src/components/ui/results-dashboard.ts</files>
  <action>
    1. Import DonutChartData type from '../../charts/types'
    2. Add new state property `_portfolioWeights: { symbol: string; weight: number }[] | null = null`
    3. Add setter `set portfolioWeights(value)` that stores weights and updates donut chart
    4. Add donut chart section to template after stats-section:
       ```html
       <section class="chart-section">
         <h3>Portfolio Composition</h3>
         <div class="chart-container square">
           <donut-chart id="donut-chart"></donut-chart>
         </div>
       </section>
       ```
    5. Add CSS for `.chart-container.square { aspect-ratio: 1; height: auto; min-height: 300px; }`
    6. In updateCharts(), transform _portfolioWeights to DonutChartData:
       ```typescript
       const donut = this.$('#donut-chart') as HTMLElement & { data: DonutChartData | null };
       if (donut && this._portfolioWeights) {
         donut.data = {
           segments: this._portfolioWeights.map(p => ({
             label: p.symbol,
             value: p.weight
           }))
         };
       }
       ```
  </action>
  <verify>npm run build succeeds</verify>
  <done>Donut chart section added to template with data binding</done>
</task>

<task type="auto">
  <name>Task 2: Add correlation heatmap section to results dashboard</name>
  <files>src/components/ui/results-dashboard.ts</files>
  <action>
    1. Import HeatmapData type from '../../charts/types'
    2. Add new state property `_correlationMatrix: { labels: string[]; matrix: number[][] } | null = null`
    3. Add setter `set correlationMatrix(value)` that stores and updates heatmap
    4. Add heatmap section to template after donut chart:
       ```html
       <section class="chart-section">
         <h3>Asset Correlations</h3>
         <div class="chart-container square">
           <correlation-heatmap id="heatmap-chart"></correlation-heatmap>
         </div>
       </section>
       ```
    5. In updateCharts(), set heatmap data:
       ```typescript
       const heatmap = this.$('#heatmap-chart') as HTMLElement & { data: HeatmapData | null };
       if (heatmap && this._correlationMatrix) {
         heatmap.data = this._correlationMatrix;
       }
       ```
    6. Update grid layout: Change `.dashboard-grid` to `grid-template-columns: repeat(2, 1fr)` (already is 2-col)
       - Probability cone: full-width
       - Histogram + Stats: side by side (current)
       - Donut + Heatmap: side by side (new row)
  </action>
  <verify>npm run build succeeds</verify>
  <done>Correlation heatmap section added to template with data binding</done>
</task>

<task type="auto">
  <name>Task 3: Wire portfolio data from app-root to dashboard</name>
  <files>src/components/app-root.ts</files>
  <action>
    1. After setting `dashboard.data = this._simulationResult`, also set portfolio data:
       ```typescript
       // Set portfolio composition for donut chart
       const weights = Object.entries(weightEditor?.getWeights() ?? {}).map(([symbol, weight]) => ({
         symbol,
         weight
       }));
       (dashboard as any).portfolioWeights = weights;

       // Set correlation matrix for heatmap
       (dashboard as any).correlationMatrix = {
         labels: weights.map(w => w.symbol),
         matrix: correlationMatrix  // from collectSimulationParams
       };
       ```
    2. Store the portfolio config in class property so it's available after simulation completes
    3. Alternatively, extract weight and correlation data at the point of dashboard.data assignment
  </action>
  <verify>npm run dev, run simulation, verify donut chart and heatmap display data</verify>
  <done>Portfolio weights and correlation matrix passed to dashboard after simulation</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run dev` and run simulation
- [ ] Donut chart shows portfolio allocation (e.g., 70% SPY, 30% AGG)
- [ ] Correlation heatmap shows asset correlations
- [ ] Mobile layout stacks charts in single column
</verification>

<success_criteria>
- All tasks completed
- Donut chart displays after simulation with correct asset weights
- Correlation heatmap displays with asset correlation matrix
- No TypeScript errors
- Grid layout works on desktop and mobile
</success_criteria>

<output>
After completion, create `.planning/phases/11-complete-results-dashboard/11-01-SUMMARY.md`
</output>
