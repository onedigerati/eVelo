---
phase: 11-complete-results-dashboard
plan: 09
type: execute
wave: 3
depends_on: ["11-03"]
files_modified:
  - src/components/ui/performance-table.ts
  - src/components/ui/return-probability-table.ts
  - src/components/ui/results-dashboard.ts
  - src/components/ui/index.ts
  - src/calculations/return-probabilities.ts
autonomous: true

must_haves:
  truths:
    - "Performance summary table shows metrics across percentiles"
    - "Return probability table shows likelihood of achieving return thresholds"
    - "Values are color-coded (green positive, red negative)"
  artifacts:
    - path: "src/components/ui/performance-table.ts"
      provides: "PerformanceTable web component"
      contains: "TWRR"
    - path: "src/components/ui/return-probability-table.ts"
      provides: "ReturnProbabilityTable web component"
      contains: "Annual Return Probabilities"
---

<objective>
Add detailed performance tables showing metrics across percentiles and return probabilities.

Purpose: Provide tabular data for users who want detailed numerical analysis.
Output: Two comprehensive tables with color-coded values.
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/11-complete-results-dashboard/GAPS-PLAN.md
@references/screenshots-ui/MonteCarlo-result-panel-3.png
@references/screenshots-ui/MonteCarlo-result-panel-4.png

Reference shows:
1. Performance Summary Table:
   - Rows: TWRR (nominal/real), Portfolio End Balance (nominal/real), Annual Mean Return, Annualized Volatility
   - Columns: P10, P25, P50, P75, P90
   - Green text for positive, standard for neutral

2. Expected Annual Return Table:
   - Rows: P10, P25, P50, P75, P90
   - Columns: 1 Year, 3 Years, 5 Years, 10 Years, 15 Years

3. Annual Return Probabilities Table:
   - Rows: >=0%, >=2.5%, >=5%, >=7.5%, >=10%, >=12.5%
   - Columns: 1 Year, 3 Years, 5 Years, 10 Years, 15 Years
   - All green (positive probabilities)
</context>

<tasks>
- task: "Create return probability calculations"
  file: "src/calculations/return-probabilities.ts"
  action: "create"
  details: |
    Calculate probability of achieving return thresholds:

    interface ReturnProbabilities {
      thresholds: number[];  // [0, 0.025, 0.05, 0.075, 0.10, 0.125]
      timeHorizons: number[];  // [1, 3, 5, 10, 15]
      probabilities: number[][];  // [threshold][horizon]
    }

    function calculateReturnProbabilities(
      terminalValues: Float64Array,
      initialValue: number,
      timeHorizon: number
    ): ReturnProbabilities

    For each threshold/horizon combination:
    - Calculate required terminal value for that CAGR
    - Count simulations that exceed that value
    - Return as percentage

- task: "Create PerformanceTable component"
  file: "src/components/ui/performance-table.ts"
  action: "create"
  details: |
    Web component for performance summary table:

    Props:
    - data: {
        twrrNominal: PercentileRow,
        twrrReal: PercentileRow,
        portfolioNominal: PercentileRow,
        portfolioReal: PercentileRow,
        meanReturn: PercentileRow,
        volatility: PercentileRow
      }

    Layout:
    - Header row with "Metric", P10, P25, P50, P75, P90
    - Data rows with label and 5 percentile values
    - Note text below explaining metrics

    Styling:
    - Alternating row backgrounds
    - Green text for positive returns
    - Red text for negative returns
    - Responsive horizontal scroll on mobile

- task: "Create ReturnProbabilityTable component"
  file: "src/components/ui/return-probability-table.ts"
  action: "create"
  details: |
    Web component showing return probability matrix:

    Props:
    - expectedReturns: { percentiles: string[], horizons: number[], values: number[][] }
    - probabilities: ReturnProbabilities

    Layout (two tables):

    1. Expected Annual Return:
       - Header: Percentile, 1 Year, 3 Years, 5 Years, 10 Years, 15 Years
       - Rows: 10th, 25th, 50th, 75th, 90th Percentile
       - Values: CAGR at each horizon for each percentile

    2. Annual Return Probabilities:
       - Header: Return, 1 Year, 3 Years, 5 Years, 10 Years, 15 Years
       - Rows: >=0.00%, >=2.50%, >=5.00%, etc.
       - Values: Probability of achieving threshold

    Styling:
    - All probability values in green (they're positive)
    - Color intensity based on value (darker = higher prob)
    - Note text explaining interpretation

- task: "Integrate into results-dashboard"
  file: "src/components/ui/results-dashboard.ts"
  action: "modify"
  details: |
    Add sections after existing charts:
    1. Performance Summary section with performance-table
    2. Expected Returns section with return-probability-table

    Calculate data from simulation output.
    For "real" values, apply inflation adjustment (2.5% default).

- task: "Export components and calculations"
  file: "src/components/ui/index.ts"
  action: "modify"
  file: "src/calculations/index.ts"
  action: "modify"
</tasks>

<verification>
After completion:
- [ ] `npm run build` succeeds
- [ ] Performance table shows all 6 metrics
- [ ] Return probability tables display correctly
- [ ] Color coding works (green/red)
- [ ] Mobile horizontal scroll works
- [ ] Note text present
</verification>
