---
phase: 07.1-application-integration
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ui/settings-panel.ts
  - src/components/ui/index.ts
  - src/components/app-root.ts
autonomous: true

must_haves:
  truths:
    - "User can configure API keys for data providers"
    - "User can select CORS proxy option"
    - "API key changes persist across sessions"
  artifacts:
    - path: "src/components/ui/settings-panel.ts"
      provides: "Settings UI for API keys and CORS proxy"
      contains: "setApiKey"
      min_lines: 120
  key_links:
    - from: "settings-panel.ts"
      to: "settings-service.ts"
      via: "setApiKey/setCorsConfig calls"
      pattern: "setApiKey\\("
---

<objective>
Create settings panel UI for configuring API keys and CORS proxy options.

Purpose: Allow users to configure external data source credentials for fetching market data.
Output: settings-panel component accessible from app-root header, persisting to IndexedDB.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Settings service API:
@src/data/services/settings-service.ts
@src/data/schemas/settings.ts

# CORS proxy types:
@src/data/api/cors-proxy.ts

# Base component pattern:
@src/components/base-component.ts

# Current app-root:
@src/components/app-root.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create settings-panel component</name>
  <files>src/components/ui/settings-panel.ts</files>
  <action>
Create a component for managing API keys and CORS proxy settings:

1. Import dependencies:
   ```typescript
   import { BaseComponent } from '../base-component';
   import {
     getSettings,
     setApiKey,
     clearApiKey,
     getCorsConfig,
     setCorsConfig
   } from '../../data/services/settings-service';
   import type { ApiSource } from '../../data/schemas/market-data';
   import type { CorsProxyType } from '../../data/api/cors-proxy';
   ```

2. Define API provider info:
   ```typescript
   const API_PROVIDERS: Array<{
     source: ApiSource;
     name: string;
     description: string;
     signupUrl: string;
   }> = [
     {
       source: 'fmp',
       name: 'Financial Modeling Prep',
       description: 'Free tier: 250 requests/day',
       signupUrl: 'https://site.financialmodelingprep.com/developer/docs'
     },
     {
       source: 'eodhd',
       name: 'EOD Historical Data',
       description: 'Free tier: 20 requests/day',
       signupUrl: 'https://eodhistoricaldata.com/register'
     },
     {
       source: 'alphavantage',
       name: 'Alpha Vantage',
       description: 'Free tier: 25 requests/day',
       signupUrl: 'https://www.alphavantage.co/support/#api-key'
     },
     {
       source: 'tiingo',
       name: 'Tiingo',
       description: 'Free tier: 500 symbols, 1000 requests/day',
       signupUrl: 'https://api.tiingo.com/'
     }
   ];

   const CORS_PROXY_OPTIONS: Array<{
     type: CorsProxyType;
     name: string;
     description: string;
   }> = [
     { type: 'none', name: 'None', description: 'Direct requests (localhost/same-origin only)' },
     { type: 'allorigins', name: 'AllOrigins', description: 'Public proxy (may be slow)' },
     { type: 'corsproxy', name: 'CORS Proxy', description: 'Alternative public proxy' },
     { type: 'custom', name: 'Custom', description: 'Your own proxy URL' }
   ];
   ```

3. Create SettingsPanel class:
   ```typescript
   export class SettingsPanel extends BaseComponent {
     private _visible = false;

     show(): void {
       this._visible = true;
       this.loadCurrentSettings();
       this.updateVisibility();
     }

     hide(): void {
       this._visible = false;
       this.updateVisibility();
     }

     toggle(): void {
       this._visible ? this.hide() : this.show();
     }
   ```

4. Template with API key inputs and CORS proxy selector:
   ```typescript
   protected template(): string {
     const apiInputs = API_PROVIDERS.map(p => `
       <div class="api-provider">
         <label>${p.name}</label>
         <p class="description">${p.description}</p>
         <div class="input-row">
           <input type="password"
                  id="api-${p.source}"
                  placeholder="Enter API key"
                  autocomplete="off" />
           <button class="btn-clear" data-source="${p.source}">Clear</button>
         </div>
         <a href="${p.signupUrl}" target="_blank" rel="noopener">Get API key →</a>
       </div>
     `).join('');

     const corsOptions = CORS_PROXY_OPTIONS.map(o => `
       <label class="radio-option">
         <input type="radio" name="cors-proxy" value="${o.type}" />
         <span class="option-name">${o.name}</span>
         <span class="option-desc">${o.description}</span>
       </label>
     `).join('');

     return `
       <div class="settings-overlay" id="overlay">
         <div class="settings-modal">
           <header>
             <h2>Settings</h2>
             <button id="btn-close" aria-label="Close">×</button>
           </header>

           <section class="api-keys-section">
             <h3>API Keys</h3>
             <p class="section-info">Configure API keys for fetching historical market data.
                At least one is needed for non-bundled assets.</p>
             ${apiInputs}
           </section>

           <section class="cors-section">
             <h3>CORS Proxy</h3>
             <p class="section-info">Required for fetching data from external APIs in browser.</p>
             <div class="cors-options">
               ${corsOptions}
             </div>
             <div class="custom-url-row" id="custom-url-row" style="display: none;">
               <label>Custom Proxy URL</label>
               <input type="text" id="cors-custom-url" placeholder="https://your-proxy.com/" />
             </div>
           </section>

           <footer>
             <button id="btn-save" class="btn-primary">Save Settings</button>
           </footer>
         </div>
       </div>
     `;
   }
   ```

5. Styles:
   - Overlay with semi-transparent backdrop
   - Centered modal card (max-width 500px)
   - Section headers with descriptions
   - Radio button styled as cards
   - Show/hide based on _visible

6. updateVisibility():
   ```typescript
   private updateVisibility(): void {
     const overlay = this.$('#overlay') as HTMLElement;
     if (overlay) {
       overlay.style.display = this._visible ? 'flex' : 'none';
     }
   }
   ```

7. loadCurrentSettings():
   ```typescript
   private async loadCurrentSettings(): Promise<void> {
     const settings = await getSettings();

     // Set API key inputs (show mask if value exists)
     for (const p of API_PROVIDERS) {
       const input = this.$(`#api-${p.source}`) as HTMLInputElement;
       const key = settings.apiKeys[p.source as keyof typeof settings.apiKeys];
       if (input && key) {
         input.value = '••••••••'; // Mask existing keys
         input.dataset.hasKey = 'true';
       }
     }

     // Set CORS proxy radio
     const proxyRadio = this.$(`input[name="cors-proxy"][value="${settings.corsProxyType}"]`) as HTMLInputElement;
     if (proxyRadio) proxyRadio.checked = true;

     // Show custom URL if custom selected
     const customRow = this.$('#custom-url-row') as HTMLElement;
     if (customRow) {
       customRow.style.display = settings.corsProxyType === 'custom' ? 'block' : 'none';
     }

     const customUrl = this.$('#cors-custom-url') as HTMLInputElement;
     if (customUrl && settings.corsProxyUrl) {
       customUrl.value = settings.corsProxyUrl;
     }
   }
   ```

8. afterRender() with event handlers:
   ```typescript
   protected override afterRender(): void {
     // Close button
     this.$('#btn-close')?.addEventListener('click', () => this.hide());

     // Overlay click to close
     this.$('#overlay')?.addEventListener('click', (e) => {
       if ((e.target as HTMLElement).id === 'overlay') this.hide();
     });

     // Clear buttons
     this.shadowRoot?.querySelectorAll('.btn-clear').forEach(btn => {
       btn.addEventListener('click', async (e) => {
         const source = (e.target as HTMLElement).dataset.source as ApiSource;
         await clearApiKey(source);
         const input = this.$(`#api-${source}`) as HTMLInputElement;
         if (input) {
           input.value = '';
           input.dataset.hasKey = 'false';
         }
         this.showToast(`${source.toUpperCase()} API key cleared`, 'success');
       });
     });

     // CORS proxy radio change
     this.shadowRoot?.querySelectorAll('input[name="cors-proxy"]').forEach(radio => {
       radio.addEventListener('change', () => {
         const customRow = this.$('#custom-url-row') as HTMLElement;
         const selected = (this.$('input[name="cors-proxy"]:checked') as HTMLInputElement)?.value;
         if (customRow) {
           customRow.style.display = selected === 'custom' ? 'block' : 'none';
         }
       });
     });

     // Save button
     this.$('#btn-save')?.addEventListener('click', async () => {
       await this.saveSettings();
       this.showToast('Settings saved', 'success');
       this.hide();
     });

     // Input focus clears mask
     for (const p of API_PROVIDERS) {
       const input = this.$(`#api-${p.source}`) as HTMLInputElement;
       input?.addEventListener('focus', () => {
         if (input.dataset.hasKey === 'true') {
           input.value = '';
         }
       });
     }
   }
   ```

9. saveSettings():
   ```typescript
   private async saveSettings(): Promise<void> {
     // Save API keys (only if changed from mask)
     for (const p of API_PROVIDERS) {
       const input = this.$(`#api-${p.source}`) as HTMLInputElement;
       if (input && input.value && input.value !== '••••••••') {
         await setApiKey(p.source, input.value);
       }
     }

     // Save CORS config
     const selectedProxy = (this.$('input[name="cors-proxy"]:checked') as HTMLInputElement)?.value as CorsProxyType;
     const customUrl = (this.$('#cors-custom-url') as HTMLInputElement)?.value;

     await setCorsConfig({
       type: selectedProxy || 'none',
       customUrl: selectedProxy === 'custom' ? customUrl : undefined
     });
   }
   ```

10. showToast helper (same as portfolio-manager).

11. Register: `customElements.define('settings-panel', SettingsPanel);`
  </action>
  <verify>npm run build succeeds</verify>
  <done>
    - settings-panel component with API key inputs
    - CORS proxy selector with custom URL option
    - Saves to IndexedDB via settings service
    - Modal show/hide API
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate settings panel into app-root</name>
  <files>src/components/ui/index.ts, src/components/app-root.ts</files>
  <action>
1. Update UI barrel export in src/components/ui/index.ts:
   ```typescript
   export * from './settings-panel';
   ```

2. Add settings button to app-root header:
   Update the header slot content:
   ```html
   <div slot="header" class="header-content">
     <h1>eVelo Portfolio Simulator</h1>
     <button id="btn-settings" class="header-btn" aria-label="Settings">⚙️</button>
   </div>
   ```

3. Add settings-panel component after toast-container:
   ```html
   <settings-panel id="settings-panel"></settings-panel>
   ```

4. Add header styles in styles():
   ```css
   .header-content {
     display: flex;
     align-items: center;
     justify-content: space-between;
     width: 100%;
   }

   .header-btn {
     background: transparent;
     border: none;
     font-size: 1.5rem;
     cursor: pointer;
     padding: var(--spacing-xs, 4px);
     border-radius: var(--radius-sm, 4px);
   }

   .header-btn:hover {
     background: var(--surface-hover, rgba(0,0,0,0.05));
   }
   ```

5. In afterRender(), add settings button handler:
   ```typescript
   const settingsBtn = this.$('#btn-settings');
   const settingsPanel = this.$('#settings-panel') as any;

   settingsBtn?.addEventListener('click', () => {
     settingsPanel?.toggle();
   });
   ```
  </action>
  <verify>
    - npm run build succeeds
    - Settings gear icon appears in header
    - Clicking opens settings modal
  </verify>
  <done>
    - Settings button in header
    - Settings panel toggles on click
    - User can configure API keys and CORS proxy
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Settings gear icon appears in header
- [ ] Clicking gear opens settings modal
- [ ] API key inputs work (can enter, clear)
- [ ] CORS proxy selector works (radio buttons)
- [ ] Saving persists to IndexedDB (check dev tools)
- [ ] Settings load on next modal open
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- API keys persist across sessions
- CORS proxy configuration works
</success_criteria>

<output>
After completion, create `.planning/phases/07.1-application-integration/07.1-04-SUMMARY.md`
</output>
