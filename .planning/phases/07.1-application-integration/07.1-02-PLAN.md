---
phase: 07.1-application-integration
plan: 02
type: execute
wave: 2
depends_on: ["07.1-01"]
files_modified:
  - src/components/app-root.ts
  - src/components/ui/results-dashboard.ts
  - src/components/ui/index.ts
autonomous: false

must_haves:
  truths:
    - "Probability cone chart displays after simulation completes"
    - "Histogram chart shows terminal value distribution"
    - "Charts update with each new simulation run"
  artifacts:
    - path: "src/components/ui/results-dashboard.ts"
      provides: "Dashboard container with chart components"
      contains: "probability-cone-chart"
      min_lines: 80
    - path: "src/components/app-root.ts"
      provides: "Dashboard integration with simulation results"
      contains: "results-dashboard"
  key_links:
    - from: "app-root.ts"
      to: "results-dashboard.ts"
      via: "passes SimulationOutput to dashboard"
      pattern: "results\\.data\\s*="
    - from: "results-dashboard.ts"
      to: "probability-cone-chart"
      via: "transforms YearlyPercentiles to ProbabilityConeData"
      pattern: "cone\\.data\\s*="
---

<objective>
Create results dashboard component and wire chart components to display simulation results.

Purpose: Visualize Monte Carlo results in probability cone, histogram, and summary statistics.
Output: results-dashboard.ts component displaying charts after simulation, integrated into app-root.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan output (simulation integration):
@.planning/phases/07.1-application-integration/07.1-01-SUMMARY.md

# Simulation output types:
@src/simulation/types.ts

# Chart components and their data types:
@src/charts/index.ts
@src/charts/types.ts
@src/charts/probability-cone-chart.ts
@src/charts/histogram-chart.ts

# Base component pattern:
@src/components/base-component.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create results-dashboard component</name>
  <files>src/components/ui/results-dashboard.ts</files>
  <action>
Create a new Web Component to display simulation results:

1. Import dependencies:
   ```typescript
   import { BaseComponent } from '../base-component';
   import type { SimulationOutput, YearlyPercentiles } from '../../simulation/types';
   import type { ProbabilityConeData, HistogramData } from '../../charts/types';
   // Import chart components to register them
   import '../../charts';
   ```

2. Create ResultsDashboard class extending BaseComponent:
   ```typescript
   export class ResultsDashboard extends BaseComponent {
     private _data: SimulationOutput | null = null;

     set data(value: SimulationOutput | null) {
       this._data = value;
       this.updateCharts();
     }

     get data(): SimulationOutput | null {
       return this._data;
     }
   ```

3. Template with chart grid and summary stats:
   ```typescript
   protected template(): string {
     return `
       <div class="dashboard-grid">
         <section class="chart-section full-width">
           <h3>Portfolio Projection</h3>
           <div class="chart-container">
             <probability-cone-chart id="cone-chart"></probability-cone-chart>
           </div>
         </section>

         <section class="chart-section">
           <h3>Terminal Value Distribution</h3>
           <div class="chart-container">
             <histogram-chart id="histogram-chart"></histogram-chart>
           </div>
         </section>

         <section class="stats-section">
           <h3>Summary Statistics</h3>
           <div class="stats-grid" id="stats-grid">
             <div class="stat-item">
               <span class="stat-label">Median Value</span>
               <span class="stat-value" id="stat-median">—</span>
             </div>
             <div class="stat-item">
               <span class="stat-label">Success Rate</span>
               <span class="stat-value" id="stat-success">—</span>
             </div>
             <div class="stat-item">
               <span class="stat-label">Mean Value</span>
               <span class="stat-value" id="stat-mean">—</span>
             </div>
             <div class="stat-item">
               <span class="stat-label">Std Deviation</span>
               <span class="stat-value" id="stat-stddev">—</span>
             </div>
           </div>
         </section>
       </div>

       <div class="no-data" id="no-data">
         <p>Run a simulation to see results</p>
       </div>
     `;
   }
   ```

4. Styles for dashboard grid layout:
   - CSS Grid: 2 columns on desktop, 1 on mobile
   - Chart containers with fixed height (400px)
   - Stats grid with 2x2 layout
   - Hide no-data when data present

5. updateCharts() method:
   ```typescript
   private updateCharts(): void {
     const noData = this.$('#no-data') as HTMLElement;
     const grid = this.$('.dashboard-grid') as HTMLElement;

     if (!this._data) {
       noData?.style.display = 'block';
       grid?.style.display = 'none';
       return;
     }

     noData.style.display = 'none';
     grid.style.display = 'grid';

     // Update probability cone
     const cone = this.$('#cone-chart') as any;
     if (cone) {
       cone.data = this.transformToConeData(this._data.yearlyPercentiles);
     }

     // Update histogram
     const histogram = this.$('#histogram-chart') as any;
     if (histogram) {
       histogram.data = this.transformToHistogramData(this._data.terminalValues);
     }

     // Update stats
     this.updateStats(this._data.statistics);
   }
   ```

6. Data transformation helpers:
   ```typescript
   private transformToConeData(percentiles: YearlyPercentiles[]): ProbabilityConeData {
     return {
       years: percentiles.map(p => p.year),
       bands: {
         p10: percentiles.map(p => p.p10),
         p25: percentiles.map(p => p.p25),
         p50: percentiles.map(p => p.p50),
         p75: percentiles.map(p => p.p75),
         p90: percentiles.map(p => p.p90)
       }
     };
   }

   private transformToHistogramData(values: Float64Array): HistogramData {
     // Create bins from terminal values
     const arr = Array.from(values);
     const min = Math.min(...arr);
     const max = Math.max(...arr);
     const binCount = 20;
     const binWidth = (max - min) / binCount;

     const bins: Array<{ min: number; max: number; count: number }> = [];
     for (let i = 0; i < binCount; i++) {
       bins.push({
         min: min + i * binWidth,
         max: min + (i + 1) * binWidth,
         count: 0
       });
     }

     for (const v of arr) {
       const binIndex = Math.min(Math.floor((v - min) / binWidth), binCount - 1);
       bins[binIndex].count++;
     }

     return { bins };
   }

   private updateStats(stats: SimulationStatistics): void {
     const format = (n: number) => new Intl.NumberFormat('en-US', {
       style: 'currency', currency: 'USD', notation: 'compact', maximumFractionDigits: 1
     }).format(n);

     const median = this.$('#stat-median');
     const success = this.$('#stat-success');
     const mean = this.$('#stat-mean');
     const stddev = this.$('#stat-stddev');

     if (median) median.textContent = format(stats.median);
     if (success) success.textContent = `${stats.successRate.toFixed(1)}%`;
     if (mean) mean.textContent = format(stats.mean);
     if (stddev) stddev.textContent = format(stats.stddev);
   }
   ```

7. Register element: `customElements.define('results-dashboard', ResultsDashboard);`
  </action>
  <verify>npm run build succeeds without errors</verify>
  <done>
    - results-dashboard component created
    - Takes SimulationOutput via data setter
    - Transforms data for probability cone and histogram charts
    - Displays summary statistics
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate dashboard into app-root</name>
  <files>src/components/app-root.ts, src/components/ui/index.ts</files>
  <action>
1. Add results-dashboard to UI barrel export:
   In src/components/ui/index.ts, add:
   `export * from './results-dashboard';`

2. Update app-root template:
   Replace the `<div class="charts-placeholder">` with:
   ```html
   <results-dashboard id="results"></results-dashboard>
   ```

3. In afterRender, after simulation completes:
   ```typescript
   const dashboard = this.$('#results') as any;
   if (dashboard) {
     dashboard.data = this._simulationResult;
   }
   ```

4. Also set dashboard.data in the simulation-complete flow (after storing result).

5. Remove the old charts-placeholder styles since they're no longer needed.
  </action>
  <verify>npm run build succeeds, page loads with dashboard component visible</verify>
  <done>
    - results-dashboard integrated into app-root
    - Dashboard receives simulation results after each run
    - Placeholder removed, dashboard shows "Run simulation to see results" initially
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Results dashboard with probability cone and histogram charts, wired to simulation engine
  </what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Visit: http://localhost:5173
    3. Click "Run Simulation" button
    4. Wait for progress to reach 100%
    5. Verify:
       - Probability cone chart appears with colored percentile bands
       - Histogram chart shows terminal value distribution
       - Summary statistics show median, success rate, mean, std deviation
       - Running another simulation updates the charts
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] results-dashboard component exists with chart integration
- [ ] Probability cone chart displays simulation results
- [ ] Histogram chart displays terminal value distribution
- [ ] Summary statistics update after simulation
- [ ] Human verification checkpoint passed
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Charts display real simulation data
- User approved visual verification
</success_criteria>

<output>
After completion, create `.planning/phases/07.1-application-integration/07.1-02-SUMMARY.md`
</output>
