---
phase: 07.1-application-integration
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ui/portfolio-manager.ts
  - src/components/ui/portfolio-list.ts
  - src/components/ui/index.ts
  - src/components/app-root.ts
autonomous: true

must_haves:
  truths:
    - "User can save current portfolio with a name"
    - "User can load a previously saved portfolio"
    - "User can delete a saved portfolio"
    - "User can export portfolios to JSON file"
    - "User can import portfolios from JSON file"
  artifacts:
    - path: "src/components/ui/portfolio-manager.ts"
      provides: "Portfolio management panel with save/load/export/import"
      contains: "savePortfolio"
      min_lines: 150
    - path: "src/components/ui/portfolio-list.ts"
      provides: "Saved portfolio list with load/delete actions"
      contains: "loadAllPortfolios"
      min_lines: 80
  key_links:
    - from: "portfolio-manager.ts"
      to: "portfolio-service.ts"
      via: "save/load/delete CRUD calls"
      pattern: "savePortfolio\\("
    - from: "portfolio-list.ts"
      to: "portfolio-service.ts"
      via: "loadAllPortfolios query"
      pattern: "loadAllPortfolios\\("
---

<objective>
Create portfolio management UI for saving, loading, exporting, and importing portfolio configurations.

Purpose: Allow users to persist and manage multiple portfolio configurations using IndexedDB storage.
Output: portfolio-manager and portfolio-list components integrated into app-root sidebar.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Portfolio service API:
@src/data/services/portfolio-service.ts
@src/data/schemas/portfolio.ts

# Base component pattern:
@src/components/base-component.ts

# Current app-root for integration:
@src/components/app-root.ts

# Weight editor for current portfolio state:
@src/components/ui/weight-editor.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create portfolio-list component</name>
  <files>src/components/ui/portfolio-list.ts</files>
  <action>
Create a component to display saved portfolios with load/delete actions:

1. Import dependencies:
   ```typescript
   import { BaseComponent } from '../base-component';
   import { loadAllPortfolios, deletePortfolio } from '../../data/services/portfolio-service';
   import type { PortfolioRecord } from '../../data/schemas/portfolio';
   ```

2. Create PortfolioList class:
   ```typescript
   export class PortfolioList extends BaseComponent {
     private _portfolios: PortfolioRecord[] = [];

     async connectedCallback() {
       super.connectedCallback();
       await this.refresh();
     }

     async refresh(): Promise<void> {
       this._portfolios = await loadAllPortfolios();
       this.renderList();
     }
   ```

3. Template with list container:
   ```typescript
   protected template(): string {
     return `
       <div class="portfolio-list" id="list">
         <p class="empty-message">No saved portfolios</p>
       </div>
     `;
   }
   ```

4. renderList() method to update DOM:
   ```typescript
   private renderList(): void {
     const list = this.$('#list') as HTMLElement;
     if (!list) return;

     if (this._portfolios.length === 0) {
       list.innerHTML = '<p class="empty-message">No saved portfolios</p>';
       return;
     }

     list.innerHTML = this._portfolios.map(p => `
       <div class="portfolio-item" data-id="${p.id}">
         <div class="portfolio-info">
           <span class="portfolio-name">${this.escapeHtml(p.name)}</span>
           <span class="portfolio-meta">${p.assets.length} assets Â· ${this.formatDate(p.modified)}</span>
         </div>
         <div class="portfolio-actions">
           <button class="btn-load" data-id="${p.id}">Load</button>
           <button class="btn-delete" data-id="${p.id}">Delete</button>
         </div>
       </div>
     `).join('');
   }
   ```

5. Styles for list items:
   - Stack layout with name, meta, and action buttons
   - Hover highlight on items
   - Danger color for delete button

6. afterRender() to attach click handlers:
   ```typescript
   protected override afterRender(): void {
     const list = this.$('#list');
     list?.addEventListener('click', async (e) => {
       const target = e.target as HTMLElement;
       const id = parseInt(target.dataset.id || '');

       if (target.classList.contains('btn-load') && id) {
         this.dispatchEvent(new CustomEvent('load-portfolio', {
           detail: { id },
           bubbles: true,
           composed: true
         }));
       }

       if (target.classList.contains('btn-delete') && id) {
         if (confirm('Delete this portfolio?')) {
           await deletePortfolio(id);
           await this.refresh();
         }
       }
     });
   }
   ```

7. Helper methods:
   - escapeHtml() for XSS prevention
   - formatDate() for friendly date display

8. Register: `customElements.define('portfolio-list', PortfolioList);`
  </action>
  <verify>npm run build succeeds</verify>
  <done>
    - portfolio-list component displays saved portfolios
    - Load button dispatches load-portfolio event
    - Delete button removes portfolio after confirm
    - List refreshes after delete
  </done>
</task>

<task type="auto">
  <name>Task 2: Create portfolio-manager component</name>
  <files>src/components/ui/portfolio-manager.ts</files>
  <action>
Create a panel for portfolio management actions:

1. Import dependencies:
   ```typescript
   import { BaseComponent } from '../base-component';
   import {
     savePortfolio,
     loadPortfolio,
     loadAllPortfolios,
     exportAndDownload,
     importFromFile,
     bulkImportPortfolios
   } from '../../data/services/portfolio-service';
   import type { PortfolioRecord, PortfolioAsset } from '../../data/schemas/portfolio';
   import './portfolio-list';
   ```

2. Create PortfolioManager class:
   ```typescript
   export class PortfolioManager extends BaseComponent {
     private _currentPortfolioId: number | undefined;

     // Getter for external components to access current portfolio
     get currentPortfolioId(): number | undefined {
       return this._currentPortfolioId;
     }
   ```

3. Template with save form, list, and import/export:
   ```typescript
   protected template(): string {
     return `
       <div class="portfolio-manager">
         <section class="save-section">
           <h4>Save Current Portfolio</h4>
           <div class="save-form">
             <input type="text" id="portfolio-name" placeholder="Portfolio name" />
             <button id="btn-save" class="btn-primary">Save</button>
           </div>
         </section>

         <section class="list-section">
           <h4>Saved Portfolios</h4>
           <portfolio-list id="portfolio-list"></portfolio-list>
         </section>

         <section class="import-export-section">
           <h4>Import / Export</h4>
           <div class="ie-buttons">
             <button id="btn-export">Export All</button>
             <button id="btn-import">Import</button>
             <input type="file" id="import-file" accept=".json" hidden />
           </div>
         </section>
       </div>
     `;
   }
   ```

4. Styles:
   - Sections with spacing
   - Save form with inline input + button
   - Import/export buttons side by side

5. afterRender() with event handlers:
   ```typescript
   protected override afterRender(): void {
     const saveBtn = this.$('#btn-save');
     const nameInput = this.$('#portfolio-name') as HTMLInputElement;
     const exportBtn = this.$('#btn-export');
     const importBtn = this.$('#btn-import');
     const importFile = this.$('#import-file') as HTMLInputElement;
     const list = this.$('#portfolio-list') as any;

     // Save button
     saveBtn?.addEventListener('click', async () => {
       const name = nameInput?.value.trim();
       if (!name) {
         this.showToast('Please enter a portfolio name', 'error');
         return;
       }
       await this.saveCurrentPortfolio(name);
       nameInput.value = '';
       await list?.refresh();
       this.showToast('Portfolio saved', 'success');
     });

     // Export button
     exportBtn?.addEventListener('click', async () => {
       const portfolios = await loadAllPortfolios();
       if (portfolios.length === 0) {
         this.showToast('No portfolios to export', 'warning');
         return;
       }
       exportAndDownload(portfolios);
       this.showToast(`Exported ${portfolios.length} portfolios`, 'success');
     });

     // Import button triggers file input
     importBtn?.addEventListener('click', () => {
       importFile?.click();
     });

     // File input change
     importFile?.addEventListener('change', async () => {
       const file = importFile.files?.[0];
       if (!file) return;

       try {
         const portfolios = await importFromFile(file);
         await bulkImportPortfolios(portfolios);
         await list?.refresh();
         this.showToast(`Imported ${portfolios.length} portfolios`, 'success');
       } catch (e) {
         this.showToast((e as Error).message, 'error');
       }
       importFile.value = ''; // Reset for re-import
     });

     // Listen for load-portfolio from list
     this.addEventListener('load-portfolio', async (e: Event) => {
       const { id } = (e as CustomEvent).detail;
       const portfolio = await loadPortfolio(id);
       if (portfolio) {
         this._currentPortfolioId = id;
         this.dispatchEvent(new CustomEvent('portfolio-loaded', {
           detail: { portfolio },
           bubbles: true,
           composed: true
         }));
       }
     });
   }
   ```

6. saveCurrentPortfolio() method - dispatches event to collect current state:
   ```typescript
   private async saveCurrentPortfolio(name: string): Promise<void> {
     // Dispatch event asking parent for current portfolio state
     const event = new CustomEvent('request-portfolio-state', {
       bubbles: true,
       composed: true,
       detail: {}
     });
     this.dispatchEvent(event);

     // Parent should have set event.detail.assets
     const assets = (event as any).detail.assets as PortfolioAsset[] | undefined;
     if (!assets || assets.length === 0) {
       this.showToast('No assets to save', 'warning');
       return;
     }

     const record: Omit<PortfolioRecord, 'id'> = {
       name,
       assets,
       created: new Date().toISOString(),
       modified: new Date().toISOString(),
       version: 1
     };

     if (this._currentPortfolioId) {
       // Update existing
       await savePortfolio({ ...record, id: this._currentPortfolioId });
     } else {
       // Create new
       this._currentPortfolioId = await savePortfolio(record);
     }
   }
   ```

7. showToast helper that finds toast-container:
   ```typescript
   private showToast(message: string, type: 'success' | 'error' | 'warning' = 'success'): void {
     const container = document.querySelector('toast-container') as any;
     container?.show(message, type);
   }
   ```

8. Register: `customElements.define('portfolio-manager', PortfolioManager);`
  </action>
  <verify>npm run build succeeds</verify>
  <done>
    - portfolio-manager component with save/load/export/import UI
    - Dispatches portfolio-loaded event when user loads a portfolio
    - Requests current portfolio state via custom event
    - Export downloads JSON file, import reads JSON file
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate portfolio manager into app-root</name>
  <files>src/components/ui/index.ts, src/components/app-root.ts</files>
  <action>
1. Update UI barrel export in src/components/ui/index.ts:
   ```typescript
   export * from './portfolio-manager';
   export * from './portfolio-list';
   ```

2. Add portfolio-manager to app-root sidebar:
   After the "Asset Allocation" param-section, add:
   ```html
   <param-section title="Portfolio Management">
     <portfolio-manager id="portfolio-manager"></portfolio-manager>
   </param-section>
   ```

3. In app-root afterRender, handle portfolio events:
   ```typescript
   // Handle request for current portfolio state
   this.addEventListener('request-portfolio-state', (e: Event) => {
     const weightEditor = this.$('weight-editor') as any;
     const assets = weightEditor?.getAssets?.() || [];
     (e as CustomEvent).detail.assets = assets.map((a: any) => ({
       id: a.id,
       symbol: a.id,
       name: a.name,
       assetClass: 'equity', // Default, can be refined later
       weight: a.weight / 100 // Convert percent to decimal
     }));
   });

   // Handle portfolio loaded
   this.addEventListener('portfolio-loaded', (e: Event) => {
     const { portfolio } = (e as CustomEvent).detail;
     const weightEditor = this.$('weight-editor') as any;
     if (weightEditor && portfolio.assets) {
       // Transform to weight-editor format
       const assets = portfolio.assets.map((a: PortfolioAsset) => ({
         id: a.symbol,
         name: a.name,
         weight: a.weight * 100 // Convert decimal to percent
       }));
       weightEditor.setAttribute('assets', JSON.stringify(assets));
     }
   });
   ```

4. Import PortfolioAsset type in app-root if needed for type safety.
  </action>
  <verify>
    - npm run build succeeds
    - Portfolio Management section appears in sidebar
  </verify>
  <done>
    - portfolio-manager integrated into sidebar
    - Current portfolio state collected from weight-editor
    - Loaded portfolios update weight-editor
    - Export/import functionality accessible
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Portfolio Management section appears in sidebar
- [ ] Saving a portfolio persists it (check IndexedDB in dev tools)
- [ ] Saved portfolios appear in list
- [ ] Loading a portfolio updates weight-editor
- [ ] Deleting a portfolio removes it from list
- [ ] Export downloads a JSON file
- [ ] Import loads portfolios from JSON file
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Users can save/load/export/import portfolios
- Portfolio state syncs with weight-editor
</success_criteria>

<output>
After completion, create `.planning/phases/07.1-application-integration/07.1-03-SUMMARY.md`
</output>
