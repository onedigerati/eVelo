---
phase: 22-mobile-sidebar-ux-redesign
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ui/main-layout.ts
  - src/components/app-root.ts
autonomous: true

must_haves:
  truths:
    - "Mobile: Sidebar collapses vertically (slides up/down) instead of horizontal overlay"
    - "Mobile: Clicking 'Run Monte Carlo Simulation' auto-collapses sidebar"
    - "Transition animations are smooth (300ms CSS transitions)"
    - "Touch interactions work reliably on mobile devices"
  artifacts:
    - path: "src/components/ui/main-layout.ts"
      provides: "Mobile vertical collapse CSS with translateY, auto-collapse event listener"
      contains: "translateY(-100%)"
    - path: "src/components/app-root.ts"
      provides: "simulation-start event dispatch"
      contains: "simulation-start"
  key_links:
    - from: "src/components/app-root.ts"
      to: "src/components/ui/main-layout.ts"
      via: "simulation-start CustomEvent bubbling"
      pattern: "simulation-start.*bubbles.*composed"
---

<objective>
Implement mobile vertical collapse behavior and auto-collapse on simulation run.

Purpose: Replace horizontal slide overlay with more natural vertical slide for mobile sidebar UX. Auto-collapse sidebar when user runs simulation so results are immediately visible.

Output: Updated main-layout.ts with vertical collapse CSS and auto-collapse event listener; updated app-root.ts with simulation-start event dispatch.
</objective>

<execution_context>
@C:\Users\ungac\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ungac\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-mobile-sidebar-ux-redesign/22-RESEARCH.md
@src/components/ui/main-layout.ts
@src/components/app-root.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement mobile vertical collapse CSS in main-layout.ts</name>
  <files>src/components/ui/main-layout.ts</files>
  <action>
Update the mobile responsive CSS in main-layout.ts to use vertical collapse (translateY) instead of horizontal overlay (translateX):

1. Change mobile grid layout to include sidebar in flow:
   ```css
   @media (max-width: 768px) {
     .layout {
       grid-template-areas:
         "header"
         "sidebar"
         "main";
       grid-template-rows: auto auto 1fr;
       grid-template-columns: 1fr;
     }
   }
   ```

2. Change sidebar-area from fixed overlay to relative positioning with vertical collapse:
   ```css
   .sidebar-area {
     position: relative;
     width: 100%;
     max-height: 60vh;
     overflow-y: auto;
     transform: translateY(0);
     transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                 max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                 opacity 0.3s ease;
     border-right: none;
     border-bottom: 1px solid var(--border-color, #e2e8f0);
   }
   ```

3. Update collapsed state to slide up instead of left:
   ```css
   :host([sidebar-collapsed]) .sidebar-area {
     transform: translateY(-100%);
     max-height: 0;
     overflow: hidden;
     opacity: 0;
   }
   ```

4. Remove or hide backdrop on mobile (not needed for vertical collapse):
   ```css
   .sidebar-backdrop {
     display: none;
   }
   ```

5. REMOVE the `sidebar-open` attribute handling for mobile - we're unifying to use `sidebar-collapsed` attribute for both desktop and mobile (CSS media queries differentiate behavior).

6. Update reduced motion support:
   ```css
   @media (prefers-reduced-motion: reduce) {
     .sidebar-area {
       transition: none;
     }
   }
   ```

Important: Keep the desktop behavior unchanged (horizontal collapse to 48px). Only mobile behavior changes to vertical.
  </action>
  <verify>
Run `npm run build` to verify TypeScript compiles without errors. Open dev server and test at 768px breakpoint - sidebar should slide up/down vertically when collapsed/expanded.
  </verify>
  <done>
Mobile sidebar slides up (disappears) when collapsed and slides down (appears) when expanded, using smooth CSS transitions. Desktop horizontal collapse behavior unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire simulation-start event for auto-collapse</name>
  <files>src/components/app-root.ts, src/components/ui/main-layout.ts</files>
  <action>
Add event-based auto-collapse when simulation runs on mobile:

1. In app-root.ts, dispatch `simulation-start` event when Run button is clicked:

   Find the runBtn click handler (around line 1310) and add event dispatch BEFORE the simulation starts:
   ```typescript
   runBtn?.addEventListener('click', async () => {
     // Prevent double-runs
     if (this._isRunning) {
       return;
     }

     // NEW: Dispatch event to trigger auto-collapse on mobile
     this.dispatchEvent(
       new CustomEvent('simulation-start', {
         bubbles: true,
         composed: true,
       })
     );

     try {
       this._isRunning = true;
       // ... rest of existing code
   ```

2. In main-layout.ts, add listener for `simulation-start` in afterRender():
   ```typescript
   protected override afterRender(): void {
     // ... existing toggle listener ...

     // Auto-collapse sidebar when simulation runs (mobile only)
     this.addEventListener('simulation-start', () => {
       if (window.matchMedia('(max-width: 768px)').matches) {
         this.setAttribute('sidebar-collapsed', '');
       }
     });

     // ... rest of existing code
   ```

3. Update the mobile menu button click handler to toggle `sidebar-collapsed` instead of `sidebar-open`:
   ```typescript
   // Mobile menu button toggles sidebar collapse
   this.$('.mobile-menu-btn')?.addEventListener('click', () => {
     if (this.hasAttribute('sidebar-collapsed')) {
       this.removeAttribute('sidebar-collapsed');
       // Also clear sidebar-panel's collapsed attribute
       const sidebarPanel = this.querySelector('sidebar-panel');
       sidebarPanel?.removeAttribute('collapsed');
     } else {
       this.setAttribute('sidebar-collapsed', '');
     }
   });
   ```

4. Remove the backdrop click handler (backdrop hidden on mobile now):
   Keep the backdrop click handler but wrap it in a desktop-only check, or remove it since we removed backdrop display on mobile.
  </action>
  <verify>
Run `npm run build` to verify TypeScript compiles. Test on mobile viewport: tap "Run Monte Carlo Simulation" button - sidebar should auto-collapse, revealing results dashboard. Tap mobile menu button - sidebar should expand/collapse vertically.
  </verify>
  <done>
Clicking "Run Monte Carlo Simulation" on mobile automatically collapses sidebar. Mobile menu button toggles vertical sidebar collapse. Events bubble correctly from app-root to main-layout.
  </done>
</task>

</tasks>

<verification>
1. **Desktop behavior unchanged**: At viewport > 768px, sidebar collapses horizontally to 48px and expands to 320px. Simulation button does NOT auto-collapse sidebar.
2. **Mobile vertical collapse**: At viewport <= 768px, sidebar slides up (collapses) and down (expands) instead of horizontal overlay.
3. **Auto-collapse on simulation**: On mobile, clicking "Run Monte Carlo Simulation" automatically collapses sidebar so results are visible.
4. **Smooth animations**: Transitions use 300ms cubic-bezier(0.4, 0, 0.2, 1) easing for smooth, polished feel.
5. **Reduced motion support**: Animations disabled when `prefers-reduced-motion: reduce` is active.
6. **No regressions**: Simulation still runs correctly, results display properly, comparison mode works.
</verification>

<success_criteria>
- Mobile sidebar animates vertically (translateY) with smooth 300ms transition
- Simulation button click triggers sidebar auto-collapse on mobile viewport
- Mobile menu button toggles sidebar expand/collapse
- Desktop horizontal collapse behavior unchanged
- Build passes without errors
- Touch interactions responsive on mobile devices
</success_criteria>

<output>
After completion, create `.planning/phases/22-mobile-sidebar-ux-redesign/22-01-SUMMARY.md`
</output>
