---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/types/index.ts
  - src/types/simulation.ts
  - src/types/portfolio.ts
  - src/types/sbloc.ts
  - src/components/base-component.ts
  - src/main.ts
  - index.html
autonomous: true

must_haves:
  truths:
    - "TypeScript compiles all type definitions without errors"
    - "Web Component renders in browser with shadow DOM"
    - "Component lifecycle methods execute correctly"
  artifacts:
    - path: "src/types/index.ts"
      provides: "Type re-exports"
      exports: ["SimulationConfig", "Portfolio", "SBLOCTerms"]
    - path: "src/types/simulation.ts"
      provides: "Simulation configuration types"
      contains: "SimulationConfig"
    - path: "src/types/portfolio.ts"
      provides: "Portfolio and asset types"
      contains: "Portfolio"
    - path: "src/types/sbloc.ts"
      provides: "SBLOC terms types"
      contains: "SBLOCTerms"
    - path: "src/components/base-component.ts"
      provides: "Web Component base class"
      exports: ["BaseComponent"]
      contains: "shadow"
  key_links:
    - from: "src/types/index.ts"
      to: "src/types/simulation.ts"
      via: "re-export"
      pattern: "from.*simulation"
    - from: "src/main.ts"
      to: "src/components/base-component.ts"
      via: "import and customElements.define"
      pattern: "customElements.define"
---

<objective>
Create core TypeScript types and Web Component base class.

Purpose: Establish type definitions used throughout the application and the component architecture pattern.
Output: Type definitions for simulation, portfolio, SBLOC; working Web Component base class.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

Key context:
- Web Components with Shadow DOM for encapsulation
- TypeScript strict mode enabled
- Types will be used by simulation engine, visualizations, and UI
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create core type definitions</name>
  <files>src/types/index.ts, src/types/simulation.ts, src/types/portfolio.ts, src/types/sbloc.ts</files>
  <action>
  Create src/types/ directory and type definition files:

  1. src/types/simulation.ts:
     ```typescript
     // Simulation configuration
     export interface SimulationConfig {
       iterations: number;           // 1,000 - 100,000
       timeHorizon: number;          // years (10-50)
       inflationAdjusted: boolean;   // real vs nominal
       resamplingMethod: 'simple' | 'block';
       blockSize?: number;           // for block bootstrap
       regimeSwitching: boolean;
     }

     // Simulation results
     export interface SimulationResult {
       year: number;
       values: number[];             // One value per iteration
       percentiles: PercentileValues;
     }

     export interface PercentileValues {
       p10: number;
       p25: number;
       p50: number;
       p75: number;
       p90: number;
     }

     // Regime model
     export type MarketRegime = 'bull' | 'bear' | 'crash';
     ```

  2. src/types/portfolio.ts:
     ```typescript
     export interface Asset {
       id: string;
       symbol: string;
       name: string;
       assetClass: AssetClass;
       weight: number;               // 0-1, must sum to 1
       returns?: number[];           // historical returns
     }

     export type AssetClass = 'equity' | 'bond' | 'reit' | 'commodity' | 'cash';

     export interface Portfolio {
       id: string;
       name: string;
       assets: Asset[];
       createdAt: Date;
       updatedAt: Date;
     }

     export interface CorrelationMatrix {
       assetIds: string[];
       matrix: number[][];           // symmetric correlation matrix
     }
     ```

  3. src/types/sbloc.ts:
     ```typescript
     export interface SBLOCTerms {
       enabled: boolean;
       maxLTV: number;               // e.g., 0.50 for 50%
       interestRate: number;         // annual rate, e.g., 0.065 for 6.5%
       annualDraw: number;           // dollar amount or percentage
       maintenanceLTV: number;       // margin call threshold
     }

     export interface SBLOCState {
       balance: number;
       accruedInterest: number;
       currentLTV: number;
       marginCallTriggered: boolean;
       forcedLiquidation: number;    // amount liquidated
     }

     export interface LTVByAssetClass {
       equity: number;               // typically 0.50-0.70
       bond: number;                 // typically 0.80-0.90
       reit: number;
       commodity: number;
       cash: number;
     }
     ```

  4. src/types/index.ts:
     ```typescript
     // Re-export all types
     export * from './simulation';
     export * from './portfolio';
     export * from './sbloc';
     ```
  </action>
  <verify>npm run build succeeds (TypeScript compiles all types)</verify>
  <done>All type definitions created and compile without errors</done>
</task>

<task type="auto">
  <name>Task 2: Create Web Component base class</name>
  <files>src/components/base-component.ts, src/main.ts, index.html</files>
  <action>
  1. Create src/components/base-component.ts:
     ```typescript
     /**
      * Base class for all Web Components in eVelo.
      * Provides Shadow DOM encapsulation and lifecycle helpers.
      */
     export abstract class BaseComponent extends HTMLElement {
       protected shadow: ShadowRoot;

       constructor() {
         super();
         this.shadow = this.attachShadow({ mode: 'open' });
       }

       /**
        * Called when component is added to DOM.
        * Override to add event listeners, fetch data, etc.
        */
       connectedCallback(): void {
         this.render();
       }

       /**
        * Called when component is removed from DOM.
        * Override to clean up event listeners, timers, etc.
        */
       disconnectedCallback(): void {
         // Override in subclass if needed
       }

       /**
        * Called when observed attributes change.
        */
       attributeChangedCallback(
         name: string,
         oldValue: string | null,
         newValue: string | null
       ): void {
         if (oldValue !== newValue) {
           this.render();
         }
       }

       /**
        * Override to define which attributes trigger re-render.
        */
       static get observedAttributes(): string[] {
         return [];
       }

       /**
        * Must be implemented by subclasses.
        * Returns the component's HTML template.
        */
       protected abstract template(): string;

       /**
        * Must be implemented by subclasses.
        * Returns the component's CSS styles.
        */
       protected abstract styles(): string;

       /**
        * Renders the component by updating shadow DOM.
        */
       protected render(): void {
         this.shadow.innerHTML = `
           <style>${this.styles()}</style>
           ${this.template()}
         `;
         this.afterRender();
       }

       /**
        * Called after render completes.
        * Override to attach event listeners to rendered elements.
        */
       protected afterRender(): void {
         // Override in subclass if needed
       }

       /**
        * Helper to query elements within shadow DOM.
        */
       protected $(selector: string): Element | null {
         return this.shadow.querySelector(selector);
       }

       /**
        * Helper to query all elements within shadow DOM.
        */
       protected $$(selector: string): NodeListOf<Element> {
         return this.shadow.querySelectorAll(selector);
       }
     }
     ```

  2. Create a test component to verify the base class works.
     Create src/components/app-root.ts:
     ```typescript
     import { BaseComponent } from './base-component';

     export class AppRoot extends BaseComponent {
       protected template(): string {
         return `
           <div class="container">
             <h1>eVelo</h1>
             <p>Portfolio Strategy Simulator</p>
             <p class="status">Web Components working!</p>
           </div>
         `;
       }

       protected styles(): string {
         return `
           .container {
             font-family: system-ui, -apple-system, sans-serif;
             max-width: 800px;
             margin: 2rem auto;
             padding: 2rem;
             text-align: center;
           }
           h1 {
             color: #0d9488;
             margin-bottom: 0.5rem;
           }
           .status {
             color: #059669;
             font-weight: 500;
           }
         `;
       }
     }

     // Register the custom element
     customElements.define('app-root', AppRoot);
     ```

  3. Update src/main.ts:
     ```typescript
     import './style.css';
     import './components/app-root';

     console.log('eVelo starting...');
     ```

  4. Update index.html to use the component:
     Replace the #app div with <app-root></app-root>
  </action>
  <verify>
  - npm run build succeeds
  - npm run dev shows "eVelo" heading and "Web Components working!" in browser
  </verify>
  <done>Web Component base class created and test component renders in browser</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without TypeScript errors
- [ ] All type files export their types correctly
- [ ] Web Component renders with Shadow DOM in browser
- [ ] Browser dev tools show shadow-root on app-root element
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Type definitions compile cleanly
- Web Component base class provides lifecycle methods
- Test component renders in browser
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
