---
phase: 05-financial-calculations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/calculations/types.ts, src/calculations/metrics.ts]
autonomous: true

must_haves:
  truths:
    - "CAGR calculation returns correct compound annual growth rate"
    - "Annualized volatility calculation returns correct standard deviation of returns"
    - "Percentile extraction returns P10, P25, P50, P75, P90 from terminal values"
    - "Success rate calculation matches CFA definition"
  artifacts:
    - path: "src/calculations/types.ts"
      provides: "Type definitions for calculation inputs and outputs"
      min_lines: 80
    - path: "src/calculations/metrics.ts"
      provides: "Core financial metrics (CAGR, volatility, percentiles, success rate)"
      min_lines: 100
      exports: ["calculateCAGR", "calculateAnnualizedVolatility", "extractPercentiles", "calculateSuccessRate", "calculateMetricsSummary"]
  key_links:
    - from: "metrics.ts"
      to: "math module"
      via: "import { mean, stddev, percentile }"
      pattern: "from.*['\"].*math"
    - from: "metrics.ts"
      to: "SimulationOutput"
      via: "uses terminalValues Float64Array"
      pattern: "terminalValues"
---

<objective>
Create foundational calculation types and core financial metrics for BBD simulation results.

Purpose: Provide CFA-standard financial metrics (CAGR, volatility, percentiles) that can be computed from SimulationOutput data. These are the primary metrics users will see to evaluate their BBD strategy.

Output: Two modules - types.ts with comprehensive type definitions, metrics.ts with core calculation functions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Source files for understanding existing types
@src/simulation/types.ts
@src/math/index.ts
@src/sbloc/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create calculation types</name>
  <files>src/calculations/types.ts</files>
  <action>
Create type definitions for all Phase 5 calculation inputs and outputs:

1. **MetricsSummary** - aggregate output from core metrics:
   - cagr: number (compound annual growth rate)
   - annualizedVolatility: number
   - successRate: number (0-100)
   - percentiles: { p10, p25, p50, p75, p90 }

2. **MarginCallProbability** - per-year margin call risk:
   - year: number
   - probability: number (0-100)
   - cumulativeProbability: number (0-100)

3. **TWRRResult** - time-weighted return data:
   - twrr: number (annualized time-weighted rate of return)
   - periodReturns: number[] (per-period returns)
   - cumulativeReturn: number (total return over all periods)

4. **EstateAnalysis** - BBD estate calculations:
   - terminalPortfolioValue: number
   - terminalLoanBalance: number
   - netEstate: number (portfolio - loan)
   - embeddedCapitalGains: number (unrealized gains)
   - steppedUpBasisSavings: number (tax avoided at death)
   - estateTaxExemption: number (current threshold)

5. **BBDComparison** - BBD vs Sell comparison:
   - bbdNetEstate: number (using BBD strategy)
   - sellNetEstate: number (selling and paying taxes)
   - bbdAdvantage: number (difference)
   - taxesPaidIfSold: number (capital gains + potential estate)

6. **SalaryEquivalent** - tax-free withdrawal equivalent:
   - annualWithdrawal: number (SBLOC draw amount)
   - salaryEquivalent: number (pre-tax salary needed)
   - effectiveTaxRate: number (assumed rate for comparison)
   - taxSavings: number (annual tax avoided)

7. **CalculationConfig** - configurable parameters:
   - capitalGainsTaxRate: number (default 0.238 for federal long-term)
   - estateTaxExemption: number (default 13990000 for 2025)
   - effectiveIncomeTaxRate: number (for salary equivalent, default 0.37)

Include JSDoc comments with formulas and examples.
Export DEFAULT_CALCULATION_CONFIG with sensible defaults.
  </action>
  <verify>tsc --noEmit passes without errors on src/calculations/types.ts</verify>
  <done>All type definitions compile and are ready for use by calculation modules</done>
</task>

<task type="auto">
  <name>Task 2: Create core metrics module</name>
  <files>src/calculations/metrics.ts</files>
  <action>
Create core financial metrics calculations:

1. **calculateCAGR(startValue: number, endValue: number, years: number): number**
   - Formula: (endValue / startValue)^(1/years) - 1
   - Handle edge cases: years <= 0 returns NaN, startValue <= 0 returns NaN
   - Return as decimal (0.08 for 8%)

2. **calculateAnnualizedVolatility(returns: number[] | Float64Array): number**
   - Use stddev from math module
   - Returns already annualized if input is annual returns
   - Handle empty array (return 0)

3. **extractPercentiles(values: number[] | Float64Array): { p10, p25, p50, p75, p90 }**
   - Use percentile function from math module
   - Convert Float64Array to regular array if needed for sorting
   - Return object with all 5 percentile values

4. **calculateSuccessRate(terminalValues: Float64Array, initialValue: number): number**
   - Count iterations where terminalValue > initialValue
   - Return as percentage (0-100)
   - This is "probability of ending above starting value"

5. **calculateMetricsSummary(output: SimulationOutput, config: SimulationConfig): MetricsSummary**
   - Orchestrates all above functions
   - CAGR: from initialValue to median terminal value
   - Volatility: from terminal values
   - Uses output.statistics.successRate if available, else calculates
   - Returns complete MetricsSummary object

Import types from types.ts and math functions from ../math.
Include JSDoc with formula explanations.
  </action>
  <verify>npm run build succeeds without TypeScript errors</verify>
  <done>
- calculateCAGR returns correct growth rate (e.g., $1M to $2M over 10 years = ~7.18%)
- calculateAnnualizedVolatility returns stddev of return series
- extractPercentiles returns all 5 percentile values
- calculateSuccessRate returns percentage of iterations above initial
- calculateMetricsSummary aggregates all metrics
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `src/calculations/types.ts` exports all 7 type definitions
- [ ] `src/calculations/metrics.ts` exports all 5 functions
- [ ] Types align with existing SimulationOutput, SimulationConfig interfaces
- [ ] No circular dependencies
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- CALC-01 (success rate), CALC-02 (percentiles), CALC-03 (CAGR, volatility) requirements satisfied
- Types ready for use by other Phase 5 plans
</success_criteria>

<output>
After completion, create `.planning/phases/05-financial-calculations/05-01-SUMMARY.md`
</output>
