---
phase: 05-financial-calculations
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [src/calculations/twrr.ts, src/calculations/margin-call-probability.ts]
autonomous: true

must_haves:
  truths:
    - "TWRR calculation chains period returns correctly"
    - "Margin call probability calculates per-year risk from simulation data"
    - "Cumulative margin call probability increases monotonically"
  artifacts:
    - path: "src/calculations/twrr.ts"
      provides: "Time-Weighted Rate of Return calculation"
      min_lines: 60
      exports: ["calculateTWRR", "calculatePeriodReturn", "chainReturns"]
    - path: "src/calculations/margin-call-probability.ts"
      provides: "Margin call probability by year"
      min_lines: 80
      exports: ["calculateMarginCallProbability", "aggregateMarginCallEvents"]
  key_links:
    - from: "twrr.ts"
      to: "YearlyPercentiles"
      via: "extracts year-over-year median returns"
      pattern: "YearlyPercentiles"
    - from: "margin-call-probability.ts"
      to: "MarginCallEvent"
      via: "aggregates events from simulation runs"
      pattern: "MarginCallEvent"
---

<objective>
Create TWRR calculation and margin call probability analysis for BBD simulation.

Purpose: TWRR is the CFA-standard return metric that eliminates timing bias from cash flows. Margin call probability by year helps users understand when their BBD strategy is most at risk.

Output: Two modules - twrr.ts for time-weighted returns, margin-call-probability.ts for per-year risk analysis.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Source files for understanding existing types
@src/simulation/types.ts
@src/sbloc/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TWRR calculation</name>
  <files>src/calculations/twrr.ts</files>
  <action>
Create Time-Weighted Rate of Return calculations (CFA-standard):

1. **calculatePeriodReturn(startValue: number, endValue: number): number**
   - Formula: (endValue - startValue) / startValue
   - Return as decimal (0.05 for 5%)
   - Handle startValue <= 0 (return NaN)

2. **chainReturns(periodReturns: number[]): number**
   - Formula: product of (1 + r) for all periods - 1
   - This gives total return over all periods
   - Handle empty array (return 0)

3. **annualizeReturn(totalReturn: number, periods: number): number**
   - Formula: (1 + totalReturn)^(1/periods) - 1
   - Converts total return to annualized rate
   - Handle periods <= 0 (return NaN)

4. **calculateTWRR(yearlyPercentiles: YearlyPercentiles[]): TWRRResult**
   - Extract median (p50) values from each year
   - Calculate period returns between consecutive years
   - Chain returns to get cumulative
   - Annualize to get TWRR
   - Return TWRRResult with all components

   TWRR is important because it measures portfolio performance independent of
   cash flows (withdrawals), unlike IRR which is affected by timing.

Import YearlyPercentiles from simulation types.
Import TWRRResult from ./types.
Include JSDoc with CFA formula references.
  </action>
  <verify>npm run build succeeds without TypeScript errors</verify>
  <done>
- calculatePeriodReturn returns correct single-period return
- chainReturns correctly compounds multiple periods
- annualizeReturn converts total to annualized rate
- calculateTWRR produces complete TWRRResult from yearly data
  </done>
</task>

<task type="auto">
  <name>Task 2: Create margin call probability by year</name>
  <files>src/calculations/margin-call-probability.ts</files>
  <action>
Create margin call probability analysis:

1. **MarginCallTracker** interface (internal):
   - yearCounts: Map<number, number> (count of margin calls per year)
   - totalIterations: number

2. **aggregateMarginCallEvents(events: MarginCallEvent[][], totalIterations: number): MarginCallTracker**
   - events is array of arrays (one array per simulation iteration)
   - Count how many iterations had a margin call in each year
   - Note: One iteration can have multiple margin calls (different years)

3. **calculateMarginCallProbability(tracker: MarginCallTracker, timeHorizon: number): MarginCallProbability[]**
   - For each year 1 to timeHorizon:
     - probability = (count for year / totalIterations) * 100
     - cumulativeProbability = iterations with ANY call by year Y / total * 100
   - Return array of MarginCallProbability objects

4. **calculateMarginCallRisk(events: MarginCallEvent[][], totalIterations: number, timeHorizon: number): MarginCallProbability[]**
   - Convenience function combining aggregate + calculate
   - This is the main entry point for external use

The cumulative probability answers: "What's the chance I'll have experienced
at least one margin call by year Y?" This is distinct from per-year probability.

Import MarginCallEvent from ../sbloc/types.
Import MarginCallProbability from ./types.
  </action>
  <verify>npm run build succeeds without TypeScript errors</verify>
  <done>
- aggregateMarginCallEvents correctly counts events per year
- calculateMarginCallProbability returns array with year, probability, cumulativeProbability
- Cumulative probability is monotonically increasing
- Edge case: no margin calls returns all-zero probabilities
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `src/calculations/twrr.ts` exports calculateTWRR, calculatePeriodReturn, chainReturns
- [ ] `src/calculations/margin-call-probability.ts` exports calculateMarginCallRisk, aggregateMarginCallEvents
- [ ] Types imported correctly from types.ts and other modules
- [ ] No circular dependencies
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- CALC-04 (margin call probability) and CALC-07 (TWRR) requirements satisfied
- Functions ready for use by visualization layer
</success_criteria>

<output>
After completion, create `.planning/phases/05-financial-calculations/05-02-SUMMARY.md`
</output>
