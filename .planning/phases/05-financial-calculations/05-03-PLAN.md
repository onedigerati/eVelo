---
phase: 05-financial-calculations
plan: 03
type: execute
wave: 1
depends_on: []
files_modified: [src/calculations/estate.ts, src/calculations/salary-equivalent.ts, src/calculations/index.ts]
autonomous: true

must_haves:
  truths:
    - "Stepped-up basis savings calculates tax avoided at death"
    - "BBD vs Sell comparison shows advantage of BBD strategy"
    - "Embedded capital gains calculates unrealized appreciation"
    - "Estate tax exemption threshold is configurable"
    - "Salary equivalent shows pre-tax income needed for same spending"
  artifacts:
    - path: "src/calculations/estate.ts"
      provides: "Estate tax and BBD comparison calculations"
      min_lines: 120
      exports: ["calculateEstateAnalysis", "calculateBBDComparison", "calculateSteppedUpBasisSavings", "calculateEmbeddedCapitalGains"]
    - path: "src/calculations/salary-equivalent.ts"
      provides: "Tax-free withdrawal salary equivalent"
      min_lines: 50
      exports: ["calculateSalaryEquivalent"]
    - path: "src/calculations/index.ts"
      provides: "Barrel export for calculations module"
      min_lines: 20
  key_links:
    - from: "estate.ts"
      to: "types.ts"
      via: "import { EstateAnalysis, BBDComparison, CalculationConfig }"
      pattern: "from.*['\"].*types"
    - from: "index.ts"
      to: "all modules"
      via: "re-exports all calculation functions"
      pattern: "export.*from"
---

<objective>
Create estate calculations (BBD tax advantages) and salary equivalent calculation, plus barrel export.

Purpose: Estate calculations are the core value proposition of BBD - showing how much tax is avoided through stepped-up basis at death. Salary equivalent helps users understand the tax-free nature of SBLOC withdrawals in terms they can relate to (equivalent pre-tax salary).

Output: Three files - estate.ts for BBD tax analysis, salary-equivalent.ts for withdrawal comparison, index.ts for barrel export.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Source files for understanding existing types
@src/sbloc/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create estate calculations</name>
  <files>src/calculations/estate.ts</files>
  <action>
Create estate and BBD comparison calculations:

1. **calculateEmbeddedCapitalGains(currentValue: number, costBasis: number): number**
   - Formula: currentValue - costBasis
   - Represents unrealized appreciation that would be taxed if sold
   - Return 0 if negative (loss scenario)

2. **calculateSteppedUpBasisSavings(embeddedGains: number, capitalGainsTaxRate: number): number**
   - Formula: embeddedGains * capitalGainsTaxRate
   - This is the tax that heirs AVOID due to stepped-up basis
   - At death, cost basis resets to current market value

3. **calculateEstateAnalysis(params: EstateAnalysisParams): EstateAnalysis**
   Params interface:
   - terminalPortfolioValue: number
   - terminalLoanBalance: number
   - costBasis: number (original investment amount)
   - config: CalculationConfig

   Calculate:
   - netEstate = terminalPortfolioValue - terminalLoanBalance
   - embeddedCapitalGains = calculateEmbeddedCapitalGains(...)
   - steppedUpBasisSavings = calculateSteppedUpBasisSavings(...)
   - estateTaxExemption from config (note: only applies if estate > exemption)

4. **calculateTaxIfSold(portfolioValue: number, costBasis: number, config: CalculationConfig): number**
   - Capital gains tax on selling entire portfolio
   - Formula: max(0, portfolioValue - costBasis) * capitalGainsTaxRate
   - Used for BBD comparison

5. **calculateBBDComparison(params: BBDComparisonParams): BBDComparison**
   Params interface:
   - terminalPortfolioValue: number
   - terminalLoanBalance: number
   - costBasis: number
   - config: CalculationConfig

   Calculate:
   - bbdNetEstate = terminalPortfolioValue - terminalLoanBalance (heirs inherit this)
   - taxesPaidIfSold = calculateTaxIfSold(terminalPortfolioValue, costBasis, config)
   - sellNetEstate = terminalPortfolioValue - taxesPaidIfSold (no loan, but paid taxes)
   - bbdAdvantage = bbdNetEstate - sellNetEstate

   Note: This comparison assumes the alternative is selling to fund retirement
   spending instead of borrowing. The "sell" scenario pays capital gains tax but
   has no loan balance. BBD has loan balance but no capital gains tax.

Include JSDoc explaining the stepped-up basis rule:
"When a person dies, their assets receive a 'stepped-up basis' equal to the
fair market value at death. This eliminates all embedded capital gains, so
heirs can sell immediately with zero capital gains tax."

Import types from ./types.
Export all functions.
  </action>
  <verify>npm run build succeeds without TypeScript errors</verify>
  <done>
- calculateEmbeddedCapitalGains returns unrealized appreciation
- calculateSteppedUpBasisSavings returns tax avoided at death
- calculateEstateAnalysis returns complete EstateAnalysis object
- calculateBBDComparison shows advantage of BBD over selling
- ESTATE-01, ESTATE-02, ESTATE-03, ESTATE-04 requirements satisfied
  </done>
</task>

<task type="auto">
  <name>Task 2: Create salary equivalent and barrel export</name>
  <files>src/calculations/salary-equivalent.ts, src/calculations/index.ts</files>
  <action>
**salary-equivalent.ts:**

Create salary equivalent calculation:

1. **calculateSalaryEquivalent(annualWithdrawal: number, effectiveTaxRate: number): SalaryEquivalent**
   - SBLOC withdrawals are not taxable income
   - To get $X tax-free, you'd need to earn: X / (1 - taxRate) as salary
   - Formula: salaryEquivalent = annualWithdrawal / (1 - effectiveTaxRate)
   - taxSavings = salaryEquivalent - annualWithdrawal

   Example: $50k withdrawal at 37% tax rate
   - salaryEquivalent = 50000 / (1 - 0.37) = ~$79,365
   - taxSavings = 79365 - 50000 = ~$29,365 annually

   Return SalaryEquivalent object with all fields.

Include JSDoc explaining the concept:
"SBLOC withdrawals are loan proceeds, not income. Unlike salary which is taxed,
you keep 100% of what you borrow. To have the same spending power from salary,
you'd need to earn significantly more to net the same after-tax amount."

**index.ts:**

Create barrel export for entire calculations module:

```typescript
// Types
export type {
  MetricsSummary,
  MarginCallProbability,
  TWRRResult,
  EstateAnalysis,
  BBDComparison,
  SalaryEquivalent,
  CalculationConfig,
} from './types';

export { DEFAULT_CALCULATION_CONFIG } from './types';

// Core metrics
export {
  calculateCAGR,
  calculateAnnualizedVolatility,
  extractPercentiles,
  calculateSuccessRate,
  calculateMetricsSummary,
} from './metrics';

// TWRR
export {
  calculateTWRR,
  calculatePeriodReturn,
  chainReturns,
} from './twrr';

// Margin call probability
export {
  calculateMarginCallRisk,
  aggregateMarginCallEvents,
} from './margin-call-probability';

// Estate calculations
export {
  calculateEstateAnalysis,
  calculateBBDComparison,
  calculateSteppedUpBasisSavings,
  calculateEmbeddedCapitalGains,
} from './estate';

// Salary equivalent
export { calculateSalaryEquivalent } from './salary-equivalent';
```
  </action>
  <verify>npm run build succeeds without TypeScript errors</verify>
  <done>
- calculateSalaryEquivalent returns correct pre-tax equivalent
- index.ts exports all types and functions from all modules
- CALC-05 (salary equivalent) requirement satisfied
- Complete calculations module ready for use
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `src/calculations/estate.ts` exports all 4 estate-related functions
- [ ] `src/calculations/salary-equivalent.ts` exports calculateSalaryEquivalent
- [ ] `src/calculations/index.ts` re-exports everything from all modules
- [ ] All imports between modules resolve correctly
- [ ] No circular dependencies
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- CALC-05 (salary equivalent), ESTATE-01, ESTATE-02, ESTATE-03, ESTATE-04 requirements satisfied
- Complete calculations module available via single import
</success_criteria>

<output>
After completion, create `.planning/phases/05-financial-calculations/05-03-SUMMARY.md`
</output>
