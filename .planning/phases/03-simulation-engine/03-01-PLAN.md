---
phase: 03-simulation-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - vite.config.ts
  - src/vite-env.d.ts
  - src/simulation/types.ts
autonomous: true

must_haves:
  truths:
    - "vite-plugin-comlink installed and configured"
    - "Worker builds work with TypeScript"
    - "Simulation types defined for all subsequent plans"
  artifacts:
    - path: "src/simulation/types.ts"
      provides: "SimulationConfig, SimulationResult, RegimeParams, TransitionMatrix types"
      min_lines: 50
  key_links:
    - from: "vite.config.ts"
      to: "comlink plugin"
      via: "plugins array"
      pattern: "comlink\\(\\)"
---

<objective>
Install vite-plugin-comlink and create simulation-specific types for Web Worker communication.

Purpose: Establish worker build infrastructure and type definitions that all subsequent plans depend on.
Output: Working Comlink configuration and comprehensive simulation types.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-simulation-engine/03-RESEARCH.md

@src/types/simulation.ts
@vite.config.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install vite-plugin-comlink and update Vite config</name>
  <files>package.json, vite.config.ts, src/vite-env.d.ts</files>
  <action>
    1. Run `npm install -D vite-plugin-comlink`
    2. Update vite.config.ts to import and use comlink plugin:
       - Import: `import { comlink } from 'vite-plugin-comlink'`
       - Add to plugins array: `comlink()`
       - Add worker config: `worker: { plugins: () => [comlink()] }`
    3. Update src/vite-env.d.ts to add type reference:
       - Add line: `/// <reference types="vite-plugin-comlink/client" />`

    Do NOT modify existing viteSingleFile plugin configuration.
  </action>
  <verify>npm run build succeeds without errors</verify>
  <done>vite-plugin-comlink installed and configured for worker builds</done>
</task>

<task type="auto">
  <name>Task 2: Create comprehensive simulation types</name>
  <files>src/simulation/types.ts</files>
  <action>
    Create src/simulation/types.ts with complete type definitions:

    1. **SimulationConfig** (expanded from existing):
       - iterations: number (1000-100000)
       - timeHorizon: number (10-50 years)
       - initialValue: number
       - inflationRate: number (for real vs nominal)
       - inflationAdjusted: boolean
       - resamplingMethod: 'simple' | 'block' | 'regime'
       - blockSize?: number
       - seed?: string (for reproducibility)

    2. **PortfolioConfig** (for simulation input):
       - assets: AssetConfig[]
       - correlationMatrix: number[][]

    3. **AssetConfig**:
       - id: string
       - weight: number
       - historicalReturns: number[]
       - regimeParams?: RegimeParams

    4. **RegimeParams**:
       - mean: number
       - stddev: number

    5. **TransitionMatrix**:
       - bull: { bull: number; bear: number; crash: number }
       - bear: { bull: number; bear: number; crash: number }
       - crash: { bull: number; bear: number; crash: number }

    6. **SimulationProgress**:
       - percent: number (0-100)
       - currentIteration: number
       - status: 'running' | 'complete' | 'cancelled'

    7. **SimulationOutput** (worker return type):
       - terminalValues: Float64Array
       - yearlyPercentiles: YearlyPercentiles[]
       - statistics: SimulationStatistics

    8. **YearlyPercentiles**:
       - year: number
       - p10: number
       - p25: number
       - p50: number
       - p75: number
       - p90: number

    9. **SimulationStatistics**:
       - mean: number
       - median: number
       - stddev: number
       - successRate: number (% above initial value)

    10. **MarketRegime** type: 'bull' | 'bear' | 'crash'

    11. **DEFAULT_TRANSITION_MATRIX** constant (from research):
        - bull: { bull: 0.97, bear: 0.025, crash: 0.005 }
        - bear: { bull: 0.03, bear: 0.95, crash: 0.02 }
        - crash: { bull: 0.10, bear: 0.30, crash: 0.60 }

    12. **DEFAULT_REGIME_PARAMS** constant:
        - bull: { mean: 0.12, stddev: 0.12 }
        - bear: { mean: -0.08, stddev: 0.20 }
        - crash: { mean: -0.30, stddev: 0.35 }

    Export all types and constants.
  </action>
  <verify>tsc --noEmit passes with no type errors</verify>
  <done>All simulation types defined and exportable</done>
</task>

<task type="auto">
  <name>Task 3: Create simulation module directory structure</name>
  <files>src/simulation/index.ts</files>
  <action>
    Create src/simulation/index.ts as barrel export:

    ```typescript
    /**
     * Simulation module barrel export
     *
     * Provides Monte Carlo simulation with Web Worker support:
     * - Types for configuration and results
     * - Worker-based non-blocking simulation
     * - Bootstrap and regime-switching return generation
     */

    // Re-export all types
    export * from './types';

    // Main API will be added in Plan 04
    ```

    This establishes the module structure for subsequent plans.
  </action>
  <verify>Import from '@/simulation' resolves correctly</verify>
  <done>Simulation module structure established with types export</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run dev` starts without errors
- [ ] vite-plugin-comlink appears in node_modules
- [ ] Types import correctly: `import { SimulationConfig } from '@/simulation'`
</verification>

<success_criteria>

- All tasks completed
- vite-plugin-comlink installed and configured
- Comprehensive simulation types defined
- Module barrel export established
- Build and dev server work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/03-simulation-engine/03-01-SUMMARY.md`
</output>
