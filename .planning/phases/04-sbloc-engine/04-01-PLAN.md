---
phase: 04-sbloc-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/sbloc/types.ts
  - src/sbloc/interest.ts
autonomous: true

must_haves:
  truths:
    - "SBLOC configuration types compile and export correctly"
    - "Interest accrual calculation produces correct compound interest"
    - "Annual and monthly interest calculations match financial formulas"
  artifacts:
    - path: "src/sbloc/types.ts"
      provides: "SBLOC type definitions (config, state, events)"
      min_lines: 60
      exports: ["SBLOCConfig", "SBLOCState", "MarginCallEvent", "LiquidationEvent"]
    - path: "src/sbloc/interest.ts"
      provides: "Interest accrual calculations"
      min_lines: 40
      exports: ["accrueInterest", "calculateAnnualInterest", "calculateMonthlyInterest"]
  key_links:
    - from: "src/sbloc/interest.ts"
      to: "src/sbloc/types.ts"
      via: "imports SBLOCConfig, SBLOCState"
      pattern: "import.*from.*types"
---

<objective>
Create SBLOC type definitions and interest accrual calculations.

Purpose: Establish the foundational types for securities-backed lending simulation and implement correct compound interest calculations following CFA financial formulas.

Output: SBLOC types module and interest calculation module ready for LTV and margin call detection.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-simulation-engine/03-04-SUMMARY.md

# Reference implementation patterns
# From references/PortfolioStrategySimulator.html:
# - locBalance: Current loan balance
# - sblocRate: Annual interest rate (e.g., 0.074 for 7.4%)
# - maxBorrowing: Max LTV ratio (e.g., 0.65 for 65%)
# - maintenanceMargin: Warning threshold (e.g., 0.50 for 50%)
# - liquidationHaircut: Forced sale loss (e.g., 0.05 for 5%)
# - Interest accrual: locBalance *= (1 + sblocRate) per year
# - Monthly variant: locBalance *= (1 + monthlyRate) where monthlyRate = sblocRate/12

@src/simulation/types.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SBLOC type definitions</name>
  <files>src/sbloc/types.ts</files>
  <action>
Create comprehensive SBLOC type definitions:

**SBLOCConfig** - User-configurable SBLOC terms:
- annualInterestRate: number (e.g., 0.074 for 7.4%)
- maxLTV: number - max borrowing percentage before margin call (e.g., 0.65 for 65%)
- maintenanceMargin: number - warning zone threshold (e.g., 0.50 for 50%)
- liquidationHaircut: number - forced sale loss percentage (e.g., 0.05 for 5%)
- annualWithdrawal: number - annual draw amount in dollars
- compoundingFrequency: 'annual' | 'monthly' - how interest compounds
- startYear: number - when BBD withdrawals begin (0 = immediately)

**SBLOCState** - Current state during simulation:
- loanBalance: number - current LOC balance
- portfolioValue: number - current collateral value
- currentLTV: number - loan / portfolio ratio
- inWarningZone: boolean - between maintenance and max
- yearsSinceStart: number - years into withdrawal phase

**MarginCallEvent** - Triggered when LTV exceeds max:
- year: number
- ltvAtTrigger: number
- loanBalance: number
- portfolioValue: number

**LiquidationEvent** - Result of forced liquidation:
- year: number
- assetsLiquidated: number
- haircut: number
- loanRepaid: number
- newLoanBalance: number
- newPortfolioValue: number
- capitalGainsTax: number (optional, for future use)

**LTVByAssetClass** - Different LTV limits by asset type:
- equities: number (typically 0.50-0.70)
- bonds: number (typically 0.80-0.95)
- cash: number (typically 0.95-1.00)

Include JSDoc comments explaining each field. Export all types.
  </action>
  <verify>tsc --noEmit passes with types imported in a test file</verify>
  <done>All SBLOC types exported and documented, compilable without errors</done>
</task>

<task type="auto">
  <name>Task 2: Create interest accrual calculations</name>
  <files>src/sbloc/interest.ts</files>
  <action>
Create interest accrual module with pure functions:

**accrueInterest(state: SBLOCState, config: SBLOCConfig): SBLOCState**
- Apply one period of interest based on compounding frequency
- Annual: newBalance = oldBalance * (1 + rate)
- Monthly: newBalance = oldBalance * (1 + rate/12)
- Return new state with updated loanBalance
- Do NOT mutate input state (pure function)

**calculateAnnualInterest(principal: number, rate: number): number**
- Simple annual interest calculation: principal * rate
- Used for reporting and estimates

**calculateMonthlyInterest(principal: number, annualRate: number): number**
- Monthly interest: principal * (annualRate / 12)

**projectLoanBalance(config: SBLOCConfig, years: number, initialBalance?: number): number**
- Project loan balance after N years with compound interest
- Includes annual withdrawals: each year adds withdrawal + interest
- Formula for each year: (balance + withdrawal) * (1 + rate)
- Use for "what if" projections

Include JSDoc with:
- Formula citations (compound interest formula)
- Example usage
- Edge case handling (zero balance, zero rate)

Follow patterns from math module (Kahan summation NOT needed here - simple multiplication).
  </action>
  <verify>npm run build succeeds, functions are importable</verify>
  <done>Interest accrual functions work correctly: 100k at 7.4% annual = 107,400 after 1 year; 100k + 50k withdrawal at 7.4% = 161,100 after 1 year</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds without errors
- [ ] src/sbloc/types.ts exports all types (SBLOCConfig, SBLOCState, MarginCallEvent, LiquidationEvent)
- [ ] src/sbloc/interest.ts exports accrueInterest, calculateAnnualInterest, calculateMonthlyInterest, projectLoanBalance
- [ ] Types and functions are importable from sbloc module
- [ ] No TypeScript errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Interest calculations match financial formulas
- SBLOC-01 (configure SBLOC terms) types ready
- SBLOC-02 (interest accrual) implemented
</success_criteria>

<output>
After completion, create `.planning/phases/04-sbloc-engine/04-01-SUMMARY.md`
</output>
