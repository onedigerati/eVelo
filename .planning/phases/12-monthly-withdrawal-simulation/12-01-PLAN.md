---
phase: 12-monthly-withdrawal-simulation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/sbloc/monthly.ts
  - src/sbloc/index.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "annualToMonthlyReturns() converts annual return to 12 equal monthly returns that compound to same total"
    - "stepSBLOCMonth() executes one month of SBLOC simulation with 1/12 withdrawal"
    - "stepSBLOCYear() executes 12 monthly substeps when monthlyWithdrawal is true"
    - "stepSBLOCYear() delegates to stepSBLOC() when monthlyWithdrawal is false"
  artifacts:
    - path: "src/sbloc/monthly.ts"
      provides: "Monthly step functions and return distribution"
      exports: ["annualToMonthlyReturns", "stepSBLOCMonth", "stepSBLOCYear"]
    - path: "src/sbloc/index.ts"
      provides: "Barrel export including monthly module"
      contains: "monthly"
  key_links:
    - from: "src/sbloc/monthly.ts"
      to: "src/sbloc/engine.ts"
      via: "import stepSBLOC"
      pattern: "import.*stepSBLOC.*from.*engine"
    - from: "src/sbloc/monthly.ts"
      to: "src/sbloc/types.ts"
      via: "import types"
      pattern: "import.*SBLOCConfig.*from.*types"
---

<objective>
Create monthly step functions for SBLOC simulation with proper return distribution.

Purpose: Enable monthly granularity for SBLOC simulation when monthlyWithdrawal flag is set,
providing more accurate interest accrual and earlier margin call detection.

Output: New monthly.ts module with stepSBLOCYear() wrapper, stepSBLOCMonth() for individual
months, and annualToMonthlyReturns() helper for distributing annual returns.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-monthly-withdrawal-simulation/12-RESEARCH.md
@src/sbloc/engine.ts
@src/sbloc/types.ts
@src/sbloc/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create monthly.ts with return distribution and monthly step functions</name>
  <files>src/sbloc/monthly.ts</files>
  <action>
Create new file `src/sbloc/monthly.ts` with three exported functions:

1. **annualToMonthlyReturns(annualReturn: number): number[]**
   - Convert annual return to 12 equal monthly returns
   - Formula: `monthlyReturn = Math.pow(1 + annualReturn, 1/12) - 1`
   - Return `Array(12).fill(monthlyReturn)`
   - Example: 10% annual -> ~0.797% monthly, compounds back to ~10%

2. **stepSBLOCMonth(state, config, monthlyReturn, currentYear, currentMonth): SBLOCYearResult**
   - Execute one month of SBLOC simulation
   - Adjust config for monthly: `annualWithdrawal / 12`, `compoundingFrequency: 'monthly'`
   - Call stepSBLOC with adjusted parameters
   - Handle yearsSinceStart: keep unchanged during months, only increment at month 11
   - Return same SBLOCYearResult type for consistency

3. **stepSBLOCYear(state, config, portfolioReturn, currentYear, monthlyWithdrawal): SBLOCYearResult**
   - Wrapper function that orchestrates annual vs monthly mode
   - If `monthlyWithdrawal === false`: call `stepSBLOC()` directly (backward compatible)
   - If `monthlyWithdrawal === true`:
     - Convert annual return to 12 monthly returns via `annualToMonthlyReturns()`
     - Loop 12 times calling `stepSBLOCMonth()`
     - Accumulate totals: interestCharged, withdrawalMade
     - Track first margin call and liquidation event
     - If portfolioFailed in any month, break loop and set portfolioFailed
     - Return aggregated SBLOCYearResult with final state

Include JSDoc comments explaining:
- Why monthly compounding produces ~0.3% higher effective interest rate
- That withdrawal timing is month-start (withdrawal added before interest)
- That yearsSinceStart only increments at year boundary

Import types from './types' and stepSBLOC from './engine'.
  </action>
  <verify>
Run: `npx tsc --noEmit`
Verify no TypeScript errors. Check that monthly.ts exports all three functions.
  </verify>
  <done>
monthly.ts exists with annualToMonthlyReturns(), stepSBLOCMonth(), and stepSBLOCYear() functions.
All functions have proper TypeScript types and JSDoc documentation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update barrel export and add unit tests</name>
  <files>src/sbloc/index.ts</files>
  <action>
Update `src/sbloc/index.ts` to include the new monthly module:

1. Add export: `export * from './monthly';`

2. Verify the barrel now exports:
   - Types from types.ts
   - Interest functions from interest.ts
   - LTV/margin call functions from ltv.ts, margin-call.ts
   - Liquidation from liquidation.ts
   - Engine functions from engine.ts (stepSBLOC, initializeSBLOCState, SBLOCYearResult)
   - Monthly functions from monthly.ts (annualToMonthlyReturns, stepSBLOCMonth, stepSBLOCYear)

The barrel export ensures consumers can import from '@/sbloc' or '../sbloc' and get all functions.
  </action>
  <verify>
Run: `npx tsc --noEmit`
Check that importing from './sbloc' includes stepSBLOCYear.
  </verify>
  <done>
src/sbloc/index.ts exports monthly.ts functions.
All SBLOC module functions accessible via barrel export.
  </done>
</task>

<task type="auto">
  <name>Task 3: Validate backward compatibility</name>
  <files>src/sbloc/monthly.ts</files>
  <action>
Add inline validation comments and ensure backward compatibility:

1. In stepSBLOCYear(), ensure the `monthlyWithdrawal === false` path:
   - Calls stepSBLOC() with IDENTICAL parameters
   - Returns the EXACT same SBLOCYearResult that stepSBLOC returns
   - No modifications to state or result

2. Document expected differences when monthlyWithdrawal is true:
   - Monthly compounding: ~7.66% effective vs 7.4% nominal (for 7.4% annual rate)
   - Interest accrues on withdrawal immediately (each month)
   - Margin calls can trigger mid-year (at any of 12 checkpoints)
   - Total withdrawal amount is same ($50k/year = 12 x $4,166.67)

3. Add a verification example in JSDoc:
   ```typescript
   // Verification: monthlyWithdrawal=false produces identical results
   // const annual = stepSBLOC(state, config, 0.10, year);
   // const wrapped = stepSBLOCYear(state, config, 0.10, year, false);
   // assert(annual.newState.loanBalance === wrapped.newState.loanBalance);
   ```
  </action>
  <verify>
Run: `npm run build`
Verify build succeeds with no errors or warnings.
  </verify>
  <done>
stepSBLOCYear with monthlyWithdrawal=false produces identical results to stepSBLOC.
Expected differences for monthlyWithdrawal=true are documented.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Build succeeds: `npm run build`
3. Monthly module exports are accessible: check index.ts includes monthly exports
4. Function signatures match expected types from research document
</verification>

<success_criteria>
- annualToMonthlyReturns(0.10) returns array of 12 values that compound to ~10%
- stepSBLOCMonth executes single month with 1/12 withdrawal
- stepSBLOCYear with monthlyWithdrawal=false returns identical results to stepSBLOC
- stepSBLOCYear with monthlyWithdrawal=true processes 12 monthly substeps
- All functions exported via src/sbloc/index.ts barrel
</success_criteria>

<output>
After completion, create `.planning/phases/12-monthly-withdrawal-simulation/12-01-SUMMARY.md`
</output>
