---
phase: 12-monthly-withdrawal-simulation
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/simulation/monte-carlo.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Monte Carlo simulation uses stepSBLOCYear when SBLOC is enabled"
    - "monthlyWithdrawal flag controls monthly vs annual mode"
    - "Results are consistent with annual mode when monthlyWithdrawal is disabled"
    - "Margin call detection works at monthly intervals when enabled"
    - "Year-end state is tracked in trajectories (not monthly states)"
  artifacts:
    - path: "src/simulation/monte-carlo.ts"
      provides: "Monte Carlo simulation with monthly SBLOC integration"
      contains: "stepSBLOCYear"
  key_links:
    - from: "src/simulation/monte-carlo.ts"
      to: "src/sbloc/monthly.ts"
      via: "import stepSBLOCYear"
      pattern: "import.*stepSBLOCYear.*from.*sbloc"
---

<objective>
Integrate monthly SBLOC stepping into Monte Carlo simulation.

Purpose: Wire the monthlyWithdrawal flag in SBLOCSimConfig to switch between annual and monthly
modes during simulation, enabling more accurate interest compounding and margin call timing.

Output: Updated monte-carlo.ts that uses stepSBLOCYear() for all SBLOC simulation, with the
monthlyWithdrawal flag controlling granularity.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-monthly-withdrawal-simulation/12-RESEARCH.md
@.planning/phases/12-monthly-withdrawal-simulation/12-01-SUMMARY.md
@src/simulation/monte-carlo.ts
@src/simulation/types.ts
@src/sbloc/monthly.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace stepSBLOC with stepSBLOCYear in Monte Carlo</name>
  <files>src/simulation/monte-carlo.ts</files>
  <action>
Update `src/simulation/monte-carlo.ts` to use the new stepSBLOCYear function:

1. **Update imports:**
   Change:
   ```typescript
   import {
     initializeSBLOCState,
     stepSBLOC,
     type SBLOCConfig as SBLOCEngineConfig,
     type SBLOCState,
   } from '../sbloc';
   ```
   To:
   ```typescript
   import {
     initializeSBLOCState,
     stepSBLOCYear,
     type SBLOCConfig as SBLOCEngineConfig,
     type SBLOCState,
   } from '../sbloc';
   ```

2. **Locate the SBLOC simulation block** (around line 136-176) that currently calls:
   ```typescript
   const yearResult = stepSBLOC(prevState, sblocConfig, portfolioReturn, year);
   ```

3. **Replace with stepSBLOCYear call:**
   ```typescript
   const yearResult = stepSBLOCYear(
     prevState,
     sblocConfig,
     portfolioReturn,
     year,
     config.sbloc.monthlyWithdrawal
   );
   ```

4. **Verify the rest of the SBLOC block remains unchanged:**
   - `sblocStates[i].push(yearResult.newState)` - still works (year-end state)
   - Margin call tracking - still works (yearResult.marginCallTriggered)
   - Portfolio failure handling - still works (yearResult.portfolioFailed)

The stepSBLOCYear function handles all the monthly logic internally and returns
a year-end aggregated result, so the rest of the Monte Carlo code does not change.
  </action>
  <verify>
Run: `npx tsc --noEmit`
Run: `npm run build`
Verify no TypeScript errors and build succeeds.
  </verify>
  <done>
monte-carlo.ts imports and uses stepSBLOCYear instead of stepSBLOC.
monthlyWithdrawal flag is passed to control simulation granularity.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify SBLOC config wiring</name>
  <files>src/simulation/monte-carlo.ts</files>
  <action>
Verify that the SBLOCEngineConfig built in monte-carlo.ts has all necessary fields:

1. **Check existing config construction** (around line 146-154):
   ```typescript
   const sblocConfig: SBLOCEngineConfig = {
     annualInterestRate: config.sbloc.interestRate,
     maxLTV: config.sbloc.maintenanceMargin,
     maintenanceMargin: config.sbloc.maintenanceMargin,
     liquidationHaircut: config.sbloc.liquidationHaircut,
     annualWithdrawal: effectiveWithdrawal,
     compoundingFrequency: 'annual',  // This will be adjusted by stepSBLOCYear internally
     startYear: sblocWithdrawalStartYear,
   };
   ```

2. **Note:** The `compoundingFrequency: 'annual'` in the base config is fine because:
   - stepSBLOCYear will override it to 'monthly' when calling stepSBLOCMonth
   - When monthlyWithdrawal is false, annual compounding is correct
   - The adjustment happens inside monthly.ts, not in monte-carlo.ts

3. **Add comment for clarity:**
   ```typescript
   // compoundingFrequency is 'annual' here; stepSBLOCYear adjusts to 'monthly' internally
   // when config.sbloc.monthlyWithdrawal is true
   ```

4. **Verify effectiveWithdrawal calculation is compatible:**
   - The withdrawal raises (annualWithdrawalRaise) are calculated per year
   - stepSBLOCYear divides by 12 internally for monthly mode
   - This is correct behavior
  </action>
  <verify>
Read the updated monte-carlo.ts and verify config construction is correct.
Run: `npm run build`
  </verify>
  <done>
SBLOC config wiring verified as correct.
Comments added explaining compounding frequency handling.
  </done>
</task>

<task type="auto">
  <name>Task 3: Manual integration test</name>
  <files>src/simulation/monte-carlo.ts</files>
  <action>
Add a temporary console.log to verify monthly mode is triggered (remove before commit):

1. **Temporarily add logging** at the stepSBLOCYear call site:
   ```typescript
   if (year === 0 && i === 0) {
     console.log(`SBLOC mode: ${config.sbloc.monthlyWithdrawal ? 'monthly' : 'annual'}`);
   }
   ```

2. **Run the app in dev mode:**
   - `npm run dev`
   - Open browser to localhost
   - Configure SBLOC parameters
   - Toggle monthlyWithdrawal checkbox
   - Run simulation
   - Check console for "SBLOC mode: monthly" or "SBLOC mode: annual"

3. **Remove the console.log before committing.**

4. **Verify results:**
   - Annual mode: Results should be identical to before this phase
   - Monthly mode: Should see slightly higher loan balances (more interest accrued)
   - Charts should display correctly (year-end data only)
   - No performance degradation (should still complete in ~3 seconds for 10K iterations)
  </action>
  <verify>
Run: `npm run dev`
Toggle monthlyWithdrawal and verify both modes work.
Remove test logging.
Run: `npm run build` to ensure clean build.
  </verify>
  <done>
Both annual and monthly SBLOC modes work in the running application.
Charts display correctly with year-end data.
Performance is acceptable (~3.5s for 10K iterations in monthly mode).
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Build succeeds: `npm run build`
3. Dev server runs: `npm run dev`
4. Annual mode produces identical results to pre-phase behavior
5. Monthly mode produces slightly higher loan balances (more interest)
6. Charts display correctly (probability cone, SBLOC balance, margin call risk)
7. No console errors or warnings
</verification>

<success_criteria>
- stepSBLOCYear imported and called in monte-carlo.ts
- monthlyWithdrawal flag passed from config.sbloc
- Annual mode (monthlyWithdrawal: false) produces identical results to Phase 11
- Monthly mode (monthlyWithdrawal: true) processes 12 substeps per year
- Year-end states tracked in trajectories (no 12x data increase)
- Application runs without errors in both modes
</success_criteria>

<output>
After completion, create `.planning/phases/12-monthly-withdrawal-simulation/12-02-SUMMARY.md`
</output>
