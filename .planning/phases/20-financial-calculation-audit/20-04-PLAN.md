---
phase: 20-financial-calculation-audit
plan: 04
type: execute
wave: 3
depends_on: ["20-01", "20-03"]
files_modified:
  - src/calculations/sell-strategy.ts
autonomous: true

must_haves:
  truths:
    - "Sell strategy accepts configurable cost basis ratio"
    - "Sell strategy accepts configurable dividend yield"
    - "UI can pass user-specified values to calculation"
  artifacts:
    - path: "src/calculations/sell-strategy.ts"
      provides: "Updated function signature accepting full config"
  key_links:
    - from: "src/calculations/sell-strategy.ts"
      to: "src/config/calculation-defaults.ts"
      via: "import DEFAULT_SELL_CONFIG"
      pattern: "import.*DEFAULT_SELL_CONFIG"
---

<objective>
Wire configurable cost basis and dividend yield to Sell strategy

Purpose: Address Risk Areas #1 and #2 (hardcoded cost basis 40% and dividend yield 2%). While these values are already in the config interface, ensure they're properly used from the centralized config module and document how to override them.

Output: Updated sell-strategy.ts that imports from config module and clearly uses configurable values.
</objective>

<execution_context>
@C:\Users\ungac\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ungac\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/20-financial-calculation-audit/20-01-PLAN.md
@.planning/phases/20-financial-calculation-audit/20-03-SUMMARY.md
@src/calculations/sell-strategy.ts
@src/config/calculation-defaults.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Import centralized config and use for defaults</name>
  <files>src/calculations/sell-strategy.ts</files>
  <action>
Update sell-strategy.ts to use centralized config:

1. Add import at top of file:
```typescript
import { DEFAULT_SELL_CONFIG } from '../config';
```

2. Update the default value destructuring in calculateSellStrategy (around line 149-160):
```typescript
const {
  initialValue,
  annualWithdrawal,
  withdrawalGrowth,
  timeHorizon,
  // Use centralized defaults from config module
  capitalGainsRate = DEFAULT_SELL_CONFIG.capitalGainsRate,
  costBasisRatio = DEFAULT_SELL_CONFIG.costBasisRatio,
} = config;

// Extract dividend config with centralized defaults
const dividendYield = config.dividendYield ?? DEFAULT_SELL_CONFIG.dividendYield;
const dividendTaxRate = config.dividendTaxRate ?? DEFAULT_SELL_CONFIG.dividendTaxRate;
```

3. Update the function JSDoc to document the config parameters:
```typescript
/**
 * Calculate Sell Assets strategy outcomes from BBD simulation data.
 *
 * @param config - Sell strategy configuration
 * @param config.costBasisRatio - Cost basis as fraction of portfolio (default: 0.4 = 60% embedded gains)
 *   Users should adjust based on their portfolio's actual cost basis.
 *   - Recent IPO investor: 0.9-0.95 (mostly basis, little gain)
 *   - Long-term holder (20+ years): 0.2-0.4 (mostly gains)
 *   - Inherited portfolio: varies based on stepped-up basis
 * @param config.dividendYield - Annual dividend yield (default: 0.02 = 2%)
 *   S&P 500 average is ~1.5-2%. Growth portfolios may be lower (0.5-1%).
 *   High-yield or dividend portfolios may be 3-5%.
 * @param yearlyPercentiles - Portfolio percentiles from BBD simulation
 * @returns Sell strategy result with all metrics
 */
```

This centralizes the source of defaults while maintaining backward compatibility.
  </action>
  <verify>`npx tsc --noEmit` passes</verify>
  <done>Sell strategy uses centralized config for defaults</done>
</task>

<task type="auto">
  <name>Task 2: Add explicit config validation and logging</name>
  <files>src/calculations/sell-strategy.ts</files>
  <action>
Add configuration validation at the start of calculateSellStrategy:

```typescript
// Validate and log configuration for debugging
if (process.env.NODE_ENV !== 'production') {
  console.debug('Sell strategy config:', {
    costBasisRatio,
    dividendYield,
    capitalGainsRate,
    dividendTaxRate,
    annualWithdrawal,
    timeHorizon,
  });
}

// Validate cost basis ratio is in valid range
if (costBasisRatio < 0 || costBasisRatio > 1) {
  console.warn(`Invalid costBasisRatio ${costBasisRatio}, using default ${DEFAULT_SELL_CONFIG.costBasisRatio}`);
  // Note: TypeScript won't allow reassignment, so use default in calculation
}

// Validate dividend yield is reasonable
if (dividendYield < 0 || dividendYield > 0.15) {
  console.warn(`Unusual dividendYield ${dividendYield * 100}%, typical range is 0-10%`);
}
```

This helps users catch configuration errors and ensures calculations use valid values.
  </action>
  <verify>`npx tsc --noEmit` passes</verify>
  <done>Configuration validated and logged for debugging</done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` - should pass
2. Check that DEFAULT_SELL_CONFIG is imported from config module
3. Verify console.debug shows config values when running in dev mode
4. Test with custom config:
   - costBasisRatio: 0.8 (80% basis, 20% gains)
   - dividendYield: 0.04 (4% high-yield portfolio)
   - Verify results differ from defaults
</verification>

<success_criteria>
- Defaults sourced from centralized config module
- Config parameters documented in JSDoc
- Validation warns on unusual values
- Debug logging shows actual config used
</success_criteria>

<output>
After completion, create `.planning/phases/20-financial-calculation-audit/20-04-SUMMARY.md`
</output>
