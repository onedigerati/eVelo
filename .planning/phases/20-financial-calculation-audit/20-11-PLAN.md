---
phase: 20-financial-calculation-audit
plan: 11
type: execute
wave: 4
depends_on: ["20-09", "20-10"]
files_modified:
  - src/calculations/__tests__/integration.test.ts
autonomous: true
checkpoint: human-verify

must_haves:
  truths:
    - "Integration tests verify configuration flows through system"
    - "Dashboard outputs match calculation sources"
    - "All 13 risk areas addressed"
  artifacts:
    - path: "src/calculations/__tests__/integration.test.ts"
      provides: "Integration tests for config flow"
  key_links:
    - from: "src/calculations/__tests__/integration.test.ts"
      to: "src/components/ui/results-dashboard.ts"
      via: "tests verify dashboard calculations"
---

<objective>
Final verification and integration testing

Purpose: Verify that all 13 risk areas have been addressed and that configuration changes properly flow through the entire system. Create integration tests and perform manual verification.

Output: Integration test suite and verified calculation accuracy.
</objective>

<execution_context>
@C:\Users\ungac\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ungac\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/20-financial-calculation-audit/20-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create integration test for configuration threading</name>
  <files>src/calculations/__tests__/integration.test.ts</files>
  <action>
Create integration tests that verify configuration flows through the system:

```typescript
import { describe, test, expect } from 'vitest';
import { calculateSellStrategy } from '../sell-strategy';
import { DEFAULT_SELL_CONFIG } from '../../config';
import type { YearlyPercentiles } from '../../simulation/types';

// Create mock percentile data for testing
function createMockPercentiles(years: number, initialValue: number, cagr: number): YearlyPercentiles[] {
  const result: YearlyPercentiles[] = [];
  for (let year = 0; year <= years; year++) {
    const value = initialValue * Math.pow(1 + cagr, year);
    result.push({
      year,
      p10: value * 0.7,
      p25: value * 0.85,
      p50: value,
      p75: value * 1.15,
      p90: value * 1.3,
    });
  }
  return result;
}

describe('Configuration Threading Integration', () => {
  describe('Cost Basis Impact', () => {
    test('higher cost basis results in lower taxes', () => {
      const baseConfig = {
        initialValue: 5000000,
        annualWithdrawal: 200000,
        withdrawalGrowth: 0.03,
        timeHorizon: 30,
      };
      const percentiles = createMockPercentiles(30, 5000000, 0.07);

      // 20% basis = 80% gains (high taxes)
      const lowBasis = calculateSellStrategy(
        { ...baseConfig, costBasisRatio: 0.2 },
        percentiles
      );

      // 80% basis = 20% gains (low taxes)
      const highBasis = calculateSellStrategy(
        { ...baseConfig, costBasisRatio: 0.8 },
        percentiles
      );

      expect(lowBasis.lifetimeTaxes).toBeGreaterThan(highBasis.lifetimeTaxes);
      // Difference should be substantial (at least 50% more taxes)
      expect(lowBasis.lifetimeTaxes / highBasis.lifetimeTaxes).toBeGreaterThan(1.5);
    });
  });

  describe('Dividend Yield Impact', () => {
    test('higher dividend yield results in higher dividend taxes', () => {
      const baseConfig = {
        initialValue: 5000000,
        annualWithdrawal: 200000,
        withdrawalGrowth: 0.03,
        timeHorizon: 30,
      };
      const percentiles = createMockPercentiles(30, 5000000, 0.07);

      // 0% dividend yield (growth portfolio)
      const noDividends = calculateSellStrategy(
        { ...baseConfig, dividendYield: 0 },
        percentiles
      );

      // 4% dividend yield (income portfolio)
      const highDividends = calculateSellStrategy(
        { ...baseConfig, dividendYield: 0.04 },
        percentiles
      );

      expect(noDividends.lifetimeDividendTaxes).toBe(0);
      expect(highDividends.lifetimeDividendTaxes).toBeGreaterThan(0);
      // High dividends should result in significant tax
      expect(highDividends.totalLifetimeTaxes).toBeGreaterThan(noDividends.totalLifetimeTaxes);
    });
  });

  describe('Default Config Values', () => {
    test('DEFAULT_SELL_CONFIG has expected values', () => {
      expect(DEFAULT_SELL_CONFIG.costBasisRatio).toBe(0.4);
      expect(DEFAULT_SELL_CONFIG.dividendYield).toBe(0.02);
      expect(DEFAULT_SELL_CONFIG.capitalGainsRate).toBe(0.238);
      expect(DEFAULT_SELL_CONFIG.dividendTaxRate).toBe(0.238);
    });

    test('calculation uses defaults when config not provided', () => {
      const config = {
        initialValue: 5000000,
        annualWithdrawal: 200000,
        withdrawalGrowth: 0.03,
        timeHorizon: 30,
        // No costBasisRatio or dividendYield - should use defaults
      };
      const percentiles = createMockPercentiles(30, 5000000, 0.07);

      const result = calculateSellStrategy(config, percentiles);

      // Should produce valid results with defaults
      expect(result.terminalNetWorth).toBeGreaterThan(0);
      expect(result.lifetimeTaxes).toBeGreaterThan(0);
      expect(result.lifetimeDividendTaxes).toBeGreaterThan(0);
    });
  });

  describe('Success Rate Consistency', () => {
    test('success rate matches BBD definition (terminal > initial)', () => {
      const config = {
        initialValue: 5000000,
        annualWithdrawal: 200000,
        withdrawalGrowth: 0.03,
        timeHorizon: 30,
      };

      // Create percentiles where P50 ends above initial but P10 ends below
      const percentiles = createMockPercentiles(30, 5000000, 0.04);
      const result = calculateSellStrategy(config, percentiles);

      // Success rate should be between 0 and 100
      expect(result.successRate).toBeGreaterThanOrEqual(0);
      expect(result.successRate).toBeLessThanOrEqual(100);

      // With modest growth and high withdrawals, success < 100%
      expect(result.successRate).toBeLessThan(100);
    });
  });
});
```
  </action>
  <verify>`npm run test` passes all integration tests</verify>
  <done>Integration tests verify configuration threading</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Financial Calculation Audit with all 13 risk areas addressed</what-built>
  <how-to-verify>
1. Run simulation with default settings
2. Check console for any warnings or errors
3. Verify Sell Strategy section shows:
   - Cost Basis Ratio input (40% default)
   - Dividend Yield input (2% default)
4. Change Cost Basis to 80% and run simulation:
   - Lifetime taxes should decrease
5. Change Dividend Yield to 0% and run simulation:
   - Dividend taxes should show $0
6. Check that CAGR label says "Median CAGR"
7. Check that TWRR label says "TWRR (Median)"
8. Run `npm run test` - all tests should pass

Risk Areas Verification Checklist:
[ ] #1 Cost Basis Configurable - UI input present
[ ] #2 Dividend Yield Configurable - UI input present
[ ] #3 Sell Strategy Scenarios - (future enhancement, documented)
[ ] #4 Interest Compounding - Documented and verified
[ ] #5 CAGR Uses Median - Labeled in UI
[ ] #6 Success Rate Consistent - Tests verify BBD definition
[ ] #7 Estate Analysis - (reviewed, no change needed)
[ ] #8 Withdrawal Growth - withdrawalGrowthRate added
[ ] #9 Liquidation Target - Configurable multiplier
[ ] #10 TWRR Range - Documented limitation
[ ] #11 LTV Edge Cases - Validation catches Infinity/NaN
[ ] #12 State Validation - validateSBLOCState added
[ ] #13 Tax Rate Naming - Centralized in config module
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or list any issues found</resume-signal>
</task>

</tasks>

<verification>
1. All unit tests pass: `npm run test`
2. All integration tests pass
3. Manual UI verification complete
4. Console shows no unexpected warnings
5. Calculations produce reasonable results
</verification>

<success_criteria>
- All 13 risk areas addressed or documented
- Integration tests verify config flow
- Manual verification confirms UI works correctly
- No regressions in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/20-financial-calculation-audit/20-11-SUMMARY.md`
</output>
