---
phase: 20-financial-calculation-audit
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - src/calculations/metrics.ts
  - src/calculations/twrr.ts
  - src/components/ui/results-dashboard.ts
autonomous: true

must_haves:
  truths:
    - "CAGR documentation clarifies it uses median terminal value"
    - "Dashboard displays 'Median CAGR' label (not just 'CAGR')"
    - "TWRR shows P10/P50/P90 range when available"
  artifacts:
    - path: "src/calculations/metrics.ts"
      provides: "Updated CAGR documentation"
    - path: "src/components/ui/results-dashboard.ts"
      provides: "Updated metric labels"
  key_links:
    - from: "src/components/ui/results-dashboard.ts"
      to: "src/calculations/metrics.ts"
      via: "calculateCAGR with median"
      pattern: "Median CAGR"
---

<objective>
Clarify CAGR and TWRR reporting methodology

Purpose: Address Risk Areas #5 and #10 (CAGR Uses Median, TWRR Shows P50 Only). Users may not realize that CAGR is calculated from the median terminal value, not the mean. Clarify the methodology in documentation and UI labels. Also add TWRR range display where feasible.

Output: Updated documentation and clearer UI labels for return metrics.
</objective>

<execution_context>
@C:\Users\ungac\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ungac\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/20-financial-calculation-audit/20-RESEARCH.md
@src/calculations/metrics.ts
@src/calculations/twrr.ts
@src/components/ui/results-dashboard.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update CAGR documentation and add mean CAGR calculation</name>
  <files>src/calculations/metrics.ts</files>
  <action>
Update the CAGR calculation documentation:

1. Update calculateCAGR JSDoc:
```typescript
/**
 * Calculate Compound Annual Growth Rate (CAGR)
 *
 * CAGR measures the mean annual growth rate of an investment
 * assuming profits are reinvested at the end of each period.
 *
 * Formula: CAGR = (endValue / startValue)^(1/years) - 1
 *
 * IMPORTANT: When used with simulation results, this calculates
 * the CAGR for a SINGLE path (typically the median outcome).
 * It does NOT calculate the mean CAGR across all simulation paths.
 *
 * For Monte Carlo simulations:
 * - "Median CAGR" = CAGR calculated from median (P50) terminal value
 * - "Mean CAGR" = Average of per-iteration CAGRs (more mathematically correct)
 *
 * We use median because it's more robust to outliers and represents
 * the "typical" outcome better than mean for skewed distributions.
 */
```

2. Add a helper function for calculating mean CAGR:
```typescript
/**
 * Calculate mean CAGR across all simulation iterations
 *
 * More mathematically correct than CAGR from median, but more sensitive
 * to outliers (extremely good or bad paths skew the result).
 *
 * @param terminalValues - All terminal values from simulation
 * @param initialValue - Starting portfolio value
 * @param years - Time horizon
 * @returns Mean CAGR across all paths
 */
export function calculateMeanCAGR(
  terminalValues: Float64Array | number[],
  initialValue: number,
  years: number
): number {
  if (terminalValues.length === 0 || years <= 0 || initialValue <= 0) {
    return NaN;
  }

  let sum = 0;
  let count = 0;

  for (let i = 0; i < terminalValues.length; i++) {
    const cagr = calculateCAGR(initialValue, terminalValues[i], years);
    if (!Number.isNaN(cagr)) {
      sum += cagr;
      count++;
    }
  }

  return count > 0 ? sum / count : NaN;
}
```
  </action>
  <verify>`npx tsc --noEmit` passes</verify>
  <done>CAGR documentation updated and mean CAGR function added</done>
</task>

<task type="auto">
  <name>Task 2: Update dashboard to use clearer metric labels</name>
  <files>src/components/ui/results-dashboard.ts</files>
  <action>
Search for where CAGR is displayed and update labels:

1. Find the CAGR display element and update label from "CAGR" to "Median CAGR":
```typescript
// Old:
<span class="label">CAGR</span>

// New:
<span class="label">Median CAGR</span>
```

Or if using a template literal:
```typescript
// Old:
`CAGR: ${(cagr * 100).toFixed(2)}%`

// New:
`Median CAGR: ${(cagr * 100).toFixed(2)}%`
```

2. Add a tooltip or help text explaining:
```typescript
// Use help-tooltip component if available
<label class="metric-label">
  Median CAGR
  <help-tooltip content="Compound Annual Growth Rate calculated from the median (P50) terminal value. Represents the 'typical' annual return."></help-tooltip>
</label>
```

3. For TWRR, also clarify it's from median path:
```typescript
// Old:
<span class="label">TWRR</span>

// New:
<span class="label">TWRR (Median)</span>
```
  </action>
  <verify>Dashboard shows "Median CAGR" and "TWRR (Median)" labels</verify>
  <done>Dashboard metric labels clarified</done>
</task>

<task type="auto">
  <name>Task 3: Document TWRR methodology</name>
  <files>src/calculations/twrr.ts</files>
  <action>
Update TWRR calculation documentation:

```typescript
/**
 * Calculate Time-Weighted Rate of Return (TWRR)
 *
 * TWRR measures investment performance independent of cash flows.
 * It's the geometric mean of periodic returns.
 *
 * Formula: TWRR = [(1+R1)(1+R2)...(1+Rn)]^(1/n) - 1
 *
 * IMPORTANT: For Monte Carlo simulations, we calculate TWRR from the
 * MEDIAN (P50) yearly path, not across all iterations.
 *
 * This means TWRR represents the return of the "typical" simulation path.
 * It does NOT show the distribution of possible TWRRs.
 *
 * Displaying TWRR range (P10/P50/P90) would require:
 * 1. Calculate TWRR for each iteration's path
 * 2. Take percentiles of those TWRRs
 *
 * This is computationally expensive (need full yearly data per iteration)
 * so we currently only show median path TWRR.
 *
 * Future enhancement: Add calculateTWRRRange() that computes distribution.
 */
```

This documents the limitation and suggests future enhancement.
  </action>
  <verify>Updated documentation in twrr.ts</verify>
  <done>TWRR methodology documented with limitations</done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` - should pass
2. Run simulation and check dashboard:
   - Should show "Median CAGR" not just "CAGR"
   - Should show "TWRR (Median)" not just "TWRR"
3. Verify calculateMeanCAGR exported and works:
   - Mean CAGR should be slightly different from median CAGR
</verification>

<success_criteria>
- CAGR documentation explains median vs mean
- calculateMeanCAGR function available for future use
- Dashboard labels clarify methodology
- TWRR documentation explains limitations
</success_criteria>

<output>
After completion, create `.planning/phases/20-financial-calculation-audit/20-08-SUMMARY.md`
</output>
