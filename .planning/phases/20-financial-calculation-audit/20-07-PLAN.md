---
phase: 20-financial-calculation-audit
plan: 07
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - src/sbloc/liquidation.ts
  - src/sbloc/types.ts
autonomous: true

must_haves:
  truths:
    - "Liquidation target LTV uses configurable multiplier"
    - "Default multiplier documented with rationale"
    - "Extreme market conditions don't cause calculation errors"
  artifacts:
    - path: "src/sbloc/liquidation.ts"
      provides: "Configurable liquidation target"
    - path: "src/sbloc/types.ts"
      provides: "Updated SBLOCConfig with liquidationTargetMultiplier"
  key_links:
    - from: "src/sbloc/liquidation.ts"
      to: "src/sbloc/types.ts"
      via: "config.liquidationTargetMultiplier"
      pattern: "liquidationTargetMultiplier"
---

<objective>
Make liquidation target LTV configurable

Purpose: Address Risk Area #9 (Liquidation Target LTV Hardcoded). The 0.8x multiplier that determines target LTV after liquidation is currently hardcoded. Make this configurable while maintaining backward compatibility with the current default.

Output: Updated liquidation logic with configurable target multiplier.
</objective>

<execution_context>
@C:\Users\ungac\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ungac\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/20-financial-calculation-audit/20-01-PLAN.md
@src/sbloc/liquidation.ts
@src/sbloc/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add liquidationTargetMultiplier to SBLOCConfig</name>
  <files>src/sbloc/types.ts</files>
  <action>
Add liquidationTargetMultiplier field to SBLOCConfig:

```typescript
export interface SBLOCConfig {
  // ... existing fields ...

  /**
   * Multiplier for target LTV after forced liquidation (e.g., 0.8 for 80%)
   *
   * After a margin call, assets are sold to reduce LTV to:
   *   targetLTV = maintenanceMargin * liquidationTargetMultiplier
   *
   * Example with 50% maintenance margin and 0.8 multiplier:
   *   targetLTV = 0.50 * 0.8 = 0.40 (40%)
   *
   * Lower multiplier = more aggressive deleveraging = fewer repeat margin calls
   * Higher multiplier = less selling = more capital preserved (but riskier)
   *
   * Typical values:
   * - 0.7-0.8: Conservative (30-40% buffer below maintenance)
   * - 0.85-0.90: Moderate (10-15% buffer)
   * - 0.95+: Aggressive (minimal buffer, risky)
   *
   * Default: 0.8 (targets 80% of maintenance margin)
   */
  liquidationTargetMultiplier?: number;
}
```

Update DEFAULT_SBLOC_CONFIG:
```typescript
export const DEFAULT_SBLOC_CONFIG: SBLOCConfig = {
  // ... existing fields ...
  liquidationTargetMultiplier: 0.8,
};
```
  </action>
  <verify>`npx tsc --noEmit` passes</verify>
  <done>liquidationTargetMultiplier added to SBLOCConfig</done>
</task>

<task type="auto">
  <name>Task 2: Update liquidation logic to use configurable multiplier</name>
  <files>src/sbloc/liquidation.ts</files>
  <action>
Update executeForcedLiquidation to use the config value:

1. Find the line that calculates target LTV (should be something like):
```typescript
const targetLTV = config.maintenanceMargin * 0.8;
```

2. Replace with configurable version:
```typescript
// Target LTV after liquidation = maintenance * multiplier
// Default 0.8 provides 20% buffer below maintenance to avoid immediate repeat calls
const multiplier = config.liquidationTargetMultiplier ?? 0.8;
const targetLTV = config.maintenanceMargin * multiplier;

// Validate multiplier is reasonable
if (multiplier <= 0 || multiplier > 1) {
  console.warn(
    `Invalid liquidationTargetMultiplier ${multiplier}, using default 0.8`
  );
  // Fall back to default
  const safeTargetLTV = config.maintenanceMargin * 0.8;
  // Continue with safeTargetLTV...
}
```

3. Add documentation at the top of the function:
```typescript
/**
 * Execute forced liquidation to reduce LTV after margin call
 *
 * Liquidation Process:
 * 1. Calculate target LTV = maintenanceMargin * liquidationTargetMultiplier
 * 2. Determine excess loan (amount above target)
 * 3. Calculate assets to sell (accounting for haircut)
 * 4. Sell assets, reduce loan, update state
 *
 * The haircut represents forced-sale discount (typically 5%).
 * The multiplier controls how aggressively we deleverage (default 0.8 = 20% buffer).
 */
```
  </action>
  <verify>`npx tsc --noEmit` passes</verify>
  <done>Liquidation uses configurable target multiplier</done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` - should pass
2. Test with default multiplier (0.8):
   - After margin call, LTV should be ~40% (50% * 0.8)
3. Test with custom multiplier (0.9):
   - After margin call, LTV should be ~45% (50% * 0.9)
4. Verify invalid multiplier (1.5) triggers warning and uses default
</verification>

<success_criteria>
- Liquidation target LTV configurable via SBLOCConfig
- Default 0.8 maintains current behavior
- Invalid values trigger warning and fallback
- Documentation explains the multiplier's purpose
</success_criteria>

<output>
After completion, create `.planning/phases/20-financial-calculation-audit/20-07-SUMMARY.md`
</output>
