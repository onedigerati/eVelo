---
phase: 20-financial-calculation-audit
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/sbloc/engine.ts
  - src/sbloc/types.ts
  - src/simulation/types.ts
autonomous: true

must_haves:
  truths:
    - "SBLOC withdrawals can grow with inflation"
    - "annualWithdrawalRaise applied correctly each year"
    - "User can configure withdrawal growth rate"
  artifacts:
    - path: "src/sbloc/engine.ts"
      provides: "Updated stepSBLOC with withdrawal growth"
    - path: "src/sbloc/types.ts"
      provides: "Updated SBLOCConfig with withdrawalGrowthRate"
  key_links:
    - from: "src/sbloc/engine.ts"
      to: "src/sbloc/types.ts"
      via: "SBLOCConfig with withdrawalGrowthRate"
      pattern: "config\\.withdrawalGrowthRate"
    - from: "src/simulation/monte-carlo.ts"
      to: "src/sbloc/engine.ts"
      via: "effectiveWithdrawal passed to annualWithdrawal"
      pattern: "annualWithdrawal: effectiveWithdrawal"
---

<objective>
Add inflation-adjusted withdrawal support to SBLOC engine

Purpose: Address Risk Area #8 (SBLOC No Withdrawal Growth). Currently SBLOC withdrawals are fixed at the initial annual amount for the entire simulation. In reality, retirees need to increase withdrawals to maintain purchasing power as prices rise. Add support for configurable withdrawal growth rate.

Output: Updated SBLOC engine that applies annual withdrawal raises.
</objective>

<execution_context>
@C:\Users\ungac\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ungac\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/20-financial-calculation-audit/20-RESEARCH.md
@src/sbloc/engine.ts
@src/sbloc/types.ts
@src/simulation/types.ts
@src/simulation/monte-carlo.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add withdrawalGrowthRate to SBLOC config</name>
  <files>src/sbloc/types.ts</files>
  <action>
Add withdrawalGrowthRate field to SBLOCConfig interface:

```typescript
export interface SBLOCConfig {
  // ... existing fields ...

  /**
   * Annual growth rate for withdrawals (e.g., 0.03 for 3%)
   *
   * Models inflation adjustment - each year's withdrawal is:
   * withdrawal_year_N = annualWithdrawal * (1 + withdrawalGrowthRate)^N
   *
   * Typical values:
   * - 0.02-0.03: Matches historical inflation (2-3%)
   * - 0.00: Fixed withdrawals (no inflation adjustment)
   * - 0.04+: Higher growth for lifestyle inflation
   *
   * Default: 0.03 (3% annual growth)
   */
  withdrawalGrowthRate?: number;
}
```

Also update DEFAULT_SBLOC_CONFIG:
```typescript
export const DEFAULT_SBLOC_CONFIG: SBLOCConfig = {
  // ... existing fields ...
  withdrawalGrowthRate: 0.03, // 3% annual growth (inflation adjustment)
};
```

The field is optional with a default to maintain backward compatibility.
  </action>
  <verify>`npx tsc --noEmit` passes</verify>
  <done>withdrawalGrowthRate added to SBLOCConfig</done>
</task>

<task type="auto">
  <name>Task 2: Implement withdrawal growth in stepSBLOC</name>
  <files>src/sbloc/engine.ts</files>
  <action>
Update stepSBLOC to apply withdrawal growth:

1. Modify Step 2 (withdrawal) to calculate inflation-adjusted amount:
```typescript
// Step 2: If withdrawals have started, add annual withdrawal to loan
if (currentYear >= config.startYear) {
  // Calculate years into withdrawal phase
  const withdrawalYear = currentYear - config.startYear;

  // Apply withdrawal growth rate (defaults to 3% if not specified)
  const growthRate = config.withdrawalGrowthRate ?? 0.03;

  // Withdrawal for this year = base * (1 + growth)^years
  withdrawalMade = config.annualWithdrawal * Math.pow(1 + growthRate, withdrawalYear);

  newLoanBalance += withdrawalMade;
}
```

2. Update the function JSDoc to document the growth behavior:
```typescript
/**
 * Advance SBLOC simulation by one year
 *
 * Step order:
 * 1. Apply portfolio return first
 * 2. If currentYear >= startYear: add annual withdrawal to loan
 *    - Withdrawal grows at withdrawalGrowthRate each year
 *    - Year 0: annualWithdrawal, Year 1: annualWithdrawal * (1 + rate), etc.
 * 3. Apply interest to loan balance (annual compounding)
 * ...
 */
```

This correctly models withdrawals growing with inflation over time.
  </action>
  <verify>`npx tsc --noEmit` passes</verify>
  <done>stepSBLOC applies withdrawal growth rate</done>
</task>

<task type="auto">
  <name>Task 3: Verify SBLOCSimConfig includes withdrawal raise</name>
  <files>src/simulation/types.ts</files>
  <action>
Verify that SBLOCSimConfig already has annualWithdrawalRaise field (it does from the types review). Ensure it's documented:

```typescript
export interface SBLOCSimConfig {
  // ... existing fields ...

  /**
   * Annual percentage raise for withdrawals (e.g., 0.03 for 3%)
   *
   * This is equivalent to SBLOCConfig.withdrawalGrowthRate and is used
   * in Monte Carlo simulation. The SBLOC engine uses this to grow
   * withdrawals over time.
   *
   * Typical values:
   * - 0.00: Fixed withdrawals (no inflation)
   * - 0.02-0.03: Matches historical inflation
   * - 0.05+: Aggressive lifestyle inflation
   */
  annualWithdrawalRaise: number;
}
```

This field already exists and is passed to the SBLOC engine. Just need to ensure it's connected to withdrawalGrowthRate in the engine config conversion.
  </action>
  <verify>`npx tsc --noEmit` passes; field is documented</verify>
  <done>SBLOCSimConfig.annualWithdrawalRaise documented and connected</done>
</task>

<task type="auto">
  <name>Task 4: Verify monte-carlo.ts wiring is correct</name>
  <files>src/simulation/monte-carlo.ts</files>
  <action>
Verify that monte-carlo.ts correctly wires annualWithdrawalRaise to the SBLOC engine.

The existing code already handles this:
```typescript
// Line ~121: Extract raise rate from sim config
const sblocRaiseRate = config.sbloc?.annualWithdrawalRaise ?? 0;

// Line ~175-177: Calculate effective withdrawal with growth
const yearsOfWithdrawals = Math.max(0, year - sblocWithdrawalStartYear);
const effectiveWithdrawal = year >= sblocWithdrawalStartYear
  ? sblocBaseWithdrawal * Math.pow(1 + sblocRaiseRate, yearsOfWithdrawals)
  : 0;

// Line ~187: Pass to SBLOC engine
const sblocConfig: SBLOCEngineConfig = {
  // ...
  annualWithdrawal: effectiveWithdrawal,  // Already includes growth!
  // ...
};
```

IMPORTANT: monte-carlo.ts computes the inflation-adjusted withdrawal EXTERNALLY and passes it as the flat `annualWithdrawal`. This means the SBLOC engine's internal `withdrawalGrowthRate` is REDUNDANT for Monte Carlo simulations.

Action: Add a comment in monte-carlo.ts to document this design:
```typescript
// Note: We compute effectiveWithdrawal externally (with sblocRaiseRate growth)
// rather than using the SBLOC engine's withdrawalGrowthRate. This keeps the
// engine stateless - it just uses the withdrawal amount we pass.
// The SBLOCConfig.withdrawalGrowthRate field exists for standalone engine use.
```

This documents the wiring so future developers understand why growth is handled externally.
  </action>
  <verify>Comment present in monte-carlo.ts explaining the wiring</verify>
  <done>monte-carlo.ts to SBLOCConfig wiring documented</done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` - should pass
2. Test with simulation:
   - annualWithdrawal: $50,000
   - withdrawalGrowthRate: 0.03 (3%)
   - After 10 years: withdrawal should be ~$67,195 ($50k * 1.03^10)
3. Verify loan balance reflects cumulative inflation-adjusted withdrawals
4. Compare BBD with and without withdrawal growth - results should differ
</verification>

<success_criteria>
- Withdrawals grow at configurable rate
- Year 0 withdrawal = annualWithdrawal
- Year N withdrawal = annualWithdrawal * (1 + rate)^N
- Backward compatible (default 3% if not specified)
- monte-carlo.ts wiring documented
</success_criteria>

<output>
After completion, create `.planning/phases/20-financial-calculation-audit/20-05-SUMMARY.md`
</output>
