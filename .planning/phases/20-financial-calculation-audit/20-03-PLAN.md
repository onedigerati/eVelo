---
phase: 20-financial-calculation-audit
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/calculations/sell-strategy.ts
autonomous: true

must_haves:
  truths:
    - "Sell strategy success rate uses same definition as BBD (terminal > initial)"
    - "Success rate calculated from all scenarios, not just depleted/not depleted"
    - "BBD vs Sell comparison is apples-to-apples"
  artifacts:
    - path: "src/calculations/sell-strategy.ts"
      provides: "Updated success rate calculation"
  key_links:
    - from: "src/calculations/sell-strategy.ts"
      to: "src/calculations/metrics.ts"
      via: "Same success definition (terminal > initial)"
      pattern: "terminalValue > initialValue"
---

<objective>
Unify success rate definitions between BBD and Sell strategies

Purpose: Address Risk Area #6 (Success Rate Definitions Differ). Currently BBD success means "terminal > initial" (portfolio grew) while Sell success means "!depleted" (didn't run out of money). These measure different things and make comparison unfair. Unify both to use the same definition.

Output: Updated sell-strategy.ts with consistent success rate calculation.
</objective>

<execution_context>
@C:\Users\ungac\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ungac\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/20-financial-calculation-audit/20-RESEARCH.md
@src/calculations/sell-strategy.ts
@src/calculations/metrics.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update success rate calculation to match BBD definition</name>
  <files>src/calculations/sell-strategy.ts</files>
  <action>
Modify the calculateSellStrategy function to use the same success definition as BBD:

1. Update the success rate calculation (around line 180):
```typescript
// Calculate success rate using SAME definition as BBD:
// Success = terminal value strictly greater than initial value
// This measures whether the strategy preserved/grew wealth, not just survival
const successCount = scenarios.filter(s => s.terminalValue > initialValue).length;
const successRate = (successCount / scenarios.length) * 100;
const depletionProbability = scenarios.filter(s => s.depleted).length / scenarios.length * 100;
```

2. Update the JSDoc comment for successRate in SellStrategyResult interface (around line 42):
```typescript
/**
 * Success rate - percentage of scenarios ending above initial value (0-100)
 * Uses same definition as BBD: success = terminal > initial
 */
successRate: number;
```

3. Keep depletionProbability as a separate metric (it's still useful):
```typescript
/**
 * Depletion probability - percentage of scenarios that ran out of money (0-100)
 * Note: This is different from (100 - successRate) because a scenario can
 * end above zero but below initial value.
 */
depletionProbability: number;
```

4. Update the function comment to clarify the success definition:
```typescript
/**
 * Calculate Sell Assets strategy outcomes from BBD simulation data.
 *
 * Success is defined as: terminal value > initial value
 * This matches the BBD success definition for fair comparison.
 *
 * Depletion probability is tracked separately as scenarios that ran out of money.
 */
```

This makes BBD and Sell comparable: both measure "did the strategy grow the portfolio?"
  </action>
  <verify>`npx tsc --noEmit` passes</verify>
  <done>Success rate now uses consistent definition (terminal > initial)</done>
</task>

<task type="auto">
  <name>Task 2: Add inline documentation clarifying the change</name>
  <files>src/calculations/sell-strategy.ts</files>
  <action>
Add a documentation block explaining the success rate definitions:

After the interface definitions, add:
```typescript
// ============================================================================
// Success Rate Definition
// ============================================================================
//
// For FAIR COMPARISON between BBD and Sell strategies, we use the SAME
// success definition for both:
//
//   SUCCESS = terminal portfolio value > initial portfolio value
//
// This measures whether the strategy preserved and grew wealth.
//
// Previously, Sell used "!depleted" (portfolio > 0) which is a lower bar.
// A scenario ending at $1 would be "successful" under the old definition
// but not under the new one.
//
// We still track depletionProbability separately as it's useful for
// risk assessment (scenarios that completely ran out of money).
//
// Comparison table:
// | Scenario | Terminal | Old Success | New Success | Depleted |
// |----------|----------|-------------|-------------|----------|
// | A        | $6M      | Yes         | Yes         | No       |
// | B        | $3M      | Yes         | No          | No       |
// | C        | $0       | No          | No          | Yes      |
//
// (Assuming $5M initial value)
// ============================================================================
```

This helps future developers understand why the definition matters.
  </action>
  <verify>Documentation block present in file</verify>
  <done>Clear documentation explaining success rate definition</done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` - should pass
2. Run a simulation and check:
   - Sell success rate should now be LOWER than before (stricter definition)
   - depletionProbability should still work correctly
3. Verify BBD and Sell success rates are now comparable
</verification>

<success_criteria>
- Success rate uses same definition for both strategies
- depletionProbability still tracked as separate metric
- JSDoc updated to reflect new definition
- Inline documentation explains the rationale
</success_criteria>

<output>
After completion, create `.planning/phases/20-financial-calculation-audit/20-03-SUMMARY.md`
</output>
