---
phase: 14-dashboard-calculations-review
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/14-dashboard-calculations-review/14-GAP-FINDINGS.md
autonomous: true

must_haves:
  truths:
    - "monte-carlo.ts lines 223-353 use percentile() with 0-1 scale values"
    - "statistics.ts percentile() expects 0-100 scale (divides by 100 at line 87)"
    - "metrics.ts calculateSuccessRate uses > comparison at line 188"
    - "monte-carlo.ts calculateStatistics uses >= comparison at line 331"
    - "14-GAP-FINDINGS.md exists with >= 2 documented gaps"
  artifacts:
    - path: ".planning/phases/14-dashboard-calculations-review/14-GAP-FINDINGS.md"
      provides: "Documented calculation issues"
      contains: "## Calculation Gaps"
  key_links:
    - from: "src/simulation/monte-carlo.ts"
      to: "src/math/statistics.ts"
      via: "percentile() function calls"
      pattern: "percentile\\("
    - from: "src/calculations/metrics.ts"
      to: "src/math/statistics.ts"
      via: "percentile() function calls"
      pattern: "percentile\\("
---

<objective>
Verify all CALC requirements and document any calculation discrepancies.

Purpose: Ensure all financial calculations in the dashboard are accurate and consistent, documenting any issues found for future resolution.

Output: 14-GAP-FINDINGS.md with all calculation issues documented.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-dashboard-calculations-review/14-RESEARCH.md

Key files to verify:
@src/math/statistics.ts - percentile() expects 0-100 scale
@src/simulation/monte-carlo.ts - uses percentile() with 0-1 scale (BUG)
@src/calculations/metrics.ts - uses percentile() correctly with 0-100 scale
@src/calculations/twrr.ts
@src/calculations/salary-equivalent.ts
@src/calculations/margin-call-probability.ts
@src/calculations/return-probabilities.ts
@src/components/ui/results-dashboard.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Inspect percentile scale usage with grep pattern</name>
  <files>
    src/math/statistics.ts
    src/simulation/monte-carlo.ts
    src/calculations/metrics.ts
    src/components/ui/results-dashboard.ts
    .planning/phases/14-dashboard-calculations-review/14-GAP-FINDINGS.md
  </files>
  <action>
Use automated code inspection to identify percentile scale mismatch:

1. Read src/math/statistics.ts and locate the percentile() function implementation. Capture the line number where it divides by 100 (expected: `clampedP / 100`).

2. Use Grep tool with pattern `percentile\(` to find all percentile() calls across the codebase. For each match, capture:
   - File path and line number
   - The second argument value (the percentile parameter)
   - Whether it uses 0-100 scale (10, 25, 50, 75, 90) or 0-1 scale (0.1, 0.25, 0.5, 0.75, 0.9)

3. Read src/simulation/monte-carlo.ts lines 220-360 to confirm the specific locations using 0-1 scale:
   - yearlyPercentiles calls (expected around lines 223-227)
   - sblocTrajectory percentile calls (expected around lines 349-353)

4. Read src/calculations/metrics.ts to confirm it uses 0-100 scale correctly.

5. Write 14-GAP-FINDINGS.md with the following structure:
```markdown
# Phase 14: Gap Findings

## Calculation Gaps

### GAP-01: Percentile Scale Mismatch in monte-carlo.ts

**Requirement**: CALC-02 (Percentile Outcomes)
**Severity**: HIGH
**Component**: src/simulation/monte-carlo.ts

**Description**:
The monte-carlo.ts file calls percentile() with values on 0-1 scale (0.1, 0.25, etc.) but the percentile() function in statistics.ts expects values on 0-100 scale.

**Evidence**:
[Insert grep results showing 0-1 scale usage]
- Line XXX: percentile(values, 0.1)
- Line XXX: percentile(values, 0.25)
[etc.]

**Expected Behavior**:
percentile(values, 10) for 10th percentile, percentile(values, 25) for 25th, etc.

**Proposed Resolution**:
Change all percentile() calls in monte-carlo.ts to use 0-100 scale values.
```
  </action>
  <verify>
    - Run: Grep pattern `percentile\(` returns matches in monte-carlo.ts showing 0-1 scale values
    - Run: Grep pattern `clampedP / 100` in statistics.ts returns 1 match confirming scale expectation
    - Check: 14-GAP-FINDINGS.md exists and contains "GAP-01: Percentile Scale Mismatch"
    - Check: 14-GAP-FINDINGS.md contains GAP-01 with all template sections: Requirement, Severity, Component, Description, Evidence, Expected Behavior, Proposed Resolution
  </verify>
  <done>
    Percentile scale mismatch documented with specific file locations, line numbers, and code evidence
  </done>
</task>

<task type="auto">
  <name>Task 2: Inspect success rate and other CALC requirements</name>
  <files>
    src/simulation/monte-carlo.ts
    src/calculations/metrics.ts
    src/calculations/twrr.ts
    src/calculations/salary-equivalent.ts
    src/calculations/margin-call-probability.ts
    src/calculations/return-probabilities.ts
    .planning/phases/14-dashboard-calculations-review/14-GAP-FINDINGS.md
  </files>
  <action>
Inspect each CALC requirement using grep and file reads:

**CALC-01: Success Rate**
1. Use Grep with pattern `>= initialValue|> initialValue` in src/simulation and src/calculations
2. Read monte-carlo.ts calculateStatistics() - locate success rate comparison (expected: `v >= initialValue`)
3. Read metrics.ts calculateSuccessRate() - locate success rate comparison (expected: `terminalValues[i] > initialValue`)
4. If different operators found, document GAP-02: Success Rate Definition Inconsistency

**CALC-03: CAGR and Volatility**
1. Read metrics.ts and locate calculateCAGR() function
2. Verify formula matches: (endValue/startValue)^(1/years) - 1
3. Read calculateAnnualizedVolatility() and verify stddev usage
4. Document any discrepancies as GAP-03

**CALC-04: Margin Call Probability**
1. Read monte-carlo.ts computeMarginCallStats() function
2. Verify cumulative probability calculation
3. Check if probability is monotonically increasing (each year >= previous)
4. Document any issues as GAP-04

**CALC-05: Salary Equivalent**
1. Read salary-equivalent.ts calculateSalaryEquivalent() function
2. Verify formula: withdrawal / (1 - taxRate)
3. Test calculation: $50k at 37% tax should yield ~$79,365
4. Document any issues as GAP-05

**CALC-07: TWRR**
1. Read twrr.ts calculateTWRR() function
2. Verify geometric mean calculation: product of (1 + returns)^(1/n) - 1
3. Document any issues as GAP-06

Append all findings to 14-GAP-FINDINGS.md under ## Calculation Gaps section.
  </action>
  <verify>
    - Run: Grep pattern `>= initialValue` in monte-carlo.ts returns match
    - Run: Grep pattern `> initialValue` in metrics.ts returns match
    - Check: 14-GAP-FINDINGS.md contains GAP-02 documenting success rate inconsistency
    - Check: Each CALC requirement (CALC-01, CALC-03, CALC-04, CALC-05, CALC-07) has either a GAP entry or a note that no issues were found
    - Check: 14-GAP-FINDINGS.md contains at least 2 complete gap entries (GAP-01 and GAP-02) each with all template sections: Requirement, Severity, Component, Description, Evidence, Expected Behavior, Proposed Resolution
  </verify>
  <done>
    All CALC requirements inspected with grep/read tools, discrepancies documented with specific code locations
  </done>
</task>

</tasks>

<verification>
After completing both tasks:
1. Run: `Test-Path ".planning/phases/14-dashboard-calculations-review/14-GAP-FINDINGS.md"` returns True
2. Run: Grep pattern "GAP-0[12]" in 14-GAP-FINDINGS.md returns >= 2 matches
3. Run: Grep pattern "Severity: HIGH" in 14-GAP-FINDINGS.md returns >= 1 match
4. Check: Each gap entry contains: Requirement, Severity, Component, Description, Evidence, Expected Behavior, Proposed Resolution
</verification>

<success_criteria>
1. Percentile scale mismatch in monte-carlo.ts documented (GAP-01) with specific line numbers
2. Success rate definition inconsistency documented (GAP-02) with operator comparison evidence
3. All other CALC requirements verified (CALC-03 through CALC-07) with findings or "no issues found"
4. 14-GAP-FINDINGS.md created with structured gap documentation containing code evidence
</success_criteria>

<output>
After completion, create `.planning/phases/14-dashboard-calculations-review/14-01-SUMMARY.md`
</output>
