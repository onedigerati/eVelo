---
phase: 14-dashboard-calculations-review
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/14-dashboard-calculations-review/14-GAP-FINDINGS.md
autonomous: true

must_haves:
  truths:
    - "Percentile calculation consistency verified across all modules"
    - "Success rate calculation verified"
    - "CAGR and volatility formulas verified"
    - "TWRR calculation verified"
    - "Salary equivalent calculation verified"
    - "Margin call probability calculation verified"
    - "All calculation discrepancies documented"
  artifacts:
    - path: ".planning/phases/14-dashboard-calculations-review/14-GAP-FINDINGS.md"
      provides: "Documented calculation issues"
      contains: "## Calculation Gaps"
  key_links:
    - from: "src/simulation/monte-carlo.ts"
      to: "src/math/statistics.ts"
      via: "percentile() function calls"
      pattern: "percentile\\("
    - from: "src/calculations/metrics.ts"
      to: "src/math/statistics.ts"
      via: "percentile() function calls"
      pattern: "percentile\\("
---

<objective>
Verify all CALC requirements and document any calculation discrepancies.

Purpose: Ensure all financial calculations in the dashboard are accurate and consistent, documenting any issues found for future resolution.

Output: 14-GAP-FINDINGS.md with all calculation issues documented.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-dashboard-calculations-review/14-RESEARCH.md

Key files to verify:
@src/math/statistics.ts - percentile() expects 0-100 scale
@src/simulation/monte-carlo.ts - uses percentile() with 0-1 scale (BUG)
@src/calculations/metrics.ts - uses percentile() correctly with 0-100 scale
@src/calculations/twrr.ts
@src/calculations/salary-equivalent.ts
@src/calculations/margin-call-probability.ts
@src/calculations/return-probabilities.ts
@src/components/ui/results-dashboard.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify percentile scale consistency</name>
  <files>
    src/math/statistics.ts
    src/simulation/monte-carlo.ts
    src/calculations/metrics.ts
    src/components/ui/results-dashboard.ts
  </files>
  <action>
Verify the percentile() function usage across the codebase:

1. Read src/math/statistics.ts and confirm the percentile() function expects values on 0-100 scale (line 87: `const index = (clampedP / 100) * (n - 1)`)

2. Search for all percentile() calls and categorize by scale used:
   - CORRECT (0-100): `percentile(values, 10)`, `percentile(values, 25)`, etc.
   - INCORRECT (0-1): `percentile(values, 0.1)`, `percentile(values, 0.25)`, etc.

3. Document findings in 14-GAP-FINDINGS.md:
   - GAP-01: Percentile Scale Mismatch in monte-carlo.ts
   - List all affected lines in monte-carlo.ts (lines 223-227, 243, 254, 335, 349-353)
   - Impact: All yearlyPercentiles and sblocTrajectory percentiles are incorrectly calculated
   - The bug causes percentile(values, 0.1) to return nearly the minimum value (0.1th percentile instead of 10th)

4. Verify metrics.ts uses correct scale (should use 10, 25, 50, 75, 90)

5. Verify results-dashboard.ts uses correct scale
  </action>
  <verify>
    - Grep confirms which files use 0-1 scale vs 0-100 scale
    - 14-GAP-FINDINGS.md contains GAP-01 documenting the scale mismatch
  </verify>
  <done>
    Percentile scale inconsistency fully documented with affected locations and impact assessment
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify success rate and other CALC requirements</name>
  <files>
    src/simulation/monte-carlo.ts
    src/calculations/metrics.ts
    src/calculations/twrr.ts
    src/calculations/salary-equivalent.ts
    src/calculations/margin-call-probability.ts
    src/calculations/return-probabilities.ts
    .planning/phases/14-dashboard-calculations-review/14-GAP-FINDINGS.md
  </files>
  <action>
Verify each CALC requirement and document discrepancies:

**CALC-01: Success Rate**
1. Check monte-carlo.ts calculateStatistics() - uses `v >= initialValue` (line 331)
2. Check metrics.ts calculateSuccessRate() - uses `terminalValues[i] > initialValue` (line 188)
3. Document GAP-02: Success Rate Definition Inconsistency (> vs >=)

**CALC-02: Percentile Outcomes**
- Already covered in Task 1 (percentile scale issue)

**CALC-03: CAGR and Volatility**
1. Verify calculateCAGR() in metrics.ts uses correct formula: (endValue/startValue)^(1/years) - 1
2. Verify calculateAnnualizedVolatility() uses stddev correctly
3. Document any issues found

**CALC-04: Margin Call Probability**
1. Verify computeMarginCallStats() in monte-carlo.ts
2. Check cumulative probability is monotonically increasing
3. Document any issues found

**CALC-05: Salary Equivalent**
1. Verify calculateSalaryEquivalent() in salary-equivalent.ts
2. Formula: withdrawal / (1 - taxRate)
3. Test: $50k at 37% tax = $50000 / 0.63 = ~$79,365
4. Document any issues found

**CALC-07: TWRR**
1. Verify calculateTWRR() in twrr.ts
2. Check geometric mean calculation
3. Document any issues found

Append all findings to 14-GAP-FINDINGS.md.
  </action>
  <verify>
    - Read 14-GAP-FINDINGS.md and confirm it contains entries for all CALC requirements
    - Each gap has: requirement, severity, component, description, evidence, expected behavior, proposed resolution
  </verify>
  <done>
    All CALC requirements verified and any discrepancies documented in 14-GAP-FINDINGS.md
  </done>
</task>

</tasks>

<verification>
After completing both tasks:
1. 14-GAP-FINDINGS.md exists with ## Calculation Gaps section
2. All CALC requirements (CALC-01 through CALC-07) have been reviewed
3. Each identified gap follows the template:
   - Requirement
   - Severity (HIGH/MEDIUM/LOW)
   - Component (file and function)
   - Description
   - Evidence (code snippet or test result)
   - Expected Behavior
   - Proposed Resolution
</verification>

<success_criteria>
1. Percentile scale mismatch in monte-carlo.ts documented (GAP-01)
2. Success rate definition inconsistency documented (GAP-02)
3. All other CALC requirements verified (CALC-03 through CALC-07)
4. 14-GAP-FINDINGS.md created with structured gap documentation
</success_criteria>

<output>
After completion, create `.planning/phases/14-dashboard-calculations-review/14-01-SUMMARY.md`
</output>
