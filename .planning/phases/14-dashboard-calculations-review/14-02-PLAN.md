---
phase: 14-dashboard-calculations-review
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - .planning/phases/14-dashboard-calculations-review/14-GAP-FINDINGS.md
autonomous: true

must_haves:
  truths:
    - "results-dashboard.ts contains transformToConeData function binding yearlyPercentiles to chart"
    - "results-dashboard.ts contains updateMarginCallChart function binding marginCallStats"
    - "14-GAP-FINDINGS.md contains ## Visualization Gaps section with >= 0 gaps"
    - "14-GAP-FINDINGS.md contains ## Summary section listing all gaps by severity"
  artifacts:
    - path: ".planning/phases/14-dashboard-calculations-review/14-GAP-FINDINGS.md"
      provides: "Complete gap documentation"
      contains: "## Visualization Gaps"
  key_links:
    - from: "src/components/ui/results-dashboard.ts"
      to: "src/charts/*.ts"
      via: "Data binding and transformations"
      pattern: "transformToConeData|transformToHistogramData|updateMarginCallChart|updateSblocChart"
---

<objective>
Verify all VIZ requirements render correctly and finalize gap documentation.

Purpose: Ensure all dashboard visualizations correctly bind to simulation data and display accurate information, completing the comprehensive gap findings document.

Output: Complete 14-GAP-FINDINGS.md with all calculation and visualization issues documented.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-dashboard-calculations-review/14-RESEARCH.md
@.planning/phases/14-dashboard-calculations-review/14-01-SUMMARY.md

Key files to verify:
@src/components/ui/results-dashboard.ts - Main orchestrator (1720 lines)
@src/charts/probability-cone-chart.ts - VIZ-01
@src/charts/histogram-chart.ts - VIZ-02
@src/charts/donut-chart.ts - VIZ-03
@src/charts/correlation-heatmap.ts - VIZ-04
@src/charts/margin-call-chart.ts - VIZ-05
@src/charts/sbloc-balance-chart.ts - VIZ-06
@src/charts/bbd-comparison-chart.ts - VIZ-07
</context>

<tasks>

<task type="auto">
  <name>Task 1: Inspect visualization data bindings (VIZ-01 through VIZ-04)</name>
  <files>
    src/components/ui/results-dashboard.ts
    src/charts/probability-cone-chart.ts
    src/charts/histogram-chart.ts
    src/charts/donut-chart.ts
    src/charts/correlation-heatmap.ts
    .planning/phases/14-dashboard-calculations-review/14-GAP-FINDINGS.md
  </files>
  <action>
Inspect each visualization requirement using grep and file reads:

**VIZ-01: Probability Cone Chart**
1. Use Grep with pattern `transformToConeData|yearlyPercentiles` in results-dashboard.ts
2. Read the transformToConeData() function and verify:
   - It reads yearlyPercentiles from SimulationOutput
   - It maps p10, p25, p50, p75, p90 bands correctly
3. Read src/charts/probability-cone-chart.ts and verify setData() method binds yearlyPercentiles correctly to the chart series
4. NOTE: Data will be INCORRECT due to GAP-01 - reference this in any findings
5. Document any additional transformation issues as GAP-VIZ-01

**VIZ-02: Terminal Distribution Histogram**
1. Use Grep with pattern `transformToHistogramData|terminalValues` in results-dashboard.ts
2. Read the transformToHistogramData() function and verify:
   - It bins terminalValues correctly (expected: 20 bins)
   - It applies histogram color gradient (red -> yellow -> green)
3. Read src/charts/histogram-chart.ts and verify setData() method correctly renders bin data with color mapping
4. Document any issues as GAP-VIZ-02

**VIZ-03: Portfolio Composition Donut**
1. Use Grep with pattern `portfolioWeights|donut-chart` in results-dashboard.ts
2. Verify portfolioWeights setter exists and passes data to donut-chart component
3. Read src/charts/donut-chart.ts and verify setData() method correctly renders portfolio segments with labels and percentages
4. Check segment labels and percentages format
5. Document any issues as GAP-VIZ-03

**VIZ-04: Correlation Heatmap**
1. Use Grep with pattern `correlationMatrix|correlation-heatmap` in results-dashboard.ts
2. Read calculateAssetStatistics() function
3. Read src/charts/correlation-heatmap.ts and verify setData() method correctly renders the correlation matrix with color scale
4. Check fallback values (research identified 8%/16% defaults may be misleading)
5. Document any issues as GAP-VIZ-04

Append findings to 14-GAP-FINDINGS.md under ## Visualization Gaps section.
  </action>
  <verify>
    - Run: Grep pattern `transformToConeData` in results-dashboard.ts returns >= 1 match
    - Run: Grep pattern `transformToHistogramData` in results-dashboard.ts returns >= 1 match
    - Check: 14-GAP-FINDINGS.md contains "## Visualization Gaps" section
    - Check: Each VIZ requirement (VIZ-01 through VIZ-04) has either a GAP entry or confirmation of no issues
  </verify>
  <done>
    VIZ-01 through VIZ-04 inspected with grep/read tools, data flow verified, any issues documented
  </done>
</task>

<task type="auto">
  <name>Task 2: Inspect SBLOC visualizations (VIZ-05 through VIZ-07)</name>
  <files>
    src/components/ui/results-dashboard.ts
    src/charts/margin-call-chart.ts
    src/charts/sbloc-balance-chart.ts
    src/charts/bbd-comparison-chart.ts
    src/charts/comparison-line-chart.ts
    src/charts/cumulative-costs-chart.ts
    src/charts/terminal-comparison-chart.ts
    .planning/phases/14-dashboard-calculations-review/14-GAP-FINDINGS.md
  </files>
  <action>
Inspect SBLOC-related visualizations using grep and file reads:

**VIZ-05: Margin Call Risk Chart**
1. Use Grep with pattern `marginCallStats|updateMarginCallChart` in results-dashboard.ts
2. Read the updateMarginCallChart() function and verify:
   - marginCallStats from simulation is correctly bound
   - cumulative probability line calculation is correct
3. Read src/charts/margin-call-chart.ts and verify setData() method correctly renders margin call probability data with the cumulative line
4. Document any issues as GAP-VIZ-05

**VIZ-06: SBLOC Balance Chart**
1. Use Grep with pattern `sblocTrajectory|updateSblocChart` in results-dashboard.ts
2. Read the function binding sblocTrajectory.loanBalance percentiles
3. Read src/charts/sbloc-balance-chart.ts and verify setData() method correctly renders loan balance percentiles and cumulative data
4. NOTE: Data will be INCORRECT due to GAP-01 - reference this in any findings
5. Verify cumulative withdrawals and interest display
6. Document any issues as GAP-VIZ-06

**VIZ-07: BBD vs Sell Comparison**
1. Use Grep with pattern `estateAnalysis|calculateSellStrategy` in results-dashboard.ts
2. Read the data bindings for comparison charts:
   - bbd-comparison-chart (bar chart)
   - comparison-line-chart (net worth over time)
   - cumulative-costs-chart (taxes vs interest)
   - terminal-comparison-chart (percentile comparison)
3. Read src/charts/bbd-comparison-chart.ts and verify setData() method correctly renders BBD vs Sell bar comparison
4. Read updateComparisonLineChart() and check lines 1386-1389 for off-by-one errors (research identified potential issue)
5. Document any issues as GAP-VIZ-07

Append findings to 14-GAP-FINDINGS.md under ## Visualization Gaps section.
  </action>
  <verify>
    - Run: Grep pattern `updateMarginCallChart` in results-dashboard.ts returns >= 1 match
    - Run: Grep pattern `sblocTrajectory` in results-dashboard.ts returns >= 1 match
    - Run: Grep pattern `estateAnalysis` in results-dashboard.ts returns >= 1 match
    - Check: Each VIZ requirement (VIZ-05 through VIZ-07) has either a GAP entry or confirmation of no issues
  </verify>
  <done>
    VIZ-05 through VIZ-07 inspected with grep/read tools, SBLOC data flow verified, any issues documented
  </done>
</task>

<task type="auto">
  <name>Task 3: Finalize gap documentation with summary and metadata</name>
  <files>
    .planning/phases/14-dashboard-calculations-review/14-GAP-FINDINGS.md
  </files>
  <action>
Add final sections to 14-GAP-FINDINGS.md:

1. Read the current 14-GAP-FINDINGS.md content to count all gaps

2. Add **## Summary** section:
   - Count gaps by severity: HIGH, MEDIUM, LOW
   - List all gap IDs with one-line descriptions

3. Add **## Resolution Priority** section:
   - Order gaps by impact (percentile scale mismatch affects multiple components)
   - Group related gaps (e.g., all percentile-related issues)

4. Add **## Affected Requirements** section:
   - Map each gap to its affected requirement (CALC-XX or VIZ-XX)

5. Add **## Next Steps** section:
   - Recommend Phase 15 or gap closure plans to address findings
   - Prioritize by impact

6. Add **## Test Recommendations** section:
   - Unit tests for percentile() with both scale conventions
   - Integration tests for dashboard calculations
   - Known-input verification tests

7. Add **## Metadata** section:
   - Date reviewed: [current date]
   - Files examined: [list from all tasks]
   - Total gaps found: [count]
   - Critical gaps: [count of HIGH severity]
  </action>
  <verify>
    - Check: 14-GAP-FINDINGS.md contains "## Summary" section
    - Check: 14-GAP-FINDINGS.md contains "## Resolution Priority" section
    - Check: 14-GAP-FINDINGS.md contains "## Next Steps" section
    - Check: 14-GAP-FINDINGS.md contains "## Metadata" section
    - Run: Grep pattern "## " in 14-GAP-FINDINGS.md returns >= 6 matches (all required sections)
    - Check: File line count > 100 lines (comprehensive documentation)
  </verify>
  <done>
    14-GAP-FINDINGS.md is complete with all required sections: Calculation Gaps, Visualization Gaps, Summary, Resolution Priority, Next Steps, Test Recommendations, Metadata
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Run: `Test-Path ".planning/phases/14-dashboard-calculations-review/14-GAP-FINDINGS.md"` returns True
2. Run: Grep pattern "## Calculation Gaps" in 14-GAP-FINDINGS.md returns 1 match
3. Run: Grep pattern "## Visualization Gaps" in 14-GAP-FINDINGS.md returns 1 match
4. Run: Grep pattern "## Summary" in 14-GAP-FINDINGS.md returns 1 match
5. Run: Grep pattern "## Resolution Priority" in 14-GAP-FINDINGS.md returns 1 match
6. Check: Each gap follows template with Requirement, Severity, Component, Description, Evidence, Expected Behavior, Proposed Resolution
</verification>

<success_criteria>
1. All VIZ requirements verified (VIZ-01 through VIZ-07) using grep/read tools
2. Visualization data bindings traced from SimulationOutput to chart components
3. 14-GAP-FINDINGS.md complete with all required sections
4. Clear next steps for resolution documented
5. Phase 14 objective met: dashboard components and calculations thoroughly reviewed with code evidence
</success_criteria>

<output>
After completion, create `.planning/phases/14-dashboard-calculations-review/14-02-SUMMARY.md`
</output>
