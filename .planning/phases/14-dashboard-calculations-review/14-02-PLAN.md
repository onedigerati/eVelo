---
phase: 14-dashboard-calculations-review
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - .planning/phases/14-dashboard-calculations-review/14-GAP-FINDINGS.md
autonomous: true

must_haves:
  truths:
    - "Probability cone chart renders with correct percentile bands"
    - "Terminal histogram displays correct distribution"
    - "Portfolio donut chart shows asset weights"
    - "Correlation heatmap displays matrix correctly"
    - "Margin call chart shows probability by year"
    - "SBLOC balance chart shows loan trajectory"
    - "BBD vs Sell comparison charts display correctly"
    - "All visualization issues documented"
  artifacts:
    - path: ".planning/phases/14-dashboard-calculations-review/14-GAP-FINDINGS.md"
      provides: "Complete gap documentation"
      contains: "## Visualization Gaps"
  key_links:
    - from: "src/components/ui/results-dashboard.ts"
      to: "src/charts/*.ts"
      via: "Data binding and transformations"
      pattern: "updateCharts|setData"
---

<objective>
Verify all VIZ requirements render correctly and finalize gap documentation.

Purpose: Ensure all dashboard visualizations correctly bind to simulation data and display accurate information, completing the comprehensive gap findings document.

Output: Complete 14-GAP-FINDINGS.md with all calculation and visualization issues documented.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-dashboard-calculations-review/14-RESEARCH.md
@.planning/phases/14-dashboard-calculations-review/14-01-SUMMARY.md

Key files to verify:
@src/components/ui/results-dashboard.ts - Main orchestrator (1720 lines)
@src/charts/probability-cone-chart.ts - VIZ-01
@src/charts/histogram-chart.ts - VIZ-02
@src/charts/donut-chart.ts - VIZ-03
@src/charts/correlation-heatmap.ts - VIZ-04
@src/charts/margin-call-chart.ts - VIZ-05
@src/charts/sbloc-balance-chart.ts - VIZ-06
@src/charts/bbd-comparison-chart.ts - VIZ-07
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify visualization data bindings (VIZ-01 through VIZ-04)</name>
  <files>
    src/components/ui/results-dashboard.ts
    src/charts/probability-cone-chart.ts
    src/charts/histogram-chart.ts
    src/charts/donut-chart.ts
    src/charts/correlation-heatmap.ts
    .planning/phases/14-dashboard-calculations-review/14-GAP-FINDINGS.md
  </files>
  <action>
Verify each visualization requirement and document issues:

**VIZ-01: Probability Cone Chart**
1. Read transformToConeData() in results-dashboard.ts
2. Verify yearlyPercentiles correctly mapped to bands (p10, p25, p50, p75, p90)
3. NOTE: Data will be INCORRECT due to GAP-01 (percentile scale mismatch in monte-carlo.ts)
4. Document if any additional transformation issues exist

**VIZ-02: Terminal Distribution Histogram**
1. Read transformToHistogramData() in results-dashboard.ts
2. Verify terminalValues properly binned (20 bins)
3. Verify histogram color gradient (red -> yellow -> green)
4. Document any issues

**VIZ-03: Portfolio Composition Donut**
1. Verify portfolioWeights setter in results-dashboard.ts
2. Verify data passed correctly to donut-chart component
3. Check segment labels and percentages format
4. Document any issues

**VIZ-04: Correlation Heatmap**
1. Verify correlationMatrix setter in results-dashboard.ts
2. Read calculateAssetStatistics() - check fallback values (8%/16% defaults)
3. Document GAP if fallback values are misleading for unknown assets

Append findings to 14-GAP-FINDINGS.md under ## Visualization Gaps section.
  </action>
  <verify>
    - 14-GAP-FINDINGS.md contains ## Visualization Gaps section
    - Each VIZ requirement (VIZ-01 through VIZ-04) has been reviewed
    - Data flow from SimulationOutput to chart components verified
  </verify>
  <done>
    VIZ-01 through VIZ-04 verified and any issues documented
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify SBLOC visualizations (VIZ-05 through VIZ-07) and finalize documentation</name>
  <files>
    src/components/ui/results-dashboard.ts
    src/charts/margin-call-chart.ts
    src/charts/sbloc-balance-chart.ts
    src/charts/bbd-comparison-chart.ts
    src/charts/comparison-line-chart.ts
    src/charts/cumulative-costs-chart.ts
    src/charts/terminal-comparison-chart.ts
    .planning/phases/14-dashboard-calculations-review/14-GAP-FINDINGS.md
  </files>
  <action>
Verify SBLOC-related visualizations and finalize gap documentation:

**VIZ-05: Margin Call Risk Chart**
1. Verify marginCallStats from simulation correctly bound
2. Check updateMarginCallChart() in results-dashboard.ts
3. Verify cumulative probability line shows correctly
4. Document any issues

**VIZ-06: SBLOC Balance Chart**
1. Verify sblocTrajectory.loanBalance percentiles bound correctly
2. NOTE: Data will be INCORRECT due to GAP-01 (percentile scale mismatch)
3. Check cumulative withdrawals and interest display
4. Document any issues

**VIZ-07: BBD vs Sell Comparison**
1. Verify estateAnalysis data binding
2. Check calculateSellStrategy() called with correct params
3. Verify all comparison charts populate:
   - bbd-comparison-chart (bar chart)
   - comparison-line-chart (net worth over time)
   - cumulative-costs-chart (taxes vs interest)
   - terminal-comparison-chart (percentile comparison)
4. Check for off-by-one errors in updateComparisonLineChart() (research identified potential issue at line 1386-1389)
5. Document any issues

**Finalize Documentation:**
1. Add ## Summary section to 14-GAP-FINDINGS.md
2. List all gaps by severity (HIGH, MEDIUM, LOW)
3. Add ## Resolution Priority section
4. Add ## Affected Requirements section mapping gaps to requirements
  </action>
  <verify>
    - 14-GAP-FINDINGS.md contains complete documentation
    - ## Summary section lists all gaps with severity
    - ## Resolution Priority section provides recommended fix order
    - All VIZ requirements reviewed and documented
  </verify>
  <done>
    VIZ-05 through VIZ-07 verified, all gaps documented, 14-GAP-FINDINGS.md complete
  </done>
</task>

<task type="auto">
  <name>Task 3: Create resolution plan summary</name>
  <files>
    .planning/phases/14-dashboard-calculations-review/14-GAP-FINDINGS.md
  </files>
  <action>
Add final sections to 14-GAP-FINDINGS.md:

1. **## Next Steps** section:
   - Create Phase 15 or gap closure plans to address findings
   - Prioritize by impact (percentile scale mismatch affects multiple components)

2. **## Test Recommendations** section:
   - Unit tests for percentile() with both scale conventions
   - Integration tests for dashboard calculations
   - Known-input verification tests (e.g., $1M over 30 years)

3. **## Metadata** section:
   - Date reviewed
   - Files examined
   - Total gaps found
   - Critical gaps requiring immediate attention

Ensure the document follows the gap finding template from research:
```markdown
### GAP-XX: [Short Title]

**Requirement**: [VIZ-XX or CALC-XX]
**Severity**: HIGH | MEDIUM | LOW
**Component**: [File and function]

**Description**:
[What is wrong or potentially wrong]

**Evidence**:
[Code snippet or test result showing the issue]

**Expected Behavior**:
[What should happen]

**Proposed Resolution**:
[How to fix it]
```
  </action>
  <verify>
    - 14-GAP-FINDINGS.md is complete and well-structured
    - All sections present: Calculation Gaps, Visualization Gaps, Summary, Resolution Priority, Next Steps, Test Recommendations, Metadata
    - Each gap follows the standard template
  </verify>
  <done>
    14-GAP-FINDINGS.md is a complete, actionable document ready for Phase 15 planning
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. 14-GAP-FINDINGS.md is complete with all sections
2. All VIZ requirements (VIZ-01 through VIZ-07) reviewed
3. Document contains:
   - ## Calculation Gaps (from Plan 14-01)
   - ## Visualization Gaps (from this plan)
   - ## Summary (gap count by severity)
   - ## Resolution Priority (recommended fix order)
   - ## Affected Requirements (mapping)
   - ## Next Steps (future work)
   - ## Test Recommendations
   - ## Metadata
4. Each gap has full documentation per template
</verification>

<success_criteria>
1. All VIZ requirements verified (VIZ-01 through VIZ-07)
2. Visualization data bindings traced from SimulationOutput to chart components
3. 14-GAP-FINDINGS.md complete with all required sections
4. Clear next steps for resolution documented
5. Phase 14 objective met: dashboard components and calculations thoroughly reviewed
</success_criteria>

<output>
After completion, create `.planning/phases/14-dashboard-calculations-review/14-02-SUMMARY.md`
</output>
