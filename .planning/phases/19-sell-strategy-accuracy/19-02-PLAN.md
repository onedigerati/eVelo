---
phase: 19-sell-strategy-accuracy
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/calculations/sell-strategy.ts
autonomous: true

must_haves:
  truths:
    - "Sell strategy deducts dividend taxes from portfolio each year"
    - "Dividend yield and tax rate are configurable"
    - "Dividend taxes accumulate separately from capital gains taxes"
  artifacts:
    - path: "src/calculations/sell-strategy.ts"
      provides: "Dividend tax calculation in year loop"
      contains: "dividendTax"
  key_links:
    - from: "SellStrategyConfig"
      to: "runSingleSellScenario"
      via: "dividend config fields"
      pattern: "dividendYield.*dividendTaxRate"
---

<objective>
Add dividend tax modeling to the Sell strategy calculation.

Purpose: The reference implementation models dividend taxes differently for BBD (borrowed to pay, portfolio stays whole) vs Sell (liquidated from portfolio, reduces balance). Without this, eVelo's Sell strategy appears more competitive than reality because it ignores dividend tax drag.

Output: Extended SellStrategyConfig with dividend parameters, updated calculation functions that deduct dividend taxes annually.
</objective>

<execution_context>
@C:\Users\ungac\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ungac\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-sell-strategy-accuracy/19-RESEARCH.md
@src/calculations/sell-strategy.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend SellStrategyConfig with dividend fields</name>
  <files>src/calculations/sell-strategy.ts</files>
  <action>
Add optional dividend tax configuration fields to the `SellStrategyConfig` interface:

```typescript
export interface SellStrategyConfig {
  /** Initial portfolio value */
  initialValue: number;
  /** Annual withdrawal amount */
  annualWithdrawal: number;
  /** Annual withdrawal growth rate (e.g., 0.03 for 3%) */
  withdrawalGrowth: number;
  /** Time horizon in years */
  timeHorizon: number;
  /** Capital gains tax rate (default: 0.238 for 23.8%) */
  capitalGainsRate?: number;
  /** Initial cost basis as fraction of portfolio (default: 0.4 for 40%) */
  costBasisRatio?: number;

  // NEW: Dividend tax configuration
  /**
   * Annual dividend yield as decimal (default: 0.02 for 2%)
   * S&P 500 historical average is ~1.5-2%
   */
  dividendYield?: number;
  /**
   * Dividend tax rate as decimal (default: 0.238 for 23.8%)
   * Uses capital gains rate for qualified dividends
   * Note: For simplicity, treating all dividends as qualified
   */
  dividendTaxRate?: number;
}
```

Also extend `SellStrategyResult` to track dividend taxes:

```typescript
export interface SellStrategyResult {
  // ... existing fields ...

  /** Cumulative lifetime dividend taxes paid (Sell strategy only) */
  lifetimeDividendTaxes: number;

  /** Total lifetime taxes (capital gains + dividends) */
  totalLifetimeTaxes: number;
}
```
  </action>
  <verify>
Build passes: `npm run build` completes without TypeScript errors.
  </verify>
  <done>
SellStrategyConfig has dividendYield and dividendTaxRate fields. SellStrategyResult includes lifetimeDividendTaxes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement dividend tax calculation in scenario functions</name>
  <files>src/calculations/sell-strategy.ts</files>
  <action>
Update both `runSingleSellScenario` and `runInterpolatedScenario` to:

1. Accept dividend config parameters
2. Deduct dividend taxes at the START of each year (before withdrawal)
3. Track total dividend taxes paid

In `runSellScenarios`, pass the dividend config:
```typescript
function runSellScenarios(
  initialValue: number,
  annualWithdrawal: number,
  withdrawalGrowth: number,
  timeHorizon: number,
  capitalGainsRate: number,
  costBasisRatio: number,
  yearlyPercentiles: YearlyPercentiles[],
  dividendYield: number,      // NEW
  dividendTaxRate: number,    // NEW
): SellScenario[]
```

In `runSingleSellScenario`:
```typescript
function runSingleSellScenario(
  // ... existing params ...
  dividendYield: number,
  dividendTaxRate: number,
): SellScenario {
  // ... setup ...
  let totalDividendTaxes = 0;  // NEW tracking variable

  for (let year = 1; year <= timeHorizon; year++) {
    if (portfolioValue <= 0) { /* ... */ }

    // 1. DIVIDEND TAX FIRST (NEW - before withdrawal)
    // Dividend taxes reduce portfolio (in Sell strategy, unlike BBD which borrows to pay)
    const dividendIncome = portfolioValue * dividendYield;
    const dividendTax = dividendIncome * dividendTaxRate;
    portfolioValue -= dividendTax;
    totalDividendTaxes += dividendTax;

    // 2. WITHDRAWAL + CAPITAL GAINS TAX (existing, already moved in 19-01)
    // ... existing withdrawal logic ...

    // 3. GROWTH APPLIED TO REDUCED PORTFOLIO (existing)
    // ... existing growth logic ...
  }

  return {
    terminalValue: portfolioValue,
    totalTaxes,           // capital gains taxes
    totalDividendTaxes,   // NEW
    depleted,
    yearlyValues,
  };
}
```

Update `SellScenario` interface to include `totalDividendTaxes`:
```typescript
interface SellScenario {
  terminalValue: number;
  totalTaxes: number;
  totalDividendTaxes: number;  // NEW
  depleted: boolean;
  yearlyValues: number[];
}
```

Apply same changes to `runInterpolatedScenario`.

In `calculateSellStrategy`, aggregate dividend taxes:
```typescript
// Extract defaults
const dividendYield = config.dividendYield ?? 0.02;  // 2% default
const dividendTaxRate = config.dividendTaxRate ?? capitalGainsRate;  // Use cap gains rate

// Pass to runSellScenarios
const scenarios = runSellScenarios(
  // ... existing params ...
  dividendYield,
  dividendTaxRate,
);

// Calculate median dividend taxes
const dividendTaxesArray = scenarios.map(s => s.totalDividendTaxes);
const lifetimeDividendTaxes = calcPercentile(dividendTaxesArray, 50);

return {
  // ... existing fields ...
  lifetimeTaxes,
  lifetimeDividendTaxes,
  totalLifetimeTaxes: lifetimeTaxes + lifetimeDividendTaxes,
};
```
  </action>
  <verify>
Build passes: `npm run build` completes without TypeScript errors.
  </verify>
  <done>
Dividend taxes are calculated and tracked in both scenario functions. Total lifetime taxes includes both capital gains and dividends.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update interpolated scenarios helper</name>
  <files>src/calculations/sell-strategy.ts</files>
  <action>
Update `runInterpolatedScenarios` to pass dividend config:

```typescript
function runInterpolatedScenarios(
  initialValue: number,
  annualWithdrawal: number,
  withdrawalGrowth: number,
  timeHorizon: number,
  capitalGainsRate: number,
  costBasisRatio: number,
  yearlyPercentiles: YearlyPercentiles[],
  dividendYield: number,      // NEW
  dividendTaxRate: number,    // NEW
): SellScenario[] {
  const scenarios: SellScenario[] = [];

  const interpolations = [
    { lower: 'p10' as const, upper: 'p25' as const, weight: 0.5 },
    { lower: 'p25' as const, upper: 'p50' as const, weight: 0.5 },
    { lower: 'p50' as const, upper: 'p75' as const, weight: 0.5 },
    { lower: 'p75' as const, upper: 'p90' as const, weight: 0.5 },
  ];

  for (const interp of interpolations) {
    const scenario = runInterpolatedScenario(
      initialValue,
      annualWithdrawal,
      withdrawalGrowth,
      timeHorizon,
      capitalGainsRate,
      costBasisRatio,
      yearlyPercentiles,
      interp.lower,
      interp.upper,
      interp.weight,
      dividendYield,      // NEW
      dividendTaxRate,    // NEW
    );
    scenarios.push(scenario);
  }

  return scenarios;
}
```

Update `runSellScenarios` to pass dividend config to `runInterpolatedScenarios`:
```typescript
const interpolatedScenarios = runInterpolatedScenarios(
  initialValue,
  annualWithdrawal,
  withdrawalGrowth,
  timeHorizon,
  capitalGainsRate,
  costBasisRatio,
  yearlyPercentiles,
  dividendYield,      // NEW
  dividendTaxRate,    // NEW
);
```

Add JSDoc to document the dividend tax behavior:
```typescript
/**
 * Calculate Sell Assets strategy outcomes from BBD simulation data.
 *
 * Uses the yearly percentiles from BBD simulation to project what would happen
 * if the investor sold assets each year instead of borrowing.
 *
 * Key differences from BBD:
 * - No loan, no interest accrual
 * - Capital gains taxes paid on each sale
 * - Dividend taxes paid from portfolio (BBD borrows to pay dividends)
 * - Portfolio depletes faster due to combined tax drag
 * - No stepped-up basis benefit at death
 *
 * Order of operations per year (matches reference):
 * 1. Dividend income generates tax liability, paid from portfolio
 * 2. Withdrawal + capital gains tax reduces portfolio
 * 3. Market returns applied to reduced portfolio
 *
 * @param config - Sell strategy configuration including dividend tax params
 * @param yearlyPercentiles - Portfolio percentiles from BBD simulation (for growth rates)
 * @returns Sell strategy result with all metrics including dividend taxes
 */
```
  </action>
  <verify>
Build passes: `npm run build` completes without TypeScript errors.
Run simulation and verify lifetimeDividendTaxes is non-zero with default 2% yield.
  </verify>
  <done>
All scenario functions accept and apply dividend tax configuration. Documentation updated.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. SellStrategyResult includes lifetimeDividendTaxes and totalLifetimeTaxes fields
3. With default 2% dividend yield, dividend taxes accumulate over simulation
4. Sell strategy terminal values lower than without dividend tax modeling
</verification>

<success_criteria>
- Dividend tax config fields added to SellStrategyConfig
- Dividend taxes deducted from portfolio each year (before withdrawal)
- Dividend taxes tracked separately and in total
- Default dividend yield of 2% applied when not specified
- Build compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/19-sell-strategy-accuracy/19-02-SUMMARY.md`
</output>
