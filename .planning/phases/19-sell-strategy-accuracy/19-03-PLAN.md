---
phase: 19-sell-strategy-accuracy
plan: 03
type: execute
wave: 2
depends_on:
  - 19-01
  - 19-02
files_modified:
  - src/calculations/sell-strategy.ts
  - src/components/ui/results-dashboard.ts
autonomous: true

must_haves:
  truths:
    - "Sell strategy receives same return sequence as BBD for each percentile"
    - "Growth rates derived consistently from percentile data"
    - "Fair comparison achieved with identical market paths"
  artifacts:
    - path: "src/calculations/sell-strategy.ts"
      provides: "Consistent return derivation"
      contains: "extractGrowthRates"
  key_links:
    - from: "calculateSellStrategy"
      to: "yearlyPercentiles"
      via: "growth rate extraction"
      pattern: "extractGrowthRates.*yearlyPercentiles"
---

<objective>
Ensure identical returns path for both BBD and Sell strategy comparison.

Purpose: eVelo currently derives Sell growth rates indirectly from BBD percentile data. While this creates comparable scenarios, the extraction method should be reviewed and documented to ensure consistency. This plan validates and documents the return derivation approach.

Output: Reviewed and documented return derivation in sell-strategy.ts, ensuring BBD and Sell use equivalent market return paths.
</objective>

<execution_context>
@C:\Users\ungac\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ungac\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-sell-strategy-accuracy/19-RESEARCH.md
@.planning/phases/19-sell-strategy-accuracy/19-01-SUMMARY.md
@.planning/phases/19-sell-strategy-accuracy/19-02-SUMMARY.md
@src/calculations/sell-strategy.ts
@src/components/ui/results-dashboard.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Review and document growth rate extraction</name>
  <files>src/calculations/sell-strategy.ts</files>
  <action>
Review the `extractGrowthRates` function and add comprehensive documentation explaining the return derivation approach:

```typescript
/**
 * Extract implied growth rates from yearly percentile data.
 *
 * This function derives the year-over-year growth rates that were used
 * in the BBD Monte Carlo simulation for a given percentile path.
 *
 * The Sell strategy uses these same growth rates to ensure an apples-to-apples
 * comparison with BBD. Both strategies experience identical market conditions
 * for each percentile scenario (P10, P25, P50, P75, P90).
 *
 * Formula: growthRate[year] = (percentile[year] - percentile[year-1]) / percentile[year-1]
 *
 * Note: This approach uses the IMPLIED growth rates from BBD portfolio values,
 * which already account for:
 * - Asset correlations
 * - Portfolio weight allocation
 * - Regime-switching or bootstrap sampling
 *
 * For BBD, the portfolio value AFTER returns and AFTER SBLOC adjustments is recorded.
 * For Sell, we apply the same return before accounting for withdrawals and taxes,
 * ensuring the underlying market performance is identical.
 *
 * @param yearlyPercentiles - Portfolio value percentiles from BBD simulation
 * @returns Array of growth rates for each year (length = timeHorizon)
 *
 * @example
 * // If year 0 P50 = $1,000,000 and year 1 P50 = $1,080,000
 * // Then growth rate for year 1 = (1,080,000 - 1,000,000) / 1,000,000 = 0.08 (8%)
 */
function extractGrowthRates(yearlyPercentiles: YearlyPercentiles[]): number[] {
  const rates: number[] = [];

  for (let i = 1; i < yearlyPercentiles.length; i++) {
    const prev = yearlyPercentiles[i - 1].p50;
    const curr = yearlyPercentiles[i].p50;
    const rate = prev > 0 ? (curr - prev) / prev : 0;
    rates.push(rate);
  }

  return rates;
}
```

Add a section comment above the helper functions:
```typescript
// ============================================================================
// Return Derivation
// ============================================================================
//
// The Sell strategy derives market returns from BBD simulation percentiles.
// This ensures both strategies experience identical market conditions for
// comparison purposes.
//
// Approach:
// - For each percentile path (P10, P25, P50, P75, P90), extract year-over-year
//   growth rates from the BBD portfolio values
// - Apply these same growth rates to the Sell portfolio (after accounting for
//   dividend taxes, withdrawals, and capital gains taxes)
//
// This creates a fair comparison where BBD advantage comes purely from:
// 1. Tax deferral (no capital gains on withdrawals)
// 2. Compound growth on full portfolio (no reduction from taxes)
// 3. Stepped-up basis at death
//
// And NOT from different market return assumptions.
// ============================================================================
```
  </action>
  <verify>
Build passes: `npm run build` completes without TypeScript errors.
  </verify>
  <done>
extractGrowthRates function has comprehensive documentation explaining the return derivation approach.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add year-0 percentile initialization</name>
  <files>src/calculations/sell-strategy.ts</files>
  <action>
The current implementation assumes yearlyPercentiles[0] exists with the initial value. Verify this is handled correctly and add defensive handling:

In `runSingleSellScenario`, verify the growth rate calculation handles year 1 correctly:

```typescript
for (let year = 1; year <= timeHorizon; year++) {
  // ... dividend tax and withdrawal logic ...

  // Get growth rate from BBD simulation for this year
  // yearlyPercentiles[year] contains values AT THE END of that year
  // yearlyPercentiles[0] should contain initial values (year 0 = start)
  const yearData = yearlyPercentiles[year];
  const prevYearData = yearlyPercentiles[year - 1];

  // Defensive: handle missing percentile data
  if (!yearData || !prevYearData) {
    // Fallback: use conservative average historical growth
    // This should rarely trigger if simulation data is complete
    console.warn(`Sell strategy: Missing percentile data for year ${year}, using fallback 7%`);
    portfolioValue *= 1.07;
  } else {
    // Calculate growth rate from percentile data
    const prevValue = prevYearData[percentileKey];
    const currValue = yearData[percentileKey];

    // Guard against division by zero
    const growthRate = prevValue > 0 ? (currValue - prevValue) / prevValue : 0;

    // Apply growth to portfolio (AFTER withdrawal, per correct order)
    portfolioValue *= (1 + growthRate);
  }

  yearlyValues.push(portfolioValue);
}
```

Add similar defensive handling to `runInterpolatedScenario`.

Also add a validation check at the start of `calculateSellStrategy`:
```typescript
export function calculateSellStrategy(
  config: SellStrategyConfig,
  yearlyPercentiles: YearlyPercentiles[],
): SellStrategyResult {
  // Validate percentile data completeness
  if (yearlyPercentiles.length < config.timeHorizon) {
    console.warn(
      `Sell strategy: yearlyPercentiles length (${yearlyPercentiles.length}) ` +
      `is less than timeHorizon (${config.timeHorizon}). Results may be incomplete.`
    );
  }

  // ... rest of function
}
```
  </action>
  <verify>
Build passes: `npm run build` completes without TypeScript errors.
  </verify>
  <done>
Defensive handling added for missing percentile data. Validation warning for incomplete data.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify integration in results-dashboard</name>
  <files>src/components/ui/results-dashboard.ts</files>
  <action>
Review how `calculateSellStrategy` is called in results-dashboard.ts to ensure yearlyPercentiles is passed correctly with year-0 data.

Search for `calculateSellStrategy` usage and verify:
1. The yearlyPercentiles array includes year-0 (initial) values
2. The config is constructed with appropriate defaults

If the yearlyPercentiles from simulation doesn't include year 0, add it:

```typescript
// Ensure yearlyPercentiles includes year 0 for initial values
const percentilesWithYear0: YearlyPercentiles[] = [
  {
    year: 0,
    p10: config.initialValue,
    p25: config.initialValue,
    p50: config.initialValue,
    p75: config.initialValue,
    p90: config.initialValue,
  },
  ...output.yearlyPercentiles,
];

const sellResult = calculateSellStrategy(
  {
    initialValue: config.initialValue,
    annualWithdrawal: config.sbloc?.annualWithdrawal ?? 0,
    withdrawalGrowth: config.sbloc?.annualWithdrawalRaise ?? 0.03,
    timeHorizon: config.timeHorizon,
    capitalGainsRate: 0.238,
    costBasisRatio: 0.4,
    // Dividend tax defaults (can be made configurable later)
    dividendYield: 0.02,
    dividendTaxRate: 0.238,
  },
  percentilesWithYear0,
);
```

Add a comment explaining the year-0 initialization:
```typescript
// Year 0 represents the portfolio state at simulation start.
// All percentiles equal the initial value since no returns have occurred.
// This allows growth rate calculation for year 1: (year1Value - initialValue) / initialValue
```
  </action>
  <verify>
1. Build passes: `npm run build` completes without TypeScript errors.
2. Run `npm run dev` and open browser to localhost.
3. Run a simulation with typical parameters ($5M initial, $200K withdrawal, 30 years).
4. Open browser console and verify NO warnings about "Missing percentile data" appear.
5. Verify Sell strategy results display correctly (terminal values, taxes shown).
  </verify>
  <done>
Year-0 percentile data is correctly provided to calculateSellStrategy. Simulation runs without missing data warnings. Integration verified by running actual simulation.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. No console warnings about missing percentile data during simulation
3. Growth rate extraction documented with clear explanation
4. Year-0 handling ensures first year has valid previous value for growth calculation
</verification>

<success_criteria>
- extractGrowthRates function has comprehensive documentation
- Defensive handling for missing/incomplete percentile data
- Year-0 percentile data properly initialized for growth rate calculation
- Integration in results-dashboard verified and documented
- Build compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/19-sell-strategy-accuracy/19-03-SUMMARY.md`
</output>
