---
phase: 16-dashboard-comparison-mode
plan: 04
type: execute
wave: 3
depends_on: ["16-02", "16-03"]
files_modified:
  - src/components/app-root.ts
  - src/components/ui/portfolio-composition.ts
autonomous: false

must_haves:
  truths:
    - "Switching presets after simulation prompts Compare or Replace"
    - "Selecting Compare enters comparison mode after new simulation"
    - "Selecting Replace clears previous results"
    - "User can run new simulation from comparison mode"
    - "Comparison state persists during session but clears on refresh"
  artifacts:
    - path: "src/components/app-root.ts"
      provides: "Integration with comparison state manager"
      contains: "comparison-state-change"
    - path: "src/components/ui/portfolio-composition.ts"
      provides: "Preset change detection with comparison prompt"
      contains: "pendingComparisonMode"
  key_links:
    - from: "src/components/app-root.ts"
      to: "comparison-state.ts"
      via: "imports comparisonState"
      pattern: "import.*comparisonState"
    - from: "src/components/app-root.ts"
      to: "comparison-dashboard"
      via: "calls enterComparisonMode/exitComparisonMode"
      pattern: "enterComparisonMode|exitComparisonMode"
    - from: "src/components/ui/portfolio-composition.ts"
      to: "modal-dialog"
      via: "shows choice modal for comparison prompt"
      pattern: "type.*choice"
---

<objective>
Integrate comparison mode into the application workflow: preset change detection, comparison prompts, and state management wiring.

Purpose: Connect all comparison components into a cohesive user flow. When a user switches presets after running a simulation, they should be prompted to compare or replace. The app-root coordinates state changes and updates the comparison dashboard accordingly.

Output: Fully integrated comparison mode with preset change detection and modal prompts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-dashboard-comparison-mode/16-RESEARCH.md

# Dependencies from earlier plans
@src/services/comparison-state.ts — ComparisonStateManager (from 16-01)
@src/components/ui/comparison-dashboard.ts — ComparisonDashboard (from 16-02, 16-03)

# Files to modify
@src/components/app-root.ts — Main application orchestrator
@src/components/ui/portfolio-composition.ts — Preset selection handling
@src/components/ui/modal-dialog.ts — Already supports 'choice' type
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add preset change detection to portfolio-composition</name>
  <files>src/components/ui/portfolio-composition.ts</files>
  <action>
Modify portfolio-composition to detect preset changes and prompt for comparison:

1. Import comparisonState from services/comparison-state

2. Add private state:
   - _pendingComparisonMode: boolean = false

3. Modify preset selection handler (where preset dropdown change is handled):

Before loading the new preset, check if simulation results exist:
```typescript
const hasExistingResults = comparisonState.getCurrentResult() !== null;

if (hasExistingResults) {
  const choice = await this.modal.show({
    title: 'Simulation Results Exist',
    subtitle: 'Would you like to compare with the new preset or replace the current results?',
    type: 'choice',
    confirmText: 'Replace',
    cancelText: 'Cancel',
    alternateText: 'Compare',
  });

  if (choice === 'cancel') {
    // Restore previous selection in dropdown
    return;
  }

  if (choice === 'alternate') {
    // Flag for comparison mode after simulation completes
    this._pendingComparisonMode = true;
  }
  // 'confirm' = replace, proceed normally
}
```

4. Dispatch custom event with pendingComparisonMode flag:
```typescript
this.dispatchEvent(new CustomEvent('preset-loaded', {
  bubbles: true,
  composed: true,
  detail: {
    presetName: selectedPreset.name,
    pendingComparisonMode: this._pendingComparisonMode,
  }
}));
this._pendingComparisonMode = false; // Reset flag
```

5. Ensure 'Cancel' reverts the dropdown selection to previous value

NOTE: The modal-dialog 'choice' type already exists and returns 'confirm', 'alternate', or 'cancel'.
  </action>
  <verify>
1. Run a simulation
2. Change preset dropdown
3. Modal appears with Compare/Replace/Cancel options
4. Cancel reverts dropdown
5. Compare sets flag for later
6. Replace proceeds without flag
  </verify>
  <done>Preset change detection prompts user with Compare/Replace choice when results exist</done>
</task>

<task type="auto">
  <name>Task 2: Wire comparison state to app-root</name>
  <files>src/components/app-root.ts</files>
  <action>
Integrate comparison state management into app-root:

1. Import comparisonState from services/comparison-state

2. Add private state:
   - _pendingComparisonMode: boolean = false
   - _currentPresetName: string = ''

3. Replace results-dashboard with comparison-dashboard in template:
   - Change `<results-dashboard id="results">` to `<comparison-dashboard id="results">`
   - Update any type casts to ComparisonDashboard

4. In afterRender() or connectedCallback(), add event listeners:

```typescript
// Listen for preset-loaded to capture pending comparison flag
this.addEventListener('preset-loaded', (e: CustomEvent) => {
  this._pendingComparisonMode = e.detail.pendingComparisonMode || false;
  this._currentPresetName = e.detail.presetName || '';
});

// Update simulation-complete handler:
this.addEventListener('simulation-complete', (e: CustomEvent) => {
  const { result, config } = e.detail;
  const dashboard = this.$('#results') as ComparisonDashboard;

  if (this._pendingComparisonMode && comparisonState.getCurrentResult()) {
    // Enter comparison mode
    comparisonState.enterComparisonMode(result, config, this._currentPresetName);
    const state = comparisonState.getState();
    dashboard.enterComparisonMode(
      state.previousResult!,
      state.currentResult!,
      state.previousConfig!,
      state.currentConfig!,
      state.previousPresetName,
      state.currentPresetName
    );
  } else {
    // Normal mode - replace results
    comparisonState.replaceResults(result, config, this._currentPresetName);
    dashboard.data = result;
  }
  this._pendingComparisonMode = false;
});

// Listen for exit-comparison-mode from dashboard
this.addEventListener('exit-comparison-mode', () => {
  comparisonState.exitComparisonMode();
  const dashboard = this.$('#results') as ComparisonDashboard;
  const currentResult = comparisonState.getCurrentResult();
  dashboard.exitComparisonMode();
  if (currentResult) {
    dashboard.data = currentResult;
  }
});
```

5. Ensure simulation can still run from comparison mode:
   - Run Simulation button should work in both modes
   - After running, exit comparison mode and show new single result

6. Update import statements for ComparisonDashboard type
  </action>
  <verify>
1. Run simulation with Preset A - results show normally
2. Change to Preset B, select "Compare" - flag is set
3. Run simulation - comparison mode activates with both results
4. Click "Exit Comparison" - returns to single view with current result
5. Refresh page - comparison state is cleared, fresh start
  </verify>
  <done>App-root orchestrates comparison mode entry/exit based on user choices and simulation events</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete comparison mode integration: preset change detection, modal prompts, side-by-side desktop view, tabbed mobile view, and exit functionality</what-built>
  <how-to-verify>
1. Open application at http://localhost:5173
2. Run a simulation with default portfolio
3. Change portfolio preset in dropdown
4. Verify modal appears: "Compare with new preset or replace?"
5. Click "Compare" and run new simulation
6. On desktop (>768px): Verify two panels side-by-side with preset names
7. On mobile (<768px): Verify tabs appear (Previous/Current/Delta)
8. Test keyboard navigation on mobile tabs (arrow keys)
9. Click "Exit Comparison" button
10. Verify returns to single result view
11. Refresh page - verify fresh start (no cached comparison)
  </how-to-verify>
  <resume-signal>Type "approved" if all flows work correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. Preset change shows comparison prompt when results exist
2. "Compare" choice leads to side-by-side after simulation
3. "Replace" choice shows single result after simulation
4. "Cancel" reverts dropdown selection
5. Exit Comparison button returns to single view
6. Mobile tabs work with keyboard navigation
7. Refresh clears comparison state (session-only)
8. TypeScript compiles without errors: `npx tsc --noEmit`
</verification>

<success_criteria>
- User is prompted to Compare or Replace when switching presets after simulation
- Comparison mode shows side-by-side on desktop, tabs on mobile
- Delta indicators show +/- changes for key metrics
- Trade-off summary provides plain-language assessment
- Exit Comparison returns to single-result view
- New simulation can run from comparison mode
- State persists during session, clears on refresh
</success_criteria>

<output>
After completion, create `.planning/phases/16-dashboard-comparison-mode/16-04-SUMMARY.md`
</output>
