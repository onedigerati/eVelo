---
phase: 16-dashboard-comparison-mode
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/comparison-state.ts
  - src/utils/delta-calculations.ts
  - src/utils/index.ts
autonomous: true

must_haves:
  truths:
    - "Comparison state can be saved to sessionStorage"
    - "Comparison state clears on page refresh"
    - "Delta calculations produce correct absolute and percentage changes"
    - "Float64Array serializes correctly to JSON"
  artifacts:
    - path: "src/services/comparison-state.ts"
      provides: "ComparisonStateManager singleton for caching simulation results"
      exports: ["comparisonState", "ComparisonState"]
    - path: "src/utils/delta-calculations.ts"
      provides: "Delta calculation utilities for comparing metrics"
      exports: ["calculateDelta", "computeComparisonMetrics", "DeltaMetrics", "ComparisonMetrics"]
  key_links:
    - from: "src/services/comparison-state.ts"
      to: "sessionStorage"
      via: "JSON.stringify with Float64Array conversion"
      pattern: "sessionStorage\\.setItem"
    - from: "src/utils/delta-calculations.ts"
      to: "SimulationOutput"
      via: "type imports"
      pattern: "import.*SimulationOutput"
---

<objective>
Create the foundation services for comparison mode: state management and delta calculations.

Purpose: Provide the data layer for caching simulation results and computing metric deltas between previous and current simulations. These are pure services with no UI, enabling parallel development of comparison components.

Output: Two new modules - ComparisonStateManager service and delta calculation utilities.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-dashboard-comparison-mode/16-RESEARCH.md

# Key existing files
@src/simulation/types.ts — SimulationOutput, SimulationConfig, SimulationStatistics types
@src/utils/index.ts — Utility module barrel export
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ComparisonStateManager service</name>
  <files>src/services/comparison-state.ts</files>
  <action>
Create a singleton service that manages comparison mode state:

1. Define ComparisonState interface:
   - isComparisonMode: boolean
   - previousResult: SimulationOutput | null
   - previousConfig: SimulationConfig | null
   - previousPresetName: string
   - currentResult: SimulationOutput | null
   - currentConfig: SimulationConfig | null
   - currentPresetName: string

2. Create ComparisonStateManager class:
   - Private state object initialized with defaults (all null/false/empty)
   - saveToSession(): Convert Float64Array to Array before JSON.stringify, save to sessionStorage key 'comparisonState'
   - loadFromSession(): Parse from sessionStorage, convert Array back to Float64Array for terminalValues
   - enterComparisonMode(current, currentConfig, presetName): Move current to previous, set new current, set isComparisonMode=true
   - exitComparisonMode(): Set isComparisonMode=false, clear previous result/config/name
   - replaceResults(newResult, newConfig, presetName): Replace current, clear previous, set isComparisonMode=false
   - getCurrentResult(): Return current result
   - getPreviousResult(): Return previous result
   - getState(): Return full state object (readonly copy)
   - dispatchChange(): Dispatch 'comparison-state-change' CustomEvent on window with state detail

3. Export singleton instance: `export const comparisonState = new ComparisonStateManager();`

IMPORTANT: Float64Array serialization - use Array.from() before stringify, new Float64Array() on load.
  </action>
  <verify>
Create temporary test in browser console:
```javascript
import { comparisonState } from './services/comparison-state';
comparisonState.replaceResults({ terminalValues: new Float64Array([1,2,3]), ... }, {}, 'Test');
// Check sessionStorage has the data
// Refresh page, check state is cleared (fresh instance)
```
  </verify>
  <done>ComparisonStateManager service exists with session persistence and Float64Array handling</done>
</task>

<task type="auto">
  <name>Task 2: Create delta calculations utility</name>
  <files>src/utils/delta-calculations.ts, src/utils/index.ts</files>
  <action>
Create utility module for computing metric deltas:

1. Define DeltaMetrics interface:
   - absolute: number (raw difference)
   - percentChange: number (percentage change from previous)
   - direction: 'up' | 'down' | 'neutral'

2. Create calculateDelta(previous: number, current: number): DeltaMetrics
   - absolute = current - previous
   - percentChange = previous !== 0 ? (absolute / Math.abs(previous)) * 100 : (current !== 0 ? 100 : 0)
   - direction = absolute > 0.001 ? 'up' : absolute < -0.001 ? 'down' : 'neutral'
   - Use 0.001 threshold to avoid floating point noise

3. Define ComparisonMetrics interface:
   - finalValue: DeltaMetrics (median terminal value)
   - successRate: DeltaMetrics
   - maxDrawdown: DeltaMetrics (optional, only if calculable)
   - cagr: DeltaMetrics (optional)
   - marginCallProbability: DeltaMetrics (optional, only if SBLOC)

4. Create computeComparisonMetrics(previous: SimulationOutput, current: SimulationOutput): ComparisonMetrics
   - Compute deltas for each available metric
   - Handle optional fields (cagr, marginCallStats) gracefully

5. Update src/utils/index.ts to export delta-calculations module

Types to import from simulation/types.ts: SimulationOutput, SimulationStatistics
  </action>
  <verify>
```typescript
import { calculateDelta, computeComparisonMetrics } from './utils';
const delta = calculateDelta(100, 120);
console.log(delta); // { absolute: 20, percentChange: 20, direction: 'up' }

const delta2 = calculateDelta(100, 80);
console.log(delta2); // { absolute: -20, percentChange: -20, direction: 'down' }
```
  </verify>
  <done>Delta calculation utilities exist with proper type exports and handle edge cases</done>
</task>

</tasks>

<verification>
1. src/services/comparison-state.ts exports comparisonState singleton and ComparisonState type
2. src/utils/delta-calculations.ts exports calculateDelta and computeComparisonMetrics
3. src/utils/index.ts re-exports delta-calculations
4. TypeScript compiles without errors: `npx tsc --noEmit`
5. State manager correctly handles Float64Array serialization (no empty objects in sessionStorage)
</verification>

<success_criteria>
- ComparisonStateManager service manages comparison state with sessionStorage persistence
- State clears on page refresh (verified by checking sessionStorage behavior)
- Delta calculations handle edge cases (zero values, small differences)
- All exports typed correctly with TypeScript
- No runtime errors when importing modules
</success_criteria>

<output>
After completion, create `.planning/phases/16-dashboard-comparison-mode/16-01-SUMMARY.md`
</output>
