---
phase: 26-theme-implementation-review
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/charts/base-chart.ts
  - src/charts/probability-cone-chart.ts
  - src/charts/histogram-chart.ts
  - src/charts/sbloc-balance-chart.ts
  - src/charts/margin-call-chart.ts
  - src/charts/comparison-line-chart.ts
  - src/charts/cumulative-costs-chart.ts
  - src/charts/terminal-comparison-chart.ts
  - src/charts/sbloc-utilization-chart.ts
  - src/charts/bbd-comparison-chart.ts
autonomous: true

must_haves:
  truths:
    - "Chart percentile band colors update when theme toggles from light to dark"
    - "Chart bar/line colors update when theme toggles"
    - "No visual artifacts or color mismatches after theme toggle"
  artifacts:
    - path: "src/charts/base-chart.ts"
      provides: "updateDatasetColors hook method"
      contains: "updateDatasetColors"
    - path: "src/charts/probability-cone-chart.ts"
      provides: "Theme-aware dataset colors"
      contains: "getChartTheme"
  key_links:
    - from: "src/charts/base-chart.ts"
      to: "src/charts/theme.ts"
      via: "getChartTheme() call in handleThemeChange"
      pattern: "getChartTheme\\(\\)"
---

<objective>
Fix chart dataset colors to update dynamically when theme changes

Purpose: Currently, BaseChart.handleThemeChange() only updates scales/grid/legend colors. Dataset colors (percentile bands, bars, lines) use DEFAULT_CHART_THEME at build time and never update. Users toggling to dark theme see light-themed chart data on dark backgrounds with poor contrast.

Output: All chart components update their dataset colors reactively when theme changes, providing consistent visual experience across light and dark themes.
</objective>

<execution_context>
@C:\Users\ungac\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\ungac\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-theme-implementation-review/26-RESEARCH.md
@src/charts/base-chart.ts
@src/charts/theme.ts
@src/charts/types.ts
@src/charts/probability-cone-chart.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add updateDatasetColors hook to BaseChart</name>
  <files>src/charts/base-chart.ts</files>
  <action>
Extend BaseChart.handleThemeChange() to call a new protected hook method updateDatasetColors():

1. Add new protected method signature that subclasses can override:
```typescript
/**
 * Override in subclasses to update dataset colors on theme change.
 * Default implementation does nothing (for charts without theme-dependent datasets).
 * @param theme - Current chart theme (light or dark)
 */
protected updateDatasetColors(theme: ChartTheme): void {
  // Default: no-op. Subclasses override for specific dataset color updates.
}
```

2. Import ChartTheme type at top of file if not already imported.

3. Modify handleThemeChange to call this hook:
```typescript
private handleThemeChange = (): void => {
  if (!this.chart) return;
  const theme = getChartTheme();

  // Existing scale/grid/legend updates...

  // NEW: Update dataset colors via subclass hook
  this.updateDatasetColors(theme);

  this.chart.update('none');
};
```

This pattern allows each chart subclass to update its specific dataset colors without modifying the base class logic.
  </action>
  <verify>
Run `npm run build` - TypeScript compiles without errors. Check that BaseChart exports updateDatasetColors method.
  </verify>
  <done>
BaseChart has protected updateDatasetColors(theme) hook method called during handleThemeChange. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement updateDatasetColors in chart subclasses</name>
  <files>
    src/charts/probability-cone-chart.ts
    src/charts/histogram-chart.ts
    src/charts/sbloc-balance-chart.ts
    src/charts/margin-call-chart.ts
    src/charts/comparison-line-chart.ts
    src/charts/cumulative-costs-chart.ts
    src/charts/terminal-comparison-chart.ts
    src/charts/sbloc-utilization-chart.ts
    src/charts/bbd-comparison-chart.ts
  </files>
  <action>
Override updateDatasetColors in each chart component. For each chart:

1. Import getChartTheme and ChartTheme from './theme' if not already imported.

2. Add override method that updates dataset colors in-place based on the chart type:

**probability-cone-chart.ts:**
```typescript
protected updateDatasetColors(theme: ChartTheme): void {
  if (!this.chart) return;
  const alpha = CHART_ALPHA.bandFill;
  const withAlpha = (hex: string, a: number): string => {
    const alpha256 = Math.round(a * 255).toString(16).padStart(2, '0');
    return hex + alpha256;
  };

  this.chart.data.datasets.forEach((dataset) => {
    const label = dataset.label || '';
    if (label.includes('P90')) {
      dataset.borderColor = theme.percentiles.p90;
    } else if (label.includes('P75')) {
      dataset.borderColor = theme.percentiles.p75;
      dataset.backgroundColor = withAlpha(theme.percentiles.p90, alpha);
    } else if (label.includes('P50')) {
      dataset.borderColor = theme.percentiles.p50;
      dataset.backgroundColor = withAlpha(theme.percentiles.p75, alpha);
    } else if (label.includes('P25')) {
      dataset.borderColor = theme.percentiles.p25;
      dataset.backgroundColor = withAlpha(theme.percentiles.p25, alpha);
    } else if (label.includes('P10')) {
      dataset.borderColor = theme.percentiles.p10;
      dataset.backgroundColor = withAlpha(theme.percentiles.p10, alpha);
    }
  });
}
```

**For other charts, follow similar patterns:**
- sbloc-balance-chart.ts: Update percentile line colors (p10, p25, p50, p75, p90)
- sbloc-utilization-chart.ts: Update percentile band colors
- margin-call-chart.ts: Update bar colors based on risk level (use theme.positive/negative/percentiles)
- histogram-chart.ts: Update bar colors (gradient from negative to positive)
- comparison-line-chart.ts: Update BBD vs Sell line colors
- cumulative-costs-chart.ts: Update area fill colors
- terminal-comparison-chart.ts: Update grouped bar colors
- bbd-comparison-chart.ts: Update BBD/Sell bar colors

Key pattern: Access dataset colors via `this.chart.data.datasets[i].borderColor` and `backgroundColor`. Use `theme.percentiles.*`, `theme.positive`, `theme.negative` from the ChartTheme.

Do NOT rebuild chart data. Only update colors in-place for efficiency.
  </action>
  <verify>
1. Run `npm run build` - all charts compile without errors
2. Start dev server, run simulation, toggle theme - verify chart colors update
  </verify>
  <done>
All 9 chart components implement updateDatasetColors() to update their specific dataset colors on theme change. Build passes and charts visually update when theme toggles.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without TypeScript errors
2. Dev server shows charts updating colors when theme toggles
3. Probability cone chart percentile bands change from light to dark theme colors
4. All chart types respond to theme changes (bars, lines, areas)
5. No console errors during theme toggle
</verification>

<success_criteria>
- [ ] BaseChart.updateDatasetColors() hook exists and is called in handleThemeChange
- [ ] 9 chart subclasses override updateDatasetColors with theme-specific logic
- [ ] Toggling theme updates chart dataset colors (not just scales/grid/legend)
- [ ] Build passes without errors
- [ ] No visual glitches or color mismatches after theme toggle
</success_criteria>

<output>
After completion, create `.planning/phases/26-theme-implementation-review/26-01-SUMMARY.md`
</output>
