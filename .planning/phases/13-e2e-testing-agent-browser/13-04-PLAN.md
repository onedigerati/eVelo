---
phase: 13-e2e-testing-agent-browser
plan: 04
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - test/e2e/responsive.js
autonomous: true

must_haves:
  truths:
    - "Responsive test captures screenshots at desktop, tablet, mobile viewports"
    - "Sidebar visibility changes correctly at mobile breakpoint"
    - "Layout adapts correctly at each viewport size"
    - "Screenshots stored for visual regression comparison"
  artifacts:
    - path: "test/e2e/responsive.js"
      provides: "Responsive layout tests at multiple viewports"
      min_lines: 80
  key_links:
    - from: "test/e2e/responsive.js"
      to: "test/e2e/helpers/agent-browser.js"
      via: "import setViewport"
      pattern: "setViewport"
---

<objective>
Create responsive layout tests that verify the app works at desktop, tablet, and mobile viewports.

Purpose: Ensure the app's responsive design works correctly across device sizes. The sidebar-panel behavior (visible on desktop, overlay on mobile) is critical UX.
Output: Responsive test capturing screenshots and verifying layout at 3 viewport sizes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/13-e2e-testing-agent-browser/13-RESEARCH.md
@.planning/phases/13-e2e-testing-agent-browser/13-01-SUMMARY.md
@src/components/ui/main-layout.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create responsive layout test</name>
  <files>test/e2e/responsive.js</files>
  <action>
  Create responsive test that verifies layout at desktop, tablet, and mobile viewports:

  ```javascript
  // test/e2e/responsive.js
  // Responsive layout tests at multiple viewports
  import { startServer, stopServer, getBaseUrl } from './helpers/server.js';
  import {
    open, close, isVisible, screenshot, wait, setViewport, findRole, evalJs
  } from './helpers/agent-browser.js';

  // Viewport configurations
  const VIEWPORTS = [
    { name: 'desktop', width: 1920, height: 1080 },
    { name: 'tablet', width: 768, height: 1024 },
    { name: 'mobile', width: 375, height: 667 },
  ];

  // Layout expectations by viewport
  // Based on 07-04 decision: Mobile breakpoint at 768px
  const EXPECTATIONS = {
    desktop: {
      sidebarVisible: true,
      description: 'Sidebar always visible on desktop'
    },
    tablet: {
      sidebarVisible: true,  // At exactly 768px, sidebar still visible
      description: 'Sidebar visible at tablet breakpoint'
    },
    mobile: {
      sidebarVisible: false, // Below 768px, sidebar hidden by default
      description: 'Sidebar hidden on mobile (overlay mode)'
    },
  };

  async function runResponsiveTest() {
    console.log('========================================');
    console.log('eVelo Responsive Layout Test');
    console.log('========================================\n');

    let passed = 0;
    let failed = 0;

    try {
      // Start server
      await startServer();

      // Open application
      await open(getBaseUrl());
      await wait('main-layout', { timeout: 10000 });

      for (const viewport of VIEWPORTS) {
        console.log(`\n[${viewport.name.toUpperCase()}] Testing ${viewport.width}x${viewport.height}`);
        console.log('-'.repeat(40));

        // Set viewport
        await setViewport(viewport.width, viewport.height);

        // Wait for layout to adjust
        await new Promise(r => setTimeout(r, 500));

        const expectation = EXPECTATIONS[viewport.name];

        // Test 1: Capture screenshot
        const screenshotPath = `test/e2e/screenshots/current/responsive-${viewport.name}.png`;
        try {
          await screenshot(screenshotPath);
          console.log(`  [PASS] Screenshot saved: responsive-${viewport.name}.png`);
          passed++;
        } catch (e) {
          console.log(`  [FAIL] Screenshot failed: ${e.message}`);
          failed++;
        }

        // Test 2: Check sidebar visibility
        try {
          const sidebarVisible = await isVisible('sidebar-panel');

          if (viewport.name === 'mobile') {
            // On mobile, sidebar should be hidden initially
            if (!sidebarVisible) {
              console.log(`  [PASS] ${expectation.description}`);
              passed++;
            } else {
              console.log(`  [FAIL] Sidebar visible on mobile (should be hidden)`);
              failed++;
            }
          } else {
            // On desktop/tablet, sidebar should be visible
            if (sidebarVisible === expectation.sidebarVisible) {
              console.log(`  [PASS] ${expectation.description}`);
              passed++;
            } else {
              console.log(`  [FAIL] Sidebar visibility: expected ${expectation.sidebarVisible}, got ${sidebarVisible}`);
              failed++;
            }
          }
        } catch (e) {
          console.log(`  [FAIL] Could not check sidebar: ${e.message}`);
          failed++;
        }

        // Test 3: Verify main layout visible
        try {
          const mainVisible = await isVisible('main-layout');
          if (mainVisible) {
            console.log(`  [PASS] Main layout visible at ${viewport.name}`);
            passed++;
          } else {
            console.log(`  [FAIL] Main layout not visible at ${viewport.name}`);
            failed++;
          }
        } catch (e) {
          console.log(`  [FAIL] Could not check main layout: ${e.message}`);
          failed++;
        }

        // Test 4: Check for horizontal overflow (layout issues)
        try {
          const hasOverflow = await evalJs(`
            document.body.scrollWidth > window.innerWidth
          `);

          if (hasOverflow === false || hasOverflow === 'false') {
            console.log(`  [PASS] No horizontal overflow at ${viewport.name}`);
            passed++;
          } else {
            console.log(`  [WARN] Horizontal overflow detected at ${viewport.name}`);
            // Don't fail - may be intentional for some layouts
          }
        } catch (e) {
          console.log(`  [INFO] Could not check overflow: ${e.message}`);
        }

        // Test 5: Mobile-specific - test menu toggle (if mobile)
        if (viewport.name === 'mobile') {
          console.log('\n  [Mobile Menu Toggle Test]');
          try {
            // Look for hamburger menu button
            await findRole('button', 'click', 'Menu');
            await new Promise(r => setTimeout(r, 300)); // Wait for animation

            const sidebarAfterToggle = await isVisible('sidebar-panel');
            if (sidebarAfterToggle) {
              console.log(`  [PASS] Sidebar opens after menu click on mobile`);
              passed++;

              // Capture screenshot with sidebar open
              await screenshot('test/e2e/screenshots/current/responsive-mobile-sidebar-open.png');
              console.log(`  [INFO] Mobile sidebar screenshot saved`);
            } else {
              console.log(`  [WARN] Sidebar did not open after menu click`);
            }
          } catch (e) {
            console.log(`  [INFO] Mobile menu toggle not tested: ${e.message}`);
          }
        }
      }

      // Summary
      console.log('\n========================================');
      console.log(`Responsive Test Complete: ${passed} passed, ${failed} failed`);
      console.log('========================================');

      return failed === 0;

    } catch (e) {
      console.error('\n[ERROR] Responsive test failed:', e.message);
      return false;

    } finally {
      // Cleanup
      try {
        await close();
      } catch {
        // Ignore close errors
      }
      await stopServer();
    }
  }

  // Run test
  runResponsiveTest()
    .then(success => process.exit(success ? 0 : 1))
    .catch(err => {
      console.error('Responsive test error:', err);
      process.exit(1);
    });
  ```

  From research and codebase:
  - Mobile breakpoint is 768px (from 07-04 decision)
  - Sidebar becomes fixed overlay with backdrop on mobile
  - CSS class toggle controls visibility (not inline display:none)
  </action>
  <verify>
  - File exists at test/e2e/responsive.js
  - No syntax errors: node --check test/e2e/responsive.js
  - Uses setViewport for viewport changes
  - Tests all 3 viewports: desktop (1920x1080), tablet (768x1024), mobile (375x667)
  </verify>
  <done>Responsive layout test created for desktop, tablet, and mobile viewports</done>
</task>

<task type="auto">
  <name>Task 2: Add results-dashboard visibility test</name>
  <files>test/e2e/responsive.js</files>
  <action>
  Enhance responsive test to verify results-dashboard visible at all viewports:

  Add after Test 3 (main layout check):

  ```javascript
  // Test 3b: Verify results-dashboard visible
  try {
    const dashboardVisible = await isVisible('results-dashboard');
    if (dashboardVisible) {
      console.log(`  [PASS] Results dashboard visible at ${viewport.name}`);
      passed++;
    } else {
      // On mobile, dashboard may require scroll
      if (viewport.name === 'mobile') {
        console.log(`  [WARN] Results dashboard not immediately visible on mobile (may need scroll)`);
      } else {
        console.log(`  [FAIL] Results dashboard not visible at ${viewport.name}`);
        failed++;
      }
    }
  } catch (e) {
    console.log(`  [INFO] Could not check results dashboard: ${e.message}`);
  }
  ```

  This verifies:
  1. Results dashboard is accessible at all viewport sizes
  2. Mobile users can access results (may require scroll)
  3. Layout doesn't hide critical content
  </action>
  <verify>
  - test/e2e/responsive.js includes results-dashboard visibility checks
  - No syntax errors after changes
  </verify>
  <done>Responsive test enhanced with results-dashboard visibility verification</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. test/e2e/responsive.js exists with 80+ lines
2. No syntax errors in responsive.js
3. Test captures screenshots at 3 viewport sizes
4. Test verifies sidebar visibility changes at mobile breakpoint
5. Test verifies main layout and results dashboard visible at each viewport
6. Test checks for horizontal overflow at each viewport
</verification>

<success_criteria>
1. Responsive test captures desktop (1920x1080), tablet (768x1024), mobile (375x667) screenshots
2. Sidebar hidden on mobile, visible on desktop/tablet
3. Mobile menu toggle opens sidebar overlay
4. Main layout visible at all viewports
5. No horizontal overflow at any viewport (warn if detected)
6. Screenshots saved to screenshots/current/ directory
</success_criteria>

<output>
After completion, create `.planning/phases/13-e2e-testing-agent-browser/13-04-SUMMARY.md`
</output>
