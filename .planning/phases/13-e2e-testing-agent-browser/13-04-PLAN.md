---
phase: 13-e2e-testing-agent-browser
plan: 04
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - test/e2e/responsive.js
autonomous: true

must_haves:
  truths:
    - "Responsive test captures screenshots at desktop, tablet, mobile viewports"
    - "Sidebar visibility changes correctly at mobile breakpoint"
    - "Layout adapts correctly at each viewport size"
    - "Screenshots stored for visual regression comparison"
  artifacts:
    - path: "test/e2e/responsive.js"
      provides: "Responsive layout tests at multiple viewports"
      min_lines: 60
  key_links:
    - from: "test/e2e/responsive.js"
      to: "test/e2e/helpers/run-test.js"
      via: "import setViewport"
      pattern: "setViewport"
---

<objective>
Create responsive layout tests that verify the app works at desktop, tablet, and mobile viewports.

Purpose: Ensure the app's responsive design works correctly across device sizes. The sidebar-panel behavior (visible on desktop, overlay on mobile) is critical UX.
Output: Responsive test capturing screenshots and verifying layout at 3 viewport sizes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/quick/004-research-agent-browser-integration/004-RESEARCH.md
@.planning/phases/13-e2e-testing-agent-browser/13-01-SUMMARY.md
@src/components/ui/main-layout.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create responsive layout test</name>
  <files>test/e2e/responsive.js</files>
  <action>
  Create responsive test that verifies layout at desktop, tablet, and mobile viewports:

  ```javascript
  // test/e2e/responsive.js
  import { startServer, stopServer, getBaseUrl } from './helpers/server.js';
  import {
    open, close, isVisible, screenshot, wait, setViewport, findRole
  } from './helpers/run-test.js';

  // Viewport configurations
  const VIEWPORTS = [
    { name: 'desktop', width: 1920, height: 1080 },
    { name: 'tablet', width: 768, height: 1024 },
    { name: 'mobile', width: 375, height: 667 },
  ];

  // Layout expectations by viewport
  const EXPECTATIONS = {
    desktop: {
      sidebarVisible: true,
      sidebarOverlay: false,
    },
    tablet: {
      sidebarVisible: true,  // Still visible at 768px
      sidebarOverlay: false,
    },
    mobile: {
      sidebarVisible: false, // Hidden by default on mobile (< 768px)
      sidebarOverlay: true,  // Becomes overlay when opened
    },
  };

  async function runResponsiveTest() {
    console.log('Starting responsive layout test...');
    let passed = 0;
    let failed = 0;

    try {
      await startServer();
      await open(getBaseUrl());
      await wait('main-layout');

      for (const viewport of VIEWPORTS) {
        console.log(`\n[${viewport.name.toUpperCase()}] Testing ${viewport.width}x${viewport.height}...`);

        // Set viewport
        await setViewport(viewport.width, viewport.height);

        // Wait for layout to adjust
        await new Promise(r => setTimeout(r, 500));

        // Capture screenshot
        const screenshotPath = `test/e2e/screenshots/current/responsive-${viewport.name}.png`;
        await screenshot(screenshotPath);
        console.log(`  [INFO] Screenshot saved: ${viewport.name}.png`);

        // Test sidebar visibility
        const expectation = EXPECTATIONS[viewport.name];

        try {
          const sidebarVisible = await isVisible('sidebar-panel');

          if (viewport.name === 'mobile') {
            // On mobile, sidebar should be hidden initially
            if (!sidebarVisible) {
              console.log('  [PASS] Sidebar hidden on mobile (expected)');
              passed++;
            } else {
              console.log('  [FAIL] Sidebar visible on mobile (should be hidden)');
              failed++;
            }

            // Test mobile menu toggle
            try {
              // Look for hamburger menu button
              await findRole('button', 'click', 'Menu');
              await new Promise(r => setTimeout(r, 300)); // Wait for animation

              const sidebarAfterToggle = await isVisible('sidebar-panel');
              if (sidebarAfterToggle) {
                console.log('  [PASS] Sidebar opens after menu click on mobile');
                passed++;
              } else {
                console.log('  [FAIL] Sidebar did not open after menu click');
                failed++;
              }

              // Screenshot with sidebar open
              await screenshot(`test/e2e/screenshots/current/responsive-mobile-sidebar-open.png`);
            } catch (e) {
              console.log(`  [WARN] Could not test mobile menu toggle: ${e.message}`);
            }

          } else {
            // On desktop/tablet, sidebar should be visible
            if (sidebarVisible === expectation.sidebarVisible) {
              console.log(`  [PASS] Sidebar visibility correct (${sidebarVisible})`);
              passed++;
            } else {
              console.log(`  [FAIL] Sidebar visibility: expected ${expectation.sidebarVisible}, got ${sidebarVisible}`);
              failed++;
            }
          }
        } catch (e) {
          console.log(`  [FAIL] Could not check sidebar: ${e.message}`);
          failed++;
        }

        // Verify main content area visible
        try {
          const mainVisible = await isVisible('main-layout');
          if (mainVisible) {
            console.log('  [PASS] Main layout visible');
            passed++;
          } else {
            console.log('  [FAIL] Main layout not visible');
            failed++;
          }
        } catch (e) {
          console.log(`  [FAIL] Could not check main layout: ${e.message}`);
          failed++;
        }
      }

      // Summary
      console.log(`\n========================================`);
      console.log(`Responsive Test Complete: ${passed} passed, ${failed} failed`);
      console.log(`========================================`);

      return failed === 0;

    } finally {
      await close();
      await stopServer();
    }
  }

  runResponsiveTest()
    .then(success => process.exit(success ? 0 : 1))
    .catch(err => {
      console.error('Responsive test error:', err);
      process.exit(1);
    });
  ```

  From research and codebase:
  - Mobile breakpoint is 768px (from 07-04 decision)
  - Sidebar becomes fixed overlay with backdrop on mobile
  - CSS class toggle controls visibility (not inline display:none)
  </action>
  <verify>
  - File exists at test/e2e/responsive.js
  - No syntax errors: node --check test/e2e/responsive.js
  </verify>
  <done>Responsive layout test created for desktop, tablet, and mobile viewports</done>
</task>

<task type="auto">
  <name>Task 2: Add content visibility tests at each viewport</name>
  <files>test/e2e/responsive.js</files>
  <action>
  Enhance responsive test to verify critical content is visible at each viewport:

  Add after sidebar checks in the viewport loop:

  ```javascript
  // Verify critical content is visible
  const CRITICAL_CONTENT = [
    { element: 'results-dashboard', description: 'Results dashboard' },
    { element: 'param-section', description: 'Parameter sections' },
  ];

  console.log(`  Checking critical content at ${viewport.name}...`);
  for (const { element, description } of CRITICAL_CONTENT) {
    try {
      const visible = await isVisible(element);
      if (visible) {
        console.log(`    [PASS] ${description} visible`);
        passed++;
      } else {
        // On mobile, some content may be scrolled out of view
        if (viewport.name === 'mobile') {
          console.log(`    [WARN] ${description} not visible (may need scroll)`);
        } else {
          console.log(`    [FAIL] ${description} not visible`);
          failed++;
        }
      }
    } catch (e) {
      console.log(`    [WARN] Could not check ${description}: ${e.message}`);
    }
  }

  // Verify no layout overflow (horizontal scroll)
  try {
    const hasOverflow = await evalJs(`
      const body = document.body;
      return body.scrollWidth > window.innerWidth;
    `);
    if (!hasOverflow) {
      console.log('  [PASS] No horizontal overflow');
      passed++;
    } else {
      console.log('  [WARN] Horizontal overflow detected');
      // Don't fail - may be intentional for charts
    }
  } catch (e) {
    // Skip overflow check if eval fails
  }
  ```

  This verifies:
  1. Results dashboard is accessible at all viewport sizes
  2. Parameter sections are visible (may need sidebar open on mobile)
  3. No unintended horizontal scroll (layout issues)
  </action>
  <verify>
  - test/e2e/responsive.js includes content visibility checks
  - No syntax errors after changes
  </verify>
  <done>Responsive test enhanced with content visibility verification</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. test/e2e/responsive.js exists with 60+ lines
2. No syntax errors in responsive.js
3. Test captures screenshots at 3 viewport sizes
4. Test verifies sidebar visibility changes at mobile breakpoint
5. Test verifies critical content visible at each viewport
</verification>

<success_criteria>
1. Responsive test captures desktop (1920x1080), tablet (768x1024), mobile (375x667) screenshots
2. Sidebar hidden on mobile, visible on desktop/tablet
3. Mobile menu toggle opens sidebar overlay
4. Main layout visible at all viewports
5. Screenshots saved to screenshots/current/ directory
</success_criteria>

<output>
After completion, create `.planning/phases/13-e2e-testing-agent-browser/13-04-SUMMARY.md`
</output>
