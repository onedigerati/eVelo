---
phase: 13-e2e-testing-agent-browser
plan: 03
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - test/e2e/workflow.js
autonomous: true

must_haves:
  truths:
    - "Workflow test sets simulation parameters via semantic locators"
    - "Workflow test triggers simulation run via button click"
    - "Workflow test verifies results appear in dashboard"
    - "Test captures pre/post simulation screenshots"
  artifacts:
    - path: "test/e2e/workflow.js"
      provides: "End-to-end simulation workflow test"
      min_lines: 100
  key_links:
    - from: "test/e2e/workflow.js"
      to: "test/e2e/helpers/agent-browser.js"
      via: "import"
      pattern: "import.*agent-browser"
    - from: "test/e2e/workflow.js"
      to: "Run Simulation button"
      via: "findRole button click"
      pattern: "findRole.*button"
---

<objective>
Create end-to-end simulation workflow test that verifies the complete params -> run -> results flow.

Purpose: Validate the core user journey - configuring parameters, running simulation, and viewing results. This is the highest-value E2E test for eVelo.
Output: Workflow test that exercises the full simulation lifecycle.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/13-e2e-testing-agent-browser/13-RESEARCH.md
@.planning/phases/13-e2e-testing-agent-browser/13-01-SUMMARY.md
@src/components/app-root.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create simulation workflow test</name>
  <files>test/e2e/workflow.js</files>
  <action>
  Create workflow test that exercises the complete simulation lifecycle:

  ```javascript
  // test/e2e/workflow.js
  // End-to-end simulation workflow test
  import { startServer, stopServer, getBaseUrl } from './helpers/server.js';
  import {
    open, close, isVisible, snapshot, screenshot, wait,
    findRole, findLabel, evalJs
  } from './helpers/agent-browser.js';

  // Test parameters (known good values)
  const TEST_PARAMS = {
    initialPortfolio: '1000000',
    timeHorizon: '30',
    annualWithdrawal: '50000',
  };

  async function runWorkflowTest() {
    console.log('========================================');
    console.log('eVelo Simulation Workflow Test');
    console.log('========================================\n');

    let passed = 0;
    let failed = 0;

    try {
      // Start server
      await startServer();

      // Open application
      await open(getBaseUrl());
      await wait('main-layout', { timeout: 10000 });

      // Phase 1: Set simulation parameters
      console.log('[Phase 1] Setting Simulation Parameters\n');

      // Screenshot before changes
      await screenshot('test/e2e/screenshots/current/workflow-01-initial.png');
      console.log('  [INFO] Initial screenshot captured');

      // Set Initial Portfolio value
      try {
        await findLabel('Initial Portfolio', 'fill', TEST_PARAMS.initialPortfolio);
        console.log(`  [PASS] Set Initial Portfolio to $${TEST_PARAMS.initialPortfolio}`);
        passed++;
      } catch (e) {
        console.log(`  [FAIL] Could not set Initial Portfolio: ${e.message}`);
        failed++;
      }

      // Set Time Horizon (range slider)
      try {
        await findLabel('Time Horizon', 'fill', TEST_PARAMS.timeHorizon);
        console.log(`  [PASS] Set Time Horizon to ${TEST_PARAMS.timeHorizon} years`);
        passed++;
      } catch (e) {
        console.log(`  [WARN] Could not set Time Horizon: ${e.message}`);
        // Don't fail - may use default
      }

      // Set Annual Withdrawal (if visible)
      try {
        await findLabel('Annual Withdrawal', 'fill', TEST_PARAMS.annualWithdrawal);
        console.log(`  [PASS] Set Annual Withdrawal to $${TEST_PARAMS.annualWithdrawal}`);
        passed++;
      } catch (e) {
        console.log(`  [INFO] Annual Withdrawal input not directly accessible`);
        // May be in SBLOC section
      }

      await screenshot('test/e2e/screenshots/current/workflow-02-params-set.png');
      console.log('  [INFO] Parameters screenshot captured');

      // Phase 2: Run simulation
      console.log('\n[Phase 2] Running Simulation\n');

      try {
        // Find and click the Run Simulation button
        await findRole('button', 'click', 'Run');
        console.log('  [PASS] Clicked Run Simulation button');
        passed++;
      } catch (e) {
        console.log(`  [FAIL] Could not click Run Simulation: ${e.message}`);
        failed++;
        throw new Error('Cannot continue without running simulation');
      }

      // Wait for simulation to complete (look for results)
      console.log('  [INFO] Waiting for simulation to complete...');

      try {
        // Wait for key-metrics-banner to appear (indicates results ready)
        await wait('key-metrics-banner', { timeout: 60000 });
        console.log('  [PASS] Simulation completed - results visible');
        passed++;
      } catch (e) {
        console.log(`  [FAIL] Simulation did not complete in time: ${e.message}`);
        failed++;
      }

      await screenshot('test/e2e/screenshots/current/workflow-03-results.png');
      console.log('  [INFO] Results screenshot captured');

      // Phase 3: Verify results
      console.log('\n[Phase 3] Verifying Results\n');

      // Check for key result components
      const RESULT_COMPONENTS = [
        { element: 'probability-cone-chart', description: 'Probability cone chart' },
        { element: 'histogram-chart', description: 'Histogram chart' },
        { element: 'percentile-spectrum', description: 'Percentile spectrum' },
      ];

      for (const { element, description } of RESULT_COMPONENTS) {
        try {
          const visible = await isVisible(element);
          if (visible) {
            console.log(`  [PASS] ${description} visible`);
            passed++;
          } else {
            console.log(`  [FAIL] ${description} not visible`);
            failed++;
          }
        } catch (e) {
          console.log(`  [FAIL] ${description}: ${e.message}`);
          failed++;
        }
      }

      // Verify probability cone chart has data via eval
      console.log('\n[Phase 4] Verifying Chart Data\n');

      try {
        const hasData = await evalJs(`
          const chart = document.querySelector('probability-cone-chart');
          if (chart && chart.shadowRoot) {
            const canvas = chart.shadowRoot.querySelector('canvas');
            if (canvas && canvas.chart) {
              return canvas.chart.data.datasets.length > 0;
            }
          }
          return false;
        `);

        if (hasData === true || hasData === 'true') {
          console.log('  [PASS] Probability cone chart has data');
          passed++;
        } else {
          console.log('  [WARN] Could not verify chart data (may be rendering issue)');
        }
      } catch (e) {
        console.log(`  [INFO] Chart data verification skipped: ${e.message}`);
      }

      // Summary
      console.log('\n========================================');
      console.log(`Workflow Test Complete: ${passed} passed, ${failed} failed`);
      console.log('========================================');

      return failed === 0;

    } catch (e) {
      console.error('\n[ERROR] Workflow test failed:', e.message);
      return false;

    } finally {
      // Cleanup
      try {
        await close();
      } catch {
        // Ignore close errors
      }
      await stopServer();
    }
  }

  // Run test
  runWorkflowTest()
    .then(success => process.exit(success ? 0 : 1))
    .catch(err => {
      console.error('Workflow test error:', err);
      process.exit(1);
    });
  ```

  Key aspects from research:
  - Use findLabel for form inputs (semantic locators pierce Shadow DOM)
  - Use findRole for button clicks
  - Use evalJs to verify Chart.js data (canvas not in a11y tree)
  - Use wait with timeout for simulation completion
  - 60 second timeout for simulation (may be slow on first run)
  </action>
  <verify>
  - File exists at test/e2e/workflow.js
  - No syntax errors: node --check test/e2e/workflow.js
  - Imports from ./helpers/agent-browser.js
  - Uses findLabel and findRole for interactions
  </verify>
  <done>Workflow test created that exercises complete simulation lifecycle</done>
</task>

<task type="auto">
  <name>Task 2: Add form value verification</name>
  <files>test/e2e/workflow.js</files>
  <action>
  Enhance workflow test to verify form values were set correctly:

  Add after Phase 1 parameter setting:

  ```javascript
  // Phase 1b: Verify form values via accessibility tree
  console.log('\n[Phase 1b] Verifying Form Values\n');

  try {
    const tree = await snapshot({ interactive: true });

    // Check that our values appear in the accessibility tree
    // This confirms the inputs accepted our values
    if (tree.includes(TEST_PARAMS.initialPortfolio) ||
        tree.includes('1,000,000') ||
        tree.includes('1000000')) {
      console.log('  [PASS] Initial Portfolio value reflected in UI');
      passed++;
    } else {
      console.log('  [WARN] Could not verify Initial Portfolio in accessibility tree');
    }

    // Check for slider/spinbutton with time horizon value
    if (tree.includes(TEST_PARAMS.timeHorizon)) {
      console.log('  [PASS] Time Horizon value reflected in UI');
      passed++;
    } else {
      console.log('  [WARN] Could not verify Time Horizon in accessibility tree');
    }

  } catch (e) {
    console.log(`  [INFO] Form value verification skipped: ${e.message}`);
  }
  ```

  This verifies that:
  1. Form inputs accept values via semantic locators
  2. Values are reflected in the UI (displayed to user)
  3. Custom events (composed: true) cross Shadow DOM boundary
  </action>
  <verify>
  - test/e2e/workflow.js includes form value verification
  - No syntax errors after changes
  </verify>
  <done>Workflow test enhanced with form value verification</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. test/e2e/workflow.js exists with 100+ lines
2. No syntax errors in workflow.js
3. Test sets parameters, runs simulation, verifies results
4. Test captures screenshots at each phase (initial, params-set, results)
5. Test uses semantic locators for Shadow DOM interaction
6. Test verifies chart data via evalJs
</verification>

<success_criteria>
1. Workflow test sets Initial Portfolio, Time Horizon via semantic locators
2. Workflow test clicks Run Simulation button via findRole
3. Workflow test waits for simulation completion (60s timeout)
4. Workflow test verifies probability-cone-chart, histogram-chart visible
5. Workflow test captures 3 screenshots (initial, params-set, results)
6. Test exits 0 on success, non-zero on failure
</success_criteria>

<output>
After completion, create `.planning/phases/13-e2e-testing-agent-browser/13-03-SUMMARY.md`
</output>
