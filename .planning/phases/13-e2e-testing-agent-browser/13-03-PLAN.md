---
phase: 13-e2e-testing-agent-browser
plan: 03
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - test/e2e/workflow.js
autonomous: true

must_haves:
  truths:
    - "Workflow test sets simulation parameters via form inputs"
    - "Workflow test triggers simulation run"
    - "Workflow test verifies results appear in dashboard"
    - "Test captures pre/post simulation screenshots"
  artifacts:
    - path: "test/e2e/workflow.js"
      provides: "End-to-end simulation workflow test"
      min_lines: 80
  key_links:
    - from: "test/e2e/workflow.js"
      to: "test/e2e/helpers/run-test.js"
      via: "import"
      pattern: "import.*run-test"
    - from: "test/e2e/workflow.js"
      to: "Run Simulation button"
      via: "findRole button click"
      pattern: "findRole.*button.*Run Simulation"
---

<objective>
Create end-to-end simulation workflow test that verifies the complete params -> run -> results flow.

Purpose: Validate the core user journey - configuring parameters, running simulation, and viewing results. This is the highest-value E2E test for eVelo.
Output: Workflow test that exercises the full simulation lifecycle.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/quick/004-research-agent-browser-integration/004-RESEARCH.md
@.planning/phases/13-e2e-testing-agent-browser/13-01-SUMMARY.md
@src/components/app-root.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create simulation workflow test</name>
  <files>test/e2e/workflow.js</files>
  <action>
  Create workflow test that exercises the complete simulation lifecycle:

  ```javascript
  // test/e2e/workflow.js
  import { startServer, stopServer, getBaseUrl } from './helpers/server.js';
  import {
    open, close, isVisible, snapshot, screenshot, wait,
    findRole, findLabel, evalJs
  } from './helpers/run-test.js';

  // Test parameters (known good values)
  const TEST_PARAMS = {
    initialPortfolio: 1000000,
    timeHorizon: 30,
    annualWithdrawal: 50000,
    iterations: 1000  // Lower for faster test
  };

  async function runWorkflowTest() {
    console.log('Starting simulation workflow test...');
    let passed = 0;
    let failed = 0;

    try {
      await startServer();
      await open(getBaseUrl());
      await wait('main-layout');

      // Phase 1: Set simulation parameters
      console.log('\n[Phase 1] Setting simulation parameters...');

      // Screenshot before changes
      await screenshot('test/e2e/screenshots/current/workflow-01-initial.png');

      // Set Initial Portfolio value
      try {
        await findLabel('Initial Portfolio', 'fill', String(TEST_PARAMS.initialPortfolio));
        console.log(`  [PASS] Set Initial Portfolio to ${TEST_PARAMS.initialPortfolio}`);
        passed++;
      } catch (e) {
        console.log(`  [FAIL] Could not set Initial Portfolio: ${e.message}`);
        failed++;
      }

      // Set Time Horizon (range slider)
      try {
        await findLabel('Time Horizon', 'fill', String(TEST_PARAMS.timeHorizon));
        console.log(`  [PASS] Set Time Horizon to ${TEST_PARAMS.timeHorizon}`);
        passed++;
      } catch (e) {
        console.log(`  [FAIL] Could not set Time Horizon: ${e.message}`);
        failed++;
      }

      // Set Annual Withdrawal
      try {
        await findLabel('Annual Withdrawal', 'fill', String(TEST_PARAMS.annualWithdrawal));
        console.log(`  [PASS] Set Annual Withdrawal to ${TEST_PARAMS.annualWithdrawal}`);
        passed++;
      } catch (e) {
        // May be in SBLOC section - don't fail
        console.log(`  [WARN] Could not set Annual Withdrawal: ${e.message}`);
      }

      await screenshot('test/e2e/screenshots/current/workflow-02-params-set.png');

      // Phase 2: Run simulation
      console.log('\n[Phase 2] Running simulation...');

      try {
        await findRole('button', 'click', 'Run Simulation');
        console.log('  [PASS] Clicked Run Simulation button');
        passed++;
      } catch (e) {
        console.log(`  [FAIL] Could not click Run Simulation: ${e.message}`);
        failed++;
        throw new Error('Cannot continue without running simulation');
      }

      // Wait for simulation to complete (look for results)
      console.log('  Waiting for simulation to complete...');
      try {
        // Wait for results-dashboard to have content or specific result element
        await wait('key-metrics-banner', { timeout: 60000 }); // 60s timeout
        console.log('  [PASS] Simulation completed - results visible');
        passed++;
      } catch (e) {
        console.log(`  [FAIL] Simulation did not complete: ${e.message}`);
        failed++;
      }

      await screenshot('test/e2e/screenshots/current/workflow-03-results.png');

      // Phase 3: Verify results
      console.log('\n[Phase 3] Verifying results...');

      // Check for key result components
      const RESULT_COMPONENTS = [
        { element: 'probability-cone-chart', description: 'Probability cone chart' },
        { element: 'histogram-chart', description: 'Histogram chart' },
        { element: 'percentile-spectrum', description: 'Percentile spectrum' },
      ];

      for (const { element, description } of RESULT_COMPONENTS) {
        try {
          const visible = await isVisible(element);
          if (visible) {
            console.log(`  [PASS] ${description} visible`);
            passed++;
          } else {
            console.log(`  [FAIL] ${description} not visible`);
            failed++;
          }
        } catch (e) {
          console.log(`  [FAIL] ${description}: ${e.message}`);
          failed++;
        }
      }

      // Verify charts have data via eval
      try {
        const chartData = await evalJs(`
          const chart = document.querySelector('probability-cone-chart');
          if (chart && chart.shadowRoot) {
            const canvas = chart.shadowRoot.querySelector('canvas');
            if (canvas && canvas.chart) {
              return canvas.chart.data.datasets.length > 0;
            }
          }
          return false;
        `);
        if (chartData) {
          console.log('  [PASS] Probability cone chart has data');
          passed++;
        } else {
          console.log('  [FAIL] Probability cone chart missing data');
          failed++;
        }
      } catch (e) {
        console.log(`  [WARN] Could not verify chart data: ${e.message}`);
      }

      // Summary
      console.log(`\n========================================`);
      console.log(`Workflow Test Complete: ${passed} passed, ${failed} failed`);
      console.log(`========================================`);

      return failed === 0;

    } finally {
      await close();
      await stopServer();
    }
  }

  runWorkflowTest()
    .then(success => process.exit(success ? 0 : 1))
    .catch(err => {
      console.error('Workflow test error:', err);
      process.exit(1);
    });
  ```

  Key aspects from research:
  - Use findLabel for form inputs (semantic locators pierce Shadow DOM)
  - Use findRole for button clicks
  - Use evalJs to verify Chart.js data (canvas not in a11y tree)
  - Use wait with timeout for simulation completion
  </action>
  <verify>
  - File exists at test/e2e/workflow.js
  - No syntax errors: node --check test/e2e/workflow.js
  </verify>
  <done>Workflow test created that exercises complete simulation lifecycle</done>
</task>

<task type="auto">
  <name>Task 2: Add form interaction verification</name>
  <files>test/e2e/workflow.js</files>
  <action>
  Enhance workflow test to verify form interactions respond correctly:

  Add after Phase 1 parameter setting:

  ```javascript
  // Phase 1b: Verify form interactions
  console.log('\n[Phase 1b] Verifying form interactions...');

  // Verify range slider value updated
  try {
    const tree = await snapshot({ interactive: true });

    // Check that slider shows updated value
    // Range sliders in eVelo display value in a span
    const hasSliderValue = tree.includes(String(TEST_PARAMS.timeHorizon));
    if (hasSliderValue) {
      console.log('  [PASS] Time Horizon value reflected in UI');
      passed++;
    } else {
      console.log('  [WARN] Time Horizon value not visible in accessibility tree');
    }
  } catch (e) {
    console.log(`  [INFO] Could not verify slider value: ${e.message}`);
  }

  // Test select-input interaction (if exists)
  try {
    // CORS proxy selector in settings, or other dropdowns
    await findRole('combobox', 'focus');
    console.log('  [PASS] Found combobox (select-input) accessible');
    passed++;
  } catch (e) {
    console.log('  [INFO] No combobox found in current view');
  }

  // Test checkbox (if visible)
  try {
    const hasCheckbox = await snapshot({ interactive: true });
    if (hasCheckbox.includes('checkbox')) {
      console.log('  [PASS] Checkbox accessible in tree');
      passed++;
    }
  } catch (e) {
    // Checkboxes may not be visible in default view
  }
  ```

  This verifies that:
  1. Range slider values update and display correctly
  2. Number inputs accept values
  3. Form state is reflected in the UI
  4. Custom events (composed: true) cross Shadow DOM boundary
  </action>
  <verify>
  - test/e2e/workflow.js includes form interaction verification
  - No syntax errors after changes
  </verify>
  <done>Workflow test enhanced with form interaction verification</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. test/e2e/workflow.js exists with 80+ lines
2. No syntax errors in workflow.js
3. Test sets parameters, runs simulation, verifies results
4. Test captures screenshots at each phase
5. Test uses semantic locators for Shadow DOM interaction
</verification>

<success_criteria>
1. Workflow test sets Initial Portfolio, Time Horizon via semantic locators
2. Workflow test clicks Run Simulation button
3. Workflow test waits for and verifies results appear
4. Workflow test verifies probability-cone-chart, histogram-chart visible
5. Workflow test captures 3 screenshots (initial, params-set, results)
</success_criteria>

<output>
After completion, create `.planning/phases/13-e2e-testing-agent-browser/13-03-SUMMARY.md`
</output>
