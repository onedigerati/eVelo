---
phase: 13-e2e-testing-agent-browser
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - test/e2e/smoke.js
autonomous: true

must_haves:
  truths:
    - "Smoke test verifies all major components render"
    - "Form inputs are accessible via semantic locators"
    - "Test captures screenshot of initial state"
    - "Test exits with code 0 on success, non-zero on failure"
  artifacts:
    - path: "test/e2e/smoke.js"
      provides: "Component rendering smoke test"
      min_lines: 50
  key_links:
    - from: "test/e2e/smoke.js"
      to: "test/e2e/helpers/run-test.js"
      via: "import"
      pattern: "import.*run-test"
    - from: "test/e2e/smoke.js"
      to: "test/e2e/helpers/server.js"
      via: "import"
      pattern: "import.*server"
---

<objective>
Create smoke test that verifies all major UI components render correctly.

Purpose: Establish baseline verification that app loads and all components are accessible - catches regressions in component registration, Shadow DOM setup, and basic rendering.
Output: Executable smoke test that validates component rendering on every run.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/quick/004-research-agent-browser-integration/004-RESEARCH.md
@.planning/phases/13-e2e-testing-agent-browser/13-01-SUMMARY.md
@src/components/ui/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create smoke test for component rendering</name>
  <files>test/e2e/smoke.js</files>
  <action>
  Create smoke test that verifies all major components render:

  ```javascript
  // test/e2e/smoke.js
  import { startServer, stopServer, getBaseUrl } from './helpers/server.js';
  import {
    open, close, isVisible, snapshot, screenshot, wait
  } from './helpers/run-test.js';

  const COMPONENTS_TO_TEST = [
    // Layout components
    { element: 'main-layout', description: 'Main layout container' },
    { element: 'sidebar-panel', description: 'Sidebar panel' },
    { element: 'results-dashboard', description: 'Results dashboard' },

    // Form inputs (verify accessible via snapshot)
    // These should appear in accessibility tree

    // Dashboard sections
    { element: 'key-metrics-banner', description: 'Key metrics banner' },
  ];

  async function runSmokeTest() {
    console.log('Starting smoke test...');
    let passed = 0;
    let failed = 0;

    try {
      await startServer();
      await open(getBaseUrl());
      await wait('main-layout');

      // Test 1: Verify layout components visible
      for (const { element, description } of COMPONENTS_TO_TEST) {
        try {
          const visible = await isVisible(element);
          if (visible) {
            console.log(`  [PASS] ${description} (${element})`);
            passed++;
          } else {
            console.log(`  [FAIL] ${description} (${element}) - not visible`);
            failed++;
          }
        } catch (e) {
          console.log(`  [FAIL] ${description} (${element}) - ${e.message}`);
          failed++;
        }
      }

      // Test 2: Verify form inputs in accessibility tree
      console.log('\nChecking accessibility tree for form inputs...');
      const tree = await snapshot({ interactive: true });

      const EXPECTED_ROLES = ['slider', 'spinbutton', 'combobox', 'button'];
      for (const role of EXPECTED_ROLES) {
        if (tree.includes(role)) {
          console.log(`  [PASS] Found ${role} role in accessibility tree`);
          passed++;
        } else {
          console.log(`  [FAIL] Missing ${role} role in accessibility tree`);
          failed++;
        }
      }

      // Test 3: Capture baseline screenshot
      await screenshot('test/e2e/screenshots/current/smoke-initial.png');
      console.log('\n  [INFO] Screenshot saved to smoke-initial.png');

      // Summary
      console.log(`\n========================================`);
      console.log(`Smoke Test Complete: ${passed} passed, ${failed} failed`);
      console.log(`========================================`);

      return failed === 0;

    } finally {
      await close();
      await stopServer();
    }
  }

  runSmokeTest()
    .then(success => process.exit(success ? 0 : 1))
    .catch(err => {
      console.error('Smoke test error:', err);
      process.exit(1);
    });
  ```

  Components to verify (from codebase):
  - main-layout, sidebar-panel, results-dashboard (layout)
  - param-section (collapsible sections)
  - range-slider, number-input, select-input (form inputs via a11y tree)
  - key-metrics-banner (results section)

  Use isVisible for custom elements, snapshot for accessibility tree verification.
  </action>
  <verify>
  - File exists at test/e2e/smoke.js
  - No syntax errors: node --check test/e2e/smoke.js
  - npm run test:e2e:smoke executes (may fail if agent-browser not installed globally)
  </verify>
  <done>Smoke test created that verifies component rendering and accessibility tree</done>
</task>

<task type="auto">
  <name>Task 2: Add detailed form input accessibility tests</name>
  <files>test/e2e/smoke.js</files>
  <action>
  Enhance smoke test to verify specific form inputs are accessible with correct ARIA roles and labels:

  Add to smoke.js after basic visibility checks:

  ```javascript
  // Test 4: Verify specific form inputs by label
  console.log('\nChecking form inputs by label...');

  const FORM_INPUTS = [
    { label: 'Initial Portfolio', expectedRole: 'spinbutton' },
    { label: 'Time Horizon', expectedRole: 'slider' },
    { label: 'Simulation Iterations', expectedRole: 'slider' },
    // Add more based on actual labels in sidebar
  ];

  // Note: agent-browser uses semantic locators
  // This verifies inputs are accessible to assistive technology

  for (const { label, expectedRole } of FORM_INPUTS) {
    try {
      // Try to find the input by label
      // If found in tree with correct role, it's accessible
      const treeContainsLabel = tree.toLowerCase().includes(label.toLowerCase());
      if (treeContainsLabel) {
        console.log(`  [PASS] Found "${label}" in accessibility tree`);
        passed++;
      } else {
        console.log(`  [WARN] "${label}" not found in accessibility tree`);
        // Don't fail - may be collapsed section
      }
    } catch (e) {
      console.log(`  [INFO] Could not verify "${label}": ${e.message}`);
    }
  }
  ```

  The key insight from research: agent-browser uses Playwright's ariaSnapshot() which includes elements in open Shadow DOM. This test verifies:
  1. Web Components are registered (customElements.define called)
  2. Shadow DOM is in 'open' mode (accessible to automation)
  3. Internal inputs have proper ARIA roles
  4. Labels are associated correctly
  </action>
  <verify>
  - test/e2e/smoke.js includes form input checks
  - No syntax errors after changes
  </verify>
  <done>Smoke test enhanced with detailed form input accessibility verification</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. test/e2e/smoke.js exists with 50+ lines
2. No syntax errors in smoke.js
3. Test checks layout components, accessibility tree, and form inputs
4. Test captures screenshot to screenshots/current/
5. Test exits with appropriate exit code
</verification>

<success_criteria>
1. Smoke test verifies main-layout, sidebar-panel, results-dashboard visible
2. Smoke test verifies slider, spinbutton, combobox, button roles in accessibility tree
3. Smoke test captures initial screenshot
4. Test script uses helpers from 13-01
5. Test exits 0 on success, non-zero on failure
</success_criteria>

<output>
After completion, create `.planning/phases/13-e2e-testing-agent-browser/13-02-SUMMARY.md`
</output>
