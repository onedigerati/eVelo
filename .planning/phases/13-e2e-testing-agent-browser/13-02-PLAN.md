---
phase: 13-e2e-testing-agent-browser
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - test/e2e/smoke.js
autonomous: true

must_haves:
  truths:
    - "Smoke test verifies all major components render"
    - "Form inputs are accessible via semantic locators in accessibility tree"
    - "Test captures screenshot of initial state"
    - "Test exits with code 0 on success, non-zero on failure"
  artifacts:
    - path: "test/e2e/smoke.js"
      provides: "Component rendering smoke test"
      min_lines: 80
  key_links:
    - from: "test/e2e/smoke.js"
      to: "test/e2e/helpers/agent-browser.js"
      via: "import"
      pattern: "import.*agent-browser"
    - from: "test/e2e/smoke.js"
      to: "test/e2e/helpers/server.js"
      via: "import"
      pattern: "import.*server"
---

<objective>
Create smoke test that verifies all major UI components render correctly.

Purpose: Establish baseline verification that app loads and all components are accessible - catches regressions in component registration, Shadow DOM setup, and basic rendering.
Output: Executable smoke test that validates component rendering on every run.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/13-e2e-testing-agent-browser/13-RESEARCH.md
@.planning/phases/13-e2e-testing-agent-browser/13-01-SUMMARY.md
@src/components/ui/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create smoke test for component rendering</name>
  <files>test/e2e/smoke.js</files>
  <action>
  Create smoke test that verifies all major components render:

  ```javascript
  // test/e2e/smoke.js
  // Smoke test - verifies all major components render correctly
  import { startServer, stopServer, getBaseUrl } from './helpers/server.js';
  import {
    open, close, isVisible, snapshot, screenshot, wait
  } from './helpers/agent-browser.js';

  // Components to verify visibility
  const LAYOUT_COMPONENTS = [
    { element: 'main-layout', description: 'Main layout container' },
    { element: 'sidebar-panel', description: 'Sidebar panel' },
    { element: 'results-dashboard', description: 'Results dashboard' },
  ];

  // Expected ARIA roles in accessibility tree
  const EXPECTED_ROLES = ['slider', 'spinbutton', 'button'];

  // Form labels expected in accessibility tree
  const FORM_LABELS = [
    'Initial Portfolio',
    'Time Horizon',
    'Iterations'
  ];

  async function runSmokeTest() {
    console.log('========================================');
    console.log('eVelo Smoke Test');
    console.log('========================================\n');

    let passed = 0;
    let failed = 0;

    try {
      // Start server
      await startServer();

      // Open application
      await open(getBaseUrl());
      await wait('main-layout', { timeout: 10000 });

      // Test 1: Verify layout components visible
      console.log('[Test 1] Layout Components\n');

      for (const { element, description } of LAYOUT_COMPONENTS) {
        try {
          const visible = await isVisible(element);
          if (visible) {
            console.log(`  [PASS] ${description} (${element})`);
            passed++;
          } else {
            console.log(`  [FAIL] ${description} (${element}) - not visible`);
            failed++;
          }
        } catch (e) {
          console.log(`  [FAIL] ${description} (${element}) - ${e.message}`);
          failed++;
        }
      }

      // Test 2: Verify form inputs in accessibility tree
      console.log('\n[Test 2] Accessibility Tree - ARIA Roles\n');

      const tree = await snapshot({ interactive: true });

      for (const role of EXPECTED_ROLES) {
        if (tree.toLowerCase().includes(role)) {
          console.log(`  [PASS] Found "${role}" role in accessibility tree`);
          passed++;
        } else {
          console.log(`  [FAIL] Missing "${role}" role in accessibility tree`);
          failed++;
        }
      }

      // Test 3: Verify form labels accessible
      console.log('\n[Test 3] Accessibility Tree - Form Labels\n');

      for (const label of FORM_LABELS) {
        if (tree.toLowerCase().includes(label.toLowerCase())) {
          console.log(`  [PASS] Found "${label}" in accessibility tree`);
          passed++;
        } else {
          console.log(`  [WARN] "${label}" not found - may be in collapsed section`);
          // Don't fail - sections may be collapsed
        }
      }

      // Test 4: Capture initial screenshot
      console.log('\n[Test 4] Screenshot Capture\n');

      try {
        await screenshot('test/e2e/screenshots/current/smoke-initial.png');
        console.log('  [PASS] Screenshot saved to smoke-initial.png');
        passed++;
      } catch (e) {
        console.log(`  [FAIL] Screenshot failed: ${e.message}`);
        failed++;
      }

      // Test 5: Verify Run Simulation button exists
      console.log('\n[Test 5] Run Simulation Button\n');

      if (tree.toLowerCase().includes('run') && tree.toLowerCase().includes('simulation')) {
        console.log('  [PASS] Run Simulation button found in accessibility tree');
        passed++;
      } else if (tree.toLowerCase().includes('button')) {
        console.log('  [WARN] Button found but "Run Simulation" text not detected');
      } else {
        console.log('  [FAIL] No button found in accessibility tree');
        failed++;
      }

      // Summary
      console.log('\n========================================');
      console.log(`Smoke Test Complete: ${passed} passed, ${failed} failed`);
      console.log('========================================');

      return failed === 0;

    } catch (e) {
      console.error('\n[ERROR] Smoke test failed:', e.message);
      return false;

    } finally {
      // Cleanup
      try {
        await close();
      } catch {
        // Ignore close errors
      }
      await stopServer();
    }
  }

  // Run test
  runSmokeTest()
    .then(success => process.exit(success ? 0 : 1))
    .catch(err => {
      console.error('Smoke test error:', err);
      process.exit(1);
    });
  ```

  Components to verify (from codebase):
  - main-layout, sidebar-panel, results-dashboard (layout)
  - range-slider, number-input (form inputs via a11y tree)
  - Run Simulation button

  Key patterns from research:
  - Use isVisible for custom elements
  - Use snapshot for accessibility tree verification
  - Semantic locators pierce Shadow DOM (mode: 'open')
  </action>
  <verify>
  - File exists at test/e2e/smoke.js
  - No syntax errors: node --check test/e2e/smoke.js
  - Imports from ./helpers/agent-browser.js (not run-test.js)
  - Imports from ./helpers/server.js
  </verify>
  <done>Smoke test created that verifies component rendering and accessibility tree</done>
</task>

<task type="auto">
  <name>Task 2: Add param-section visibility tests</name>
  <files>test/e2e/smoke.js</files>
  <action>
  Enhance smoke test to verify param-section components render:

  Add after Test 1 (Layout Components):

  ```javascript
  // Test 1b: Verify param-sections exist
  console.log('\n[Test 1b] Parameter Sections\n');

  const PARAM_SECTIONS = [
    'param-section'  // At least one should be visible
  ];

  for (const element of PARAM_SECTIONS) {
    try {
      const visible = await isVisible(element);
      if (visible) {
        console.log(`  [PASS] ${element} component found`);
        passed++;
      } else {
        console.log(`  [WARN] ${element} not immediately visible`);
      }
    } catch (e) {
      console.log(`  [INFO] Could not verify ${element}: ${e.message}`);
    }
  }
  ```

  This verifies:
  1. param-section Web Components are registered (customElements.define called)
  2. Shadow DOM is in 'open' mode (accessible to automation)
  3. Collapsible sections render (may be expanded or collapsed)
  </action>
  <verify>
  - test/e2e/smoke.js includes param-section checks
  - No syntax errors after changes
  </verify>
  <done>Smoke test enhanced with param-section visibility verification</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. test/e2e/smoke.js exists with 80+ lines
2. No syntax errors in smoke.js
3. Test checks layout components, accessibility tree, form inputs
4. Test captures screenshot to screenshots/current/
5. Test exits with appropriate exit code
6. Uses helpers from ./helpers/agent-browser.js and ./helpers/server.js
</verification>

<success_criteria>
1. Smoke test verifies main-layout, sidebar-panel, results-dashboard visible
2. Smoke test verifies slider, spinbutton, button roles in accessibility tree
3. Smoke test verifies form labels accessible (with warnings for collapsed sections)
4. Smoke test captures initial screenshot
5. Test script uses helpers from 13-01 (agent-browser.js, server.js)
6. Test exits 0 on success, non-zero on failure
</success_criteria>

<output>
After completion, create `.planning/phases/13-e2e-testing-agent-browser/13-02-SUMMARY.md`
</output>
