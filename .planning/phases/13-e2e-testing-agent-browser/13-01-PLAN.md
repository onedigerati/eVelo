---
phase: 13-e2e-testing-agent-browser
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - test/e2e/helpers/agent-browser.js
  - test/e2e/helpers/server.js
  - test/e2e/helpers/screenshot.js
  - test/e2e/screenshots/baseline/.gitkeep
  - test/e2e/screenshots/current/.gitignore
  - test/e2e/screenshots/diff/.gitignore
autonomous: true

must_haves:
  truths:
    - "agent-browser, cross-spawn, pixelmatch, pngjs installed as dev dependencies"
    - "Test directory structure exists with baseline/current/diff folders"
    - "Cross-platform agent-browser CLI wrapper works on Windows and Unix"
    - "Dev server can be started and stopped programmatically via Vite API"
    - "Screenshot comparison utility compares PNG files with threshold"
  artifacts:
    - path: "test/e2e/helpers/agent-browser.js"
      provides: "Cross-platform agent-browser CLI wrapper"
      min_lines: 60
    - path: "test/e2e/helpers/server.js"
      provides: "Vite programmatic server lifecycle management"
      min_lines: 40
    - path: "test/e2e/helpers/screenshot.js"
      provides: "Pixelmatch-based screenshot comparison utility"
      min_lines: 30
  key_links:
    - from: "test/e2e/helpers/agent-browser.js"
      to: "agent-browser"
      via: "cross-spawn"
      pattern: "spawn.*agent-browser"
    - from: "test/e2e/helpers/server.js"
      to: "vite"
      via: "createServer API"
      pattern: "createServer"
    - from: "test/e2e/helpers/screenshot.js"
      to: "pixelmatch"
      via: "import"
      pattern: "import pixelmatch"
---

<objective>
Set up E2E testing infrastructure with agent-browser, Vite programmatic API, and pixelmatch screenshot comparison.

Purpose: Establish foundation for all subsequent E2E tests - cross-platform execution helpers, dev server management via Vite API, screenshot comparison for Chart.js visual regression.
Output: Three helper modules (agent-browser.js, server.js, screenshot.js) and test directory structure ready for test files.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-e2e-testing-agent-browser/13-RESEARCH.md
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create directory structure</name>
  <files>package.json, test/e2e/screenshots/baseline/.gitkeep, test/e2e/screenshots/current/.gitignore, test/e2e/screenshots/diff/.gitignore</files>
  <action>
  1. Install E2E testing dependencies:
     ```
     npm install --save-dev agent-browser pixelmatch pngjs cross-spawn
     ```

  2. Create test directory structure:
     - test/e2e/helpers/ (helper modules)
     - test/e2e/screenshots/baseline/ (reference images - committed to git)
     - test/e2e/screenshots/current/ (test run outputs - gitignored)
     - test/e2e/screenshots/diff/ (comparison diffs - gitignored)

  3. Add .gitkeep to baseline/ (empty directory needs placeholder)

  4. Add .gitignore to current/ and diff/ directories with content:
     ```
     *
     !.gitignore
     ```

  5. Add npm scripts to package.json:
     ```json
     "scripts": {
       "test:e2e": "node test/e2e/run-all.js",
       "test:e2e:smoke": "node test/e2e/smoke.js",
       "test:e2e:workflow": "node test/e2e/workflow.js",
       "test:e2e:responsive": "node test/e2e/responsive.js",
       "test:e2e:charts": "node test/e2e/charts.js",
       "test:e2e:charts:capture": "node test/e2e/charts.js --capture",
       "postinstall": "agent-browser install || echo 'agent-browser install skipped'"
     }
     ```

  Note: The postinstall script handles Chromium download for agent-browser.
  Use JavaScript (.js) test files for Windows compatibility.
  </action>
  <verify>
  - npm ls agent-browser pixelmatch pngjs cross-spawn (all show installed)
  - Directory exists: test/e2e/helpers
  - Directory exists: test/e2e/screenshots/baseline with .gitkeep
  - Directory exists: test/e2e/screenshots/current with .gitignore
  - grep 'test:e2e' package.json (scripts defined)
  - grep 'postinstall' package.json (postinstall script exists)
  </verify>
  <done>Dependencies installed, directory structure created, npm scripts added</done>
</task>

<task type="auto">
  <name>Task 2: Create agent-browser CLI wrapper helper</name>
  <files>test/e2e/helpers/agent-browser.js</files>
  <action>
  Create a Node.js helper module that wraps agent-browser CLI commands for cross-platform execution:

  ```javascript
  // test/e2e/helpers/agent-browser.js
  // Cross-platform agent-browser CLI wrapper
  // Source: 13-RESEARCH.md Pattern 1
  import spawn from 'cross-spawn';

  /**
   * Execute agent-browser command
   * @param {string[]} args - Command arguments
   * @param {object} options - Options (timeout)
   * @returns {Promise<{stdout: string, stderr: string, exitCode: number}>}
   */
  export async function agentBrowser(args, options = {}) {
    const { timeout = 30000 } = options;

    return new Promise((resolve, reject) => {
      const proc = spawn('npx', ['agent-browser', ...args], {
        stdio: ['ignore', 'pipe', 'pipe'],
        timeout
      });

      let stdout = '';
      let stderr = '';

      proc.stdout.on('data', (data) => { stdout += data.toString(); });
      proc.stderr.on('data', (data) => { stderr += data.toString(); });

      proc.on('close', (exitCode) => {
        if (exitCode === 0) {
          resolve({ stdout, stderr, exitCode });
        } else {
          reject(new Error(`agent-browser failed (code ${exitCode}): ${stderr || stdout}`));
        }
      });

      proc.on('error', (err) => {
        reject(new Error(`agent-browser spawn error: ${err.message}`));
      });
    });
  }

  // Convenience wrappers for common commands

  export async function open(url) {
    await agentBrowser(['open', url]);
  }

  export async function close() {
    await agentBrowser(['close']);
  }

  export async function screenshot(path) {
    await agentBrowser(['screenshot', path]);
  }

  export async function snapshot(options = {}) {
    const args = ['snapshot'];
    if (options.interactive) args.push('--interactive');
    const result = await agentBrowser(args);
    return result.stdout;
  }

  export async function isVisible(element) {
    try {
      const result = await agentBrowser(['is', 'visible', element]);
      return result.stdout.trim().toLowerCase() === 'true';
    } catch {
      return false;
    }
  }

  export async function findRole(role, action, value) {
    const args = ['find', 'role', role, action];
    if (value) args.push(value);
    await agentBrowser(args);
  }

  export async function findLabel(label, action, value) {
    const args = ['find', 'label', label, action];
    if (value) args.push(value);
    await agentBrowser(args);
  }

  export async function wait(target, options = {}) {
    const args = ['wait', target];
    if (options.timeout) args.push('--timeout', String(options.timeout));
    await agentBrowser(args, { timeout: (options.timeout || 30000) + 5000 });
  }

  export async function setViewport(width, height) {
    await agentBrowser(['set', 'viewport', String(width), String(height)]);
  }

  export async function evalJs(code) {
    const result = await agentBrowser(['eval', code]);
    try {
      return JSON.parse(result.stdout.trim());
    } catch {
      return result.stdout.trim();
    }
  }
  ```

  Key requirements from research:
  - Use cross-spawn (handles Windows .cmd files automatically)
  - Use npx to run agent-browser (avoids global install issues)
  - Return parsed JSON when agent-browser outputs JSON
  - Throw errors with descriptive messages on failure
  - Support timeout configuration
  </action>
  <verify>
  - File exists at test/e2e/helpers/agent-browser.js
  - No syntax errors: node --check test/e2e/helpers/agent-browser.js
  - Uses cross-spawn (grep 'cross-spawn' test/e2e/helpers/agent-browser.js)
  </verify>
  <done>Cross-platform agent-browser CLI wrapper created with all essential commands</done>
</task>

<task type="auto">
  <name>Task 3: Create Vite server lifecycle helper</name>
  <files>test/e2e/helpers/server.js</files>
  <action>
  Create a Node.js helper module for managing the Vite dev server lifecycle using Vite's programmatic API:

  ```javascript
  // test/e2e/helpers/server.js
  // Vite server lifecycle management using programmatic API
  // Source: 13-RESEARCH.md Pattern 2, Vite JavaScript API docs
  import { createServer } from 'vite';

  let server = null;
  const PORT = 5174;  // Use different port than dev (5173) to avoid conflicts
  const BASE_URL = `http://localhost:${PORT}`;

  /**
   * Start Vite dev server
   * @returns {Promise<void>}
   */
  export async function startServer() {
    if (server) {
      throw new Error('Server already running');
    }

    server = await createServer({
      server: { port: PORT, strictPort: true },
      logLevel: 'error'  // Suppress logs in tests
    });

    await server.listen();

    console.log(`[Server] Vite dev server running at ${BASE_URL}`);
  }

  /**
   * Stop Vite dev server
   * @returns {Promise<void>}
   */
  export async function stopServer() {
    if (!server) return;

    await server.close();
    server = null;

    console.log('[Server] Vite dev server stopped');
  }

  /**
   * Get base URL for tests
   * @returns {string}
   */
  export function getBaseUrl() {
    return BASE_URL;
  }

  /**
   * Get server port
   * @returns {number}
   */
  export function getPort() {
    return PORT;
  }

  // Cleanup handlers for unexpected exit
  process.on('exit', () => {
    if (server) {
      server.close().catch(() => {});
    }
  });

  process.on('SIGINT', async () => {
    await stopServer();
    process.exit(0);
  });

  process.on('SIGTERM', async () => {
    await stopServer();
    process.exit(0);
  });
  ```

  Key requirements from research:
  - Use Vite's createServer() API (not spawning npm run dev)
  - Use port 5174 to avoid conflicts with dev server on 5173
  - Set strictPort: true to fail fast if port unavailable
  - Set logLevel: 'error' to suppress noise in test output
  - Handle cleanup on exit/SIGINT/SIGTERM
  </action>
  <verify>
  - File exists at test/e2e/helpers/server.js
  - No syntax errors: node --check test/e2e/helpers/server.js
  - Uses createServer (grep 'createServer' test/e2e/helpers/server.js)
  - Uses port 5174 (grep '5174' test/e2e/helpers/server.js)
  </verify>
  <done>Vite server lifecycle helper created with programmatic API</done>
</task>

<task type="auto">
  <name>Task 4: Create screenshot comparison utility</name>
  <files>test/e2e/helpers/screenshot.js</files>
  <action>
  Create a Node.js helper module for pixelmatch-based screenshot comparison:

  ```javascript
  // test/e2e/helpers/screenshot.js
  // Screenshot comparison utility using pixelmatch
  // Source: 13-RESEARCH.md Pattern 3, pixelmatch npm docs
  import fs from 'fs';
  import { PNG } from 'pngjs';
  import pixelmatch from 'pixelmatch';

  /**
   * Compare two PNG screenshots
   * @param {string} baselinePath - Path to baseline screenshot
   * @param {string} currentPath - Path to current screenshot
   * @param {string} diffPath - Output path for diff image
   * @param {number} threshold - Matching threshold (0-1, default 0.1)
   * @returns {Promise<{match: boolean, diffPixels: number, totalPixels: number, diffPercent: number}>}
   */
  export async function compareScreenshots(
    baselinePath,
    currentPath,
    diffPath,
    threshold = 0.1
  ) {
    // Check files exist
    if (!fs.existsSync(baselinePath)) {
      throw new Error(`Baseline not found: ${baselinePath}`);
    }
    if (!fs.existsSync(currentPath)) {
      throw new Error(`Current screenshot not found: ${currentPath}`);
    }

    // Read PNG files
    const baseline = PNG.sync.read(fs.readFileSync(baselinePath));
    const current = PNG.sync.read(fs.readFileSync(currentPath));

    // Check dimensions match
    if (baseline.width !== current.width || baseline.height !== current.height) {
      throw new Error(
        `Image dimensions don't match: ` +
        `${baseline.width}x${baseline.height} vs ${current.width}x${current.height}`
      );
    }

    // Create diff image
    const diff = new PNG({ width: baseline.width, height: baseline.height });

    // Compare pixels
    const diffPixels = pixelmatch(
      baseline.data,
      current.data,
      diff.data,
      baseline.width,
      baseline.height,
      { threshold }
    );

    // Ensure diff directory exists
    const diffDir = diffPath.substring(0, diffPath.lastIndexOf('/'));
    if (diffDir && !fs.existsSync(diffDir)) {
      fs.mkdirSync(diffDir, { recursive: true });
    }

    // Write diff image
    fs.writeFileSync(diffPath, PNG.sync.write(diff));

    const totalPixels = baseline.width * baseline.height;
    const diffPercent = (diffPixels / totalPixels) * 100;
    const match = diffPixels === 0;

    return { match, diffPixels, totalPixels, diffPercent };
  }

  /**
   * Check if baseline exists for a given name
   * @param {string} name - Screenshot name (without path/extension)
   * @param {string} baselineDir - Baseline directory path
   * @returns {boolean}
   */
  export function hasBaseline(name, baselineDir = 'test/e2e/screenshots/baseline') {
    return fs.existsSync(`${baselineDir}/${name}.png`);
  }
  ```

  Key requirements from research:
  - Use pixelmatch with threshold 0.1 (10%) for anti-aliasing tolerance
  - Return diff statistics (pixels, percent) for reporting
  - Create diff directory if it doesn't exist
  - Validate file existence and dimensions before comparison
  </action>
  <verify>
  - File exists at test/e2e/helpers/screenshot.js
  - No syntax errors: node --check test/e2e/helpers/screenshot.js
  - Uses pixelmatch (grep 'pixelmatch' test/e2e/helpers/screenshot.js)
  - Uses threshold 0.1 (grep '0.1' test/e2e/helpers/screenshot.js)
  </verify>
  <done>Screenshot comparison utility created with pixelmatch</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. npm ls agent-browser pixelmatch pngjs cross-spawn (all installed)
2. test/e2e/helpers/ contains agent-browser.js, server.js, screenshot.js
3. test/e2e/screenshots/baseline/ directory exists with .gitkeep
4. test/e2e/screenshots/current/ and diff/ exist with .gitignore
5. All helper files pass syntax check with node --check
6. package.json has test:e2e* scripts and postinstall script
</verification>

<success_criteria>
1. agent-browser, cross-spawn, pixelmatch, pngjs dev dependencies installed
2. Test directory structure created (helpers, screenshots/baseline, screenshots/current, screenshots/diff)
3. agent-browser.js uses cross-spawn for Windows compatibility
4. server.js uses Vite createServer() API on port 5174
5. screenshot.js uses pixelmatch with 0.1 threshold
6. npm test scripts defined in package.json
7. postinstall script installs agent-browser Chromium
</success_criteria>

<output>
After completion, create `.planning/phases/13-e2e-testing-agent-browser/13-01-SUMMARY.md`
</output>
