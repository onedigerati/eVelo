---
phase: 13-e2e-testing-agent-browser
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - test/e2e/helpers/run-test.js
  - test/e2e/helpers/server.js
  - test/e2e/screenshots/.gitkeep
autonomous: true

must_haves:
  truths:
    - "agent-browser is installed as dev dependency"
    - "Test directory structure exists"
    - "Cross-platform test runner helper works on Windows and Unix"
    - "Dev server can be started and stopped programmatically"
  artifacts:
    - path: "test/e2e/helpers/run-test.js"
      provides: "Cross-platform test execution wrapper"
      min_lines: 30
    - path: "test/e2e/helpers/server.js"
      provides: "Dev server lifecycle management"
      min_lines: 20
    - path: "test/e2e/screenshots/.gitkeep"
      provides: "Baseline screenshot directory"
  key_links:
    - from: "test/e2e/helpers/run-test.js"
      to: "agent-browser"
      via: "child_process.spawn"
      pattern: "spawn.*agent-browser"
    - from: "test/e2e/helpers/server.js"
      to: "vite"
      via: "npm run dev"
      pattern: "npm.*dev"
---

<objective>
Set up E2E testing infrastructure with agent-browser for Shadow DOM and Chart.js testing.

Purpose: Establish foundation for all subsequent E2E tests - cross-platform execution helpers, dev server management, and directory structure.
Output: Test infrastructure ready for smoke, workflow, and visual regression tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/quick/004-research-agent-browser-integration/004-RESEARCH.md
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install agent-browser and create directory structure</name>
  <files>package.json, test/e2e/screenshots/.gitkeep</files>
  <action>
  1. Install agent-browser as dev dependency:
     ```
     npm install --save-dev agent-browser
     ```
  2. Create test directory structure:
     - test/e2e/helpers/ (test utilities)
     - test/e2e/screenshots/baseline/ (chart baselines)
     - test/e2e/screenshots/current/ (test run outputs)
  3. Add .gitkeep files to empty directories
  4. Add npm scripts to package.json:
     - "test:e2e": "node test/e2e/run-all.js"
     - "test:e2e:smoke": "node test/e2e/smoke.js"
     - "test:e2e:workflow": "node test/e2e/workflow.js"
     - "test:e2e:responsive": "node test/e2e/responsive.js"
     - "test:e2e:charts": "node test/e2e/charts.js"

  Note: Use JavaScript (.js) test files, not bash scripts, for Windows compatibility.
  </action>
  <verify>
  - npm ls agent-browser (shows installed)
  - Directory exists: test/e2e/helpers
  - Directory exists: test/e2e/screenshots/baseline
  - npm run test:e2e --help (script exists, though tests don't exist yet)
  </verify>
  <done>agent-browser installed, directory structure created, npm scripts added</done>
</task>

<task type="auto">
  <name>Task 2: Create cross-platform test runner helper</name>
  <files>test/e2e/helpers/run-test.js</files>
  <action>
  Create a Node.js helper module that wraps agent-browser commands for cross-platform execution:

  ```javascript
  // test/e2e/helpers/run-test.js
  import { spawn } from 'child_process';
  import { resolve } from 'path';

  const AGENT_BROWSER = process.platform === 'win32'
    ? 'agent-browser.cmd'
    : 'agent-browser';

  export async function agentBrowser(command, args = []) {
    // Execute agent-browser command and return output
    // Handle Windows/Unix differences
    // Return { stdout, stderr, exitCode }
  }

  export async function open(url) { ... }
  export async function close() { ... }
  export async function snapshot(options) { ... }
  export async function findRole(role, action, value) { ... }
  export async function findLabel(label, action, value) { ... }
  export async function isVisible(element) { ... }
  export async function screenshot(path) { ... }
  export async function setViewport(width, height) { ... }
  export async function evalJs(code) { ... }
  export async function wait(target, options) { ... }
  ```

  Key requirements:
  - Use npx to run agent-browser (avoids global install issues)
  - Properly quote paths with spaces on Windows
  - Return parsed JSON when agent-browser outputs JSON
  - Throw errors with descriptive messages on failure
  - Support timeout configuration
  </action>
  <verify>
  - File exists at test/e2e/helpers/run-test.js
  - No syntax errors: node --check test/e2e/helpers/run-test.js
  </verify>
  <done>Cross-platform test runner helper created with all essential agent-browser wrappers</done>
</task>

<task type="auto">
  <name>Task 3: Create dev server lifecycle helper</name>
  <files>test/e2e/helpers/server.js</files>
  <action>
  Create a Node.js helper module for managing the Vite dev server lifecycle:

  ```javascript
  // test/e2e/helpers/server.js
  import { spawn } from 'child_process';

  let serverProcess = null;
  const PORT = 5173;
  const BASE_URL = `http://localhost:${PORT}`;

  export async function startServer() {
    // Start npm run dev
    // Wait for server to be ready (poll BASE_URL or look for "ready" in stdout)
    // Return when server is accepting connections
    // Throw if server fails to start within 30 seconds
  }

  export async function stopServer() {
    // Kill the dev server process
    // Handle Windows vs Unix process termination
    // On Windows: taskkill /F /T /PID
    // On Unix: process.kill(pid, 'SIGTERM')
  }

  export function getBaseUrl() {
    return BASE_URL;
  }

  // Cleanup handler for unexpected exit
  process.on('exit', () => {
    if (serverProcess) {
      stopServer();
    }
  });
  ```

  Key requirements:
  - Use cross-spawn or handle platform differences manually
  - Wait for server readiness by polling http://localhost:5173
  - Clean process termination on both Windows and Unix
  - Handle SIGINT/SIGTERM for graceful shutdown
  </action>
  <verify>
  - File exists at test/e2e/helpers/server.js
  - No syntax errors: node --check test/e2e/helpers/server.js
  </verify>
  <done>Dev server lifecycle helper created with cross-platform process management</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. npm ls agent-browser shows version installed
2. test/e2e/helpers/ contains run-test.js and server.js
3. test/e2e/screenshots/baseline/ directory exists
4. Both helper files pass syntax check with node --check
5. package.json has test:e2e* scripts
</verification>

<success_criteria>
1. agent-browser dev dependency installed
2. Test directory structure created (helpers, screenshots/baseline, screenshots/current)
3. Cross-platform run-test.js helper works on Windows
4. Dev server helper can start/stop Vite server
5. npm test scripts defined in package.json
</success_criteria>

<output>
After completion, create `.planning/phases/13-e2e-testing-agent-browser/13-01-SUMMARY.md`
</output>
