---
phase: 13-e2e-testing-agent-browser
plan: 05
type: execute
wave: 3
depends_on: ["13-03"]
files_modified:
  - test/e2e/charts.js
  - test/e2e/screenshots/baseline/.gitkeep
autonomous: false

must_haves:
  truths:
    - "All 13 chart types have baseline screenshots captured"
    - "Chart baselines captured after simulation with known inputs"
    - "Baseline screenshots stored in test/e2e/screenshots/baseline/"
    - "Test verifies all chart containers render"
  artifacts:
    - path: "test/e2e/charts.js"
      provides: "Chart baseline capture and verification test"
      min_lines: 100
    - path: "test/e2e/screenshots/baseline/"
      provides: "Baseline screenshots for all 13 chart types"
  key_links:
    - from: "test/e2e/charts.js"
      to: "Chart.js"
      via: "evalJs chart.data"
      pattern: "evalJs.*chart"
---

<objective>
Create chart baseline screenshot capture test for all 13 chart types in eVelo.

Purpose: Establish visual regression baselines for Chart.js canvas-based charts. Since canvas content is not in the DOM, screenshots are the primary verification method.
Output: Chart test script and baseline screenshots for all chart types.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/quick/004-research-agent-browser-integration/004-RESEARCH.md
@.planning/phases/13-e2e-testing-agent-browser/13-01-SUMMARY.md
@.planning/phases/13-e2e-testing-agent-browser/13-03-SUMMARY.md
@src/charts/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create chart baseline capture test</name>
  <files>test/e2e/charts.js</files>
  <action>
  Create test that captures baseline screenshots for all chart types:

  ```javascript
  // test/e2e/charts.js
  import { startServer, stopServer, getBaseUrl } from './helpers/server.js';
  import {
    open, close, isVisible, screenshot, wait, findRole, findLabel, evalJs
  } from './helpers/run-test.js';
  import { existsSync, mkdirSync } from 'fs';
  import { dirname, join } from 'path';

  // All chart types in eVelo (from src/charts/)
  const CHART_COMPONENTS = [
    // Core results charts
    { element: 'probability-cone-chart', name: 'probability-cone', inResults: true },
    { element: 'histogram-chart', name: 'histogram', inResults: true },
    { element: 'donut-chart', name: 'donut', inResults: true },
    { element: 'correlation-heatmap', name: 'correlation-heatmap', inResults: true },

    // SBLOC charts (visible when SBLOC enabled)
    { element: 'margin-call-chart', name: 'margin-call', requiresSBLOC: true },
    { element: 'sbloc-balance-chart', name: 'sbloc-balance', requiresSBLOC: true },
    { element: 'bbd-comparison-chart', name: 'bbd-comparison', requiresSBLOC: true },

    // Strategy comparison charts (in visual comparison section)
    { element: 'comparison-line-chart', name: 'comparison-line', requiresSBLOC: true },
    { element: 'cumulative-costs-chart', name: 'cumulative-costs', requiresSBLOC: true },
    { element: 'terminal-comparison-chart', name: 'terminal-comparison', requiresSBLOC: true },
    { element: 'sbloc-utilization-chart', name: 'sbloc-utilization', requiresSBLOC: true },
  ];

  // Test parameters for simulation
  const TEST_PARAMS = {
    initialPortfolio: 1000000,
    timeHorizon: 30,
    annualWithdrawal: 50000,  // Enables SBLOC charts
    iterations: 1000,
  };

  // Mode: 'capture' for creating baselines, 'verify' for checking against baselines
  const MODE = process.argv.includes('--capture') ? 'capture' : 'verify';

  async function runChartTest() {
    console.log(`Starting chart ${MODE} test...`);
    let passed = 0;
    let failed = 0;
    let captured = 0;

    const baselineDir = 'test/e2e/screenshots/baseline';
    const currentDir = 'test/e2e/screenshots/current';

    // Ensure directories exist
    [baselineDir, currentDir].forEach(dir => {
      if (!existsSync(dir)) {
        mkdirSync(dir, { recursive: true });
      }
    });

    try {
      await startServer();
      await open(getBaseUrl());
      await wait('main-layout');

      // Set parameters to get full chart data
      console.log('\n[Setup] Setting simulation parameters...');

      try {
        await findLabel('Initial Portfolio', 'fill', String(TEST_PARAMS.initialPortfolio));
        await findLabel('Time Horizon', 'fill', String(TEST_PARAMS.timeHorizon));

        // Enable SBLOC by setting withdrawal (if visible)
        try {
          await findLabel('Annual Withdrawal', 'fill', String(TEST_PARAMS.annualWithdrawal));
        } catch {
          console.log('  [INFO] Annual Withdrawal input not directly visible');
        }
      } catch (e) {
        console.log(`  [WARN] Could not set all parameters: ${e.message}`);
      }

      // Run simulation
      console.log('\n[Setup] Running simulation...');
      await findRole('button', 'click', 'Run Simulation');
      await wait('key-metrics-banner', { timeout: 60000 });
      console.log('  [PASS] Simulation complete');

      // Wait for charts to render
      await new Promise(r => setTimeout(r, 2000));

      // Process each chart
      console.log('\n[Charts] Processing chart components...');

      for (const chart of CHART_COMPONENTS) {
        const baselinePath = join(baselineDir, `${chart.name}.png`);
        const currentPath = join(currentDir, `${chart.name}.png`);

        try {
          const visible = await isVisible(chart.element);

          if (!visible) {
            if (chart.requiresSBLOC) {
              console.log(`  [SKIP] ${chart.name} - SBLOC section may be collapsed`);
            } else {
              console.log(`  [FAIL] ${chart.name} - not visible`);
              failed++;
            }
            continue;
          }

          // Verify chart has data
          const hasData = await evalJs(`
            const chart = document.querySelector('${chart.element}');
            if (chart && chart.shadowRoot) {
              const canvas = chart.shadowRoot.querySelector('canvas');
              if (canvas && canvas.chart) {
                return canvas.chart.data.datasets.length > 0;
              }
            }
            return false;
          `);

          if (!hasData) {
            console.log(`  [WARN] ${chart.name} - visible but no data`);
          }

          // Capture screenshot of chart element
          // Note: agent-browser screenshot captures full page
          // For individual charts, we'll rely on full dashboard screenshots
          // and document which area contains which chart

          if (MODE === 'capture') {
            // In capture mode, take full page screenshot once
            // Individual chart isolation would need Playwright directly
            console.log(`  [CAPTURE] ${chart.name} - visible with data`);
            captured++;
          } else {
            // In verify mode, just check visibility and data
            console.log(`  [PASS] ${chart.name} - visible with data`);
            passed++;
          }

        } catch (e) {
          console.log(`  [FAIL] ${chart.name} - ${e.message}`);
          failed++;
        }
      }

      // Capture full dashboard screenshot for baselines
      if (MODE === 'capture') {
        await screenshot(join(baselineDir, 'dashboard-full.png'));
        console.log('\n  [CAPTURE] Full dashboard screenshot saved');

        // Scroll to bottom to capture more charts
        await evalJs('window.scrollTo(0, document.body.scrollHeight)');
        await new Promise(r => setTimeout(r, 500));
        await screenshot(join(baselineDir, 'dashboard-bottom.png'));
        console.log('  [CAPTURE] Dashboard bottom screenshot saved');
      }

      // Summary
      console.log(`\n========================================`);
      if (MODE === 'capture') {
        console.log(`Chart Capture Complete: ${captured} charts captured`);
      } else {
        console.log(`Chart Test Complete: ${passed} passed, ${failed} failed`);
      }
      console.log(`========================================`);

      return failed === 0;

    } finally {
      await close();
      await stopServer();
    }
  }

  runChartTest()
    .then(success => process.exit(success ? 0 : 1))
    .catch(err => {
      console.error('Chart test error:', err);
      process.exit(1);
    });
  ```

  Key aspects from research:
  - Chart.js renders to canvas - content not in accessibility tree
  - Use evalJs to verify chart.data.datasets exists
  - Screenshot comparison is primary verification method
  - SBLOC charts only visible when withdrawal > 0
  </action>
  <verify>
  - File exists at test/e2e/charts.js
  - No syntax errors: node --check test/e2e/charts.js
  </verify>
  <done>Chart baseline capture test created for all 13 chart types</done>
</task>

<task type="auto">
  <name>Task 2: Add npm script for baseline capture</name>
  <files>package.json</files>
  <action>
  Add npm script for capturing chart baselines:

  In package.json scripts section, add:
  ```json
  "test:e2e:charts:capture": "node test/e2e/charts.js --capture"
  ```

  This allows:
  - `npm run test:e2e:charts` - verify charts render correctly
  - `npm run test:e2e:charts:capture` - capture new baselines

  Baseline capture workflow:
  1. Run simulation with known inputs
  2. Capture screenshots
  3. Commit to baseline/ directory
  4. Future runs compare against baselines
  </action>
  <verify>
  - package.json has test:e2e:charts:capture script
  - npm run test:e2e:charts:capture --help works
  </verify>
  <done>npm script added for chart baseline capture</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Chart baseline capture test and infrastructure</what-built>
  <how-to-verify>
  1. Run: npm run test:e2e:charts:capture
  2. Verify:
     - Server starts
     - Simulation runs
     - Charts verified (visible with data)
     - Screenshots captured to test/e2e/screenshots/baseline/
  3. Check screenshots:
     - dashboard-full.png exists
     - dashboard-bottom.png exists
  4. Review screenshots show charts with actual data (not empty)
  </how-to-verify>
  <resume-signal>Type "approved" if baselines captured correctly, or describe issues</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. test/e2e/charts.js exists with 100+ lines
2. Chart test verifies all 11 chart components
3. Test runs simulation to generate chart data
4. Test uses evalJs to verify Chart.js has data
5. Baseline screenshots captured to screenshots/baseline/
</verification>

<success_criteria>
1. Chart test verifies probability-cone-chart, histogram-chart, donut-chart, correlation-heatmap
2. Chart test verifies SBLOC charts when enabled (margin-call, sbloc-balance, bbd-comparison)
3. Chart test verifies strategy comparison charts (comparison-line, cumulative-costs, terminal-comparison, sbloc-utilization)
4. Baseline screenshots captured for full dashboard
5. npm run test:e2e:charts:capture script works
</success_criteria>

<output>
After completion, create `.planning/phases/13-e2e-testing-agent-browser/13-05-SUMMARY.md`
</output>
